Zilog eZ80 Macro Assembler Version 4.3 (19073001) RELISTED22-Oct-23     15:41:19     page:   1


PC     Object              I  Line    Source 
                           A     1    ; Zilog eZ80 ANSI C Compiler Release 3.4
                           A     2    ; -nomodsect -optsize -noreduceopt -nopadbranch
                           A     3    ; -peephole -globalopt -localcse -const=ROM 
                           A     4    	FILE	"..\main.c"
                           A     5    	.assume ADL=1
                           A     6    .DEBUG "C"
                           A     7    	SEGMENT CODE
                           A     8    .BEGREC "NONAME0",558
                           A     9    .DEFINE "fs_type"
                           A    10    .VALUE 0
                           A    11    .CLASS 8
                           A    12    .TYPE 12
                           A    13    .ENDEF
                           A    14    .DEFINE "pdrv"
                           A    15    .VALUE 1
                           A    16    .CLASS 8
                           A    17    .TYPE 12
                           A    18    .ENDEF
                           A    19    .DEFINE "n_fats"
                           A    20    .VALUE 2
                           A    21    .CLASS 8
                           A    22    .TYPE 12
                           A    23    .ENDEF
                           A    24    .DEFINE "wflag"
                           A    25    .VALUE 3
                           A    26    .CLASS 8
                           A    27    .TYPE 12
                           A    28    .ENDEF
                           A    29    .DEFINE "fsi_flag"
                           A    30    .VALUE 4
                           A    31    .CLASS 8
                           A    32    .TYPE 12
                           A    33    .ENDEF
                           A    34    .DEFINE "id"
                           A    35    .VALUE 5
                           A    36    .CLASS 8
                           A    37    .TYPE 13
                           A    38    .ENDEF
                           A    39    .DEFINE "n_rootdir"
                           A    40    .VALUE 7
                           A    41    .CLASS 8
                           A    42    .TYPE 13
                           A    43    .ENDEF
                           A    44    .DEFINE "csize"
                           A    45    .VALUE 9
                           A    46    .CLASS 8
                           A    47    .TYPE 13
                           A    48    .ENDEF
                           A    49    .DEFINE "lfnbuf"
                           A    50    .VALUE 11
                           A    51    .CLASS 8
                           A    52    .TYPE 45
                           A    53    .ENDEF
                           A    54    .DEFINE "cdir"
                           A    55    .VALUE 14
                           A    56    .CLASS 8
                           A    57    .TYPE 15
                           A    58    .ENDEF
                           A    59    .DEFINE "n_fatent"
                           A    60    .VALUE 18
                           A    61    .CLASS 8
                           A    62    .TYPE 15
                           A    63    .ENDEF
                           A    64    .DEFINE "fsize"
                           A    65    .VALUE 22
                           A    66    .CLASS 8
                           A    67    .TYPE 15
                           A    68    .ENDEF
                           A    69    .DEFINE "volbase"
                           A    70    .VALUE 26
                           A    71    .CLASS 8
                           A    72    .TYPE 15
                           A    73    .ENDEF
                           A    74    .DEFINE "fatbase"
                           A    75    .VALUE 30
                           A    76    .CLASS 8
                           A    77    .TYPE 15
                           A    78    .ENDEF
                           A    79    .DEFINE "dirbase"
                           A    80    .VALUE 34
                           A    81    .CLASS 8
                           A    82    .TYPE 15
                           A    83    .ENDEF
                           A    84    .DEFINE "database"
                           A    85    .VALUE 38
                           A    86    .CLASS 8
                           A    87    .TYPE 15
                           A    88    .ENDEF
                           A    89    .DEFINE "winsect"
                           A    90    .VALUE 42
                           A    91    .CLASS 8
                           A    92    .TYPE 15
                           A    93    .ENDEF
                           A    94    .DEFINE "win"
                           A    95    .VALUE 46
                           A    96    .CLASS 8
                           A    97    .DIM 512
                           A    98    .TYPE 108
                           A    99    .ENDEF
                           A   100    .ENDREC "NONAME0"
                           A   101    .BEGREC "NONAME1",15
                           A   102    .DEFINE "fs"
                           A   103    .VALUE 0
                           A   104    .CLASS 8
                           A   105    .TAG "NONAME0"
                           A   106    .TYPE 40
                           A   107    .ENDEF
                           A   108    .DEFINE "id"
                           A   109    .VALUE 3
                           A   110    .CLASS 8
                           A   111    .TYPE 13
                           A   112    .ENDEF
                           A   113    .DEFINE "attr"
                           A   114    .VALUE 5
                           A   115    .CLASS 8
                           A   116    .TYPE 12
                           A   117    .ENDEF
                           A   118    .DEFINE "stat"
                           A   119    .VALUE 6
                           A   120    .CLASS 8
                           A   121    .TYPE 12
                           A   122    .ENDEF
                           A   123    .DEFINE "sclust"
                           A   124    .VALUE 7
                           A   125    .CLASS 8
                           A   126    .TYPE 15
                           A   127    .ENDEF
                           A   128    .DEFINE "objsize"
                           A   129    .VALUE 11
                           A   130    .CLASS 8
                           A   131    .TYPE 15
                           A   132    .ENDEF
                           A   133    .ENDREC "NONAME1"
                           A   134    .BEGREC "NONAME2",29
                           A   135    .DEFINE "obj"
                           A   136    .VALUE 0
                           A   137    .CLASS 8
                           A   138    .TAG "NONAME1"
                           A   139    .TYPE 8
                           A   140    .ENDEF
                           A   141    .DEFINE "flag"
                           A   142    .VALUE 15
                           A   143    .CLASS 8
                           A   144    .TYPE 12
                           A   145    .ENDEF
                           A   146    .DEFINE "err"
                           A   147    .VALUE 16
                           A   148    .CLASS 8
                           A   149    .TYPE 12
                           A   150    .ENDEF
                           A   151    .DEFINE "fptr"
                           A   152    .VALUE 17
                           A   153    .CLASS 8
                           A   154    .TYPE 15
                           A   155    .ENDEF
                           A   156    .DEFINE "clust"
                           A   157    .VALUE 21
                           A   158    .CLASS 8
                           A   159    .TYPE 15
                           A   160    .ENDEF
                           A   161    .DEFINE "sect"
                           A   162    .VALUE 25
                           A   163    .CLASS 8
                           A   164    .TYPE 15
                           A   165    .ENDEF
                           A   166    .ENDREC "NONAME2"
                           A   167    .BEGREC "NONAME3",46
                           A   168    .DEFINE "obj"
                           A   169    .VALUE 0
                           A   170    .CLASS 8
                           A   171    .TAG "NONAME1"
                           A   172    .TYPE 8
                           A   173    .ENDEF
                           A   174    .DEFINE "dptr"
                           A   175    .VALUE 15
                           A   176    .CLASS 8
                           A   177    .TYPE 15
                           A   178    .ENDEF
                           A   179    .DEFINE "clust"
                           A   180    .VALUE 19
                           A   181    .CLASS 8
                           A   182    .TYPE 15
                           A   183    .ENDEF
                           A   184    .DEFINE "sect"
                           A   185    .VALUE 23
                           A   186    .CLASS 8
                           A   187    .TYPE 15
                           A   188    .ENDEF
                           A   189    .DEFINE "dir"
                           A   190    .VALUE 27
                           A   191    .CLASS 8
                           A   192    .TYPE 44
                           A   193    .ENDEF
                           A   194    .DEFINE "fn"
                           A   195    .VALUE 30
                           A   196    .CLASS 8
                           A   197    .DIM 12
                           A   198    .TYPE 108
                           A   199    .ENDEF
                           A   200    .DEFINE "blk_ofs"
                           A   201    .VALUE 42
                           A   202    .CLASS 8
                           A   203    .TYPE 15
                           A   204    .ENDEF
                           A   205    .ENDREC "NONAME3"
                           A   206    .BEGREC "NONAME4",278
                           A   207    .DEFINE "fsize"
                           A   208    .VALUE 0
                           A   209    .CLASS 8
                           A   210    .TYPE 15
                           A   211    .ENDEF
                           A   212    .DEFINE "fdate"
                           A   213    .VALUE 4
                           A   214    .CLASS 8
                           A   215    .TYPE 13
                           A   216    .ENDEF
                           A   217    .DEFINE "ftime"
                           A   218    .VALUE 6
                           A   219    .CLASS 8
                           A   220    .TYPE 13
                           A   221    .ENDEF
                           A   222    .DEFINE "fattrib"
                           A   223    .VALUE 8
                           A   224    .CLASS 8
                           A   225    .TYPE 12
                           A   226    .ENDEF
                           A   227    .DEFINE "altname"
                           A   228    .VALUE 9
                           A   229    .CLASS 8
                           A   230    .DIM 13
                           A   231    .TYPE 98
                           A   232    .ENDEF
                           A   233    .DEFINE "fname"
                           A   234    .VALUE 22
                           A   235    .CLASS 8
                           A   236    .DIM 256
                           A   237    .TYPE 98
                           A   238    .ENDEF
                           A   239    .ENDREC "NONAME4"
                           A   240    .BEGREC "NONAME5",12
                           A   241    .DEFINE "fmt"
                           A   242    .VALUE 0
                           A   243    .CLASS 8
                           A   244    .TYPE 12
                           A   245    .ENDEF
                           A   246    .DEFINE "n_fat"
                           A   247    .VALUE 1
                           A   248    .CLASS 8
                           A   249    .TYPE 12
                           A   250    .ENDEF
                           A   251    .DEFINE "align"
                           A   252    .VALUE 2
                           A   253    .CLASS 8
                           A   254    .TYPE 14
                           A   255    .ENDEF
                           A   256    .DEFINE "n_root"
                           A   257    .VALUE 5
                           A   258    .CLASS 8
                           A   259    .TYPE 14
                           A   260    .ENDEF
                           A   261    .DEFINE "au_size"
                           A   262    .VALUE 8
                           A   263    .CLASS 8
                           A   264    .TYPE 15
                           A   265    .ENDEF
                           A   266    .ENDREC "NONAME5"
                           A   267    	SEGMENT BSS
0448AF                     A   268    _fs:
0448AF                     A   269    	DS	558
                           A   270    .DEFINE "fs"
                           A   271    .ALIAS "_fs"
                           A   272    .CLASS 83
                           A   273    .VALUE _fs
                           A   274    .TAG "NONAME0"
                           A   275    .TYPE 8
                           A   276    .ENDEF
                           A   277    ;    1	#include <ez80.h>
                           A   278    ;    2	#include "src_fatfs\ff.h"
                           A   279    ;    3	#include "spi.h"
                           A   280    ;    4	#include "defines.h"
                           A   281    ;    5	#include <stdint.h>
                           A   282    ;    6	#include "agontimer.h"
                           A   283    ;    7	#include "protocol.h"
                           A   284    ;    8	
                           A   285    ;    9	#define PAGESIZE	1024
                           A   286    ;   10	#define FLASHPAGES	128
                           A   287    ;   11	#define FLASHSTART	0x0
                           A   288    ;   12	#define BAUDRATE	500000
                           A   289    ;   13	
                           A   290    ;   14	#define MOSFILENAME	"MOS.bin"
                           A   291    ;   15	#define LOADADDRESS	0x50000
                           A   292    ;   16	
                           A   293    ;   17	extern void init_UART0(void);
                           A   294    ;   18	
                           A   295    ;   19	extern void enableFlashKeyRegister(void
                           A   296    ;   20	extern void lockFlashKeyRegister(void);
                           A   297    ;   21	extern void fastmemcpy(UINT24 destinati
                           A   298    ;   22	extern void reset(void);
                           A   299    ;   23	
                           A   300    ;   24	FATFS 	fs;
                           A   301    	SEGMENT CODE
                           A   302    ;   25	
                           A   303    ;   26	int main(int argc, char * argv[]) {
040145                     A   304    _main:
                           A   305    .DEFINE "_main"
                           A   306    
                           A   307    .VALUE _main
                           A   308    
                           A   309    .CLASS 2
                           A   310    
                           A   311    .TYPE 68
                           A   312    
                           A   313    .ENDEF
                           A   314    
                           A   315    .BEGFUNC "main",26,"_main"
                           A   316    
                           A   317    .LINE 26
                           A   318    
                           A   319    .DEFINE "argc"
                           A   320    
                           A   321    .CLASS 65
                           A   322    
                           A   323    .VALUE 6
                           A   324    
                           A   325    .TYPE 4
                           A   326    
                           A   327    .ENDEF
                           A   328    
                           A   329    .DEFINE "argv"
                           A   330    
                           A   331    .CLASS 65
                           A   332    
                           A   333    .VALUE 9
                           A   334    
                           A   335    .TYPE 290
                           A   336    
                           A   337    .ENDEF
                           A   338    
                           A   339    .DEFINE "fr"
                           A   340    
                           A   341    .CLASS 65
                           A   342    
                           A   343    .VALUE -3
                           A   344    
                           A   345    .TYPE 4
                           A   346    
                           A   347    .ENDEF
                           A   348    
                           A   349    .DEFINE "size"
                           A   350    
                           A   351    .CLASS 65
                           A   352    
                           A   353    .VALUE -6
                           A   354    
                           A   355    .TYPE 14
                           A   356    
                           A   357    .ENDEF
                           A   358    
                           A   359    .DEFINE "counter"
                           A   360    
                           A   361    .CLASS 65
                           A   362    
                           A   363    .VALUE -9
                           A   364    
                           A   365    .TYPE 14
                           A   366    
                           A   367    .ENDEF
                           A   368    
                           A   369    .DEFINE "n"
                           A   370    
                           A   371    .CLASS 65
                           A   372    
                           A   373    .VALUE -12
                           A   374    
                           A   375    .TYPE 4
                           A   376    
                           A   377    .ENDEF
                           A   378    
                           A   379    .DEFINE "br"
                           A   380    
                           A   381    .CLASS 65
                           A   382    
                           A   383    .VALUE -15
                           A   384    
                           A   385    .TYPE 14
                           A   386    
                           A   387    .ENDEF
                           A   388    
                           A   389    .DEFINE "addressfrom"
                           A   390    
                           A   391    .CLASS 65
                           A   392    
                           A   393    .VALUE -18
                           A   394    
                           A   395    .TYPE 14
                           A   396    
                           A   397    .ENDEF
                           A   398    
                           A   399    .DEFINE "value"
                           A   400    
                           A   401    .CLASS 65
                           A   402    
                           A   403    .VALUE -19
                           A   404    
                           A   405    .TYPE 12
                           A   406    
                           A   407    .ENDEF
                           A   408    
                           A   409    .DEFINE "addressto"
                           A   410    
                           A   411    .CLASS 65
                           A   412    
                           A   413    .VALUE -22
                           A   414    
                           A   415    .TYPE 14
                           A   416    
                           A   417    .ENDEF
                           A   418    
                           A   419    .DEFINE "pagemax"
                           A   420    
                           A   421    .CLASS 65
                           A   422    
                           A   423    .VALUE -25
                           A   424    
                           A   425    .TYPE 14
                           A   426    
                           A   427    .ENDEF
                           A   428    
                           A   429    .DEFINE "total"
                           A   430    
                           A   431    .CLASS 65
                           A   432    
                           A   433    .VALUE -29
                           A   434    
                           A   435    .TYPE 15
                           A   436    
                           A   437    .ENDEF
                           A   438    
                           A   439    .DEFINE "lastpagebytes"
                           A   440    
                           A   441    .CLASS 65
                           A   442    
                           A   443    .VALUE -35
                           A   444    
                           A   445    .TYPE 14
                           A   446    
                           A   447    .ENDEF
                           A   448    
                           A   449    .DEFINE "fil"
                           A   450    
                           A   451    .CLASS 65
                           A   452    
                           A   453    .VALUE -64
                           A   454    
                           A   455    .TAG "NONAME2"
                           A   456    
                           A   457    .TYPE 8
                           A   458    
                           A   459    .ENDEF
                           A   460    
                           A   461    .DEFINE "buffer"
                           A   462    
                           A   463    .CLASS 65
                           A   464    
                           A   465    .VALUE -1088
                           A   466    
                           A   467    .DIM 1024
                           A   468    
                           A   469    .TYPE 108
                           A   470    
                           A   471    .ENDEF
                           A   472    
040145 DDE5                A   473    	PUSH	IX
040147 DD210000 00         A   474    	LD	IX,0
04014C DD39                A   475    	ADD	IX,SP
04014E 21BFFBFF            A   476    	LD	HL,-1089
040152 39                  A   477    	ADD	HL,SP
040153 F9                  A   478    	LD	SP,HL
                           A   479    ;   27		FRESULT	fr;
                           A   480    ;   28		FIL	   	fil;
                           A   481    ;   29		UINT24  br;	
                           A   482    ;   30		void * 	dest;
                           A   483    ;   31		UINT24 size;
                           A   484    ;   32		
                           A   485    ;   33		UINT24	counter,pagemax, lastpageby
                           A   486    ;   34		UINT24 addressto,addressfrom;
                           A   487    ;   35		UINT8	value;
                           A   488    ;   36		UINT24 timer;
                           A   489    ;   37	
                           A   490    ;   38		unsigned char buffer[1024];
                           A   491    ;   39		int n;
                           A   492    ;   40		uint32_t total;
                           A   493    ;   41	
                           A   494    ;   42	
                           A   495    ;   43		init_spi();
                           A   496    .LINE 43
                           A   497    
040154 CD D2 3F 04         A   498    	CALL	_init_spi
                           A   499    ;   44		init_UART0();
                           A   500    .LINE 44
                           A   501    
040158 CD 90 41 04         A   502    	CALL	_init_UART0
                           A   503    ;   45	
                           A   504    ;   46		f_mount(&fs, "", 1);
                           A   505    .LINE 46
                           A   506    
04015C 01010000            A   507    	LD	BC,1
040160 C5                  A   508    	PUSH	BC
040161 01 7F 48 04         A   509    	LD	BC,L__0
040165 C5                  A   510    	PUSH	BC
040166 01 AF 48 04         A   511    	LD	BC,_fs
04016A C5                  A   512    	PUSH	BC
04016B CD 3C 33 04         A   513    	CALL	_f_mount
04016F C1                  A   514    	POP	BC
040170 C1                  A   515    	POP	BC
040171 C1                  A   516    	POP	BC
                           A   517    ;   47	
                           A   518    ;   48		sendStatus('S', 1, 0); // startup c
                           A   519    .LINE 48
                           A   520    
040172 01000000            A   521    	LD	BC,0
040176 C5                  A   522    	PUSH	BC
040177 C5                  A   523    	PUSH	BC
040178 01010000            A   524    	LD	BC,1
04017C C5                  A   525    	PUSH	BC
04017D 01530000            A   526    	LD	BC,83
040181 C5                  A   527    	PUSH	BC
040182 CD 81 42 04         A   528    	CALL	_sendStatus
040186 C1                  A   529    	POP	BC
040187 C1                  A   530    	POP	BC
040188 C1                  A   531    	POP	BC
040189 C1                  A   532    	POP	BC
                           A   533    ;   49	
                           A   534    ;   50		addressto = FLASHSTART;
                           A   535    ;   51		addressfrom = LOADADDRESS;
                           A   536    ;   52		fr = f_open(&fil, MOSFILENAME, FA_R
                           A   537    .LINE 52
                           A   538    
04018A 01010000            A   539    	LD	BC,1
04018E C5                  A   540    	PUSH	BC
04018F 01 80 48 04         A   541    	LD	BC,L__1
040193 C5                  A   542    	PUSH	BC
040194 ED65C0              A   543    	PEA	IX+%FFFFFFC0
040197 CD C8 33 04         A   544    	CALL	_f_open
04019B C1                  A   545    	POP	BC
04019C C1                  A   546    	POP	BC
04019D C1                  A   547    	POP	BC
04019E DD2FFD              A   548    	LD	(IX+%FFFFFFFD),HL
                           A   549    ;   53		if(fr == FR_OK) {
                           A   550    .LINE 53
                           A   551    
0401A1 CD 31 46 04         A   552    	CALL	__icmpzero
0401A5 C2 20 04 04         A   553    	JR	NZ,L_30
                           A   554    ;   54			size = f_size(&fil);
                           A   555    .LINE 54
                           A   556    
0401A9 DD07CB              A   557    	LD	BC,(IX+%FFFFFFCB)
0401AC DD0FFA              A   558    	LD	(IX+%FFFFFFFA),BC
                           A   559    ;   55			sendStatus('F', 1, size); // fi
                           A   560    .LINE 55
                           A   561    
0401AF AF                  A   562    	XOR	A,A
0401B0 C5D1                A   563    	LD	DE,BC
0401B2 4F                  A   564    	LD	C,A
0401B3 0600                A   565    	LD	B,%0
0401B5 C5                  A   566    	PUSH	BC
0401B6 D5                  A   567    	PUSH	DE
0401B7 01010000            A   568    	LD	BC,1
0401BB C5                  A   569    	PUSH	BC
0401BC 01460000            A   570    	LD	BC,70
0401C0 C5                  A   571    	PUSH	BC
0401C1 CD 81 42 04         A   572    	CALL	_sendStatus
0401C5 C1                  A   573    	POP	BC
0401C6 C1                  A   574    	POP	BC
0401C7 C1                  A   575    	POP	BC
0401C8 C1                  A   576    	POP	BC
                           A   577    ;   56	
                           A   578    ;   57			fr = f_read(&fil, (void *)LOADA
                           A   579    .LINE 57
                           A   580    
0401C9 ED65F1              A   581    	PEA	IX+%FFFFFFF1
0401CC DD07FA              A   582    	LD	BC,(IX+%FFFFFFFA)
0401CF C5                  A   583    	PUSH	BC
0401D0 01000005            A   584    	LD	BC,327680
0401D4 C5                  A   585    	PUSH	BC
0401D5 ED65C0              A   586    	PEA	IX+%FFFFFFC0
0401D8 CD 18 35 04         A   587    	CALL	_f_read
0401DC C1                  A   588    	POP	BC
0401DD C1                  A   589    	POP	BC
0401DE C1                  A   590    	POP	BC
0401DF C1                  A   591    	POP	BC
0401E0 DD2FFD              A   592    	LD	(IX+%FFFFFFFD),HL
                           A   593    ;   58			sendStatus('M', 1, br); // file
                           A   594    .LINE 58
                           A   595    
0401E3 DD07F1              A   596    	LD	BC,(IX+%FFFFFFF1)
0401E6 AF                  A   597    	XOR	A,A
0401E7 C5D1                A   598    	LD	DE,BC
0401E9 4F                  A   599    	LD	C,A
0401EA 0600                A   600    	LD	B,%0
0401EC C5                  A   601    	PUSH	BC
0401ED D5                  A   602    	PUSH	DE
0401EE 01010000            A   603    	LD	BC,1
0401F2 C5                  A   604    	PUSH	BC
0401F3 014D0000            A   605    	LD	BC,77
0401F7 C5                  A   606    	PUSH	BC
0401F8 CD 81 42 04         A   607    	CALL	_sendStatus
0401FC C1                  A   608    	POP	BC
0401FD C1                  A   609    	POP	BC
0401FE C1                  A   610    	POP	BC
0401FF C1                  A   611    	POP	BC
                           A   612    ;   59	
                           A   613    ;   60			f_close(&fil);
                           A   614    .LINE 60
                           A   615    
040200 ED65C0              A   616    	PEA	IX+%FFFFFFC0
040203 CD 53 38 04         A   617    	CALL	_f_close
040207 C1                  A   618    	POP	BC
                           A   619    ;   61	
                           A   620    ;   62			fr = f_open(&fil, "video.ino.bi
                           A   621    .LINE 62
                           A   622    
040208 01010000            A   623    	LD	BC,1
04020C C5                  A   624    	PUSH	BC
04020D 01 88 48 04         A   625    	LD	BC,L__3
040211 C5                  A   626    	PUSH	BC
040212 ED65C0              A   627    	PEA	IX+%FFFFFFC0
040215 CD C8 33 04         A   628    	CALL	_f_open
040219 C1                  A   629    	POP	BC
04021A C1                  A   630    	POP	BC
04021B C1                  A   631    	POP	BC
04021C DD2FFD              A   632    	LD	(IX+%FFFFFFFD),HL
                           A   633    ;   63			if(fr == FR_OK) {
                           A   634    .LINE 63
                           A   635    
04021F CD 31 46 04         A   636    	CALL	__icmpzero
040223 C2 1E 03 04         A   637    	JR	NZ,L_10
                           A   638    ;   64				size = f_size(&fil);
                           A   639    .LINE 64
                           A   640    
040227 DD07CB              A   641    	LD	BC,(IX+%FFFFFFCB)
04022A DD0FFA              A   642    	LD	(IX+%FFFFFFFA),BC
                           A   643    ;   65				sendStatus('V', 1, size); /
                           A   644    .LINE 65
                           A   645    
04022D AF                  A   646    	XOR	A,A
04022E C5D1                A   647    	LD	DE,BC
040230 4F                  A   648    	LD	C,A
040231 0600                A   649    	LD	B,%0
040233 C5                  A   650    	PUSH	BC
040234 D5                  A   651    	PUSH	DE
040235 01010000            A   652    	LD	BC,1
040239 C5                  A   653    	PUSH	BC
04023A 01560000            A   654    	LD	BC,86
04023E C5                  A   655    	PUSH	BC
04023F CD 81 42 04         A   656    	CALL	_sendStatus
040243 C1                  A   657    	POP	BC
040244 C1                  A   658    	POP	BC
040245 C1                  A   659    	POP	BC
040246 C1                  A   660    	POP	BC
                           A   661    ;   66				
                           A   662    ;   67				total = 0;
                           A   663    .LINE 67
                           A   664    
040247 01000000            A   665    	LD	BC,0
04024B AF                  A   666    	XOR	A,A
04024C DD0FE3              A   667    	LD	(IX+%FFFFFFE3),BC
04024F DD77E6              A   668    	LD	(IX+%FFFFFFE6),A
                           A   669    ;   68				while(1) {
040252                     A   670    L_7:
                           A   671    .LINE 68
                           A   672    
                           A   673    ;   69					fr = f_read(&fil, (void
                           A   674    .LINE 69
                           A   675    
040252 ED65F1              A   676    	PEA	IX+%FFFFFFF1
040255 01000400            A   677    	LD	BC,1024
040259 C5                  A   678    	PUSH	BC
04025A DDE5E1              A   679    	LD	HL,IX
04025D 01C0FBFF            A   680    	LD	BC,-1088
040261 09                  A   681    	ADD	HL,BC
040262 E5C1                A   682    	LD	BC,HL
040264 C5                  A   683    	PUSH	BC
040265 ED65C0              A   684    	PEA	IX+%FFFFFFC0
040268 CD 18 35 04         A   685    	CALL	_f_read
04026C C1                  A   686    	POP	BC
04026D C1                  A   687    	POP	BC
04026E C1                  A   688    	POP	BC
04026F C1                  A   689    	POP	BC
040270 DD2FFD              A   690    	LD	(IX+%FFFFFFFD),HL
                           A   691    ;   70					if(br == 0) break;
                           A   692    .LINE 70
                           A   693    
040273 DD27F1              A   694    	LD	HL,(IX+%FFFFFFF1)
040276 CD 31 46 04         A   695    	CALL	__icmpzero
04027A CA 00 03 04         A   696    	JR	Z,L_8
                           A   697    ;   71					for(n = 0; n < br; n++)
                           A   698    .LINE 71
                           A   699    
04027E 01000000            A   700    	LD	BC,0
040282 DD0FF4              A   701    	LD	(IX+%FFFFFFF4),BC
040285 18 6A               A   702    	JR	L_4
040287                     A   703    L_2:
                           A   704    ;   72						putch(buffer[n]);
                           A   705    .LINE 72
                           A   706    
040287 DD07F4              A   707    	LD	BC,(IX+%FFFFFFF4)
04028A DDE5E1              A   708    	LD	HL,IX
04028D 11C0FBFF            A   709    	LD	DE,-1088
040291 19                  A   710    	ADD	HL,DE
040292 09                  A   711    	ADD	HL,BC
040293 7E                  A   712    	LD	A,(HL)
040294 B7ED62              A   713    	UEXT	HL
040297 6F                  A   714    	LD	L,A
040298 E5                  A   715    	PUSH	HL
040299 FDE5                A   716    	PUSH	IY
04029B C5                  A   717    	PUSH	BC
04029C FD21BFFB FF         A   718    	LD	IY,-1089
0402A1 DDE5C1              A   719    	LD	BC,IX
0402A4 FD09                A   720    	ADD	IY,BC
0402A6 FD7700              A   721    	LD	(IY),A
0402A9 C1                  A   722    	POP	BC
0402AA FDE1                A   723    	POP	IY
0402AC CD 54 42 04         A   724    	CALL	_putch
0402B0 FDE5                A   725    	PUSH	IY
0402B2 C5                  A   726    	PUSH	BC
0402B3 FD21BFFB FF         A   727    	LD	IY,-1089
0402B8 DDE5C1              A   728    	LD	BC,IX
0402BB FD09                A   729    	ADD	IY,BC
0402BD FD7E00              A   730    	LD	A,(IY)
0402C0 C1                  A   731    	POP	BC
0402C1 FDE1                A   732    	POP	IY
0402C3 C1                  A   733    	POP	BC
                           A   734    ;   73						total += buffer[n];
                           A   735    .LINE 73
                           A   736    
0402C4 DD07F4              A   737    	LD	BC,(IX+%FFFFFFF4)
0402C7 DDE5E1              A   738    	LD	HL,IX
0402CA 11C0FBFF            A   739    	LD	DE,-1088
0402CE 19                  A   740    	ADD	HL,DE
0402CF 09                  A   741    	ADD	HL,BC
0402D0 E5FDE1              A   742    	LD	IY,HL
0402D3 B7ED62              A   743    	UEXT	HL
0402D6 FD6E00              A   744    	LD	L,(IY)
0402D9 5C                  A   745    	LD	E,H
0402DA DD07E3              A   746    	LD	BC,(IX+%FFFFFFE3)
0402DD DD7EE6              A   747    	LD	A,(IX+%FFFFFFE6)
0402E0 CD F1 43 04         A   748    	CALL	__ladd
0402E4 DD2FE3              A   749    	LD	(IX+%FFFFFFE3),HL
0402E7 DD73E6              A   750    	LD	(IX+%FFFFFFE6),E
0402EA DD07F4              A   751    	LD	BC,(IX+%FFFFFFF4)
0402ED 03                  A   752    	INC	BC
0402EE DD0FF4              A   753    	LD	(IX+%FFFFFFF4),BC
                           A   754    ;   74					}
0402F1                     A   755    L_4:
                           A   756    .LINE 74
                           A   757    
0402F1 DD07F1              A   758    	LD	BC,(IX+%FFFFFFF1)
0402F4 DD27F4              A   759    	LD	HL,(IX+%FFFFFFF4)
0402F7 B7                  A   760    	OR	A,A
0402F8 ED42                A   761    	SBC	HL,BC
0402FA 38 8B               A   762    	JR	C,L_2
0402FC C3 52 02 04         A   763    	JR	L_7
                           A   764    ;   75				}
040300                     A   765    L_8:
                           A   766    .LINE 75
                           A   767    
                           A   768    ;   76				sendStatus('W', 1, total);
                           A   769    .LINE 76
                           A   770    
040300 DD4EE6              A   771    	LD	C,(IX+%FFFFFFE6)
040303 0600                A   772    	LD	B,%0
040305 C5                  A   773    	PUSH	BC
040306 DD07E3              A   774    	LD	BC,(IX+%FFFFFFE3)
040309 C5                  A   775    	PUSH	BC
04030A 01010000            A   776    	LD	BC,1
04030E C5                  A   777    	PUSH	BC
04030F 01570000            A   778    	LD	BC,87
040313 C5                  A   779    	PUSH	BC
040314 CD 81 42 04         A   780    	CALL	_sendStatus
040318 C1                  A   781    	POP	BC
040319 C1                  A   782    	POP	BC
04031A C1                  A   783    	POP	BC
04031B C1                  A   784    	POP	BC
                           A   785    ;   77			}
                           A   786    ;   78			else sendStatus('V', 0, fr);
                           A   787    .LINE 78
                           A   788    
04031C 18 20               A   789    	JR	L_12
04031E                     A   790    L_10:
04031E DD07FD              A   791    	LD	BC,(IX+%FFFFFFFD)
040321 CD CD 46 04         A   792    	CALL	__itol
040325 C5D1                A   793    	LD	DE,BC
040327 4F                  A   794    	LD	C,A
040328 0600                A   795    	LD	B,%0
04032A C5                  A   796    	PUSH	BC
04032B D5                  A   797    	PUSH	DE
04032C 01000000            A   798    	LD	BC,0
040330 C5                  A   799    	PUSH	BC
040331 01560000            A   800    	LD	BC,86
040335 C5                  A   801    	PUSH	BC
040336 CD 81 42 04         A   802    	CALL	_sendStatus
04033A C1                  A   803    	POP	BC
04033B C1                  A   804    	POP	BC
04033C C1                  A   805    	POP	BC
04033D C1                  A   806    	POP	BC
                           A   807    ;   79			while(1)
04033E                     A   808    L_12:
                           A   809    .LINE 79
                           A   810    
                           A   811    ;   80			// Wait for user to acknowledge
                           A   812    ;   81			getch();
                           A   813    .LINE 81
                           A   814    
04033E CD 7C 43 04         A   815    	CALL	_getch
040342 18 FA               A   816    	JR	L_12
                           A   817    ;   82			
                           A   818    ;   83			// Unprotect and erase flash
                           A   819    ;   84			enableFlashKeyRegister();	// 
                           A   820    ;   85			FLASH_PROT = 0;				// 
                           A   821    ;   86			enableFlashKeyRegister();	// 
                           A   822    ;   87			FLASH_FDIV = 0x5F;			// 
                           A   823    ;   88	
                           A   824    ;   89			// Mass erase flash
                           A   825    ;   90			FLASH_PGCTL = 0x01;	// mass era
                           A   826    ;   91			do {
040344                     A   827    L_15:
                           A   828    .LINE 91
                           A   829    
                           A   830    ;   92				value = FLASH_PGCTL;
                           A   831    .LINE 92
                           A   832    
040344 ED38FF              A   833    	IN0	A,(255)
040347 DD77ED              A   834    	LD	(IX+%FFFFFFED),A
                           A   835    ;   93			} while(value & 0x01); // wait 
                           A   836    .LINE 93
                           A   837    
04034A E601                A   838    	AND	A,%1
04034C 20 F6               A   839    	JR	NZ,L_15
                           A   840    ;   94			sendStatus('E', 1, 128);
                           A   841    .LINE 94
                           A   842    
04034E 01000000            A   843    	LD	BC,0
040352 C5                  A   844    	PUSH	BC
040353 01800000            A   845    	LD	BC,128
040357 C5                  A   846    	PUSH	BC
040358 01010000            A   847    	LD	BC,1
04035C C5                  A   848    	PUSH	BC
04035D 01450000            A   849    	LD	BC,69
040361 C5                  A   850    	PUSH	BC
040362 CD 81 42 04         A   851    	CALL	_sendStatus
040366 C1                  A   852    	POP	BC
040367 C1                  A   853    	POP	BC
040368 C1                  A   854    	POP	BC
040369 C1                  A   855    	POP	BC
                           A   856    ;   95	
                           A   857    ;   96			// determine number of pages to
                           A   858    ;   97			pagemax = size/PAGESIZE;
                           A   859    ;   98			if(size%PAGESIZE) // last page 
                           A   860    .LINE 98
                           A   861    
04036A 01FF0300            A   862    	LD	BC,1023
04036E DD27FA              A   863    	LD	HL,(IX+%FFFFFFFA)
040371 CD 40 47 04         A   864    	CALL	__iand
040375 DD2FE0              A   865    	LD	(IX+%FFFFFFE0),HL
040378 CD 31 46 04         A   866    	CALL	__icmpzero
04037C 28 74               A   867    	JR	Z,L_26
                           A   868    ;   99			{
                           A   869    ;  100				pagemax += 1;
                           A   870    ;  101				lastpagebytes = size%PAGESI
                           A   871    ;  102			}
                           A   872    ;  103			else lastpagebytes = PAGESIZE; 
                           A   873    .LINE 103
                           A   874    
                           A   875    ;  104	
                           A   876    ;  105			// write out each page to flash
                           A   877    ;  106			for(counter = 0; counter < page
                           A   878    .LINE 106
                           A   879    
04037E 18 72               A   880    	JR	L_26
040380                     A   881    L_24:
                           A   882    ;  107			{
                           A   883    ;  108				if(counter == (pagemax - 1)
                           A   884    .LINE 108
                           A   885    
040380 DD31E7              A   886    	LD	IY,(IX+%FFFFFFE7)
040383 ED23FF              A   887    	LEA	HL,IY+%FFFFFFFF
040386 DD07F7              A   888    	LD	BC,(IX+%FFFFFFF7)
040389 B7                  A   889    	OR	A,A
04038A ED42                A   890    	SBC	HL,BC
04038C 20 15               A   891    	JR	NZ,L_22
                           A   892    ;  109					fastmemcpy(addressto,ad
                           A   893    .LINE 109
                           A   894    
04038E DD07DD              A   895    	LD	BC,(IX+%FFFFFFDD)
040391 C5                  A   896    	PUSH	BC
040392 DD07EE              A   897    	LD	BC,(IX+%FFFFFFEE)
040395 C5                  A   898    	PUSH	BC
040396 DD07EA              A   899    	LD	BC,(IX+%FFFFFFEA)
040399 C5                  A   900    	PUSH	BC
04039A CD 26 01 04         A   901    	CALL	_fastmemcpy
04039E C1                  A   902    	POP	BC
04039F C1                  A   903    	POP	BC
0403A0 C1                  A   904    	POP	BC
                           A   905    ;  110				else 
                           A   906    .LINE 110
                           A   907    
0403A1 18 14               A   908    	JR	L_23
0403A3                     A   909    L_22:
                           A   910    ;  111					fastmemcpy(addressto,ad
                           A   911    .LINE 111
                           A   912    
0403A3 01000400            A   913    	LD	BC,1024
0403A7 C5                  A   914    	PUSH	BC
0403A8 DD07EE              A   915    	LD	BC,(IX+%FFFFFFEE)
0403AB C5                  A   916    	PUSH	BC
0403AC DD07EA              A   917    	LD	BC,(IX+%FFFFFFEA)
0403AF C5                  A   918    	PUSH	BC
0403B0 CD 26 01 04         A   919    	CALL	_fastmemcpy
0403B4 C1                  A   920    	POP	BC
0403B5 C1                  A   921    	POP	BC
0403B6 C1                  A   922    	POP	BC
0403B7                     A   923    L_23:
                           A   924    ;  112			
                           A   925    ;  113				addressto += PAGESIZE;
                           A   926    .LINE 113
                           A   927    
0403B7 01000400            A   928    	LD	BC,1024
0403BB DD27EA              A   929    	LD	HL,(IX+%FFFFFFEA)
0403BE 09                  A   930    	ADD	HL,BC
0403BF DD2FEA              A   931    	LD	(IX+%FFFFFFEA),HL
                           A   932    ;  114				addressfrom += PAGESIZE;
                           A   933    .LINE 114
                           A   934    
0403C2 DD27EE              A   935    	LD	HL,(IX+%FFFFFFEE)
0403C5 09                  A   936    	ADD	HL,BC
0403C6 DD2FEE              A   937    	LD	(IX+%FFFFFFEE),HL
                           A   938    ;  115				sendStatus('X', 1, counter+
                           A   939    .LINE 115
                           A   940    
0403C9 AF                  A   941    	XOR	A,A
0403CA 5F                  A   942    	LD	E,A
0403CB DD27F7              A   943    	LD	HL,(IX+%FFFFFFF7)
0403CE 3E01                A   944    	LD	A,%1
0403D0 CD E2 43 04         A   945    	CALL	__ladd_b
0403D4 4B                  A   946    	LD	C,E
0403D5 0600                A   947    	LD	B,%0
0403D7 C5                  A   948    	PUSH	BC
0403D8 E5                  A   949    	PUSH	HL
0403D9 01010000            A   950    	LD	BC,1
0403DD C5                  A   951    	PUSH	BC
0403DE 01580000            A   952    	LD	BC,88
0403E2 C5                  A   953    	PUSH	BC
0403E3 CD 81 42 04         A   954    	CALL	_sendStatus
0403E7 C1                  A   955    	POP	BC
0403E8 C1                  A   956    	POP	BC
0403E9 C1                  A   957    	POP	BC
0403EA C1                  A   958    	POP	BC
0403EB DD07F7              A   959    	LD	BC,(IX+%FFFFFFF7)
0403EE 03                  A   960    	INC	BC
0403EF DD0FF7              A   961    	LD	(IX+%FFFFFFF7),BC
                           A   962    ;  116			}
0403F2                     A   963    L_26:
                           A   964    .LINE 116
                           A   965    
0403F2 DD07E7              A   966    	LD	BC,(IX+%FFFFFFE7)
0403F5 DD27F7              A   967    	LD	HL,(IX+%FFFFFFF7)
0403F8 B7                  A   968    	OR	A,A
0403F9 ED42                A   969    	SBC	HL,BC
0403FB 38 83               A   970    	JR	C,L_24
                           A   971    ;  117			lockFlashKeyRegister();	// lock
                           A   972    .LINE 117
                           A   973    
0403FD CD 11 01 04         A   974    	CALL	_lockFlashKeyRegister
                           A   975    ;  118			sendStatus('P', 1, counter); //
                           A   976    .LINE 118
                           A   977    
040401 DD07F7              A   978    	LD	BC,(IX+%FFFFFFF7)
040404 AF                  A   979    	XOR	A,A
040405 C5D1                A   980    	LD	DE,BC
040407 4F                  A   981    	LD	C,A
040408 0600                A   982    	LD	B,%0
04040A C5                  A   983    	PUSH	BC
04040B D5                  A   984    	PUSH	DE
04040C 01010000            A   985    	LD	BC,1
040410 C5                  A   986    	PUSH	BC
040411 01500000            A   987    	LD	BC,80
040415 C5                  A   988    	PUSH	BC
040416 CD 81 42 04         A   989    	CALL	_sendStatus
04041A C1                  A   990    	POP	BC
04041B C1                  A   991    	POP	BC
04041C C1                  A   992    	POP	BC
04041D C1                  A   993    	POP	BC
                           A   994    ;  119		}
                           A   995    ;  120		else sendStatus('F', 0, fr); // fil
                           A   996    .LINE 120
                           A   997    
04041E 18 20               A   998    	JR	L_32
040420                     A   999    L_30:
040420 DD07FD              A  1000    	LD	BC,(IX+%FFFFFFFD)
040423 CD CD 46 04         A  1001    	CALL	__itol
040427 C5D1                A  1002    	LD	DE,BC
040429 4F                  A  1003    	LD	C,A
04042A 0600                A  1004    	LD	B,%0
04042C C5                  A  1005    	PUSH	BC
04042D D5                  A  1006    	PUSH	DE
04042E 01000000            A  1007    	LD	BC,0
040432 C5                  A  1008    	PUSH	BC
040433 01460000            A  1009    	LD	BC,70
040437 C5                  A  1010    	PUSH	BC
040438 CD 81 42 04         A  1011    	CALL	_sendStatus
04043C C1                  A  1012    	POP	BC
04043D C1                  A  1013    	POP	BC
04043E C1                  A  1014    	POP	BC
04043F C1                  A  1015    	POP	BC
                           A  1016    ;  121		while(1);
040440                     A  1017    L_32:
                           A  1018    .LINE 121
                           A  1019    
040440 18 FE               A  1020    	JR	L_32
                           A  1021    ;  122		return 0;
                           A  1022    ;  123	}
                           A  1023    .LINE 123
                           A  1024    
040442 DDF9                A  1025    	LD	SP,IX
040444 DDE1                A  1026    	POP	IX
040446 C9                  A  1027    	RET	
                           A  1028    
                           A  1029    
                           A  1030    ;**************************** _main ***********
                           A  1031    ;Name                         Addr/Register   S
                           A  1032    ;_lockFlashKeyRegister               IMPORT  --
                           A  1033    ;_fastmemcpy                         IMPORT  --
                           A  1034    ;_getch                              IMPORT  --
                           A  1035    ;_putch                              IMPORT  --
                           A  1036    ;_f_close                            IMPORT  --
                           A  1037    ;_f_read                             IMPORT  --
                           A  1038    ;_f_open                             IMPORT  --
                           A  1039    ;_sendStatus                         IMPORT  --
                           A  1040    ;_fs                                 STATIC    
                           A  1041    ;_f_mount                            IMPORT  --
                           A  1042    ;_init_UART0                         IMPORT  --
                           A  1043    ;_init_spi                           IMPORT  --
                           A  1044    ;buffer                             IX-1088   1
                           A  1045    ;fil                                  IX-64    
                           A  1046    ;lastpagebytes                        IX-35    
                           A  1047    ;G_0                                  IX-32    
                           A  1048    ;total                                IX-29    
                           A  1049    ;pagemax                              IX-25    
                           A  1050    ;addressto                            IX-22    
                           A  1051    ;value                                IX-19    
                           A  1052    ;addressfrom                          IX-18    
                           A  1053    ;br                                   IX-15    
                           A  1054    ;n                                    IX-12    
                           A  1055    ;counter                               IX-9    
                           A  1056    ;size                                  IX-6    
                           A  1057    ;fr                                    IX-3    
                           A  1058    ;argv                                  IX+9    
                           A  1059    ;argc                                  IX+6    
                           A  1060    
                           A  1061    
                           A  1062    ; Stack Frame Size: 1101 (bytes)
                           A  1063    ;       Spill Code: 0 (instruction)
                           A  1064    
                           A  1065    
                           A  1066    .ENDFUNC "main",123,"_main"
                           A  1067    	SEGMENT STRSECT
04487F                     A  1068    L__0:
04487F 00                  A  1069    	DB	0
044880                     A  1070    L__1:
044880 4D4F532E 62696E     A  1071    	DB	"MOS.bin"
044887 00                  A  1072    	DB	0
044888                     A  1073    L__3:
044888 76696465 6F2E696E   A  1074    	DB	"video.ino.bin"
044890 6F2E6269 6E 
044895 00                  A  1075    	DB	0
                           A  1076    	XREF _fastmemcpy:ROM
                           A  1077    	XREF _lockFlashKeyRegister:ROM
                           A  1078    	XREF _init_UART0:ROM
                           A  1079    	XREF _getch:ROM
                           A  1080    	XREF _putch:ROM
                           A  1081    	XREF _sendStatus:ROM
                           A  1082    	XREF _init_spi:ROM
                           A  1083    	XREF _f_mount:ROM
                           A  1084    	XREF _f_read:ROM
                           A  1085    	XREF _f_close:ROM
                           A  1086    	XREF _f_open:ROM
                           A  1087    	XREF __ladd:ROM
                           A  1088    	XREF __iand:ROM
                           A  1089    	XREF __itol:ROM
                           A  1090    	XREF __icmpzero:ROM
                           A  1091    	XREF __ladd_b:ROM
                           A  1092    	XDEF _main
                           A  1093    	XDEF _fs
                           A  1094    	END


Errors: 0
Warnings: 0
Lines Assembled: 1095
