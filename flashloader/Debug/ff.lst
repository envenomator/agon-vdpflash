Zilog eZ80 Macro Assembler Version 4.3 (19073001) RELISTED25-Oct-23     16:46:56     page:   1


PC     Object              I  Line    Source 
                           A     1    ; Zilog eZ80 ANSI C Compiler Release 3.4
                           A     2    ; -nomodsect -optsize -noreduceopt -nopadbranch
                           A     3    ; -peephole -globalopt -localcse -const=ROM 
                           A     4    	FILE	"..\src_fatfs\ff.c"
                           A     5    	.assume ADL=1
                           A     6    .DEBUG "C"
                           A     7    	SEGMENT CODE
                           A     8    .BEGREC "NONAME0",558
                           A     9    .DEFINE "fs_type"
                           A    10    .VALUE 0
                           A    11    .CLASS 8
                           A    12    .TYPE 12
                           A    13    .ENDEF
                           A    14    .DEFINE "pdrv"
                           A    15    .VALUE 1
                           A    16    .CLASS 8
                           A    17    .TYPE 12
                           A    18    .ENDEF
                           A    19    .DEFINE "n_fats"
                           A    20    .VALUE 2
                           A    21    .CLASS 8
                           A    22    .TYPE 12
                           A    23    .ENDEF
                           A    24    .DEFINE "wflag"
                           A    25    .VALUE 3
                           A    26    .CLASS 8
                           A    27    .TYPE 12
                           A    28    .ENDEF
                           A    29    .DEFINE "fsi_flag"
                           A    30    .VALUE 4
                           A    31    .CLASS 8
                           A    32    .TYPE 12
                           A    33    .ENDEF
                           A    34    .DEFINE "id"
                           A    35    .VALUE 5
                           A    36    .CLASS 8
                           A    37    .TYPE 13
                           A    38    .ENDEF
                           A    39    .DEFINE "n_rootdir"
                           A    40    .VALUE 7
                           A    41    .CLASS 8
                           A    42    .TYPE 13
                           A    43    .ENDEF
                           A    44    .DEFINE "csize"
                           A    45    .VALUE 9
                           A    46    .CLASS 8
                           A    47    .TYPE 13
                           A    48    .ENDEF
                           A    49    .DEFINE "lfnbuf"
                           A    50    .VALUE 11
                           A    51    .CLASS 8
                           A    52    .TYPE 45
                           A    53    .ENDEF
                           A    54    .DEFINE "cdir"
                           A    55    .VALUE 14
                           A    56    .CLASS 8
                           A    57    .TYPE 15
                           A    58    .ENDEF
                           A    59    .DEFINE "n_fatent"
                           A    60    .VALUE 18
                           A    61    .CLASS 8
                           A    62    .TYPE 15
                           A    63    .ENDEF
                           A    64    .DEFINE "fsize"
                           A    65    .VALUE 22
                           A    66    .CLASS 8
                           A    67    .TYPE 15
                           A    68    .ENDEF
                           A    69    .DEFINE "volbase"
                           A    70    .VALUE 26
                           A    71    .CLASS 8
                           A    72    .TYPE 15
                           A    73    .ENDEF
                           A    74    .DEFINE "fatbase"
                           A    75    .VALUE 30
                           A    76    .CLASS 8
                           A    77    .TYPE 15
                           A    78    .ENDEF
                           A    79    .DEFINE "dirbase"
                           A    80    .VALUE 34
                           A    81    .CLASS 8
                           A    82    .TYPE 15
                           A    83    .ENDEF
                           A    84    .DEFINE "database"
                           A    85    .VALUE 38
                           A    86    .CLASS 8
                           A    87    .TYPE 15
                           A    88    .ENDEF
                           A    89    .DEFINE "winsect"
                           A    90    .VALUE 42
                           A    91    .CLASS 8
                           A    92    .TYPE 15
                           A    93    .ENDEF
                           A    94    .DEFINE "win"
                           A    95    .VALUE 46
                           A    96    .CLASS 8
                           A    97    .DIM 512
                           A    98    .TYPE 108
                           A    99    .ENDEF
                           A   100    .ENDREC "NONAME0"
                           A   101    .BEGREC "NONAME1",15
                           A   102    .DEFINE "fs"
                           A   103    .VALUE 0
                           A   104    .CLASS 8
                           A   105    .TAG "NONAME0"
                           A   106    .TYPE 40
                           A   107    .ENDEF
                           A   108    .DEFINE "id"
                           A   109    .VALUE 3
                           A   110    .CLASS 8
                           A   111    .TYPE 13
                           A   112    .ENDEF
                           A   113    .DEFINE "attr"
                           A   114    .VALUE 5
                           A   115    .CLASS 8
                           A   116    .TYPE 12
                           A   117    .ENDEF
                           A   118    .DEFINE "stat"
                           A   119    .VALUE 6
                           A   120    .CLASS 8
                           A   121    .TYPE 12
                           A   122    .ENDEF
                           A   123    .DEFINE "sclust"
                           A   124    .VALUE 7
                           A   125    .CLASS 8
                           A   126    .TYPE 15
                           A   127    .ENDEF
                           A   128    .DEFINE "objsize"
                           A   129    .VALUE 11
                           A   130    .CLASS 8
                           A   131    .TYPE 15
                           A   132    .ENDEF
                           A   133    .ENDREC "NONAME1"
                           A   134    .BEGREC "NONAME2",541
                           A   135    .DEFINE "obj"
                           A   136    .VALUE 0
                           A   137    .CLASS 8
                           A   138    .TAG "NONAME1"
                           A   139    .TYPE 8
                           A   140    .ENDEF
                           A   141    .DEFINE "flag"
                           A   142    .VALUE 15
                           A   143    .CLASS 8
                           A   144    .TYPE 12
                           A   145    .ENDEF
                           A   146    .DEFINE "err"
                           A   147    .VALUE 16
                           A   148    .CLASS 8
                           A   149    .TYPE 12
                           A   150    .ENDEF
                           A   151    .DEFINE "fptr"
                           A   152    .VALUE 17
                           A   153    .CLASS 8
                           A   154    .TYPE 15
                           A   155    .ENDEF
                           A   156    .DEFINE "clust"
                           A   157    .VALUE 21
                           A   158    .CLASS 8
                           A   159    .TYPE 15
                           A   160    .ENDEF
                           A   161    .DEFINE "sect"
                           A   162    .VALUE 25
                           A   163    .CLASS 8
                           A   164    .TYPE 15
                           A   165    .ENDEF
                           A   166    .DEFINE "buf"
                           A   167    .VALUE 29
                           A   168    .CLASS 8
                           A   169    .DIM 512
                           A   170    .TYPE 108
                           A   171    .ENDEF
                           A   172    .ENDREC "NONAME2"
                           A   173    .BEGREC "NONAME3",46
                           A   174    .DEFINE "obj"
                           A   175    .VALUE 0
                           A   176    .CLASS 8
                           A   177    .TAG "NONAME1"
                           A   178    .TYPE 8
                           A   179    .ENDEF
                           A   180    .DEFINE "dptr"
                           A   181    .VALUE 15
                           A   182    .CLASS 8
                           A   183    .TYPE 15
                           A   184    .ENDEF
                           A   185    .DEFINE "clust"
                           A   186    .VALUE 19
                           A   187    .CLASS 8
                           A   188    .TYPE 15
                           A   189    .ENDEF
                           A   190    .DEFINE "sect"
                           A   191    .VALUE 23
                           A   192    .CLASS 8
                           A   193    .TYPE 15
                           A   194    .ENDEF
                           A   195    .DEFINE "dir"
                           A   196    .VALUE 27
                           A   197    .CLASS 8
                           A   198    .TYPE 44
                           A   199    .ENDEF
                           A   200    .DEFINE "fn"
                           A   201    .VALUE 30
                           A   202    .CLASS 8
                           A   203    .DIM 12
                           A   204    .TYPE 108
                           A   205    .ENDEF
                           A   206    .DEFINE "blk_ofs"
                           A   207    .VALUE 42
                           A   208    .CLASS 8
                           A   209    .TYPE 15
                           A   210    .ENDEF
                           A   211    .ENDREC "NONAME3"
                           A   212    .BEGREC "NONAME4",278
                           A   213    .DEFINE "fsize"
                           A   214    .VALUE 0
                           A   215    .CLASS 8
                           A   216    .TYPE 15
                           A   217    .ENDEF
                           A   218    .DEFINE "fdate"
                           A   219    .VALUE 4
                           A   220    .CLASS 8
                           A   221    .TYPE 13
                           A   222    .ENDEF
                           A   223    .DEFINE "ftime"
                           A   224    .VALUE 6
                           A   225    .CLASS 8
                           A   226    .TYPE 13
                           A   227    .ENDEF
                           A   228    .DEFINE "fattrib"
                           A   229    .VALUE 8
                           A   230    .CLASS 8
                           A   231    .TYPE 12
                           A   232    .ENDEF
                           A   233    .DEFINE "altname"
                           A   234    .VALUE 9
                           A   235    .CLASS 8
                           A   236    .DIM 13
                           A   237    .TYPE 98
                           A   238    .ENDEF
                           A   239    .DEFINE "fname"
                           A   240    .VALUE 22
                           A   241    .CLASS 8
                           A   242    .DIM 256
                           A   243    .TYPE 98
                           A   244    .ENDEF
                           A   245    .ENDREC "NONAME4"
                           A   246    .BEGREC "NONAME5",12
                           A   247    .DEFINE "fmt"
                           A   248    .VALUE 0
                           A   249    .CLASS 8
                           A   250    .TYPE 12
                           A   251    .ENDEF
                           A   252    .DEFINE "n_fat"
                           A   253    .VALUE 1
                           A   254    .CLASS 8
                           A   255    .TYPE 12
                           A   256    .ENDEF
                           A   257    .DEFINE "align"
                           A   258    .VALUE 2
                           A   259    .CLASS 8
                           A   260    .TYPE 14
                           A   261    .ENDEF
                           A   262    .DEFINE "n_root"
                           A   263    .VALUE 5
                           A   264    .CLASS 8
                           A   265    .TYPE 14
                           A   266    .ENDEF
                           A   267    .DEFINE "au_size"
                           A   268    .VALUE 8
                           A   269    .CLASS 8
                           A   270    .TYPE 15
                           A   271    .ENDEF
                           A   272    .ENDREC "NONAME5"
                           A   273    	SEGMENT BSS
044FC6                     A   274    _FatFs:
044FC6                     A   275    	DS	3
                           A   276    .DEFINE "FatFs"
                           A   277    .ALIAS "_FatFs"
                           A   278    .CLASS 83
                           A   279    .VALUE _FatFs
                           A   280    .DIM 1
                           A   281    .TAG "NONAME0"
                           A   282    .TYPE 360
                           A   283    .ENDEF
044FC9                     A   284    _Fsid:
044FC9                     A   285    	DS	2*1
                           A   286    .DEFINE "Fsid"
                           A   287    .ALIAS "_Fsid"
                           A   288    .CLASS 83
                           A   289    .VALUE _Fsid
                           A   290    .TYPE 13
                           A   291    .ENDEF
044FCB                     A   292    _CurrVol:
044FCB                     A   293    	DS	1
                           A   294    .DEFINE "CurrVol"
                           A   295    .ALIAS "_CurrVol"
                           A   296    .CLASS 83
                           A   297    .VALUE _CurrVol
                           A   298    .TYPE 12
                           A   299    .ENDEF
                           A   300    	SEGMENT TEXT
044CE1                     A   301    _LfnOfs:
044CE1 01                  A   302    	DB	1
044CE2 03                  A   303    	DB	3
044CE3 05                  A   304    	DB	5
044CE4 07                  A   305    	DB	7
044CE5 09                  A   306    	DB	9
044CE6 0E                  A   307    	DB	14
044CE7 10                  A   308    	DB	16
044CE8 12                  A   309    	DB	18
044CE9 14                  A   310    	DB	20
044CEA 16                  A   311    	DB	22
044CEB 18                  A   312    	DB	24
044CEC 1C                  A   313    	DB	28
044CED 1E                  A   314    	DB	30
                           A   315    .DEFINE "LfnOfs"
                           A   316    .ALIAS "_LfnOfs"
                           A   317    .CLASS 84
                           A   318    .VALUE _LfnOfs
                           A   319    .DIM 13
                           A   320    .TYPE 108
                           A   321    .ENDEF
044CEE                     A   322    _ExCvt:
044CEE 80                  A   323    	DB	128
044CEF 9A                  A   324    	DB	154
044CF0 45                  A   325    	DB	69
044CF1 41                  A   326    	DB	65
044CF2 8E                  A   327    	DB	142
044CF3 41                  A   328    	DB	65
044CF4 8F                  A   329    	DB	143
044CF5 80                  A   330    	DB	128
044CF6 45                  A   331    	DB	69
044CF7 45                  A   332    	DB	69
044CF8 45                  A   333    	DB	69
044CF9 49                  A   334    	DB	73
044CFA 49                  A   335    	DB	73
044CFB 49                  A   336    	DB	73
044CFC 8E                  A   337    	DB	142
044CFD 8F                  A   338    	DB	143
044CFE 90                  A   339    	DB	144
044CFF 92                  A   340    	DB	146
044D00 92                  A   341    	DB	146
044D01 4F                  A   342    	DB	79
044D02 99                  A   343    	DB	153
044D03 4F                  A   344    	DB	79
044D04 55                  A   345    	DB	85
044D05 55                  A   346    	DB	85
044D06 59                  A   347    	DB	89
044D07 99                  A   348    	DB	153
044D08 9A                  A   349    	DB	154
044D09 9B                  A   350    	DB	155
044D0A 9C                  A   351    	DB	156
044D0B 9D                  A   352    	DB	157
044D0C 9E                  A   353    	DB	158
044D0D 9F                  A   354    	DB	159
044D0E 41                  A   355    	DB	65
044D0F 49                  A   356    	DB	73
044D10 4F                  A   357    	DB	79
044D11 55                  A   358    	DB	85
044D12 A5                  A   359    	DB	165
044D13 A5                  A   360    	DB	165
044D14 A6                  A   361    	DB	166
044D15 A7                  A   362    	DB	167
044D16 A8                  A   363    	DB	168
044D17 A9                  A   364    	DB	169
044D18 AA                  A   365    	DB	170
044D19 AB                  A   366    	DB	171
044D1A AC                  A   367    	DB	172
044D1B AD                  A   368    	DB	173
044D1C AE                  A   369    	DB	174
044D1D AF                  A   370    	DB	175
044D1E B0                  A   371    	DB	176
044D1F B1                  A   372    	DB	177
044D20 B2                  A   373    	DB	178
044D21 B3                  A   374    	DB	179
044D22 B4                  A   375    	DB	180
044D23 B5                  A   376    	DB	181
044D24 B6                  A   377    	DB	182
044D25 B7                  A   378    	DB	183
044D26 B8                  A   379    	DB	184
044D27 B9                  A   380    	DB	185
044D28 BA                  A   381    	DB	186
044D29 BB                  A   382    	DB	187
044D2A BC                  A   383    	DB	188
044D2B BD                  A   384    	DB	189
044D2C BE                  A   385    	DB	190
044D2D BF                  A   386    	DB	191
044D2E C0                  A   387    	DB	192
044D2F C1                  A   388    	DB	193
044D30 C2                  A   389    	DB	194
044D31 C3                  A   390    	DB	195
044D32 C4                  A   391    	DB	196
044D33 C5                  A   392    	DB	197
044D34 C6                  A   393    	DB	198
044D35 C7                  A   394    	DB	199
044D36 C8                  A   395    	DB	200
044D37 C9                  A   396    	DB	201
044D38 CA                  A   397    	DB	202
044D39 CB                  A   398    	DB	203
044D3A CC                  A   399    	DB	204
044D3B CD                  A   400    	DB	205
044D3C CE                  A   401    	DB	206
044D3D CF                  A   402    	DB	207
044D3E D0                  A   403    	DB	208
044D3F D1                  A   404    	DB	209
044D40 D2                  A   405    	DB	210
044D41 D3                  A   406    	DB	211
044D42 D4                  A   407    	DB	212
044D43 D5                  A   408    	DB	213
044D44 D6                  A   409    	DB	214
044D45 D7                  A   410    	DB	215
044D46 D8                  A   411    	DB	216
044D47 D9                  A   412    	DB	217
044D48 DA                  A   413    	DB	218
044D49 DB                  A   414    	DB	219
044D4A DC                  A   415    	DB	220
044D4B DD                  A   416    	DB	221
044D4C DE                  A   417    	DB	222
044D4D DF                  A   418    	DB	223
044D4E E0                  A   419    	DB	224
044D4F E1                  A   420    	DB	225
044D50 E2                  A   421    	DB	226
044D51 E3                  A   422    	DB	227
044D52 E4                  A   423    	DB	228
044D53 E5                  A   424    	DB	229
044D54 E6                  A   425    	DB	230
044D55 E7                  A   426    	DB	231
044D56 E8                  A   427    	DB	232
044D57 E9                  A   428    	DB	233
044D58 EA                  A   429    	DB	234
044D59 EB                  A   430    	DB	235
044D5A EC                  A   431    	DB	236
044D5B ED                  A   432    	DB	237
044D5C EE                  A   433    	DB	238
044D5D EF                  A   434    	DB	239
044D5E F0                  A   435    	DB	240
044D5F F1                  A   436    	DB	241
044D60 F2                  A   437    	DB	242
044D61 F3                  A   438    	DB	243
044D62 F4                  A   439    	DB	244
044D63 F5                  A   440    	DB	245
044D64 F6                  A   441    	DB	246
044D65 F7                  A   442    	DB	247
044D66 F8                  A   443    	DB	248
044D67 F9                  A   444    	DB	249
044D68 FA                  A   445    	DB	250
044D69 FB                  A   446    	DB	251
044D6A FC                  A   447    	DB	252
044D6B FD                  A   448    	DB	253
044D6C FE                  A   449    	DB	254
044D6D FF                  A   450    	DB	255
                           A   451    .DEFINE "ExCvt"
                           A   452    .ALIAS "_ExCvt"
                           A   453    .CLASS 84
                           A   454    .VALUE _ExCvt
                           A   455    .DIM 128
                           A   456    .TYPE 108
                           A   457    .ENDEF
                           A   458    ;    1	/*-------------------------------------
                           A   459    ;    2	/  FatFs - Generic FAT Filesystem Modul
                           A   460    ;    3	/--------------------------------------
                           A   461    ;    4	/
                           A   462    ;    5	/ Copyright (C) 2021, ChaN, all right r
                           A   463    ;    6	/
                           A   464    ;    7	/ FatFs module is an open source softwa
                           A   465    ;    8	/ source and binary forms, with or with
                           A   466    ;    9	/ that the following condition is met:
                           A   467    ;   10	/
                           A   468    ;   11	/ 1. Redistributions of source code mus
                           A   469    ;   12	/    this condition and the following d
                           A   470    ;   13	/
                           A   471    ;   14	/ This software is provided by the copy
                           A   472    ;   15	/ and any warranties related to this so
                           A   473    ;   16	/ The copyright owner or contributors b
                           A   474    ;   17	/ by use of this software.
                           A   475    ;   18	/
                           A   476    ;   19	/--------------------------------------
                           A   477    ;   20	
                           A   478    ;   21	#include <string.h>
                           A   479    ;   22	
                           A   480    ;   23	#include "ff.h"			/* Declarations
                           A   481    ;   24	#include "diskio.h"		/* Declarations
                           A   482    ;   25	
                           A   483    ;   26	
                           A   484    ;   27	/*-------------------------------------
                           A   485    ;   28	
                           A   486    ;   29	   Module Private Definitions
                           A   487    ;   30	
                           A   488    ;   31	---------------------------------------
                           A   489    ;   32	
                           A   490    ;   33	#if FF_DEFINED != 86631	/* Revision ID 
                           A   491    ;   34	#error Wrong include file (ff.h).
                           A   492    ;   35	#endif
                           A   493    ;   36	
                           A   494    ;   37	
                           A   495    ;   38	/* Limits and boundaries */
                           A   496    ;   39	#define MAX_DIR		0x200000		/* 
                           A   497    ;   40	#define MAX_DIR_EX	0x10000000		/* 
                           A   498    ;   41	#define MAX_FAT12	0xFF5			/* 
                           A   499    ;   42	#define MAX_FAT16	0xFFF5			/* 
                           A   500    ;   43	#define MAX_FAT32	0x0FFFFFF5		/* 
                           A   501    ;   44	#define MAX_EXFAT	0x7FFFFFFD		/* 
                           A   502    ;   45	
                           A   503    ;   46	
                           A   504    ;   47	/* Character code support macros */
                           A   505    ;   48	#define IsUpper(c)		((c) >= 'A' && 
                           A   506    ;   49	#define IsLower(c)		((c) >= 'a' && 
                           A   507    ;   50	#define IsDigit(c)		((c) >= '0' && 
                           A   508    ;   51	#define IsSeparator(c)	((c) == '/' || 
                           A   509    ;   52	#define IsTerminator(c)	((UINT)(c) < (F
                           A   510    ;   53	#define IsSurrogate(c)	((c) >= 0xD800 
                           A   511    ;   54	#define IsSurrogateH(c)	((c) >= 0xD800 
                           A   512    ;   55	#define IsSurrogateL(c)	((c) >= 0xDC00 
                           A   513    ;   56	
                           A   514    ;   57	
                           A   515    ;   58	/* Additional file access control and f
                           A   516    ;   59	#define FA_SEEKEND	0x20	/* Seek to 
                           A   517    ;   60	#define FA_MODIFIED	0x40	/* File has
                           A   518    ;   61	#define FA_DIRTY	0x80	/* FIL.buf[
                           A   519    ;   62	
                           A   520    ;   63	
                           A   521    ;   64	/* Additional file attribute bits for i
                           A   522    ;   65	#define AM_VOL		0x08	/* Volume l
                           A   523    ;   66	#define AM_LFN		0x0F	/* LFN entr
                           A   524    ;   67	#define AM_MASK		0x3F	/* Mask of 
                           A   525    ;   68	#define AM_MASKX	0x37	/* Mask of 
                           A   526    ;   69	
                           A   527    ;   70	
                           A   528    ;   71	/* Name status flags in fn[11] */
                           A   529    ;   72	#define NSFLAG		11		/* Index of
                           A   530    ;   73	#define NS_LOSS		0x01	/* Out of 8
                           A   531    ;   74	#define NS_LFN		0x02	/* Force to
                           A   532    ;   75	#define NS_LAST		0x04	/* Last seg
                           A   533    ;   76	#define NS_BODY		0x08	/* Lower ca
                           A   534    ;   77	#define NS_EXT		0x10	/* Lower ca
                           A   535    ;   78	#define NS_DOT		0x20	/* Dot entr
                           A   536    ;   79	#define NS_NOLFN	0x40	/* Do not f
                           A   537    ;   80	#define NS_NONAME	0x80	/* Not foll
                           A   538    ;   81	
                           A   539    ;   82	
                           A   540    ;   83	/* exFAT directory entry types */
                           A   541    ;   84	#define	ET_BITMAP	0x81	/* Allocati
                           A   542    ;   85	#define	ET_UPCASE	0x82	/* Up-case 
                           A   543    ;   86	#define	ET_VLABEL	0x83	/* Volume l
                           A   544    ;   87	#define	ET_FILEDIR	0x85	/* File and
                           A   545    ;   88	#define	ET_STREAM	0xC0	/* Stream e
                           A   546    ;   89	#define	ET_FILENAME	0xC1	/* Name ext
                           A   547    ;   90	
                           A   548    ;   91	
                           A   549    ;   92	/* FatFs refers the FAT structure as si
                           A   550    ;   93	/ because the C structure is not binary
                           A   551    ;   94	
                           A   552    ;   95	#define BS_JmpBoot			0		/* 
                           A   553    ;   96	#define BS_OEMName			3		/* 
                           A   554    ;   97	#define BPB_BytsPerSec		11		/* 
                           A   555    ;   98	#define BPB_SecPerClus		13		/* 
                           A   556    ;   99	#define BPB_RsvdSecCnt		14		/* 
                           A   557    ;  100	#define BPB_NumFATs			16		/* 
                           A   558    ;  101	#define BPB_RootEntCnt		17		/* 
                           A   559    ;  102	#define BPB_TotSec16		19		/* 
                           A   560    ;  103	#define BPB_Media			21		/* 
                           A   561    ;  104	#define BPB_FATSz16			22		/* 
                           A   562    ;  105	#define BPB_SecPerTrk		24		/* 
                           A   563    ;  106	#define BPB_NumHeads		26		/* 
                           A   564    ;  107	#define BPB_HiddSec			28		/* 
                           A   565    ;  108	#define BPB_TotSec32		32		/* 
                           A   566    ;  109	#define BS_DrvNum			36		/* 
                           A   567    ;  110	#define BS_NTres			37		/* 
                           A   568    ;  111	#define BS_BootSig			38		/* 
                           A   569    ;  112	#define BS_VolID			39		/* 
                           A   570    ;  113	#define BS_VolLab			43		/* 
                           A   571    ;  114	#define BS_FilSysType		54		/* 
                           A   572    ;  115	#define BS_BootCode			62		/* 
                           A   573    ;  116	#define BS_55AA				510		/* 
                           A   574    ;  117	
                           A   575    ;  118	#define BPB_FATSz32			36		/* 
                           A   576    ;  119	#define BPB_ExtFlags32		40		/* 
                           A   577    ;  120	#define BPB_FSVer32			42		/* 
                           A   578    ;  121	#define BPB_RootClus32		44		/* 
                           A   579    ;  122	#define BPB_FSInfo32		48		/* 
                           A   580    ;  123	#define BPB_BkBootSec32		50		/* 
                           A   581    ;  124	#define BS_DrvNum32			64		/* 
                           A   582    ;  125	#define BS_NTres32			65		/* 
                           A   583    ;  126	#define BS_BootSig32		66		/* 
                           A   584    ;  127	#define BS_VolID32			67		/* 
                           A   585    ;  128	#define BS_VolLab32			71		/* 
                           A   586    ;  129	#define BS_FilSysType32		82		/* 
                           A   587    ;  130	#define BS_BootCode32		90		/* 
                           A   588    ;  131	
                           A   589    ;  132	#define BPB_ZeroedEx		11		/* 
                           A   590    ;  133	#define BPB_VolOfsEx		64		/* 
                           A   591    ;  134	#define BPB_TotSecEx		72		/* 
                           A   592    ;  135	#define BPB_FatOfsEx		80		/* 
                           A   593    ;  136	#define BPB_FatSzEx			84		/* 
                           A   594    ;  137	#define BPB_DataOfsEx		88		/* 
                           A   595    ;  138	#define BPB_NumClusEx		92		/* 
                           A   596    ;  139	#define BPB_RootClusEx		96		/* 
                           A   597    ;  140	#define BPB_VolIDEx			100		/* 
                           A   598    ;  141	#define BPB_FSVerEx			104		/* 
                           A   599    ;  142	#define BPB_VolFlagEx		106		/* 
                           A   600    ;  143	#define BPB_BytsPerSecEx	108		/* 
                           A   601    ;  144	#define BPB_SecPerClusEx	109		/* 
                           A   602    ;  145	#define BPB_NumFATsEx		110		/* 
                           A   603    ;  146	#define BPB_DrvNumEx		111		/* 
                           A   604    ;  147	#define BPB_PercInUseEx		112		/* 
                           A   605    ;  148	#define BPB_RsvdEx			113		/* 
                           A   606    ;  149	#define BS_BootCodeEx		120		/* 
                           A   607    ;  150	
                           A   608    ;  151	#define DIR_Name			0		/* 
                           A   609    ;  152	#define DIR_Attr			11		/* 
                           A   610    ;  153	#define DIR_NTres			12		/* 
                           A   611    ;  154	#define DIR_CrtTime10		13		/* 
                           A   612    ;  155	#define DIR_CrtTime			14		/* 
                           A   613    ;  156	#define DIR_LstAccDate		18		/* 
                           A   614    ;  157	#define DIR_FstClusHI		20		/* 
                           A   615    ;  158	#define DIR_ModTime			22		/* 
                           A   616    ;  159	#define DIR_FstClusLO		26		/* 
                           A   617    ;  160	#define DIR_FileSize		28		/* 
                           A   618    ;  161	#define LDIR_Ord			0		/* 
                           A   619    ;  162	#define LDIR_Attr			11		/* 
                           A   620    ;  163	#define LDIR_Type			12		/* 
                           A   621    ;  164	#define LDIR_Chksum			13		/* 
                           A   622    ;  165	#define LDIR_FstClusLO		26		/* 
                           A   623    ;  166	#define XDIR_Type			0		/* 
                           A   624    ;  167	#define XDIR_NumLabel		1		/* 
                           A   625    ;  168	#define XDIR_Label			2		/* 
                           A   626    ;  169	#define XDIR_CaseSum		4		/* 
                           A   627    ;  170	#define XDIR_NumSec			1		/* 
                           A   628    ;  171	#define XDIR_SetSum			2		/* 
                           A   629    ;  172	#define XDIR_Attr			4		/* 
                           A   630    ;  173	#define XDIR_CrtTime		8		/* 
                           A   631    ;  174	#define XDIR_ModTime		12		/* 
                           A   632    ;  175	#define XDIR_AccTime		16		/* 
                           A   633    ;  176	#define XDIR_CrtTime10		20		/* 
                           A   634    ;  177	#define XDIR_ModTime10		21		/* 
                           A   635    ;  178	#define XDIR_CrtTZ			22		/* 
                           A   636    ;  179	#define XDIR_ModTZ			23		/* 
                           A   637    ;  180	#define XDIR_AccTZ			24		/* 
                           A   638    ;  181	#define XDIR_GenFlags		33		/* 
                           A   639    ;  182	#define XDIR_NumName		35		/* 
                           A   640    ;  183	#define XDIR_NameHash		36		/* 
                           A   641    ;  184	#define XDIR_ValidFileSize	40		/* 
                           A   642    ;  185	#define XDIR_FstClus		52		/* 
                           A   643    ;  186	#define XDIR_FileSize		56		/* 
                           A   644    ;  187	
                           A   645    ;  188	#define SZDIRE				32		/* 
                           A   646    ;  189	#define DDEM				0xE5	/* 
                           A   647    ;  190	#define RDDEM				0x05	/* 
                           A   648    ;  191	#define LLEF				0x40	/* 
                           A   649    ;  192	
                           A   650    ;  193	#define FSI_LeadSig			0		/* 
                           A   651    ;  194	#define FSI_StrucSig		484		/* 
                           A   652    ;  195	#define FSI_Free_Count		488		/* 
                           A   653    ;  196	#define FSI_Nxt_Free		492		/* 
                           A   654    ;  197	
                           A   655    ;  198	#define MBR_Table			446		/* 
                           A   656    ;  199	#define SZ_PTE				16		/* 
                           A   657    ;  200	#define PTE_Boot			0		/* 
                           A   658    ;  201	#define PTE_StHead			1		/* 
                           A   659    ;  202	#define PTE_StSec			2		/* 
                           A   660    ;  203	#define PTE_StCyl			3		/* 
                           A   661    ;  204	#define PTE_System			4		/* 
                           A   662    ;  205	#define PTE_EdHead			5		/* 
                           A   663    ;  206	#define PTE_EdSec			6		/* 
                           A   664    ;  207	#define PTE_EdCyl			7		/* 
                           A   665    ;  208	#define PTE_StLba			8		/* 
                           A   666    ;  209	#define PTE_SizLba			12		/* 
                           A   667    ;  210	
                           A   668    ;  211	#define GPTH_Sign			0		/* 
                           A   669    ;  212	#define GPTH_Rev			8		/* 
                           A   670    ;  213	#define GPTH_Size			12		/* 
                           A   671    ;  214	#define GPTH_Bcc			16		/* 
                           A   672    ;  215	#define GPTH_CurLba			24		/* 
                           A   673    ;  216	#define GPTH_BakLba			32		/* 
                           A   674    ;  217	#define GPTH_FstLba			40		/* 
                           A   675    ;  218	#define GPTH_LstLba			48		/* 
                           A   676    ;  219	#define GPTH_DskGuid		56		/* 
                           A   677    ;  220	#define GPTH_PtOfs			72		/* 
                           A   678    ;  221	#define GPTH_PtNum			80		/* 
                           A   679    ;  222	#define GPTH_PteSize		84		/* 
                           A   680    ;  223	#define GPTH_PtBcc			88		/* 
                           A   681    ;  224	#define SZ_GPTE				128		/* 
                           A   682    ;  225	#define GPTE_PtGuid			0		/* 
                           A   683    ;  226	#define GPTE_UpGuid			16		/* 
                           A   684    ;  227	#define GPTE_FstLba			32		/* 
                           A   685    ;  228	#define GPTE_LstLba			40		/* 
                           A   686    ;  229	#define GPTE_Flags			48		/* 
                           A   687    ;  230	#define GPTE_Name			56		/* 
                           A   688    ;  231	
                           A   689    ;  232	
                           A   690    ;  233	/* Post process on fatal error in the f
                           A   691    ;  234	#define ABORT(fs, res)		{ fp->err =
                           A   692    ;  235	
                           A   693    ;  236	
                           A   694    ;  237	/* Re-entrancy related */
                           A   695    ;  238	#if FF_FS_REENTRANT
                           A   696    ;  239	#if FF_USE_LFN == 1
                           A   697    ;  240	#error Static LFN work area cannot be u
                           A   698    ;  241	#endif
                           A   699    ;  242	#define LEAVE_FF(fs, res)	{ unlock_fs
                           A   700    ;  243	#else
                           A   701    ;  244	#define LEAVE_FF(fs, res)	return res
                           A   702    ;  245	#endif
                           A   703    ;  246	
                           A   704    ;  247	
                           A   705    ;  248	/* Definitions of logical drive - physi
                           A   706    ;  249	#if FF_MULTI_PARTITION
                           A   707    ;  250	#define LD2PD(vol) VolToPart[vol].pd	
                           A   708    ;  251	#define LD2PT(vol) VolToPart[vol].pt	
                           A   709    ;  252	#else
                           A   710    ;  253	#define LD2PD(vol) (BYTE)(vol)	/* Each
                           A   711    ;  254	#define LD2PT(vol) 0			/* Auto
                           A   712    ;  255	#endif
                           A   713    ;  256	
                           A   714    ;  257	
                           A   715    ;  258	/* Definitions of sector size */
                           A   716    ;  259	#if (FF_MAX_SS < FF_MIN_SS) || (FF_MAX_
                           A   717    ;  260	#error Wrong sector size configuration
                           A   718    ;  261	#endif
                           A   719    ;  262	#if FF_MAX_SS == FF_MIN_SS
                           A   720    ;  263	#define SS(fs)	((UINT)FF_MAX_SS)	/* 
                           A   721    ;  264	#else
                           A   722    ;  265	#define SS(fs)	((fs)->ssize)	/* Vari
                           A   723    ;  266	#endif
                           A   724    ;  267	
                           A   725    ;  268	
                           A   726    ;  269	/* Timestamp */
                           A   727    ;  270	#if FF_FS_NORTC == 1
                           A   728    ;  271	#if FF_NORTC_YEAR < 1980 || FF_NORTC_YE
                           A   729    ;  272	#error Invalid FF_FS_NORTC settings
                           A   730    ;  273	#endif
                           A   731    ;  274	#define GET_FATTIME()	((DWORD)(FF_NOR
                           A   732    ;  275	#else
                           A   733    ;  276	#define GET_FATTIME()	get_fattime()
                           A   734    ;  277	#endif
                           A   735    ;  278	
                           A   736    ;  279	
                           A   737    ;  280	/* File lock controls */
                           A   738    ;  281	#if FF_FS_LOCK != 0
                           A   739    ;  282	#if FF_FS_READONLY
                           A   740    ;  283	#error FF_FS_LOCK must be 0 at read-onl
                           A   741    ;  284	#endif
                           A   742    ;  285	typedef struct {
                           A   743    ;  286		FATFS *fs;		/* Object ID 1, vol
                           A   744    ;  287		DWORD clu;		/* Object ID 2, con
                           A   745    ;  288		DWORD ofs;		/* Object ID 3, off
                           A   746    ;  289		WORD ctr;		/* Object open coun
                           A   747    ;  290	} FILESEM;
                           A   748    ;  291	#endif
                           A   749    ;  292	
                           A   750    ;  293	
                           A   751    ;  294	/* SBCS up-case tables (\x80-\xFF) */
                           A   752    ;  295	#define TBL_CT437  {0x80,0x9A,0x45,0x41
                           A   753    ;  296						0x90,0x92,0x92,0x4F
                           A   754    ;  297						0x41,0x49,0x4F,0x55
                           A   755    ;  298						0xB0,0xB1,0xB2,0xB3
                           A   756    ;  299						0xC0,0xC1,0xC2,0xC3
                           A   757    ;  300						0xD0,0xD1,0xD2,0xD3
                           A   758    ;  301						0xE0,0xE1,0xE2,0xE3
                           A   759    ;  302						0xF0,0xF1,0xF2,0xF3
                           A   760    ;  303	#define TBL_CT720  {0x80,0x81,0x82,0x83
                           A   761    ;  304						0x90,0x91,0x92,0x93
                           A   762    ;  305						0xA0,0xA1,0xA2,0xA3
                           A   763    ;  306						0xB0,0xB1,0xB2,0xB3
                           A   764    ;  307						0xC0,0xC1,0xC2,0xC3
                           A   765    ;  308						0xD0,0xD1,0xD2,0xD3
                           A   766    ;  309						0xE0,0xE1,0xE2,0xE3
                           A   767    ;  310						0xF0,0xF1,0xF2,0xF3
                           A   768    ;  311	#define TBL_CT737  {0x80,0x81,0x82,0x83
                           A   769    ;  312						0x90,0x92,0x92,0x93
                           A   770    ;  313						0x88,0x89,0x8A,0x8B
                           A   771    ;  314						0xB0,0xB1,0xB2,0xB3
                           A   772    ;  315						0xC0,0xC1,0xC2,0xC3
                           A   773    ;  316						0xD0,0xD1,0xD2,0xD3
                           A   774    ;  317						0x97,0xEA,0xEB,0xEC
                           A   775    ;  318						0xF0,0xF1,0xF2,0xF3
                           A   776    ;  319	#define TBL_CT771  {0x80,0x81,0x82,0x83
                           A   777    ;  320						0x90,0x91,0x92,0x93
                           A   778    ;  321						0x80,0x81,0x82,0x83
                           A   779    ;  322						0xB0,0xB1,0xB2,0xB3
                           A   780    ;  323						0xC0,0xC1,0xC2,0xC3
                           A   781    ;  324						0xD0,0xD1,0xD2,0xD3
                           A   782    ;  325						0x90,0x91,0x92,0x93
                           A   783    ;  326						0xF0,0xF0,0xF2,0xF2
                           A   784    ;  327	#define TBL_CT775  {0x80,0x9A,0x91,0xA0
                           A   785    ;  328						0x90,0x92,0x92,0xE2
                           A   786    ;  329						0xA0,0xA1,0xE0,0xA3
                           A   787    ;  330						0xB0,0xB1,0xB2,0xB3
                           A   788    ;  331						0xC0,0xC1,0xC2,0xC3
                           A   789    ;  332						0xB5,0xB6,0xB7,0xB8
                           A   790    ;  333						0xE0,0xE1,0xE2,0xE3
                           A   791    ;  334						0xF0,0xF1,0xF2,0xF3
                           A   792    ;  335	#define TBL_CT850  {0x43,0x55,0x45,0x41
                           A   793    ;  336						0x45,0x92,0x92,0x4F
                           A   794    ;  337						0x41,0x49,0x4F,0x55
                           A   795    ;  338						0xB0,0xB1,0xB2,0xB3
                           A   796    ;  339						0xC0,0xC1,0xC2,0xC3
                           A   797    ;  340						0xD1,0xD1,0x45,0x45
                           A   798    ;  341						0x4F,0xE1,0x4F,0x4F
                           A   799    ;  342						0xF0,0xF1,0xF2,0xF3
                           A   800    ;  343	#define TBL_CT852  {0x80,0x9A,0x90,0xB6
                           A   801    ;  344						0x90,0x91,0x91,0xE2
                           A   802    ;  345						0xB5,0xD6,0xE0,0xE9
                           A   803    ;  346						0xB0,0xB1,0xB2,0xB3
                           A   804    ;  347						0xC0,0xC1,0xC2,0xC3
                           A   805    ;  348						0xD1,0xD1,0xD2,0xD3
                           A   806    ;  349						0xE0,0xE1,0xE2,0xE3
                           A   807    ;  350						0xF0,0xF1,0xF2,0xF3
                           A   808    ;  351	#define TBL_CT855  {0x81,0x81,0x83,0x83
                           A   809    ;  352						0x91,0x91,0x93,0x93
                           A   810    ;  353						0xA1,0xA1,0xA3,0xA3
                           A   811    ;  354						0xB0,0xB1,0xB2,0xB3
                           A   812    ;  355						0xC0,0xC1,0xC2,0xC3
                           A   813    ;  356						0xD1,0xD1,0xD3,0xD3
                           A   814    ;  357						0xE0,0xE2,0xE2,0xE4
                           A   815    ;  358						0xF0,0xF2,0xF2,0xF4
                           A   816    ;  359	#define TBL_CT857  {0x80,0x9A,0x90,0xB6
                           A   817    ;  360						0x90,0x92,0x92,0xE2
                           A   818    ;  361						0xB5,0xD6,0xE0,0xE9
                           A   819    ;  362						0xB0,0xB1,0xB2,0xB3
                           A   820    ;  363						0xC0,0xC1,0xC2,0xC3
                           A   821    ;  364						0xD0,0xD1,0xD2,0xD3
                           A   822    ;  365						0xE0,0xE1,0xE2,0xE3
                           A   823    ;  366						0xF0,0xF1,0xF2,0xF3
                           A   824    ;  367	#define TBL_CT860  {0x80,0x9A,0x90,0x8F
                           A   825    ;  368						0x90,0x91,0x92,0x8C
                           A   826    ;  369						0x86,0x8B,0x9F,0x96
                           A   827    ;  370						0xB0,0xB1,0xB2,0xB3
                           A   828    ;  371						0xC0,0xC1,0xC2,0xC3
                           A   829    ;  372						0xD0,0xD1,0xD2,0xD3
                           A   830    ;  373						0xE0,0xE1,0xE2,0xE3
                           A   831    ;  374						0xF0,0xF1,0xF2,0xF3
                           A   832    ;  375	#define TBL_CT861  {0x80,0x9A,0x90,0x41
                           A   833    ;  376						0x90,0x92,0x92,0x4F
                           A   834    ;  377						0xA4,0xA5,0xA6,0xA7
                           A   835    ;  378						0xB0,0xB1,0xB2,0xB3
                           A   836    ;  379						0xC0,0xC1,0xC2,0xC3
                           A   837    ;  380						0xD0,0xD1,0xD2,0xD3
                           A   838    ;  381						0xE0,0xE1,0xE2,0xE3
                           A   839    ;  382						0xF0,0xF1,0xF2,0xF3
                           A   840    ;  383	#define TBL_CT862  {0x80,0x81,0x82,0x83
                           A   841    ;  384						0x90,0x91,0x92,0x93
                           A   842    ;  385						0x41,0x49,0x4F,0x55
                           A   843    ;  386						0xB0,0xB1,0xB2,0xB3
                           A   844    ;  387						0xC0,0xC1,0xC2,0xC3
                           A   845    ;  388						0xD0,0xD1,0xD2,0xD3
                           A   846    ;  389						0xE0,0xE1,0xE2,0xE3
                           A   847    ;  390						0xF0,0xF1,0xF2,0xF3
                           A   848    ;  391	#define TBL_CT863  {0x43,0x55,0x45,0x41
                           A   849    ;  392						0x45,0x45,0x45,0x4F
                           A   850    ;  393						0xA0,0xA1,0x4F,0x55
                           A   851    ;  394						0xB0,0xB1,0xB2,0xB3
                           A   852    ;  395						0xC0,0xC1,0xC2,0xC3
                           A   853    ;  396						0xD0,0xD1,0xD2,0xD3
                           A   854    ;  397						0xE0,0xE1,0xE2,0xE3
                           A   855    ;  398						0xF0,0xF1,0xF2,0xF3
                           A   856    ;  399	#define TBL_CT864  {0x80,0x9A,0x45,0x41
                           A   857    ;  400						0x90,0x92,0x92,0x4F
                           A   858    ;  401						0x41,0x49,0x4F,0x55
                           A   859    ;  402						0xB0,0xB1,0xB2,0xB3
                           A   860    ;  403						0xC0,0xC1,0xC2,0xC3
                           A   861    ;  404						0xD0,0xD1,0xD2,0xD3
                           A   862    ;  405						0xE0,0xE1,0xE2,0xE3
                           A   863    ;  406						0xF0,0xF1,0xF2,0xF3
                           A   864    ;  407	#define TBL_CT865  {0x80,0x9A,0x90,0x41
                           A   865    ;  408						0x90,0x92,0x92,0x4F
                           A   866    ;  409						0x41,0x49,0x4F,0x55
                           A   867    ;  410						0xB0,0xB1,0xB2,0xB3
                           A   868    ;  411						0xC0,0xC1,0xC2,0xC3
                           A   869    ;  412						0xD0,0xD1,0xD2,0xD3
                           A   870    ;  413						0xE0,0xE1,0xE2,0xE3
                           A   871    ;  414						0xF0,0xF1,0xF2,0xF3
                           A   872    ;  415	#define TBL_CT866  {0x80,0x81,0x82,0x83
                           A   873    ;  416						0x90,0x91,0x92,0x93
                           A   874    ;  417						0x80,0x81,0x82,0x83
                           A   875    ;  418						0xB0,0xB1,0xB2,0xB3
                           A   876    ;  419						0xC0,0xC1,0xC2,0xC3
                           A   877    ;  420						0xD0,0xD1,0xD2,0xD3
                           A   878    ;  421						0x90,0x91,0x92,0x93
                           A   879    ;  422						0xF0,0xF0,0xF2,0xF2
                           A   880    ;  423	#define TBL_CT869  {0x80,0x81,0x82,0x83
                           A   881    ;  424						0x90,0x91,0x92,0x93
                           A   882    ;  425						0x91,0x90,0x92,0x95
                           A   883    ;  426						0xB0,0xB1,0xB2,0xB3
                           A   884    ;  427						0xC0,0xC1,0xC2,0xC3
                           A   885    ;  428						0xD0,0xD1,0xD2,0xD3
                           A   886    ;  429						0xA9,0xAA,0xAC,0xAD
                           A   887    ;  430						0xF0,0xF1,0xD1,0xD2
                           A   888    ;  431	
                           A   889    ;  432	
                           A   890    ;  433	/* DBCS code range |----- 1st byte ----
                           A   891    ;  434	/*                  <------>    <------
                           A   892    ;  435	#define TBL_DC932 {0x81, 0x9F, 0xE0, 0x
                           A   893    ;  436	#define TBL_DC936 {0x81, 0xFE, 0x00, 0x
                           A   894    ;  437	#define TBL_DC949 {0x81, 0xFE, 0x00, 0x
                           A   895    ;  438	#define TBL_DC950 {0x81, 0xFE, 0x00, 0x
                           A   896    ;  439	
                           A   897    ;  440	
                           A   898    ;  441	/* Macros for table definitions */
                           A   899    ;  442	#define MERGE_2STR(a, b) a ## b
                           A   900    ;  443	#define MKCVTBL(hd, cp) MERGE_2STR(hd, 
                           A   901    ;  444	
                           A   902    ;  445	
                           A   903    ;  446	
                           A   904    ;  447	
                           A   905    ;  448	/*-------------------------------------
                           A   906    ;  449	
                           A   907    ;  450	   Module Private Work Area
                           A   908    ;  451	
                           A   909    ;  452	---------------------------------------
                           A   910    ;  453	/* Remark: Variables defined here witho
                           A   911    ;  454	/  zero/null at start-up. If not, the l
                           A   912    ;  455	/  not compliance with C standard. */
                           A   913    ;  456	
                           A   914    ;  457	/*--------------------------------*/
                           A   915    ;  458	/* File/Volume controls           */
                           A   916    ;  459	/*--------------------------------*/
                           A   917    ;  460	
                           A   918    ;  461	#if FF_VOLUMES < 1 || FF_VOLUMES > 10
                           A   919    ;  462	#error Wrong FF_VOLUMES setting
                           A   920    ;  463	#endif
                           A   921    ;  464	static FATFS* FatFs[FF_VOLUMES];	/* 
                           A   922    ;  465	static WORD Fsid;					/* 
                           A   923    ;  466	
                           A   924    ;  467	#if FF_FS_RPATH != 0
                           A   925    ;  468	static BYTE CurrVol;				/* 
                           A   926    ;  469	#endif
                           A   927    ;  470	
                           A   928    ;  471	#if FF_FS_LOCK != 0
                           A   929    ;  472	static FILESEM Files[FF_FS_LOCK];	/* 
                           A   930    ;  473	#endif
                           A   931    ;  474	
                           A   932    ;  475	#if FF_STR_VOLUME_ID
                           A   933    ;  476	#ifdef FF_VOLUME_STRS
                           A   934    ;  477	static const char* const VolumeStr[FF_V
                           A   935    ;  478	#endif
                           A   936    ;  479	#endif
                           A   937    ;  480	
                           A   938    ;  481	#if FF_LBA64
                           A   939    ;  482	#if FF_MIN_GPT > 0x100000000
                           A   940    ;  483	#error Wrong FF_MIN_GPT setting
                           A   941    ;  484	#endif
                           A   942    ;  485	static const BYTE GUID_MS_Basic[16] = {
                           A   943    ;  486	#endif
                           A   944    ;  487	
                           A   945    ;  488	
                           A   946    ;  489	
                           A   947    ;  490	/*--------------------------------*/
                           A   948    ;  491	/* LFN/Directory working buffer   */
                           A   949    ;  492	/*--------------------------------*/
                           A   950    ;  493	
                           A   951    ;  494	#if FF_USE_LFN == 0		/* Non-LFN conf
                           A   952    ;  495	#if FF_FS_EXFAT
                           A   953    ;  496	#error LFN must be enabled when enable 
                           A   954    ;  497	#endif
                           A   955    ;  498	#define DEF_NAMBUF
                           A   956    ;  499	#define INIT_NAMBUF(fs)
                           A   957    ;  500	#define FREE_NAMBUF()
                           A   958    ;  501	#define LEAVE_MKFS(res)	return res
                           A   959    ;  502	
                           A   960    ;  503	#else					/* LFN configur
                           A   961    ;  504	#if FF_MAX_LFN < 12 || FF_MAX_LFN > 255
                           A   962    ;  505	#error Wrong setting of FF_MAX_LFN
                           A   963    ;  506	#endif
                           A   964    ;  507	#if FF_LFN_BUF < FF_SFN_BUF || FF_SFN_B
                           A   965    ;  508	#error Wrong setting of FF_LFN_BUF or F
                           A   966    ;  509	#endif
                           A   967    ;  510	#if FF_LFN_UNICODE < 0 || FF_LFN_UNICOD
                           A   968    ;  511	#error Wrong setting of FF_LFN_UNICODE
                           A   969    ;  512	#endif
                           A   970    ;  513	static const BYTE LfnOfs[] = {1,3,5,7,9
                           A   971    ;  514	#define MAXDIRB(nc)	((nc + 44U) / 15 * 
                           A   972    ;  515	
                           A   973    ;  516	#if FF_USE_LFN == 1		/* LFN enabled 
                           A   974    ;  517	#if FF_FS_EXFAT
                           A   975    ;  518	static BYTE	DirBuf[MAXDIRB(FF_MAX_LFN)]
                           A   976    ;  519	#endif
                           A   977    ;  520	static WCHAR LfnBuf[FF_MAX_LFN + 1];	
                           A   978    ;  521	#define DEF_NAMBUF
                           A   979    ;  522	#define INIT_NAMBUF(fs)
                           A   980    ;  523	#define FREE_NAMBUF()
                           A   981    ;  524	#define LEAVE_MKFS(res)	return res
                           A   982    ;  525	
                           A   983    ;  526	#elif FF_USE_LFN == 2 	/* LFN enabled 
                           A   984    ;  527	#if FF_FS_EXFAT
                           A   985    ;  528	#define DEF_NAMBUF		WCHAR lbuf[FF_M
                           A   986    ;  529	#define INIT_NAMBUF(fs)	{ (fs)->lfnbuf 
                           A   987    ;  530	#define FREE_NAMBUF()
                           A   988    ;  531	#else
                           A   989    ;  532	#define DEF_NAMBUF		WCHAR lbuf[FF_M
                           A   990    ;  533	#define INIT_NAMBUF(fs)	{ (fs)->lfnbuf 
                           A   991    ;  534	#define FREE_NAMBUF()
                           A   992    ;  535	#endif
                           A   993    ;  536	#define LEAVE_MKFS(res)	return res
                           A   994    ;  537	
                           A   995    ;  538	#elif FF_USE_LFN == 3 	/* LFN enabled 
                           A   996    ;  539	#if FF_FS_EXFAT
                           A   997    ;  540	#define DEF_NAMBUF		WCHAR *lfn;	/* 
                           A   998    ;  541	#define INIT_NAMBUF(fs)	{ lfn = ff_mema
                           A   999    ;  542	#define FREE_NAMBUF()	ff_memfree(lfn)
                           A  1000    ;  543	#else
                           A  1001    ;  544	#define DEF_NAMBUF		WCHAR *lfn;	/* 
                           A  1002    ;  545	#define INIT_NAMBUF(fs)	{ lfn = ff_mema
                           A  1003    ;  546	#define FREE_NAMBUF()	ff_memfree(lfn)
                           A  1004    ;  547	#endif
                           A  1005    ;  548	#define LEAVE_MKFS(res)	{ if (!work) ff
                           A  1006    ;  549	#define MAX_MALLOC	0x8000	/* Must be 
                           A  1007    ;  550	
                           A  1008    ;  551	#else
                           A  1009    ;  552	#error Wrong setting of FF_USE_LFN
                           A  1010    ;  553	
                           A  1011    ;  554	#endif	/* FF_USE_LFN == 1 */
                           A  1012    ;  555	#endif	/* FF_USE_LFN == 0 */
                           A  1013    ;  556	
                           A  1014    ;  557	
                           A  1015    ;  558	
                           A  1016    ;  559	/*--------------------------------*/
                           A  1017    ;  560	/* Code conversion tables         */
                           A  1018    ;  561	/*--------------------------------*/
                           A  1019    ;  562	
                           A  1020    ;  563	#if FF_CODE_PAGE == 0	/* Run-time cod
                           A  1021    ;  564	#define CODEPAGE CodePage
                           A  1022    ;  565	static WORD CodePage;	/* Current code
                           A  1023    ;  566	static const BYTE *ExCvt, *DbcTbl;	/* 
                           A  1024    ;  567	
                           A  1025    ;  568	static const BYTE Ct437[] = TBL_CT437;
                           A  1026    ;  569	static const BYTE Ct720[] = TBL_CT720;
                           A  1027    ;  570	static const BYTE Ct737[] = TBL_CT737;
                           A  1028    ;  571	static const BYTE Ct771[] = TBL_CT771;
                           A  1029    ;  572	static const BYTE Ct775[] = TBL_CT775;
                           A  1030    ;  573	static const BYTE Ct850[] = TBL_CT850;
                           A  1031    ;  574	static const BYTE Ct852[] = TBL_CT852;
                           A  1032    ;  575	static const BYTE Ct855[] = TBL_CT855;
                           A  1033    ;  576	static const BYTE Ct857[] = TBL_CT857;
                           A  1034    ;  577	static const BYTE Ct860[] = TBL_CT860;
                           A  1035    ;  578	static const BYTE Ct861[] = TBL_CT861;
                           A  1036    ;  579	static const BYTE Ct862[] = TBL_CT862;
                           A  1037    ;  580	static const BYTE Ct863[] = TBL_CT863;
                           A  1038    ;  581	static const BYTE Ct864[] = TBL_CT864;
                           A  1039    ;  582	static const BYTE Ct865[] = TBL_CT865;
                           A  1040    ;  583	static const BYTE Ct866[] = TBL_CT866;
                           A  1041    ;  584	static const BYTE Ct869[] = TBL_CT869;
                           A  1042    ;  585	static const BYTE Dc932[] = TBL_DC932;
                           A  1043    ;  586	static const BYTE Dc936[] = TBL_DC936;
                           A  1044    ;  587	static const BYTE Dc949[] = TBL_DC949;
                           A  1045    ;  588	static const BYTE Dc950[] = TBL_DC950;
                           A  1046    ;  589	
                           A  1047    ;  590	#elif FF_CODE_PAGE < 900	/* Static c
                           A  1048    ;  591	#define CODEPAGE FF_CODE_PAGE
                           A  1049    ;  592	static const BYTE ExCvt[] = MKCVTBL(TBL
                           A  1050    	SEGMENT CODE
                           A  1051    ;  593	
                           A  1052    ;  594	#else					/* Static code 
                           A  1053    ;  595	#define CODEPAGE FF_CODE_PAGE
                           A  1054    ;  596	static const BYTE DbcTbl[] = MKCVTBL(TB
                           A  1055    ;  597	
                           A  1056    ;  598	#endif
                           A  1057    ;  599	
                           A  1058    ;  600	
                           A  1059    ;  601	
                           A  1060    ;  602	
                           A  1061    ;  603	/*-------------------------------------
                           A  1062    ;  604	
                           A  1063    ;  605	   Module Private Functions
                           A  1064    ;  606	
                           A  1065    ;  607	---------------------------------------
                           A  1066    ;  608	
                           A  1067    ;  609	
                           A  1068    ;  610	/*-------------------------------------
                           A  1069    ;  611	/* Load/Store multi-byte word in the FA
                           A  1070    ;  612	/*-------------------------------------
                           A  1071    ;  613	
                           A  1072    ;  614	static WORD ld_word (const BYTE* ptr)	
                           A  1073    ;  615	{
040F25                     A  1074    _ld_word:
                           A  1075    .DEFINE "_ld_word"
                           A  1076    
                           A  1077    .VALUE _ld_word
                           A  1078    
                           A  1079    .CLASS 3
                           A  1080    
                           A  1081    .TYPE 77
                           A  1082    
                           A  1083    .ENDEF
                           A  1084    
                           A  1085    .BEGFUNC "ld_word",615,"_ld_word"
                           A  1086    
                           A  1087    .LINE 615
                           A  1088    
                           A  1089    .DEFINE "ptr"
                           A  1090    
                           A  1091    .CLASS 65
                           A  1092    
                           A  1093    .VALUE 6
                           A  1094    
                           A  1095    .TYPE 204
                           A  1096    
                           A  1097    .ENDEF
                           A  1098    
                           A  1099    .DEFINE "rv"
                           A  1100    
                           A  1101    .CLASS 65
                           A  1102    
                           A  1103    .VALUE -2
                           A  1104    
                           A  1105    .TYPE 13
                           A  1106    
                           A  1107    .ENDEF
                           A  1108    
040F25 DDE5                A  1109    	PUSH	IX
040F27 DD210000 00         A  1110    	LD	IX,0
040F2C DD39                A  1111    	ADD	IX,SP
040F2E 3B                  A  1112    	DEC	SP
040F2F 3B                  A  1113    	DEC	SP
                           A  1114    ;  616		WORD rv;
                           A  1115    ;  617	
                           A  1116    ;  618		rv = ptr[1];
                           A  1117    .LINE 618
                           A  1118    
040F30 DD2706              A  1119    	LD	HL,(IX+%6)
040F33 23                  A  1120    	INC	HL
040F34 4E                  A  1121    	LD	C,(HL)
040F35 0600                A  1122    	LD	B,%0
040F37 C5E1                A  1123    	LD	HL,BC
040F39 DD75FE              A  1124    	LD	(IX+%FFFFFFFE),L
040F3C DD74FF              A  1125    	LD	(IX+%FFFFFFFF),H
                           A  1126    ;  619		rv = rv << 8 | ptr[0];
                           A  1127    .LINE 619
                           A  1128    
040F3F DD2706              A  1129    	LD	HL,(IX+%6)
040F42 4E                  A  1130    	LD	C,(HL)
040F43 C5D1                A  1131    	LD	DE,BC
040F45 DD27FE              A  1132    	LD	HL,(IX+%FFFFFFFE)
040F48 65                  A  1133    	LD	H,L
040F49 2E00                A  1134    	LD	L,%0
040F4B E5C1                A  1135    	LD	BC,HL
040F4D D5E1                A  1136    	LD	HL,DE
040F4F CD 42 48 04         A  1137    	CALL	__sor
040F53 DD75FE              A  1138    	LD	(IX+%FFFFFFFE),L
040F56 DD74FF              A  1139    	LD	(IX+%FFFFFFFF),H
                           A  1140    ;  620		return rv;
                           A  1141    .LINE 620
                           A  1142    
040F59 DD27FE              A  1143    	LD	HL,(IX+%FFFFFFFE)
                           A  1144    ;  621	}
                           A  1145    .LINE 621
                           A  1146    
040F5C DDF9                A  1147    	LD	SP,IX
040F5E DDE1                A  1148    	POP	IX
040F60 C9                  A  1149    	RET	
                           A  1150    
                           A  1151    
                           A  1152    ;**************************** _ld_word ********
                           A  1153    ;Name                         Addr/Register   S
                           A  1154    ;rv                                    IX-2    
                           A  1155    ;ptr                                   IX+6    
                           A  1156    
                           A  1157    
                           A  1158    ; Stack Frame Size: 11 (bytes)
                           A  1159    ;       Spill Code: 0 (instruction)
                           A  1160    
                           A  1161    
                           A  1162    .ENDFUNC "ld_word",621,"_ld_word"
                           A  1163    ;  622	
                           A  1164    ;  623	static DWORD ld_dword (const BYTE* ptr)
                           A  1165    ;  624	{
040F61                     A  1166    _ld_dword:
                           A  1167    .DEFINE "_ld_dword"
                           A  1168    
                           A  1169    .VALUE _ld_dword
                           A  1170    
                           A  1171    .CLASS 3
                           A  1172    
                           A  1173    .TYPE 79
                           A  1174    
                           A  1175    .ENDEF
                           A  1176    
                           A  1177    .BEGFUNC "ld_dword",624,"_ld_dword"
                           A  1178    
                           A  1179    .LINE 624
                           A  1180    
                           A  1181    .DEFINE "ptr"
                           A  1182    
                           A  1183    .CLASS 65
                           A  1184    
                           A  1185    .VALUE 6
                           A  1186    
                           A  1187    .TYPE 204
                           A  1188    
                           A  1189    .ENDEF
                           A  1190    
                           A  1191    .DEFINE "rv"
                           A  1192    
                           A  1193    .CLASS 65
                           A  1194    
                           A  1195    .VALUE -4
                           A  1196    
                           A  1197    .TYPE 15
                           A  1198    
                           A  1199    .ENDEF
                           A  1200    
040F61 DDE5                A  1201    	PUSH	IX
040F63 DD210000 00         A  1202    	LD	IX,0
040F68 DD39                A  1203    	ADD	IX,SP
040F6A ED22F3              A  1204    	LEA	HL,IX+%FFFFFFF3
040F6D F9                  A  1205    	LD	SP,HL
                           A  1206    ;  625		DWORD rv;
                           A  1207    ;  626	
                           A  1208    ;  627		rv = ptr[3];
                           A  1209    .LINE 627
                           A  1210    
040F6E DD3106              A  1211    	LD	IY,(IX+%6)
040F71 B7ED62              A  1212    	UEXT	HL
040F74 FD6E03              A  1213    	LD	L,(IY+%3)
040F77 E5C1                A  1214    	LD	BC,HL
040F79 DD0FFC              A  1215    	LD	(IX+%FFFFFFFC),BC
040F7C DD74FF              A  1216    	LD	(IX+%FFFFFFFF),H
                           A  1217    ;  628		rv = rv << 8 | ptr[2];
                           A  1218    .LINE 628
                           A  1219    
040F7F B7ED62              A  1220    	UEXT	HL
040F82 FD6E02              A  1221    	LD	L,(IY+%2)
040F85 DD2FF9              A  1222    	LD	(IX+%FFFFFFF9),HL
040F88 5C                  A  1223    	LD	E,H
040F89 DD7EFF              A  1224    	LD	A,(IX+%FFFFFFFF)
040F8C 2E08                A  1225    	LD	L,%8
040F8E CD E5 47 04         A  1226    	CALL	__lshl
040F92 DD27F9              A  1227    	LD	HL,(IX+%FFFFFFF9)
040F95 CD D3 46 04         A  1228    	CALL	__lor
040F99 E5C1                A  1229    	LD	BC,HL
040F9B DD0FFC              A  1230    	LD	(IX+%FFFFFFFC),BC
040F9E DD73FF              A  1231    	LD	(IX+%FFFFFFFF),E
                           A  1232    ;  629		rv = rv << 8 | ptr[1];
                           A  1233    .LINE 629
                           A  1234    
040FA1 B7ED62              A  1235    	UEXT	HL
040FA4 FD6E01              A  1236    	LD	L,(IY+%1)
040FA7 DD2FF6              A  1237    	LD	(IX+%FFFFFFF6),HL
040FAA 5C                  A  1238    	LD	E,H
040FAB DD7EFF              A  1239    	LD	A,(IX+%FFFFFFFF)
040FAE 2E08                A  1240    	LD	L,%8
040FB0 CD E5 47 04         A  1241    	CALL	__lshl
040FB4 DD27F6              A  1242    	LD	HL,(IX+%FFFFFFF6)
040FB7 CD D3 46 04         A  1243    	CALL	__lor
040FBB DD2FFC              A  1244    	LD	(IX+%FFFFFFFC),HL
040FBE DD73FF              A  1245    	LD	(IX+%FFFFFFFF),E
                           A  1246    ;  630		rv = rv << 8 | ptr[0];
                           A  1247    .LINE 630
                           A  1248    
040FC1 E5C1                A  1249    	LD	BC,HL
040FC3 DD7EFF              A  1250    	LD	A,(IX+%FFFFFFFF)
040FC6 2E08                A  1251    	LD	L,%8
040FC8 CD E5 47 04         A  1252    	CALL	__lshl
040FCC DD0FF3              A  1253    	LD	(IX+%FFFFFFF3),BC
040FCF 5F                  A  1254    	LD	E,A
040FD0 B7ED62              A  1255    	UEXT	HL
040FD3 FD6E00              A  1256    	LD	L,(IY)
040FD6 E5C1                A  1257    	LD	BC,HL
040FD8 7C                  A  1258    	LD	A,H
040FD9 DD27F3              A  1259    	LD	HL,(IX+%FFFFFFF3)
040FDC CD D3 46 04         A  1260    	CALL	__lor
040FE0 DD2FFC              A  1261    	LD	(IX+%FFFFFFFC),HL
040FE3 DD73FF              A  1262    	LD	(IX+%FFFFFFFF),E
                           A  1263    ;  631		return rv;
                           A  1264    .LINE 631
                           A  1265    
040FE6 DD27FC              A  1266    	LD	HL,(IX+%FFFFFFFC)
040FE9 DD5EFF              A  1267    	LD	E,(IX+%FFFFFFFF)
                           A  1268    ;  632	}
                           A  1269    .LINE 632
                           A  1270    
040FEC DDF9                A  1271    	LD	SP,IX
040FEE DDE1                A  1272    	POP	IX
040FF0 C9                  A  1273    	RET	
                           A  1274    
                           A  1275    
                           A  1276    ;**************************** _ld_dword *******
                           A  1277    ;Name                         Addr/Register   S
                           A  1278    ;rv                                    IX-4    
                           A  1279    ;ptr                                   IX+6    
                           A  1280    
                           A  1281    
                           A  1282    ; Stack Frame Size: 22 (bytes)
                           A  1283    ;       Spill Code: 0 (instruction)
                           A  1284    
                           A  1285    
                           A  1286    .ENDFUNC "ld_dword",632,"_ld_dword"
                           A  1287    ;  633	
                           A  1288    ;  634	#if FF_FS_EXFAT
                           A  1289    ;  635	static QWORD ld_qword (const BYTE* ptr)
                           A  1290    ;  636	{
                           A  1291    ;  637		QWORD rv;
                           A  1292    ;  638	
                           A  1293    ;  639		rv = ptr[7];
                           A  1294    ;  640		rv = rv << 8 | ptr[6];
                           A  1295    ;  641		rv = rv << 8 | ptr[5];
                           A  1296    ;  642		rv = rv << 8 | ptr[4];
                           A  1297    ;  643		rv = rv << 8 | ptr[3];
                           A  1298    ;  644		rv = rv << 8 | ptr[2];
                           A  1299    ;  645		rv = rv << 8 | ptr[1];
                           A  1300    ;  646		rv = rv << 8 | ptr[0];
                           A  1301    ;  647		return rv;
                           A  1302    ;  648	}
                           A  1303    ;  649	#endif
                           A  1304    ;  650	
                           A  1305    ;  651	#if !FF_FS_READONLY
                           A  1306    ;  652	static void st_word (BYTE* ptr, WORD va
                           A  1307    ;  653	{
                           A  1308    ;  654		*ptr++ = (BYTE)val; val >>= 8;
                           A  1309    ;  655		*ptr++ = (BYTE)val;
                           A  1310    ;  656	}
                           A  1311    ;  657	
                           A  1312    ;  658	static void st_dword (BYTE* ptr, DWORD 
                           A  1313    ;  659	{
                           A  1314    ;  660		*ptr++ = (BYTE)val; val >>= 8;
                           A  1315    ;  661		*ptr++ = (BYTE)val; val >>= 8;
                           A  1316    ;  662		*ptr++ = (BYTE)val; val >>= 8;
                           A  1317    ;  663		*ptr++ = (BYTE)val;
                           A  1318    ;  664	}
                           A  1319    ;  665	
                           A  1320    ;  666	#if FF_FS_EXFAT
                           A  1321    ;  667	static void st_qword (BYTE* ptr, QWORD 
                           A  1322    ;  668	{
                           A  1323    ;  669		*ptr++ = (BYTE)val; val >>= 8;
                           A  1324    ;  670		*ptr++ = (BYTE)val; val >>= 8;
                           A  1325    ;  671		*ptr++ = (BYTE)val; val >>= 8;
                           A  1326    ;  672		*ptr++ = (BYTE)val; val >>= 8;
                           A  1327    ;  673		*ptr++ = (BYTE)val; val >>= 8;
                           A  1328    ;  674		*ptr++ = (BYTE)val; val >>= 8;
                           A  1329    ;  675		*ptr++ = (BYTE)val; val >>= 8;
                           A  1330    ;  676		*ptr++ = (BYTE)val;
                           A  1331    ;  677	}
                           A  1332    ;  678	#endif
                           A  1333    ;  679	#endif	/* !FF_FS_READONLY */
                           A  1334    ;  680	
                           A  1335    ;  681	
                           A  1336    ;  682	
                           A  1337    ;  683	/*-------------------------------------
                           A  1338    ;  684	/* String functions                    
                           A  1339    ;  685	/*-------------------------------------
                           A  1340    ;  686	
                           A  1341    ;  687	/* Test if the byte is DBC 1st byte */
                           A  1342    ;  688	static int dbc_1st (BYTE c)
                           A  1343    ;  689	{
040FF1                     A  1344    _dbc_1st:
                           A  1345    .DEFINE "_dbc_1st"
                           A  1346    
                           A  1347    .VALUE _dbc_1st
                           A  1348    
                           A  1349    .CLASS 3
                           A  1350    
                           A  1351    .TYPE 68
                           A  1352    
                           A  1353    .ENDEF
                           A  1354    
                           A  1355    .BEGFUNC "dbc_1st",689,"_dbc_1st"
                           A  1356    
                           A  1357    .LINE 689
                           A  1358    
                           A  1359    .DEFINE "c"
                           A  1360    
                           A  1361    .CLASS 65
                           A  1362    
                           A  1363    .VALUE 6
                           A  1364    
                           A  1365    .TYPE 12
                           A  1366    
                           A  1367    .ENDEF
                           A  1368    
040FF1 DDE5                A  1369    	PUSH	IX
040FF3 DD210000 00         A  1370    	LD	IX,0
040FF8 DD39                A  1371    	ADD	IX,SP
                           A  1372    ;  690	#if FF_CODE_PAGE == 0		/* Variable
                           A  1373    ;  691		if (DbcTbl && c >= DbcTbl[0]) {
                           A  1374    ;  692			if (c <= DbcTbl[1]) return 1;	
                           A  1375    ;  693			if (c >= DbcTbl[2] && c <= DbcT
                           A  1376    ;  694		}
                           A  1377    ;  695	#elif FF_CODE_PAGE >= 900	/* DBCS fix
                           A  1378    ;  696		if (c >= DbcTbl[0]) {
                           A  1379    ;  697			if (c <= DbcTbl[1]) return 1;
                           A  1380    ;  698			if (c >= DbcTbl[2] && c <= DbcT
                           A  1381    ;  699		}
                           A  1382    ;  700	#else						/* SBCS fix
                           A  1383    ;  701		if (c != 0) return 0;	/* Always f
                           A  1384    .LINE 701
                           A  1385    
040FFA DD7E06              A  1386    	LD	A,(IX+%6)
040FFD B7                  A  1387    	OR	A,A
040FFE 28 05               A  1388    	JR	Z,L_3
041000 B7                  A  1389    	OR	A,A
041001 ED62                A  1390    	SBC	HL,HL
041003 18 03               A  1391    	JR	L_4
041005                     A  1392    L_3:
                           A  1393    ;  702	#endif
                           A  1394    ;  703		return 0;
                           A  1395    .LINE 703
                           A  1396    
041005 B7                  A  1397    	OR	A,A
041006 ED62                A  1398    	SBC	HL,HL
                           A  1399    ;  704	}
041008                     A  1400    L_4:
                           A  1401    .LINE 704
                           A  1402    
041008 DDF9                A  1403    	LD	SP,IX
04100A DDE1                A  1404    	POP	IX
04100C C9                  A  1405    	RET	
                           A  1406    
                           A  1407    
                           A  1408    ;**************************** _dbc_1st ********
                           A  1409    ;Name                         Addr/Register   S
                           A  1410    ;c                                     IX+6    
                           A  1411    
                           A  1412    
                           A  1413    ; Stack Frame Size: 9 (bytes)
                           A  1414    ;       Spill Code: 0 (instruction)
                           A  1415    
                           A  1416    
                           A  1417    .ENDFUNC "dbc_1st",704,"_dbc_1st"
                           A  1418    ;  705	
                           A  1419    ;  706	
                           A  1420    ;  707	/* Test if the byte is DBC 2nd byte */
                           A  1421    ;  708	static int dbc_2nd (BYTE c)
                           A  1422    ;  709	{
04100D                     A  1423    _dbc_2nd:
                           A  1424    .DEFINE "_dbc_2nd"
                           A  1425    
                           A  1426    .VALUE _dbc_2nd
                           A  1427    
                           A  1428    .CLASS 3
                           A  1429    
                           A  1430    .TYPE 68
                           A  1431    
                           A  1432    .ENDEF
                           A  1433    
                           A  1434    .BEGFUNC "dbc_2nd",709,"_dbc_2nd"
                           A  1435    
                           A  1436    .LINE 709
                           A  1437    
                           A  1438    .DEFINE "c"
                           A  1439    
                           A  1440    .CLASS 65
                           A  1441    
                           A  1442    .VALUE 6
                           A  1443    
                           A  1444    .TYPE 12
                           A  1445    
                           A  1446    .ENDEF
                           A  1447    
04100D DDE5                A  1448    	PUSH	IX
04100F DD210000 00         A  1449    	LD	IX,0
041014 DD39                A  1450    	ADD	IX,SP
                           A  1451    ;  710	#if FF_CODE_PAGE == 0		/* Variable
                           A  1452    ;  711		if (DbcTbl && c >= DbcTbl[4]) {
                           A  1453    ;  712			if (c <= DbcTbl[5]) return 1;	
                           A  1454    ;  713			if (c >= DbcTbl[6] && c <= DbcT
                           A  1455    ;  714			if (c >= DbcTbl[8] && c <= DbcT
                           A  1456    ;  715		}
                           A  1457    ;  716	#elif FF_CODE_PAGE >= 900	/* DBCS fix
                           A  1458    ;  717		if (c >= DbcTbl[4]) {
                           A  1459    ;  718			if (c <= DbcTbl[5]) return 1;
                           A  1460    ;  719			if (c >= DbcTbl[6] && c <= DbcT
                           A  1461    ;  720			if (c >= DbcTbl[8] && c <= DbcT
                           A  1462    ;  721		}
                           A  1463    ;  722	#else						/* SBCS fix
                           A  1464    ;  723		if (c != 0) return 0;	/* Always f
                           A  1465    .LINE 723
                           A  1466    
041016 DD7E06              A  1467    	LD	A,(IX+%6)
041019 B7                  A  1468    	OR	A,A
04101A 28 05               A  1469    	JR	Z,L_6
04101C B7                  A  1470    	OR	A,A
04101D ED62                A  1471    	SBC	HL,HL
04101F 18 03               A  1472    	JR	L_7
041021                     A  1473    L_6:
                           A  1474    ;  724	#endif
                           A  1475    ;  725		return 0;
                           A  1476    .LINE 725
                           A  1477    
041021 B7                  A  1478    	OR	A,A
041022 ED62                A  1479    	SBC	HL,HL
                           A  1480    ;  726	}
041024                     A  1481    L_7:
                           A  1482    .LINE 726
                           A  1483    
041024 DDF9                A  1484    	LD	SP,IX
041026 DDE1                A  1485    	POP	IX
041028 C9                  A  1486    	RET	
                           A  1487    
                           A  1488    
                           A  1489    ;**************************** _dbc_2nd ********
                           A  1490    ;Name                         Addr/Register   S
                           A  1491    ;c                                     IX+6    
                           A  1492    
                           A  1493    
                           A  1494    ; Stack Frame Size: 9 (bytes)
                           A  1495    ;       Spill Code: 0 (instruction)
                           A  1496    
                           A  1497    
                           A  1498    .ENDFUNC "dbc_2nd",726,"_dbc_2nd"
                           A  1499    ;  727	
                           A  1500    ;  728	
                           A  1501    ;  729	#if FF_USE_LFN
                           A  1502    ;  730	
                           A  1503    ;  731	/* Get a Unicode code point from the TC
                           A  1504    ;  732	static DWORD tchar2uni (	/* Returns 
                           A  1505    ;  733		const TCHAR** str		/* Pointer 
                           A  1506    ;  734	)
                           A  1507    ;  735	{
041029                     A  1508    _tchar2uni:
                           A  1509    .DEFINE "_tchar2uni"
                           A  1510    
                           A  1511    .VALUE _tchar2uni
                           A  1512    
                           A  1513    .CLASS 3
                           A  1514    
                           A  1515    .TYPE 79
                           A  1516    
                           A  1517    .ENDEF
                           A  1518    
                           A  1519    .BEGFUNC "tchar2uni",735,"_tchar2uni"
                           A  1520    
                           A  1521    .LINE 735
                           A  1522    
                           A  1523    .DEFINE "str"
                           A  1524    
                           A  1525    .CLASS 65
                           A  1526    
                           A  1527    .VALUE 6
                           A  1528    
                           A  1529    .TYPE 1570
                           A  1530    
                           A  1531    .ENDEF
                           A  1532    
                           A  1533    .DEFINE "p"
                           A  1534    
                           A  1535    .CLASS 65
                           A  1536    
                           A  1537    .VALUE -3
                           A  1538    
                           A  1539    .TYPE 194
                           A  1540    
                           A  1541    .ENDEF
                           A  1542    
                           A  1543    .DEFINE "wc"
                           A  1544    
                           A  1545    .CLASS 65
                           A  1546    
                           A  1547    .VALUE -5
                           A  1548    
                           A  1549    .TYPE 13
                           A  1550    
                           A  1551    .ENDEF
                           A  1552    
                           A  1553    .DEFINE "b"
                           A  1554    
                           A  1555    .CLASS 65
                           A  1556    
                           A  1557    .VALUE -6
                           A  1558    
                           A  1559    .TYPE 12
                           A  1560    
                           A  1561    .ENDEF
                           A  1562    
                           A  1563    .DEFINE "uc"
                           A  1564    
                           A  1565    .CLASS 65
                           A  1566    
                           A  1567    .VALUE -10
                           A  1568    
                           A  1569    .TYPE 15
                           A  1570    
                           A  1571    .ENDEF
                           A  1572    
041029 DDE5                A  1573    	PUSH	IX
04102B DD210000 00         A  1574    	LD	IX,0
041030 DD39                A  1575    	ADD	IX,SP
041032 C5                  A  1576    	PUSH	BC
041033 C5                  A  1577    	PUSH	BC
041034 C5                  A  1578    	PUSH	BC
041035 3B                  A  1579    	DEC	SP
                           A  1580    ;  736		DWORD uc;
                           A  1581    ;  737		const TCHAR *p = *str;
                           A  1582    .LINE 737
                           A  1583    
041036 DD2706              A  1584    	LD	HL,(IX+%6)
041039 ED07                A  1585    	LD	BC,(HL)
04103B DD0FFD              A  1586    	LD	(IX+%FFFFFFFD),BC
                           A  1587    ;  738	
                           A  1588    ;  739	#if FF_LFN_UNICODE == 1		/* UTF-16 i
                           A  1589    ;  740		WCHAR wc;
                           A  1590    ;  741	
                           A  1591    ;  742		uc = *p++;	/* Get a unit */
                           A  1592    ;  743		if (IsSurrogate(uc)) {	/* Surrogat
                           A  1593    ;  744			wc = *p++;		/* Get low surr
                           A  1594    ;  745			if (!IsSurrogateH(uc) || !IsSur
                           A  1595    ;  746			uc = uc << 16 | wc;
                           A  1596    ;  747		}
                           A  1597    ;  748	
                           A  1598    ;  749	#elif FF_LFN_UNICODE == 2	/* UTF-8 in
                           A  1599    ;  750		BYTE b;
                           A  1600    ;  751		int nf;
                           A  1601    ;  752	
                           A  1602    ;  753		uc = (BYTE)*p++;	/* Get an encod
                           A  1603    ;  754		if (uc & 0x80) {	/* Multiple byt
                           A  1604    ;  755			if        ((uc & 0xE0) == 0xC0)
                           A  1605    ;  756				uc &= 0x1F; nf = 1;
                           A  1606    ;  757			} else if ((uc & 0xF0) == 0xE0)
                           A  1607    ;  758				uc &= 0x0F; nf = 2;
                           A  1608    ;  759			} else if ((uc & 0xF8) == 0xF0)
                           A  1609    ;  760				uc &= 0x07; nf = 3;
                           A  1610    ;  761			} else {						
                           A  1611    ;  762				return 0xFFFFFFFF;
                           A  1612    ;  763			}
                           A  1613    ;  764			do {	/* Get trailing bytes *
                           A  1614    ;  765				b = (BYTE)*p++;
                           A  1615    ;  766				if ((b & 0xC0) != 0x80) ret
                           A  1616    ;  767				uc = uc << 6 | (b & 0x3F);
                           A  1617    ;  768			} while (--nf != 0);
                           A  1618    ;  769			if (uc < 0x80 || IsSurrogate(uc
                           A  1619    ;  770			if (uc >= 0x010000) uc = 0xD800
                           A  1620    ;  771		}
                           A  1621    ;  772	
                           A  1622    ;  773	#elif FF_LFN_UNICODE == 3	/* UTF-32 i
                           A  1623    ;  774		uc = (TCHAR)*p++;	/* Get a unit *
                           A  1624    ;  775		if (uc >= 0x110000 || IsSurrogate(u
                           A  1625    ;  776		if (uc >= 0x010000) uc = 0xD800DC00
                           A  1626    ;  777	
                           A  1627    ;  778	#else		/* ANSI/OEM input */
                           A  1628    ;  779		BYTE b;
                           A  1629    ;  780		WCHAR wc;
                           A  1630    ;  781	
                           A  1631    ;  782		wc = (BYTE)*p++;			/* Get 
                           A  1632    .LINE 782
                           A  1633    
04103E C5E1                A  1634    	LD	HL,BC
041040 4E                  A  1635    	LD	C,(HL)
041041 0600                A  1636    	LD	B,%0
041043 C5E1                A  1637    	LD	HL,BC
041045 DD75FB              A  1638    	LD	(IX+%FFFFFFFB),L
041048 DD74FC              A  1639    	LD	(IX+%FFFFFFFC),H
04104B DD07FD              A  1640    	LD	BC,(IX+%FFFFFFFD)
04104E 03                  A  1641    	INC	BC
04104F DD0FFD              A  1642    	LD	(IX+%FFFFFFFD),BC
                           A  1643    ;  783		if (dbc_1st((BYTE)wc)) {	/* Is i
                           A  1644    .LINE 783
                           A  1645    
041052 DD4EFB              A  1646    	LD	C,(IX+%FFFFFFFB)
041055 0600                A  1647    	LD	B,%0
041057 C5                  A  1648    	PUSH	BC
041058 CD F1 0F 04         A  1649    	CALL	_dbc_1st
04105C C1                  A  1650    	POP	BC
04105D CD E5 46 04         A  1651    	CALL	__icmpzero
041061 28 3A               A  1652    	JR	Z,L_15
                           A  1653    ;  784			b = (BYTE)*p++;			/* Get 
                           A  1654    .LINE 784
                           A  1655    
041063 DD27FD              A  1656    	LD	HL,(IX+%FFFFFFFD)
041066 7E                  A  1657    	LD	A,(HL)
041067 DD77FA              A  1658    	LD	(IX+%FFFFFFFA),A
04106A DD07FD              A  1659    	LD	BC,(IX+%FFFFFFFD)
04106D 03                  A  1660    	INC	BC
04106E DD0FFD              A  1661    	LD	(IX+%FFFFFFFD),BC
                           A  1662    ;  785			if (!dbc_2nd(b)) return 0xFFFFF
                           A  1663    .LINE 785
                           A  1664    
041071 DD4EFA              A  1665    	LD	C,(IX+%FFFFFFFA)
041074 0600                A  1666    	LD	B,%0
041076 C5                  A  1667    	PUSH	BC
041077 CD 0D 10 04         A  1668    	CALL	_dbc_2nd
04107B C1                  A  1669    	POP	BC
04107C CD E5 46 04         A  1670    	CALL	__icmpzero
041080 20 08               A  1671    	JR	NZ,L_11
041082 21FFFFFF            A  1672    	LD	HL,16777215
041086 1EFF                A  1673    	LD	E,%FF
041088 18 5E               A  1674    	JR	L_17
04108A                     A  1675    L_11:
                           A  1676    ;  786			wc = (wc << 8) + b;		/* Make
                           A  1677    .LINE 786
                           A  1678    
04108A DD27FB              A  1679    	LD	HL,(IX+%FFFFFFFB)
04108D 65                  A  1680    	LD	H,L
04108E 2E00                A  1681    	LD	L,%0
041090 DD4EFA              A  1682    	LD	C,(IX+%FFFFFFFA)
041093 0600                A  1683    	LD	B,%0
041095 4009                A  1684    	ADD.SIS	HL,BC
041097 DD75FB              A  1685    	LD	(IX+%FFFFFFFB),L
04109A DD74FC              A  1686    	LD	(IX+%FFFFFFFC),H
                           A  1687    ;  787		}
04109D                     A  1688    L_15:
                           A  1689    .LINE 787
                           A  1690    
                           A  1691    ;  788		if (wc != 0) {
                           A  1692    .LINE 788
                           A  1693    
04109D DD27FB              A  1694    	LD	HL,(IX+%FFFFFFFB)
0410A0 CD D8 47 04         A  1695    	CALL	__scmpzero
0410A4 28 26               A  1696    	JR	Z,L_16
                           A  1697    ;  789			wc = ff_oem2uni(wc, CODEPAGE);	
                           A  1698    .LINE 789
                           A  1699    
0410A6 01B50100            A  1700    	LD	BC,437
0410AA C5                  A  1701    	PUSH	BC
0410AB DD07FB              A  1702    	LD	BC,(IX+%FFFFFFFB)
0410AE C5                  A  1703    	PUSH	BC
0410AF CD D0 0C 04         A  1704    	CALL	_ff_oem2uni
0410B3 C1                  A  1705    	POP	BC
0410B4 C1                  A  1706    	POP	BC
0410B5 DD75FB              A  1707    	LD	(IX+%FFFFFFFB),L
0410B8 DD74FC              A  1708    	LD	(IX+%FFFFFFFC),H
                           A  1709    ;  790			if (wc == 0) return 0xFFFFFFFF;
                           A  1710    .LINE 790
                           A  1711    
0410BB DD27FB              A  1712    	LD	HL,(IX+%FFFFFFFB)
0410BE CD D8 47 04         A  1713    	CALL	__scmpzero
0410C2 20 08               A  1714    	JR	NZ,L_16
0410C4 21FFFFFF            A  1715    	LD	HL,16777215
0410C8 1EFF                A  1716    	LD	E,%FF
0410CA 18 1C               A  1717    	JR	L_17
                           A  1718    ;  791		}
0410CC                     A  1719    L_16:
                           A  1720    .LINE 791
                           A  1721    
                           A  1722    ;  792		uc = wc;
                           A  1723    .LINE 792
                           A  1724    
0410CC DD07FB              A  1725    	LD	BC,(IX+%FFFFFFFB)
0410CF CD 73 45 04         A  1726    	CALL	__stoiu
0410D3 AF                  A  1727    	XOR	A,A
0410D4 DD2FF6              A  1728    	LD	(IX+%FFFFFFF6),HL
0410D7 DD77F9              A  1729    	LD	(IX+%FFFFFFF9),A
                           A  1730    ;  793	
                           A  1731    ;  794	#endif
                           A  1732    ;  795		*str = p;	/* Next read pointer */
                           A  1733    .LINE 795
                           A  1734    
0410DA DD2706              A  1735    	LD	HL,(IX+%6)
0410DD DD07FD              A  1736    	LD	BC,(IX+%FFFFFFFD)
0410E0 ED0F                A  1737    	LD	(HL),BC
                           A  1738    ;  796		return uc;
                           A  1739    .LINE 796
                           A  1740    
0410E2 DD27F6              A  1741    	LD	HL,(IX+%FFFFFFF6)
0410E5 DD5EF9              A  1742    	LD	E,(IX+%FFFFFFF9)
                           A  1743    ;  797	}
0410E8                     A  1744    L_17:
                           A  1745    .LINE 797
                           A  1746    
0410E8 DDF9                A  1747    	LD	SP,IX
0410EA DDE1                A  1748    	POP	IX
0410EC C9                  A  1749    	RET	
                           A  1750    
                           A  1751    
                           A  1752    ;**************************** _tchar2uni ******
                           A  1753    ;Name                         Addr/Register   S
                           A  1754    ;_ff_oem2uni                         IMPORT  --
                           A  1755    ;uc                                   IX-10    
                           A  1756    ;b                                     IX-6    
                           A  1757    ;wc                                    IX-5    
                           A  1758    ;p                                     IX-3    
                           A  1759    ;str                                   IX+6    
                           A  1760    
                           A  1761    
                           A  1762    ; Stack Frame Size: 19 (bytes)
                           A  1763    ;       Spill Code: 0 (instruction)
                           A  1764    
                           A  1765    
                           A  1766    .ENDFUNC "tchar2uni",797,"_tchar2uni"
                           A  1767    ;  798	
                           A  1768    ;  799	
                           A  1769    ;  800	/* Store a Unicode char in defined API 
                           A  1770    ;  801	static UINT put_utf (	/* Returns numb
                           A  1771    ;  802		DWORD chr,	/* UTF-16 encoded chara
                           A  1772    ;  803		TCHAR* buf,	/* Output buffer */
                           A  1773    ;  804		UINT szb	/* Size of the buffer *
                           A  1774    ;  805	)
                           A  1775    ;  806	{
0410ED                     A  1776    _put_utf:
                           A  1777    .DEFINE "_put_utf"
                           A  1778    
                           A  1779    .VALUE _put_utf
                           A  1780    
                           A  1781    .CLASS 3
                           A  1782    
                           A  1783    .TYPE 78
                           A  1784    
                           A  1785    .ENDEF
                           A  1786    
                           A  1787    .BEGFUNC "put_utf",806,"_put_utf"
                           A  1788    
                           A  1789    .LINE 806
                           A  1790    
                           A  1791    .DEFINE "chr"
                           A  1792    
                           A  1793    .CLASS 65
                           A  1794    
                           A  1795    .VALUE 6
                           A  1796    
                           A  1797    .TYPE 15
                           A  1798    
                           A  1799    .ENDEF
                           A  1800    
                           A  1801    .DEFINE "buf"
                           A  1802    
                           A  1803    .CLASS 65
                           A  1804    
                           A  1805    .VALUE 12
                           A  1806    
                           A  1807    .TYPE 34
                           A  1808    
                           A  1809    .ENDEF
                           A  1810    
                           A  1811    .DEFINE "szb"
                           A  1812    
                           A  1813    .CLASS 65
                           A  1814    
                           A  1815    .VALUE 15
                           A  1816    
                           A  1817    .TYPE 14
                           A  1818    
                           A  1819    .ENDEF
                           A  1820    
                           A  1821    .DEFINE "wc"
                           A  1822    
                           A  1823    .CLASS 65
                           A  1824    
                           A  1825    .VALUE -2
                           A  1826    
                           A  1827    .TYPE 13
                           A  1828    
                           A  1829    .ENDEF
                           A  1830    
0410ED DDE5                A  1831    	PUSH	IX
0410EF DD210000 00         A  1832    	LD	IX,0
0410F4 DD39                A  1833    	ADD	IX,SP
0410F6 3B                  A  1834    	DEC	SP
0410F7 3B                  A  1835    	DEC	SP
                           A  1836    ;  807	#if FF_LFN_UNICODE == 1	/* UTF-16 outpu
                           A  1837    ;  808		WCHAR hs, wc;
                           A  1838    ;  809	
                           A  1839    ;  810		hs = (WCHAR)(chr >> 16);
                           A  1840    ;  811		wc = (WCHAR)chr;
                           A  1841    ;  812		if (hs == 0) {	/* Single encoding 
                           A  1842    ;  813			if (szb < 1 || IsSurrogate(wc))
                           A  1843    ;  814			*buf = wc;
                           A  1844    ;  815			return 1;
                           A  1845    ;  816		}
                           A  1846    ;  817		if (szb < 2 || !IsSurrogateH(hs) ||
                           A  1847    ;  818		*buf++ = hs;
                           A  1848    ;  819		*buf++ = wc;
                           A  1849    ;  820		return 2;
                           A  1850    ;  821	
                           A  1851    ;  822	#elif FF_LFN_UNICODE == 2	/* UTF-8 ou
                           A  1852    ;  823		DWORD hc;
                           A  1853    ;  824	
                           A  1854    ;  825		if (chr < 0x80) {	/* Single byte 
                           A  1855    ;  826			if (szb < 1) return 0;	/* Buff
                           A  1856    ;  827			*buf = (TCHAR)chr;
                           A  1857    ;  828			return 1;
                           A  1858    ;  829		}
                           A  1859    ;  830		if (chr < 0x800) {	/* 2-byte seque
                           A  1860    ;  831			if (szb < 2) return 0;	/* Buff
                           A  1861    ;  832			*buf++ = (TCHAR)(0xC0 | (chr >>
                           A  1862    ;  833			*buf++ = (TCHAR)(0x80 | (chr >>
                           A  1863    ;  834			return 2;
                           A  1864    ;  835		}
                           A  1865    ;  836		if (chr < 0x10000) {	/* 3-byte s
                           A  1866    ;  837			if (szb < 3 || IsSurrogate(chr)
                           A  1867    ;  838			*buf++ = (TCHAR)(0xE0 | (chr >>
                           A  1868    ;  839			*buf++ = (TCHAR)(0x80 | (chr >>
                           A  1869    ;  840			*buf++ = (TCHAR)(0x80 | (chr >>
                           A  1870    ;  841			return 3;
                           A  1871    ;  842		}
                           A  1872    ;  843		/* 4-byte sequence */
                           A  1873    ;  844		if (szb < 4) return 0;	/* Buffer o
                           A  1874    ;  845		hc = ((chr & 0xFFFF0000) - 0xD80000
                           A  1875    ;  846		chr = (chr & 0xFFFF) - 0xDC00;		
                           A  1876    ;  847		if (hc >= 0x100000 || chr >= 0x400)
                           A  1877    ;  848		chr = (hc | chr) + 0x10000;
                           A  1878    ;  849		*buf++ = (TCHAR)(0xF0 | (chr >> 18 
                           A  1879    ;  850		*buf++ = (TCHAR)(0x80 | (chr >> 12 
                           A  1880    ;  851		*buf++ = (TCHAR)(0x80 | (chr >> 6 &
                           A  1881    ;  852		*buf++ = (TCHAR)(0x80 | (chr >> 0 &
                           A  1882    ;  853		return 4;
                           A  1883    ;  854	
                           A  1884    ;  855	#elif FF_LFN_UNICODE == 3	/* UTF-32 o
                           A  1885    ;  856		DWORD hc;
                           A  1886    ;  857	
                           A  1887    ;  858		if (szb < 1) return 0;	/* Buffer o
                           A  1888    ;  859		if (chr >= 0x10000) {	/* Out of B
                           A  1889    ;  860			hc = ((chr & 0xFFFF0000) - 0xD8
                           A  1890    ;  861			chr = (chr & 0xFFFF) - 0xDC00;	
                           A  1891    ;  862			if (hc >= 0x100000 || chr >= 0x
                           A  1892    ;  863			chr = (hc | chr) + 0x10000;
                           A  1893    ;  864		}
                           A  1894    ;  865		*buf++ = (TCHAR)chr;
                           A  1895    ;  866		return 1;
                           A  1896    ;  867	
                           A  1897    ;  868	#else						/* ANSI/OEM
                           A  1898    ;  869		WCHAR wc;
                           A  1899    ;  870	
                           A  1900    ;  871		wc = ff_uni2oem(chr, CODEPAGE);
                           A  1901    .LINE 871
                           A  1902    
0410F8 01B50100            A  1903    	LD	BC,437
0410FC C5                  A  1904    	PUSH	BC
0410FD DD4E09              A  1905    	LD	C,(IX+%9)
041100 0600                A  1906    	LD	B,%0
041102 C5                  A  1907    	PUSH	BC
041103 DD0706              A  1908    	LD	BC,(IX+%6)
041106 C5                  A  1909    	PUSH	BC
041107 CD 25 0C 04         A  1910    	CALL	_ff_uni2oem
04110B C1                  A  1911    	POP	BC
04110C C1                  A  1912    	POP	BC
04110D C1                  A  1913    	POP	BC
04110E DD75FE              A  1914    	LD	(IX+%FFFFFFFE),L
041111 DD74FF              A  1915    	LD	(IX+%FFFFFFFF),H
                           A  1916    ;  872		if (wc >= 0x100) {	/* Is this a DB
                           A  1917    .LINE 872
                           A  1918    
041114 49010001            A  1919    	LD.LIS	BC,256
041118 DD27FE              A  1920    	LD	HL,(IX+%FFFFFFFE)
04111B B7                  A  1921    	OR	A,A
04111C 40ED42              A  1922    	SBC.SIS	HL,BC
04111F 38 37               A  1923    	JR	C,L_25
                           A  1924    ;  873			if (szb < 2) return 0;
                           A  1925    .LINE 873
                           A  1926    
041121 01020000            A  1927    	LD	BC,2
041125 DD270F              A  1928    	LD	HL,(IX+%F)
041128 B7                  A  1929    	OR	A,A
041129 ED42                A  1930    	SBC	HL,BC
04112B 30 05               A  1931    	JR	NC,L_20
04112D B7                  A  1932    	OR	A,A
04112E ED62                A  1933    	SBC	HL,HL
041130 18 4B               A  1934    	JR	L_28
041132                     A  1935    L_20:
                           A  1936    ;  874			*buf++ = (char)(wc >> 8);	/* 
                           A  1937    .LINE 874
                           A  1938    
041132 DD07FE              A  1939    	LD	BC,(IX+%FFFFFFFE)
041135 CD 73 45 04         A  1940    	CALL	__stoiu
041139 3E08                A  1941    	LD	A,%8
04113B CD E3 44 04         A  1942    	CALL	__ishrs_b
04113F DD310C              A  1943    	LD	IY,(IX+%C)
041142 FD7500              A  1944    	LD	(IY),L
041145 DD070C              A  1945    	LD	BC,(IX+%C)
041148 03                  A  1946    	INC	BC
041149 DD0F0C              A  1947    	LD	(IX+%C),BC
                           A  1948    ;  875			*buf++ = (TCHAR)wc;			/* 
                           A  1949    .LINE 875
                           A  1950    
04114C DD7EFE              A  1951    	LD	A,(IX+%FFFFFFFE)
04114F C5E1                A  1952    	LD	HL,BC
041151 77                  A  1953    	LD	(HL),A
                           A  1954    ;  876			return 2;
                           A  1955    .LINE 876
                           A  1956    
041152 21020000            A  1957    	LD	HL,2
041156 18 25               A  1958    	JR	L_28
                           A  1959    ;  877		}
041158                     A  1960    L_25:
                           A  1961    .LINE 877
                           A  1962    
                           A  1963    ;  878		if (wc == 0 || szb < 1) return 0;	
                           A  1964    .LINE 878
                           A  1965    
041158 DD27FE              A  1966    	LD	HL,(IX+%FFFFFFFE)
04115B CD D8 47 04         A  1967    	CALL	__scmpzero
04115F 28 0C               A  1968    	JR	Z,L_24
041161 01010000            A  1969    	LD	BC,1
041165 DD270F              A  1970    	LD	HL,(IX+%F)
041168 B7                  A  1971    	OR	A,A
041169 ED42                A  1972    	SBC	HL,BC
04116B 30 05               A  1973    	JR	NC,L_27
04116D                     A  1974    L_24:
04116D B7                  A  1975    	OR	A,A
04116E ED62                A  1976    	SBC	HL,HL
041170 18 0B               A  1977    	JR	L_28
041172                     A  1978    L_27:
                           A  1979    ;  879		*buf++ = (TCHAR)wc;					
                           A  1980    .LINE 879
                           A  1981    
041172 DD7EFE              A  1982    	LD	A,(IX+%FFFFFFFE)
041175 DD270C              A  1983    	LD	HL,(IX+%C)
041178 77                  A  1984    	LD	(HL),A
                           A  1985    ;  880		return 1;
                           A  1986    .LINE 880
                           A  1987    
041179 21010000            A  1988    	LD	HL,1
                           A  1989    ;  881	#endif
                           A  1990    ;  882	}
04117D                     A  1991    L_28:
                           A  1992    .LINE 882
                           A  1993    
04117D DDF9                A  1994    	LD	SP,IX
04117F DDE1                A  1995    	POP	IX
041181 C9                  A  1996    	RET	
                           A  1997    
                           A  1998    
                           A  1999    ;**************************** _put_utf ********
                           A  2000    ;Name                         Addr/Register   S
                           A  2001    ;_ff_uni2oem                         IMPORT  --
                           A  2002    ;wc                                    IX-2    
                           A  2003    ;szb                                  IX+15    
                           A  2004    ;buf                                  IX+12    
                           A  2005    ;chr                                   IX+6    
                           A  2006    
                           A  2007    
                           A  2008    ; Stack Frame Size: 20 (bytes)
                           A  2009    ;       Spill Code: 0 (instruction)
                           A  2010    
                           A  2011    
                           A  2012    .ENDFUNC "put_utf",882,"_put_utf"
                           A  2013    ;  883	#endif	/* FF_USE_LFN */
                           A  2014    ;  884	
                           A  2015    ;  885	
                           A  2016    ;  886	#if FF_FS_REENTRANT
                           A  2017    ;  887	/*-------------------------------------
                           A  2018    ;  888	/* Request/Release grant to access the 
                           A  2019    ;  889	/*-------------------------------------
                           A  2020    ;  890	static int lock_fs (		/* 1:Ok, 0:
                           A  2021    ;  891		FATFS* fs		/* Filesystem objec
                           A  2022    ;  892	)
                           A  2023    ;  893	{
                           A  2024    ;  894		return ff_req_grant(fs->sobj);
                           A  2025    ;  895	}
                           A  2026    ;  896	
                           A  2027    ;  897	
                           A  2028    ;  898	static void unlock_fs (
                           A  2029    ;  899		FATFS* fs,		/* Filesystem objec
                           A  2030    ;  900		FRESULT res		/* Result code to b
                           A  2031    ;  901	)
                           A  2032    ;  902	{
                           A  2033    ;  903		if (fs && res != FR_NOT_ENABLED && 
                           A  2034    ;  904			ff_rel_grant(fs->sobj);
                           A  2035    ;  905		}
                           A  2036    ;  906	}
                           A  2037    ;  907	
                           A  2038    ;  908	#endif
                           A  2039    ;  909	
                           A  2040    ;  910	
                           A  2041    ;  911	
                           A  2042    ;  912	#if FF_FS_LOCK != 0
                           A  2043    ;  913	/*-------------------------------------
                           A  2044    ;  914	/* File lock control functions         
                           A  2045    ;  915	/*-------------------------------------
                           A  2046    ;  916	
                           A  2047    ;  917	static FRESULT chk_lock (	/* Check if
                           A  2048    ;  918		DIR* dp,		/* Directory object
                           A  2049    ;  919		int acc			/* Desired access t
                           A  2050    ;  920	)
                           A  2051    ;  921	{
                           A  2052    ;  922		UINT i, be;
                           A  2053    ;  923	
                           A  2054    ;  924		/* Search open object table for the
                           A  2055    ;  925		be = 0;
                           A  2056    ;  926		for (i = 0; i < FF_FS_LOCK; i++) {
                           A  2057    ;  927			if (Files[i].fs) {	/* Existing
                           A  2058    ;  928				if (Files[i].fs == dp->obj.
                           A  2059    ;  929					Files[i].clu == dp->obj
                           A  2060    ;  930					Files[i].ofs == dp->dpt
                           A  2061    ;  931			} else {			/* Blank en
                           A  2062    ;  932				be = 1;
                           A  2063    ;  933			}
                           A  2064    ;  934		}
                           A  2065    ;  935		if (i == FF_FS_LOCK) {	/* The obje
                           A  2066    ;  936			return (!be && acc != 2) ? FR_T
                           A  2067    ;  937		}
                           A  2068    ;  938	
                           A  2069    ;  939		/* The object was opened. Reject an
                           A  2070    ;  940		return (acc != 0 || Files[i].ctr ==
                           A  2071    ;  941	}
                           A  2072    ;  942	
                           A  2073    ;  943	
                           A  2074    ;  944	static int enq_lock (void)	/* Check if
                           A  2075    ;  945	{
                           A  2076    ;  946		UINT i;
                           A  2077    ;  947	
                           A  2078    ;  948		for (i = 0; i < FF_FS_LOCK && Files
                           A  2079    ;  949		return (i == FF_FS_LOCK) ? 0 : 1;
                           A  2080    ;  950	}
                           A  2081    ;  951	
                           A  2082    ;  952	
                           A  2083    ;  953	static UINT inc_lock (	/* Increment ob
                           A  2084    ;  954		DIR* dp,	/* Directory object poi
                           A  2085    ;  955		int acc		/* Desired access (0:Re
                           A  2086    ;  956	)
                           A  2087    ;  957	{
                           A  2088    ;  958		UINT i;
                           A  2089    ;  959	
                           A  2090    ;  960	
                           A  2091    ;  961		for (i = 0; i < FF_FS_LOCK; i++) {	
                           A  2092    ;  962			if (Files[i].fs == dp->obj.fs
                           A  2093    ;  963			 && Files[i].clu == dp->obj.scl
                           A  2094    ;  964			 && Files[i].ofs == dp->dptr) b
                           A  2095    ;  965		}
                           A  2096    ;  966	
                           A  2097    ;  967		if (i == FF_FS_LOCK) {			/* 
                           A  2098    ;  968			for (i = 0; i < FF_FS_LOCK && F
                           A  2099    ;  969			if (i == FF_FS_LOCK) return 0;	
                           A  2100    ;  970			Files[i].fs = dp->obj.fs;
                           A  2101    ;  971			Files[i].clu = dp->obj.sclust;
                           A  2102    ;  972			Files[i].ofs = dp->dptr;
                           A  2103    ;  973			Files[i].ctr = 0;
                           A  2104    ;  974		}
                           A  2105    ;  975	
                           A  2106    ;  976		if (acc >= 1 && Files[i].ctr) retur
                           A  2107    ;  977	
                           A  2108    ;  978		Files[i].ctr = acc ? 0x100 : Files[
                           A  2109    ;  979	
                           A  2110    ;  980		return i + 1;	/* Index number ori
                           A  2111    ;  981	}
                           A  2112    ;  982	
                           A  2113    ;  983	
                           A  2114    ;  984	static FRESULT dec_lock (	/* Decremen
                           A  2115    ;  985		UINT i			/* Semaphore index 
                           A  2116    ;  986	)
                           A  2117    ;  987	{
                           A  2118    ;  988		WORD n;
                           A  2119    ;  989		FRESULT res;
                           A  2120    ;  990	
                           A  2121    ;  991	
                           A  2122    ;  992		if (--i < FF_FS_LOCK) {	/* Index nu
                           A  2123    ;  993			n = Files[i].ctr;
                           A  2124    ;  994			if (n == 0x100) n = 0;	/* If w
                           A  2125    ;  995			if (n > 0) n--;			/* Decr
                           A  2126    ;  996			Files[i].ctr = n;
                           A  2127    ;  997			if (n == 0) Files[i].fs = 0;	
                           A  2128    ;  998			res = FR_OK;
                           A  2129    ;  999		} else {
                           A  2130    ; 1000			res = FR_INT_ERR;		/* Inva
                           A  2131    ; 1001		}
                           A  2132    ; 1002		return res;
                           A  2133    ; 1003	}
                           A  2134    ; 1004	
                           A  2135    ; 1005	
                           A  2136    ; 1006	static void clear_lock (	/* Clear lo
                           A  2137    ; 1007		FATFS *fs
                           A  2138    ; 1008	)
                           A  2139    ; 1009	{
                           A  2140    ; 1010		UINT i;
                           A  2141    ; 1011	
                           A  2142    ; 1012		for (i = 0; i < FF_FS_LOCK; i++) {
                           A  2143    ; 1013			if (Files[i].fs == fs) Files[i]
                           A  2144    ; 1014		}
                           A  2145    ; 1015	}
                           A  2146    ; 1016	
                           A  2147    ; 1017	#endif	/* FF_FS_LOCK != 0 */
                           A  2148    ; 1018	
                           A  2149    ; 1019	
                           A  2150    ; 1020	
                           A  2151    ; 1021	/*-------------------------------------
                           A  2152    ; 1022	/* Move/Flush disk access window in the
                           A  2153    ; 1023	/*-------------------------------------
                           A  2154    ; 1024	#if !FF_FS_READONLY
                           A  2155    ; 1025	static FRESULT sync_window (	/* Retu
                           A  2156    ; 1026		FATFS* fs			/* Filesystem o
                           A  2157    ; 1027	)
                           A  2158    ; 1028	{
                           A  2159    ; 1029		FRESULT res = FR_OK;
                           A  2160    ; 1030	
                           A  2161    ; 1031	
                           A  2162    ; 1032		if (fs->wflag) {	/* Is the disk 
                           A  2163    ; 1033			if (disk_write(fs->pdrv, fs->wi
                           A  2164    ; 1034				fs->wflag = 0;	/* Clear wi
                           A  2165    ; 1035				if (fs->winsect - fs->fatba
                           A  2166    ; 1036					if (fs->n_fats == 2) di
                           A  2167    ; 1037				}
                           A  2168    ; 1038			} else {
                           A  2169    ; 1039				res = FR_DISK_ERR;
                           A  2170    ; 1040			}
                           A  2171    ; 1041		}
                           A  2172    ; 1042		return res;
                           A  2173    ; 1043	}
                           A  2174    ; 1044	#endif
                           A  2175    ; 1045	
                           A  2176    ; 1046	
                           A  2177    ; 1047	static FRESULT move_window (	/* Retu
                           A  2178    ; 1048		FATFS* fs,		/* Filesystem objec
                           A  2179    ; 1049		LBA_t sect		/* Sector LBA to ma
                           A  2180    ; 1050	)
                           A  2181    ; 1051	{
041182                     A  2182    _move_window:
                           A  2183    .DEFINE "_move_window"
                           A  2184    
                           A  2185    .VALUE _move_window
                           A  2186    
                           A  2187    .CLASS 3
                           A  2188    
                           A  2189    .TYPE 68
                           A  2190    
                           A  2191    .ENDEF
                           A  2192    
                           A  2193    .BEGFUNC "move_window",1051,"_move_window"
                           A  2194    
                           A  2195    .LINE 1051
                           A  2196    
                           A  2197    .DEFINE "fs"
                           A  2198    
                           A  2199    .CLASS 65
                           A  2200    
                           A  2201    .VALUE 6
                           A  2202    
                           A  2203    .TAG "NONAME0"
                           A  2204    
                           A  2205    .TYPE 40
                           A  2206    
                           A  2207    .ENDEF
                           A  2208    
                           A  2209    .DEFINE "sect"
                           A  2210    
                           A  2211    .CLASS 65
                           A  2212    
                           A  2213    .VALUE 9
                           A  2214    
                           A  2215    .TYPE 15
                           A  2216    
                           A  2217    .ENDEF
                           A  2218    
                           A  2219    .DEFINE "res"
                           A  2220    
                           A  2221    .CLASS 65
                           A  2222    
                           A  2223    .VALUE -3
                           A  2224    
                           A  2225    .TYPE 4
                           A  2226    
                           A  2227    .ENDEF
                           A  2228    
041182 DDE5                A  2229    	PUSH	IX
041184 DD210000 00         A  2230    	LD	IX,0
041189 DD39                A  2231    	ADD	IX,SP
04118B C5                  A  2232    	PUSH	BC
                           A  2233    ; 1052		FRESULT res = FR_OK;
                           A  2234    .LINE 1052
                           A  2235    
04118C 01000000            A  2236    	LD	BC,0
041190 DD0FFD              A  2237    	LD	(IX+%FFFFFFFD),BC
                           A  2238    ; 1053	
                           A  2239    ; 1054	
                           A  2240    ; 1055		if (sect != fs->winsect) {	/* Wind
                           A  2241    .LINE 1055
                           A  2242    
041193 DD3106              A  2243    	LD	IY,(IX+%6)
041196 FD272A              A  2244    	LD	HL,(IY+%2A)
041199 FD5E2D              A  2245    	LD	E,(IY+%2D)
04119C DD0709              A  2246    	LD	BC,(IX+%9)
04119F DD7E0C              A  2247    	LD	A,(IX+%C)
0411A2 CD 88 47 04         A  2248    	CALL	__lcmpu
0411A6 28 4C               A  2249    	JR	Z,L_33
                           A  2250    ; 1056	#if !FF_FS_READONLY
                           A  2251    ; 1057			res = sync_window(fs);		/* 
                           A  2252    ; 1058	#endif
                           A  2253    ; 1059			if (res == FR_OK) {			/* 
                           A  2254    ; 1060				if (disk_read(fs->pdrv, fs-
                           A  2255    .LINE 1060
                           A  2256    
0411A8 01010000            A  2257    	LD	BC,1
0411AC C5                  A  2258    	PUSH	BC
0411AD DD4E0C              A  2259    	LD	C,(IX+%C)
0411B0 0600                A  2260    	LD	B,%0
0411B2 C5                  A  2261    	PUSH	BC
0411B3 DD0709              A  2262    	LD	BC,(IX+%9)
0411B6 C5                  A  2263    	PUSH	BC
0411B7 DD3106              A  2264    	LD	IY,(IX+%6)
0411BA ED662E              A  2265    	PEA	IY+%2E
0411BD FD4E01              A  2266    	LD	C,(IY+%1)
0411C0 0600                A  2267    	LD	B,%0
0411C2 C5                  A  2268    	PUSH	BC
0411C3 CD FE 3E 04         A  2269    	CALL	_disk_read
0411C7 C1                  A  2270    	POP	BC
0411C8 C1                  A  2271    	POP	BC
0411C9 C1                  A  2272    	POP	BC
0411CA C1                  A  2273    	POP	BC
0411CB C1                  A  2274    	POP	BC
0411CC CD E5 46 04         A  2275    	CALL	__icmpzero
0411D0 28 13               A  2276    	JR	Z,L_30
                           A  2277    ; 1061					sect = (LBA_t)0 - 1;	
                           A  2278    .LINE 1061
                           A  2279    
0411D2 01FFFFFF            A  2280    	LD	BC,16777215
0411D6 3EFF                A  2281    	LD	A,%FF
0411D8 DD0F09              A  2282    	LD	(IX+%9),BC
0411DB DD770C              A  2283    	LD	(IX+%C),A
                           A  2284    ; 1062					res = FR_DISK_ERR;
                           A  2285    .LINE 1062
                           A  2286    
0411DE 01010000            A  2287    	LD	BC,1
0411E2 DD0FFD              A  2288    	LD	(IX+%FFFFFFFD),BC
                           A  2289    ; 1063				}
0411E5                     A  2290    L_30:
                           A  2291    .LINE 1063
                           A  2292    
                           A  2293    ; 1064				fs->winsect = sect;
                           A  2294    .LINE 1064
                           A  2295    
0411E5 DD0709              A  2296    	LD	BC,(IX+%9)
0411E8 DD7E0C              A  2297    	LD	A,(IX+%C)
0411EB DD3106              A  2298    	LD	IY,(IX+%6)
0411EE FD0F2A              A  2299    	LD	(IY+%2A),BC
0411F1 FD772D              A  2300    	LD	(IY+%2D),A
                           A  2301    ; 1065			}
                           A  2302    ; 1066		}
0411F4                     A  2303    L_33:
                           A  2304    .LINE 1066
                           A  2305    
                           A  2306    ; 1067		return res;
                           A  2307    .LINE 1067
                           A  2308    
0411F4 DD27FD              A  2309    	LD	HL,(IX+%FFFFFFFD)
                           A  2310    ; 1068	}
                           A  2311    .LINE 1068
                           A  2312    
0411F7 DDF9                A  2313    	LD	SP,IX
0411F9 DDE1                A  2314    	POP	IX
0411FB C9                  A  2315    	RET	
                           A  2316    
                           A  2317    
                           A  2318    ;**************************** _move_window ****
                           A  2319    ;Name                         Addr/Register   S
                           A  2320    ;_disk_read                          IMPORT  --
                           A  2321    ;res                                   IX-3    
                           A  2322    ;sect                                  IX+9    
                           A  2323    ;fs                                    IX+6    
                           A  2324    
                           A  2325    
                           A  2326    ; Stack Frame Size: 18 (bytes)
                           A  2327    ;       Spill Code: 0 (instruction)
                           A  2328    
                           A  2329    
                           A  2330    .ENDFUNC "move_window",1068,"_move_window"
                           A  2331    ; 1069	
                           A  2332    ; 1070	
                           A  2333    ; 1071	
                           A  2334    ; 1072	
                           A  2335    ; 1073	#if !FF_FS_READONLY
                           A  2336    ; 1074	/*-------------------------------------
                           A  2337    ; 1075	/* Synchronize filesystem and data on t
                           A  2338    ; 1076	/*-------------------------------------
                           A  2339    ; 1077	
                           A  2340    ; 1078	static FRESULT sync_fs (	/* Returns 
                           A  2341    ; 1079		FATFS* fs		/* Filesystem objec
                           A  2342    ; 1080	)
                           A  2343    ; 1081	{
                           A  2344    ; 1082		FRESULT res;
                           A  2345    ; 1083	
                           A  2346    ; 1084	
                           A  2347    ; 1085		res = sync_window(fs);
                           A  2348    ; 1086		if (res == FR_OK) {
                           A  2349    ; 1087			if (fs->fs_type == FS_FAT32 && 
                           A  2350    ; 1088				/* Create FSInfo structure 
                           A  2351    ; 1089				memset(fs->win, 0, sizeof f
                           A  2352    ; 1090				st_word(fs->win + BS_55AA, 
                           A  2353    ; 1091				st_dword(fs->win + FSI_Lead
                           A  2354    ; 1092				st_dword(fs->win + FSI_Stru
                           A  2355    ; 1093				st_dword(fs->win + FSI_Free
                           A  2356    ; 1094				st_dword(fs->win + FSI_Nxt_
                           A  2357    ; 1095				fs->winsect = fs->volbase +
                           A  2358    ; 1096				disk_write(fs->pdrv, fs->wi
                           A  2359    ; 1097				fs->fsi_flag = 0;
                           A  2360    ; 1098			}
                           A  2361    ; 1099			/* Make sure that no pending wr
                           A  2362    ; 1100			if (disk_ioctl(fs->pdrv, CTRL_S
                           A  2363    ; 1101		}
                           A  2364    ; 1102	
                           A  2365    ; 1103		return res;
                           A  2366    ; 1104	}
                           A  2367    ; 1105	
                           A  2368    ; 1106	#endif
                           A  2369    ; 1107	
                           A  2370    ; 1108	
                           A  2371    ; 1109	
                           A  2372    ; 1110	/*-------------------------------------
                           A  2373    ; 1111	/* Get physical sector number from clus
                           A  2374    ; 1112	/*-------------------------------------
                           A  2375    ; 1113	
                           A  2376    ; 1114	static LBA_t clst2sect (	/* !=0:Sect
                           A  2377    ; 1115		FATFS* fs,		/* Filesystem objec
                           A  2378    ; 1116		DWORD clst		/* Cluster# to be c
                           A  2379    ; 1117	)
                           A  2380    ; 1118	{
0411FC                     A  2381    _clst2sect:
                           A  2382    .DEFINE "_clst2sect"
                           A  2383    
                           A  2384    .VALUE _clst2sect
                           A  2385    
                           A  2386    .CLASS 3
                           A  2387    
                           A  2388    .TYPE 79
                           A  2389    
                           A  2390    .ENDEF
                           A  2391    
                           A  2392    .BEGFUNC "clst2sect",1118,"_clst2sect"
                           A  2393    
                           A  2394    .LINE 1118
                           A  2395    
                           A  2396    .DEFINE "fs"
                           A  2397    
                           A  2398    .CLASS 65
                           A  2399    
                           A  2400    .VALUE 6
                           A  2401    
                           A  2402    .TAG "NONAME0"
                           A  2403    
                           A  2404    .TYPE 40
                           A  2405    
                           A  2406    .ENDEF
                           A  2407    
                           A  2408    .DEFINE "clst"
                           A  2409    
                           A  2410    .CLASS 65
                           A  2411    
                           A  2412    .VALUE 9
                           A  2413    
                           A  2414    .TYPE 15
                           A  2415    
                           A  2416    .ENDEF
                           A  2417    
0411FC DDE5                A  2418    	PUSH	IX
0411FE DD210000 00         A  2419    	LD	IX,0
041203 DD39                A  2420    	ADD	IX,SP
                           A  2421    ; 1119		clst -= 2;		/* Cluster number i
                           A  2422    .LINE 1119
                           A  2423    
041205 DD2709              A  2424    	LD	HL,(IX+%9)
041208 DD5E0C              A  2425    	LD	E,(IX+%C)
04120B 01020000            A  2426    	LD	BC,2
04120F AF                  A  2427    	XOR	A,A
041210 CD 7B 46 04         A  2428    	CALL	__lsub
041214 DD2F09              A  2429    	LD	(IX+%9),HL
041217 DD730C              A  2430    	LD	(IX+%C),E
                           A  2431    ; 1120		if (clst >= fs->n_fatent - 2) retur
                           A  2432    .LINE 1120
                           A  2433    
04121A DD3106              A  2434    	LD	IY,(IX+%6)
04121D FD2712              A  2435    	LD	HL,(IY+%12)
041220 FD5E15              A  2436    	LD	E,(IY+%15)
041223 01020000            A  2437    	LD	BC,2
041227 AF                  A  2438    	XOR	A,A
041228 CD 7B 46 04         A  2439    	CALL	__lsub
04122C 7B                  A  2440    	LD	A,E
04122D E5C1                A  2441    	LD	BC,HL
04122F DD2709              A  2442    	LD	HL,(IX+%9)
041232 DD5E0C              A  2443    	LD	E,(IX+%C)
041235 CD 88 47 04         A  2444    	CALL	__lcmpu
041239 38 07               A  2445    	JR	C,L_36
04123B B7                  A  2446    	OR	A,A
04123C ED62                A  2447    	SBC	HL,HL
04123E 1E00                A  2448    	LD	E,%0
041240 18 20               A  2449    	JR	L_37
041242                     A  2450    L_36:
                           A  2451    ; 1121		return fs->database + (LBA_t)fs->cs
                           A  2452    .LINE 1121
                           A  2453    
041242 DD3106              A  2454    	LD	IY,(IX+%6)
041245 FD0709              A  2455    	LD	BC,(IY+%9)
041248 CD 73 45 04         A  2456    	CALL	__stoiu
04124C 1E00                A  2457    	LD	E,%0
04124E DD0709              A  2458    	LD	BC,(IX+%9)
041251 DD7E0C              A  2459    	LD	A,(IX+%C)
041254 CD BD 48 04         A  2460    	CALL	__lmulu
041258 FD0726              A  2461    	LD	BC,(IY+%26)
04125B FD7E29              A  2462    	LD	A,(IY+%29)
04125E CD A5 44 04         A  2463    	CALL	__ladd
                           A  2464    ; 1122	}
041262                     A  2465    L_37:
                           A  2466    .LINE 1122
                           A  2467    
041262 DDF9                A  2468    	LD	SP,IX
041264 DDE1                A  2469    	POP	IX
041266 C9                  A  2470    	RET	
                           A  2471    
                           A  2472    
                           A  2473    ;**************************** _clst2sect ******
                           A  2474    ;Name                         Addr/Register   S
                           A  2475    ;clst                                  IX+9    
                           A  2476    ;fs                                    IX+6    
                           A  2477    
                           A  2478    
                           A  2479    ; Stack Frame Size: 15 (bytes)
                           A  2480    ;       Spill Code: 0 (instruction)
                           A  2481    
                           A  2482    
                           A  2483    .ENDFUNC "clst2sect",1122,"_clst2sect"
                           A  2484    ; 1123	
                           A  2485    ; 1124	
                           A  2486    ; 1125	
                           A  2487    ; 1126	
                           A  2488    ; 1127	/*-------------------------------------
                           A  2489    ; 1128	/* FAT access - Read value of an FAT en
                           A  2490    ; 1129	/*-------------------------------------
                           A  2491    ; 1130	
                           A  2492    ; 1131	static DWORD get_fat (		/* 0xFFFFFF
                           A  2493    ; 1132		FFOBJID* obj,	/* Corresponding ob
                           A  2494    ; 1133		DWORD clst		/* Cluster number t
                           A  2495    ; 1134	)
                           A  2496    ; 1135	{
041267                     A  2497    _get_fat:
                           A  2498    .DEFINE "_get_fat"
                           A  2499    
                           A  2500    .VALUE _get_fat
                           A  2501    
                           A  2502    .CLASS 3
                           A  2503    
                           A  2504    .TYPE 79
                           A  2505    
                           A  2506    .ENDEF
                           A  2507    
                           A  2508    .BEGFUNC "get_fat",1135,"_get_fat"
                           A  2509    
                           A  2510    .LINE 1135
                           A  2511    
                           A  2512    .DEFINE "obj"
                           A  2513    
                           A  2514    .CLASS 65
                           A  2515    
                           A  2516    .VALUE 6
                           A  2517    
                           A  2518    .TAG "NONAME1"
                           A  2519    
                           A  2520    .TYPE 40
                           A  2521    
                           A  2522    .ENDEF
                           A  2523    
                           A  2524    .DEFINE "clst"
                           A  2525    
                           A  2526    .CLASS 65
                           A  2527    
                           A  2528    .VALUE 9
                           A  2529    
                           A  2530    .TYPE 15
                           A  2531    
                           A  2532    .ENDEF
                           A  2533    
                           A  2534    .DEFINE "fs"
                           A  2535    
                           A  2536    .CLASS 65
                           A  2537    
                           A  2538    .VALUE -3
                           A  2539    
                           A  2540    .TAG "NONAME0"
                           A  2541    
                           A  2542    .TYPE 40
                           A  2543    
                           A  2544    .ENDEF
                           A  2545    
                           A  2546    .DEFINE "bc"
                           A  2547    
                           A  2548    .CLASS 65
                           A  2549    
                           A  2550    .VALUE -6
                           A  2551    
                           A  2552    .TYPE 14
                           A  2553    
                           A  2554    .ENDEF
                           A  2555    
                           A  2556    .DEFINE "val"
                           A  2557    
                           A  2558    .CLASS 65
                           A  2559    
                           A  2560    .VALUE -10
                           A  2561    
                           A  2562    .TYPE 15
                           A  2563    
                           A  2564    .ENDEF
                           A  2565    
                           A  2566    .DEFINE "wc"
                           A  2567    
                           A  2568    .CLASS 65
                           A  2569    
                           A  2570    .VALUE -13
                           A  2571    
                           A  2572    .TYPE 14
                           A  2573    
                           A  2574    .ENDEF
                           A  2575    
041267 DDE5                A  2576    	PUSH	IX
041269 DD210000 00         A  2577    	LD	IX,0
04126E DD39                A  2578    	ADD	IX,SP
041270 ED22F0              A  2579    	LEA	HL,IX+%FFFFFFF0
041273 F9                  A  2580    	LD	SP,HL
                           A  2581    ; 1136		UINT wc, bc;
                           A  2582    ; 1137		DWORD val;
                           A  2583    ; 1138		FATFS *fs = obj->fs;
                           A  2584    .LINE 1138
                           A  2585    
041274 DD3106              A  2586    	LD	IY,(IX+%6)
041277 FD0700              A  2587    	LD	BC,(IY+%0)
04127A DD0FFD              A  2588    	LD	(IX+%FFFFFFFD),BC
                           A  2589    ; 1139	
                           A  2590    ; 1140	
                           A  2591    ; 1141		if (clst < 2 || clst >= fs->n_faten
                           A  2592    .LINE 1141
                           A  2593    
04127D DD2709              A  2594    	LD	HL,(IX+%9)
041280 DD5E0C              A  2595    	LD	E,(IX+%C)
041283 01020000            A  2596    	LD	BC,2
041287 AF                  A  2597    	XOR	A,A
041288 CD 88 47 04         A  2598    	CALL	__lcmpu
04128C 38 15               A  2599    	JR	C,L_56
04128E DD2709              A  2600    	LD	HL,(IX+%9)
041291 DD5E0C              A  2601    	LD	E,(IX+%C)
041294 DD31FD              A  2602    	LD	IY,(IX+%FFFFFFFD)
041297 FD0712              A  2603    	LD	BC,(IY+%12)
04129A FD7E15              A  2604    	LD	A,(IY+%15)
04129D CD 88 47 04         A  2605    	CALL	__lcmpu
0412A1 38 0F               A  2606    	JR	C,L_57
0412A3                     A  2607    L_56:
                           A  2608    ; 1142			val = 1;	/* Internal error *
                           A  2609    .LINE 1142
                           A  2610    
0412A3 01010000            A  2611    	LD	BC,1
0412A7 AF                  A  2612    	XOR	A,A
0412A8 DD0FF6              A  2613    	LD	(IX+%FFFFFFF6),BC
0412AB DD77F9              A  2614    	LD	(IX+%FFFFFFF9),A
                           A  2615    ; 1143	
                           A  2616    ; 1144		} else {
                           A  2617    .LINE 1144
                           A  2618    
0412AE C3 A9 14 04         A  2619    	JR	L_58
0412B2                     A  2620    L_57:
                           A  2621    ; 1145			val = 0xFFFFFFFF;	/* Default 
                           A  2622    .LINE 1145
                           A  2623    
0412B2 01FFFFFF            A  2624    	LD	BC,16777215
0412B6 3EFF                A  2625    	LD	A,%FF
0412B8 DD0FF6              A  2626    	LD	(IX+%FFFFFFF6),BC
0412BB DD77F9              A  2627    	LD	(IX+%FFFFFFF9),A
                           A  2628    ; 1146	
                           A  2629    ; 1147			switch (fs->fs_type) {
                           A  2630    .LINE 1147
                           A  2631    
0412BE DD31FD              A  2632    	LD	IY,(IX+%FFFFFFFD)
0412C1 FD7E00              A  2633    	LD	A,(IY+%0)
0412C4 B7ED62              A  2634    	UEXT	HL
0412C7 6F                  A  2635    	LD	L,A
0412C8 CD 08 45 04         A  2636    	CALL	__seqcaseD
0412CC E9                  A  2637    	JP	(HL)
0412CD                     A  2638    L__23:
0412CD 0300                A  2639    	DW	3
0412CF 0100                A  2640    	DW	1
0412D1 00                  A  2641    	DB	0
0412D2 DE1204              A  2642    	DW24	L_39	
                           A  2643    
0412D5 CF1304              A  2644    	DW24	L_49	
                           A  2645    
0412D8 361404              A  2646    	DW24	L_52	
                           A  2647    
0412DB 9E1404              A  2648    	DW24	L_55	
                           A  2649    
                           A  2650    ; 1148			case FS_FAT12 :
0412DE                     A  2651    L_39:
                           A  2652    .LINE 1148
                           A  2653    
                           A  2654    ; 1149				bc = (UINT)clst; bc += bc /
                           A  2655    .LINE 1149
                           A  2656    
0412DE DD2709              A  2657    	LD	HL,(IX+%9)
0412E1 3E01                A  2658    	LD	A,%1
0412E3 CD 5C 47 04         A  2659    	CALL	__ishru_b
0412E7 DD0709              A  2660    	LD	BC,(IX+%9)
0412EA 09                  A  2661    	ADD	HL,BC
0412EB DD2FFA              A  2662    	LD	(IX+%FFFFFFFA),HL
                           A  2663    ; 1150				if (move_window(fs, fs->fat
                           A  2664    .LINE 1150
                           A  2665    
0412EE 3E09                A  2666    	LD	A,%9
0412F0 CD 5C 47 04         A  2667    	CALL	__ishru_b
0412F4 E5C1                A  2668    	LD	BC,HL
0412F6 AF                  A  2669    	XOR	A,A
0412F7 DD31FD              A  2670    	LD	IY,(IX+%FFFFFFFD)
0412FA FD271E              A  2671    	LD	HL,(IY+%1E)
0412FD FD5E21              A  2672    	LD	E,(IY+%21)
041300 CD A5 44 04         A  2673    	CALL	__ladd
041304 4B                  A  2674    	LD	C,E
041305 0600                A  2675    	LD	B,%0
041307 C5                  A  2676    	PUSH	BC
041308 E5                  A  2677    	PUSH	HL
041309 DD07FD              A  2678    	LD	BC,(IX+%FFFFFFFD)
04130C C5                  A  2679    	PUSH	BC
04130D CD 82 11 04         A  2680    	CALL	_move_window
041311 C1                  A  2681    	POP	BC
041312 C1                  A  2682    	POP	BC
041313 C1                  A  2683    	POP	BC
041314 CD E5 46 04         A  2684    	CALL	__icmpzero
041318 C2 A9 14 04         A  2685    	JR	NZ,L_58
                           A  2686    ; 1151				wc = fs->win[bc++ % SS(fs)]
                           A  2687    .LINE 1151
                           A  2688    
04131C 01FF0100            A  2689    	LD	BC,511
041320 DD27FA              A  2690    	LD	HL,(IX+%FFFFFFFA)
041323 CD F4 47 04         A  2691    	CALL	__iand
041327 E5C1                A  2692    	LD	BC,HL
041329 DD31FD              A  2693    	LD	IY,(IX+%FFFFFFFD)
04132C ED232E              A  2694    	LEA	HL,IY+%2E
04132F 09                  A  2695    	ADD	HL,BC
041330 7E                  A  2696    	LD	A,(HL)
041331 B7ED62              A  2697    	UEXT	HL
041334 6F                  A  2698    	LD	L,A
041335 DD2FF3              A  2699    	LD	(IX+%FFFFFFF3),HL
041338 DD07FA              A  2700    	LD	BC,(IX+%FFFFFFFA)
04133B 03                  A  2701    	INC	BC
04133C DD0FFA              A  2702    	LD	(IX+%FFFFFFFA),BC
                           A  2703    ; 1152				if (move_window(fs, fs->fat
                           A  2704    .LINE 1152
                           A  2705    
04133F C5E1                A  2706    	LD	HL,BC
041341 3E09                A  2707    	LD	A,%9
041343 CD 5C 47 04         A  2708    	CALL	__ishru_b
041347 E5C1                A  2709    	LD	BC,HL
041349 AF                  A  2710    	XOR	A,A
04134A FD271E              A  2711    	LD	HL,(IY+%1E)
04134D FD5E21              A  2712    	LD	E,(IY+%21)
041350 CD A5 44 04         A  2713    	CALL	__ladd
041354 4B                  A  2714    	LD	C,E
041355 0600                A  2715    	LD	B,%0
041357 C5                  A  2716    	PUSH	BC
041358 E5                  A  2717    	PUSH	HL
041359 DD07FD              A  2718    	LD	BC,(IX+%FFFFFFFD)
04135C C5                  A  2719    	PUSH	BC
04135D CD 82 11 04         A  2720    	CALL	_move_window
041361 C1                  A  2721    	POP	BC
041362 C1                  A  2722    	POP	BC
041363 C1                  A  2723    	POP	BC
041364 CD E5 46 04         A  2724    	CALL	__icmpzero
041368 C2 A9 14 04         A  2725    	JR	NZ,L_58
                           A  2726    ; 1153				wc |= fs->win[bc % SS(fs)] 
                           A  2727    .LINE 1153
                           A  2728    
04136C 01FF0100            A  2729    	LD	BC,511
041370 DD27FA              A  2730    	LD	HL,(IX+%FFFFFFFA)
041373 CD F4 47 04         A  2731    	CALL	__iand
041377 E5C1                A  2732    	LD	BC,HL
041379 DD31FD              A  2733    	LD	IY,(IX+%FFFFFFFD)
04137C ED232E              A  2734    	LEA	HL,IY+%2E
04137F 09                  A  2735    	ADD	HL,BC
041380 7E                  A  2736    	LD	A,(HL)
041381 B7ED62              A  2737    	UEXT	HL
041384 6F                  A  2738    	LD	L,A
041385 3E08                A  2739    	LD	A,%8
041387 CD 30 48 04         A  2740    	CALL	__ishl_b
04138B DD07F3              A  2741    	LD	BC,(IX+%FFFFFFF3)
04138E CD 58 45 04         A  2742    	CALL	__ior
041392 DD2FF3              A  2743    	LD	(IX+%FFFFFFF3),HL
                           A  2744    ; 1154				val = (clst & 1) ? (wc >> 4
                           A  2745    .LINE 1154
                           A  2746    
041395 DD7E09              A  2747    	LD	A,(IX+%9)
041398 E601                A  2748    	AND	A,%1
04139A B7ED62              A  2749    	UEXT	HL
04139D 6F                  A  2750    	LD	L,A
04139E 5C                  A  2751    	LD	E,H
04139F CD B8 45 04         A  2752    	CALL	__lcmpzero
0413A3 28 0E               A  2753    	JR	Z,L_47
0413A5 DD27F3              A  2754    	LD	HL,(IX+%FFFFFFF3)
0413A8 3E04                A  2755    	LD	A,%4
0413AA CD 5C 47 04         A  2756    	CALL	__ishru_b
0413AE DD2FF0              A  2757    	LD	(IX+%FFFFFFF0),HL
0413B1 18 0E               A  2758    	JR	L_48
0413B3                     A  2759    L_47:
0413B3 01FF0F00            A  2760    	LD	BC,4095
0413B7 DD27F3              A  2761    	LD	HL,(IX+%FFFFFFF3)
0413BA CD F4 47 04         A  2762    	CALL	__iand
0413BE DD2FF0              A  2763    	LD	(IX+%FFFFFFF0),HL
0413C1                     A  2764    L_48:
0413C1 DD07F0              A  2765    	LD	BC,(IX+%FFFFFFF0)
0413C4 AF                  A  2766    	XOR	A,A
0413C5 DD0FF6              A  2767    	LD	(IX+%FFFFFFF6),BC
0413C8 DD77F9              A  2768    	LD	(IX+%FFFFFFF9),A
                           A  2769    ; 1155				break;
                           A  2770    .LINE 1155
                           A  2771    
0413CB C3 A9 14 04         A  2772    	JR	L_58
                           A  2773    ; 1156	
                           A  2774    ; 1157			case FS_FAT16 :
0413CF                     A  2775    L_49:
                           A  2776    .LINE 1157
                           A  2777    
                           A  2778    ; 1158				if (move_window(fs, fs->fat
                           A  2779    .LINE 1158
                           A  2780    
0413CF DD0709              A  2781    	LD	BC,(IX+%9)
0413D2 DD7E0C              A  2782    	LD	A,(IX+%C)
0413D5 2E08                A  2783    	LD	L,%8
0413D7 CD 87 46 04         A  2784    	CALL	__lshru
0413DB DD31FD              A  2785    	LD	IY,(IX+%FFFFFFFD)
0413DE FD271E              A  2786    	LD	HL,(IY+%1E)
0413E1 FD5E21              A  2787    	LD	E,(IY+%21)
0413E4 CD A5 44 04         A  2788    	CALL	__ladd
0413E8 4B                  A  2789    	LD	C,E
0413E9 0600                A  2790    	LD	B,%0
0413EB C5                  A  2791    	PUSH	BC
0413EC E5                  A  2792    	PUSH	HL
0413ED DD07FD              A  2793    	LD	BC,(IX+%FFFFFFFD)
0413F0 C5                  A  2794    	PUSH	BC
0413F1 CD 82 11 04         A  2795    	CALL	_move_window
0413F5 C1                  A  2796    	POP	BC
0413F6 C1                  A  2797    	POP	BC
0413F7 C1                  A  2798    	POP	BC
0413F8 CD E5 46 04         A  2799    	CALL	__icmpzero
0413FC C2 A9 14 04         A  2800    	JR	NZ,L_58
                           A  2801    ; 1159				val = ld_word(fs->win + cls
                           A  2802    .LINE 1159
                           A  2803    
041400 DD2709              A  2804    	LD	HL,(IX+%9)
041403 DD5E0C              A  2805    	LD	E,(IX+%C)
041406 01020000            A  2806    	LD	BC,2
04140A AF                  A  2807    	XOR	A,A
04140B CD BD 48 04         A  2808    	CALL	__lmulu
04140F 01FF0100            A  2809    	LD	BC,511
041413 AF                  A  2810    	XOR	A,A
041414 CD B4 48 04         A  2811    	CALL	__land
041418 E5C1                A  2812    	LD	BC,HL
04141A DD31FD              A  2813    	LD	IY,(IX+%FFFFFFFD)
04141D ED232E              A  2814    	LEA	HL,IY+%2E
041420 09                  A  2815    	ADD	HL,BC
041421 E5                  A  2816    	PUSH	HL
041422 CD 25 0F 04         A  2817    	CALL	_ld_word
041426 C1                  A  2818    	POP	BC
041427 E5C1                A  2819    	LD	BC,HL
041429 CD 73 45 04         A  2820    	CALL	__stoiu
04142D AF                  A  2821    	XOR	A,A
04142E DD2FF6              A  2822    	LD	(IX+%FFFFFFF6),HL
041431 DD77F9              A  2823    	LD	(IX+%FFFFFFF9),A
                           A  2824    ; 1160				break;
                           A  2825    .LINE 1160
                           A  2826    
041434 18 73               A  2827    	JR	L_58
                           A  2828    ; 1161	
                           A  2829    ; 1162			case FS_FAT32 :
041436                     A  2830    L_52:
                           A  2831    .LINE 1162
                           A  2832    
                           A  2833    ; 1163				if (move_window(fs, fs->fat
                           A  2834    .LINE 1163
                           A  2835    
041436 DD0709              A  2836    	LD	BC,(IX+%9)
041439 DD7E0C              A  2837    	LD	A,(IX+%C)
04143C 2E07                A  2838    	LD	L,%7
04143E CD 87 46 04         A  2839    	CALL	__lshru
041442 DD31FD              A  2840    	LD	IY,(IX+%FFFFFFFD)
041445 FD271E              A  2841    	LD	HL,(IY+%1E)
041448 FD5E21              A  2842    	LD	E,(IY+%21)
04144B CD A5 44 04         A  2843    	CALL	__ladd
04144F 4B                  A  2844    	LD	C,E
041450 0600                A  2845    	LD	B,%0
041452 C5                  A  2846    	PUSH	BC
041453 E5                  A  2847    	PUSH	HL
041454 DD07FD              A  2848    	LD	BC,(IX+%FFFFFFFD)
041457 C5                  A  2849    	PUSH	BC
041458 CD 82 11 04         A  2850    	CALL	_move_window
04145C C1                  A  2851    	POP	BC
04145D C1                  A  2852    	POP	BC
04145E C1                  A  2853    	POP	BC
04145F CD E5 46 04         A  2854    	CALL	__icmpzero
041463 20 44               A  2855    	JR	NZ,L_58
                           A  2856    ; 1164				val = ld_dword(fs->win + cl
                           A  2857    .LINE 1164
                           A  2858    
041465 DD2709              A  2859    	LD	HL,(IX+%9)
041468 DD5E0C              A  2860    	LD	E,(IX+%C)
04146B 01040000            A  2861    	LD	BC,4
04146F AF                  A  2862    	XOR	A,A
041470 CD BD 48 04         A  2863    	CALL	__lmulu
041474 01FF0100            A  2864    	LD	BC,511
041478 AF                  A  2865    	XOR	A,A
041479 CD B4 48 04         A  2866    	CALL	__land
04147D E5C1                A  2867    	LD	BC,HL
04147F DD31FD              A  2868    	LD	IY,(IX+%FFFFFFFD)
041482 ED232E              A  2869    	LEA	HL,IY+%2E
041485 09                  A  2870    	ADD	HL,BC
041486 E5                  A  2871    	PUSH	HL
041487 CD 61 0F 04         A  2872    	CALL	_ld_dword
04148B C1                  A  2873    	POP	BC
04148C 01FFFFFF            A  2874    	LD	BC,16777215
041490 3E0F                A  2875    	LD	A,%F
041492 CD B4 48 04         A  2876    	CALL	__land
041496 DD2FF6              A  2877    	LD	(IX+%FFFFFFF6),HL
041499 DD73F9              A  2878    	LD	(IX+%FFFFFFF9),E
                           A  2879    ; 1165				break;
                           A  2880    .LINE 1165
                           A  2881    
04149C 18 0B               A  2882    	JR	L_58
                           A  2883    ; 1166	#if FF_FS_EXFAT
                           A  2884    ; 1167			case FS_EXFAT :
                           A  2885    ; 1168				if ((obj->objsize != 0 && o
                           A  2886    ; 1169					DWORD cofs = clst - obj
                           A  2887    ; 1170					DWORD clen = (DWORD)((L
                           A  2888    ; 1171	
                           A  2889    ; 1172					if (obj->stat == 2 && c
                           A  2890    ; 1173						val = (cofs == clen
                           A  2891    ; 1174						break;
                           A  2892    ; 1175					}
                           A  2893    ; 1176					if (obj->stat == 3 && c
                           A  2894    ; 1177						val = clst + 1; 	
                           A  2895    ; 1178						break;
                           A  2896    ; 1179					}
                           A  2897    ; 1180					if (obj->stat != 2) {	
                           A  2898    ; 1181						if (obj->n_frag != 
                           A  2899    ; 1182							val = 0x7FFFFFF
                           A  2900    ; 1183						} else {
                           A  2901    ; 1184							if (move_window
                           A  2902    ; 1185							val = ld_dword(
                           A  2903    ; 1186						}
                           A  2904    ; 1187						break;
                           A  2905    ; 1188					}
                           A  2906    ; 1189				}
                           A  2907    ; 1190				val = 1;	/* Internal err
                           A  2908    ; 1191				break;
                           A  2909    ; 1192	#endif
                           A  2910    ; 1193			default:
04149E                     A  2911    L_55:
                           A  2912    .LINE 1193
                           A  2913    
                           A  2914    ; 1194				val = 1;	/* Internal err
                           A  2915    .LINE 1194
                           A  2916    
04149E 01010000            A  2917    	LD	BC,1
0414A2 AF                  A  2918    	XOR	A,A
0414A3 DD0FF6              A  2919    	LD	(IX+%FFFFFFF6),BC
0414A6 DD77F9              A  2920    	LD	(IX+%FFFFFFF9),A
                           A  2921    ; 1195			}
                           A  2922    ; 1196		}
0414A9                     A  2923    L_58:
                           A  2924    .LINE 1196
                           A  2925    
                           A  2926    ; 1197	
                           A  2927    ; 1198		return val;
                           A  2928    .LINE 1198
                           A  2929    
0414A9 DD27F6              A  2930    	LD	HL,(IX+%FFFFFFF6)
0414AC DD5EF9              A  2931    	LD	E,(IX+%FFFFFFF9)
                           A  2932    ; 1199	}
                           A  2933    .LINE 1199
                           A  2934    
0414AF DDF9                A  2935    	LD	SP,IX
0414B1 DDE1                A  2936    	POP	IX
0414B3 C9                  A  2937    	RET	
                           A  2938    
                           A  2939    
                           A  2940    ;**************************** _get_fat ********
                           A  2941    ;Name                         Addr/Register   S
                           A  2942    ;temp45                               IX-16    
                           A  2943    ;wc                                   IX-13    
                           A  2944    ;val                                  IX-10    
                           A  2945    ;bc                                    IX-6    
                           A  2946    ;fs                                    IX-3    
                           A  2947    ;clst                                  IX+9    
                           A  2948    ;obj                                   IX+6    
                           A  2949    
                           A  2950    
                           A  2951    ; Stack Frame Size: 31 (bytes)
                           A  2952    ;       Spill Code: 0 (instruction)
                           A  2953    
                           A  2954    
                           A  2955    .ENDFUNC "get_fat",1199,"_get_fat"
                           A  2956    ; 1200	
                           A  2957    ; 1201	
                           A  2958    ; 1202	
                           A  2959    ; 1203	
                           A  2960    ; 1204	#if !FF_FS_READONLY
                           A  2961    ; 1205	/*-------------------------------------
                           A  2962    ; 1206	/* FAT access - Change value of an FAT 
                           A  2963    ; 1207	/*-------------------------------------
                           A  2964    ; 1208	
                           A  2965    ; 1209	static FRESULT put_fat (	/* FR_OK(0)
                           A  2966    ; 1210		FATFS* fs,		/* Corresponding fi
                           A  2967    ; 1211		DWORD clst,		/* FAT index number
                           A  2968    ; 1212		DWORD val		/* New value to be 
                           A  2969    ; 1213	)
                           A  2970    ; 1214	{
                           A  2971    ; 1215		UINT bc;
                           A  2972    ; 1216		BYTE *p;
                           A  2973    ; 1217		FRESULT res = FR_INT_ERR;
                           A  2974    ; 1218	
                           A  2975    ; 1219	
                           A  2976    ; 1220		if (clst >= 2 && clst < fs->n_faten
                           A  2977    ; 1221			switch (fs->fs_type) {
                           A  2978    ; 1222			case FS_FAT12:
                           A  2979    ; 1223				bc = (UINT)clst; bc += bc /
                           A  2980    ; 1224				res = move_window(fs, fs->f
                           A  2981    ; 1225				if (res != FR_OK) break;
                           A  2982    ; 1226				p = fs->win + bc++ % SS(fs)
                           A  2983    ; 1227				*p = (clst & 1) ? ((*p & 0x
                           A  2984    ; 1228				fs->wflag = 1;
                           A  2985    ; 1229				res = move_window(fs, fs->f
                           A  2986    ; 1230				if (res != FR_OK) break;
                           A  2987    ; 1231				p = fs->win + bc % SS(fs);
                           A  2988    ; 1232				*p = (clst & 1) ? (BYTE)(va
                           A  2989    ; 1233				fs->wflag = 1;
                           A  2990    ; 1234				break;
                           A  2991    ; 1235	
                           A  2992    ; 1236			case FS_FAT16:
                           A  2993    ; 1237				res = move_window(fs, fs->f
                           A  2994    ; 1238				if (res != FR_OK) break;
                           A  2995    ; 1239				st_word(fs->win + clst * 2 
                           A  2996    ; 1240				fs->wflag = 1;
                           A  2997    ; 1241				break;
                           A  2998    ; 1242	
                           A  2999    ; 1243			case FS_FAT32:
                           A  3000    ; 1244	#if FF_FS_EXFAT
                           A  3001    ; 1245			case FS_EXFAT:
                           A  3002    ; 1246	#endif
                           A  3003    ; 1247				res = move_window(fs, fs->f
                           A  3004    ; 1248				if (res != FR_OK) break;
                           A  3005    ; 1249				if (!FF_FS_EXFAT || fs->fs_
                           A  3006    ; 1250					val = (val & 0x0FFFFFFF
                           A  3007    ; 1251				}
                           A  3008    ; 1252				st_dword(fs->win + clst * 4
                           A  3009    ; 1253				fs->wflag = 1;
                           A  3010    ; 1254				break;
                           A  3011    ; 1255			}
                           A  3012    ; 1256		}
                           A  3013    ; 1257		return res;
                           A  3014    ; 1258	}
                           A  3015    ; 1259	
                           A  3016    ; 1260	#endif /* !FF_FS_READONLY */
                           A  3017    ; 1261	
                           A  3018    ; 1262	
                           A  3019    ; 1263	
                           A  3020    ; 1264	
                           A  3021    ; 1265	#if FF_FS_EXFAT && !FF_FS_READONLY
                           A  3022    ; 1266	/*-------------------------------------
                           A  3023    ; 1267	/* exFAT: Accessing FAT and Allocation 
                           A  3024    ; 1268	/*-------------------------------------
                           A  3025    ; 1269	
                           A  3026    ; 1270	/*-------------------------------------
                           A  3027    ; 1271	/* Find a contiguous free cluster block
                           A  3028    ; 1272	/*-------------------------------------
                           A  3029    ; 1273	
                           A  3030    ; 1274	static DWORD find_bitmap (	/* 0:Not fo
                           A  3031    ; 1275		FATFS* fs,	/* Filesystem object */
                           A  3032    ; 1276		DWORD clst,	/* Cluster number to sc
                           A  3033    ; 1277		DWORD ncl	/* Number of contiguous
                           A  3034    ; 1278	)
                           A  3035    ; 1279	{
                           A  3036    ; 1280		BYTE bm, bv;
                           A  3037    ; 1281		UINT i;
                           A  3038    ; 1282		DWORD val, scl, ctr;
                           A  3039    ; 1283	
                           A  3040    ; 1284	
                           A  3041    ; 1285		clst -= 2;	/* The first bit in the
                           A  3042    ; 1286		if (clst >= fs->n_fatent - 2) clst 
                           A  3043    ; 1287		scl = val = clst; ctr = 0;
                           A  3044    ; 1288		for (;;) {
                           A  3045    ; 1289			if (move_window(fs, fs->bitbase
                           A  3046    ; 1290			i = val / 8 % SS(fs); bm = 1 <<
                           A  3047    ; 1291			do {
                           A  3048    ; 1292				do {
                           A  3049    ; 1293					bv = fs->win[i] & bm; b
                           A  3050    ; 1294					if (++val >= fs->n_fate
                           A  3051    ; 1295						val = 0; bm = 0; i 
                           A  3052    ; 1296					}
                           A  3053    ; 1297					if (bv == 0) {	/* Is i
                           A  3054    ; 1298						if (++ctr == ncl) r
                           A  3055    ; 1299					} else {
                           A  3056    ; 1300						scl = val; ctr = 0;
                           A  3057    ; 1301					}
                           A  3058    ; 1302					if (val == clst) return
                           A  3059    ; 1303				} while (bm != 0);
                           A  3060    ; 1304				bm = 1;
                           A  3061    ; 1305			} while (++i < SS(fs));
                           A  3062    ; 1306		}
                           A  3063    ; 1307	}
                           A  3064    ; 1308	
                           A  3065    ; 1309	
                           A  3066    ; 1310	/*-------------------------------------
                           A  3067    ; 1311	/* Set/Clear a block of allocation bitm
                           A  3068    ; 1312	/*-------------------------------------
                           A  3069    ; 1313	
                           A  3070    ; 1314	static FRESULT change_bitmap (
                           A  3071    ; 1315		FATFS* fs,	/* Filesystem object */
                           A  3072    ; 1316		DWORD clst,	/* Cluster number to ch
                           A  3073    ; 1317		DWORD ncl,	/* Number of clusters t
                           A  3074    ; 1318		int bv		/* bit value to be set 
                           A  3075    ; 1319	)
                           A  3076    ; 1320	{
                           A  3077    ; 1321		BYTE bm;
                           A  3078    ; 1322		UINT i;
                           A  3079    ; 1323		LBA_t sect;
                           A  3080    ; 1324	
                           A  3081    ; 1325	
                           A  3082    ; 1326		clst -= 2;	/* The first bit corres
                           A  3083    ; 1327		sect = fs->bitbase + clst / 8 / SS(
                           A  3084    ; 1328		i = clst / 8 % SS(fs);				
                           A  3085    ; 1329		bm = 1 << (clst % 8);				
                           A  3086    ; 1330		for (;;) {
                           A  3087    ; 1331			if (move_window(fs, sect++) != 
                           A  3088    ; 1332			do {
                           A  3089    ; 1333				do {
                           A  3090    ; 1334					if (bv == (int)((fs->wi
                           A  3091    ; 1335					fs->win[i] ^= bm;	/* 
                           A  3092    ; 1336					fs->wflag = 1;
                           A  3093    ; 1337					if (--ncl == 0) return 
                           A  3094    ; 1338				} while (bm <<= 1);		/* 
                           A  3095    ; 1339				bm = 1;
                           A  3096    ; 1340			} while (++i < SS(fs));		/* 
                           A  3097    ; 1341			i = 0;
                           A  3098    ; 1342		}
                           A  3099    ; 1343	}
                           A  3100    ; 1344	
                           A  3101    ; 1345	
                           A  3102    ; 1346	/*-------------------------------------
                           A  3103    ; 1347	/* Fill the first fragment of the FAT c
                           A  3104    ; 1348	/*-------------------------------------
                           A  3105    ; 1349	
                           A  3106    ; 1350	static FRESULT fill_first_frag (
                           A  3107    ; 1351		FFOBJID* obj	/* Pointer to the c
                           A  3108    ; 1352	)
                           A  3109    ; 1353	{
                           A  3110    ; 1354		FRESULT res;
                           A  3111    ; 1355		DWORD cl, n;
                           A  3112    ; 1356	
                           A  3113    ; 1357	
                           A  3114    ; 1358		if (obj->stat == 3) {	/* Has the 
                           A  3115    ; 1359			for (cl = obj->sclust, n = obj-
                           A  3116    ; 1360				res = put_fat(obj->fs, cl, 
                           A  3117    ; 1361				if (res != FR_OK) return re
                           A  3118    ; 1362			}
                           A  3119    ; 1363			obj->stat = 0;	/* Change statu
                           A  3120    ; 1364		}
                           A  3121    ; 1365		return FR_OK;
                           A  3122    ; 1366	}
                           A  3123    ; 1367	
                           A  3124    ; 1368	
                           A  3125    ; 1369	/*-------------------------------------
                           A  3126    ; 1370	/* Fill the last fragment of the FAT ch
                           A  3127    ; 1371	/*-------------------------------------
                           A  3128    ; 1372	
                           A  3129    ; 1373	static FRESULT fill_last_frag (
                           A  3130    ; 1374		FFOBJID* obj,	/* Pointer to the c
                           A  3131    ; 1375		DWORD lcl,		/* Last cluster of 
                           A  3132    ; 1376		DWORD term		/* Value to set the
                           A  3133    ; 1377	)
                           A  3134    ; 1378	{
                           A  3135    ; 1379		FRESULT res;
                           A  3136    ; 1380	
                           A  3137    ; 1381	
                           A  3138    ; 1382		while (obj->n_frag > 0) {	/* Crea
                           A  3139    ; 1383			res = put_fat(obj->fs, lcl - ob
                           A  3140    ; 1384			if (res != FR_OK) return res;
                           A  3141    ; 1385			obj->n_frag--;
                           A  3142    ; 1386		}
                           A  3143    ; 1387		return FR_OK;
                           A  3144    ; 1388	}
                           A  3145    ; 1389	
                           A  3146    ; 1390	#endif	/* FF_FS_EXFAT && !FF_FS_READON
                           A  3147    ; 1391	
                           A  3148    ; 1392	
                           A  3149    ; 1393	
                           A  3150    ; 1394	#if !FF_FS_READONLY
                           A  3151    ; 1395	/*-------------------------------------
                           A  3152    ; 1396	/* FAT handling - Remove a cluster chai
                           A  3153    ; 1397	/*-------------------------------------
                           A  3154    ; 1398	
                           A  3155    ; 1399	static FRESULT remove_chain (	/* FR_O
                           A  3156    ; 1400		FFOBJID* obj,		/* Correspondin
                           A  3157    ; 1401		DWORD clst,			/* Cluster to r
                           A  3158    ; 1402		DWORD pclst			/* Previous clu
                           A  3159    ; 1403	)
                           A  3160    ; 1404	{
                           A  3161    ; 1405		FRESULT res = FR_OK;
                           A  3162    ; 1406		DWORD nxt;
                           A  3163    ; 1407		FATFS *fs = obj->fs;
                           A  3164    ; 1408	#if FF_FS_EXFAT || FF_USE_TRIM
                           A  3165    ; 1409		DWORD scl = clst, ecl = clst;
                           A  3166    ; 1410	#endif
                           A  3167    ; 1411	#if FF_USE_TRIM
                           A  3168    ; 1412		LBA_t rt[2];
                           A  3169    ; 1413	#endif
                           A  3170    ; 1414	
                           A  3171    ; 1415		if (clst < 2 || clst >= fs->n_faten
                           A  3172    ; 1416	
                           A  3173    ; 1417		/* Mark the previous cluster 'EOC' 
                           A  3174    ; 1418		if (pclst != 0 && (!FF_FS_EXFAT || 
                           A  3175    ; 1419			res = put_fat(fs, pclst, 0xFFFF
                           A  3176    ; 1420			if (res != FR_OK) return res;
                           A  3177    ; 1421		}
                           A  3178    ; 1422	
                           A  3179    ; 1423		/* Remove the chain */
                           A  3180    ; 1424		do {
                           A  3181    ; 1425			nxt = get_fat(obj, clst);		
                           A  3182    ; 1426			if (nxt == 0) break;			
                           A  3183    ; 1427			if (nxt == 1) return FR_INT_ERR
                           A  3184    ; 1428			if (nxt == 0xFFFFFFFF) return F
                           A  3185    ; 1429			if (!FF_FS_EXFAT || fs->fs_type
                           A  3186    ; 1430				res = put_fat(fs, clst, 0);
                           A  3187    ; 1431				if (res != FR_OK) return re
                           A  3188    ; 1432			}
                           A  3189    ; 1433			if (fs->free_clst < fs->n_faten
                           A  3190    ; 1434				fs->free_clst++;
                           A  3191    ; 1435				fs->fsi_flag |= 1;
                           A  3192    ; 1436			}
                           A  3193    ; 1437	#if FF_FS_EXFAT || FF_USE_TRIM
                           A  3194    ; 1438			if (ecl + 1 == nxt) {	/* Is n
                           A  3195    ; 1439				ecl = nxt;
                           A  3196    ; 1440			} else {				/* End 
                           A  3197    ; 1441	#if FF_FS_EXFAT
                           A  3198    ; 1442				if (fs->fs_type == FS_EXFAT
                           A  3199    ; 1443					res = change_bitmap(fs,
                           A  3200    ; 1444					if (res != FR_OK) retur
                           A  3201    ; 1445				}
                           A  3202    ; 1446	#endif
                           A  3203    ; 1447	#if FF_USE_TRIM
                           A  3204    ; 1448				rt[0] = clst2sect(fs, scl);
                           A  3205    ; 1449				rt[1] = clst2sect(fs, ecl) 
                           A  3206    ; 1450				disk_ioctl(fs->pdrv, CTRL_T
                           A  3207    ; 1451	#endif
                           A  3208    ; 1452				scl = ecl = nxt;
                           A  3209    ; 1453			}
                           A  3210    ; 1454	#endif
                           A  3211    ; 1455			clst = nxt;					/* 
                           A  3212    ; 1456		} while (clst < fs->n_fatent);	/* 
                           A  3213    ; 1457	
                           A  3214    ; 1458	#if FF_FS_EXFAT
                           A  3215    ; 1459		/* Some post processes for chain st
                           A  3216    ; 1460		if (fs->fs_type == FS_EXFAT) {
                           A  3217    ; 1461			if (pclst == 0) {	/* Has the 
                           A  3218    ; 1462				obj->stat = 0;		/* Chan
                           A  3219    ; 1463			} else {
                           A  3220    ; 1464				if (obj->stat == 0) {	/* 
                           A  3221    ; 1465					clst = obj->sclust;		
                           A  3222    ; 1466					while (clst != pclst) {
                           A  3223    ; 1467						nxt = get_fat(obj, 
                           A  3224    ; 1468						if (nxt < 2) return
                           A  3225    ; 1469						if (nxt == 0xFFFFFF
                           A  3226    ; 1470						if (nxt != clst + 1
                           A  3227    ; 1471						clst++;
                           A  3228    ; 1472					}
                           A  3229    ; 1473					if (clst == pclst) {	
                           A  3230    ; 1474						obj->stat = 2;		
                           A  3231    ; 1475					}
                           A  3232    ; 1476				} else {
                           A  3233    ; 1477					if (obj->stat == 3 && p
                           A  3234    ; 1478						obj->stat = 2;	/* 
                           A  3235    ; 1479					}
                           A  3236    ; 1480				}
                           A  3237    ; 1481			}
                           A  3238    ; 1482		}
                           A  3239    ; 1483	#endif
                           A  3240    ; 1484		return FR_OK;
                           A  3241    ; 1485	}
                           A  3242    ; 1486	
                           A  3243    ; 1487	
                           A  3244    ; 1488	
                           A  3245    ; 1489	
                           A  3246    ; 1490	/*-------------------------------------
                           A  3247    ; 1491	/* FAT handling - Stretch a chain or Cr
                           A  3248    ; 1492	/*-------------------------------------
                           A  3249    ; 1493	
                           A  3250    ; 1494	static DWORD create_chain (	/* 0:No fre
                           A  3251    ; 1495		FFOBJID* obj,		/* Correspondin
                           A  3252    ; 1496		DWORD clst			/* Cluster# to 
                           A  3253    ; 1497	)
                           A  3254    ; 1498	{
                           A  3255    ; 1499		DWORD cs, ncl, scl;
                           A  3256    ; 1500		FRESULT res;
                           A  3257    ; 1501		FATFS *fs = obj->fs;
                           A  3258    ; 1502	
                           A  3259    ; 1503	
                           A  3260    ; 1504		if (clst == 0) {	/* Create a new
                           A  3261    ; 1505			scl = fs->last_clst;			
                           A  3262    ; 1506			if (scl == 0 || scl >= fs->n_fa
                           A  3263    ; 1507		}
                           A  3264    ; 1508		else {				/* Stretch a ch
                           A  3265    ; 1509			cs = get_fat(obj, clst);		
                           A  3266    ; 1510			if (cs < 2) return 1;			
                           A  3267    ; 1511			if (cs == 0xFFFFFFFF) return cs
                           A  3268    ; 1512			if (cs < fs->n_fatent) return c
                           A  3269    ; 1513			scl = clst;						
                           A  3270    ; 1514		}
                           A  3271    ; 1515		if (fs->free_clst == 0) return 0;	
                           A  3272    ; 1516	
                           A  3273    ; 1517	#if FF_FS_EXFAT
                           A  3274    ; 1518		if (fs->fs_type == FS_EXFAT) {	/* 
                           A  3275    ; 1519			ncl = find_bitmap(fs, scl, 1);	
                           A  3276    ; 1520			if (ncl == 0 || ncl == 0xFFFFFF
                           A  3277    ; 1521			res = change_bitmap(fs, ncl, 1,
                           A  3278    ; 1522			if (res == FR_INT_ERR) return 1
                           A  3279    ; 1523			if (res == FR_DISK_ERR) return 
                           A  3280    ; 1524			if (clst == 0) {				
                           A  3281    ; 1525				obj->stat = 2;				
                           A  3282    ; 1526			} else {						
                           A  3283    ; 1527				if (obj->stat == 2 && ncl !
                           A  3284    ; 1528					obj->n_cont = scl - obj
                           A  3285    ; 1529					obj->stat = 3;			
                           A  3286    ; 1530				}
                           A  3287    ; 1531			}
                           A  3288    ; 1532			if (obj->stat != 2) {	/* Is t
                           A  3289    ; 1533				if (ncl == clst + 1) {	/* 
                           A  3290    ; 1534					obj->n_frag = obj->n_fr
                           A  3291    ; 1535				} else {				/* 
                           A  3292    ; 1536					if (obj->n_frag == 0) o
                           A  3293    ; 1537					res = fill_last_frag(ob
                           A  3294    ; 1538					if (res == FR_OK) obj->
                           A  3295    ; 1539				}
                           A  3296    ; 1540			}
                           A  3297    ; 1541		} else
                           A  3298    ; 1542	#endif
                           A  3299    ; 1543		{	/* On the FAT/FAT32 volume */
                           A  3300    ; 1544			ncl = 0;
                           A  3301    ; 1545			if (scl == clst) {				
                           A  3302    ; 1546				ncl = scl + 1;				
                           A  3303    ; 1547				if (ncl >= fs->n_fatent) nc
                           A  3304    ; 1548				cs = get_fat(obj, ncl);		
                           A  3305    ; 1549				if (cs == 1 || cs == 0xFFFF
                           A  3306    ; 1550				if (cs != 0) {				
                           A  3307    ; 1551					cs = fs->last_clst;		
                           A  3308    ; 1552					if (cs >= 2 && cs < fs-
                           A  3309    ; 1553					ncl = 0;
                           A  3310    ; 1554				}
                           A  3311    ; 1555			}
                           A  3312    ; 1556			if (ncl == 0) {	/* The new clus
                           A  3313    ; 1557				ncl = scl;	/* Start cluste
                           A  3314    ; 1558				for (;;) {
                           A  3315    ; 1559					ncl++;					
                           A  3316    ; 1560					if (ncl >= fs->n_fatent
                           A  3317    ; 1561						ncl = 2;
                           A  3318    ; 1562						if (ncl > scl) retu
                           A  3319    ; 1563					}
                           A  3320    ; 1564					cs = get_fat(obj, ncl);
                           A  3321    ; 1565					if (cs == 0) break;		
                           A  3322    ; 1566					if (cs == 1 || cs == 0x
                           A  3323    ; 1567					if (ncl == scl) return 
                           A  3324    ; 1568				}
                           A  3325    ; 1569			}
                           A  3326    ; 1570			res = put_fat(fs, ncl, 0xFFFFFF
                           A  3327    ; 1571			if (res == FR_OK && clst != 0) 
                           A  3328    ; 1572				res = put_fat(fs, clst, ncl
                           A  3329    ; 1573			}
                           A  3330    ; 1574		}
                           A  3331    ; 1575	
                           A  3332    ; 1576		if (res == FR_OK) {			/* Upda
                           A  3333    ; 1577			fs->last_clst = ncl;
                           A  3334    ; 1578			if (fs->free_clst <= fs->n_fate
                           A  3335    ; 1579			fs->fsi_flag |= 1;
                           A  3336    ; 1580		} else {
                           A  3337    ; 1581			ncl = (res == FR_DISK_ERR) ? 0x
                           A  3338    ; 1582		}
                           A  3339    ; 1583	
                           A  3340    ; 1584		return ncl;		/* Return new clust
                           A  3341    ; 1585	}
                           A  3342    ; 1586	
                           A  3343    ; 1587	#endif /* !FF_FS_READONLY */
                           A  3344    ; 1588	
                           A  3345    ; 1589	
                           A  3346    ; 1590	
                           A  3347    ; 1591	
                           A  3348    ; 1592	#if FF_USE_FASTSEEK
                           A  3349    ; 1593	/*-------------------------------------
                           A  3350    ; 1594	/* FAT handling - Convert offset into c
                           A  3351    ; 1595	/*-------------------------------------
                           A  3352    ; 1596	
                           A  3353    ; 1597	static DWORD clmt_clust (	/* <2:Error
                           A  3354    ; 1598		FIL* fp,		/* Pointer to the f
                           A  3355    ; 1599		FSIZE_t ofs		/* File offset to b
                           A  3356    ; 1600	)
                           A  3357    ; 1601	{
                           A  3358    ; 1602		DWORD cl, ncl, *tbl;
                           A  3359    ; 1603		FATFS *fs = fp->obj.fs;
                           A  3360    ; 1604	
                           A  3361    ; 1605	
                           A  3362    ; 1606		tbl = fp->cltbl + 1;	/* Top of C
                           A  3363    ; 1607		cl = (DWORD)(ofs / SS(fs) / fs->csi
                           A  3364    ; 1608		for (;;) {
                           A  3365    ; 1609			ncl = *tbl++;			/* Numb
                           A  3366    ; 1610			if (ncl == 0) return 0;	/* End 
                           A  3367    ; 1611			if (cl < ncl) break;	/* In t
                           A  3368    ; 1612			cl -= ncl; tbl++;		/* Next
                           A  3369    ; 1613		}
                           A  3370    ; 1614		return cl + *tbl;	/* Return the c
                           A  3371    ; 1615	}
                           A  3372    ; 1616	
                           A  3373    ; 1617	#endif	/* FF_USE_FASTSEEK */
                           A  3374    ; 1618	
                           A  3375    ; 1619	
                           A  3376    ; 1620	
                           A  3377    ; 1621	
                           A  3378    ; 1622	/*-------------------------------------
                           A  3379    ; 1623	/* Directory handling - Fill a cluster 
                           A  3380    ; 1624	/*-------------------------------------
                           A  3381    ; 1625	
                           A  3382    ; 1626	#if !FF_FS_READONLY
                           A  3383    ; 1627	static FRESULT dir_clear (	/* Returns 
                           A  3384    ; 1628		FATFS *fs,		/* Filesystem objec
                           A  3385    ; 1629		DWORD clst		/* Directory table 
                           A  3386    ; 1630	)
                           A  3387    ; 1631	{
                           A  3388    ; 1632		LBA_t sect;
                           A  3389    ; 1633		UINT n, szb;
                           A  3390    ; 1634		BYTE *ibuf;
                           A  3391    ; 1635	
                           A  3392    ; 1636	
                           A  3393    ; 1637		if (sync_window(fs) != FR_OK) retur
                           A  3394    ; 1638		sect = clst2sect(fs, clst);		/* 
                           A  3395    ; 1639		fs->winsect = sect;				/* 
                           A  3396    ; 1640		memset(fs->win, 0, sizeof fs->win);
                           A  3397    ; 1641	#if FF_USE_LFN == 3		/* Quick table 
                           A  3398    ; 1642		/* Allocate a temporary buffer */
                           A  3399    ; 1643		for (szb = ((DWORD)fs->csize * SS(f
                           A  3400    ; 1644		if (szb > SS(fs)) {		/* Buffer a
                           A  3401    ; 1645			memset(ibuf, 0, szb);
                           A  3402    ; 1646			szb /= SS(fs);		/* Bytes ->
                           A  3403    ; 1647			for (n = 0; n < fs->csize && di
                           A  3404    ; 1648			ff_memfree(ibuf);
                           A  3405    ; 1649		} else
                           A  3406    ; 1650	#endif
                           A  3407    ; 1651		{
                           A  3408    ; 1652			ibuf = fs->win; szb = 1;	/* 
                           A  3409    ; 1653			for (n = 0; n < fs->csize && di
                           A  3410    ; 1654		}
                           A  3411    ; 1655		return (n == fs->csize) ? FR_OK : F
                           A  3412    ; 1656	}
                           A  3413    ; 1657	#endif	/* !FF_FS_READONLY */
                           A  3414    ; 1658	
                           A  3415    ; 1659	
                           A  3416    ; 1660	
                           A  3417    ; 1661	
                           A  3418    ; 1662	/*-------------------------------------
                           A  3419    ; 1663	/* Directory handling - Set directory i
                           A  3420    ; 1664	/*-------------------------------------
                           A  3421    ; 1665	
                           A  3422    ; 1666	static FRESULT dir_sdi (	/* FR_OK(0)
                           A  3423    ; 1667		DIR* dp,		/* Pointer to direc
                           A  3424    ; 1668		DWORD ofs		/* Offset of direct
                           A  3425    ; 1669	)
                           A  3426    ; 1670	{
0414B4                     A  3427    _dir_sdi:
                           A  3428    .DEFINE "_dir_sdi"
                           A  3429    
                           A  3430    .VALUE _dir_sdi
                           A  3431    
                           A  3432    .CLASS 3
                           A  3433    
                           A  3434    .TYPE 68
                           A  3435    
                           A  3436    .ENDEF
                           A  3437    
                           A  3438    .BEGFUNC "dir_sdi",1670,"_dir_sdi"
                           A  3439    
                           A  3440    .LINE 1670
                           A  3441    
                           A  3442    .DEFINE "dp"
                           A  3443    
                           A  3444    .CLASS 65
                           A  3445    
                           A  3446    .VALUE 6
                           A  3447    
                           A  3448    .TAG "NONAME3"
                           A  3449    
                           A  3450    .TYPE 40
                           A  3451    
                           A  3452    .ENDEF
                           A  3453    
                           A  3454    .DEFINE "ofs"
                           A  3455    
                           A  3456    .CLASS 65
                           A  3457    
                           A  3458    .VALUE 9
                           A  3459    
                           A  3460    .TYPE 15
                           A  3461    
                           A  3462    .ENDEF
                           A  3463    
                           A  3464    .DEFINE "clst"
                           A  3465    
                           A  3466    .CLASS 65
                           A  3467    
                           A  3468    .VALUE -4
                           A  3469    
                           A  3470    .TYPE 15
                           A  3471    
                           A  3472    .ENDEF
                           A  3473    
                           A  3474    .DEFINE "fs"
                           A  3475    
                           A  3476    .CLASS 65
                           A  3477    
                           A  3478    .VALUE -7
                           A  3479    
                           A  3480    .TAG "NONAME0"
                           A  3481    
                           A  3482    .TYPE 40
                           A  3483    
                           A  3484    .ENDEF
                           A  3485    
                           A  3486    .DEFINE "csz"
                           A  3487    
                           A  3488    .CLASS 65
                           A  3489    
                           A  3490    .VALUE -11
                           A  3491    
                           A  3492    .TYPE 15
                           A  3493    
                           A  3494    .ENDEF
                           A  3495    
0414B4 DDE5                A  3496    	PUSH	IX
0414B6 DD210000 00         A  3497    	LD	IX,0
0414BB DD39                A  3498    	ADD	IX,SP
0414BD ED22F0              A  3499    	LEA	HL,IX+%FFFFFFF0
0414C0 F9                  A  3500    	LD	SP,HL
                           A  3501    ; 1671		DWORD csz, clst;
                           A  3502    ; 1672		FATFS *fs = dp->obj.fs;
                           A  3503    .LINE 1672
                           A  3504    
0414C1 DD3106              A  3505    	LD	IY,(IX+%6)
0414C4 FD0700              A  3506    	LD	BC,(IY+%0)
0414C7 DD0FF9              A  3507    	LD	(IX+%FFFFFFF9),BC
                           A  3508    ; 1673	
                           A  3509    ; 1674	
                           A  3510    ; 1675		if (ofs >= (DWORD)((FF_FS_EXFAT && 
                           A  3511    .LINE 1675
                           A  3512    
0414CA DD2709              A  3513    	LD	HL,(IX+%9)
0414CD DD5E0C              A  3514    	LD	E,(IX+%C)
0414D0 01000020            A  3515    	LD	BC,2097152
0414D4 AF                  A  3516    	XOR	A,A
0414D5 CD 88 47 04         A  3517    	CALL	__lcmpu
0414D9 30 10               A  3518    	JR	NC,L_61
0414DB DD7E09              A  3519    	LD	A,(IX+%9)
0414DE E61F                A  3520    	AND	A,%1F
0414E0 B7ED62              A  3521    	UEXT	HL
0414E3 6F                  A  3522    	LD	L,A
0414E4 5C                  A  3523    	LD	E,H
0414E5 CD B8 45 04         A  3524    	CALL	__lcmpzero
0414E9 28 08               A  3525    	JR	Z,L_62
0414EB                     A  3526    L_61:
                           A  3527    ; 1676			return FR_INT_ERR;
                           A  3528    .LINE 1676
                           A  3529    
0414EB 21020000            A  3530    	LD	HL,2
0414EF C3 B5 16 04         A  3531    	JR	L_82
                           A  3532    ; 1677		}
0414F3                     A  3533    L_62:
                           A  3534    .LINE 1677
                           A  3535    
                           A  3536    ; 1678		dp->dptr = ofs;				/* Set 
                           A  3537    .LINE 1678
                           A  3538    
0414F3 DD0709              A  3539    	LD	BC,(IX+%9)
0414F6 DD7E0C              A  3540    	LD	A,(IX+%C)
0414F9 DD3106              A  3541    	LD	IY,(IX+%6)
0414FC FD0F0F              A  3542    	LD	(IY+%F),BC
0414FF FD7712              A  3543    	LD	(IY+%12),A
                           A  3544    ; 1679		clst = dp->obj.sclust;		/* Tabl
                           A  3545    .LINE 1679
                           A  3546    
041502 FD0707              A  3547    	LD	BC,(IY+%7)
041505 FD7E0A              A  3548    	LD	A,(IY+%A)
041508 DD0FFC              A  3549    	LD	(IX+%FFFFFFFC),BC
04150B DD77FF              A  3550    	LD	(IX+%FFFFFFFF),A
                           A  3551    ; 1680		if (clst == 0 && fs->fs_type >= FS_
                           A  3552    .LINE 1680
                           A  3553    
04150E C5E1                A  3554    	LD	HL,BC
041510 DD5EFF              A  3555    	LD	E,(IX+%FFFFFFFF)
041513 CD B8 45 04         A  3556    	CALL	__lcmpzero
041517 20 19               A  3557    	JR	NZ,L_78
041519 DD31F9              A  3558    	LD	IY,(IX+%FFFFFFF9)
04151C FD7E00              A  3559    	LD	A,(IY+%0)
04151F FE03                A  3560    	CP	A,%3
041521 38 0F               A  3561    	JR	C,L_78
                           A  3562    ; 1681			clst = (DWORD)fs->dirbase;
                           A  3563    .LINE 1681
                           A  3564    
041523 DD31F9              A  3565    	LD	IY,(IX+%FFFFFFF9)
041526 FD0722              A  3566    	LD	BC,(IY+%22)
041529 FD7E25              A  3567    	LD	A,(IY+%25)
04152C DD0FFC              A  3568    	LD	(IX+%FFFFFFFC),BC
04152F DD77FF              A  3569    	LD	(IX+%FFFFFFFF),A
                           A  3570    ; 1682			if (FF_FS_EXFAT) dp->obj.stat =
                           A  3571    ; 1683		}
041532                     A  3572    L_78:
                           A  3573    .LINE 1683
                           A  3574    
                           A  3575    ; 1684	
                           A  3576    ; 1685		if (clst == 0) {	/* Static table
                           A  3577    .LINE 1685
                           A  3578    
041532 DD27FC              A  3579    	LD	HL,(IX+%FFFFFFFC)
041535 DD5EFF              A  3580    	LD	E,(IX+%FFFFFFFF)
041538 CD B8 45 04         A  3581    	CALL	__lcmpzero
04153C 20 4C               A  3582    	JR	NZ,L_77
                           A  3583    ; 1686			if (ofs / SZDIRE >= fs->n_rootd
                           A  3584    .LINE 1686
                           A  3585    
04153E DD31F9              A  3586    	LD	IY,(IX+%FFFFFFF9)
041541 FD0707              A  3587    	LD	BC,(IY+%7)
041544 CD 73 45 04         A  3588    	CALL	__stoiu
041548 DD2FF2              A  3589    	LD	(IX+%FFFFFFF2),HL
04154B 0600                A  3590    	LD	B,%0
04154D DD70F0              A  3591    	LD	(IX+%FFFFFFF0),B	; spill
041550 DD0709              A  3592    	LD	BC,(IX+%9)
041553 DD7E0C              A  3593    	LD	A,(IX+%C)
041556 2E05                A  3594    	LD	L,%5
041558 CD 87 46 04         A  3595    	CALL	__lshru
04155C 5F                  A  3596    	LD	E,A
04155D C5E1                A  3597    	LD	HL,BC
04155F DD46F0              A  3598    	LD	B,(IX+%FFFFFFF0)	; unspill
041562 78                  A  3599    	LD	A,B
041563 DD07F2              A  3600    	LD	BC,(IX+%FFFFFFF2)
041566 CD 88 47 04         A  3601    	CALL	__lcmpu
04156A 38 08               A  3602    	JR	C,L_67
04156C 21020000            A  3603    	LD	HL,2
041570 C3 B5 16 04         A  3604    	JR	L_82
041574                     A  3605    L_67:
                           A  3606    ; 1687			dp->sect = fs->dirbase;
                           A  3607    .LINE 1687
                           A  3608    
041574 DD31F9              A  3609    	LD	IY,(IX+%FFFFFFF9)
041577 FD0722              A  3610    	LD	BC,(IY+%22)
04157A FD7E25              A  3611    	LD	A,(IY+%25)
04157D DD3106              A  3612    	LD	IY,(IX+%6)
041580 FD0F17              A  3613    	LD	(IY+%17),BC
041583 FD771A              A  3614    	LD	(IY+%1A),A
                           A  3615    ; 1688	
                           A  3616    ; 1689		} else {			/* Dynamic tabl
                           A  3617    .LINE 1689
                           A  3618    
041586 C3 54 16 04         A  3619    	JR	L_79
04158A                     A  3620    L_77:
                           A  3621    ; 1690			csz = (DWORD)fs->csize * SS(fs)
                           A  3622    .LINE 1690
                           A  3623    
04158A DD31F9              A  3624    	LD	IY,(IX+%FFFFFFF9)
04158D FD0709              A  3625    	LD	BC,(IY+%9)
041590 CD 73 45 04         A  3626    	CALL	__stoiu
041594 1E00                A  3627    	LD	E,%0
041596 01000200            A  3628    	LD	BC,512
04159A AF                  A  3629    	XOR	A,A
04159B CD BD 48 04         A  3630    	CALL	__lmulu
04159F DD2FF5              A  3631    	LD	(IX+%FFFFFFF5),HL
0415A2 DD73F8              A  3632    	LD	(IX+%FFFFFFF8),E
                           A  3633    ; 1691			while (ofs >= csz) {			
                           A  3634    .LINE 1691
                           A  3635    
0415A5 18 7B               A  3636    	JR	L_73
0415A7                     A  3637    L_74:
                           A  3638    ; 1692				clst = get_fat(&dp->obj, cl
                           A  3639    .LINE 1692
                           A  3640    
0415A7 DD4EFF              A  3641    	LD	C,(IX+%FFFFFFFF)
0415AA 0600                A  3642    	LD	B,%0
0415AC C5                  A  3643    	PUSH	BC
0415AD DD07FC              A  3644    	LD	BC,(IX+%FFFFFFFC)
0415B0 C5                  A  3645    	PUSH	BC
0415B1 DD3106              A  3646    	LD	IY,(IX+%6)
0415B4 ED6600              A  3647    	PEA	IY+%0
0415B7 CD 67 12 04         A  3648    	CALL	_get_fat
0415BB C1                  A  3649    	POP	BC
0415BC C1                  A  3650    	POP	BC
0415BD C1                  A  3651    	POP	BC
0415BE DD2FFC              A  3652    	LD	(IX+%FFFFFFFC),HL
0415C1 DD73FF              A  3653    	LD	(IX+%FFFFFFFF),E
                           A  3654    ; 1693				if (clst == 0xFFFFFFFF) ret
                           A  3655    .LINE 1693
                           A  3656    
0415C4 DD27FC              A  3657    	LD	HL,(IX+%FFFFFFFC)
0415C7 DD5EFF              A  3658    	LD	E,(IX+%FFFFFFFF)
0415CA 01FFFFFF            A  3659    	LD	BC,16777215
0415CE 3EFF                A  3660    	LD	A,%FF
0415D0 CD 88 47 04         A  3661    	CALL	__lcmpu
0415D4 20 08               A  3662    	JR	NZ,L_71
0415D6 21010000            A  3663    	LD	HL,1
0415DA C3 B5 16 04         A  3664    	JR	L_82
0415DE                     A  3665    L_71:
                           A  3666    ; 1694				if (clst < 2 || clst >= fs-
                           A  3667    .LINE 1694
                           A  3668    
0415DE DD27FC              A  3669    	LD	HL,(IX+%FFFFFFFC)
0415E1 DD5EFF              A  3670    	LD	E,(IX+%FFFFFFFF)
0415E4 01020000            A  3671    	LD	BC,2
0415E8 AF                  A  3672    	XOR	A,A
0415E9 CD 88 47 04         A  3673    	CALL	__lcmpu
0415ED 38 15               A  3674    	JR	C,L_70
0415EF DD27FC              A  3675    	LD	HL,(IX+%FFFFFFFC)
0415F2 DD5EFF              A  3676    	LD	E,(IX+%FFFFFFFF)
0415F5 DD31F9              A  3677    	LD	IY,(IX+%FFFFFFF9)
0415F8 FD0712              A  3678    	LD	BC,(IY+%12)
0415FB FD7E15              A  3679    	LD	A,(IY+%15)
0415FE CD 88 47 04         A  3680    	CALL	__lcmpu
041602 38 08               A  3681    	JR	C,L_72
041604                     A  3682    L_70:
041604 21020000            A  3683    	LD	HL,2
041608 C3 B5 16 04         A  3684    	JR	L_82
04160C                     A  3685    L_72:
                           A  3686    ; 1695				ofs -= csz;
                           A  3687    .LINE 1695
                           A  3688    
04160C DD2709              A  3689    	LD	HL,(IX+%9)
04160F DD5E0C              A  3690    	LD	E,(IX+%C)
041612 DD07F5              A  3691    	LD	BC,(IX+%FFFFFFF5)
041615 DD7EF8              A  3692    	LD	A,(IX+%FFFFFFF8)
041618 CD 7B 46 04         A  3693    	CALL	__lsub
04161C DD2F09              A  3694    	LD	(IX+%9),HL
04161F DD730C              A  3695    	LD	(IX+%C),E
                           A  3696    ; 1696			}
041622                     A  3697    L_73:
                           A  3698    .LINE 1696
                           A  3699    
041622 DD2709              A  3700    	LD	HL,(IX+%9)
041625 DD5E0C              A  3701    	LD	E,(IX+%C)
041628 DD07F5              A  3702    	LD	BC,(IX+%FFFFFFF5)
04162B DD7EF8              A  3703    	LD	A,(IX+%FFFFFFF8)
04162E CD 88 47 04         A  3704    	CALL	__lcmpu
041632 D2 A7 15 04         A  3705    	JR	NC,L_74
                           A  3706    ; 1697			dp->sect = clst2sect(fs, clst);
                           A  3707    .LINE 1697
                           A  3708    
041636 DD4EFF              A  3709    	LD	C,(IX+%FFFFFFFF)
041639 0600                A  3710    	LD	B,%0
04163B C5                  A  3711    	PUSH	BC
04163C DD07FC              A  3712    	LD	BC,(IX+%FFFFFFFC)
04163F C5                  A  3713    	PUSH	BC
041640 DD07F9              A  3714    	LD	BC,(IX+%FFFFFFF9)
041643 C5                  A  3715    	PUSH	BC
041644 CD FC 11 04         A  3716    	CALL	_clst2sect
041648 C1                  A  3717    	POP	BC
041649 C1                  A  3718    	POP	BC
04164A C1                  A  3719    	POP	BC
04164B DD3106              A  3720    	LD	IY,(IX+%6)
04164E FD2F17              A  3721    	LD	(IY+%17),HL
041651 FD731A              A  3722    	LD	(IY+%1A),E
                           A  3723    ; 1698		}
041654                     A  3724    L_79:
                           A  3725    .LINE 1698
                           A  3726    
                           A  3727    ; 1699		dp->clust = clst;					
                           A  3728    .LINE 1699
                           A  3729    
041654 DD07FC              A  3730    	LD	BC,(IX+%FFFFFFFC)
041657 DD7EFF              A  3731    	LD	A,(IX+%FFFFFFFF)
04165A DD3106              A  3732    	LD	IY,(IX+%6)
04165D FD0F13              A  3733    	LD	(IY+%13),BC
041660 FD7716              A  3734    	LD	(IY+%16),A
                           A  3735    ; 1700		if (dp->sect == 0) return FR_INT_ER
                           A  3736    .LINE 1700
                           A  3737    
041663 FD2717              A  3738    	LD	HL,(IY+%17)
041666 FD5E1A              A  3739    	LD	E,(IY+%1A)
041669 CD B8 45 04         A  3740    	CALL	__lcmpzero
04166D 20 06               A  3741    	JR	NZ,L_81
04166F 21020000            A  3742    	LD	HL,2
041673 18 40               A  3743    	JR	L_82
041675                     A  3744    L_81:
                           A  3745    ; 1701		dp->sect += ofs / SS(fs);			
                           A  3746    .LINE 1701
                           A  3747    
041675 DD0709              A  3748    	LD	BC,(IX+%9)
041678 DD7E0C              A  3749    	LD	A,(IX+%C)
04167B 2E09                A  3750    	LD	L,%9
04167D CD 87 46 04         A  3751    	CALL	__lshru
041681 DD3106              A  3752    	LD	IY,(IX+%6)
041684 FD2717              A  3753    	LD	HL,(IY+%17)
041687 FD5E1A              A  3754    	LD	E,(IY+%1A)
04168A CD A5 44 04         A  3755    	CALL	__ladd
04168E FD2F17              A  3756    	LD	(IY+%17),HL
041691 FD731A              A  3757    	LD	(IY+%1A),E
                           A  3758    ; 1702		dp->dir = fs->win + (ofs % SS(fs));
                           A  3759    .LINE 1702
                           A  3760    
041694 DD2709              A  3761    	LD	HL,(IX+%9)
041697 DD5E0C              A  3762    	LD	E,(IX+%C)
04169A 01FF0100            A  3763    	LD	BC,511
04169E AF                  A  3764    	XOR	A,A
04169F CD B4 48 04         A  3765    	CALL	__land
0416A3 E5C1                A  3766    	LD	BC,HL
0416A5 DD31F9              A  3767    	LD	IY,(IX+%FFFFFFF9)
0416A8 ED232E              A  3768    	LEA	HL,IY+%2E
0416AB 09                  A  3769    	ADD	HL,BC
0416AC DD3106              A  3770    	LD	IY,(IX+%6)
0416AF FD2F1B              A  3771    	LD	(IY+%1B),HL
                           A  3772    ; 1703	
                           A  3773    ; 1704		return FR_OK;
                           A  3774    .LINE 1704
                           A  3775    
0416B2 B7                  A  3776    	OR	A,A
0416B3 ED62                A  3777    	SBC	HL,HL
                           A  3778    ; 1705	}
0416B5                     A  3779    L_82:
                           A  3780    .LINE 1705
                           A  3781    
0416B5 DDF9                A  3782    	LD	SP,IX
0416B7 DDE1                A  3783    	POP	IX
0416B9 C9                  A  3784    	RET	
                           A  3785    
                           A  3786    
                           A  3787    ;**************************** _dir_sdi ********
                           A  3788    ;Name                         Addr/Register   S
                           A  3789    ;csz                                  IX-11    
                           A  3790    ;fs                                    IX-7    
                           A  3791    ;clst                                  IX-4    
                           A  3792    ;ofs                                   IX+9    
                           A  3793    ;dp                                    IX+6    
                           A  3794    
                           A  3795    
                           A  3796    ; Stack Frame Size: 31 (bytes)
                           A  3797    ;       Spill Code: 0 (instruction)
                           A  3798    
                           A  3799    
                           A  3800    .ENDFUNC "dir_sdi",1705,"_dir_sdi"
                           A  3801    ; 1706	
                           A  3802    ; 1707	
                           A  3803    ; 1708	
                           A  3804    ; 1709	
                           A  3805    ; 1710	/*-------------------------------------
                           A  3806    ; 1711	/* Directory handling - Move directory 
                           A  3807    ; 1712	/*-------------------------------------
                           A  3808    ; 1713	
                           A  3809    ; 1714	static FRESULT dir_next (	/* FR_OK(0)
                           A  3810    ; 1715		DIR* dp,				/* Pointer 
                           A  3811    ; 1716		int stretch				/* 0: Do no
                           A  3812    ; 1717	)
                           A  3813    ; 1718	{
0416BA                     A  3814    _dir_next:
                           A  3815    .DEFINE "_dir_next"
                           A  3816    
                           A  3817    .VALUE _dir_next
                           A  3818    
                           A  3819    .CLASS 3
                           A  3820    
                           A  3821    .TYPE 68
                           A  3822    
                           A  3823    .ENDEF
                           A  3824    
                           A  3825    .BEGFUNC "dir_next",1718,"_dir_next"
                           A  3826    
                           A  3827    .LINE 1718
                           A  3828    
                           A  3829    .DEFINE "dp"
                           A  3830    
                           A  3831    .CLASS 65
                           A  3832    
                           A  3833    .VALUE 6
                           A  3834    
                           A  3835    .TAG "NONAME3"
                           A  3836    
                           A  3837    .TYPE 40
                           A  3838    
                           A  3839    .ENDEF
                           A  3840    
                           A  3841    .DEFINE "stretch"
                           A  3842    
                           A  3843    .CLASS 65
                           A  3844    
                           A  3845    .VALUE 9
                           A  3846    
                           A  3847    .TYPE 4
                           A  3848    
                           A  3849    .ENDEF
                           A  3850    
                           A  3851    .DEFINE "fs"
                           A  3852    
                           A  3853    .CLASS 65
                           A  3854    
                           A  3855    .VALUE -3
                           A  3856    
                           A  3857    .TAG "NONAME0"
                           A  3858    
                           A  3859    .TYPE 40
                           A  3860    
                           A  3861    .ENDEF
                           A  3862    
                           A  3863    .DEFINE "clst"
                           A  3864    
                           A  3865    .CLASS 65
                           A  3866    
                           A  3867    .VALUE -7
                           A  3868    
                           A  3869    .TYPE 15
                           A  3870    
                           A  3871    .ENDEF
                           A  3872    
                           A  3873    .DEFINE "ofs"
                           A  3874    
                           A  3875    .CLASS 65
                           A  3876    
                           A  3877    .VALUE -11
                           A  3878    
                           A  3879    .TYPE 15
                           A  3880    
                           A  3881    .ENDEF
                           A  3882    
0416BA DDE5                A  3883    	PUSH	IX
0416BC DD210000 00         A  3884    	LD	IX,0
0416C1 DD39                A  3885    	ADD	IX,SP
0416C3 ED22E1              A  3886    	LEA	HL,IX+%FFFFFFE1
0416C6 F9                  A  3887    	LD	SP,HL
                           A  3888    ; 1719		DWORD ofs, clst;
                           A  3889    ; 1720		FATFS *fs = dp->obj.fs;
                           A  3890    .LINE 1720
                           A  3891    
0416C7 DD3106              A  3892    	LD	IY,(IX+%6)
0416CA FD0700              A  3893    	LD	BC,(IY+%0)
0416CD DD0FFD              A  3894    	LD	(IX+%FFFFFFFD),BC
                           A  3895    ; 1721	
                           A  3896    ; 1722	
                           A  3897    ; 1723		ofs = dp->dptr + SZDIRE;	/* Next
                           A  3898    .LINE 1723
                           A  3899    
0416D0 FD270F              A  3900    	LD	HL,(IY+%F)
0416D3 FD5E12              A  3901    	LD	E,(IY+%12)
0416D6 3E20                A  3902    	LD	A,%20
0416D8 CD 96 44 04         A  3903    	CALL	__ladd_b
0416DC DD2FF5              A  3904    	LD	(IX+%FFFFFFF5),HL
0416DF DD73F8              A  3905    	LD	(IX+%FFFFFFF8),E
                           A  3906    ; 1724		if (ofs >= (DWORD)((FF_FS_EXFAT && 
                           A  3907    .LINE 1724
                           A  3908    
0416E2 DD27F5              A  3909    	LD	HL,(IX+%FFFFFFF5)
0416E5 DD5EF8              A  3910    	LD	E,(IX+%FFFFFFF8)
0416E8 01000020            A  3911    	LD	BC,2097152
0416EC AF                  A  3912    	XOR	A,A
0416ED CD 88 47 04         A  3913    	CALL	__lcmpu
0416F1 38 0E               A  3914    	JR	C,L_85
0416F3 01000000            A  3915    	LD	BC,0
0416F7 DD3106              A  3916    	LD	IY,(IX+%6)
0416FA FD0F17              A  3917    	LD	(IY+%17),BC
0416FD FD361A00            A  3918    	LD	(IY+%1A),%0
041701                     A  3919    L_85:
                           A  3920    ; 1725		if (dp->sect == 0) return FR_NO_FIL
                           A  3921    .LINE 1725
                           A  3922    
041701 DD3106              A  3923    	LD	IY,(IX+%6)
041704 FD0717              A  3924    	LD	BC,(IY+%17)
041707 FD7E1A              A  3925    	LD	A,(IY+%1A)
04170A DD0FF1              A  3926    	LD	(IX+%FFFFFFF1),BC
04170D DD77F4              A  3927    	LD	(IX+%FFFFFFF4),A
041710 C5E1                A  3928    	LD	HL,BC
041712 DD5EF4              A  3929    	LD	E,(IX+%FFFFFFF4)
041715 CD B8 45 04         A  3930    	CALL	__lcmpzero
041719 20 08               A  3931    	JR	NZ,L_100
04171B 21040000            A  3932    	LD	HL,4
04171F C3 C7 18 04         A  3933    	JR	L_102
041723                     A  3934    L_100:
                           A  3935    ; 1726	
                           A  3936    ; 1727		if (ofs % SS(fs) == 0) {	/* Sect
                           A  3937    .LINE 1727
                           A  3938    
041723 DD27F5              A  3939    	LD	HL,(IX+%FFFFFFF5)
041726 DD5EF8              A  3940    	LD	E,(IX+%FFFFFFF8)
041729 01FF0100            A  3941    	LD	BC,511
04172D AF                  A  3942    	XOR	A,A
04172E CD B4 48 04         A  3943    	CALL	__land
041732 DD2FED              A  3944    	LD	(IX+%FFFFFFED),HL
041735 DD73F0              A  3945    	LD	(IX+%FFFFFFF0),E
041738 DD27ED              A  3946    	LD	HL,(IX+%FFFFFFED)
04173B DD5EF0              A  3947    	LD	E,(IX+%FFFFFFF0)
04173E CD B8 45 04         A  3948    	CALL	__lcmpzero
041742 C2 A5 18 04         A  3949    	JR	NZ,L_101
                           A  3950    ; 1728			dp->sect++;				/* Next
                           A  3951    .LINE 1728
                           A  3952    
041746 DD27F1              A  3953    	LD	HL,(IX+%FFFFFFF1)
041749 DD5EF4              A  3954    	LD	E,(IX+%FFFFFFF4)
04174C 3E01                A  3955    	LD	A,%1
04174E CD 96 44 04         A  3956    	CALL	__ladd_b
041752 DD3106              A  3957    	LD	IY,(IX+%6)
041755 FD2F17              A  3958    	LD	(IY+%17),HL
041758 FD731A              A  3959    	LD	(IY+%1A),E
                           A  3960    ; 1729	
                           A  3961    ; 1730			if (dp->clust == 0) {	/* Stat
                           A  3962    .LINE 1730
                           A  3963    
04175B FD0713              A  3964    	LD	BC,(IY+%13)
04175E FD7E16              A  3965    	LD	A,(IY+%16)
041761 DD0FE9              A  3966    	LD	(IX+%FFFFFFE9),BC
041764 DD77EC              A  3967    	LD	(IX+%FFFFFFEC),A
041767 C5E1                A  3968    	LD	HL,BC
041769 DD5EEC              A  3969    	LD	E,(IX+%FFFFFFEC)
04176C CD B8 45 04         A  3970    	CALL	__lcmpzero
041770 20 46               A  3971    	JR	NZ,L_98
                           A  3972    ; 1731				if (ofs / SZDIRE >= fs->n_r
                           A  3973    .LINE 1731
                           A  3974    
041772 DD31FD              A  3975    	LD	IY,(IX+%FFFFFFFD)
041775 FD0707              A  3976    	LD	BC,(IY+%7)
041778 CD 73 45 04         A  3977    	CALL	__stoiu
04177C DD2FE3              A  3978    	LD	(IX+%FFFFFFE3),HL
04177F 0600                A  3979    	LD	B,%0
041781 DD70E1              A  3980    	LD	(IX+%FFFFFFE1),B	; spill
041784 DD07F5              A  3981    	LD	BC,(IX+%FFFFFFF5)
041787 DD7EF8              A  3982    	LD	A,(IX+%FFFFFFF8)
04178A 2E05                A  3983    	LD	L,%5
04178C CD 87 46 04         A  3984    	CALL	__lshru
041790 5F                  A  3985    	LD	E,A
041791 C5E1                A  3986    	LD	HL,BC
041793 DD46E1              A  3987    	LD	B,(IX+%FFFFFFE1)	; unspill
041796 78                  A  3988    	LD	A,B
041797 DD07E3              A  3989    	LD	BC,(IX+%FFFFFFE3)
04179A CD 88 47 04         A  3990    	CALL	__lcmpu
04179E DA A5 18 04         A  3991    	JR	C,L_101
                           A  3992    ; 1732					dp->sect = 0; return FR
                           A  3993    .LINE 1732
                           A  3994    
0417A2 01000000            A  3995    	LD	BC,0
0417A6 DD3106              A  3996    	LD	IY,(IX+%6)
0417A9 FD0F17              A  3997    	LD	(IY+%17),BC
0417AC FD361A00            A  3998    	LD	(IY+%1A),%0
0417B0 21040000            A  3999    	LD	HL,4
0417B4 C3 C7 18 04         A  4000    	JR	L_102
                           A  4001    ; 1733				}
                           A  4002    ; 1734			}
                           A  4003    ; 1735			else {					/* Dyna
0417B8                     A  4004    L_98:
                           A  4005    .LINE 1735
                           A  4006    
                           A  4007    ; 1736				if ((ofs / SS(fs) & (fs->cs
                           A  4008    .LINE 1736
                           A  4009    
0417B8 DD31FD              A  4010    	LD	IY,(IX+%FFFFFFFD)
0417BB FD0709              A  4011    	LD	BC,(IY+%9)
0417BE CD 73 45 04         A  4012    	CALL	__stoiu
0417C2 2B                  A  4013    	DEC	HL
0417C3 E5C1                A  4014    	LD	BC,HL
0417C5 CD 81 47 04         A  4015    	CALL	__itol
0417C9 DD0FE6              A  4016    	LD	(IX+%FFFFFFE6),BC
0417CC 5F                  A  4017    	LD	E,A
0417CD DD07F5              A  4018    	LD	BC,(IX+%FFFFFFF5)
0417D0 DD7EF8              A  4019    	LD	A,(IX+%FFFFFFF8)
0417D3 2E09                A  4020    	LD	L,%9
0417D5 CD 87 46 04         A  4021    	CALL	__lshru
0417D9 DD27E6              A  4022    	LD	HL,(IX+%FFFFFFE6)
0417DC CD B4 48 04         A  4023    	CALL	__land
0417E0 CD B8 45 04         A  4024    	CALL	__lcmpzero
0417E4 C2 A5 18 04         A  4025    	JR	NZ,L_101
                           A  4026    ; 1737					clst = get_fat(&dp->obj
                           A  4027    .LINE 1737
                           A  4028    
0417E8 DD4EEC              A  4029    	LD	C,(IX+%FFFFFFEC)
0417EB 0600                A  4030    	LD	B,%0
0417ED C5                  A  4031    	PUSH	BC
0417EE DD07E9              A  4032    	LD	BC,(IX+%FFFFFFE9)
0417F1 C5                  A  4033    	PUSH	BC
0417F2 DD3106              A  4034    	LD	IY,(IX+%6)
0417F5 ED6600              A  4035    	PEA	IY+%0
0417F8 CD 67 12 04         A  4036    	CALL	_get_fat
0417FC C1                  A  4037    	POP	BC
0417FD C1                  A  4038    	POP	BC
0417FE C1                  A  4039    	POP	BC
0417FF E5C1                A  4040    	LD	BC,HL
041801 DD0FF9              A  4041    	LD	(IX+%FFFFFFF9),BC
041804 DD73FC              A  4042    	LD	(IX+%FFFFFFFC),E
                           A  4043    ; 1738					if (clst <= 1) return F
                           A  4044    .LINE 1738
                           A  4045    
041807 21010000            A  4046    	LD	HL,1
04180B 1E00                A  4047    	LD	E,%0
04180D DD7EFC              A  4048    	LD	A,(IX+%FFFFFFFC)
041810 CD 88 47 04         A  4049    	CALL	__lcmpu
041814 38 08               A  4050    	JR	C,L_90
041816 21020000            A  4051    	LD	HL,2
04181A C3 C7 18 04         A  4052    	JR	L_102
04181E                     A  4053    L_90:
                           A  4054    ; 1739					if (clst == 0xFFFFFFFF)
                           A  4055    .LINE 1739
                           A  4056    
04181E DD27F9              A  4057    	LD	HL,(IX+%FFFFFFF9)
041821 DD5EFC              A  4058    	LD	E,(IX+%FFFFFFFC)
041824 01FFFFFF            A  4059    	LD	BC,16777215
041828 3EFF                A  4060    	LD	A,%FF
04182A CD 88 47 04         A  4061    	CALL	__lcmpu
04182E 20 08               A  4062    	JR	NZ,L_94
041830 21010000            A  4063    	LD	HL,1
041834 C3 C7 18 04         A  4064    	JR	L_102
041838                     A  4065    L_94:
                           A  4066    ; 1740					if (clst >= fs->n_faten
                           A  4067    .LINE 1740
                           A  4068    
041838 DD27F9              A  4069    	LD	HL,(IX+%FFFFFFF9)
04183B DD5EFC              A  4070    	LD	E,(IX+%FFFFFFFC)
04183E DD31FD              A  4071    	LD	IY,(IX+%FFFFFFFD)
041841 FD0712              A  4072    	LD	BC,(IY+%12)
041844 FD7E15              A  4073    	LD	A,(IY+%15)
041847 CD 88 47 04         A  4074    	CALL	__lcmpu
04184B 38 2B               A  4075    	JR	C,L_95
                           A  4076    ; 1741	#if !FF_FS_READONLY
                           A  4077    ; 1742						if (!stretch) {		
                           A  4078    ; 1743							dp->sect = 0; r
                           A  4079    ; 1744						}
                           A  4080    ; 1745						clst = create_chain
                           A  4081    ; 1746						if (clst == 0) retu
                           A  4082    ; 1747						if (clst == 1) retu
                           A  4083    ; 1748						if (clst == 0xFFFFF
                           A  4084    ; 1749						if (dir_clear(fs, c
                           A  4085    ; 1750						if (FF_FS_EXFAT) dp
                           A  4086    ; 1751	#else
                           A  4087    ; 1752						if (!stretch) dp->s
                           A  4088    .LINE 1752
                           A  4089    
04184D DD2709              A  4090    	LD	HL,(IX+%9)
041850 CD E5 46 04         A  4091    	CALL	__icmpzero
041854 20 0E               A  4092    	JR	NZ,L_92
041856 01000000            A  4093    	LD	BC,0
04185A DD3106              A  4094    	LD	IY,(IX+%6)
04185D FD0F17              A  4095    	LD	(IY+%17),BC
041860 FD361A00            A  4096    	LD	(IY+%1A),%0
041864                     A  4097    L_92:
                           A  4098    ; 1753						dp->sect = 0; retur
                           A  4099    .LINE 1753
                           A  4100    
041864 01000000            A  4101    	LD	BC,0
041868 DD3106              A  4102    	LD	IY,(IX+%6)
04186B FD0F17              A  4103    	LD	(IY+%17),BC
04186E FD361A00            A  4104    	LD	(IY+%1A),%0
041872 21040000            A  4105    	LD	HL,4
041876 18 4F               A  4106    	JR	L_102
                           A  4107    ; 1754	#endif
                           A  4108    ; 1755					}
041878                     A  4109    L_95:
                           A  4110    .LINE 1755
                           A  4111    
                           A  4112    ; 1756					dp->clust = clst;		
                           A  4113    .LINE 1756
                           A  4114    
041878 DD07F9              A  4115    	LD	BC,(IX+%FFFFFFF9)
04187B DD7EFC              A  4116    	LD	A,(IX+%FFFFFFFC)
04187E DD3106              A  4117    	LD	IY,(IX+%6)
041881 FD0F13              A  4118    	LD	(IY+%13),BC
041884 FD7716              A  4119    	LD	(IY+%16),A
                           A  4120    ; 1757					dp->sect = clst2sect(fs
                           A  4121    .LINE 1757
                           A  4122    
041887 DD4EFC              A  4123    	LD	C,(IX+%FFFFFFFC)
04188A 0600                A  4124    	LD	B,%0
04188C C5                  A  4125    	PUSH	BC
04188D DD07F9              A  4126    	LD	BC,(IX+%FFFFFFF9)
041890 C5                  A  4127    	PUSH	BC
041891 DD07FD              A  4128    	LD	BC,(IX+%FFFFFFFD)
041894 C5                  A  4129    	PUSH	BC
041895 CD FC 11 04         A  4130    	CALL	_clst2sect
041899 C1                  A  4131    	POP	BC
04189A C1                  A  4132    	POP	BC
04189B C1                  A  4133    	POP	BC
04189C DD3106              A  4134    	LD	IY,(IX+%6)
04189F FD2F17              A  4135    	LD	(IY+%17),HL
0418A2 FD731A              A  4136    	LD	(IY+%1A),E
                           A  4137    ; 1758				}
                           A  4138    ; 1759			}
                           A  4139    ; 1760		}
0418A5                     A  4140    L_101:
                           A  4141    .LINE 1760
                           A  4142    
                           A  4143    ; 1761		dp->dptr = ofs;						
                           A  4144    .LINE 1761
                           A  4145    
0418A5 DD07F5              A  4146    	LD	BC,(IX+%FFFFFFF5)
0418A8 DD7EF8              A  4147    	LD	A,(IX+%FFFFFFF8)
0418AB DD3106              A  4148    	LD	IY,(IX+%6)
0418AE FD0F0F              A  4149    	LD	(IY+%F),BC
0418B1 FD7712              A  4150    	LD	(IY+%12),A
                           A  4151    ; 1762		dp->dir = fs->win + ofs % SS(fs);	
                           A  4152    .LINE 1762
                           A  4153    
0418B4 DD07ED              A  4154    	LD	BC,(IX+%FFFFFFED)
0418B7 DD31FD              A  4155    	LD	IY,(IX+%FFFFFFFD)
0418BA ED232E              A  4156    	LEA	HL,IY+%2E
0418BD 09                  A  4157    	ADD	HL,BC
0418BE DD3106              A  4158    	LD	IY,(IX+%6)
0418C1 FD2F1B              A  4159    	LD	(IY+%1B),HL
                           A  4160    ; 1763	
                           A  4161    ; 1764		return FR_OK;
                           A  4162    .LINE 1764
                           A  4163    
0418C4 B7                  A  4164    	OR	A,A
0418C5 ED62                A  4165    	SBC	HL,HL
                           A  4166    ; 1765	}
0418C7                     A  4167    L_102:
                           A  4168    .LINE 1765
                           A  4169    
0418C7 DDF9                A  4170    	LD	SP,IX
0418C9 DDE1                A  4171    	POP	IX
0418CB C9                  A  4172    	RET	
                           A  4173    
                           A  4174    
                           A  4175    ;**************************** _dir_next *******
                           A  4176    ;Name                         Addr/Register   S
                           A  4177    ;G_1                                  IX-23    
                           A  4178    ;G_2                                  IX-19    
                           A  4179    ;G_0                                  IX-15    
                           A  4180    ;ofs                                  IX-11    
                           A  4181    ;clst                                  IX-7    
                           A  4182    ;fs                                    IX-3    
                           A  4183    ;stretch                               IX+9    
                           A  4184    ;dp                                    IX+6    
                           A  4185    
                           A  4186    
                           A  4187    ; Stack Frame Size: 43 (bytes)
                           A  4188    ;       Spill Code: 0 (instruction)
                           A  4189    
                           A  4190    
                           A  4191    .ENDFUNC "dir_next",1765,"_dir_next"
                           A  4192    ; 1766	
                           A  4193    ; 1767	
                           A  4194    ; 1768	
                           A  4195    ; 1769	
                           A  4196    ; 1770	#if !FF_FS_READONLY
                           A  4197    ; 1771	/*-------------------------------------
                           A  4198    ; 1772	/* Directory handling - Reserve a block
                           A  4199    ; 1773	/*-------------------------------------
                           A  4200    ; 1774	
                           A  4201    ; 1775	static FRESULT dir_alloc (	/* FR_OK(0)
                           A  4202    ; 1776		DIR* dp,				/* Pointer 
                           A  4203    ; 1777		UINT n_ent				/* Number o
                           A  4204    ; 1778	)
                           A  4205    ; 1779	{
                           A  4206    ; 1780		FRESULT res;
                           A  4207    ; 1781		UINT n;
                           A  4208    ; 1782		FATFS *fs = dp->obj.fs;
                           A  4209    ; 1783	
                           A  4210    ; 1784	
                           A  4211    ; 1785		res = dir_sdi(dp, 0);
                           A  4212    ; 1786		if (res == FR_OK) {
                           A  4213    ; 1787			n = 0;
                           A  4214    ; 1788			do {
                           A  4215    ; 1789				res = move_window(fs, dp->s
                           A  4216    ; 1790				if (res != FR_OK) break;
                           A  4217    ; 1791	#if FF_FS_EXFAT
                           A  4218    ; 1792				if ((fs->fs_type == FS_EXFA
                           A  4219    ; 1793	#else
                           A  4220    ; 1794				if (dp->dir[DIR_Name] == DD
                           A  4221    ; 1795	#endif
                           A  4222    ; 1796					if (++n == n_ent) break
                           A  4223    ; 1797				} else {
                           A  4224    ; 1798					n = 0;				/* 
                           A  4225    ; 1799				}
                           A  4226    ; 1800				res = dir_next(dp, 1);	/* 
                           A  4227    ; 1801			} while (res == FR_OK);
                           A  4228    ; 1802		}
                           A  4229    ; 1803	
                           A  4230    ; 1804		if (res == FR_NO_FILE) res = FR_DEN
                           A  4231    ; 1805		return res;
                           A  4232    ; 1806	}
                           A  4233    ; 1807	
                           A  4234    ; 1808	#endif	/* !FF_FS_READONLY */
                           A  4235    ; 1809	
                           A  4236    ; 1810	
                           A  4237    ; 1811	
                           A  4238    ; 1812	
                           A  4239    ; 1813	/*-------------------------------------
                           A  4240    ; 1814	/* FAT: Directory handling - Load/Store
                           A  4241    ; 1815	/*-------------------------------------
                           A  4242    ; 1816	
                           A  4243    ; 1817	static DWORD ld_clust (	/* Returns the 
                           A  4244    ; 1818		FATFS* fs,			/* Pointer to t
                           A  4245    ; 1819		const BYTE* dir		/* Pointer to t
                           A  4246    ; 1820	)
                           A  4247    ; 1821	{
0418CC                     A  4248    _ld_clust:
                           A  4249    .DEFINE "_ld_clust"
                           A  4250    
                           A  4251    .VALUE _ld_clust
                           A  4252    
                           A  4253    .CLASS 3
                           A  4254    
                           A  4255    .TYPE 79
                           A  4256    
                           A  4257    .ENDEF
                           A  4258    
                           A  4259    .BEGFUNC "ld_clust",1821,"_ld_clust"
                           A  4260    
                           A  4261    .LINE 1821
                           A  4262    
                           A  4263    .DEFINE "fs"
                           A  4264    
                           A  4265    .CLASS 65
                           A  4266    
                           A  4267    .VALUE 6
                           A  4268    
                           A  4269    .TAG "NONAME0"
                           A  4270    
                           A  4271    .TYPE 40
                           A  4272    
                           A  4273    .ENDEF
                           A  4274    
                           A  4275    .DEFINE "dir"
                           A  4276    
                           A  4277    .CLASS 65
                           A  4278    
                           A  4279    .VALUE 9
                           A  4280    
                           A  4281    .TYPE 204
                           A  4282    
                           A  4283    .ENDEF
                           A  4284    
                           A  4285    .DEFINE "cl"
                           A  4286    
                           A  4287    .CLASS 65
                           A  4288    
                           A  4289    .VALUE -4
                           A  4290    
                           A  4291    .TYPE 15
                           A  4292    
                           A  4293    .ENDEF
                           A  4294    
0418CC DDE5                A  4295    	PUSH	IX
0418CE DD210000 00         A  4296    	LD	IX,0
0418D3 DD39                A  4297    	ADD	IX,SP
0418D5 C5                  A  4298    	PUSH	BC
0418D6 3B                  A  4299    	DEC	SP
                           A  4300    ; 1822		DWORD cl;
                           A  4301    ; 1823	
                           A  4302    ; 1824		cl = ld_word(dir + DIR_FstClusLO);
                           A  4303    .LINE 1824
                           A  4304    
0418D7 DD3109              A  4305    	LD	IY,(IX+%9)
0418DA ED031A              A  4306    	LEA	BC,IY+%1A
0418DD C5                  A  4307    	PUSH	BC
0418DE CD 25 0F 04         A  4308    	CALL	_ld_word
0418E2 C1                  A  4309    	POP	BC
0418E3 E5C1                A  4310    	LD	BC,HL
0418E5 CD 73 45 04         A  4311    	CALL	__stoiu
0418E9 AF                  A  4312    	XOR	A,A
0418EA DD2FFC              A  4313    	LD	(IX+%FFFFFFFC),HL
0418ED DD77FF              A  4314    	LD	(IX+%FFFFFFFF),A
                           A  4315    ; 1825		if (fs->fs_type == FS_FAT32) {
                           A  4316    .LINE 1825
                           A  4317    
0418F0 DD3106              A  4318    	LD	IY,(IX+%6)
0418F3 FD7E00              A  4319    	LD	A,(IY+%0)
0418F6 FE03                A  4320    	CP	A,%3
0418F8 20 2E               A  4321    	JR	NZ,L_104
                           A  4322    ; 1826			cl |= (DWORD)ld_word(dir + DIR_
                           A  4323    .LINE 1826
                           A  4324    
0418FA DD3109              A  4325    	LD	IY,(IX+%9)
0418FD ED0314              A  4326    	LEA	BC,IY+%14
041900 C5                  A  4327    	PUSH	BC
041901 CD 25 0F 04         A  4328    	CALL	_ld_word
041905 C1                  A  4329    	POP	BC
041906 E5C1                A  4330    	LD	BC,HL
041908 CD 73 45 04         A  4331    	CALL	__stoiu
04190C AF                  A  4332    	XOR	A,A
04190D E5C1                A  4333    	LD	BC,HL
04190F 2E10                A  4334    	LD	L,%10
041911 CD E5 47 04         A  4335    	CALL	__lshl
041915 5F                  A  4336    	LD	E,A
041916 C5E1                A  4337    	LD	HL,BC
041918 DD07FC              A  4338    	LD	BC,(IX+%FFFFFFFC)
04191B DD7EFF              A  4339    	LD	A,(IX+%FFFFFFFF)
04191E CD D3 46 04         A  4340    	CALL	__lor
041922 DD2FFC              A  4341    	LD	(IX+%FFFFFFFC),HL
041925 DD73FF              A  4342    	LD	(IX+%FFFFFFFF),E
                           A  4343    ; 1827		}
041928                     A  4344    L_104:
                           A  4345    .LINE 1827
                           A  4346    
                           A  4347    ; 1828	
                           A  4348    ; 1829		return cl;
                           A  4349    .LINE 1829
                           A  4350    
041928 DD27FC              A  4351    	LD	HL,(IX+%FFFFFFFC)
04192B DD5EFF              A  4352    	LD	E,(IX+%FFFFFFFF)
                           A  4353    ; 1830	}
                           A  4354    .LINE 1830
                           A  4355    
04192E DDF9                A  4356    	LD	SP,IX
041930 DDE1                A  4357    	POP	IX
041932 C9                  A  4358    	RET	
                           A  4359    
                           A  4360    
                           A  4361    ;**************************** _ld_clust *******
                           A  4362    ;Name                         Addr/Register   S
                           A  4363    ;cl                                    IX-4    
                           A  4364    ;dir                                   IX+9    
                           A  4365    ;fs                                    IX+6    
                           A  4366    
                           A  4367    
                           A  4368    ; Stack Frame Size: 16 (bytes)
                           A  4369    ;       Spill Code: 0 (instruction)
                           A  4370    
                           A  4371    
                           A  4372    .ENDFUNC "ld_clust",1830,"_ld_clust"
                           A  4373    ; 1831	
                           A  4374    ; 1832	
                           A  4375    ; 1833	#if !FF_FS_READONLY
                           A  4376    ; 1834	static void st_clust (
                           A  4377    ; 1835		FATFS* fs,	/* Pointer to the fs ob
                           A  4378    ; 1836		BYTE* dir,	/* Pointer to the key e
                           A  4379    ; 1837		DWORD cl	/* Value to be set */
                           A  4380    ; 1838	)
                           A  4381    ; 1839	{
                           A  4382    ; 1840		st_word(dir + DIR_FstClusLO, (WORD)
                           A  4383    ; 1841		if (fs->fs_type == FS_FAT32) {
                           A  4384    ; 1842			st_word(dir + DIR_FstClusHI, (W
                           A  4385    ; 1843		}
                           A  4386    ; 1844	}
                           A  4387    ; 1845	#endif
                           A  4388    ; 1846	
                           A  4389    ; 1847	
                           A  4390    ; 1848	
                           A  4391    ; 1849	#if FF_USE_LFN
                           A  4392    ; 1850	/*-------------------------------------
                           A  4393    ; 1851	/* FAT-LFN: Compare a part of file name
                           A  4394    ; 1852	/*-------------------------------------
                           A  4395    ; 1853	
                           A  4396    ; 1854	static int cmp_lfn (		/* 1:matche
                           A  4397    ; 1855		const WCHAR* lfnbuf,	/* Pointer 
                           A  4398    ; 1856		BYTE* dir				/* Pointer 
                           A  4399    ; 1857	)
                           A  4400    ; 1858	{
041933                     A  4401    _cmp_lfn:
                           A  4402    .DEFINE "_cmp_lfn"
                           A  4403    
                           A  4404    .VALUE _cmp_lfn
                           A  4405    
                           A  4406    .CLASS 3
                           A  4407    
                           A  4408    .TYPE 68
                           A  4409    
                           A  4410    .ENDEF
                           A  4411    
                           A  4412    .BEGFUNC "cmp_lfn",1858,"_cmp_lfn"
                           A  4413    
                           A  4414    .LINE 1858
                           A  4415    
                           A  4416    .DEFINE "lfnbuf"
                           A  4417    
                           A  4418    .CLASS 65
                           A  4419    
                           A  4420    .VALUE 6
                           A  4421    
                           A  4422    .TYPE 205
                           A  4423    
                           A  4424    .ENDEF
                           A  4425    
                           A  4426    .DEFINE "dir"
                           A  4427    
                           A  4428    .CLASS 65
                           A  4429    
                           A  4430    .VALUE 9
                           A  4431    
                           A  4432    .TYPE 44
                           A  4433    
                           A  4434    .ENDEF
                           A  4435    
                           A  4436    .DEFINE "i"
                           A  4437    
                           A  4438    .CLASS 65
                           A  4439    
                           A  4440    .VALUE -3
                           A  4441    
                           A  4442    .TYPE 14
                           A  4443    
                           A  4444    .ENDEF
                           A  4445    
                           A  4446    .DEFINE "s"
                           A  4447    
                           A  4448    .CLASS 65
                           A  4449    
                           A  4450    .VALUE -6
                           A  4451    
                           A  4452    .TYPE 14
                           A  4453    
                           A  4454    .ENDEF
                           A  4455    
                           A  4456    .DEFINE "wc"
                           A  4457    
                           A  4458    .CLASS 65
                           A  4459    
                           A  4460    .VALUE -8
                           A  4461    
                           A  4462    .TYPE 13
                           A  4463    
                           A  4464    .ENDEF
                           A  4465    
                           A  4466    .DEFINE "uc"
                           A  4467    
                           A  4468    .CLASS 65
                           A  4469    
                           A  4470    .VALUE -10
                           A  4471    
                           A  4472    .TYPE 13
                           A  4473    
                           A  4474    .ENDEF
                           A  4475    
041933 DDE5                A  4476    	PUSH	IX
041935 DD210000 00         A  4477    	LD	IX,0
04193A DD39                A  4478    	ADD	IX,SP
04193C ED22F2              A  4479    	LEA	HL,IX+%FFFFFFF2
04193F F9                  A  4480    	LD	SP,HL
                           A  4481    ; 1859		UINT i, s;
                           A  4482    ; 1860		WCHAR wc, uc;
                           A  4483    ; 1861	
                           A  4484    ; 1862	
                           A  4485    ; 1863		if (ld_word(dir + LDIR_FstClusLO) !
                           A  4486    .LINE 1863
                           A  4487    
041940 DD3109              A  4488    	LD	IY,(IX+%9)
041943 ED031A              A  4489    	LEA	BC,IY+%1A
041946 C5                  A  4490    	PUSH	BC
041947 CD 25 0F 04         A  4491    	CALL	_ld_word
04194B C1                  A  4492    	POP	BC
04194C CD D8 47 04         A  4493    	CALL	__scmpzero
041950 28 07               A  4494    	JR	Z,L_107
041952 B7                  A  4495    	OR	A,A
041953 ED62                A  4496    	SBC	HL,HL
041955 C3 5C 1A 04         A  4497    	JR	L_124
041959                     A  4498    L_107:
                           A  4499    ; 1864	
                           A  4500    ; 1865		i = ((dir[LDIR_Ord] & 0x3F) - 1) * 
                           A  4501    .LINE 1865
                           A  4502    
041959 DD2709              A  4503    	LD	HL,(IX+%9)
04195C 7E                  A  4504    	LD	A,(HL)
04195D E63F                A  4505    	AND	A,%3F
04195F B7ED62              A  4506    	UEXT	HL
041962 6F                  A  4507    	LD	L,A
041963 2B                  A  4508    	DEC	HL
041964 3E0D                A  4509    	LD	A,%D
041966 CD 4B 48 04         A  4510    	CALL	__imul_b
04196A DD2FFD              A  4511    	LD	(IX+%FFFFFFFD),HL
                           A  4512    ; 1866	
                           A  4513    ; 1867		for (wc = 1, s = 0; s < 13; s++) {	
                           A  4514    .LINE 1867
                           A  4515    
04196D DD36F801            A  4516    	LD	(IX+%FFFFFFF8),%1
041971 DD36F900            A  4517    	LD	(IX+%FFFFFFF9),%0
041975 01000000            A  4518    	LD	BC,0
041979 DD0FFA              A  4519    	LD	(IX+%FFFFFFFA),BC
04197C C3 24 1A 04         A  4520    	JR	L_118
041980                     A  4521    L_116:
                           A  4522    ; 1868			uc = ld_word(dir + LfnOfs[s]);	
                           A  4523    .LINE 1868
                           A  4524    
041980 01 E1 4C 04         A  4525    	LD	BC,_LfnOfs
041984 DD27FA              A  4526    	LD	HL,(IX+%FFFFFFFA)
041987 09                  A  4527    	ADD	HL,BC
041988 7E                  A  4528    	LD	A,(HL)
041989 B7ED62              A  4529    	UEXT	HL
04198C 6F                  A  4530    	LD	L,A
04198D DD0709              A  4531    	LD	BC,(IX+%9)
041990 09                  A  4532    	ADD	HL,BC
041991 E5                  A  4533    	PUSH	HL
041992 CD 25 0F 04         A  4534    	CALL	_ld_word
041996 C1                  A  4535    	POP	BC
041997 DD75F6              A  4536    	LD	(IX+%FFFFFFF6),L
04199A DD74F7              A  4537    	LD	(IX+%FFFFFFF7),H
                           A  4538    ; 1869			if (wc != 0) {
                           A  4539    .LINE 1869
                           A  4540    
04199D DD27F8              A  4541    	LD	HL,(IX+%FFFFFFF8)
0419A0 CD D8 47 04         A  4542    	CALL	__scmpzero
0419A4 28 65               A  4543    	JR	Z,L_115
                           A  4544    ; 1870				if (i >= FF_MAX_LFN + 1 || 
                           A  4545    .LINE 1870
                           A  4546    
0419A6 01000100            A  4547    	LD	BC,256
0419AA DD27FD              A  4548    	LD	HL,(IX+%FFFFFFFD)
0419AD B7                  A  4549    	OR	A,A
0419AE ED42                A  4550    	SBC	HL,BC
0419B0 30 49               A  4551    	JR	NC,L_111
0419B2 DD27FD              A  4552    	LD	HL,(IX+%FFFFFFFD)
0419B5 DD07FD              A  4553    	LD	BC,(IX+%FFFFFFFD)
0419B8 03                  A  4554    	INC	BC
0419B9 DD0FFD              A  4555    	LD	(IX+%FFFFFFFD),BC
0419BC 29                  A  4556    	ADD	HL,HL
0419BD DD0706              A  4557    	LD	BC,(IX+%6)
0419C0 09                  A  4558    	ADD	HL,BC
0419C1 ED07                A  4559    	LD	BC,(HL)
0419C3 CD 73 45 04         A  4560    	CALL	__stoiu
0419C7 0E00                A  4561    	LD	C,%0
0419C9 0600                A  4562    	LD	B,%0
0419CB C5                  A  4563    	PUSH	BC
0419CC E5                  A  4564    	PUSH	HL
0419CD CD 38 0D 04         A  4565    	CALL	_ff_wtoupper
0419D1 C1                  A  4566    	POP	BC
0419D2 C1                  A  4567    	POP	BC
0419D3 DD73F5              A  4568    	LD	(IX+%FFFFFFF5),E
0419D6 DD2FF2              A  4569    	LD	(IX+%FFFFFFF2),HL
0419D9 DD07F6              A  4570    	LD	BC,(IX+%FFFFFFF6)
0419DC CD 73 45 04         A  4571    	CALL	__stoiu
0419E0 0E00                A  4572    	LD	C,%0
0419E2 0600                A  4573    	LD	B,%0
0419E4 C5                  A  4574    	PUSH	BC
0419E5 E5                  A  4575    	PUSH	HL
0419E6 CD 38 0D 04         A  4576    	CALL	_ff_wtoupper
0419EA C1                  A  4577    	POP	BC
0419EB C1                  A  4578    	POP	BC
0419EC 7B                  A  4579    	LD	A,E
0419ED E5C1                A  4580    	LD	BC,HL
0419EF DD5EF5              A  4581    	LD	E,(IX+%FFFFFFF5)
0419F2 DD27F2              A  4582    	LD	HL,(IX+%FFFFFFF2)
0419F5 CD 88 47 04         A  4583    	CALL	__lcmpu
0419F9 28 05               A  4584    	JR	Z,L_112
0419FB                     A  4585    L_111:
                           A  4586    ; 1871					return 0;				
                           A  4587    .LINE 1871
                           A  4588    
0419FB B7                  A  4589    	OR	A,A
0419FC ED62                A  4590    	SBC	HL,HL
0419FE 18 5C               A  4591    	JR	L_124
                           A  4592    ; 1872				}
041A00                     A  4593    L_112:
                           A  4594    .LINE 1872
                           A  4595    
                           A  4596    ; 1873				wc = uc;
                           A  4597    .LINE 1873
                           A  4598    
041A00 DD07F6              A  4599    	LD	BC,(IX+%FFFFFFF6)
041A03 DD71F8              A  4600    	LD	(IX+%FFFFFFF8),C
041A06 DD70F9              A  4601    	LD	(IX+%FFFFFFF9),B
                           A  4602    ; 1874			} else {
                           A  4603    .LINE 1874
                           A  4604    
041A09 18 12               A  4605    	JR	L_117
041A0B                     A  4606    L_115:
                           A  4607    ; 1875				if (uc != 0xFFFF) return 0;
                           A  4608    .LINE 1875
                           A  4609    
041A0B 4901FFFF            A  4610    	LD.LIS	BC,65535
041A0F DD27F6              A  4611    	LD	HL,(IX+%FFFFFFF6)
041A12 B7                  A  4612    	OR	A,A
041A13 40ED42              A  4613    	SBC.SIS	HL,BC
041A16 28 05               A  4614    	JR	Z,L_117
041A18 B7                  A  4615    	OR	A,A
041A19 ED62                A  4616    	SBC	HL,HL
041A1B 18 3F               A  4617    	JR	L_124
                           A  4618    ; 1876			}
                           A  4619    ; 1877		}
041A1D                     A  4620    L_117:
                           A  4621    .LINE 1877
                           A  4622    
041A1D DD07FA              A  4623    	LD	BC,(IX+%FFFFFFFA)
041A20 03                  A  4624    	INC	BC
041A21 DD0FFA              A  4625    	LD	(IX+%FFFFFFFA),BC
041A24                     A  4626    L_118:
041A24 010D0000            A  4627    	LD	BC,13
041A28 DD27FA              A  4628    	LD	HL,(IX+%FFFFFFFA)
041A2B B7                  A  4629    	OR	A,A
041A2C ED42                A  4630    	SBC	HL,BC
041A2E DA 80 19 04         A  4631    	JR	C,L_116
                           A  4632    ; 1878	
                           A  4633    ; 1879		if ((dir[LDIR_Ord] & LLEF) && wc &&
                           A  4634    .LINE 1879
                           A  4635    
041A32 DD2709              A  4636    	LD	HL,(IX+%9)
041A35 7E                  A  4637    	LD	A,(HL)
041A36 E640                A  4638    	AND	A,%40
041A38 28 1E               A  4639    	JR	Z,L_123
041A3A DD27F8              A  4640    	LD	HL,(IX+%FFFFFFF8)
041A3D CD D8 47 04         A  4641    	CALL	__scmpzero
041A41 28 15               A  4642    	JR	Z,L_123
041A43 DD27FD              A  4643    	LD	HL,(IX+%FFFFFFFD)
041A46 29                  A  4644    	ADD	HL,HL
041A47 DD0706              A  4645    	LD	BC,(IX+%6)
041A4A 09                  A  4646    	ADD	HL,BC
041A4B ED27                A  4647    	LD	HL,(HL)
041A4D CD D8 47 04         A  4648    	CALL	__scmpzero
041A51 28 05               A  4649    	JR	Z,L_123
041A53 B7                  A  4650    	OR	A,A
041A54 ED62                A  4651    	SBC	HL,HL
041A56 18 04               A  4652    	JR	L_124
041A58                     A  4653    L_123:
                           A  4654    ; 1880	
                           A  4655    ; 1881		return 1;		/* The part of LFN 
                           A  4656    .LINE 1881
                           A  4657    
041A58 21010000            A  4658    	LD	HL,1
                           A  4659    ; 1882	}
041A5C                     A  4660    L_124:
                           A  4661    .LINE 1882
                           A  4662    
041A5C DDF9                A  4663    	LD	SP,IX
041A5E DDE1                A  4664    	POP	IX
041A60 C9                  A  4665    	RET	
                           A  4666    
                           A  4667    
                           A  4668    ;**************************** _cmp_lfn ********
                           A  4669    ;Name                         Addr/Register   S
                           A  4670    ;_ff_wtoupper                        IMPORT  --
                           A  4671    ;_LfnOfs                             STATIC    
                           A  4672    ;uc                                   IX-10    
                           A  4673    ;wc                                    IX-8    
                           A  4674    ;s                                     IX-6    
                           A  4675    ;i                                     IX-3    
                           A  4676    ;dir                                   IX+9    
                           A  4677    ;lfnbuf                                IX+6    
                           A  4678    
                           A  4679    
                           A  4680    ; Stack Frame Size: 26 (bytes)
                           A  4681    ;       Spill Code: 0 (instruction)
                           A  4682    
                           A  4683    
                           A  4684    .ENDFUNC "cmp_lfn",1882,"_cmp_lfn"
                           A  4685    ; 1883	
                           A  4686    ; 1884	
                           A  4687    ; 1885	#if FF_FS_MINIMIZE <= 1 || FF_FS_RPATH 
                           A  4688    ; 1886	/*-------------------------------------
                           A  4689    ; 1887	/* FAT-LFN: Pick a part of file name fr
                           A  4690    ; 1888	/*-------------------------------------
                           A  4691    ; 1889	
                           A  4692    ; 1890	static int pick_lfn (	/* 1:succeeded,
                           A  4693    ; 1891		WCHAR* lfnbuf,		/* Pointer to t
                           A  4694    ; 1892		BYTE* dir			/* Pointer to t
                           A  4695    ; 1893	)
                           A  4696    ; 1894	{
041A61                     A  4697    _pick_lfn:
                           A  4698    .DEFINE "_pick_lfn"
                           A  4699    
                           A  4700    .VALUE _pick_lfn
                           A  4701    
                           A  4702    .CLASS 3
                           A  4703    
                           A  4704    .TYPE 68
                           A  4705    
                           A  4706    .ENDEF
                           A  4707    
                           A  4708    .BEGFUNC "pick_lfn",1894,"_pick_lfn"
                           A  4709    
                           A  4710    .LINE 1894
                           A  4711    
                           A  4712    .DEFINE "lfnbuf"
                           A  4713    
                           A  4714    .CLASS 65
                           A  4715    
                           A  4716    .VALUE 6
                           A  4717    
                           A  4718    .TYPE 45
                           A  4719    
                           A  4720    .ENDEF
                           A  4721    
                           A  4722    .DEFINE "dir"
                           A  4723    
                           A  4724    .CLASS 65
                           A  4725    
                           A  4726    .VALUE 9
                           A  4727    
                           A  4728    .TYPE 44
                           A  4729    
                           A  4730    .ENDEF
                           A  4731    
                           A  4732    .DEFINE "i"
                           A  4733    
                           A  4734    .CLASS 65
                           A  4735    
                           A  4736    .VALUE -3
                           A  4737    
                           A  4738    .TYPE 14
                           A  4739    
                           A  4740    .ENDEF
                           A  4741    
                           A  4742    .DEFINE "s"
                           A  4743    
                           A  4744    .CLASS 65
                           A  4745    
                           A  4746    .VALUE -6
                           A  4747    
                           A  4748    .TYPE 14
                           A  4749    
                           A  4750    .ENDEF
                           A  4751    
                           A  4752    .DEFINE "wc"
                           A  4753    
                           A  4754    .CLASS 65
                           A  4755    
                           A  4756    .VALUE -8
                           A  4757    
                           A  4758    .TYPE 13
                           A  4759    
                           A  4760    .ENDEF
                           A  4761    
                           A  4762    .DEFINE "uc"
                           A  4763    
                           A  4764    .CLASS 65
                           A  4765    
                           A  4766    .VALUE -10
                           A  4767    
                           A  4768    .TYPE 13
                           A  4769    
                           A  4770    .ENDEF
                           A  4771    
041A61 DDE5                A  4772    	PUSH	IX
041A63 DD210000 00         A  4773    	LD	IX,0
041A68 DD39                A  4774    	ADD	IX,SP
041A6A C5                  A  4775    	PUSH	BC
041A6B C5                  A  4776    	PUSH	BC
041A6C C5                  A  4777    	PUSH	BC
041A6D 3B                  A  4778    	DEC	SP
                           A  4779    ; 1895		UINT i, s;
                           A  4780    ; 1896		WCHAR wc, uc;
                           A  4781    ; 1897	
                           A  4782    ; 1898	
                           A  4783    ; 1899		if (ld_word(dir + LDIR_FstClusLO) !
                           A  4784    .LINE 1899
                           A  4785    
041A6E DD3109              A  4786    	LD	IY,(IX+%9)
041A71 ED031A              A  4787    	LEA	BC,IY+%1A
041A74 C5                  A  4788    	PUSH	BC
041A75 CD 25 0F 04         A  4789    	CALL	_ld_word
041A79 C1                  A  4790    	POP	BC
041A7A CD D8 47 04         A  4791    	CALL	__scmpzero
041A7E 28 07               A  4792    	JR	Z,L_126
041A80 B7                  A  4793    	OR	A,A
041A81 ED62                A  4794    	SBC	HL,HL
041A83 C3 5E 1B 04         A  4795    	JR	L_143
041A87                     A  4796    L_126:
                           A  4797    ; 1900	
                           A  4798    ; 1901		i = ((dir[LDIR_Ord] & ~LLEF) - 1) *
                           A  4799    .LINE 1901
                           A  4800    
041A87 DD2709              A  4801    	LD	HL,(IX+%9)
041A8A 7E                  A  4802    	LD	A,(HL)
041A8B CBB7                A  4803    	RES	%6,A
041A8D B7ED62              A  4804    	UEXT	HL
041A90 6F                  A  4805    	LD	L,A
041A91 2B                  A  4806    	DEC	HL
041A92 3E0D                A  4807    	LD	A,%D
041A94 CD 4B 48 04         A  4808    	CALL	__imul_b
041A98 DD2FFD              A  4809    	LD	(IX+%FFFFFFFD),HL
                           A  4810    ; 1902	
                           A  4811    ; 1903		for (wc = 1, s = 0; s < 13; s++) {	
                           A  4812    .LINE 1903
                           A  4813    
041A9B DD36F801            A  4814    	LD	(IX+%FFFFFFF8),%1
041A9F DD36F900            A  4815    	LD	(IX+%FFFFFFF9),%0
041AA3 01000000            A  4816    	LD	BC,0
041AA7 DD0FFA              A  4817    	LD	(IX+%FFFFFFFA),BC
041AAA 18 73               A  4818    	JR	L_136
041AAC                     A  4819    L_134:
                           A  4820    ; 1904			uc = ld_word(dir + LfnOfs[s]);	
                           A  4821    .LINE 1904
                           A  4822    
041AAC 01 E1 4C 04         A  4823    	LD	BC,_LfnOfs
041AB0 DD27FA              A  4824    	LD	HL,(IX+%FFFFFFFA)
041AB3 09                  A  4825    	ADD	HL,BC
041AB4 7E                  A  4826    	LD	A,(HL)
041AB5 B7ED62              A  4827    	UEXT	HL
041AB8 6F                  A  4828    	LD	L,A
041AB9 DD0709              A  4829    	LD	BC,(IX+%9)
041ABC 09                  A  4830    	ADD	HL,BC
041ABD E5                  A  4831    	PUSH	HL
041ABE CD 25 0F 04         A  4832    	CALL	_ld_word
041AC2 C1                  A  4833    	POP	BC
041AC3 DD75F6              A  4834    	LD	(IX+%FFFFFFF6),L
041AC6 DD74F7              A  4835    	LD	(IX+%FFFFFFF7),H
                           A  4836    ; 1905			if (wc != 0) {
                           A  4837    .LINE 1905
                           A  4838    
041AC9 DD27F8              A  4839    	LD	HL,(IX+%FFFFFFF8)
041ACC CD D8 47 04         A  4840    	CALL	__scmpzero
041AD0 28 34               A  4841    	JR	Z,L_133
                           A  4842    ; 1906				if (i >= FF_MAX_LFN + 1) re
                           A  4843    .LINE 1906
                           A  4844    
041AD2 01000100            A  4845    	LD	BC,256
041AD6 DD27FD              A  4846    	LD	HL,(IX+%FFFFFFFD)
041AD9 B7                  A  4847    	OR	A,A
041ADA ED42                A  4848    	SBC	HL,BC
041ADC 38 05               A  4849    	JR	C,L_130
041ADE B7                  A  4850    	OR	A,A
041ADF ED62                A  4851    	SBC	HL,HL
041AE1 18 7B               A  4852    	JR	L_143
041AE3                     A  4853    L_130:
                           A  4854    ; 1907				lfnbuf[i++] = wc = uc;		
                           A  4855    .LINE 1907
                           A  4856    
041AE3 DD07F6              A  4857    	LD	BC,(IX+%FFFFFFF6)
041AE6 DD71F8              A  4858    	LD	(IX+%FFFFFFF8),C
041AE9 DD70F9              A  4859    	LD	(IX+%FFFFFFF9),B
041AEC DD27FD              A  4860    	LD	HL,(IX+%FFFFFFFD)
041AEF 29                  A  4861    	ADD	HL,HL
041AF0 DD0706              A  4862    	LD	BC,(IX+%6)
041AF3 09                  A  4863    	ADD	HL,BC
041AF4 DD7EF6              A  4864    	LD	A,(IX+%FFFFFFF6)
041AF7 77                  A  4865    	LD	(HL),A
041AF8 23                  A  4866    	INC	HL
041AF9 DD7EF7              A  4867    	LD	A,(IX+%FFFFFFF7)
041AFC 77                  A  4868    	LD	(HL),A
041AFD DD07FD              A  4869    	LD	BC,(IX+%FFFFFFFD)
041B00 03                  A  4870    	INC	BC
041B01 DD0FFD              A  4871    	LD	(IX+%FFFFFFFD),BC
                           A  4872    ; 1908			} else {
                           A  4873    .LINE 1908
                           A  4874    
041B04 18 12               A  4875    	JR	L_135
041B06                     A  4876    L_133:
                           A  4877    ; 1909				if (uc != 0xFFFF) return 0;
                           A  4878    .LINE 1909
                           A  4879    
041B06 4901FFFF            A  4880    	LD.LIS	BC,65535
041B0A DD27F6              A  4881    	LD	HL,(IX+%FFFFFFF6)
041B0D B7                  A  4882    	OR	A,A
041B0E 40ED42              A  4883    	SBC.SIS	HL,BC
041B11 28 05               A  4884    	JR	Z,L_135
041B13 B7                  A  4885    	OR	A,A
041B14 ED62                A  4886    	SBC	HL,HL
041B16 18 46               A  4887    	JR	L_143
                           A  4888    ; 1910			}
                           A  4889    ; 1911		}
041B18                     A  4890    L_135:
                           A  4891    .LINE 1911
                           A  4892    
041B18 DD07FA              A  4893    	LD	BC,(IX+%FFFFFFFA)
041B1B 03                  A  4894    	INC	BC
041B1C DD0FFA              A  4895    	LD	(IX+%FFFFFFFA),BC
041B1F                     A  4896    L_136:
041B1F 010D0000            A  4897    	LD	BC,13
041B23 DD27FA              A  4898    	LD	HL,(IX+%FFFFFFFA)
041B26 B7                  A  4899    	OR	A,A
041B27 ED42                A  4900    	SBC	HL,BC
041B29 38 81               A  4901    	JR	C,L_134
                           A  4902    ; 1912	
                           A  4903    ; 1913		if (dir[LDIR_Ord] & LLEF && wc != 0
                           A  4904    .LINE 1913
                           A  4905    
041B2B DD2709              A  4906    	LD	HL,(IX+%9)
041B2E 7E                  A  4907    	LD	A,(HL)
041B2F E640                A  4908    	AND	A,%40
041B31 28 27               A  4909    	JR	Z,L_142
041B33 DD27F8              A  4910    	LD	HL,(IX+%FFFFFFF8)
041B36 CD D8 47 04         A  4911    	CALL	__scmpzero
041B3A 28 1E               A  4912    	JR	Z,L_142
                           A  4913    ; 1914			if (i >= FF_MAX_LFN + 1) return
                           A  4914    .LINE 1914
                           A  4915    
041B3C 01000100            A  4916    	LD	BC,256
041B40 DD27FD              A  4917    	LD	HL,(IX+%FFFFFFFD)
041B43 B7                  A  4918    	OR	A,A
041B44 ED42                A  4919    	SBC	HL,BC
041B46 38 05               A  4920    	JR	C,L_139
041B48 B7                  A  4921    	OR	A,A
041B49 ED62                A  4922    	SBC	HL,HL
041B4B 18 11               A  4923    	JR	L_143
041B4D                     A  4924    L_139:
                           A  4925    ; 1915			lfnbuf[i] = 0;
                           A  4926    .LINE 1915
                           A  4927    
041B4D DD27FD              A  4928    	LD	HL,(IX+%FFFFFFFD)
041B50 29                  A  4929    	ADD	HL,HL
041B51 DD0706              A  4930    	LD	BC,(IX+%6)
041B54 09                  A  4931    	ADD	HL,BC
041B55 3600                A  4932    	LD	(HL),%0
041B57 23                  A  4933    	INC	HL
041B58 3600                A  4934    	LD	(HL),%0
                           A  4935    ; 1916		}
041B5A                     A  4936    L_142:
                           A  4937    .LINE 1916
                           A  4938    
                           A  4939    ; 1917	
                           A  4940    ; 1918		return 1;		/* The part of LFN 
                           A  4941    .LINE 1918
                           A  4942    
041B5A 21010000            A  4943    	LD	HL,1
                           A  4944    ; 1919	}
041B5E                     A  4945    L_143:
                           A  4946    .LINE 1919
                           A  4947    
041B5E DDF9                A  4948    	LD	SP,IX
041B60 DDE1                A  4949    	POP	IX
041B62 C9                  A  4950    	RET	
                           A  4951    
                           A  4952    
                           A  4953    ;**************************** _pick_lfn *******
                           A  4954    ;Name                         Addr/Register   S
                           A  4955    ;_LfnOfs                             STATIC    
                           A  4956    ;uc                                   IX-10    
                           A  4957    ;wc                                    IX-8    
                           A  4958    ;s                                     IX-6    
                           A  4959    ;i                                     IX-3    
                           A  4960    ;dir                                   IX+9    
                           A  4961    ;lfnbuf                                IX+6    
                           A  4962    
                           A  4963    
                           A  4964    ; Stack Frame Size: 22 (bytes)
                           A  4965    ;       Spill Code: 0 (instruction)
                           A  4966    
                           A  4967    
                           A  4968    .ENDFUNC "pick_lfn",1919,"_pick_lfn"
                           A  4969    ; 1920	#endif
                           A  4970    ; 1921	
                           A  4971    ; 1922	
                           A  4972    ; 1923	#if !FF_FS_READONLY
                           A  4973    ; 1924	/*-------------------------------------
                           A  4974    ; 1925	/* FAT-LFN: Create an entry of LFN entr
                           A  4975    ; 1926	/*-------------------------------------
                           A  4976    ; 1927	
                           A  4977    ; 1928	static void put_lfn (
                           A  4978    ; 1929		const WCHAR* lfn,	/* Pointer to t
                           A  4979    ; 1930		BYTE* dir,			/* Pointer to t
                           A  4980    ; 1931		BYTE ord,			/* LFN order (1
                           A  4981    ; 1932		BYTE sum			/* Checksum of 
                           A  4982    ; 1933	)
                           A  4983    ; 1934	{
                           A  4984    ; 1935		UINT i, s;
                           A  4985    ; 1936		WCHAR wc;
                           A  4986    ; 1937	
                           A  4987    ; 1938	
                           A  4988    ; 1939		dir[LDIR_Chksum] = sum;			/* 
                           A  4989    ; 1940		dir[LDIR_Attr] = AM_LFN;		/* 
                           A  4990    ; 1941		dir[LDIR_Type] = 0;
                           A  4991    ; 1942		st_word(dir + LDIR_FstClusLO, 0);
                           A  4992    ; 1943	
                           A  4993    ; 1944		i = (ord - 1) * 13;				/* 
                           A  4994    ; 1945		s = wc = 0;
                           A  4995    ; 1946		do {
                           A  4996    ; 1947			if (wc != 0xFFFF) wc = lfn[i++]
                           A  4997    ; 1948			st_word(dir + LfnOfs[s], wc);	
                           A  4998    ; 1949			if (wc == 0) wc = 0xFFFF;		
                           A  4999    ; 1950		} while (++s < 13);
                           A  5000    ; 1951		if (wc == 0xFFFF || !lfn[i]) ord |=
                           A  5001    ; 1952		dir[LDIR_Ord] = ord;			/* 
                           A  5002    ; 1953	}
                           A  5003    ; 1954	
                           A  5004    ; 1955	#endif	/* !FF_FS_READONLY */
                           A  5005    ; 1956	#endif	/* FF_USE_LFN */
                           A  5006    ; 1957	
                           A  5007    ; 1958	
                           A  5008    ; 1959	
                           A  5009    ; 1960	#if FF_USE_LFN && !FF_FS_READONLY
                           A  5010    ; 1961	/*-------------------------------------
                           A  5011    ; 1962	/* FAT-LFN: Create a Numbered SFN      
                           A  5012    ; 1963	/*-------------------------------------
                           A  5013    ; 1964	
                           A  5014    ; 1965	static void gen_numname (
                           A  5015    ; 1966		BYTE* dst,			/* Pointer to t
                           A  5016    ; 1967		const BYTE* src,	/* Pointer to S
                           A  5017    ; 1968		const WCHAR* lfn,	/* Pointer to L
                           A  5018    ; 1969		UINT seq			/* Sequence num
                           A  5019    ; 1970	)
                           A  5020    ; 1971	{
                           A  5021    ; 1972		BYTE ns[8], c;
                           A  5022    ; 1973		UINT i, j;
                           A  5023    ; 1974		WCHAR wc;
                           A  5024    ; 1975		DWORD sreg;
                           A  5025    ; 1976	
                           A  5026    ; 1977	
                           A  5027    ; 1978		memcpy(dst, src, 11);	/* Prepare 
                           A  5028    ; 1979	
                           A  5029    ; 1980		if (seq > 5) {	/* In case of many 
                           A  5030    ; 1981			sreg = seq;
                           A  5031    ; 1982			while (*lfn) {	/* Create a CRC
                           A  5032    ; 1983				wc = *lfn++;
                           A  5033    ; 1984				for (i = 0; i < 16; i++) {
                           A  5034    ; 1985					sreg = (sreg << 1) + (w
                           A  5035    ; 1986					wc >>= 1;
                           A  5036    ; 1987					if (sreg & 0x10000) sre
                           A  5037    ; 1988				}
                           A  5038    ; 1989			}
                           A  5039    ; 1990			seq = (UINT)sreg;
                           A  5040    ; 1991		}
                           A  5041    ; 1992	
                           A  5042    ; 1993		/* Make suffix (~ + hexdecimal) */
                           A  5043    ; 1994		i = 7;
                           A  5044    ; 1995		do {
                           A  5045    ; 1996			c = (BYTE)((seq % 16) + '0'); s
                           A  5046    ; 1997			if (c > '9') c += 7;
                           A  5047    ; 1998			ns[i--] = c;
                           A  5048    ; 1999		} while (i && seq);
                           A  5049    ; 2000		ns[i] = '~';
                           A  5050    ; 2001	
                           A  5051    ; 2002		/* Append the suffix to the SFN bod
                           A  5052    ; 2003		for (j = 0; j < i && dst[j] != ' ';
                           A  5053    ; 2004			if (dbc_1st(dst[j])) {	/* To a
                           A  5054    ; 2005				if (j == i - 1) break;
                           A  5055    ; 2006				j++;
                           A  5056    ; 2007			}
                           A  5057    ; 2008		}
                           A  5058    ; 2009		do {	/* Append the suffix */
                           A  5059    ; 2010			dst[j++] = (i < 8) ? ns[i++] : 
                           A  5060    ; 2011		} while (j < 8);
                           A  5061    ; 2012	}
                           A  5062    ; 2013	#endif	/* FF_USE_LFN && !FF_FS_READONL
                           A  5063    ; 2014	
                           A  5064    ; 2015	
                           A  5065    ; 2016	
                           A  5066    ; 2017	#if FF_USE_LFN
                           A  5067    ; 2018	/*-------------------------------------
                           A  5068    ; 2019	/* FAT-LFN: Calculate checksum of an SF
                           A  5069    ; 2020	/*-------------------------------------
                           A  5070    ; 2021	
                           A  5071    ; 2022	static BYTE sum_sfn (
                           A  5072    ; 2023		const BYTE* dir		/* Pointer to t
                           A  5073    ; 2024	)
                           A  5074    ; 2025	{
041B63                     A  5075    _sum_sfn:
                           A  5076    .DEFINE "_sum_sfn"
                           A  5077    
                           A  5078    .VALUE _sum_sfn
                           A  5079    
                           A  5080    .CLASS 3
                           A  5081    
                           A  5082    .TYPE 76
                           A  5083    
                           A  5084    .ENDEF
                           A  5085    
                           A  5086    .BEGFUNC "sum_sfn",2025,"_sum_sfn"
                           A  5087    
                           A  5088    .LINE 2025
                           A  5089    
                           A  5090    .DEFINE "dir"
                           A  5091    
                           A  5092    .CLASS 65
                           A  5093    
                           A  5094    .VALUE 6
                           A  5095    
                           A  5096    .TYPE 204
                           A  5097    
                           A  5098    .ENDEF
                           A  5099    
                           A  5100    .DEFINE "sum"
                           A  5101    
                           A  5102    .CLASS 65
                           A  5103    
                           A  5104    .VALUE -1
                           A  5105    
                           A  5106    .TYPE 12
                           A  5107    
                           A  5108    .ENDEF
                           A  5109    
                           A  5110    .DEFINE "n"
                           A  5111    
                           A  5112    .CLASS 65
                           A  5113    
                           A  5114    .VALUE -4
                           A  5115    
                           A  5116    .TYPE 14
                           A  5117    
                           A  5118    .ENDEF
                           A  5119    
041B63 DDE5                A  5120    	PUSH	IX
041B65 DD210000 00         A  5121    	LD	IX,0
041B6A DD39                A  5122    	ADD	IX,SP
041B6C C5                  A  5123    	PUSH	BC
041B6D 3B                  A  5124    	DEC	SP
                           A  5125    ; 2026		BYTE sum = 0;
                           A  5126    .LINE 2026
                           A  5127    
041B6E DD36FF00            A  5128    	LD	(IX+%FFFFFFFF),%0
                           A  5129    ; 2027		UINT n = 11;
                           A  5130    .LINE 2027
                           A  5131    
041B72 010B0000            A  5132    	LD	BC,11
041B76 DD0FFC              A  5133    	LD	(IX+%FFFFFFFC),BC
                           A  5134    ; 2028	
                           A  5135    ; 2029		do {
041B79                     A  5136    L_145:
                           A  5137    .LINE 2029
                           A  5138    
                           A  5139    ; 2030			sum = (sum >> 1) + (sum << 7) +
                           A  5140    .LINE 2030
                           A  5141    
041B79 DD7EFF              A  5142    	LD	A,(IX+%FFFFFFFF)
041B7C B7ED62              A  5143    	UEXT	HL
041B7F 6F                  A  5144    	LD	L,A
041B80 3E01                A  5145    	LD	A,%1
041B82 CD E3 44 04         A  5146    	CALL	__ishrs_b
041B86 0607                A  5147    	LD	B,%7
041B88 DD7EFF              A  5148    	LD	A,(IX+%FFFFFFFF)
041B8B CD 2A 49 04         A  5149    	CALL	__bshl
041B8F 47                  A  5150    	LD	B,A
041B90 7D                  A  5151    	LD	A,L
041B91 80                  A  5152    	ADD	A,B
041B92 DD2706              A  5153    	LD	HL,(IX+%6)
041B95 86                  A  5154    	ADD	A,(HL)
041B96 DD77FF              A  5155    	LD	(IX+%FFFFFFFF),A
041B99 DD0706              A  5156    	LD	BC,(IX+%6)
041B9C 03                  A  5157    	INC	BC
041B9D DD0F06              A  5158    	LD	(IX+%6),BC
                           A  5159    ; 2031		} while (--n);
                           A  5160    .LINE 2031
                           A  5161    
041BA0 DD31FC              A  5162    	LD	IY,(IX+%FFFFFFFC)
041BA3 ED33FF              A  5163    	LEA	IY,IY+%FFFFFFFF
041BA6 DD3EFC              A  5164    	LD	(IX+%FFFFFFFC),IY
041BA9 DD27FC              A  5165    	LD	HL,(IX+%FFFFFFFC)
041BAC CD E5 46 04         A  5166    	CALL	__icmpzero
041BB0 20 C7               A  5167    	JR	NZ,L_145
                           A  5168    ; 2032		return sum;
                           A  5169    .LINE 2032
                           A  5170    
041BB2 DD7EFF              A  5171    	LD	A,(IX+%FFFFFFFF)
                           A  5172    ; 2033	}
                           A  5173    .LINE 2033
                           A  5174    
041BB5 DDF9                A  5175    	LD	SP,IX
041BB7 DDE1                A  5176    	POP	IX
041BB9 C9                  A  5177    	RET	
                           A  5178    
                           A  5179    
                           A  5180    ;**************************** _sum_sfn ********
                           A  5181    ;Name                         Addr/Register   S
                           A  5182    ;n                                     IX-4    
                           A  5183    ;sum                                   IX-1    
                           A  5184    ;dir                                   IX+6    
                           A  5185    
                           A  5186    
                           A  5187    ; Stack Frame Size: 13 (bytes)
                           A  5188    ;       Spill Code: 0 (instruction)
                           A  5189    
                           A  5190    
                           A  5191    .ENDFUNC "sum_sfn",2033,"_sum_sfn"
                           A  5192    ; 2034	
                           A  5193    ; 2035	#endif	/* FF_USE_LFN */
                           A  5194    ; 2036	
                           A  5195    ; 2037	
                           A  5196    ; 2038	
                           A  5197    ; 2039	#if FF_FS_EXFAT
                           A  5198    ; 2040	/*-------------------------------------
                           A  5199    ; 2041	/* exFAT: Checksum                     
                           A  5200    ; 2042	/*-------------------------------------
                           A  5201    ; 2043	
                           A  5202    ; 2044	static WORD xdir_sum (	/* Get checksum
                           A  5203    ; 2045		const BYTE* dir		/* Directory en
                           A  5204    ; 2046	)
                           A  5205    ; 2047	{
                           A  5206    ; 2048		UINT i, szblk;
                           A  5207    ; 2049		WORD sum;
                           A  5208    ; 2050	
                           A  5209    ; 2051	
                           A  5210    ; 2052		szblk = (dir[XDIR_NumSec] + 1) * SZ
                           A  5211    ; 2053		for (i = sum = 0; i < szblk; i++) {
                           A  5212    ; 2054			if (i == XDIR_SetSum) {	/* Skip
                           A  5213    ; 2055				i++;
                           A  5214    ; 2056			} else {
                           A  5215    ; 2057				sum = ((sum & 1) ? 0x8000 :
                           A  5216    ; 2058			}
                           A  5217    ; 2059		}
                           A  5218    ; 2060		return sum;
                           A  5219    ; 2061	}
                           A  5220    ; 2062	
                           A  5221    ; 2063	
                           A  5222    ; 2064	
                           A  5223    ; 2065	static WORD xname_sum (	/* Get check su
                           A  5224    ; 2066		const WCHAR* name	/* File name to
                           A  5225    ; 2067	)
                           A  5226    ; 2068	{
                           A  5227    ; 2069		WCHAR chr;
                           A  5228    ; 2070		WORD sum = 0;
                           A  5229    ; 2071	
                           A  5230    ; 2072	
                           A  5231    ; 2073		while ((chr = *name++) != 0) {
                           A  5232    ; 2074			chr = (WCHAR)ff_wtoupper(chr);	
                           A  5233    ; 2075			sum = ((sum & 1) ? 0x8000 : 0) 
                           A  5234    ; 2076			sum = ((sum & 1) ? 0x8000 : 0) 
                           A  5235    ; 2077		}
                           A  5236    ; 2078		return sum;
                           A  5237    ; 2079	}
                           A  5238    ; 2080	
                           A  5239    ; 2081	
                           A  5240    ; 2082	#if !FF_FS_READONLY && FF_USE_MKFS
                           A  5241    ; 2083	static DWORD xsum32 (	/* Returns 32-b
                           A  5242    ; 2084		BYTE  dat,			/* Byte to be c
                           A  5243    ; 2085		DWORD sum			/* Previous sum
                           A  5244    ; 2086	)
                           A  5245    ; 2087	{
                           A  5246    ; 2088		sum = ((sum & 1) ? 0x80000000 : 0) 
                           A  5247    ; 2089		return sum;
                           A  5248    ; 2090	}
                           A  5249    ; 2091	#endif
                           A  5250    ; 2092	
                           A  5251    ; 2093	
                           A  5252    ; 2094	
                           A  5253    ; 2095	/*-----------------------------------*/
                           A  5254    ; 2096	/* exFAT: Get a directry entry block */
                           A  5255    ; 2097	/*-----------------------------------*/
                           A  5256    ; 2098	
                           A  5257    ; 2099	static FRESULT load_xdir (	/* FR_INT_E
                           A  5258    ; 2100		DIR* dp					/* Reading 
                           A  5259    ; 2101	)
                           A  5260    ; 2102	{
                           A  5261    ; 2103		FRESULT res;
                           A  5262    ; 2104		UINT i, sz_ent;
                           A  5263    ; 2105		BYTE *dirb = dp->obj.fs->dirbuf;	
                           A  5264    ; 2106	
                           A  5265    ; 2107	
                           A  5266    ; 2108		/* Load file directory entry */
                           A  5267    ; 2109		res = move_window(dp->obj.fs, dp->s
                           A  5268    ; 2110		if (res != FR_OK) return res;
                           A  5269    ; 2111		if (dp->dir[XDIR_Type] != ET_FILEDI
                           A  5270    ; 2112		memcpy(dirb + 0 * SZDIRE, dp->dir, 
                           A  5271    ; 2113		sz_ent = (dirb[XDIR_NumSec] + 1) * 
                           A  5272    ; 2114		if (sz_ent < 3 * SZDIRE || sz_ent >
                           A  5273    ; 2115	
                           A  5274    ; 2116		/* Load stream extension entry */
                           A  5275    ; 2117		res = dir_next(dp, 0);
                           A  5276    ; 2118		if (res == FR_NO_FILE) res = FR_INT
                           A  5277    ; 2119		if (res != FR_OK) return res;
                           A  5278    ; 2120		res = move_window(dp->obj.fs, dp->s
                           A  5279    ; 2121		if (res != FR_OK) return res;
                           A  5280    ; 2122		if (dp->dir[XDIR_Type] != ET_STREAM
                           A  5281    ; 2123		memcpy(dirb + 1 * SZDIRE, dp->dir, 
                           A  5282    ; 2124		if (MAXDIRB(dirb[XDIR_NumName]) > s
                           A  5283    ; 2125	
                           A  5284    ; 2126		/* Load file name entries */
                           A  5285    ; 2127		i = 2 * SZDIRE;	/* Name offset to l
                           A  5286    ; 2128		do {
                           A  5287    ; 2129			res = dir_next(dp, 0);
                           A  5288    ; 2130			if (res == FR_NO_FILE) res = FR
                           A  5289    ; 2131			if (res != FR_OK) return res;
                           A  5290    ; 2132			res = move_window(dp->obj.fs, d
                           A  5291    ; 2133			if (res != FR_OK) return res;
                           A  5292    ; 2134			if (dp->dir[XDIR_Type] != ET_FI
                           A  5293    ; 2135			if (i < MAXDIRB(FF_MAX_LFN)) me
                           A  5294    ; 2136		} while ((i += SZDIRE) < sz_ent);
                           A  5295    ; 2137	
                           A  5296    ; 2138		/* Sanity check (do it for only acc
                           A  5297    ; 2139		if (i <= MAXDIRB(FF_MAX_LFN)) {
                           A  5298    ; 2140			if (xdir_sum(dirb) != ld_word(d
                           A  5299    ; 2141		}
                           A  5300    ; 2142		return FR_OK;
                           A  5301    ; 2143	}
                           A  5302    ; 2144	
                           A  5303    ; 2145	
                           A  5304    ; 2146	/*-------------------------------------
                           A  5305    ; 2147	/* exFAT: Initialize object allocation 
                           A  5306    ; 2148	/*-------------------------------------
                           A  5307    ; 2149	
                           A  5308    ; 2150	static void init_alloc_info (
                           A  5309    ; 2151		FATFS* fs,		/* Filesystem objec
                           A  5310    ; 2152		FFOBJID* obj	/* Object allocatio
                           A  5311    ; 2153	)
                           A  5312    ; 2154	{
                           A  5313    ; 2155		obj->sclust = ld_dword(fs->dirbuf +
                           A  5314    ; 2156		obj->objsize = ld_qword(fs->dirbuf 
                           A  5315    ; 2157		obj->stat = fs->dirbuf[XDIR_GenFlag
                           A  5316    ; 2158		obj->n_frag = 0;					
                           A  5317    ; 2159	}
                           A  5318    ; 2160	
                           A  5319    ; 2161	
                           A  5320    ; 2162	
                           A  5321    ; 2163	#if !FF_FS_READONLY || FF_FS_RPATH != 0
                           A  5322    ; 2164	/*-------------------------------------
                           A  5323    ; 2165	/* exFAT: Load the object's directory e
                           A  5324    ; 2166	/*-------------------------------------
                           A  5325    ; 2167	
                           A  5326    ; 2168	static FRESULT load_obj_xdir (
                           A  5327    ; 2169		DIR* dp,			/* Blank direct
                           A  5328    ; 2170		const FFOBJID* obj	/* Object with 
                           A  5329    ; 2171	)
                           A  5330    ; 2172	{
                           A  5331    ; 2173		FRESULT res;
                           A  5332    ; 2174	
                           A  5333    ; 2175		/* Open object containing directory
                           A  5334    ; 2176		dp->obj.fs = obj->fs;
                           A  5335    ; 2177		dp->obj.sclust = obj->c_scl;
                           A  5336    ; 2178		dp->obj.stat = (BYTE)obj->c_size;
                           A  5337    ; 2179		dp->obj.objsize = obj->c_size & 0xF
                           A  5338    ; 2180		dp->obj.n_frag = 0;
                           A  5339    ; 2181		dp->blk_ofs = obj->c_ofs;
                           A  5340    ; 2182	
                           A  5341    ; 2183		res = dir_sdi(dp, dp->blk_ofs);	/* 
                           A  5342    ; 2184		if (res == FR_OK) {
                           A  5343    ; 2185			res = load_xdir(dp);		/* 
                           A  5344    ; 2186		}
                           A  5345    ; 2187		return res;
                           A  5346    ; 2188	}
                           A  5347    ; 2189	#endif
                           A  5348    ; 2190	
                           A  5349    ; 2191	
                           A  5350    ; 2192	#if !FF_FS_READONLY
                           A  5351    ; 2193	/*-------------------------------------
                           A  5352    ; 2194	/* exFAT: Store the directory entry blo
                           A  5353    ; 2195	/*-------------------------------------
                           A  5354    ; 2196	
                           A  5355    ; 2197	static FRESULT store_xdir (
                           A  5356    ; 2198		DIR* dp				/* Pointer to t
                           A  5357    ; 2199	)
                           A  5358    ; 2200	{
                           A  5359    ; 2201		FRESULT res;
                           A  5360    ; 2202		UINT nent;
                           A  5361    ; 2203		BYTE *dirb = dp->obj.fs->dirbuf;	
                           A  5362    ; 2204	
                           A  5363    ; 2205		/* Create set sum */
                           A  5364    ; 2206		st_word(dirb + XDIR_SetSum, xdir_su
                           A  5365    ; 2207		nent = dirb[XDIR_NumSec] + 1;
                           A  5366    ; 2208	
                           A  5367    ; 2209		/* Store the direcotry entry block 
                           A  5368    ; 2210		res = dir_sdi(dp, dp->blk_ofs);
                           A  5369    ; 2211		while (res == FR_OK) {
                           A  5370    ; 2212			res = move_window(dp->obj.fs, d
                           A  5371    ; 2213			if (res != FR_OK) break;
                           A  5372    ; 2214			memcpy(dp->dir, dirb, SZDIRE);
                           A  5373    ; 2215			dp->obj.fs->wflag = 1;
                           A  5374    ; 2216			if (--nent == 0) break;
                           A  5375    ; 2217			dirb += SZDIRE;
                           A  5376    ; 2218			res = dir_next(dp, 0);
                           A  5377    ; 2219		}
                           A  5378    ; 2220		return (res == FR_OK || res == FR_D
                           A  5379    ; 2221	}
                           A  5380    ; 2222	
                           A  5381    ; 2223	
                           A  5382    ; 2224	
                           A  5383    ; 2225	/*-------------------------------------
                           A  5384    ; 2226	/* exFAT: Create a new directory enrty 
                           A  5385    ; 2227	/*-------------------------------------
                           A  5386    ; 2228	
                           A  5387    ; 2229	static void create_xdir (
                           A  5388    ; 2230		BYTE* dirb,			/* Pointer to t
                           A  5389    ; 2231		const WCHAR* lfn	/* Pointer to t
                           A  5390    ; 2232	)
                           A  5391    ; 2233	{
                           A  5392    ; 2234		UINT i;
                           A  5393    ; 2235		BYTE nc1, nlen;
                           A  5394    ; 2236		WCHAR wc;
                           A  5395    ; 2237	
                           A  5396    ; 2238	
                           A  5397    ; 2239		/* Create file-directory and stream
                           A  5398    ; 2240		memset(dirb, 0, 2 * SZDIRE);
                           A  5399    ; 2241		dirb[0 * SZDIRE + XDIR_Type] = ET_F
                           A  5400    ; 2242		dirb[1 * SZDIRE + XDIR_Type] = ET_S
                           A  5401    ; 2243	
                           A  5402    ; 2244		/* Create file-name entries */
                           A  5403    ; 2245		i = SZDIRE * 2;	/* Top of file_name
                           A  5404    ; 2246		nlen = nc1 = 0; wc = 1;
                           A  5405    ; 2247		do {
                           A  5406    ; 2248			dirb[i++] = ET_FILENAME; dirb[i
                           A  5407    ; 2249			do {	/* Fill name field */
                           A  5408    ; 2250				if (wc != 0 && (wc = lfn[nl
                           A  5409    ; 2251				st_word(dirb + i, wc); 	/* 
                           A  5410    ; 2252				i += 2;
                           A  5411    ; 2253			} while (i % SZDIRE != 0);
                           A  5412    ; 2254			nc1++;
                           A  5413    ; 2255		} while (lfn[nlen]);	/* Fill nex
                           A  5414    ; 2256	
                           A  5415    ; 2257		dirb[XDIR_NumName] = nlen;		/* 
                           A  5416    ; 2258		dirb[XDIR_NumSec] = 1 + nc1;	/* 
                           A  5417    ; 2259		st_word(dirb + XDIR_NameHash, xname
                           A  5418    ; 2260	}
                           A  5419    ; 2261	
                           A  5420    ; 2262	#endif	/* !FF_FS_READONLY */
                           A  5421    ; 2263	#endif	/* FF_FS_EXFAT */
                           A  5422    ; 2264	
                           A  5423    ; 2265	
                           A  5424    ; 2266	
                           A  5425    ; 2267	#if FF_FS_MINIMIZE <= 1 || FF_FS_RPATH 
                           A  5426    ; 2268	/*-------------------------------------
                           A  5427    ; 2269	/* Read an object from the directory   
                           A  5428    ; 2270	/*-------------------------------------
                           A  5429    ; 2271	
                           A  5430    ; 2272	#define DIR_READ_FILE(dp) dir_read(dp, 
                           A  5431    ; 2273	#define DIR_READ_LABEL(dp) dir_read(dp,
                           A  5432    ; 2274	
                           A  5433    ; 2275	static FRESULT dir_read (
                           A  5434    ; 2276		DIR* dp,		/* Pointer to the d
                           A  5435    ; 2277		int vol			/* Filtered by 0:fi
                           A  5436    ; 2278	)
                           A  5437    ; 2279	{
041BBA                     A  5438    _dir_read:
                           A  5439    .DEFINE "_dir_read"
                           A  5440    
                           A  5441    .VALUE _dir_read
                           A  5442    
                           A  5443    .CLASS 3
                           A  5444    
                           A  5445    .TYPE 68
                           A  5446    
                           A  5447    .ENDEF
                           A  5448    
                           A  5449    .BEGFUNC "dir_read",2279,"_dir_read"
                           A  5450    
                           A  5451    .LINE 2279
                           A  5452    
                           A  5453    .DEFINE "dp"
                           A  5454    
                           A  5455    .CLASS 65
                           A  5456    
                           A  5457    .VALUE 6
                           A  5458    
                           A  5459    .TAG "NONAME3"
                           A  5460    
                           A  5461    .TYPE 40
                           A  5462    
                           A  5463    .ENDEF
                           A  5464    
                           A  5465    .DEFINE "vol"
                           A  5466    
                           A  5467    .CLASS 65
                           A  5468    
                           A  5469    .VALUE 9
                           A  5470    
                           A  5471    .TYPE 4
                           A  5472    
                           A  5473    .ENDEF
                           A  5474    
                           A  5475    .DEFINE "b"
                           A  5476    
                           A  5477    .CLASS 65
                           A  5478    
                           A  5479    .VALUE -1
                           A  5480    
                           A  5481    .TYPE 12
                           A  5482    
                           A  5483    .ENDEF
                           A  5484    
                           A  5485    .DEFINE "ord"
                           A  5486    
                           A  5487    .CLASS 65
                           A  5488    
                           A  5489    .VALUE -2
                           A  5490    
                           A  5491    .TYPE 12
                           A  5492    
                           A  5493    .ENDEF
                           A  5494    
                           A  5495    .DEFINE "res"
                           A  5496    
                           A  5497    .CLASS 65
                           A  5498    
                           A  5499    .VALUE -5
                           A  5500    
                           A  5501    .TYPE 4
                           A  5502    
                           A  5503    .ENDEF
                           A  5504    
                           A  5505    .DEFINE "attr"
                           A  5506    
                           A  5507    .CLASS 65
                           A  5508    
                           A  5509    .VALUE -6
                           A  5510    
                           A  5511    .TYPE 12
                           A  5512    
                           A  5513    .ENDEF
                           A  5514    
                           A  5515    .DEFINE "sum"
                           A  5516    
                           A  5517    .CLASS 65
                           A  5518    
                           A  5519    .VALUE -7
                           A  5520    
                           A  5521    .TYPE 12
                           A  5522    
                           A  5523    .ENDEF
                           A  5524    
                           A  5525    .DEFINE "fs"
                           A  5526    
                           A  5527    .CLASS 65
                           A  5528    
                           A  5529    .VALUE -10
                           A  5530    
                           A  5531    .TAG "NONAME0"
                           A  5532    
                           A  5533    .TYPE 40
                           A  5534    
                           A  5535    .ENDEF
                           A  5536    
041BBA DDE5                A  5537    	PUSH	IX
041BBC DD210000 00         A  5538    	LD	IX,0
041BC1 DD39                A  5539    	ADD	IX,SP
041BC3 ED22E9              A  5540    	LEA	HL,IX+%FFFFFFE9
041BC6 F9                  A  5541    	LD	SP,HL
                           A  5542    ; 2280		FRESULT res = FR_NO_FILE;
                           A  5543    .LINE 2280
                           A  5544    
041BC7 01040000            A  5545    	LD	BC,4
041BCB DD0FFB              A  5546    	LD	(IX+%FFFFFFFB),BC
                           A  5547    ; 2281		FATFS *fs = dp->obj.fs;
                           A  5548    .LINE 2281
                           A  5549    
041BCE DD3106              A  5550    	LD	IY,(IX+%6)
041BD1 FD0700              A  5551    	LD	BC,(IY+%0)
041BD4 DD0FF6              A  5552    	LD	(IX+%FFFFFFF6),BC
                           A  5553    ; 2282		BYTE attr, b;
                           A  5554    ; 2283	#if FF_USE_LFN
                           A  5555    ; 2284		BYTE ord = 0xFF, sum = 0xFF;
                           A  5556    .LINE 2284
                           A  5557    
041BD7 DD36FEFF            A  5558    	LD	(IX+%FFFFFFFE),%FF
041BDB DD36F9FF            A  5559    	LD	(IX+%FFFFFFF9),%FF
                           A  5560    ; 2285	#endif
                           A  5561    ; 2286	
                           A  5562    ; 2287		while (dp->sect) {
                           A  5563    .LINE 2287
                           A  5564    
041BDF C3 25 1D 04         A  5565    	JR	L_172
041BE3                     A  5566    L_173:
                           A  5567    ; 2288			res = move_window(fs, dp->sect)
                           A  5568    .LINE 2288
                           A  5569    
041BE3 DD4EEC              A  5570    	LD	C,(IX+%FFFFFFEC)
041BE6 0600                A  5571    	LD	B,%0
041BE8 C5                  A  5572    	PUSH	BC
041BE9 DD07E9              A  5573    	LD	BC,(IX+%FFFFFFE9)
041BEC C5                  A  5574    	PUSH	BC
041BED DD07F6              A  5575    	LD	BC,(IX+%FFFFFFF6)
041BF0 C5                  A  5576    	PUSH	BC
041BF1 CD 82 11 04         A  5577    	CALL	_move_window
041BF5 C1                  A  5578    	POP	BC
041BF6 C1                  A  5579    	POP	BC
041BF7 C1                  A  5580    	POP	BC
041BF8 DD2FFB              A  5581    	LD	(IX+%FFFFFFFB),HL
                           A  5582    ; 2289			if (res != FR_OK) break;
                           A  5583    .LINE 2289
                           A  5584    
041BFB CD E5 46 04         A  5585    	CALL	__icmpzero
041BFF C2 41 1D 04         A  5586    	JR	NZ,L_175
                           A  5587    ; 2290			b = dp->dir[DIR_Name];	/* Test
                           A  5588    .LINE 2290
                           A  5589    
041C03 DD3106              A  5590    	LD	IY,(IX+%6)
041C06 FD071B              A  5591    	LD	BC,(IY+%1B)
041C09 DD0FF0              A  5592    	LD	(IX+%FFFFFFF0),BC
041C0C C5E1                A  5593    	LD	HL,BC
041C0E 7E                  A  5594    	LD	A,(HL)
041C0F DD77FF              A  5595    	LD	(IX+%FFFFFFFF),A
                           A  5596    ; 2291			if (b == 0) {
                           A  5597    .LINE 2291
                           A  5598    
041C12 B7                  A  5599    	OR	A,A
041C13 20 0B               A  5600    	JR	NZ,L_169
                           A  5601    ; 2292				res = FR_NO_FILE; break; /*
                           A  5602    .LINE 2292
                           A  5603    
041C15 01040000            A  5604    	LD	BC,4
041C19 DD0FFB              A  5605    	LD	(IX+%FFFFFFFB),BC
041C1C C3 41 1D 04         A  5606    	JR	L_175
                           A  5607    ; 2293			}
041C20                     A  5608    L_169:
                           A  5609    .LINE 2293
                           A  5610    
                           A  5611    ; 2294	#if FF_FS_EXFAT
                           A  5612    ; 2295			if (fs->fs_type == FS_EXFAT) {	
                           A  5613    ; 2296				if (FF_USE_LABEL && vol) {
                           A  5614    ; 2297					if (b == ET_VLABEL) bre
                           A  5615    ; 2298				} else {
                           A  5616    ; 2299					if (b == ET_FILEDIR) {	
                           A  5617    ; 2300						dp->blk_ofs = dp->d
                           A  5618    ; 2301						res = load_xdir(dp)
                           A  5619    ; 2302						if (res == FR_OK) {
                           A  5620    ; 2303							dp->obj.attr = 
                           A  5621    ; 2304						}
                           A  5622    ; 2305						break;
                           A  5623    ; 2306					}
                           A  5624    ; 2307				}
                           A  5625    ; 2308			} else
                           A  5626    ; 2309	#endif
                           A  5627    ; 2310			{	/* On the FAT/FAT32 volume 
                           A  5628    ; 2311				dp->obj.attr = attr = dp->d
                           A  5629    .LINE 2311
                           A  5630    
041C20 DD31F0              A  5631    	LD	IY,(IX+%FFFFFFF0)
041C23 FD7E0B              A  5632    	LD	A,(IY+%B)
041C26 E63F                A  5633    	AND	A,%3F
041C28 DD77FA              A  5634    	LD	(IX+%FFFFFFFA),A
041C2B DD3106              A  5635    	LD	IY,(IX+%6)
041C2E FD7705              A  5636    	LD	(IY+%5),A
                           A  5637    ; 2312	#if FF_USE_LFN		/* LFN configuratio
                           A  5638    ; 2313				if (b == DDEM || b == '.' |
                           A  5639    .LINE 2313
                           A  5640    
041C31 DD7EFF              A  5641    	LD	A,(IX+%FFFFFFFF)
041C34 FEE5                A  5642    	CP	A,%E5
041C36 28 23               A  5643    	JR	Z,L_167
041C38 DD7EFF              A  5644    	LD	A,(IX+%FFFFFFFF)
041C3B FE2E                A  5645    	CP	A,%2E
041C3D 28 1C               A  5646    	JR	Z,L_167
041C3F DD7EFA              A  5647    	LD	A,(IX+%FFFFFFFA)
041C42 CBAF                A  5648    	RES	%5,A
041C44 FE08                A  5649    	CP	A,%8
041C46 20 04               A  5650    	JR	NZ,L__81
041C48 0601                A  5651    	LD	B,%1
041C4A 18 02               A  5652    	JR	L__82
041C4C                     A  5653    L__81:
041C4C 0600                A  5654    	LD	B,%0
041C4E                     A  5655    L__82:
041C4E 78                  A  5656    	LD	A,B
041C4F 17ED62              A  5657    	SEXT	HL
041C52 68                  A  5658    	LD	L,B
041C53 DD0709              A  5659    	LD	BC,(IX+%9)
041C56 B7                  A  5660    	OR	A,A
041C57 ED42                A  5661    	SBC	HL,BC
041C59 28 08               A  5662    	JR	Z,L_168
041C5B                     A  5663    L_167:
                           A  5664    ; 2314					ord = 0xFF;
                           A  5665    .LINE 2314
                           A  5666    
041C5B DD36FEFF            A  5667    	LD	(IX+%FFFFFFFE),%FF
                           A  5668    ; 2315				} else {
                           A  5669    .LINE 2315
                           A  5670    
041C5F C3 0D 1D 04         A  5671    	JR	L_170
041C63                     A  5672    L_168:
                           A  5673    ; 2316					if (attr == AM_LFN) {	
                           A  5674    .LINE 2316
                           A  5675    
041C63 DD7EFA              A  5676    	LD	A,(IX+%FFFFFFFA)
041C66 FE0F                A  5677    	CP	A,%F
041C68 20 7C               A  5678    	JR	NZ,L_166
                           A  5679    ; 2317						if (b & LLEF) {		
                           A  5680    .LINE 2317
                           A  5681    
041C6A DD7EFF              A  5682    	LD	A,(IX+%FFFFFFFF)
041C6D E640                A  5683    	AND	A,%40
041C6F 28 26               A  5684    	JR	Z,L_161
                           A  5685    ; 2318							sum = dp->dir[L
                           A  5686    .LINE 2318
                           A  5687    
041C71 DD3106              A  5688    	LD	IY,(IX+%6)
041C74 FD371B              A  5689    	LD	IY,(IY+%1B)
041C77 FD7E0D              A  5690    	LD	A,(IY+%D)
041C7A DD77F9              A  5691    	LD	(IX+%FFFFFFF9),A
                           A  5692    ; 2319							b &= (BYTE)~LLE
                           A  5693    .LINE 2319
                           A  5694    
041C7D DD7EFF              A  5695    	LD	A,(IX+%FFFFFFFF)
041C80 CBB7                A  5696    	RES	%6,A
041C82 DD77FF              A  5697    	LD	(IX+%FFFFFFFF),A
041C85 DD77FE              A  5698    	LD	(IX+%FFFFFFFE),A
                           A  5699    ; 2320							dp->blk_ofs = d
                           A  5700    .LINE 2320
                           A  5701    
041C88 DD3106              A  5702    	LD	IY,(IX+%6)
041C8B FD070F              A  5703    	LD	BC,(IY+%F)
041C8E FD7E12              A  5704    	LD	A,(IY+%12)
041C91 FD0F2A              A  5705    	LD	(IY+%2A),BC
041C94 FD772D              A  5706    	LD	(IY+%2D),A
                           A  5707    ; 2321						}
041C97                     A  5708    L_161:
                           A  5709    .LINE 2321
                           A  5710    
                           A  5711    ; 2322						/* Check LFN validi
                           A  5712    ; 2323						ord = (b == ord && 
                           A  5713    .LINE 2323
                           A  5714    
041C97 DD7EFF              A  5715    	LD	A,(IX+%FFFFFFFF)
041C9A DDBEFE              A  5716    	CP	A,(IX+%FFFFFFFE)
041C9D 20 38               A  5717    	JR	NZ,L_159
041C9F DD3106              A  5718    	LD	IY,(IX+%6)
041CA2 FD071B              A  5719    	LD	BC,(IY+%1B)
041CA5 DD0FED              A  5720    	LD	(IX+%FFFFFFED),BC
041CA8 DD31ED              A  5721    	LD	IY,(IX+%FFFFFFED)
041CAB FD7E0D              A  5722    	LD	A,(IY+%D)
041CAE DDBEF9              A  5723    	CP	A,(IX+%FFFFFFF9)
041CB1 20 24               A  5724    	JR	NZ,L_159
041CB3 DD07ED              A  5725    	LD	BC,(IX+%FFFFFFED)
041CB6 C5                  A  5726    	PUSH	BC
041CB7 DD31F6              A  5727    	LD	IY,(IX+%FFFFFFF6)
041CBA FD070B              A  5728    	LD	BC,(IY+%B)
041CBD C5                  A  5729    	PUSH	BC
041CBE CD 61 1A 04         A  5730    	CALL	_pick_lfn
041CC2 C1                  A  5731    	POP	BC
041CC3 C1                  A  5732    	POP	BC
041CC4 CD E5 46 04         A  5733    	CALL	__icmpzero
041CC8 28 0D               A  5734    	JR	Z,L_159
041CCA DD7EFE              A  5735    	LD	A,(IX+%FFFFFFFE)
041CCD B7ED62              A  5736    	UEXT	HL
041CD0 6F                  A  5737    	LD	L,A
041CD1 2B                  A  5738    	DEC	HL
041CD2 DD2FF3              A  5739    	LD	(IX+%FFFFFFF3),HL
041CD5 18 07               A  5740    	JR	L_160
041CD7                     A  5741    L_159:
041CD7 01FF0000            A  5742    	LD	BC,255
041CDB DD0FF3              A  5743    	LD	(IX+%FFFFFFF3),BC
041CDE                     A  5744    L_160:
041CDE DD7EF3              A  5745    	LD	A,(IX+%FFFFFFF3)
041CE1 DD77FE              A  5746    	LD	(IX+%FFFFFFFE),A
                           A  5747    ; 2324					} else {				
                           A  5748    .LINE 2324
                           A  5749    
041CE4 18 27               A  5750    	JR	L_170
041CE6                     A  5751    L_166:
                           A  5752    ; 2325						if (ord != 0 || sum
                           A  5753    .LINE 2325
                           A  5754    
041CE6 DD7EFE              A  5755    	LD	A,(IX+%FFFFFFFE)
041CE9 B7                  A  5756    	OR	A,A
041CEA 20 11               A  5757    	JR	NZ,L_163
041CEC DD3106              A  5758    	LD	IY,(IX+%6)
041CEF FD071B              A  5759    	LD	BC,(IY+%1B)
041CF2 C5                  A  5760    	PUSH	BC
041CF3 CD 63 1B 04         A  5761    	CALL	_sum_sfn
041CF7 C1                  A  5762    	POP	BC
041CF8 DDBEF9              A  5763    	CP	A,(IX+%FFFFFFF9)
041CFB 28 44               A  5764    	JR	Z,L_175
041CFD                     A  5765    L_163:
                           A  5766    ; 2326							dp->blk_ofs = 0
                           A  5767    .LINE 2326
                           A  5768    
041CFD 01FFFFFF            A  5769    	LD	BC,16777215
041D01 DD3106              A  5770    	LD	IY,(IX+%6)
041D04 FD0F2A              A  5771    	LD	(IY+%2A),BC
041D07 FD362DFF            A  5772    	LD	(IY+%2D),%FF
                           A  5773    ; 2327						}
                           A  5774    .LINE 2327
                           A  5775    
                           A  5776    ; 2328						break;
                           A  5777    .LINE 2328
                           A  5778    
041D0B 18 34               A  5779    	JR	L_175
                           A  5780    ; 2329					}
                           A  5781    ; 2330				}
                           A  5782    ; 2331	#else		/* Non LFN configuration */
                           A  5783    ; 2332				if (b != DDEM && b != '.' &
                           A  5784    ; 2333					break;
                           A  5785    ; 2334				}
                           A  5786    ; 2335	#endif
                           A  5787    ; 2336			}
041D0D                     A  5788    L_170:
                           A  5789    .LINE 2336
                           A  5790    
                           A  5791    ; 2337			res = dir_next(dp, 0);		/* 
                           A  5792    .LINE 2337
                           A  5793    
041D0D 01000000            A  5794    	LD	BC,0
041D11 C5                  A  5795    	PUSH	BC
041D12 DD0706              A  5796    	LD	BC,(IX+%6)
041D15 C5                  A  5797    	PUSH	BC
041D16 CD BA 16 04         A  5798    	CALL	_dir_next
041D1A C1                  A  5799    	POP	BC
041D1B C1                  A  5800    	POP	BC
041D1C DD2FFB              A  5801    	LD	(IX+%FFFFFFFB),HL
                           A  5802    ; 2338			if (res != FR_OK) break;
                           A  5803    .LINE 2338
                           A  5804    
041D1F CD E5 46 04         A  5805    	CALL	__icmpzero
041D23 20 1C               A  5806    	JR	NZ,L_175
                           A  5807    ; 2339		}
041D25                     A  5808    L_172:
                           A  5809    .LINE 2339
                           A  5810    
041D25 DD3106              A  5811    	LD	IY,(IX+%6)
041D28 FD0717              A  5812    	LD	BC,(IY+%17)
041D2B FD7E1A              A  5813    	LD	A,(IY+%1A)
041D2E DD0FE9              A  5814    	LD	(IX+%FFFFFFE9),BC
041D31 DD77EC              A  5815    	LD	(IX+%FFFFFFEC),A
041D34 C5E1                A  5816    	LD	HL,BC
041D36 DD5EEC              A  5817    	LD	E,(IX+%FFFFFFEC)
041D39 CD B8 45 04         A  5818    	CALL	__lcmpzero
041D3D C2 E3 1B 04         A  5819    	JR	NZ,L_173
041D41                     A  5820    L_175:
                           A  5821    ; 2340	
                           A  5822    ; 2341		if (res != FR_OK) dp->sect = 0;		
                           A  5823    .LINE 2341
                           A  5824    
041D41 DD27FB              A  5825    	LD	HL,(IX+%FFFFFFFB)
041D44 CD E5 46 04         A  5826    	CALL	__icmpzero
041D48 28 0E               A  5827    	JR	Z,L_176
041D4A 01000000            A  5828    	LD	BC,0
041D4E DD3106              A  5829    	LD	IY,(IX+%6)
041D51 FD0F17              A  5830    	LD	(IY+%17),BC
041D54 FD361A00            A  5831    	LD	(IY+%1A),%0
041D58                     A  5832    L_176:
                           A  5833    ; 2342		return res;
                           A  5834    .LINE 2342
                           A  5835    
041D58 DD27FB              A  5836    	LD	HL,(IX+%FFFFFFFB)
                           A  5837    ; 2343	}
                           A  5838    .LINE 2343
                           A  5839    
041D5B DDF9                A  5840    	LD	SP,IX
041D5D DDE1                A  5841    	POP	IX
041D5F C9                  A  5842    	RET	
                           A  5843    
                           A  5844    
                           A  5845    ;**************************** _dir_read *******
                           A  5846    ;Name                         Addr/Register   S
                           A  5847    ;G_3                                  IX-23    
                           A  5848    ;G_5                                  IX-19    
                           A  5849    ;G_4                                  IX-16    
                           A  5850    ;temp157                              IX-13    
                           A  5851    ;fs                                   IX-10    
                           A  5852    ;sum                                   IX-7    
                           A  5853    ;attr                                  IX-6    
                           A  5854    ;res                                   IX-5    
                           A  5855    ;ord                                   IX-2    
                           A  5856    ;b                                     IX-1    
                           A  5857    ;vol                                   IX+9    
                           A  5858    ;dp                                    IX+6    
                           A  5859    
                           A  5860    
                           A  5861    ; Stack Frame Size: 35 (bytes)
                           A  5862    ;       Spill Code: 0 (instruction)
                           A  5863    
                           A  5864    
                           A  5865    .ENDFUNC "dir_read",2343,"_dir_read"
                           A  5866    ; 2344	
                           A  5867    ; 2345	#endif	/* FF_FS_MINIMIZE <= 1 || FF_US
                           A  5868    ; 2346	
                           A  5869    ; 2347	
                           A  5870    ; 2348	
                           A  5871    ; 2349	/*-------------------------------------
                           A  5872    ; 2350	/* Directory handling - Find an object 
                           A  5873    ; 2351	/*-------------------------------------
                           A  5874    ; 2352	
                           A  5875    ; 2353	static FRESULT dir_find (	/* FR_OK(0)
                           A  5876    ; 2354		DIR* dp					/* Pointer 
                           A  5877    ; 2355	)
                           A  5878    ; 2356	{
041D60                     A  5879    _dir_find:
                           A  5880    .DEFINE "_dir_find"
                           A  5881    
                           A  5882    .VALUE _dir_find
                           A  5883    
                           A  5884    .CLASS 3
                           A  5885    
                           A  5886    .TYPE 68
                           A  5887    
                           A  5888    .ENDEF
                           A  5889    
                           A  5890    .BEGFUNC "dir_find",2356,"_dir_find"
                           A  5891    
                           A  5892    .LINE 2356
                           A  5893    
                           A  5894    .DEFINE "dp"
                           A  5895    
                           A  5896    .CLASS 65
                           A  5897    
                           A  5898    .VALUE 6
                           A  5899    
                           A  5900    .TAG "NONAME3"
                           A  5901    
                           A  5902    .TYPE 40
                           A  5903    
                           A  5904    .ENDEF
                           A  5905    
                           A  5906    .DEFINE "c"
                           A  5907    
                           A  5908    .CLASS 65
                           A  5909    
                           A  5910    .VALUE -1
                           A  5911    
                           A  5912    .TYPE 12
                           A  5913    
                           A  5914    .ENDEF
                           A  5915    
                           A  5916    .DEFINE "ord"
                           A  5917    
                           A  5918    .CLASS 65
                           A  5919    
                           A  5920    .VALUE -2
                           A  5921    
                           A  5922    .TYPE 12
                           A  5923    
                           A  5924    .ENDEF
                           A  5925    
                           A  5926    .DEFINE "res"
                           A  5927    
                           A  5928    .CLASS 65
                           A  5929    
                           A  5930    .VALUE -5
                           A  5931    
                           A  5932    .TYPE 4
                           A  5933    
                           A  5934    .ENDEF
                           A  5935    
                           A  5936    .DEFINE "a"
                           A  5937    
                           A  5938    .CLASS 65
                           A  5939    
                           A  5940    .VALUE -6
                           A  5941    
                           A  5942    .TYPE 12
                           A  5943    
                           A  5944    .ENDEF
                           A  5945    
                           A  5946    .DEFINE "sum"
                           A  5947    
                           A  5948    .CLASS 65
                           A  5949    
                           A  5950    .VALUE -7
                           A  5951    
                           A  5952    .TYPE 12
                           A  5953    
                           A  5954    .ENDEF
                           A  5955    
                           A  5956    .DEFINE "fs"
                           A  5957    
                           A  5958    .CLASS 65
                           A  5959    
                           A  5960    .VALUE -10
                           A  5961    
                           A  5962    .TAG "NONAME0"
                           A  5963    
                           A  5964    .TYPE 40
                           A  5965    
                           A  5966    .ENDEF
                           A  5967    
041D60 DDE5                A  5968    	PUSH	IX
041D62 DD210000 00         A  5969    	LD	IX,0
041D67 DD39                A  5970    	ADD	IX,SP
041D69 ED22EA              A  5971    	LEA	HL,IX+%FFFFFFEA
041D6C F9                  A  5972    	LD	SP,HL
                           A  5973    ; 2357		FRESULT res;
                           A  5974    ; 2358		FATFS *fs = dp->obj.fs;
                           A  5975    .LINE 2358
                           A  5976    
041D6D DD3106              A  5977    	LD	IY,(IX+%6)
041D70 FD0700              A  5978    	LD	BC,(IY+%0)
041D73 DD0FF6              A  5979    	LD	(IX+%FFFFFFF6),BC
                           A  5980    ; 2359		BYTE c;
                           A  5981    ; 2360	#if FF_USE_LFN
                           A  5982    ; 2361		BYTE a, ord, sum;
                           A  5983    ; 2362	#endif
                           A  5984    ; 2363	
                           A  5985    ; 2364		res = dir_sdi(dp, 0);			/* 
                           A  5986    .LINE 2364
                           A  5987    
041D76 01000000            A  5988    	LD	BC,0
041D7A C5                  A  5989    	PUSH	BC
041D7B C5                  A  5990    	PUSH	BC
041D7C DD0706              A  5991    	LD	BC,(IX+%6)
041D7F C5                  A  5992    	PUSH	BC
041D80 CD B4 14 04         A  5993    	CALL	_dir_sdi
041D84 C1                  A  5994    	POP	BC
041D85 C1                  A  5995    	POP	BC
041D86 C1                  A  5996    	POP	BC
041D87 DD2FFB              A  5997    	LD	(IX+%FFFFFFFB),HL
                           A  5998    ; 2365		if (res != FR_OK) return res;
                           A  5999    .LINE 2365
                           A  6000    
041D8A CD E5 46 04         A  6001    	CALL	__icmpzero
041D8E 28 07               A  6002    	JR	Z,L_179
041D90 DD27FB              A  6003    	LD	HL,(IX+%FFFFFFFB)
041D93 C3 31 1F 04         A  6004    	JR	L_209
041D97                     A  6005    L_179:
                           A  6006    ; 2366	#if FF_FS_EXFAT
                           A  6007    ; 2367		if (fs->fs_type == FS_EXFAT) {	/* 
                           A  6008    ; 2368			BYTE nc;
                           A  6009    ; 2369			UINT di, ni;
                           A  6010    ; 2370			WORD hash = xname_sum(fs->lfnbu
                           A  6011    ; 2371	
                           A  6012    ; 2372			while ((res = DIR_READ_FILE(dp)
                           A  6013    ; 2373	#if FF_MAX_LFN < 255
                           A  6014    ; 2374				if (fs->dirbuf[XDIR_NumName
                           A  6015    ; 2375	#endif
                           A  6016    ; 2376				if (ld_word(fs->dirbuf + XD
                           A  6017    ; 2377				for (nc = fs->dirbuf[XDIR_N
                           A  6018    ; 2378					if ((di % SZDIRE) == 0)
                           A  6019    ; 2379					if (ff_wtoupper(ld_word
                           A  6020    ; 2380				}
                           A  6021    ; 2381				if (nc == 0 && !fs->lfnbuf[
                           A  6022    ; 2382			}
                           A  6023    ; 2383			return res;
                           A  6024    ; 2384		}
                           A  6025    ; 2385	#endif
                           A  6026    ; 2386		/* On the FAT/FAT32 volume */
                           A  6027    ; 2387	#if FF_USE_LFN
                           A  6028    ; 2388		ord = sum = 0xFF; dp->blk_ofs = 0xF
                           A  6029    .LINE 2388
                           A  6030    
041D97 DD36F9FF            A  6031    	LD	(IX+%FFFFFFF9),%FF
041D9B DD36FEFF            A  6032    	LD	(IX+%FFFFFFFE),%FF
041D9F 01FFFFFF            A  6033    	LD	BC,16777215
041DA3 DD3106              A  6034    	LD	IY,(IX+%6)
041DA6 FD0F2A              A  6035    	LD	(IY+%2A),BC
041DA9 FD362DFF            A  6036    	LD	(IY+%2D),%FF
                           A  6037    ; 2389	#endif
                           A  6038    ; 2390		do {
041DAD                     A  6039    L_206:
                           A  6040    .LINE 2390
                           A  6041    
                           A  6042    ; 2391			res = move_window(fs, dp->sect)
                           A  6043    .LINE 2391
                           A  6044    
041DAD DD3106              A  6045    	LD	IY,(IX+%6)
041DB0 FD0717              A  6046    	LD	BC,(IY+%17)
041DB3 FD7E1A              A  6047    	LD	A,(IY+%1A)
041DB6 2600                A  6048    	LD	H,%0
041DB8 6F                  A  6049    	LD	L,A
041DB9 E5                  A  6050    	PUSH	HL
041DBA C5                  A  6051    	PUSH	BC
041DBB DD07F6              A  6052    	LD	BC,(IX+%FFFFFFF6)
041DBE C5                  A  6053    	PUSH	BC
041DBF CD 82 11 04         A  6054    	CALL	_move_window
041DC3 C1                  A  6055    	POP	BC
041DC4 C1                  A  6056    	POP	BC
041DC5 C1                  A  6057    	POP	BC
041DC6 DD2FFB              A  6058    	LD	(IX+%FFFFFFFB),HL
                           A  6059    ; 2392			if (res != FR_OK) break;
                           A  6060    .LINE 2392
                           A  6061    
041DC9 CD E5 46 04         A  6062    	CALL	__icmpzero
041DCD C2 2E 1F 04         A  6063    	JR	NZ,L_208
                           A  6064    ; 2393			c = dp->dir[DIR_Name];
                           A  6065    .LINE 2393
                           A  6066    
041DD1 DD3106              A  6067    	LD	IY,(IX+%6)
041DD4 FD071B              A  6068    	LD	BC,(IY+%1B)
041DD7 DD0FF0              A  6069    	LD	(IX+%FFFFFFF0),BC
041DDA C5E1                A  6070    	LD	HL,BC
041DDC 7E                  A  6071    	LD	A,(HL)
041DDD DD77FF              A  6072    	LD	(IX+%FFFFFFFF),A
                           A  6073    ; 2394			if (c == 0) { res = FR_NO_FILE;
                           A  6074    .LINE 2394
                           A  6075    
041DE0 B7                  A  6076    	OR	A,A
041DE1 20 0B               A  6077    	JR	NZ,L_183
041DE3 01040000            A  6078    	LD	BC,4
041DE7 DD0FFB              A  6079    	LD	(IX+%FFFFFFFB),BC
041DEA C3 2E 1F 04         A  6080    	JR	L_208
041DEE                     A  6081    L_183:
                           A  6082    ; 2395	#if FF_USE_LFN		/* LFN configuratio
                           A  6083    ; 2396			dp->obj.attr = a = dp->dir[DIR_
                           A  6084    .LINE 2396
                           A  6085    
041DEE DD31F0              A  6086    	LD	IY,(IX+%FFFFFFF0)
041DF1 FD7E0B              A  6087    	LD	A,(IY+%B)
041DF4 E63F                A  6088    	AND	A,%3F
041DF6 DD77FA              A  6089    	LD	(IX+%FFFFFFFA),A
041DF9 DD3106              A  6090    	LD	IY,(IX+%6)
041DFC FD7705              A  6091    	LD	(IY+%5),A
                           A  6092    ; 2397			if (c == DDEM || ((a & AM_VOL) 
                           A  6093    .LINE 2397
                           A  6094    
041DFF DD7EFF              A  6095    	LD	A,(IX+%FFFFFFFF)
041E02 FEE5                A  6096    	CP	A,%E5
041E04 28 0E               A  6097    	JR	Z,L_203
041E06 DD7EFA              A  6098    	LD	A,(IX+%FFFFFFFA)
041E09 E608                A  6099    	AND	A,%8
041E0B 28 1D               A  6100    	JR	Z,L_204
041E0D DD7EFA              A  6101    	LD	A,(IX+%FFFFFFFA)
041E10 FE0F                A  6102    	CP	A,%F
041E12 28 16               A  6103    	JR	Z,L_204
041E14                     A  6104    L_203:
                           A  6105    ; 2398				ord = 0xFF; dp->blk_ofs = 0
                           A  6106    .LINE 2398
                           A  6107    
041E14 DD36FEFF            A  6108    	LD	(IX+%FFFFFFFE),%FF
041E18 01FFFFFF            A  6109    	LD	BC,16777215
041E1C DD3106              A  6110    	LD	IY,(IX+%6)
041E1F FD0F2A              A  6111    	LD	(IY+%2A),BC
041E22 FD362DFF            A  6112    	LD	(IY+%2D),%FF
                           A  6113    ; 2399			} else {
                           A  6114    .LINE 2399
                           A  6115    
041E26 C3 14 1F 04         A  6116    	JR	L_205
041E2A                     A  6117    L_204:
                           A  6118    ; 2400				if (a == AM_LFN) {			
                           A  6119    .LINE 2400
                           A  6120    
041E2A DD7EFA              A  6121    	LD	A,(IX+%FFFFFFFA)
041E2D FE0F                A  6122    	CP	A,%F
041E2F C2 BB 1E 04         A  6123    	JR	NZ,L_202
                           A  6124    ; 2401					if (!(dp->fn[NSFLAG] & 
                           A  6125    .LINE 2401
                           A  6126    
041E33 DD3106              A  6127    	LD	IY,(IX+%6)
041E36 FD7E29              A  6128    	LD	A,(IY+%29)
041E39 E640                A  6129    	AND	A,%40
041E3B C2 14 1F 04         A  6130    	JR	NZ,L_205
                           A  6131    ; 2402						if (c & LLEF) {		
                           A  6132    .LINE 2402
                           A  6133    
041E3F DD7EFF              A  6134    	LD	A,(IX+%FFFFFFFF)
041E42 E640                A  6135    	AND	A,%40
041E44 28 26               A  6136    	JR	Z,L_193
                           A  6137    ; 2403							sum = dp->dir[L
                           A  6138    .LINE 2403
                           A  6139    
041E46 DD3106              A  6140    	LD	IY,(IX+%6)
041E49 FD371B              A  6141    	LD	IY,(IY+%1B)
041E4C FD7E0D              A  6142    	LD	A,(IY+%D)
041E4F DD77F9              A  6143    	LD	(IX+%FFFFFFF9),A
                           A  6144    ; 2404							c &= (BYTE)~LLE
                           A  6145    .LINE 2404
                           A  6146    
041E52 DD7EFF              A  6147    	LD	A,(IX+%FFFFFFFF)
041E55 CBB7                A  6148    	RES	%6,A
041E57 DD77FF              A  6149    	LD	(IX+%FFFFFFFF),A
041E5A DD77FE              A  6150    	LD	(IX+%FFFFFFFE),A
                           A  6151    ; 2405							dp->blk_ofs = d
                           A  6152    .LINE 2405
                           A  6153    
041E5D DD3106              A  6154    	LD	IY,(IX+%6)
041E60 FD070F              A  6155    	LD	BC,(IY+%F)
041E63 FD7E12              A  6156    	LD	A,(IY+%12)
041E66 FD0F2A              A  6157    	LD	(IY+%2A),BC
041E69 FD772D              A  6158    	LD	(IY+%2D),A
                           A  6159    ; 2406						}
041E6C                     A  6160    L_193:
                           A  6161    .LINE 2406
                           A  6162    
                           A  6163    ; 2407						/* Check validity o
                           A  6164    ; 2408						ord = (c == ord && 
                           A  6165    .LINE 2408
                           A  6166    
041E6C DD7EFF              A  6167    	LD	A,(IX+%FFFFFFFF)
041E6F DDBEFE              A  6168    	CP	A,(IX+%FFFFFFFE)
041E72 20 38               A  6169    	JR	NZ,L_191
041E74 DD3106              A  6170    	LD	IY,(IX+%6)
041E77 FD071B              A  6171    	LD	BC,(IY+%1B)
041E7A DD0FED              A  6172    	LD	(IX+%FFFFFFED),BC
041E7D DD31ED              A  6173    	LD	IY,(IX+%FFFFFFED)
041E80 FD7E0D              A  6174    	LD	A,(IY+%D)
041E83 DDBEF9              A  6175    	CP	A,(IX+%FFFFFFF9)
041E86 20 24               A  6176    	JR	NZ,L_191
041E88 DD07ED              A  6177    	LD	BC,(IX+%FFFFFFED)
041E8B C5                  A  6178    	PUSH	BC
041E8C DD31F6              A  6179    	LD	IY,(IX+%FFFFFFF6)
041E8F FD070B              A  6180    	LD	BC,(IY+%B)
041E92 C5                  A  6181    	PUSH	BC
041E93 CD 33 19 04         A  6182    	CALL	_cmp_lfn
041E97 C1                  A  6183    	POP	BC
041E98 C1                  A  6184    	POP	BC
041E99 CD E5 46 04         A  6185    	CALL	__icmpzero
041E9D 28 0D               A  6186    	JR	Z,L_191
041E9F DD7EFE              A  6187    	LD	A,(IX+%FFFFFFFE)
041EA2 B7ED62              A  6188    	UEXT	HL
041EA5 6F                  A  6189    	LD	L,A
041EA6 2B                  A  6190    	DEC	HL
041EA7 DD2FF3              A  6191    	LD	(IX+%FFFFFFF3),HL
041EAA 18 07               A  6192    	JR	L_192
041EAC                     A  6193    L_191:
041EAC 01FF0000            A  6194    	LD	BC,255
041EB0 DD0FF3              A  6195    	LD	(IX+%FFFFFFF3),BC
041EB3                     A  6196    L_192:
041EB3 DD7EF3              A  6197    	LD	A,(IX+%FFFFFFF3)
041EB6 DD77FE              A  6198    	LD	(IX+%FFFFFFFE),A
                           A  6199    ; 2409					}
                           A  6200    ; 2410				} else {					
                           A  6201    .LINE 2410
                           A  6202    
041EB9 18 59               A  6203    	JR	L_205
041EBB                     A  6204    L_202:
                           A  6205    ; 2411					if (ord == 0 && sum == 
                           A  6206    .LINE 2411
                           A  6207    
041EBB DD7EFE              A  6208    	LD	A,(IX+%FFFFFFFE)
041EBE B7                  A  6209    	OR	A,A
041EBF 20 11               A  6210    	JR	NZ,L_199
041EC1 DD3106              A  6211    	LD	IY,(IX+%6)
041EC4 FD071B              A  6212    	LD	BC,(IY+%1B)
041EC7 C5                  A  6213    	PUSH	BC
041EC8 CD 63 1B 04         A  6214    	CALL	_sum_sfn
041ECC C1                  A  6215    	POP	BC
041ECD DDBEF9              A  6216    	CP	A,(IX+%FFFFFFF9)
041ED0 28 5C               A  6217    	JR	Z,L_208
041ED2                     A  6218    L_199:
                           A  6219    ; 2412					if (!(dp->fn[NSFLAG] & 
                           A  6220    .LINE 2412
                           A  6221    
041ED2 DD3106              A  6222    	LD	IY,(IX+%6)
041ED5 ED031E              A  6223    	LEA	BC,IY+%1E
041ED8 DD0FEA              A  6224    	LD	(IX+%FFFFFFEA),BC
041EDB DD31EA              A  6225    	LD	IY,(IX+%FFFFFFEA)
041EDE FD7E0B              A  6226    	LD	A,(IY+%B)
041EE1 E601                A  6227    	AND	A,%1
041EE3 20 1D               A  6228    	JR	NZ,L_200
041EE5 010B0000            A  6229    	LD	BC,11
041EE9 C5                  A  6230    	PUSH	BC
041EEA DD07EA              A  6231    	LD	BC,(IX+%FFFFFFEA)
041EED C5                  A  6232    	PUSH	BC
041EEE DD3106              A  6233    	LD	IY,(IX+%6)
041EF1 FD071B              A  6234    	LD	BC,(IY+%1B)
041EF4 C5                  A  6235    	PUSH	BC
041EF5 CD A9 46 04         A  6236    	CALL	_memcmp
041EF9 C1                  A  6237    	POP	BC
041EFA C1                  A  6238    	POP	BC
041EFB C1                  A  6239    	POP	BC
041EFC CD E5 46 04         A  6240    	CALL	__icmpzero
041F00 28 2C               A  6241    	JR	Z,L_208
041F02                     A  6242    L_200:
                           A  6243    ; 2413					ord = 0xFF; dp->blk_ofs
                           A  6244    .LINE 2413
                           A  6245    
041F02 DD36FEFF            A  6246    	LD	(IX+%FFFFFFFE),%FF
041F06 01FFFFFF            A  6247    	LD	BC,16777215
041F0A DD3106              A  6248    	LD	IY,(IX+%6)
041F0D FD0F2A              A  6249    	LD	(IY+%2A),BC
041F10 FD362DFF            A  6250    	LD	(IY+%2D),%FF
                           A  6251    ; 2414				}
                           A  6252    ; 2415			}
041F14                     A  6253    L_205:
                           A  6254    .LINE 2415
                           A  6255    
                           A  6256    ; 2416	#else		/* Non LFN configuration */
                           A  6257    ; 2417			dp->obj.attr = dp->dir[DIR_Attr
                           A  6258    ; 2418			if (!(dp->dir[DIR_Attr] & AM_VO
                           A  6259    ; 2419	#endif
                           A  6260    ; 2420			res = dir_next(dp, 0);	/* Next
                           A  6261    .LINE 2420
                           A  6262    
041F14 01000000            A  6263    	LD	BC,0
041F18 C5                  A  6264    	PUSH	BC
041F19 DD0706              A  6265    	LD	BC,(IX+%6)
041F1C C5                  A  6266    	PUSH	BC
041F1D CD BA 16 04         A  6267    	CALL	_dir_next
041F21 C1                  A  6268    	POP	BC
041F22 C1                  A  6269    	POP	BC
041F23 DD2FFB              A  6270    	LD	(IX+%FFFFFFFB),HL
                           A  6271    ; 2421		} while (res == FR_OK);
                           A  6272    .LINE 2421
                           A  6273    
041F26 CD E5 46 04         A  6274    	CALL	__icmpzero
041F2A CA AD 1D 04         A  6275    	JR	Z,L_206
041F2E                     A  6276    L_208:
                           A  6277    ; 2422	
                           A  6278    ; 2423		return res;
                           A  6279    .LINE 2423
                           A  6280    
041F2E DD27FB              A  6281    	LD	HL,(IX+%FFFFFFFB)
                           A  6282    ; 2424	}
041F31                     A  6283    L_209:
                           A  6284    .LINE 2424
                           A  6285    
041F31 DDF9                A  6286    	LD	SP,IX
041F33 DDE1                A  6287    	POP	IX
041F35 C9                  A  6288    	RET	
                           A  6289    
                           A  6290    
                           A  6291    ;**************************** _dir_find *******
                           A  6292    ;Name                         Addr/Register   S
                           A  6293    ;_memcmp                             IMPORT  --
                           A  6294    ;G_8                                  IX-22    
                           A  6295    ;G_7                                  IX-19    
                           A  6296    ;G_6                                  IX-16    
                           A  6297    ;temp189                              IX-13    
                           A  6298    ;fs                                   IX-10    
                           A  6299    ;sum                                   IX-7    
                           A  6300    ;a                                     IX-6    
                           A  6301    ;res                                   IX-5    
                           A  6302    ;ord                                   IX-2    
                           A  6303    ;c                                     IX-1    
                           A  6304    ;dp                                    IX+6    
                           A  6305    
                           A  6306    
                           A  6307    ; Stack Frame Size: 31 (bytes)
                           A  6308    ;       Spill Code: 0 (instruction)
                           A  6309    
                           A  6310    
                           A  6311    .ENDFUNC "dir_find",2424,"_dir_find"
                           A  6312    ; 2425	
                           A  6313    ; 2426	
                           A  6314    ; 2427	
                           A  6315    ; 2428	
                           A  6316    ; 2429	#if !FF_FS_READONLY
                           A  6317    ; 2430	/*-------------------------------------
                           A  6318    ; 2431	/* Register an object to the directory 
                           A  6319    ; 2432	/*-------------------------------------
                           A  6320    ; 2433	
                           A  6321    ; 2434	static FRESULT dir_register (	/* FR_O
                           A  6322    ; 2435		DIR* dp						/* Targ
                           A  6323    ; 2436	)
                           A  6324    ; 2437	{
                           A  6325    ; 2438		FRESULT res;
                           A  6326    ; 2439		FATFS *fs = dp->obj.fs;
                           A  6327    ; 2440	#if FF_USE_LFN		/* LFN configuratio
                           A  6328    ; 2441		UINT n, len, n_ent;
                           A  6329    ; 2442		BYTE sn[12], sum;
                           A  6330    ; 2443	
                           A  6331    ; 2444	
                           A  6332    ; 2445		if (dp->fn[NSFLAG] & (NS_DOT | NS_N
                           A  6333    ; 2446		for (len = 0; fs->lfnbuf[len]; len+
                           A  6334    ; 2447	
                           A  6335    ; 2448	#if FF_FS_EXFAT
                           A  6336    ; 2449		if (fs->fs_type == FS_EXFAT) {	/* 
                           A  6337    ; 2450			n_ent = (len + 14) / 15 + 2;	
                           A  6338    ; 2451			res = dir_alloc(dp, n_ent);		
                           A  6339    ; 2452			if (res != FR_OK) return res;
                           A  6340    ; 2453			dp->blk_ofs = dp->dptr - SZDIRE
                           A  6341    ; 2454	
                           A  6342    ; 2455			if (dp->obj.stat & 4) {			
                           A  6343    ; 2456				dp->obj.stat &= ~4;
                           A  6344    ; 2457				res = fill_first_frag(&dp->
                           A  6345    ; 2458				if (res != FR_OK) return re
                           A  6346    ; 2459				res = fill_last_frag(&dp->o
                           A  6347    ; 2460				if (res != FR_OK) return re
                           A  6348    ; 2461				if (dp->obj.sclust != 0) {	
                           A  6349    ; 2462					DIR dj;
                           A  6350    ; 2463	
                           A  6351    ; 2464					res = load_obj_xdir(&dj
                           A  6352    ; 2465					if (res != FR_OK) retur
                           A  6353    ; 2466					dp->obj.objsize += (DWO
                           A  6354    ; 2467					st_qword(fs->dirbuf + X
                           A  6355    ; 2468					st_qword(fs->dirbuf + X
                           A  6356    ; 2469					fs->dirbuf[XDIR_GenFlag
                           A  6357    ; 2470					res = store_xdir(&dj);	
                           A  6358    ; 2471					if (res != FR_OK) retur
                           A  6359    ; 2472				}
                           A  6360    ; 2473			}
                           A  6361    ; 2474	
                           A  6362    ; 2475			create_xdir(fs->dirbuf, fs->lfn
                           A  6363    ; 2476			return FR_OK;
                           A  6364    ; 2477		}
                           A  6365    ; 2478	#endif
                           A  6366    ; 2479		/* On the FAT/FAT32 volume */
                           A  6367    ; 2480		memcpy(sn, dp->fn, 12);
                           A  6368    ; 2481		if (sn[NSFLAG] & NS_LOSS) {			
                           A  6369    ; 2482			dp->fn[NSFLAG] = NS_NOLFN;		
                           A  6370    ; 2483			for (n = 1; n < 100; n++) {
                           A  6371    ; 2484				gen_numname(dp->fn, sn, fs-
                           A  6372    ; 2485				res = dir_find(dp);			
                           A  6373    ; 2486				if (res != FR_OK) break;
                           A  6374    ; 2487			}
                           A  6375    ; 2488			if (n == 100) return FR_DENIED;
                           A  6376    ; 2489			if (res != FR_NO_FILE) return r
                           A  6377    ; 2490			dp->fn[NSFLAG] = sn[NSFLAG];
                           A  6378    ; 2491		}
                           A  6379    ; 2492	
                           A  6380    ; 2493		/* Create an SFN with/without LFNs.
                           A  6381    ; 2494		n_ent = (sn[NSFLAG] & NS_LFN) ? (le
                           A  6382    ; 2495		res = dir_alloc(dp, n_ent);		/* 
                           A  6383    ; 2496		if (res == FR_OK && --n_ent) {	/* 
                           A  6384    ; 2497			res = dir_sdi(dp, dp->dptr - n_
                           A  6385    ; 2498			if (res == FR_OK) {
                           A  6386    ; 2499				sum = sum_sfn(dp->fn);	/* 
                           A  6387    ; 2500				do {					/* 
                           A  6388    ; 2501					res = move_window(fs, d
                           A  6389    ; 2502					if (res != FR_OK) break
                           A  6390    ; 2503					put_lfn(fs->lfnbuf, dp-
                           A  6391    ; 2504					fs->wflag = 1;
                           A  6392    ; 2505					res = dir_next(dp, 0);	
                           A  6393    ; 2506				} while (res == FR_OK && --
                           A  6394    ; 2507			}
                           A  6395    ; 2508		}
                           A  6396    ; 2509	
                           A  6397    ; 2510	#else	/* Non LFN configuration */
                           A  6398    ; 2511		res = dir_alloc(dp, 1);		/* Allo
                           A  6399    ; 2512	
                           A  6400    ; 2513	#endif
                           A  6401    ; 2514	
                           A  6402    ; 2515		/* Set SFN entry */
                           A  6403    ; 2516		if (res == FR_OK) {
                           A  6404    ; 2517			res = move_window(fs, dp->sect)
                           A  6405    ; 2518			if (res == FR_OK) {
                           A  6406    ; 2519				memset(dp->dir, 0, SZDIRE);
                           A  6407    ; 2520				memcpy(dp->dir + DIR_Name, 
                           A  6408    ; 2521	#if FF_USE_LFN
                           A  6409    ; 2522				dp->dir[DIR_NTres] = dp->fn
                           A  6410    ; 2523	#endif
                           A  6411    ; 2524				fs->wflag = 1;
                           A  6412    ; 2525			}
                           A  6413    ; 2526		}
                           A  6414    ; 2527	
                           A  6415    ; 2528		return res;
                           A  6416    ; 2529	}
                           A  6417    ; 2530	
                           A  6418    ; 2531	#endif /* !FF_FS_READONLY */
                           A  6419    ; 2532	
                           A  6420    ; 2533	
                           A  6421    ; 2534	
                           A  6422    ; 2535	#if !FF_FS_READONLY && FF_FS_MINIMIZE =
                           A  6423    ; 2536	/*-------------------------------------
                           A  6424    ; 2537	/* Remove an object from the directory 
                           A  6425    ; 2538	/*-------------------------------------
                           A  6426    ; 2539	
                           A  6427    ; 2540	static FRESULT dir_remove (	/* FR_OK:Su
                           A  6428    ; 2541		DIR* dp					/* Director
                           A  6429    ; 2542	)
                           A  6430    ; 2543	{
                           A  6431    ; 2544		FRESULT res;
                           A  6432    ; 2545		FATFS *fs = dp->obj.fs;
                           A  6433    ; 2546	#if FF_USE_LFN		/* LFN configuratio
                           A  6434    ; 2547		DWORD last = dp->dptr;
                           A  6435    ; 2548	
                           A  6436    ; 2549		res = (dp->blk_ofs == 0xFFFFFFFF) ?
                           A  6437    ; 2550		if (res == FR_OK) {
                           A  6438    ; 2551			do {
                           A  6439    ; 2552				res = move_window(fs, dp->s
                           A  6440    ; 2553				if (res != FR_OK) break;
                           A  6441    ; 2554				if (FF_FS_EXFAT && fs->fs_t
                           A  6442    ; 2555					dp->dir[XDIR_Type] &= 0
                           A  6443    ; 2556				} else {					
                           A  6444    ; 2557					dp->dir[DIR_Name] = DDE
                           A  6445    ; 2558				}
                           A  6446    ; 2559				fs->wflag = 1;
                           A  6447    ; 2560				if (dp->dptr >= last) break
                           A  6448    ; 2561				res = dir_next(dp, 0);	/* 
                           A  6449    ; 2562			} while (res == FR_OK);
                           A  6450    ; 2563			if (res == FR_NO_FILE) res = FR
                           A  6451    ; 2564		}
                           A  6452    ; 2565	#else			/* Non LFN configuratio
                           A  6453    ; 2566	
                           A  6454    ; 2567		res = move_window(fs, dp->sect);
                           A  6455    ; 2568		if (res == FR_OK) {
                           A  6456    ; 2569			dp->dir[DIR_Name] = DDEM;	/* 
                           A  6457    ; 2570			fs->wflag = 1;
                           A  6458    ; 2571		}
                           A  6459    ; 2572	#endif
                           A  6460    ; 2573	
                           A  6461    ; 2574		return res;
                           A  6462    ; 2575	}
                           A  6463    ; 2576	
                           A  6464    ; 2577	#endif /* !FF_FS_READONLY && FF_FS_MINI
                           A  6465    ; 2578	
                           A  6466    ; 2579	
                           A  6467    ; 2580	
                           A  6468    ; 2581	#if FF_FS_MINIMIZE <= 1 || FF_FS_RPATH 
                           A  6469    ; 2582	/*-------------------------------------
                           A  6470    ; 2583	/* Get file information from directory 
                           A  6471    ; 2584	/*-------------------------------------
                           A  6472    ; 2585	
                           A  6473    ; 2586	static void get_fileinfo (
                           A  6474    ; 2587		DIR* dp,			/* Pointer to t
                           A  6475    ; 2588		FILINFO* fno		/* Pointer to t
                           A  6476    ; 2589	)
                           A  6477    ; 2590	{
041F36                     A  6478    _get_fileinfo:
                           A  6479    .DEFINE "_get_fileinfo"
                           A  6480    
                           A  6481    .VALUE _get_fileinfo
                           A  6482    
                           A  6483    .CLASS 3
                           A  6484    
                           A  6485    .TYPE 65
                           A  6486    
                           A  6487    .ENDEF
                           A  6488    
                           A  6489    .BEGFUNC "get_fileinfo",2590,"_get_fileinfo"
                           A  6490    
                           A  6491    .LINE 2590
                           A  6492    
                           A  6493    .DEFINE "dp"
                           A  6494    
                           A  6495    .CLASS 65
                           A  6496    
                           A  6497    .VALUE 6
                           A  6498    
                           A  6499    .TAG "NONAME3"
                           A  6500    
                           A  6501    .TYPE 40
                           A  6502    
                           A  6503    .ENDEF
                           A  6504    
                           A  6505    .DEFINE "fno"
                           A  6506    
                           A  6507    .CLASS 65
                           A  6508    
                           A  6509    .VALUE 9
                           A  6510    
                           A  6511    .TAG "NONAME4"
                           A  6512    
                           A  6513    .TYPE 40
                           A  6514    
                           A  6515    .ENDEF
                           A  6516    
                           A  6517    .DEFINE "di"
                           A  6518    
                           A  6519    .CLASS 65
                           A  6520    
                           A  6521    .VALUE -3
                           A  6522    
                           A  6523    .TYPE 14
                           A  6524    
                           A  6525    .ENDEF
                           A  6526    
                           A  6527    .DEFINE "wc"
                           A  6528    
                           A  6529    .CLASS 65
                           A  6530    
                           A  6531    .VALUE -5
                           A  6532    
                           A  6533    .TYPE 13
                           A  6534    
                           A  6535    .ENDEF
                           A  6536    
                           A  6537    .DEFINE "si"
                           A  6538    
                           A  6539    .CLASS 65
                           A  6540    
                           A  6541    .VALUE -8
                           A  6542    
                           A  6543    .TYPE 14
                           A  6544    
                           A  6545    .ENDEF
                           A  6546    
                           A  6547    .DEFINE "hs"
                           A  6548    
                           A  6549    .CLASS 65
                           A  6550    
                           A  6551    .VALUE -10
                           A  6552    
                           A  6553    .TYPE 13
                           A  6554    
                           A  6555    .ENDEF
                           A  6556    
                           A  6557    .DEFINE "lcf"
                           A  6558    
                           A  6559    .CLASS 65
                           A  6560    
                           A  6561    .VALUE -11
                           A  6562    
                           A  6563    .TYPE 12
                           A  6564    
                           A  6565    .ENDEF
                           A  6566    
                           A  6567    .DEFINE "nw"
                           A  6568    
                           A  6569    .CLASS 65
                           A  6570    
                           A  6571    .VALUE -23
                           A  6572    
                           A  6573    .TYPE 14
                           A  6574    
                           A  6575    .ENDEF
                           A  6576    
                           A  6577    .DEFINE "fs"
                           A  6578    
                           A  6579    .CLASS 65
                           A  6580    
                           A  6581    .VALUE -29
                           A  6582    
                           A  6583    .TAG "NONAME0"
                           A  6584    
                           A  6585    .TYPE 40
                           A  6586    
                           A  6587    .ENDEF
                           A  6588    
041F36 DDE5                A  6589    	PUSH	IX
041F38 DD210000 00         A  6590    	LD	IX,0
041F3D DD39                A  6591    	ADD	IX,SP
041F3F ED22DF              A  6592    	LEA	HL,IX+%FFFFFFDF
041F42 F9                  A  6593    	LD	SP,HL
                           A  6594    ; 2591		UINT si, di;
                           A  6595    ; 2592	#if FF_USE_LFN
                           A  6596    ; 2593		BYTE lcf;
                           A  6597    ; 2594		WCHAR wc, hs;
                           A  6598    ; 2595		FATFS *fs = dp->obj.fs;
                           A  6599    .LINE 2595
                           A  6600    
041F43 DD3106              A  6601    	LD	IY,(IX+%6)
041F46 FD0700              A  6602    	LD	BC,(IY+%0)
041F49 DD0FE3              A  6603    	LD	(IX+%FFFFFFE3),BC
                           A  6604    ; 2596		UINT nw;
                           A  6605    ; 2597	#else
                           A  6606    ; 2598		TCHAR c;
                           A  6607    ; 2599	#endif
                           A  6608    ; 2600	
                           A  6609    ; 2601	
                           A  6610    ; 2602		fno->fname[0] = 0;			/* Inva
                           A  6611    .LINE 2602
                           A  6612    
041F4C DD3109              A  6613    	LD	IY,(IX+%9)
041F4F FD361600            A  6614    	LD	(IY+%16),%0
                           A  6615    ; 2603		if (dp->sect == 0) return;	/* Exit
                           A  6616    .LINE 2603
                           A  6617    
041F53 DD3106              A  6618    	LD	IY,(IX+%6)
041F56 FD2717              A  6619    	LD	HL,(IY+%17)
041F59 FD5E1A              A  6620    	LD	E,(IY+%1A)
041F5C CD B8 45 04         A  6621    	CALL	__lcmpzero
041F60 CA 73 22 04         A  6622    	JR	Z,L_257
                           A  6623    ; 2604	
                           A  6624    ; 2605	#if FF_USE_LFN		/* LFN configuratio
                           A  6625    ; 2606	#if FF_FS_EXFAT
                           A  6626    ; 2607		if (fs->fs_type == FS_EXFAT) {	/* 
                           A  6627    ; 2608			UINT nc = 0;
                           A  6628    ; 2609	
                           A  6629    ; 2610			si = SZDIRE * 2; di = 0;	/* 
                           A  6630    ; 2611			hs = 0;
                           A  6631    ; 2612			while (nc < fs->dirbuf[XDIR_Num
                           A  6632    ; 2613				if (si >= MAXDIRB(FF_MAX_LF
                           A  6633    ; 2614				if ((si % SZDIRE) == 0) si 
                           A  6634    ; 2615				wc = ld_word(fs->dirbuf + s
                           A  6635    ; 2616				if (hs == 0 && IsSurrogate(
                           A  6636    ; 2617					hs = wc; continue;		
                           A  6637    ; 2618				}
                           A  6638    ; 2619				nw = put_utf((DWORD)hs << 1
                           A  6639    ; 2620				if (nw == 0) { di = 0; brea
                           A  6640    ; 2621				di += nw;
                           A  6641    ; 2622				hs = 0;
                           A  6642    ; 2623			}
                           A  6643    ; 2624			if (hs != 0) di = 0;			
                           A  6644    ; 2625			if (di == 0) fno->fname[di++] =
                           A  6645    ; 2626			fno->fname[di] = 0;				
                           A  6646    ; 2627			fno->altname[0] = 0;			
                           A  6647    ; 2628	
                           A  6648    ; 2629			fno->fattrib = fs->dirbuf[XDIR_
                           A  6649    ; 2630			fno->fsize = (fno->fattrib & AM
                           A  6650    ; 2631			fno->ftime = ld_word(fs->dirbuf
                           A  6651    ; 2632			fno->fdate = ld_word(fs->dirbuf
                           A  6652    ; 2633			return;
                           A  6653    ; 2634		} else
                           A  6654    ; 2635	#endif
                           A  6655    ; 2636		{	/* FAT/FAT32 volume */
                           A  6656    ; 2637			if (dp->blk_ofs != 0xFFFFFFFF) 
                           A  6657    .LINE 2637
                           A  6658    
041F64 DD3106              A  6659    	LD	IY,(IX+%6)
041F67 FD272A              A  6660    	LD	HL,(IY+%2A)
041F6A FD5E2D              A  6661    	LD	E,(IY+%2D)
041F6D 01FFFFFF            A  6662    	LD	BC,16777215
041F71 3EFF                A  6663    	LD	A,%FF
041F73 CD 88 47 04         A  6664    	CALL	__lcmpu
041F77 CA 7F 20 04         A  6665    	JR	Z,L_225
                           A  6666    ; 2638				si = di = 0;
                           A  6667    .LINE 2638
                           A  6668    
041F7B 01000000            A  6669    	LD	BC,0
041F7F DD0FFD              A  6670    	LD	(IX+%FFFFFFFD),BC
041F82 DD0FF8              A  6671    	LD	(IX+%FFFFFFF8),BC
                           A  6672    ; 2639				hs = 0;
                           A  6673    .LINE 2639
                           A  6674    
041F85 DD36F600            A  6675    	LD	(IX+%FFFFFFF6),%0
041F89 DD36F700            A  6676    	LD	(IX+%FFFFFFF7),%0
                           A  6677    ; 2640				while (fs->lfnbuf[si] != 0)
                           A  6678    .LINE 2640
                           A  6679    
041F8D C3 48 20 04         A  6680    	JR	L_218
041F91                     A  6681    L_219:
                           A  6682    ; 2641					wc = fs->lfnbuf[si++];	
                           A  6683    .LINE 2641
                           A  6684    
041F91 DD27F8              A  6685    	LD	HL,(IX+%FFFFFFF8)
041F94 29                  A  6686    	ADD	HL,HL
041F95 DD07EF              A  6687    	LD	BC,(IX+%FFFFFFEF)
041F98 09                  A  6688    	ADD	HL,BC
041F99 ED07                A  6689    	LD	BC,(HL)
041F9B DD71FB              A  6690    	LD	(IX+%FFFFFFFB),C
041F9E DD70FC              A  6691    	LD	(IX+%FFFFFFFC),B
041FA1 DD07F8              A  6692    	LD	BC,(IX+%FFFFFFF8)
041FA4 03                  A  6693    	INC	BC
041FA5 DD0FF8              A  6694    	LD	(IX+%FFFFFFF8),BC
                           A  6695    ; 2642					if (hs == 0 && IsSurrog
                           A  6696    .LINE 2642
                           A  6697    
041FA8 DD27F6              A  6698    	LD	HL,(IX+%FFFFFFF6)
041FAB CD D8 47 04         A  6699    	CALL	__scmpzero
041FAF 20 25               A  6700    	JR	NZ,L_215
041FB1 490100D8            A  6701    	LD.LIS	BC,55296
041FB5 DD27FB              A  6702    	LD	HL,(IX+%FFFFFFFB)
041FB8 B7                  A  6703    	OR	A,A
041FB9 40ED42              A  6704    	SBC.SIS	HL,BC
041FBC 38 18               A  6705    	JR	C,L_215
041FBE DD07FB              A  6706    	LD	BC,(IX+%FFFFFFFB)
041FC1 4921FFDF            A  6707    	LD.LIS	HL,57343
041FC5 B7                  A  6708    	OR	A,A
041FC6 40ED42              A  6709    	SBC.SIS	HL,BC
041FC9 38 0B               A  6710    	JR	C,L_215
                           A  6711    ; 2643						hs = wc; continue;	
                           A  6712    .LINE 2643
                           A  6713    
041FCB DD07FB              A  6714    	LD	BC,(IX+%FFFFFFFB)
041FCE DD71F6              A  6715    	LD	(IX+%FFFFFFF6),C
041FD1 DD70F7              A  6716    	LD	(IX+%FFFFFFF7),B
041FD4 18 72               A  6717    	JR	L_218
                           A  6718    ; 2644					}
041FD6                     A  6719    L_215:
                           A  6720    .LINE 2644
                           A  6721    
                           A  6722    ; 2645					nw = put_utf((DWORD)hs 
                           A  6723    .LINE 2645
                           A  6724    
041FD6 21FF0000            A  6725    	LD	HL,255
041FDA DD07FD              A  6726    	LD	BC,(IX+%FFFFFFFD)
041FDD B7                  A  6727    	OR	A,A
041FDE ED42                A  6728    	SBC	HL,BC
041FE0 E5                  A  6729    	PUSH	HL
041FE1 DD07FD              A  6730    	LD	BC,(IX+%FFFFFFFD)
041FE4 DD3109              A  6731    	LD	IY,(IX+%9)
041FE7 ED2316              A  6732    	LEA	HL,IY+%16
041FEA 09                  A  6733    	ADD	HL,BC
041FEB E5                  A  6734    	PUSH	HL
041FEC DD07F6              A  6735    	LD	BC,(IX+%FFFFFFF6)
041FEF CD 73 45 04         A  6736    	CALL	__stoiu
041FF3 AF                  A  6737    	XOR	A,A
041FF4 E5C1                A  6738    	LD	BC,HL
041FF6 2E10                A  6739    	LD	L,%10
041FF8 CD E5 47 04         A  6740    	CALL	__lshl
041FFC DD0FE0              A  6741    	LD	(IX+%FFFFFFE0),BC
041FFF 5F                  A  6742    	LD	E,A
042000 DD07FB              A  6743    	LD	BC,(IX+%FFFFFFFB)
042003 CD 73 45 04         A  6744    	CALL	__stoiu
042007 E5C1                A  6745    	LD	BC,HL
042009 AF                  A  6746    	XOR	A,A
04200A DD27E0              A  6747    	LD	HL,(IX+%FFFFFFE0)
04200D CD D3 46 04         A  6748    	CALL	__lor
042011 4B                  A  6749    	LD	C,E
042012 0600                A  6750    	LD	B,%0
042014 C5                  A  6751    	PUSH	BC
042015 E5                  A  6752    	PUSH	HL
042016 DD77DF              A  6753    	LD	(IX+%FFFFFFDF),A
042019 CD ED 10 04         A  6754    	CALL	_put_utf
04201D DD7EDF              A  6755    	LD	A,(IX+%FFFFFFDF)
042020 C1                  A  6756    	POP	BC
042021 C1                  A  6757    	POP	BC
042022 C1                  A  6758    	POP	BC
042023 C1                  A  6759    	POP	BC
042024 DD2FE9              A  6760    	LD	(IX+%FFFFFFE9),HL
                           A  6761    ; 2646					if (nw == 0) { di = 0; 
                           A  6762    .LINE 2646
                           A  6763    
042027 CD E5 46 04         A  6764    	CALL	__icmpzero
04202B 20 09               A  6765    	JR	NZ,L_217
04202D 01000000            A  6766    	LD	BC,0
042031 DD0FFD              A  6767    	LD	(IX+%FFFFFFFD),BC
042034 18 2D               A  6768    	JR	L_221
042036                     A  6769    L_217:
                           A  6770    ; 2647					di += nw;
                           A  6771    .LINE 2647
                           A  6772    
042036 DD07E9              A  6773    	LD	BC,(IX+%FFFFFFE9)
042039 DD27FD              A  6774    	LD	HL,(IX+%FFFFFFFD)
04203C 09                  A  6775    	ADD	HL,BC
04203D DD2FFD              A  6776    	LD	(IX+%FFFFFFFD),HL
                           A  6777    ; 2648					hs = 0;
                           A  6778    .LINE 2648
                           A  6779    
042040 DD36F600            A  6780    	LD	(IX+%FFFFFFF6),%0
042044 DD36F700            A  6781    	LD	(IX+%FFFFFFF7),%0
                           A  6782    ; 2649				}
042048                     A  6783    L_218:
                           A  6784    .LINE 2649
                           A  6785    
042048 DD31E3              A  6786    	LD	IY,(IX+%FFFFFFE3)
04204B FD070B              A  6787    	LD	BC,(IY+%B)
04204E DD0FEF              A  6788    	LD	(IX+%FFFFFFEF),BC
042051 DD27F8              A  6789    	LD	HL,(IX+%FFFFFFF8)
042054 29                  A  6790    	ADD	HL,HL
042055 DD07EF              A  6791    	LD	BC,(IX+%FFFFFFEF)
042058 09                  A  6792    	ADD	HL,BC
042059 ED27                A  6793    	LD	HL,(HL)
04205B CD D8 47 04         A  6794    	CALL	__scmpzero
04205F C2 91 1F 04         A  6795    	JR	NZ,L_219
042063                     A  6796    L_221:
                           A  6797    ; 2650				if (hs != 0) di = 0;	/* 
                           A  6798    .LINE 2650
                           A  6799    
042063 DD27F6              A  6800    	LD	HL,(IX+%FFFFFFF6)
042066 CD D8 47 04         A  6801    	CALL	__scmpzero
04206A 28 07               A  6802    	JR	Z,L_222
04206C 01000000            A  6803    	LD	BC,0
042070 DD0FFD              A  6804    	LD	(IX+%FFFFFFFD),BC
042073                     A  6805    L_222:
                           A  6806    ; 2651				fno->fname[di] = 0;		/* 
                           A  6807    .LINE 2651
                           A  6808    
042073 DD07FD              A  6809    	LD	BC,(IX+%FFFFFFFD)
042076 DD3109              A  6810    	LD	IY,(IX+%9)
042079 ED2316              A  6811    	LEA	HL,IY+%16
04207C 09                  A  6812    	ADD	HL,BC
04207D 3600                A  6813    	LD	(HL),%0
                           A  6814    ; 2652			}
                           A  6815    ; 2653		}
04207F                     A  6816    L_225:
                           A  6817    .LINE 2653
                           A  6818    
                           A  6819    ; 2654	
                           A  6820    ; 2655		si = di = 0;
                           A  6821    .LINE 2655
                           A  6822    
04207F 01000000            A  6823    	LD	BC,0
042083 DD0FFD              A  6824    	LD	(IX+%FFFFFFFD),BC
042086 DD0FF8              A  6825    	LD	(IX+%FFFFFFF8),BC
                           A  6826    ; 2656		while (si < 11) {		/* Get SFN 
                           A  6827    .LINE 2656
                           A  6828    
042089 18 7E               A  6829    	JR	L_236
04208B                     A  6830    L_237:
                           A  6831    ; 2657			wc = dp->dir[si++];			/* 
                           A  6832    .LINE 2657
                           A  6833    
04208B DD07F8              A  6834    	LD	BC,(IX+%FFFFFFF8)
04208E DD3106              A  6835    	LD	IY,(IX+%6)
042091 FD271B              A  6836    	LD	HL,(IY+%1B)
042094 09                  A  6837    	ADD	HL,BC
042095 4E                  A  6838    	LD	C,(HL)
042096 0600                A  6839    	LD	B,%0
042098 C5E1                A  6840    	LD	HL,BC
04209A DD75FB              A  6841    	LD	(IX+%FFFFFFFB),L
04209D DD74FC              A  6842    	LD	(IX+%FFFFFFFC),H
0420A0 DD07F8              A  6843    	LD	BC,(IX+%FFFFFFF8)
0420A3 03                  A  6844    	INC	BC
0420A4 DD0FF8              A  6845    	LD	(IX+%FFFFFFF8),BC
                           A  6846    ; 2658			if (wc == ' ') continue;	/* 
                           A  6847    .LINE 2658
                           A  6848    
0420A7 49012000            A  6849    	LD.LIS	BC,32
0420AB DD27FB              A  6850    	LD	HL,(IX+%FFFFFFFB)
0420AE B7                  A  6851    	OR	A,A
0420AF 40ED42              A  6852    	SBC.SIS	HL,BC
0420B2 28 55               A  6853    	JR	Z,L_236
                           A  6854    ; 2659			if (wc == RDDEM) wc = DDEM;	/* 
                           A  6855    .LINE 2659
                           A  6856    
0420B4 49010500            A  6857    	LD.LIS	BC,5
0420B8 DD27FB              A  6858    	LD	HL,(IX+%FFFFFFFB)
0420BB B7                  A  6859    	OR	A,A
0420BC 40ED42              A  6860    	SBC.SIS	HL,BC
0420BF 20 08               A  6861    	JR	NZ,L_233
0420C1 DD36FBE5            A  6862    	LD	(IX+%FFFFFFFB),%E5
0420C5 DD36FC00            A  6863    	LD	(IX+%FFFFFFFC),%0
0420C9                     A  6864    L_233:
                           A  6865    ; 2660			if (si == 9 && di < FF_SFN_BUF)
                           A  6866    .LINE 2660
                           A  6867    
0420C9 01090000            A  6868    	LD	BC,9
0420CD DD27F8              A  6869    	LD	HL,(IX+%FFFFFFF8)
0420D0 B7                  A  6870    	OR	A,A
0420D1 ED42                A  6871    	SBC	HL,BC
0420D3 20 1F               A  6872    	JR	NZ,L_235
0420D5 010C0000            A  6873    	LD	BC,12
0420D9 DD27FD              A  6874    	LD	HL,(IX+%FFFFFFFD)
0420DC B7                  A  6875    	OR	A,A
0420DD ED42                A  6876    	SBC	HL,BC
0420DF 30 13               A  6877    	JR	NC,L_235
0420E1 DD07FD              A  6878    	LD	BC,(IX+%FFFFFFFD)
0420E4 DD3109              A  6879    	LD	IY,(IX+%9)
0420E7 ED2309              A  6880    	LEA	HL,IY+%9
0420EA 09                  A  6881    	ADD	HL,BC
0420EB 362E                A  6882    	LD	(HL),%2E
0420ED DD07FD              A  6883    	LD	BC,(IX+%FFFFFFFD)
0420F0 03                  A  6884    	INC	BC
0420F1 DD0FFD              A  6885    	LD	(IX+%FFFFFFFD),BC
0420F4                     A  6886    L_235:
                           A  6887    ; 2661	#if FF_LFN_UNICODE >= 1	/* Unicode outp
                           A  6888    ; 2662			if (dbc_1st((BYTE)wc) && si != 
                           A  6889    ; 2663				wc = wc << 8 | dp->dir[si++
                           A  6890    ; 2664			}
                           A  6891    ; 2665			wc = ff_oem2uni(wc, CODEPAGE);	
                           A  6892    ; 2666			if (wc == 0) { di = 0; break; }
                           A  6893    ; 2667			nw = put_utf(wc, &fno->altname[
                           A  6894    ; 2668			if (nw == 0) { di = 0; break; }
                           A  6895    ; 2669			di += nw;
                           A  6896    ; 2670	#else					/* ANSI/OEM out
                           A  6897    ; 2671			fno->altname[di++] = (TCHAR)wc;
                           A  6898    .LINE 2671
                           A  6899    
0420F4 DD7EFB              A  6900    	LD	A,(IX+%FFFFFFFB)
0420F7 DD07FD              A  6901    	LD	BC,(IX+%FFFFFFFD)
0420FA DD3109              A  6902    	LD	IY,(IX+%9)
0420FD ED2309              A  6903    	LEA	HL,IY+%9
042100 09                  A  6904    	ADD	HL,BC
042101 77                  A  6905    	LD	(HL),A
042102 DD07FD              A  6906    	LD	BC,(IX+%FFFFFFFD)
042105 03                  A  6907    	INC	BC
042106 DD0FFD              A  6908    	LD	(IX+%FFFFFFFD),BC
                           A  6909    ; 2672	#endif
                           A  6910    ; 2673		}
042109                     A  6911    L_236:
                           A  6912    .LINE 2673
                           A  6913    
042109 010B0000            A  6914    	LD	BC,11
04210D DD27F8              A  6915    	LD	HL,(IX+%FFFFFFF8)
042110 B7                  A  6916    	OR	A,A
042111 ED42                A  6917    	SBC	HL,BC
042113 DA 8B 20 04         A  6918    	JR	C,L_237
                           A  6919    ; 2674		fno->altname[di] = 0;	/* Terminat
                           A  6920    .LINE 2674
                           A  6921    
042117 DD3109              A  6922    	LD	IY,(IX+%9)
04211A ED0309              A  6923    	LEA	BC,IY+%9
04211D DD0FEC              A  6924    	LD	(IX+%FFFFFFEC),BC
042120 DD07FD              A  6925    	LD	BC,(IX+%FFFFFFFD)
042123 ED2309              A  6926    	LEA	HL,IY+%9
042126 09                  A  6927    	ADD	HL,BC
042127 3600                A  6928    	LD	(HL),%0
                           A  6929    ; 2675	
                           A  6930    ; 2676		if (fno->fname[0] == 0) {	/* If L
                           A  6931    .LINE 2676
                           A  6932    
042129 ED0316              A  6933    	LEA	BC,IY+%16
04212C DD0FF2              A  6934    	LD	(IX+%FFFFFFF2),BC
04212F FD7E16              A  6935    	LD	A,(IY+%16)
042132 B7                  A  6936    	OR	A,A
042133 C2 15 22 04         A  6937    	JR	NZ,L_256
                           A  6938    ; 2677			if (di == 0) {	/* If LFN and S
                           A  6939    .LINE 2677
                           A  6940    
042137 DD27FD              A  6941    	LD	HL,(IX+%FFFFFFFD)
04213A CD E5 46 04         A  6942    	CALL	__icmpzero
04213E 20 1D               A  6943    	JR	NZ,L_252
                           A  6944    ; 2678				fno->fname[di++] = '?';
                           A  6945    .LINE 2678
                           A  6946    
042140 DD3109              A  6947    	LD	IY,(IX+%9)
042143 ED0316              A  6948    	LEA	BC,IY+%16
042146 DD0FF2              A  6949    	LD	(IX+%FFFFFFF2),BC
042149 DD07FD              A  6950    	LD	BC,(IX+%FFFFFFFD)
04214C ED2316              A  6951    	LEA	HL,IY+%16
04214F 09                  A  6952    	ADD	HL,BC
042150 363F                A  6953    	LD	(HL),%3F
042152 DD07FD              A  6954    	LD	BC,(IX+%FFFFFFFD)
042155 03                  A  6955    	INC	BC
042156 DD0FFD              A  6956    	LD	(IX+%FFFFFFFD),BC
                           A  6957    ; 2679			} else {
                           A  6958    .LINE 2679
                           A  6959    
042159 C3 FB 21 04         A  6960    	JR	L_253
04215D                     A  6961    L_252:
                           A  6962    ; 2680				for (si = di = 0, lcf = NS_
                           A  6963    .LINE 2680
                           A  6964    
04215D 01000000            A  6965    	LD	BC,0
042161 DD0FFD              A  6966    	LD	(IX+%FFFFFFFD),BC
042164 DD0FF8              A  6967    	LD	(IX+%FFFFFFF8),BC
042167 DD36F508            A  6968    	LD	(IX+%FFFFFFF5),%8
04216B 18 75               A  6969    	JR	L_250
04216D                     A  6970    L_248:
                           A  6971    ; 2681					wc = (WCHAR)fno->altnam
                           A  6972    .LINE 2681
                           A  6973    
04216D DD27E6              A  6974    	LD	HL,(IX+%FFFFFFE6)
042170 7E                  A  6975    	LD	A,(HL)
042171 47                  A  6976    	LD	B,A
042172 17ED62              A  6977    	SEXT	HL
042175 DD70FB              A  6978    	LD	(IX+%FFFFFFFB),B
042178 DD74FC              A  6979    	LD	(IX+%FFFFFFFC),H
                           A  6980    ; 2682					if (wc == '.') lcf = NS
                           A  6981    .LINE 2682
                           A  6982    
04217B 49012E00            A  6983    	LD.LIS	BC,46
04217F DD27FB              A  6984    	LD	HL,(IX+%FFFFFFFB)
042182 B7                  A  6985    	OR	A,A
042183 40ED42              A  6986    	SBC.SIS	HL,BC
042186 20 04               A  6987    	JR	NZ,L_246
042188 DD36F510            A  6988    	LD	(IX+%FFFFFFF5),%10
04218C                     A  6989    L_246:
                           A  6990    ; 2683					if (IsUpper(wc) && (dp-
                           A  6991    .LINE 2683
                           A  6992    
04218C 49014100            A  6993    	LD.LIS	BC,65
042190 DD27FB              A  6994    	LD	HL,(IX+%FFFFFFFB)
042193 B7                  A  6995    	OR	A,A
042194 40ED42              A  6996    	SBC.SIS	HL,BC
042197 38 27               A  6997    	JR	C,L_247
042199 DD07FB              A  6998    	LD	BC,(IX+%FFFFFFFB)
04219C 49215A00            A  6999    	LD.LIS	HL,90
0421A0 B7                  A  7000    	OR	A,A
0421A1 40ED42              A  7001    	SBC.SIS	HL,BC
0421A4 38 1A               A  7002    	JR	C,L_247
0421A6 DD3106              A  7003    	LD	IY,(IX+%6)
0421A9 FD371B              A  7004    	LD	IY,(IY+%1B)
0421AC FD7E0C              A  7005    	LD	A,(IY+%C)
0421AF DDA6F5              A  7006    	AND	A,(IX+%FFFFFFF5)
0421B2 28 0C               A  7007    	JR	Z,L_247
0421B4 DD31FB              A  7008    	LD	IY,(IX+%FFFFFFFB)
0421B7 ED2320              A  7009    	LEA	HL,IY+%20
0421BA DD75FB              A  7010    	LD	(IX+%FFFFFFFB),L
0421BD DD74FC              A  7011    	LD	(IX+%FFFFFFFC),H
0421C0                     A  7012    L_247:
                           A  7013    ; 2684					fno->fname[di] = (TCHAR
                           A  7014    .LINE 2684
                           A  7015    
0421C0 DD3109              A  7016    	LD	IY,(IX+%9)
0421C3 ED0316              A  7017    	LEA	BC,IY+%16
0421C6 DD0FF2              A  7018    	LD	(IX+%FFFFFFF2),BC
0421C9 DD7EFB              A  7019    	LD	A,(IX+%FFFFFFFB)
0421CC DD07FD              A  7020    	LD	BC,(IX+%FFFFFFFD)
0421CF ED2316              A  7021    	LEA	HL,IY+%16
0421D2 09                  A  7022    	ADD	HL,BC
0421D3 77                  A  7023    	LD	(HL),A
0421D4 DD07F8              A  7024    	LD	BC,(IX+%FFFFFFF8)
0421D7 03                  A  7025    	INC	BC
0421D8 DD0FF8              A  7026    	LD	(IX+%FFFFFFF8),BC
0421DB DD07FD              A  7027    	LD	BC,(IX+%FFFFFFFD)
0421DE 03                  A  7028    	INC	BC
0421DF DD0FFD              A  7029    	LD	(IX+%FFFFFFFD),BC
                           A  7030    ; 2685				}
0421E2                     A  7031    L_250:
                           A  7032    .LINE 2685
                           A  7033    
0421E2 DD3109              A  7034    	LD	IY,(IX+%9)
0421E5 ED0309              A  7035    	LEA	BC,IY+%9
0421E8 DD0FEC              A  7036    	LD	(IX+%FFFFFFEC),BC
0421EB DD07F8              A  7037    	LD	BC,(IX+%FFFFFFF8)
0421EE ED2309              A  7038    	LEA	HL,IY+%9
0421F1 09                  A  7039    	ADD	HL,BC
0421F2 DD2FE6              A  7040    	LD	(IX+%FFFFFFE6),HL
0421F5 7E                  A  7041    	LD	A,(HL)
0421F6 B7                  A  7042    	OR	A,A
0421F7 C2 6D 21 04         A  7043    	JR	NZ,L_248
                           A  7044    ; 2686			}
0421FB                     A  7045    L_253:
                           A  7046    .LINE 2686
                           A  7047    
                           A  7048    ; 2687			fno->fname[di] = 0;	/* Terminat
                           A  7049    .LINE 2687
                           A  7050    
0421FB DD07FD              A  7051    	LD	BC,(IX+%FFFFFFFD)
0421FE DD27F2              A  7052    	LD	HL,(IX+%FFFFFFF2)
042201 09                  A  7053    	ADD	HL,BC
042202 3600                A  7054    	LD	(HL),%0
                           A  7055    ; 2688			if (!dp->dir[DIR_NTres]) fno->a
                           A  7056    .LINE 2688
                           A  7057    
042204 DD3106              A  7058    	LD	IY,(IX+%6)
042207 FD371B              A  7059    	LD	IY,(IY+%1B)
04220A FD7E0C              A  7060    	LD	A,(IY+%C)
04220D B7                  A  7061    	OR	A,A
04220E 20 05               A  7062    	JR	NZ,L_256
042210 DD27EC              A  7063    	LD	HL,(IX+%FFFFFFEC)
042213 3600                A  7064    	LD	(HL),%0
                           A  7065    ; 2689		}
042215                     A  7066    L_256:
                           A  7067    .LINE 2689
                           A  7068    
                           A  7069    ; 2690	
                           A  7070    ; 2691	#else	/* Non-LFN configuration */
                           A  7071    ; 2692		si = di = 0;
                           A  7072    ; 2693		while (si < 11) {		/* Copy nam
                           A  7073    ; 2694			c = (TCHAR)dp->dir[si++];
                           A  7074    ; 2695			if (c == ' ') continue;		/* 
                           A  7075    ; 2696			if (c == RDDEM) c = DDEM;	/* 
                           A  7076    ; 2697			if (si == 9) fno->fname[di++] =
                           A  7077    ; 2698			fno->fname[di++] = c;
                           A  7078    ; 2699		}
                           A  7079    ; 2700		fno->fname[di] = 0;		/* Terminat
                           A  7080    ; 2701	#endif
                           A  7081    ; 2702	
                           A  7082    ; 2703		fno->fattrib = dp->dir[DIR_Attr] & 
                           A  7083    .LINE 2703
                           A  7084    
042215 DD3106              A  7085    	LD	IY,(IX+%6)
042218 FD371B              A  7086    	LD	IY,(IY+%1B)
04221B ED230B              A  7087    	LEA	HL,IY+%B
04221E 7E                  A  7088    	LD	A,(HL)
04221F E63F                A  7089    	AND	A,%3F
042221 DD3109              A  7090    	LD	IY,(IX+%9)
042224 FD7708              A  7091    	LD	(IY+%8),A
                           A  7092    ; 2704		fno->fsize = ld_dword(dp->dir + DIR
                           A  7093    .LINE 2704
                           A  7094    
042227 DD3106              A  7095    	LD	IY,(IX+%6)
04222A FD371B              A  7096    	LD	IY,(IY+%1B)
04222D ED031C              A  7097    	LEA	BC,IY+%1C
042230 C5                  A  7098    	PUSH	BC
042231 CD 61 0F 04         A  7099    	CALL	_ld_dword
042235 C1                  A  7100    	POP	BC
042236 DD3109              A  7101    	LD	IY,(IX+%9)
042239 FD2F00              A  7102    	LD	(IY+%0),HL
04223C FD7303              A  7103    	LD	(IY+%3),E
                           A  7104    ; 2705		fno->ftime = ld_word(dp->dir + DIR_
                           A  7105    .LINE 2705
                           A  7106    
04223F DD3106              A  7107    	LD	IY,(IX+%6)
042242 FD371B              A  7108    	LD	IY,(IY+%1B)
042245 ED0316              A  7109    	LEA	BC,IY+%16
042248 C5                  A  7110    	PUSH	BC
042249 CD 25 0F 04         A  7111    	CALL	_ld_word
04224D C1                  A  7112    	POP	BC
04224E DD3109              A  7113    	LD	IY,(IX+%9)
042251 E5C1                A  7114    	LD	BC,HL
042253 FD7106              A  7115    	LD	(IY+%6),C
042256 FD7007              A  7116    	LD	(IY+%7),B
                           A  7117    ; 2706		fno->fdate = ld_word(dp->dir + DIR_
                           A  7118    .LINE 2706
                           A  7119    
042259 DD3106              A  7120    	LD	IY,(IX+%6)
04225C FD371B              A  7121    	LD	IY,(IY+%1B)
04225F ED0318              A  7122    	LEA	BC,IY+%18
042262 C5                  A  7123    	PUSH	BC
042263 CD 25 0F 04         A  7124    	CALL	_ld_word
042267 C1                  A  7125    	POP	BC
042268 DD3109              A  7126    	LD	IY,(IX+%9)
04226B E5C1                A  7127    	LD	BC,HL
04226D FD7104              A  7128    	LD	(IY+%4),C
042270 FD7005              A  7129    	LD	(IY+%5),B
                           A  7130    ; 2707	}
042273                     A  7131    L_257:
                           A  7132    .LINE 2707
                           A  7133    
042273 DDF9                A  7134    	LD	SP,IX
042275 DDE1                A  7135    	POP	IX
042277 C9                  A  7136    	RET	
                           A  7137    
                           A  7138    
                           A  7139    ;**************************** _get_fileinfo ***
                           A  7140    ;Name                         Addr/Register   S
                           A  7141    ;fs                                   IX-29    
                           A  7142    ;G_11                                 IX-26    
                           A  7143    ;nw                                   IX-23    
                           A  7144    ;G_15                                 IX-20    
                           A  7145    ;G_9                                  IX-17    
                           A  7146    ;G_14                                 IX-14    
                           A  7147    ;lcf                                  IX-11    
                           A  7148    ;hs                                   IX-10    
                           A  7149    ;si                                    IX-8    
                           A  7150    ;wc                                    IX-5    
                           A  7151    ;di                                    IX-3    
                           A  7152    ;fno                                   IX+9    
                           A  7153    ;dp                                    IX+6    
                           A  7154    
                           A  7155    
                           A  7156    ; Stack Frame Size: 45 (bytes)
                           A  7157    ;       Spill Code: 0 (instruction)
                           A  7158    
                           A  7159    
                           A  7160    .ENDFUNC "get_fileinfo",2707,"_get_fileinfo"
                           A  7161    ; 2708	
                           A  7162    ; 2709	#endif /* FF_FS_MINIMIZE <= 1 || FF_FS_
                           A  7163    ; 2710	
                           A  7164    ; 2711	
                           A  7165    ; 2712	
                           A  7166    ; 2713	#if FF_USE_FIND && FF_FS_MINIMIZE <= 1
                           A  7167    ; 2714	/*-------------------------------------
                           A  7168    ; 2715	/* Pattern matching                    
                           A  7169    ; 2716	/*-------------------------------------
                           A  7170    ; 2717	
                           A  7171    ; 2718	#define FIND_RECURS	4	/* Maximum numb
                           A  7172    ; 2719	
                           A  7173    ; 2720	
                           A  7174    ; 2721	static DWORD get_achar (	/* Get a ch
                           A  7175    ; 2722		const TCHAR** ptr		/* Pointer 
                           A  7176    ; 2723	)
                           A  7177    ; 2724	{
                           A  7178    ; 2725		DWORD chr;
                           A  7179    ; 2726	
                           A  7180    ; 2727	
                           A  7181    ; 2728	#if FF_USE_LFN && FF_LFN_UNICODE >= 1	
                           A  7182    ; 2729		chr = tchar2uni(ptr);
                           A  7183    ; 2730		if (chr == 0xFFFFFFFF) chr = 0;		
                           A  7184    ; 2731		chr = ff_wtoupper(chr);
                           A  7185    ; 2732	
                           A  7186    ; 2733	#else									
                           A  7187    ; 2734		chr = (BYTE)*(*ptr)++;				
                           A  7188    ; 2735		if (IsLower(chr)) chr -= 0x20;		
                           A  7189    ; 2736	#if FF_CODE_PAGE == 0
                           A  7190    ; 2737		if (ExCvt && chr >= 0x80) chr = ExC
                           A  7191    ; 2738	#elif FF_CODE_PAGE < 900
                           A  7192    ; 2739		if (chr >= 0x80) chr = ExCvt[chr - 
                           A  7193    ; 2740	#endif
                           A  7194    ; 2741	#if FF_CODE_PAGE == 0 || FF_CODE_PAGE >
                           A  7195    ; 2742		if (dbc_1st((BYTE)chr)) {	/* Get 
                           A  7196    ; 2743			chr = dbc_2nd((BYTE)**ptr) ? ch
                           A  7197    ; 2744		}
                           A  7198    ; 2745	#endif
                           A  7199    ; 2746	
                           A  7200    ; 2747	#endif
                           A  7201    ; 2748		return chr;
                           A  7202    ; 2749	}
                           A  7203    ; 2750	
                           A  7204    ; 2751	
                           A  7205    ; 2752	static int pattern_match (	/* 0:mismat
                           A  7206    ; 2753		const TCHAR* pat,	/* Matching pat
                           A  7207    ; 2754		const TCHAR* nam,	/* String to be
                           A  7208    ; 2755		UINT skip,			/* Number of pr
                           A  7209    ; 2756		UINT recur			/* Recursion co
                           A  7210    ; 2757	)
                           A  7211    ; 2758	{
                           A  7212    ; 2759		const TCHAR *pptr, *nptr;
                           A  7213    ; 2760		DWORD pchr, nchr;
                           A  7214    ; 2761		UINT sk;
                           A  7215    ; 2762	
                           A  7216    ; 2763	
                           A  7217    ; 2764		while ((skip & 0xFF) != 0) {		
                           A  7218    ; 2765			if (!get_achar(&nam)) return 0;
                           A  7219    ; 2766			skip--;
                           A  7220    ; 2767		}
                           A  7221    ; 2768		if (*pat == 0 && skip) return 1;	
                           A  7222    ; 2769	
                           A  7223    ; 2770		do {
                           A  7224    ; 2771			pptr = pat; nptr = nam;			
                           A  7225    ; 2772			for (;;) {
                           A  7226    ; 2773				if (*pptr == '?' || *pptr =
                           A  7227    ; 2774					if (recur == 0) return 
                           A  7228    ; 2775					sk = 0;
                           A  7229    ; 2776					do {	/* Analyze the 
                           A  7230    ; 2777						if (*pptr++ == '?')
                           A  7231    ; 2778					} while (*pptr == '?' |
                           A  7232    ; 2779					if (pattern_match(pptr,
                           A  7233    ; 2780					nchr = *nptr; break;	
                           A  7234    ; 2781				}
                           A  7235    ; 2782				pchr = get_achar(&pptr);	
                           A  7236    ; 2783				nchr = get_achar(&nptr);	
                           A  7237    ; 2784				if (pchr != nchr) break;	
                           A  7238    ; 2785				if (pchr == 0) return 1;	
                           A  7239    ; 2786			}
                           A  7240    ; 2787			get_achar(&nam);			/* 
                           A  7241    ; 2788		} while (skip && nchr);		/* Retr
                           A  7242    ; 2789	
                           A  7243    ; 2790		return 0;
                           A  7244    ; 2791	}
                           A  7245    ; 2792	
                           A  7246    ; 2793	#endif /* FF_USE_FIND && FF_FS_MINIMIZE
                           A  7247    ; 2794	
                           A  7248    ; 2795	
                           A  7249    ; 2796	
                           A  7250    ; 2797	/*-------------------------------------
                           A  7251    ; 2798	/* Pick a top segment and create the ob
                           A  7252    ; 2799	/*-------------------------------------
                           A  7253    ; 2800	
                           A  7254    ; 2801	static FRESULT create_name (	/* FR_O
                           A  7255    ; 2802		DIR* dp,					/* Poin
                           A  7256    ; 2803		const TCHAR** path			/* Poin
                           A  7257    ; 2804	)
                           A  7258    ; 2805	{
042278                     A  7259    _create_name:
                           A  7260    .DEFINE "_create_name"
                           A  7261    
                           A  7262    .VALUE _create_name
                           A  7263    
                           A  7264    .CLASS 3
                           A  7265    
                           A  7266    .TYPE 68
                           A  7267    
                           A  7268    .ENDEF
                           A  7269    
                           A  7270    .BEGFUNC "create_name",2805,"_create_name"
                           A  7271    
                           A  7272    .LINE 2805
                           A  7273    
                           A  7274    .DEFINE "dp"
                           A  7275    
                           A  7276    .CLASS 65
                           A  7277    
                           A  7278    .VALUE 6
                           A  7279    
                           A  7280    .TAG "NONAME3"
                           A  7281    
                           A  7282    .TYPE 40
                           A  7283    
                           A  7284    .ENDEF
                           A  7285    
                           A  7286    .DEFINE "path"
                           A  7287    
                           A  7288    .CLASS 65
                           A  7289    
                           A  7290    .VALUE 9
                           A  7291    
                           A  7292    .TYPE 1570
                           A  7293    
                           A  7294    .ENDEF
                           A  7295    
                           A  7296    .DEFINE "di"
                           A  7297    
                           A  7298    .CLASS 65
                           A  7299    
                           A  7300    .VALUE -3
                           A  7301    
                           A  7302    .TYPE 14
                           A  7303    
                           A  7304    .ENDEF
                           A  7305    
                           A  7306    .DEFINE "cf"
                           A  7307    
                           A  7308    .CLASS 65
                           A  7309    
                           A  7310    .VALUE -4
                           A  7311    
                           A  7312    .TYPE 12
                           A  7313    
                           A  7314    .ENDEF
                           A  7315    
                           A  7316    .DEFINE "wc"
                           A  7317    
                           A  7318    .CLASS 65
                           A  7319    
                           A  7320    .VALUE -6
                           A  7321    
                           A  7322    .TYPE 13
                           A  7323    
                           A  7324    .ENDEF
                           A  7325    
                           A  7326    .DEFINE "i"
                           A  7327    
                           A  7328    .CLASS 65
                           A  7329    
                           A  7330    .VALUE -9
                           A  7331    
                           A  7332    .TYPE 14
                           A  7333    
                           A  7334    .ENDEF
                           A  7335    
                           A  7336    .DEFINE "b"
                           A  7337    
                           A  7338    .CLASS 65
                           A  7339    
                           A  7340    .VALUE -10
                           A  7341    
                           A  7342    .TYPE 12
                           A  7343    
                           A  7344    .ENDEF
                           A  7345    
                           A  7346    .DEFINE "si"
                           A  7347    
                           A  7348    .CLASS 65
                           A  7349    
                           A  7350    .VALUE -13
                           A  7351    
                           A  7352    .TYPE 14
                           A  7353    
                           A  7354    .ENDEF
                           A  7355    
                           A  7356    .DEFINE "lfn"
                           A  7357    
                           A  7358    .CLASS 65
                           A  7359    
                           A  7360    .VALUE -16
                           A  7361    
                           A  7362    .TYPE 45
                           A  7363    
                           A  7364    .ENDEF
                           A  7365    
                           A  7366    .DEFINE "uc"
                           A  7367    
                           A  7368    .CLASS 65
                           A  7369    
                           A  7370    .VALUE -20
                           A  7371    
                           A  7372    .TYPE 15
                           A  7373    
                           A  7374    .ENDEF
                           A  7375    
                           A  7376    .DEFINE "p"
                           A  7377    
                           A  7378    .CLASS 65
                           A  7379    
                           A  7380    .VALUE -23
                           A  7381    
                           A  7382    .TYPE 194
                           A  7383    
                           A  7384    .ENDEF
                           A  7385    
                           A  7386    .DEFINE "ni"
                           A  7387    
                           A  7388    .CLASS 65
                           A  7389    
                           A  7390    .VALUE -26
                           A  7391    
                           A  7392    .TYPE 14
                           A  7393    
                           A  7394    .ENDEF
                           A  7395    
042278 DDE5                A  7396    	PUSH	IX
04227A DD210000 00         A  7397    	LD	IX,0
04227F DD39                A  7398    	ADD	IX,SP
042281 ED22D4              A  7399    	LEA	HL,IX+%FFFFFFD4
042284 F9                  A  7400    	LD	SP,HL
                           A  7401    ; 2806	#if FF_USE_LFN		/* LFN configuratio
                           A  7402    ; 2807		BYTE b, cf;
                           A  7403    ; 2808		WCHAR wc, *lfn;
                           A  7404    ; 2809		DWORD uc;
                           A  7405    ; 2810		UINT i, ni, si, di;
                           A  7406    ; 2811		const TCHAR *p;
                           A  7407    ; 2812	
                           A  7408    ; 2813	
                           A  7409    ; 2814		/* Create LFN into LFN working buff
                           A  7410    ; 2815		p = *path; lfn = dp->obj.fs->lfnbuf
                           A  7411    .LINE 2815
                           A  7412    
042285 DD2709              A  7413    	LD	HL,(IX+%9)
042288 ED07                A  7414    	LD	BC,(HL)
04228A DD0FE9              A  7415    	LD	(IX+%FFFFFFE9),BC
04228D DD3106              A  7416    	LD	IY,(IX+%6)
042290 FD3700              A  7417    	LD	IY,(IY+%0)
042293 FD070B              A  7418    	LD	BC,(IY+%B)
042296 DD0FF0              A  7419    	LD	(IX+%FFFFFFF0),BC
042299 01000000            A  7420    	LD	BC,0
04229D DD0FFD              A  7421    	LD	(IX+%FFFFFFFD),BC
                           A  7422    ; 2816		for (;;) {
0422A0                     A  7423    L_273:
                           A  7424    .LINE 2816
                           A  7425    
                           A  7426    ; 2817			uc = tchar2uni(&p);			/* 
                           A  7427    .LINE 2817
                           A  7428    
0422A0 ED65E9              A  7429    	PEA	IX+%FFFFFFE9
0422A3 CD 29 10 04         A  7430    	CALL	_tchar2uni
0422A7 C1                  A  7431    	POP	BC
0422A8 DD2FEC              A  7432    	LD	(IX+%FFFFFFEC),HL
0422AB DD73EF              A  7433    	LD	(IX+%FFFFFFEF),E
                           A  7434    ; 2818			if (uc == 0xFFFFFFFF) return FR
                           A  7435    .LINE 2818
                           A  7436    
0422AE DD27EC              A  7437    	LD	HL,(IX+%FFFFFFEC)
0422B1 DD5EEF              A  7438    	LD	E,(IX+%FFFFFFEF)
0422B4 01FFFFFF            A  7439    	LD	BC,16777215
0422B8 3EFF                A  7440    	LD	A,%FF
0422BA CD 88 47 04         A  7441    	CALL	__lcmpu
0422BE 20 08               A  7442    	JR	NZ,L_261
0422C0 21060000            A  7443    	LD	HL,6
0422C4 C3 50 28 04         A  7444    	JR	L_371
0422C8                     A  7445    L_261:
                           A  7446    ; 2819			if (uc >= 0x10000) lfn[di++] = 
                           A  7447    .LINE 2819
                           A  7448    
0422C8 DD27EC              A  7449    	LD	HL,(IX+%FFFFFFEC)
0422CB DD5EEF              A  7450    	LD	E,(IX+%FFFFFFEF)
0422CE 01000001            A  7451    	LD	BC,65536
0422D2 AF                  A  7452    	XOR	A,A
0422D3 CD 88 47 04         A  7453    	CALL	__lcmpu
0422D7 38 1E               A  7454    	JR	C,L_262
0422D9 DD07EC              A  7455    	LD	BC,(IX+%FFFFFFEC)
0422DC DD7EEF              A  7456    	LD	A,(IX+%FFFFFFEF)
0422DF 2E10                A  7457    	LD	L,%10
0422E1 CD 87 46 04         A  7458    	CALL	__lshru
0422E5 DD27FD              A  7459    	LD	HL,(IX+%FFFFFFFD)
0422E8 29                  A  7460    	ADD	HL,HL
0422E9 DD17F0              A  7461    	LD	DE,(IX+%FFFFFFF0)
0422EC 19                  A  7462    	ADD	HL,DE
0422ED 71                  A  7463    	LD	(HL),C
0422EE 23                  A  7464    	INC	HL
0422EF 70                  A  7465    	LD	(HL),B
0422F0 DD07FD              A  7466    	LD	BC,(IX+%FFFFFFFD)
0422F3 03                  A  7467    	INC	BC
0422F4 DD0FFD              A  7468    	LD	(IX+%FFFFFFFD),BC
0422F7                     A  7469    L_262:
                           A  7470    ; 2820			wc = (WCHAR)uc;
                           A  7471    ; 2821			if (wc < ' ' || IsSeparator(wc)
                           A  7472    .LINE 2821
                           A  7473    
0422F7 49012000            A  7474    	LD.LIS	BC,32
0422FB DD27EC              A  7475    	LD	HL,(IX+%FFFFFFEC)
0422FE B7                  A  7476    	OR	A,A
0422FF 40ED42              A  7477    	SBC.SIS	HL,BC
042302 38 75               A  7478    	JR	C,L_283
042304 49012F00            A  7479    	LD.LIS	BC,47
042308 DD27EC              A  7480    	LD	HL,(IX+%FFFFFFEC)
04230B B7                  A  7481    	OR	A,A
04230C 40ED42              A  7482    	SBC.SIS	HL,BC
04230F 28 68               A  7483    	JR	Z,L_283
042311 49015C00            A  7484    	LD.LIS	BC,92
042315 DD27EC              A  7485    	LD	HL,(IX+%FFFFFFEC)
042318 B7                  A  7486    	OR	A,A
042319 40ED42              A  7487    	SBC.SIS	HL,BC
04231C 28 5B               A  7488    	JR	Z,L_283
                           A  7489    ; 2822			if (wc < 0x80 && strchr("*:<>|\
                           A  7490    .LINE 2822
                           A  7491    
04231E 49018000            A  7492    	LD.LIS	BC,128
042322 DD27EC              A  7493    	LD	HL,(IX+%FFFFFFEC)
042325 B7                  A  7494    	OR	A,A
042326 40ED42              A  7495    	SBC.SIS	HL,BC
042329 30 21               A  7496    	JR	NC,L_270
04232B DD07EC              A  7497    	LD	BC,(IX+%FFFFFFEC)
04232E CD 73 45 04         A  7498    	CALL	__stoiu
042332 E5                  A  7499    	PUSH	HL
042333 01 7F 4D 04         A  7500    	LD	BC,L__141
042337 C5                  A  7501    	PUSH	BC
042338 CD F1 46 04         A  7502    	CALL	_strchr
04233C C1                  A  7503    	POP	BC
04233D C1                  A  7504    	POP	BC
04233E CD E5 46 04         A  7505    	CALL	__icmpzero
042342 28 08               A  7506    	JR	Z,L_270
042344 21060000            A  7507    	LD	HL,6
042348 C3 50 28 04         A  7508    	JR	L_371
04234C                     A  7509    L_270:
                           A  7510    ; 2823			if (di >= FF_MAX_LFN) return FR
                           A  7511    .LINE 2823
                           A  7512    
04234C 01FF0000            A  7513    	LD	BC,255
042350 DD27FD              A  7514    	LD	HL,(IX+%FFFFFFFD)
042353 B7                  A  7515    	OR	A,A
042354 ED42                A  7516    	SBC	HL,BC
042356 38 08               A  7517    	JR	C,L_272
042358 21060000            A  7518    	LD	HL,6
04235C C3 50 28 04         A  7519    	JR	L_371
042360                     A  7520    L_272:
                           A  7521    ; 2824			lfn[di++] = wc;				/* 
                           A  7522    .LINE 2824
                           A  7523    
042360 DD27FD              A  7524    	LD	HL,(IX+%FFFFFFFD)
042363 29                  A  7525    	ADD	HL,HL
042364 DD07F0              A  7526    	LD	BC,(IX+%FFFFFFF0)
042367 09                  A  7527    	ADD	HL,BC
042368 DD07EC              A  7528    	LD	BC,(IX+%FFFFFFEC)
04236B 71                  A  7529    	LD	(HL),C
04236C 23                  A  7530    	INC	HL
04236D 70                  A  7531    	LD	(HL),B
04236E DD07FD              A  7532    	LD	BC,(IX+%FFFFFFFD)
042371 03                  A  7533    	INC	BC
042372 DD0FFD              A  7534    	LD	(IX+%FFFFFFFD),BC
                           A  7535    ; 2825		}
                           A  7536    .LINE 2825
                           A  7537    
042375 C3 A0 22 04         A  7538    	JR	L_273
042379                     A  7539    L_283:
                           A  7540    ; 2826		if (wc < ' ') {				/* Stop
                           A  7541    .LINE 2826
                           A  7542    
042379 49012000            A  7543    	LD.LIS	BC,32
04237D DD27EC              A  7544    	LD	HL,(IX+%FFFFFFEC)
042380 B7                  A  7545    	OR	A,A
042381 40ED42              A  7546    	SBC.SIS	HL,BC
042384 30 13               A  7547    	JR	NC,L_277
                           A  7548    ; 2827			cf = NS_LAST;			/* Last
                           A  7549    .LINE 2827
                           A  7550    
042386 DD36FC04            A  7551    	LD	(IX+%FFFFFFFC),%4
                           A  7552    ; 2828		} else {					/* Stop
                           A  7553    .LINE 2828
                           A  7554    
04238A 18 4B               A  7555    	JR	L_284
                           A  7556    ; 2829			while (IsSeparator(*p)) p++;	
                           A  7557    .LINE 2829
                           A  7558    
04238C                     A  7559    L_278:
04238C DD07E9              A  7560    	LD	BC,(IX+%FFFFFFE9)
04238F DD0FD4              A  7561    	LD	(IX+%FFFFFFD4),BC
042392 DD07E9              A  7562    	LD	BC,(IX+%FFFFFFE9)
042395 03                  A  7563    	INC	BC
042396 DD0FE9              A  7564    	LD	(IX+%FFFFFFE9),BC
042399                     A  7565    L_277:
042399 DD27E9              A  7566    	LD	HL,(IX+%FFFFFFE9)
04239C 7E                  A  7567    	LD	A,(HL)
04239D 47                  A  7568    	LD	B,A
04239E 17ED62              A  7569    	SEXT	HL
0423A1 68                  A  7570    	LD	L,B
0423A2 012F0000            A  7571    	LD	BC,47
0423A6 B7                  A  7572    	OR	A,A
0423A7 ED42                A  7573    	SBC	HL,BC
0423A9 28 E1               A  7574    	JR	Z,L_278
0423AB DD27E9              A  7575    	LD	HL,(IX+%FFFFFFE9)
0423AE 7E                  A  7576    	LD	A,(HL)
0423AF 47                  A  7577    	LD	B,A
0423B0 17ED62              A  7578    	SEXT	HL
0423B3 68                  A  7579    	LD	L,B
0423B4 015C0000            A  7580    	LD	BC,92
0423B8 B7                  A  7581    	OR	A,A
0423B9 ED42                A  7582    	SBC	HL,BC
0423BB 28 CF               A  7583    	JR	Z,L_278
                           A  7584    ; 2830			cf = 0;					/* Next
                           A  7585    .LINE 2830
                           A  7586    
0423BD DD36FC00            A  7587    	LD	(IX+%FFFFFFFC),%0
                           A  7588    ; 2831			if (IsTerminator(*p)) cf = NS_L
                           A  7589    .LINE 2831
                           A  7590    
0423C1 DD27E9              A  7591    	LD	HL,(IX+%FFFFFFE9)
0423C4 7E                  A  7592    	LD	A,(HL)
0423C5 47                  A  7593    	LD	B,A
0423C6 17ED62              A  7594    	SEXT	HL
0423C9 68                  A  7595    	LD	L,B
0423CA 01200000            A  7596    	LD	BC,32
0423CE B7                  A  7597    	OR	A,A
0423CF ED42                A  7598    	SBC	HL,BC
0423D1 30 04               A  7599    	JR	NC,L_284
0423D3 DD36FC04            A  7600    	LD	(IX+%FFFFFFFC),%4
                           A  7601    ; 2832		}
0423D7                     A  7602    L_284:
                           A  7603    .LINE 2832
                           A  7604    
                           A  7605    ; 2833		*path = p;					/* Retu
                           A  7606    .LINE 2833
                           A  7607    
0423D7 DD2709              A  7608    	LD	HL,(IX+%9)
0423DA DD07E9              A  7609    	LD	BC,(IX+%FFFFFFE9)
0423DD ED0F                A  7610    	LD	(HL),BC
                           A  7611    ; 2834	
                           A  7612    ; 2835	#if FF_FS_RPATH != 0
                           A  7613    ; 2836		if ((di == 1 && lfn[di - 1] == '.')
                           A  7614    .LINE 2836
                           A  7615    
0423DF 01010000            A  7616    	LD	BC,1
0423E3 DD27FD              A  7617    	LD	HL,(IX+%FFFFFFFD)
0423E6 B7                  A  7618    	OR	A,A
0423E7 ED42                A  7619    	SBC	HL,BC
0423E9 20 1A               A  7620    	JR	NZ,L_288
0423EB DD31FD              A  7621    	LD	IY,(IX+%FFFFFFFD)
0423EE ED23FF              A  7622    	LEA	HL,IY+%FFFFFFFF
0423F1 29                  A  7623    	ADD	HL,HL
0423F2 DD07F0              A  7624    	LD	BC,(IX+%FFFFFFF0)
0423F5 09                  A  7625    	ADD	HL,BC
0423F6 ED07                A  7626    	LD	BC,(HL)
0423F8 CD 73 45 04         A  7627    	CALL	__stoiu
0423FC 012E0000            A  7628    	LD	BC,46
042400 B7                  A  7629    	OR	A,A
042401 ED42                A  7630    	SBC	HL,BC
042403 28 46               A  7631    	JR	Z,L_298
042405                     A  7632    L_288:
                           A  7633    ; 2837			(di == 2 && lfn[di - 1] == '.' 
                           A  7634    .LINE 2837
                           A  7635    
042405 01020000            A  7636    	LD	BC,2
042409 DD27FD              A  7637    	LD	HL,(IX+%FFFFFFFD)
04240C B7                  A  7638    	OR	A,A
04240D ED42                A  7639    	SBC	HL,BC
04240F C2 ED 24 04         A  7640    	JR	NZ,L_303
042413 DD31FD              A  7641    	LD	IY,(IX+%FFFFFFFD)
042416 ED23FF              A  7642    	LEA	HL,IY+%FFFFFFFF
042419 29                  A  7643    	ADD	HL,HL
04241A DD07F0              A  7644    	LD	BC,(IX+%FFFFFFF0)
04241D 09                  A  7645    	ADD	HL,BC
04241E ED07                A  7646    	LD	BC,(HL)
042420 CD 73 45 04         A  7647    	CALL	__stoiu
042424 012E0000            A  7648    	LD	BC,46
042428 B7                  A  7649    	OR	A,A
042429 ED42                A  7650    	SBC	HL,BC
04242B C2 ED 24 04         A  7651    	JR	NZ,L_303
04242F DD31FD              A  7652    	LD	IY,(IX+%FFFFFFFD)
042432 ED23FE              A  7653    	LEA	HL,IY+%FFFFFFFE
042435 29                  A  7654    	ADD	HL,HL
042436 DD07F0              A  7655    	LD	BC,(IX+%FFFFFFF0)
042439 09                  A  7656    	ADD	HL,BC
04243A ED07                A  7657    	LD	BC,(HL)
04243C CD 73 45 04         A  7658    	CALL	__stoiu
042440 012E0000            A  7659    	LD	BC,46
042444 B7                  A  7660    	OR	A,A
042445 ED42                A  7661    	SBC	HL,BC
042447 C2 ED 24 04         A  7662    	JR	NZ,L_303
04244B                     A  7663    L_298:
                           A  7664    ; 2838			lfn[di] = 0;
                           A  7665    .LINE 2838
                           A  7666    
04244B DD27FD              A  7667    	LD	HL,(IX+%FFFFFFFD)
04244E 29                  A  7668    	ADD	HL,HL
04244F DD07F0              A  7669    	LD	BC,(IX+%FFFFFFF0)
042452 09                  A  7670    	ADD	HL,BC
042453 3600                A  7671    	LD	(HL),%0
042455 23                  A  7672    	INC	HL
042456 3600                A  7673    	LD	(HL),%0
                           A  7674    ; 2839			for (i = 0; i < 11; i++) {	/* 
                           A  7675    .LINE 2839
                           A  7676    
042458 01000000            A  7677    	LD	BC,0
04245C DD0FF7              A  7678    	LD	(IX+%FFFFFFF7),BC
04245F 18 30               A  7679    	JR	L_296
042461                     A  7680    L_294:
                           A  7681    ; 2840				dp->fn[i] = (i < di) ? '.' 
                           A  7682    .LINE 2840
                           A  7683    
042461 DD07FD              A  7684    	LD	BC,(IX+%FFFFFFFD)
042464 DD27F7              A  7685    	LD	HL,(IX+%FFFFFFF7)
042467 B7                  A  7686    	OR	A,A
042468 ED42                A  7687    	SBC	HL,BC
04246A 30 09               A  7688    	JR	NC,L_292
04246C 012E0000            A  7689    	LD	BC,46
042470 DD0FE3              A  7690    	LD	(IX+%FFFFFFE3),BC
042473 18 07               A  7691    	JR	L_293
042475                     A  7692    L_292:
042475 01200000            A  7693    	LD	BC,32
042479 DD0FE3              A  7694    	LD	(IX+%FFFFFFE3),BC
04247C                     A  7695    L_293:
04247C DD7EE3              A  7696    	LD	A,(IX+%FFFFFFE3)
04247F DD07F7              A  7697    	LD	BC,(IX+%FFFFFFF7)
042482 DD3106              A  7698    	LD	IY,(IX+%6)
042485 ED231E              A  7699    	LEA	HL,IY+%1E
042488 09                  A  7700    	ADD	HL,BC
042489 77                  A  7701    	LD	(HL),A
04248A DD07F7              A  7702    	LD	BC,(IX+%FFFFFFF7)
04248D 03                  A  7703    	INC	BC
04248E DD0FF7              A  7704    	LD	(IX+%FFFFFFF7),BC
                           A  7705    ; 2841			}
042491                     A  7706    L_296:
                           A  7707    .LINE 2841
                           A  7708    
042491 010B0000            A  7709    	LD	BC,11
042495 DD27F7              A  7710    	LD	HL,(IX+%FFFFFFF7)
042498 B7                  A  7711    	OR	A,A
042499 ED42                A  7712    	SBC	HL,BC
04249B 38 C4               A  7713    	JR	C,L_294
                           A  7714    ; 2842			dp->fn[i] = cf | NS_DOT;	/* 
                           A  7715    .LINE 2842
                           A  7716    
04249D DD7EFC              A  7717    	LD	A,(IX+%FFFFFFFC)
0424A0 CBEF                A  7718    	SET	%5,A
0424A2 DD07F7              A  7719    	LD	BC,(IX+%FFFFFFF7)
0424A5 DD3106              A  7720    	LD	IY,(IX+%6)
0424A8 ED231E              A  7721    	LEA	HL,IY+%1E
0424AB 09                  A  7722    	ADD	HL,BC
0424AC 77                  A  7723    	LD	(HL),A
                           A  7724    ; 2843			return FR_OK;
                           A  7725    .LINE 2843
                           A  7726    
0424AD B7                  A  7727    	OR	A,A
0424AE ED62                A  7728    	SBC	HL,HL
0424B0 C3 50 28 04         A  7729    	JR	L_371
                           A  7730    ; 2844		}
                           A  7731    .LINE 2844
                           A  7732    
                           A  7733    ; 2845	#endif
                           A  7734    ; 2846		while (di) {					/* 
                           A  7735    .LINE 2846
                           A  7736    
0424B4                     A  7737    L_304:
                           A  7738    ; 2847			wc = lfn[di - 1];
                           A  7739    .LINE 2847
                           A  7740    
0424B4 DD31FD              A  7741    	LD	IY,(IX+%FFFFFFFD)
0424B7 ED33FF              A  7742    	LEA	IY,IY+%FFFFFFFF
0424BA DD3EE0              A  7743    	LD	(IX+%FFFFFFE0),IY
0424BD DD27E0              A  7744    	LD	HL,(IX+%FFFFFFE0)
0424C0 29                  A  7745    	ADD	HL,HL
0424C1 DD07F0              A  7746    	LD	BC,(IX+%FFFFFFF0)
0424C4 09                  A  7747    	ADD	HL,BC
0424C5 ED07                A  7748    	LD	BC,(HL)
0424C7 DD71FA              A  7749    	LD	(IX+%FFFFFFFA),C
0424CA DD70FB              A  7750    	LD	(IX+%FFFFFFFB),B
                           A  7751    ; 2848			if (wc != ' ' && wc != '.') bre
                           A  7752    .LINE 2848
                           A  7753    
0424CD 49012000            A  7754    	LD.LIS	BC,32
0424D1 DD27FA              A  7755    	LD	HL,(IX+%FFFFFFFA)
0424D4 B7                  A  7756    	OR	A,A
0424D5 40ED42              A  7757    	SBC.SIS	HL,BC
0424D8 28 0D               A  7758    	JR	Z,L_302
0424DA 49012E00            A  7759    	LD.LIS	BC,46
0424DE DD27FA              A  7760    	LD	HL,(IX+%FFFFFFFA)
0424E1 B7                  A  7761    	OR	A,A
0424E2 40ED42              A  7762    	SBC.SIS	HL,BC
0424E5 20 0F               A  7763    	JR	NZ,L_306
0424E7                     A  7764    L_302:
                           A  7765    ; 2849			di--;
                           A  7766    .LINE 2849
                           A  7767    
0424E7 DD07E0              A  7768    	LD	BC,(IX+%FFFFFFE0)
0424EA DD0FFD              A  7769    	LD	(IX+%FFFFFFFD),BC
                           A  7770    ; 2850		}
0424ED                     A  7771    L_303:
                           A  7772    .LINE 2850
                           A  7773    
0424ED DD27FD              A  7774    	LD	HL,(IX+%FFFFFFFD)
0424F0 CD E5 46 04         A  7775    	CALL	__icmpzero
0424F4 20 BE               A  7776    	JR	NZ,L_304
0424F6                     A  7777    L_306:
                           A  7778    ; 2851		lfn[di] = 0;						
                           A  7779    .LINE 2851
                           A  7780    
0424F6 DD27FD              A  7781    	LD	HL,(IX+%FFFFFFFD)
0424F9 29                  A  7782    	ADD	HL,HL
0424FA DD07F0              A  7783    	LD	BC,(IX+%FFFFFFF0)
0424FD 09                  A  7784    	ADD	HL,BC
0424FE 3600                A  7785    	LD	(HL),%0
042500 23                  A  7786    	INC	HL
042501 3600                A  7787    	LD	(HL),%0
                           A  7788    ; 2852		if (di == 0) return FR_INVALID_NAME
                           A  7789    .LINE 2852
                           A  7790    
042503 DD27FD              A  7791    	LD	HL,(IX+%FFFFFFFD)
042506 CD E5 46 04         A  7792    	CALL	__icmpzero
04250A 20 08               A  7793    	JR	NZ,L_312
04250C 21060000            A  7794    	LD	HL,6
042510 C3 50 28 04         A  7795    	JR	L_371
042514                     A  7796    L_312:
                           A  7797    ; 2853	
                           A  7798    ; 2854		/* Create SFN in directory form */
                           A  7799    ; 2855		for (si = 0; lfn[si] == ' '; si++) 
                           A  7800    .LINE 2855
                           A  7801    
042514 01000000            A  7802    	LD	BC,0
042518 DD0FF3              A  7803    	LD	(IX+%FFFFFFF3),BC
04251B 18 07               A  7804    	JR	L_311
04251D                     A  7805    L_309:
04251D DD07F3              A  7806    	LD	BC,(IX+%FFFFFFF3)
042520 03                  A  7807    	INC	BC
042521 DD0FF3              A  7808    	LD	(IX+%FFFFFFF3),BC
042524                     A  7809    L_311:
042524 DD27F3              A  7810    	LD	HL,(IX+%FFFFFFF3)
042527 29                  A  7811    	ADD	HL,HL
042528 DD07F0              A  7812    	LD	BC,(IX+%FFFFFFF0)
04252B 09                  A  7813    	ADD	HL,BC
04252C DD2FDD              A  7814    	LD	(IX+%FFFFFFDD),HL
04252F ED07                A  7815    	LD	BC,(HL)
042531 CD 73 45 04         A  7816    	CALL	__stoiu
042535 01200000            A  7817    	LD	BC,32
042539 B7                  A  7818    	OR	A,A
04253A ED42                A  7819    	SBC	HL,BC
04253C 28 DF               A  7820    	JR	Z,L_309
                           A  7821    ; 2856		if (si > 0 || lfn[si] == '.') cf |=
                           A  7822    .LINE 2856
                           A  7823    
04253E DD07F3              A  7824    	LD	BC,(IX+%FFFFFFF3)
042541 B7                  A  7825    	OR	A,A
042542 ED62                A  7826    	SBC	HL,HL
042544 B7                  A  7827    	OR	A,A
042545 ED42                A  7828    	SBC	HL,BC
042547 38 12               A  7829    	JR	C,L_314
042549 DD27DD              A  7830    	LD	HL,(IX+%FFFFFFDD)
04254C ED07                A  7831    	LD	BC,(HL)
04254E CD 73 45 04         A  7832    	CALL	__stoiu
042552 012E0000            A  7833    	LD	BC,46
042556 B7                  A  7834    	OR	A,A
042557 ED42                A  7835    	SBC	HL,BC
042559 20 10               A  7836    	JR	NZ,L_318
04255B                     A  7837    L_314:
04255B DD7EFC              A  7838    	LD	A,(IX+%FFFFFFFC)
04255E F603                A  7839    	OR	A,%3
042560 DD77FC              A  7840    	LD	(IX+%FFFFFFFC),A
                           A  7841    ; 2857		while (di > 0 && lfn[di - 1] != '.'
                           A  7842    .LINE 2857
                           A  7843    
042563 18 06               A  7844    	JR	L_318
042565                     A  7845    L_319:
042565 DD07DA              A  7846    	LD	BC,(IX+%FFFFFFDA)
042568 DD0FFD              A  7847    	LD	(IX+%FFFFFFFD),BC
04256B                     A  7848    L_318:
04256B DD07FD              A  7849    	LD	BC,(IX+%FFFFFFFD)
04256E B7                  A  7850    	OR	A,A
04256F ED62                A  7851    	SBC	HL,HL
042571 B7                  A  7852    	OR	A,A
042572 ED42                A  7853    	SBC	HL,BC
042574 30 20               A  7854    	JR	NC,L_321
042576 DD31FD              A  7855    	LD	IY,(IX+%FFFFFFFD)
042579 ED33FF              A  7856    	LEA	IY,IY+%FFFFFFFF
04257C DD3EDA              A  7857    	LD	(IX+%FFFFFFDA),IY
04257F DD27DA              A  7858    	LD	HL,(IX+%FFFFFFDA)
042582 29                  A  7859    	ADD	HL,HL
042583 DD07F0              A  7860    	LD	BC,(IX+%FFFFFFF0)
042586 09                  A  7861    	ADD	HL,BC
042587 ED07                A  7862    	LD	BC,(HL)
042589 CD 73 45 04         A  7863    	CALL	__stoiu
04258D 012E0000            A  7864    	LD	BC,46
042591 B7                  A  7865    	OR	A,A
042592 ED42                A  7866    	SBC	HL,BC
042594 20 CF               A  7867    	JR	NZ,L_319
042596                     A  7868    L_321:
                           A  7869    ; 2858	
                           A  7870    ; 2859		memset(dp->fn, ' ', 11);
                           A  7871    .LINE 2859
                           A  7872    
042596 010B0000            A  7873    	LD	BC,11
04259A C5                  A  7874    	PUSH	BC
04259B 01200000            A  7875    	LD	BC,32
04259F C5                  A  7876    	PUSH	BC
0425A0 DD3106              A  7877    	LD	IY,(IX+%6)
0425A3 ED661E              A  7878    	PEA	IY+%1E
0425A6 CD 0F 48 04         A  7879    	CALL	_memset
0425AA C1                  A  7880    	POP	BC
0425AB C1                  A  7881    	POP	BC
0425AC C1                  A  7882    	POP	BC
                           A  7883    ; 2860		i = b = 0; ni = 8;
                           A  7884    .LINE 2860
                           A  7885    
0425AD DD36F600            A  7886    	LD	(IX+%FFFFFFF6),%0
0425B1 01000000            A  7887    	LD	BC,0
0425B5 DD0FF7              A  7888    	LD	(IX+%FFFFFFF7),BC
0425B8 01080000            A  7889    	LD	BC,8
0425BC DD0FE6              A  7890    	LD	(IX+%FFFFFFE6),BC
                           A  7891    ; 2861		for (;;) {
0425BF                     A  7892    L_356:
                           A  7893    .LINE 2861
                           A  7894    
                           A  7895    ; 2862			wc = lfn[si++];					
                           A  7896    .LINE 2862
                           A  7897    
0425BF DD27F3              A  7898    	LD	HL,(IX+%FFFFFFF3)
0425C2 29                  A  7899    	ADD	HL,HL
0425C3 DD07F0              A  7900    	LD	BC,(IX+%FFFFFFF0)
0425C6 09                  A  7901    	ADD	HL,BC
0425C7 ED07                A  7902    	LD	BC,(HL)
0425C9 DD71FA              A  7903    	LD	(IX+%FFFFFFFA),C
0425CC DD70FB              A  7904    	LD	(IX+%FFFFFFFB),B
0425CF DD07F3              A  7905    	LD	BC,(IX+%FFFFFFF3)
0425D2 03                  A  7906    	INC	BC
0425D3 DD0FF3              A  7907    	LD	(IX+%FFFFFFF3),BC
                           A  7908    ; 2863			if (wc == 0) break;				
                           A  7909    .LINE 2863
                           A  7910    
0425D6 DD27FA              A  7911    	LD	HL,(IX+%FFFFFFFA)
0425D9 CD D8 47 04         A  7912    	CALL	__scmpzero
0425DD CA CA 27 04         A  7913    	JR	Z,L_359
                           A  7914    ; 2864			if (wc == ' ' || (wc == '.' && 
                           A  7915    .LINE 2864
                           A  7916    
0425E1 49012000            A  7917    	LD.LIS	BC,32
0425E5 DD27FA              A  7918    	LD	HL,(IX+%FFFFFFFA)
0425E8 B7                  A  7919    	OR	A,A
0425E9 40ED42              A  7920    	SBC.SIS	HL,BC
0425EC 28 18               A  7921    	JR	Z,L_326
0425EE 49012E00            A  7922    	LD.LIS	BC,46
0425F2 DD27FA              A  7923    	LD	HL,(IX+%FFFFFFFA)
0425F5 B7                  A  7924    	OR	A,A
0425F6 40ED42              A  7925    	SBC.SIS	HL,BC
0425F9 20 15               A  7926    	JR	NZ,L_336
0425FB DD07FD              A  7927    	LD	BC,(IX+%FFFFFFFD)
0425FE DD27F3              A  7928    	LD	HL,(IX+%FFFFFFF3)
042601 B7                  A  7929    	OR	A,A
042602 ED42                A  7930    	SBC	HL,BC
042604 28 0A               A  7931    	JR	Z,L_336
042606                     A  7932    L_326:
                           A  7933    ; 2865				cf |= NS_LOSS | NS_LFN;
                           A  7934    .LINE 2865
                           A  7935    
042606 DD7EFC              A  7936    	LD	A,(IX+%FFFFFFFC)
042609 F603                A  7937    	OR	A,%3
04260B DD77FC              A  7938    	LD	(IX+%FFFFFFFC),A
                           A  7939    ; 2866				continue;
                           A  7940    .LINE 2866
                           A  7941    
04260E 18 AF               A  7942    	JR	L_356
                           A  7943    ; 2867			}
042610                     A  7944    L_336:
                           A  7945    .LINE 2867
                           A  7946    
                           A  7947    ; 2868	
                           A  7948    ; 2869			if (i >= ni || si == di) {		
                           A  7949    .LINE 2869
                           A  7950    
042610 DD07E6              A  7951    	LD	BC,(IX+%FFFFFFE6)
042613 DD27F7              A  7952    	LD	HL,(IX+%FFFFFFF7)
042616 B7                  A  7953    	OR	A,A
042617 ED42                A  7954    	SBC	HL,BC
042619 30 0B               A  7955    	JR	NC,L_335
04261B DD07FD              A  7956    	LD	BC,(IX+%FFFFFFFD)
04261E DD27F3              A  7957    	LD	HL,(IX+%FFFFFFF3)
042621 B7                  A  7958    	OR	A,A
042622 ED42                A  7959    	SBC	HL,BC
042624 20 58               A  7960    	JR	NZ,L_339
042626                     A  7961    L_335:
                           A  7962    ; 2870				if (ni == 11) {				
                           A  7963    .LINE 2870
                           A  7964    
042626 010B0000            A  7965    	LD	BC,11
04262A DD27E6              A  7966    	LD	HL,(IX+%FFFFFFE6)
04262D B7                  A  7967    	OR	A,A
04262E ED42                A  7968    	SBC	HL,BC
042630 20 0C               A  7969    	JR	NZ,L_331
                           A  7970    ; 2871					cf |= NS_LOSS | NS_LFN;
                           A  7971    .LINE 2871
                           A  7972    
042632 DD7EFC              A  7973    	LD	A,(IX+%FFFFFFFC)
042635 F603                A  7974    	OR	A,%3
042637 DD77FC              A  7975    	LD	(IX+%FFFFFFFC),A
                           A  7976    ; 2872					break;
                           A  7977    .LINE 2872
                           A  7978    
04263A C3 CA 27 04         A  7979    	JR	L_359
                           A  7980    ; 2873				}
04263E                     A  7981    L_331:
                           A  7982    .LINE 2873
                           A  7983    
                           A  7984    ; 2874				if (si != di) cf |= NS_LOSS
                           A  7985    .LINE 2874
                           A  7986    
04263E DD07FD              A  7987    	LD	BC,(IX+%FFFFFFFD)
042641 DD27F3              A  7988    	LD	HL,(IX+%FFFFFFF3)
042644 B7                  A  7989    	OR	A,A
042645 ED42                A  7990    	SBC	HL,BC
042647 28 08               A  7991    	JR	Z,L_333
042649 DD7EFC              A  7992    	LD	A,(IX+%FFFFFFFC)
04264C F603                A  7993    	OR	A,%3
04264E DD77FC              A  7994    	LD	(IX+%FFFFFFFC),A
042651                     A  7995    L_333:
                           A  7996    ; 2875				if (si > di) break;			
                           A  7997    .LINE 2875
                           A  7998    
042651 DD07F3              A  7999    	LD	BC,(IX+%FFFFFFF3)
042654 DD27FD              A  8000    	LD	HL,(IX+%FFFFFFFD)
042657 B7                  A  8001    	OR	A,A
042658 ED42                A  8002    	SBC	HL,BC
04265A DA CA 27 04         A  8003    	JR	C,L_359
                           A  8004    ; 2876				si = di; i = 8; ni = 11; b 
                           A  8005    .LINE 2876
                           A  8006    
04265E DD07FD              A  8007    	LD	BC,(IX+%FFFFFFFD)
042661 DD0FF3              A  8008    	LD	(IX+%FFFFFFF3),BC
042664 01080000            A  8009    	LD	BC,8
042668 DD0FF7              A  8010    	LD	(IX+%FFFFFFF7),BC
04266B 010B0000            A  8011    	LD	BC,11
04266F DD0FE6              A  8012    	LD	(IX+%FFFFFFE6),BC
042672 DD7EF6              A  8013    	LD	A,(IX+%FFFFFFF6)
042675 87                  A  8014    	ADD	A,A
042676 87                  A  8015    	ADD	A,A
042677 DD77F6              A  8016    	LD	(IX+%FFFFFFF6),A
                           A  8017    ; 2877				continue;
                           A  8018    .LINE 2877
                           A  8019    
04267A C3 BF 25 04         A  8020    	JR	L_356
                           A  8021    ; 2878			}
04267E                     A  8022    L_339:
                           A  8023    .LINE 2878
                           A  8024    
                           A  8025    ; 2879	
                           A  8026    ; 2880			if (wc >= 0x80) {	/* Is this 
                           A  8027    .LINE 2880
                           A  8028    
04267E 49018000            A  8029    	LD.LIS	BC,128
042682 DD27FA              A  8030    	LD	HL,(IX+%FFFFFFFA)
042685 B7                  A  8031    	OR	A,A
042686 40ED42              A  8032    	SBC.SIS	HL,BC
042689 38 51               A  8033    	JR	C,L_353
                           A  8034    ; 2881				cf |= NS_LFN;	/* LFN entr
                           A  8035    .LINE 2881
                           A  8036    
04268B DD7EFC              A  8037    	LD	A,(IX+%FFFFFFFC)
04268E CBCF                A  8038    	SET	%1,A
042690 DD77FC              A  8039    	LD	(IX+%FFFFFFFC),A
                           A  8040    ; 2882	#if FF_CODE_PAGE == 0
                           A  8041    ; 2883				if (ExCvt) {	/* In SBCS 
                           A  8042    ; 2884					wc = ff_uni2oem(wc, COD
                           A  8043    ; 2885					if (wc & 0x80) wc = ExC
                           A  8044    ; 2886				} else {		/* In DBCS 
                           A  8045    ; 2887					wc = ff_uni2oem(ff_wtou
                           A  8046    ; 2888				}
                           A  8047    ; 2889	#elif FF_CODE_PAGE < 900	/* In SBCS 
                           A  8048    ; 2890				wc = ff_uni2oem(wc, CODEPAG
                           A  8049    .LINE 2890
                           A  8050    
042693 01B50100            A  8051    	LD	BC,437
042697 C5                  A  8052    	PUSH	BC
042698 DD07FA              A  8053    	LD	BC,(IX+%FFFFFFFA)
04269B CD 73 45 04         A  8054    	CALL	__stoiu
04269F 0E00                A  8055    	LD	C,%0
0426A1 0600                A  8056    	LD	B,%0
0426A3 C5                  A  8057    	PUSH	BC
0426A4 E5                  A  8058    	PUSH	HL
0426A5 CD 25 0C 04         A  8059    	CALL	_ff_uni2oem
0426A9 C1                  A  8060    	POP	BC
0426AA C1                  A  8061    	POP	BC
0426AB C1                  A  8062    	POP	BC
0426AC DD75FA              A  8063    	LD	(IX+%FFFFFFFA),L
0426AF DD74FB              A  8064    	LD	(IX+%FFFFFFFB),H
                           A  8065    ; 2891				if (wc & 0x80) wc = ExCvt[w
                           A  8066    .LINE 2891
                           A  8067    
0426B2 DD7EFA              A  8068    	LD	A,(IX+%FFFFFFFA)
0426B5 E680                A  8069    	AND	A,%80
0426B7 4F                  A  8070    	LD	C,A
0426B8 0600                A  8071    	LD	B,%0
0426BA C5E1                A  8072    	LD	HL,BC
0426BC CD D8 47 04         A  8073    	CALL	__scmpzero
0426C0 28 1A               A  8074    	JR	Z,L_353
0426C2 DD7EFA              A  8075    	LD	A,(IX+%FFFFFFFA)
0426C5 CBBF                A  8076    	RES	%7,A
0426C7 4F                  A  8077    	LD	C,A
0426C8 CD 73 45 04         A  8078    	CALL	__stoiu
0426CC 01 EE 4C 04         A  8079    	LD	BC,_ExCvt
0426D0 09                  A  8080    	ADD	HL,BC
0426D1 4E                  A  8081    	LD	C,(HL)
0426D2 0600                A  8082    	LD	B,%0
0426D4 C5E1                A  8083    	LD	HL,BC
0426D6 DD75FA              A  8084    	LD	(IX+%FFFFFFFA),L
0426D9 DD74FB              A  8085    	LD	(IX+%FFFFFFFB),H
                           A  8086    ; 2892	#else						/* In DBCS 
                           A  8087    ; 2893				wc = ff_uni2oem(ff_wtoupper
                           A  8088    ; 2894	#endif
                           A  8089    ; 2895			}
0426DC                     A  8090    L_353:
                           A  8091    .LINE 2895
                           A  8092    
                           A  8093    ; 2896	
                           A  8094    ; 2897			if (wc >= 0x100) {				
                           A  8095    .LINE 2897
                           A  8096    
0426DC 49010001            A  8097    	LD.LIS	BC,256
0426E0 DD27FA              A  8098    	LD	HL,(IX+%FFFFFFFA)
0426E3 B7                  A  8099    	OR	A,A
0426E4 40ED42              A  8100    	SBC.SIS	HL,BC
0426E7 38 44               A  8101    	JR	C,L_352
                           A  8102    ; 2898				if (i >= ni - 1) {			
                           A  8103    .LINE 2898
                           A  8104    
0426E9 DD31E6              A  8105    	LD	IY,(IX+%FFFFFFE6)
0426EC ED03FF              A  8106    	LEA	BC,IY+%FFFFFFFF
0426EF DD27F7              A  8107    	LD	HL,(IX+%FFFFFFF7)
0426F2 B7                  A  8108    	OR	A,A
0426F3 ED42                A  8109    	SBC	HL,BC
0426F5 38 12               A  8110    	JR	C,L_342
                           A  8111    ; 2899					cf |= NS_LOSS | NS_LFN;
                           A  8112    .LINE 2899
                           A  8113    
0426F7 DD7EFC              A  8114    	LD	A,(IX+%FFFFFFFC)
0426FA F603                A  8115    	OR	A,%3
0426FC DD77FC              A  8116    	LD	(IX+%FFFFFFFC),A
                           A  8117    ; 2900					i = ni; continue;		
                           A  8118    .LINE 2900
                           A  8119    
0426FF DD07E6              A  8120    	LD	BC,(IX+%FFFFFFE6)
042702 DD0FF7              A  8121    	LD	(IX+%FFFFFFF7),BC
042705 C3 BF 25 04         A  8122    	JR	L_356
                           A  8123    ; 2901				}
042709                     A  8124    L_342:
                           A  8125    .LINE 2901
                           A  8126    
                           A  8127    ; 2902				dp->fn[i++] = (BYTE)(wc >> 
                           A  8128    .LINE 2902
                           A  8129    
042709 DD07FA              A  8130    	LD	BC,(IX+%FFFFFFFA)
04270C CD 73 45 04         A  8131    	CALL	__stoiu
042710 3E08                A  8132    	LD	A,%8
042712 CD E3 44 04         A  8133    	CALL	__ishrs_b
042716 7D                  A  8134    	LD	A,L
042717 DD07F7              A  8135    	LD	BC,(IX+%FFFFFFF7)
04271A DD3106              A  8136    	LD	IY,(IX+%6)
04271D ED231E              A  8137    	LEA	HL,IY+%1E
042720 09                  A  8138    	ADD	HL,BC
042721 77                  A  8139    	LD	(HL),A
042722 DD07F7              A  8140    	LD	BC,(IX+%FFFFFFF7)
042725 03                  A  8141    	INC	BC
042726 DD0FF7              A  8142    	LD	(IX+%FFFFFFF7),BC
                           A  8143    ; 2903			} else {						
                           A  8144    .LINE 2903
                           A  8145    
042729 C3 B1 27 04         A  8146    	JR	L_355
04272D                     A  8147    L_352:
                           A  8148    ; 2904				if (wc == 0 || strchr("+,;=
                           A  8149    .LINE 2904
                           A  8150    
04272D DD27FA              A  8151    	LD	HL,(IX+%FFFFFFFA)
042730 CD D8 47 04         A  8152    	CALL	__scmpzero
042734 28 19               A  8153    	JR	Z,L_349
042736 DD07FA              A  8154    	LD	BC,(IX+%FFFFFFFA)
042739 CD 73 45 04         A  8155    	CALL	__stoiu
04273D E5                  A  8156    	PUSH	HL
04273E 01 88 4D 04         A  8157    	LD	BC,L__178
042742 C5                  A  8158    	PUSH	BC
042743 CD F1 46 04         A  8159    	CALL	_strchr
042747 C1                  A  8160    	POP	BC
042748 C1                  A  8161    	POP	BC
042749 CD E5 46 04         A  8162    	CALL	__icmpzero
04274D 28 12               A  8163    	JR	Z,L_350
04274F                     A  8164    L_349:
                           A  8165    ; 2905					wc = '_'; cf |= NS_LOSS
                           A  8166    .LINE 2905
                           A  8167    
04274F DD36FA5F            A  8168    	LD	(IX+%FFFFFFFA),%5F
042753 DD36FB00            A  8169    	LD	(IX+%FFFFFFFB),%0
042757 DD7EFC              A  8170    	LD	A,(IX+%FFFFFFFC)
04275A F603                A  8171    	OR	A,%3
04275C DD77FC              A  8172    	LD	(IX+%FFFFFFFC),A
                           A  8173    ; 2906				} else {
                           A  8174    .LINE 2906
                           A  8175    
04275F 18 50               A  8176    	JR	L_355
042761                     A  8177    L_350:
                           A  8178    ; 2907					if (IsUpper(wc)) {		
                           A  8179    .LINE 2907
                           A  8180    
042761 49014100            A  8181    	LD.LIS	BC,65
042765 DD27FA              A  8182    	LD	HL,(IX+%FFFFFFFA)
042768 B7                  A  8183    	OR	A,A
042769 40ED42              A  8184    	SBC.SIS	HL,BC
04276C 38 15               A  8185    	JR	C,L_348
04276E DD07FA              A  8186    	LD	BC,(IX+%FFFFFFFA)
042771 49215A00            A  8187    	LD.LIS	HL,90
042775 B7                  A  8188    	OR	A,A
042776 40ED42              A  8189    	SBC.SIS	HL,BC
042779 38 08               A  8190    	JR	C,L_348
                           A  8191    ; 2908						b |= 2;
                           A  8192    .LINE 2908
                           A  8193    
04277B DD7EF6              A  8194    	LD	A,(IX+%FFFFFFF6)
04277E CBCF                A  8195    	SET	%1,A
042780 DD77F6              A  8196    	LD	(IX+%FFFFFFF6),A
                           A  8197    ; 2909					}
042783                     A  8198    L_348:
                           A  8199    .LINE 2909
                           A  8200    
                           A  8201    ; 2910					if (IsLower(wc)) {		
                           A  8202    .LINE 2910
                           A  8203    
042783 49016100            A  8204    	LD.LIS	BC,97
042787 DD27FA              A  8205    	LD	HL,(IX+%FFFFFFFA)
04278A B7                  A  8206    	OR	A,A
04278B 40ED42              A  8207    	SBC.SIS	HL,BC
04278E 38 21               A  8208    	JR	C,L_355
042790 DD07FA              A  8209    	LD	BC,(IX+%FFFFFFFA)
042793 49217A00            A  8210    	LD.LIS	HL,122
042797 B7                  A  8211    	OR	A,A
042798 40ED42              A  8212    	SBC.SIS	HL,BC
04279B 38 14               A  8213    	JR	C,L_355
                           A  8214    ; 2911						b |= 1; wc -= 0x20;
                           A  8215    .LINE 2911
                           A  8216    
04279D DD7EF6              A  8217    	LD	A,(IX+%FFFFFFF6)
0427A0 CBC7                A  8218    	SET	%0,A
0427A2 DD77F6              A  8219    	LD	(IX+%FFFFFFF6),A
0427A5 DD31FA              A  8220    	LD	IY,(IX+%FFFFFFFA)
0427A8 ED23E0              A  8221    	LEA	HL,IY+%FFFFFFE0
0427AB DD75FA              A  8222    	LD	(IX+%FFFFFFFA),L
0427AE DD74FB              A  8223    	LD	(IX+%FFFFFFFB),H
                           A  8224    ; 2912					}
                           A  8225    ; 2913				}
                           A  8226    ; 2914			}
0427B1                     A  8227    L_355:
                           A  8228    .LINE 2914
                           A  8229    
                           A  8230    ; 2915			dp->fn[i++] = (BYTE)wc;
                           A  8231    .LINE 2915
                           A  8232    
0427B1 DD7EFA              A  8233    	LD	A,(IX+%FFFFFFFA)
0427B4 DD07F7              A  8234    	LD	BC,(IX+%FFFFFFF7)
0427B7 DD3106              A  8235    	LD	IY,(IX+%6)
0427BA ED231E              A  8236    	LEA	HL,IY+%1E
0427BD 09                  A  8237    	ADD	HL,BC
0427BE 77                  A  8238    	LD	(HL),A
0427BF DD07F7              A  8239    	LD	BC,(IX+%FFFFFFF7)
0427C2 03                  A  8240    	INC	BC
0427C3 DD0FF7              A  8241    	LD	(IX+%FFFFFFF7),BC
                           A  8242    ; 2916		}
                           A  8243    .LINE 2916
                           A  8244    
0427C6 C3 BF 25 04         A  8245    	JR	L_356
0427CA                     A  8246    L_359:
                           A  8247    ; 2917	
                           A  8248    ; 2918		if (dp->fn[0] == DDEM) dp->fn[0] = 
                           A  8249    .LINE 2918
                           A  8250    
0427CA DD3106              A  8251    	LD	IY,(IX+%6)
0427CD ED031E              A  8252    	LEA	BC,IY+%1E
0427D0 DD0FD7              A  8253    	LD	(IX+%FFFFFFD7),BC
0427D3 FD7E1E              A  8254    	LD	A,(IY+%1E)
0427D6 B7ED62              A  8255    	UEXT	HL
0427D9 6F                  A  8256    	LD	L,A
0427DA 01E50000            A  8257    	LD	BC,229
0427DE B7                  A  8258    	OR	A,A
0427DF ED42                A  8259    	SBC	HL,BC
0427E1 20 0D               A  8260    	JR	NZ,L_361
0427E3 DD3106              A  8261    	LD	IY,(IX+%6)
0427E6 ED031E              A  8262    	LEA	BC,IY+%1E
0427E9 DD0FD7              A  8263    	LD	(IX+%FFFFFFD7),BC
0427EC FD361E05            A  8264    	LD	(IY+%1E),%5
0427F0                     A  8265    L_361:
                           A  8266    ; 2919	
                           A  8267    ; 2920		if (ni == 8) b <<= 2;				
                           A  8268    .LINE 2920
                           A  8269    
0427F0 01080000            A  8270    	LD	BC,8
0427F4 DD27E6              A  8271    	LD	HL,(IX+%FFFFFFE6)
0427F7 B7                  A  8272    	OR	A,A
0427F8 ED42                A  8273    	SBC	HL,BC
0427FA 20 08               A  8274    	JR	NZ,L_364
0427FC DD7EF6              A  8275    	LD	A,(IX+%FFFFFFF6)
0427FF 87                  A  8276    	ADD	A,A
042800 87                  A  8277    	ADD	A,A
042801 DD77F6              A  8278    	LD	(IX+%FFFFFFF6),A
042804                     A  8279    L_364:
                           A  8280    ; 2921		if ((b & 0x0C) == 0x0C || (b & 0x03
                           A  8281    .LINE 2921
                           A  8282    
042804 DD7EF6              A  8283    	LD	A,(IX+%FFFFFFF6)
042807 E60C                A  8284    	AND	A,%C
042809 FE0C                A  8285    	CP	A,%C
04280B 28 09               A  8286    	JR	Z,L_363
04280D DD7EF6              A  8287    	LD	A,(IX+%FFFFFFF6)
042810 E603                A  8288    	AND	A,%3
042812 FE03                A  8289    	CP	A,%3
042814 20 08               A  8290    	JR	NZ,L_369
042816                     A  8291    L_363:
042816 DD7EFC              A  8292    	LD	A,(IX+%FFFFFFFC)
042819 CBCF                A  8293    	SET	%1,A
04281B DD77FC              A  8294    	LD	(IX+%FFFFFFFC),A
04281E                     A  8295    L_369:
                           A  8296    ; 2922		if (!(cf & NS_LFN)) {				
                           A  8297    .LINE 2922
                           A  8298    
04281E DD7EFC              A  8299    	LD	A,(IX+%FFFFFFFC)
042821 E602                A  8300    	AND	A,%2
042823 20 1E               A  8301    	JR	NZ,L_370
                           A  8302    ; 2923			if (b & 0x01) cf |= NS_EXT;		
                           A  8303    .LINE 2923
                           A  8304    
042825 DD7EF6              A  8305    	LD	A,(IX+%FFFFFFF6)
042828 E601                A  8306    	AND	A,%1
04282A 28 08               A  8307    	JR	Z,L_367
04282C DD7EFC              A  8308    	LD	A,(IX+%FFFFFFFC)
04282F CBE7                A  8309    	SET	%4,A
042831 DD77FC              A  8310    	LD	(IX+%FFFFFFFC),A
042834                     A  8311    L_367:
                           A  8312    ; 2924			if (b & 0x04) cf |= NS_BODY;	
                           A  8313    .LINE 2924
                           A  8314    
042834 DD7EF6              A  8315    	LD	A,(IX+%FFFFFFF6)
042837 E604                A  8316    	AND	A,%4
042839 28 08               A  8317    	JR	Z,L_370
04283B DD7EFC              A  8318    	LD	A,(IX+%FFFFFFFC)
04283E CBDF                A  8319    	SET	%3,A
042840 DD77FC              A  8320    	LD	(IX+%FFFFFFFC),A
                           A  8321    ; 2925		}
042843                     A  8322    L_370:
                           A  8323    .LINE 2925
                           A  8324    
                           A  8325    ; 2926	
                           A  8326    ; 2927		dp->fn[NSFLAG] = cf;	/* SFN is c
                           A  8327    .LINE 2927
                           A  8328    
042843 DD31D7              A  8329    	LD	IY,(IX+%FFFFFFD7)
042846 ED230B              A  8330    	LEA	HL,IY+%B
042849 DD7EFC              A  8331    	LD	A,(IX+%FFFFFFFC)
04284C 77                  A  8332    	LD	(HL),A
                           A  8333    ; 2928	
                           A  8334    ; 2929		return FR_OK;
                           A  8335    .LINE 2929
                           A  8336    
04284D B7                  A  8337    	OR	A,A
04284E ED62                A  8338    	SBC	HL,HL
                           A  8339    ; 2930	
                           A  8340    ; 2931	
                           A  8341    ; 2932	#else	/* FF_USE_LFN : Non-LFN configu
                           A  8342    ; 2933		BYTE c, d, *sfn;
                           A  8343    ; 2934		UINT ni, si, i;
                           A  8344    ; 2935		const char *p;
                           A  8345    ; 2936	
                           A  8346    ; 2937		/* Create file name in directory fo
                           A  8347    ; 2938		p = *path; sfn = dp->fn;
                           A  8348    ; 2939		memset(sfn, ' ', 11);
                           A  8349    ; 2940		si = i = 0; ni = 8;
                           A  8350    ; 2941	#if FF_FS_RPATH != 0
                           A  8351    ; 2942		if (p[si] == '.') { /* Is this a do
                           A  8352    ; 2943			for (;;) {
                           A  8353    ; 2944				c = (BYTE)p[si++];
                           A  8354    ; 2945				if (c != '.' || si >= 3) br
                           A  8355    ; 2946				sfn[i++] = c;
                           A  8356    ; 2947			}
                           A  8357    ; 2948			if (!IsSeparator(c) && c > ' ')
                           A  8358    ; 2949			*path = p + si;					
                           A  8359    ; 2950			sfn[NSFLAG] = (c <= ' ') ? NS_L
                           A  8360    ; 2951			return FR_OK;
                           A  8361    ; 2952		}
                           A  8362    ; 2953	#endif
                           A  8363    ; 2954		for (;;) {
                           A  8364    ; 2955			c = (BYTE)p[si++];				
                           A  8365    ; 2956			if (c <= ' ') break; 			
                           A  8366    ; 2957			if (IsSeparator(c)) {			
                           A  8367    ; 2958				while (IsSeparator(p[si])) 
                           A  8368    ; 2959				break;
                           A  8369    ; 2960			}
                           A  8370    ; 2961			if (c == '.' || i >= ni) {		
                           A  8371    ; 2962				if (ni == 11 || c != '.') r
                           A  8372    ; 2963				i = 8; ni = 11;				
                           A  8373    ; 2964				continue;
                           A  8374    ; 2965			}
                           A  8375    ; 2966	#if FF_CODE_PAGE == 0
                           A  8376    ; 2967			if (ExCvt && c >= 0x80) {		
                           A  8377    ; 2968				c = ExCvt[c & 0x7F];		
                           A  8378    ; 2969			}
                           A  8379    ; 2970	#elif FF_CODE_PAGE < 900
                           A  8380    ; 2971			if (c >= 0x80) {				
                           A  8381    ; 2972				c = ExCvt[c & 0x7F];		
                           A  8382    ; 2973			}
                           A  8383    ; 2974	#endif
                           A  8384    ; 2975			if (dbc_1st(c)) {				
                           A  8385    ; 2976				d = (BYTE)p[si++];			
                           A  8386    ; 2977				if (!dbc_2nd(d) || i >= ni 
                           A  8387    ; 2978				sfn[i++] = c;
                           A  8388    ; 2979				sfn[i++] = d;
                           A  8389    ; 2980			} else {						
                           A  8390    ; 2981				if (strchr("*+,:;<=>[]|\"\?
                           A  8391    ; 2982				if (IsLower(c)) c -= 0x20;	
                           A  8392    ; 2983				sfn[i++] = c;
                           A  8393    ; 2984			}
                           A  8394    ; 2985		}
                           A  8395    ; 2986		*path = &p[si];						
                           A  8396    ; 2987		if (i == 0) return FR_INVALID_NAME;
                           A  8397    ; 2988	
                           A  8398    ; 2989		if (sfn[0] == DDEM) sfn[0] = RDDEM;
                           A  8399    ; 2990		sfn[NSFLAG] = (c <= ' ' || p[si] <=
                           A  8400    ; 2991	
                           A  8401    ; 2992		return FR_OK;
                           A  8402    ; 2993	#endif /* FF_USE_LFN */
                           A  8403    ; 2994	}
042850                     A  8404    L_371:
                           A  8405    .LINE 2994
                           A  8406    
042850 DDF9                A  8407    	LD	SP,IX
042852 DDE1                A  8408    	POP	IX
042854 C9                  A  8409    	RET	
                           A  8410    
                           A  8411    
                           A  8412    ;**************************** _create_name ****
                           A  8413    ;Name                         Addr/Register   S
                           A  8414    ;_ExCvt                              STATIC    
                           A  8415    ;_ff_uni2oem                         IMPORT  --
                           A  8416    ;_memset                             IMPORT  --
                           A  8417    ;_strchr                             IMPORT  --
                           A  8418    ;G_20                                 IX-41    
                           A  8419    ;G_18                                 IX-38    
                           A  8420    ;G_17                                 IX-35    
                           A  8421    ;G_16                                 IX-32    
                           A  8422    ;temp290                              IX-29    
                           A  8423    ;ni                                   IX-26    
                           A  8424    ;p                                    IX-23    
                           A  8425    ;uc                                   IX-20    
                           A  8426    ;lfn                                  IX-16    
                           A  8427    ;si                                   IX-13    
                           A  8428    ;b                                    IX-10    
                           A  8429    ;i                                     IX-9    
                           A  8430    ;wc                                    IX-6    
                           A  8431    ;cf                                    IX-4    
                           A  8432    ;di                                    IX-3    
                           A  8433    ;path                                  IX+9    
                           A  8434    ;dp                                    IX+6    
                           A  8435    
                           A  8436    
                           A  8437    ; Stack Frame Size: 56 (bytes)
                           A  8438    ;       Spill Code: 0 (instruction)
                           A  8439    
                           A  8440    
                           A  8441    .ENDFUNC "create_name",2994,"_create_name"
                           A  8442    	SEGMENT STRSECT
044D7F                     A  8443    L__141:
044D7F 2A3A3C3E 7C223F     A  8444    	DB	"*:<>|\"?"
044D86 7F00                A  8445    	DB	127,0
044D88                     A  8446    L__178:
044D88 2B2C3B3D 5B5D       A  8447    	DB	"+,;=[]"
044D8E 00                  A  8448    	DB	0
                           A  8449    	SEGMENT CODE
                           A  8450    ; 2995	
                           A  8451    ; 2996	
                           A  8452    ; 2997	
                           A  8453    ; 2998	
                           A  8454    ; 2999	/*-------------------------------------
                           A  8455    ; 3000	/* Follow a file path                  
                           A  8456    ; 3001	/*-------------------------------------
                           A  8457    ; 3002	
                           A  8458    ; 3003	static FRESULT follow_path (	/* FR_O
                           A  8459    ; 3004		DIR* dp,					/* Dire
                           A  8460    ; 3005		const TCHAR* path			/* Full
                           A  8461    ; 3006	)
                           A  8462    ; 3007	{
042855                     A  8463    _follow_path:
                           A  8464    .DEFINE "_follow_path"
                           A  8465    
                           A  8466    .VALUE _follow_path
                           A  8467    
                           A  8468    .CLASS 3
                           A  8469    
                           A  8470    .TYPE 68
                           A  8471    
                           A  8472    .ENDEF
                           A  8473    
                           A  8474    .BEGFUNC "follow_path",3007,"_follow_path"
                           A  8475    
                           A  8476    .LINE 3007
                           A  8477    
                           A  8478    .DEFINE "dp"
                           A  8479    
                           A  8480    .CLASS 65
                           A  8481    
                           A  8482    .VALUE 6
                           A  8483    
                           A  8484    .TAG "NONAME3"
                           A  8485    
                           A  8486    .TYPE 40
                           A  8487    
                           A  8488    .ENDEF
                           A  8489    
                           A  8490    .DEFINE "path"
                           A  8491    
                           A  8492    .CLASS 65
                           A  8493    
                           A  8494    .VALUE 9
                           A  8495    
                           A  8496    .TYPE 194
                           A  8497    
                           A  8498    .ENDEF
                           A  8499    
                           A  8500    .DEFINE "res"
                           A  8501    
                           A  8502    .CLASS 65
                           A  8503    
                           A  8504    .VALUE -3
                           A  8505    
                           A  8506    .TYPE 4
                           A  8507    
                           A  8508    .ENDEF
                           A  8509    
                           A  8510    .DEFINE "ns"
                           A  8511    
                           A  8512    .CLASS 65
                           A  8513    
                           A  8514    .VALUE -4
                           A  8515    
                           A  8516    .TYPE 12
                           A  8517    
                           A  8518    .ENDEF
                           A  8519    
                           A  8520    .DEFINE "fs"
                           A  8521    
                           A  8522    .CLASS 65
                           A  8523    
                           A  8524    .VALUE -7
                           A  8525    
                           A  8526    .TAG "NONAME0"
                           A  8527    
                           A  8528    .TYPE 40
                           A  8529    
                           A  8530    .ENDEF
                           A  8531    
042855 DDE5                A  8532    	PUSH	IX
042857 DD210000 00         A  8533    	LD	IX,0
04285C DD39                A  8534    	ADD	IX,SP
04285E ED22F3              A  8535    	LEA	HL,IX+%FFFFFFF3
042861 F9                  A  8536    	LD	SP,HL
                           A  8537    ; 3008		FRESULT res;
                           A  8538    ; 3009		BYTE ns;
                           A  8539    ; 3010		FATFS *fs = dp->obj.fs;
                           A  8540    .LINE 3010
                           A  8541    
042862 DD3106              A  8542    	LD	IY,(IX+%6)
042865 FD0700              A  8543    	LD	BC,(IY+%0)
042868 DD0FF9              A  8544    	LD	(IX+%FFFFFFF9),BC
                           A  8545    ; 3011	
                           A  8546    ; 3012	
                           A  8547    ; 3013	#if FF_FS_RPATH != 0
                           A  8548    ; 3014		if (!IsSeparator(*path) && (FF_STR_
                           A  8549    .LINE 3014
                           A  8550    
04286B DD2709              A  8551    	LD	HL,(IX+%9)
04286E 7E                  A  8552    	LD	A,(HL)
04286F 47                  A  8553    	LD	B,A
042870 17ED62              A  8554    	SEXT	HL
042873 68                  A  8555    	LD	L,B
042874 012F0000            A  8556    	LD	BC,47
042878 B7                  A  8557    	OR	A,A
042879 ED42                A  8558    	SBC	HL,BC
04287B 28 33               A  8559    	JR	Z,L_376
04287D DD2709              A  8560    	LD	HL,(IX+%9)
042880 7E                  A  8561    	LD	A,(HL)
042881 47                  A  8562    	LD	B,A
042882 17ED62              A  8563    	SEXT	HL
042885 68                  A  8564    	LD	L,B
042886 015C0000            A  8565    	LD	BC,92
04288A B7                  A  8566    	OR	A,A
04288B ED42                A  8567    	SBC	HL,BC
04288D 28 21               A  8568    	JR	Z,L_376
                           A  8569    ; 3015			dp->obj.sclust = fs->cdir;		
                           A  8570    .LINE 3015
                           A  8571    
04288F DD31F9              A  8572    	LD	IY,(IX+%FFFFFFF9)
042892 FD070E              A  8573    	LD	BC,(IY+%E)
042895 FD7E11              A  8574    	LD	A,(IY+%11)
042898 DD3106              A  8575    	LD	IY,(IX+%6)
04289B FD0F07              A  8576    	LD	(IY+%7),BC
04289E FD770A              A  8577    	LD	(IY+%A),A
                           A  8578    ; 3016		} else
                           A  8579    .LINE 3016
                           A  8580    
0428A1 18 3F               A  8581    	JR	L_400
                           A  8582    ; 3017	#endif
                           A  8583    ; 3018		{									
                           A  8584    ; 3019			while (IsSeparator(*path)) path
0428A3                     A  8585    L_377:
                           A  8586    .LINE 3019
                           A  8587    
0428A3 DD0709              A  8588    	LD	BC,(IX+%9)
0428A6 DD0FF3              A  8589    	LD	(IX+%FFFFFFF3),BC
0428A9 DD0709              A  8590    	LD	BC,(IX+%9)
0428AC 03                  A  8591    	INC	BC
0428AD DD0F09              A  8592    	LD	(IX+%9),BC
0428B0                     A  8593    L_376:
0428B0 DD2709              A  8594    	LD	HL,(IX+%9)
0428B3 7E                  A  8595    	LD	A,(HL)
0428B4 47                  A  8596    	LD	B,A
0428B5 17ED62              A  8597    	SEXT	HL
0428B8 68                  A  8598    	LD	L,B
0428B9 012F0000            A  8599    	LD	BC,47
0428BD B7                  A  8600    	OR	A,A
0428BE ED42                A  8601    	SBC	HL,BC
0428C0 28 E1               A  8602    	JR	Z,L_377
0428C2 DD2709              A  8603    	LD	HL,(IX+%9)
0428C5 7E                  A  8604    	LD	A,(HL)
0428C6 47                  A  8605    	LD	B,A
0428C7 17ED62              A  8606    	SEXT	HL
0428CA 68                  A  8607    	LD	L,B
0428CB 015C0000            A  8608    	LD	BC,92
0428CF B7                  A  8609    	OR	A,A
0428D0 ED42                A  8610    	SBC	HL,BC
0428D2 28 CF               A  8611    	JR	Z,L_377
                           A  8612    ; 3020			dp->obj.sclust = 0;				
                           A  8613    .LINE 3020
                           A  8614    
0428D4 01000000            A  8615    	LD	BC,0
0428D8 DD3106              A  8616    	LD	IY,(IX+%6)
0428DB FD0F07              A  8617    	LD	(IY+%7),BC
0428DE FD360A00            A  8618    	LD	(IY+%A),%0
                           A  8619    ; 3021		}
0428E2                     A  8620    L_400:
                           A  8621    .LINE 3021
                           A  8622    
                           A  8623    ; 3022	#if FF_FS_EXFAT
                           A  8624    ; 3023		dp->obj.n_frag = 0;	/* Invalidate l
                           A  8625    ; 3024	#if FF_FS_RPATH != 0
                           A  8626    ; 3025		if (fs->fs_type == FS_EXFAT && dp->
                           A  8627    ; 3026			DIR dj;
                           A  8628    ; 3027	
                           A  8629    ; 3028			dp->obj.c_scl = fs->cdc_scl;
                           A  8630    ; 3029			dp->obj.c_size = fs->cdc_size;
                           A  8631    ; 3030			dp->obj.c_ofs = fs->cdc_ofs;
                           A  8632    ; 3031			res = load_obj_xdir(&dj, &dp->o
                           A  8633    ; 3032			if (res != FR_OK) return res;
                           A  8634    ; 3033			dp->obj.objsize = ld_dword(fs->
                           A  8635    ; 3034			dp->obj.stat = fs->dirbuf[XDIR_
                           A  8636    ; 3035		}
                           A  8637    ; 3036	#endif
                           A  8638    ; 3037	#endif
                           A  8639    ; 3038	
                           A  8640    ; 3039		if ((UINT)*path < ' ') {			
                           A  8641    .LINE 3039
                           A  8642    
0428E2 DD2709              A  8643    	LD	HL,(IX+%9)
0428E5 7E                  A  8644    	LD	A,(HL)
0428E6 47                  A  8645    	LD	B,A
0428E7 17ED62              A  8646    	SEXT	HL
0428EA 68                  A  8647    	LD	L,B
0428EB 01200000            A  8648    	LD	BC,32
0428EF B7                  A  8649    	OR	A,A
0428F0 ED42                A  8650    	SBC	HL,BC
0428F2 30 20               A  8651    	JR	NC,L_396
                           A  8652    ; 3040			dp->fn[NSFLAG] = NS_NONAME;
                           A  8653    .LINE 3040
                           A  8654    
0428F4 DD3106              A  8655    	LD	IY,(IX+%6)
0428F7 ED2329              A  8656    	LEA	HL,IY+%29
0428FA 3680                A  8657    	LD	(HL),%80
                           A  8658    ; 3041			res = dir_sdi(dp, 0);
                           A  8659    .LINE 3041
                           A  8660    
0428FC 01000000            A  8661    	LD	BC,0
042900 C5                  A  8662    	PUSH	BC
042901 C5                  A  8663    	PUSH	BC
042902 DD0706              A  8664    	LD	BC,(IX+%6)
042905 C5                  A  8665    	PUSH	BC
042906 CD B4 14 04         A  8666    	CALL	_dir_sdi
04290A C1                  A  8667    	POP	BC
04290B C1                  A  8668    	POP	BC
04290C C1                  A  8669    	POP	BC
04290D DD2FFD              A  8670    	LD	(IX+%FFFFFFFD),HL
                           A  8671    ; 3042	
                           A  8672    ; 3043		} else {							
                           A  8673    .LINE 3043
                           A  8674    
042910 C3 D6 29 04         A  8675    	JR	L_401
                           A  8676    ; 3044			for (;;) {
042914                     A  8677    L_396:
                           A  8678    .LINE 3044
                           A  8679    
                           A  8680    ; 3045				res = create_name(dp, &path
                           A  8681    .LINE 3045
                           A  8682    
042914 ED6509              A  8683    	PEA	IX+%9
042917 DD0706              A  8684    	LD	BC,(IX+%6)
04291A C5                  A  8685    	PUSH	BC
04291B CD 78 22 04         A  8686    	CALL	_create_name
04291F C1                  A  8687    	POP	BC
042920 C1                  A  8688    	POP	BC
042921 DD2FFD              A  8689    	LD	(IX+%FFFFFFFD),HL
                           A  8690    ; 3046				if (res != FR_OK) break;
                           A  8691    .LINE 3046
                           A  8692    
042924 CD E5 46 04         A  8693    	CALL	__icmpzero
042928 C2 D6 29 04         A  8694    	JR	NZ,L_401
                           A  8695    ; 3047				res = dir_find(dp);			
                           A  8696    .LINE 3047
                           A  8697    
04292C DD0706              A  8698    	LD	BC,(IX+%6)
04292F C5                  A  8699    	PUSH	BC
042930 CD 60 1D 04         A  8700    	CALL	_dir_find
042934 C1                  A  8701    	POP	BC
042935 DD2FFD              A  8702    	LD	(IX+%FFFFFFFD),HL
                           A  8703    ; 3048				ns = dp->fn[NSFLAG];
                           A  8704    .LINE 3048
                           A  8705    
042938 DD3106              A  8706    	LD	IY,(IX+%6)
04293B ED3329              A  8707    	LEA	IY,IY+%29
04293E DD3EF6              A  8708    	LD	(IX+%FFFFFFF6),IY
042941 DD27F6              A  8709    	LD	HL,(IX+%FFFFFFF6)
042944 7E                  A  8710    	LD	A,(HL)
042945 DD77FC              A  8711    	LD	(IX+%FFFFFFFC),A
                           A  8712    ; 3049				if (res != FR_OK) {			
                           A  8713    .LINE 3049
                           A  8714    
042948 DD27FD              A  8715    	LD	HL,(IX+%FFFFFFFD)
04294B CD E5 46 04         A  8716    	CALL	__icmpzero
04294F 28 38               A  8717    	JR	Z,L_392
                           A  8718    ; 3050					if (res == FR_NO_FILE) 
                           A  8719    .LINE 3050
                           A  8720    
042951 01040000            A  8721    	LD	BC,4
042955 DD27FD              A  8722    	LD	HL,(IX+%FFFFFFFD)
042958 B7                  A  8723    	OR	A,A
042959 ED42                A  8724    	SBC	HL,BC
04295B 20 79               A  8725    	JR	NZ,L_401
                           A  8726    ; 3051						if (FF_FS_RPATH && 
                           A  8727    .LINE 3051
                           A  8728    
04295D DD7EFC              A  8729    	LD	A,(IX+%FFFFFFFC)
042960 E620                A  8730    	AND	A,%20
042962 28 15               A  8731    	JR	Z,L_387
                           A  8732    ; 3052							if (!(ns & NS_L
                           A  8733    .LINE 3052
                           A  8734    
042964 DD7EFC              A  8735    	LD	A,(IX+%FFFFFFFC)
042967 E604                A  8736    	AND	A,%4
042969 28 A9               A  8737    	JR	Z,L_396
                           A  8738    ; 3053							dp->fn[NSFLAG] 
                           A  8739    .LINE 3053
                           A  8740    
04296B DD27F6              A  8741    	LD	HL,(IX+%FFFFFFF6)
04296E 3680                A  8742    	LD	(HL),%80
                           A  8743    ; 3054							res = FR_OK;
                           A  8744    .LINE 3054
                           A  8745    
042970 01000000            A  8746    	LD	BC,0
042974 DD0FFD              A  8747    	LD	(IX+%FFFFFFFD),BC
                           A  8748    ; 3055						} else {			
                           A  8749    .LINE 3055
                           A  8750    
042977 18 5D               A  8751    	JR	L_401
042979                     A  8752    L_387:
                           A  8753    ; 3056							if (!(ns & NS_L
                           A  8754    .LINE 3056
                           A  8755    
042979 DD7EFC              A  8756    	LD	A,(IX+%FFFFFFFC)
04297C E604                A  8757    	AND	A,%4
04297E 20 56               A  8758    	JR	NZ,L_401
042980 01050000            A  8759    	LD	BC,5
042984 DD0FFD              A  8760    	LD	(IX+%FFFFFFFD),BC
                           A  8761    ; 3057						}
                           A  8762    ; 3058					}
                           A  8763    .LINE 3058
                           A  8764    
                           A  8765    ; 3059					break;
                           A  8766    .LINE 3059
                           A  8767    
042987 18 4D               A  8768    	JR	L_401
                           A  8769    ; 3060				}
042989                     A  8770    L_392:
                           A  8771    .LINE 3060
                           A  8772    
                           A  8773    ; 3061				if (ns & NS_LAST) break;	
                           A  8774    .LINE 3061
                           A  8775    
042989 DD7EFC              A  8776    	LD	A,(IX+%FFFFFFFC)
04298C E604                A  8777    	AND	A,%4
04298E 20 46               A  8778    	JR	NZ,L_401
                           A  8779    ; 3062				/* Get into the sub-directo
                           A  8780    ; 3063				if (!(dp->obj.attr & AM_DIR
                           A  8781    .LINE 3063
                           A  8782    
042990 DD3106              A  8783    	LD	IY,(IX+%6)
042993 FD7E05              A  8784    	LD	A,(IY+%5)
042996 E610                A  8785    	AND	A,%10
042998 20 09               A  8786    	JR	NZ,L_395
                           A  8787    ; 3064					res = FR_NO_PATH; break
                           A  8788    .LINE 3064
                           A  8789    
04299A 01050000            A  8790    	LD	BC,5
04299E DD0FFD              A  8791    	LD	(IX+%FFFFFFFD),BC
0429A1 18 33               A  8792    	JR	L_401
                           A  8793    ; 3065				}
0429A3                     A  8794    L_395:
                           A  8795    .LINE 3065
                           A  8796    
                           A  8797    ; 3066	#if FF_FS_EXFAT
                           A  8798    ; 3067				if (fs->fs_type == FS_EXFAT
                           A  8799    ; 3068					dp->obj.c_scl = dp->obj
                           A  8800    ; 3069					dp->obj.c_size = ((DWOR
                           A  8801    ; 3070					dp->obj.c_ofs = dp->blk
                           A  8802    ; 3071					init_alloc_info(fs, &dp
                           A  8803    ; 3072				} else
                           A  8804    ; 3073	#endif
                           A  8805    ; 3074				{
                           A  8806    ; 3075					dp->obj.sclust = ld_clu
                           A  8807    .LINE 3075
                           A  8808    
0429A3 DD3106              A  8809    	LD	IY,(IX+%6)
0429A6 FD270F              A  8810    	LD	HL,(IY+%F)
0429A9 FD5E12              A  8811    	LD	E,(IY+%12)
0429AC 01FF0100            A  8812    	LD	BC,511
0429B0 AF                  A  8813    	XOR	A,A
0429B1 CD B4 48 04         A  8814    	CALL	__land
0429B5 E5C1                A  8815    	LD	BC,HL
0429B7 DD31F9              A  8816    	LD	IY,(IX+%FFFFFFF9)
0429BA ED232E              A  8817    	LEA	HL,IY+%2E
0429BD 09                  A  8818    	ADD	HL,BC
0429BE E5                  A  8819    	PUSH	HL
0429BF DD07F9              A  8820    	LD	BC,(IX+%FFFFFFF9)
0429C2 C5                  A  8821    	PUSH	BC
0429C3 CD CC 18 04         A  8822    	CALL	_ld_clust
0429C7 C1                  A  8823    	POP	BC
0429C8 C1                  A  8824    	POP	BC
0429C9 DD3106              A  8825    	LD	IY,(IX+%6)
0429CC FD2F07              A  8826    	LD	(IY+%7),HL
0429CF FD730A              A  8827    	LD	(IY+%A),E
                           A  8828    ; 3076				}
                           A  8829    ; 3077			}
                           A  8830    .LINE 3077
                           A  8831    
0429D2 C3 14 29 04         A  8832    	JR	L_396
                           A  8833    ; 3078		}
0429D6                     A  8834    L_401:
                           A  8835    .LINE 3078
                           A  8836    
                           A  8837    ; 3079	
                           A  8838    ; 3080		return res;
                           A  8839    .LINE 3080
                           A  8840    
0429D6 DD27FD              A  8841    	LD	HL,(IX+%FFFFFFFD)
                           A  8842    ; 3081	}
                           A  8843    .LINE 3081
                           A  8844    
0429D9 DDF9                A  8845    	LD	SP,IX
0429DB DDE1                A  8846    	POP	IX
0429DD C9                  A  8847    	RET	
                           A  8848    
                           A  8849    
                           A  8850    ;**************************** _follow_path ****
                           A  8851    ;Name                         Addr/Register   S
                           A  8852    ;G_22                                 IX-10    
                           A  8853    ;fs                                    IX-7    
                           A  8854    ;ns                                    IX-4    
                           A  8855    ;res                                   IX-3    
                           A  8856    ;path                                  IX+9    
                           A  8857    ;dp                                    IX+6    
                           A  8858    
                           A  8859    
                           A  8860    ; Stack Frame Size: 25 (bytes)
                           A  8861    ;       Spill Code: 0 (instruction)
                           A  8862    
                           A  8863    
                           A  8864    .ENDFUNC "follow_path",3081,"_follow_path"
                           A  8865    ; 3082	
                           A  8866    ; 3083	
                           A  8867    ; 3084	
                           A  8868    ; 3085	
                           A  8869    ; 3086	/*-------------------------------------
                           A  8870    ; 3087	/* Get logical drive number from path n
                           A  8871    ; 3088	/*-------------------------------------
                           A  8872    ; 3089	
                           A  8873    ; 3090	static int get_ldnumber (	/* Returns 
                           A  8874    ; 3091		const TCHAR** path		/* Pointer 
                           A  8875    ; 3092	)
                           A  8876    ; 3093	{
0429DE                     A  8877    _get_ldnumber:
                           A  8878    .DEFINE "_get_ldnumber"
                           A  8879    
                           A  8880    .VALUE _get_ldnumber
                           A  8881    
                           A  8882    .CLASS 3
                           A  8883    
                           A  8884    .TYPE 68
                           A  8885    
                           A  8886    .ENDEF
                           A  8887    
                           A  8888    .BEGFUNC "get_ldnumber",3093,"_get_ldnumber"
                           A  8889    
                           A  8890    .LINE 3093
                           A  8891    
                           A  8892    .DEFINE "path"
                           A  8893    
                           A  8894    .CLASS 65
                           A  8895    
                           A  8896    .VALUE 6
                           A  8897    
                           A  8898    .TYPE 1570
                           A  8899    
                           A  8900    .ENDEF
                           A  8901    
                           A  8902    .DEFINE "tp"
                           A  8903    
                           A  8904    .CLASS 65
                           A  8905    
                           A  8906    .VALUE -3
                           A  8907    
                           A  8908    .TYPE 194
                           A  8909    
                           A  8910    .ENDEF
                           A  8911    
                           A  8912    .DEFINE "tt"
                           A  8913    
                           A  8914    .CLASS 65
                           A  8915    
                           A  8916    .VALUE -6
                           A  8917    
                           A  8918    .TYPE 194
                           A  8919    
                           A  8920    .ENDEF
                           A  8921    
                           A  8922    .DEFINE "tc"
                           A  8923    
                           A  8924    .CLASS 65
                           A  8925    
                           A  8926    .VALUE -7
                           A  8927    
                           A  8928    .TYPE 2
                           A  8929    
                           A  8930    .ENDEF
                           A  8931    
                           A  8932    .DEFINE "i"
                           A  8933    
                           A  8934    .CLASS 65
                           A  8935    
                           A  8936    .VALUE -10
                           A  8937    
                           A  8938    .TYPE 4
                           A  8939    
                           A  8940    .ENDEF
                           A  8941    
                           A  8942    .DEFINE "vol"
                           A  8943    
                           A  8944    .CLASS 65
                           A  8945    
                           A  8946    .VALUE -13
                           A  8947    
                           A  8948    .TYPE 4
                           A  8949    
                           A  8950    .ENDEF
                           A  8951    
0429DE DDE5                A  8952    	PUSH	IX
0429E0 DD210000 00         A  8953    	LD	IX,0
0429E5 DD39                A  8954    	ADD	IX,SP
0429E7 ED22F0              A  8955    	LEA	HL,IX+%FFFFFFF0
0429EA F9                  A  8956    	LD	SP,HL
                           A  8957    ; 3094		const TCHAR *tp, *tt;
                           A  8958    ; 3095		TCHAR tc;
                           A  8959    ; 3096		int i;
                           A  8960    ; 3097		int vol = -1;
                           A  8961    .LINE 3097
                           A  8962    
0429EB 01FFFFFF            A  8963    	LD	BC,16777215
0429EF DD0FF3              A  8964    	LD	(IX+%FFFFFFF3),BC
                           A  8965    ; 3098	#if FF_STR_VOLUME_ID		/* Find str
                           A  8966    ; 3099		const char *sp;
                           A  8967    ; 3100		char c;
                           A  8968    ; 3101	#endif
                           A  8969    ; 3102	
                           A  8970    ; 3103		tt = tp = *path;
                           A  8971    .LINE 3103
                           A  8972    
0429F2 DD2706              A  8973    	LD	HL,(IX+%6)
0429F5 ED07                A  8974    	LD	BC,(HL)
0429F7 DD0FFD              A  8975    	LD	(IX+%FFFFFFFD),BC
0429FA DD0FFA              A  8976    	LD	(IX+%FFFFFFFA),BC
                           A  8977    ; 3104		if (!tp) return vol;	/* Invalid 
                           A  8978    .LINE 3104
                           A  8979    
0429FD C5E1                A  8980    	LD	HL,BC
0429FF CD E5 46 04         A  8981    	CALL	__icmpzero
042A03 20 08               A  8982    	JR	NZ,L_406
042A05 21FFFFFF            A  8983    	LD	HL,16777215
042A09 C3 C2 2A 04         A  8984    	JR	L_418
                           A  8985    ; 3105		do tc = *tt++; while (!IsTerminator
042A0D                     A  8986    L_406:
                           A  8987    .LINE 3105
                           A  8988    
042A0D DD07FA              A  8989    	LD	BC,(IX+%FFFFFFFA)
042A10 DD0FF0              A  8990    	LD	(IX+%FFFFFFF0),BC
042A13 C5E1                A  8991    	LD	HL,BC
042A15 7E                  A  8992    	LD	A,(HL)
042A16 DD77F9              A  8993    	LD	(IX+%FFFFFFF9),A
042A19 DD07FA              A  8994    	LD	BC,(IX+%FFFFFFFA)
042A1C 03                  A  8995    	INC	BC
042A1D DD0FFA              A  8996    	LD	(IX+%FFFFFFFA),BC
042A20 DD7EF9              A  8997    	LD	A,(IX+%FFFFFFF9)
042A23 FE20                A  8998    	CP	A,%20
042A25 38 07               A  8999    	JR	C,L_416
042A27 DD7EF9              A  9000    	LD	A,(IX+%FFFFFFF9)
042A2A FE3A                A  9001    	CP	A,%3A
042A2C 20 DF               A  9002    	JR	NZ,L_406
042A2E                     A  9003    L_416:
                           A  9004    ; 3106	
                           A  9005    ; 3107		if (tc == ':') {	/* DOS/Windows 
                           A  9006    .LINE 3107
                           A  9007    
042A2E DD7EF9              A  9008    	LD	A,(IX+%FFFFFFF9)
042A31 FE3A                A  9009    	CP	A,%3A
042A33 20 7A               A  9010    	JR	NZ,L_417
                           A  9011    ; 3108			i = FF_VOLUMES;
                           A  9012    .LINE 3108
                           A  9013    
042A35 01010000            A  9014    	LD	BC,1
042A39 DD0FF6              A  9015    	LD	(IX+%FFFFFFF6),BC
                           A  9016    ; 3109			if (IsDigit(*tp) && tp + 2 == t
                           A  9017    .LINE 3109
                           A  9018    
042A3C DD27FD              A  9019    	LD	HL,(IX+%FFFFFFFD)
042A3F 7E                  A  9020    	LD	A,(HL)
042A40 47                  A  9021    	LD	B,A
042A41 17ED62              A  9022    	SEXT	HL
042A44 68                  A  9023    	LD	L,B
042A45 01300000            A  9024    	LD	BC,48
042A49 B7                  A  9025    	OR	A,A
042A4A ED42                A  9026    	SBC	HL,BC
042A4C FA 8A 2A 04         A  9027    	JP	M,L_413
042A50 DD27FD              A  9028    	LD	HL,(IX+%FFFFFFFD)
042A53 7E                  A  9029    	LD	A,(HL)
042A54 47                  A  9030    	LD	B,A
042A55 17ED62              A  9031    	SEXT	HL
042A58 68                  A  9032    	LD	L,B
042A59 E5C1                A  9033    	LD	BC,HL
042A5B 21390000            A  9034    	LD	HL,57
042A5F B7                  A  9035    	OR	A,A
042A60 ED42                A  9036    	SBC	HL,BC
042A62 CD 87 44 04         A  9037    	CALL	__setflag
042A66 FA 8A 2A 04         A  9038    	JP	M,L_413
042A6A DD31FD              A  9039    	LD	IY,(IX+%FFFFFFFD)
042A6D ED2302              A  9040    	LEA	HL,IY+%2
042A70 DD07FA              A  9041    	LD	BC,(IX+%FFFFFFFA)
042A73 B7                  A  9042    	OR	A,A
042A74 ED42                A  9043    	SBC	HL,BC
042A76 20 12               A  9044    	JR	NZ,L_413
                           A  9045    ; 3110				i = (int)*tp - '0';	/* Get 
                           A  9046    .LINE 3110
                           A  9047    
042A78 DD27FD              A  9048    	LD	HL,(IX+%FFFFFFFD)
042A7B 7E                  A  9049    	LD	A,(HL)
042A7C 47                  A  9050    	LD	B,A
042A7D 17ED62              A  9051    	SEXT	HL
042A80 68                  A  9052    	LD	L,B
042A81 E5FDE1              A  9053    	LD	IY,HL
042A84 ED33D0              A  9054    	LEA	IY,IY+%FFFFFFD0
042A87 DD3EF6              A  9055    	LD	(IX+%FFFFFFF6),IY
                           A  9056    ; 3111			}
042A8A                     A  9057    L_413:
                           A  9058    .LINE 3111
                           A  9059    
                           A  9060    ; 3112	#if FF_STR_VOLUME_ID == 1	/* Arbitrar
                           A  9061    ; 3113			else {
                           A  9062    ; 3114				i = 0;
                           A  9063    ; 3115				do {
                           A  9064    ; 3116					sp = VolumeStr[i]; tp =
                           A  9065    ; 3117					do {	/* Compare the 
                           A  9066    ; 3118						c = *sp++; tc = *tp
                           A  9067    ; 3119						if (IsLower(c)) c -
                           A  9068    ; 3120						if (IsLower(tc)) tc
                           A  9069    ; 3121					} while (c && (TCHAR)c 
                           A  9070    ; 3122				} while ((c || tp != tt) &&
                           A  9071    ; 3123			}
                           A  9072    ; 3124	#endif
                           A  9073    ; 3125			if (i < FF_VOLUMES) {	/* If a
                           A  9074    .LINE 3125
                           A  9075    
042A8A 01010000            A  9076    	LD	BC,1
042A8E DD27F6              A  9077    	LD	HL,(IX+%FFFFFFF6)
042A91 B7                  A  9078    	OR	A,A
042A92 ED42                A  9079    	SBC	HL,BC
042A94 CD 87 44 04         A  9080    	CALL	__setflag
042A98 F2 AA 2A 04         A  9081    	JP	P,L_414
                           A  9082    ; 3126				vol = i;		/* Drive nu
                           A  9083    .LINE 3126
                           A  9084    
042A9C DD07F6              A  9085    	LD	BC,(IX+%FFFFFFF6)
042A9F DD0FF3              A  9086    	LD	(IX+%FFFFFFF3),BC
                           A  9087    ; 3127				*path = tt;		/* Snip the
                           A  9088    .LINE 3127
                           A  9089    
042AA2 DD2706              A  9090    	LD	HL,(IX+%6)
042AA5 DD07FA              A  9091    	LD	BC,(IX+%FFFFFFFA)
042AA8 ED0F                A  9092    	LD	(HL),BC
                           A  9093    ; 3128			}
042AAA                     A  9094    L_414:
                           A  9095    .LINE 3128
                           A  9096    
                           A  9097    ; 3129			return vol;
                           A  9098    .LINE 3129
                           A  9099    
042AAA DD27F3              A  9100    	LD	HL,(IX+%FFFFFFF3)
042AAD 18 13               A  9101    	JR	L_418
                           A  9102    ; 3130		}
042AAF                     A  9103    L_417:
                           A  9104    .LINE 3130
                           A  9105    
                           A  9106    ; 3131	#if FF_STR_VOLUME_ID == 2		/* Unix
                           A  9107    ; 3132		if (*tp == '/') {			/* Is t
                           A  9108    ; 3133			while (*(tp + 1) == '/') tp++;	
                           A  9109    ; 3134			i = 0;
                           A  9110    ; 3135			do {
                           A  9111    ; 3136				tt = tp; sp = VolumeStr[i];
                           A  9112    ; 3137				do {	/* Compare the volu
                           A  9113    ; 3138					c = *sp++; tc = *(++tt)
                           A  9114    ; 3139					if (IsLower(c)) c -= 0x
                           A  9115    ; 3140					if (IsLower(tc)) tc -= 
                           A  9116    ; 3141				} while (c && (TCHAR)c == t
                           A  9117    ; 3142			} while ((c || (tc != '/' && !I
                           A  9118    ; 3143			if (i < FF_VOLUMES) {	/* If a
                           A  9119    ; 3144				vol = i;		/* Drive nu
                           A  9120    ; 3145				*path = tt;		/* Snip the
                           A  9121    ; 3146			}
                           A  9122    ; 3147			return vol;
                           A  9123    ; 3148		}
                           A  9124    ; 3149	#endif
                           A  9125    ; 3150		/* No drive prefix is found */
                           A  9126    ; 3151	#if FF_FS_RPATH != 0
                           A  9127    ; 3152		vol = CurrVol;	/* Default drive is
                           A  9128    .LINE 3152
                           A  9129    
042AAF 3A CB 4F 04         A  9130    	LD	A,(_CurrVol)
042AB3 B7ED62              A  9131    	UEXT	HL
042AB6 6F                  A  9132    	LD	L,A
042AB7 DD2FF3              A  9133    	LD	(IX+%FFFFFFF3),HL
                           A  9134    ; 3153	#else
                           A  9135    ; 3154		vol = 0;		/* Default drive is
                           A  9136    ; 3155	#endif
                           A  9137    ; 3156		return vol;		/* Return the defau
                           A  9138    .LINE 3156
                           A  9139    
042ABA 3A CB 4F 04         A  9140    	LD	A,(_CurrVol)
042ABE B7ED62              A  9141    	UEXT	HL
042AC1 6F                  A  9142    	LD	L,A
                           A  9143    ; 3157	}
042AC2                     A  9144    L_418:
                           A  9145    .LINE 3157
                           A  9146    
042AC2 DDF9                A  9147    	LD	SP,IX
042AC4 DDE1                A  9148    	POP	IX
042AC6 C9                  A  9149    	RET	
                           A  9150    
                           A  9151    
                           A  9152    ;**************************** _get_ldnumber ***
                           A  9153    ;Name                         Addr/Register   S
                           A  9154    ;_CurrVol                            STATIC    
                           A  9155    ;vol                                  IX-13    
                           A  9156    ;i                                    IX-10    
                           A  9157    ;tc                                    IX-7    
                           A  9158    ;tt                                    IX-6    
                           A  9159    ;tp                                    IX-3    
                           A  9160    ;path                                  IX+6    
                           A  9161    
                           A  9162    
                           A  9163    ; Stack Frame Size: 25 (bytes)
                           A  9164    ;       Spill Code: 0 (instruction)
                           A  9165    
                           A  9166    
                           A  9167    .ENDFUNC "get_ldnumber",3157,"_get_ldnumber"
                           A  9168    ; 3158	
                           A  9169    ; 3159	
                           A  9170    ; 3160	
                           A  9171    ; 3161	
                           A  9172    ; 3162	/*-------------------------------------
                           A  9173    ; 3163	/* GPT support functions               
                           A  9174    ; 3164	/*-------------------------------------
                           A  9175    ; 3165	
                           A  9176    ; 3166	#if FF_LBA64
                           A  9177    ; 3167	
                           A  9178    ; 3168	/* Calculate CRC32 in byte-by-byte */
                           A  9179    ; 3169	
                           A  9180    ; 3170	static DWORD crc32 (	/* Returns next
                           A  9181    ; 3171		DWORD crc,			/* Current CRC 
                           A  9182    ; 3172		BYTE d				/* A byte to be
                           A  9183    ; 3173	)
                           A  9184    ; 3174	{
                           A  9185    ; 3175		BYTE b;
                           A  9186    ; 3176	
                           A  9187    ; 3177	
                           A  9188    ; 3178		for (b = 1; b; b <<= 1) {
                           A  9189    ; 3179			crc ^= (d & b) ? 1 : 0;
                           A  9190    ; 3180			crc = (crc & 1) ? crc >> 1 ^ 0x
                           A  9191    ; 3181		}
                           A  9192    ; 3182		return crc;
                           A  9193    ; 3183	}
                           A  9194    ; 3184	
                           A  9195    ; 3185	
                           A  9196    ; 3186	/* Check validity of GPT header */
                           A  9197    ; 3187	
                           A  9198    ; 3188	static int test_gpt_header (	/* 0:In
                           A  9199    ; 3189		const BYTE* gpth			/* Poin
                           A  9200    ; 3190	)
                           A  9201    ; 3191	{
                           A  9202    ; 3192		UINT i;
                           A  9203    ; 3193		DWORD bcc;
                           A  9204    ; 3194	
                           A  9205    ; 3195	
                           A  9206    ; 3196		if (memcmp(gpth + GPTH_Sign, "EFI P
                           A  9207    ; 3197		for (i = 0, bcc = 0xFFFFFFFF; i < 9
                           A  9208    ; 3198			bcc = crc32(bcc, i - GPTH_Bcc <
                           A  9209    ; 3199		}
                           A  9210    ; 3200		if (~bcc != ld_dword(gpth + GPTH_Bc
                           A  9211    ; 3201		if (ld_dword(gpth + GPTH_PteSize) !
                           A  9212    ; 3202		if (ld_dword(gpth + GPTH_PtNum) > 1
                           A  9213    ; 3203	
                           A  9214    ; 3204		return 1;
                           A  9215    ; 3205	}
                           A  9216    ; 3206	
                           A  9217    ; 3207	#if !FF_FS_READONLY && FF_USE_MKFS
                           A  9218    ; 3208	
                           A  9219    ; 3209	/* Generate random value */
                           A  9220    ; 3210	static DWORD make_rand (
                           A  9221    ; 3211		DWORD seed,		/* Seed value */
                           A  9222    ; 3212		BYTE* buff,		/* Output buffer */
                           A  9223    ; 3213		UINT n			/* Data length */
                           A  9224    ; 3214	)
                           A  9225    ; 3215	{
                           A  9226    ; 3216		UINT r;
                           A  9227    ; 3217	
                           A  9228    ; 3218	
                           A  9229    ; 3219		if (seed == 0) seed = 1;
                           A  9230    ; 3220		do {
                           A  9231    ; 3221			for (r = 0; r < 8; r++) seed = 
                           A  9232    ; 3222			*buff++ = (BYTE)seed;
                           A  9233    ; 3223		} while (--n);
                           A  9234    ; 3224		return seed;
                           A  9235    ; 3225	}
                           A  9236    ; 3226	
                           A  9237    ; 3227	#endif
                           A  9238    ; 3228	#endif
                           A  9239    ; 3229	
                           A  9240    ; 3230	
                           A  9241    ; 3231	
                           A  9242    ; 3232	/*-------------------------------------
                           A  9243    ; 3233	/* Load a sector and check if it is an 
                           A  9244    ; 3234	/*-------------------------------------
                           A  9245    ; 3235	
                           A  9246    ; 3236	/* Check what the sector is */
                           A  9247    ; 3237	
                           A  9248    ; 3238	static UINT check_fs (	/* 0:FAT/FAT32 
                           A  9249    ; 3239		FATFS* fs,			/* Filesystem o
                           A  9250    ; 3240		LBA_t sect			/* Sector to lo
                           A  9251    ; 3241	)
                           A  9252    ; 3242	{
042AC7                     A  9253    _check_fs:
                           A  9254    .DEFINE "_check_fs"
                           A  9255    
                           A  9256    .VALUE _check_fs
                           A  9257    
                           A  9258    .CLASS 3
                           A  9259    
                           A  9260    .TYPE 78
                           A  9261    
                           A  9262    .ENDEF
                           A  9263    
                           A  9264    .BEGFUNC "check_fs",3242,"_check_fs"
                           A  9265    
                           A  9266    .LINE 3242
                           A  9267    
                           A  9268    .DEFINE "fs"
                           A  9269    
                           A  9270    .CLASS 65
                           A  9271    
                           A  9272    .VALUE 6
                           A  9273    
                           A  9274    .TAG "NONAME0"
                           A  9275    
                           A  9276    .TYPE 40
                           A  9277    
                           A  9278    .ENDEF
                           A  9279    
                           A  9280    .DEFINE "sect"
                           A  9281    
                           A  9282    .CLASS 65
                           A  9283    
                           A  9284    .VALUE 9
                           A  9285    
                           A  9286    .TYPE 15
                           A  9287    
                           A  9288    .ENDEF
                           A  9289    
                           A  9290    .DEFINE "b"
                           A  9291    
                           A  9292    .CLASS 65
                           A  9293    
                           A  9294    .VALUE -4
                           A  9295    
                           A  9296    .TYPE 12
                           A  9297    
                           A  9298    .ENDEF
                           A  9299    
                           A  9300    .DEFINE "w"
                           A  9301    
                           A  9302    .CLASS 65
                           A  9303    
                           A  9304    .VALUE -9
                           A  9305    
                           A  9306    .TYPE 13
                           A  9307    
                           A  9308    .ENDEF
                           A  9309    
                           A  9310    .DEFINE "sign"
                           A  9311    
                           A  9312    .CLASS 65
                           A  9313    
                           A  9314    .VALUE -11
                           A  9315    
                           A  9316    .TYPE 13
                           A  9317    
                           A  9318    .ENDEF
                           A  9319    
042AC7 DDE5                A  9320    	PUSH	IX
042AC9 DD210000 00         A  9321    	LD	IX,0
042ACE DD39                A  9322    	ADD	IX,SP
042AD0 ED22EC              A  9323    	LEA	HL,IX+%FFFFFFEC
042AD3 F9                  A  9324    	LD	SP,HL
                           A  9325    ; 3243		WORD w, sign;
                           A  9326    ; 3244		BYTE b;
                           A  9327    ; 3245	
                           A  9328    ; 3246	
                           A  9329    ; 3247		fs->wflag = 0; fs->winsect = (LBA_t
                           A  9330    .LINE 3247
                           A  9331    
042AD4 DD3106              A  9332    	LD	IY,(IX+%6)
042AD7 FD360300            A  9333    	LD	(IY+%3),%0
042ADB 01FFFFFF            A  9334    	LD	BC,16777215
042ADF FD0F2A              A  9335    	LD	(IY+%2A),BC
042AE2 FD362DFF            A  9336    	LD	(IY+%2D),%FF
                           A  9337    ; 3248		if (move_window(fs, sect) != FR_OK)
                           A  9338    .LINE 3248
                           A  9339    
042AE6 DD4E0C              A  9340    	LD	C,(IX+%C)
042AE9 0600                A  9341    	LD	B,%0
042AEB C5                  A  9342    	PUSH	BC
042AEC DD0709              A  9343    	LD	BC,(IX+%9)
042AEF C5                  A  9344    	PUSH	BC
042AF0 DD0706              A  9345    	LD	BC,(IX+%6)
042AF3 C5                  A  9346    	PUSH	BC
042AF4 CD 82 11 04         A  9347    	CALL	_move_window
042AF8 C1                  A  9348    	POP	BC
042AF9 C1                  A  9349    	POP	BC
042AFA C1                  A  9350    	POP	BC
042AFB CD E5 46 04         A  9351    	CALL	__icmpzero
042AFF 28 08               A  9352    	JR	Z,L_420
042B01 21040000            A  9353    	LD	HL,4
042B05 C3 9F 2C 04         A  9354    	JR	L_443
042B09                     A  9355    L_420:
                           A  9356    ; 3249		sign = ld_word(fs->win + BS_55AA);
                           A  9357    .LINE 3249
                           A  9358    
042B09 DD3106              A  9359    	LD	IY,(IX+%6)
042B0C ED032E              A  9360    	LEA	BC,IY+%2E
042B0F DD0FF9              A  9361    	LD	(IX+%FFFFFFF9),BC
042B12 DD0FEF              A  9362    	LD	(IX+%FFFFFFEF),BC
042B15 01FE0100            A  9363    	LD	BC,510
042B19 DD27F9              A  9364    	LD	HL,(IX+%FFFFFFF9)
042B1C 09                  A  9365    	ADD	HL,BC
042B1D E5                  A  9366    	PUSH	HL
042B1E CD 25 0F 04         A  9367    	CALL	_ld_word
042B22 C1                  A  9368    	POP	BC
042B23 DD75F5              A  9369    	LD	(IX+%FFFFFFF5),L
042B26 DD74F6              A  9370    	LD	(IX+%FFFFFFF6),H
                           A  9371    ; 3250	#if FF_FS_EXFAT
                           A  9372    ; 3251		if (sign == 0xAA55 && !memcmp(fs->w
                           A  9373    ; 3252	#endif
                           A  9374    ; 3253		b = fs->win[BS_JmpBoot];
                           A  9375    .LINE 3253
                           A  9376    
042B29 DD27F9              A  9377    	LD	HL,(IX+%FFFFFFF9)
042B2C 7E                  A  9378    	LD	A,(HL)
042B2D DD77FC              A  9379    	LD	(IX+%FFFFFFFC),A
                           A  9380    ; 3254		if (b == 0xEB || b == 0xE9 || b == 
                           A  9381    .LINE 3254
                           A  9382    
042B30 FEEB                A  9383    	CP	A,%EB
042B32 28 10               A  9384    	JR	Z,L_437
042B34 DD7EFC              A  9385    	LD	A,(IX+%FFFFFFFC)
042B37 FEE9                A  9386    	CP	A,%E9
042B39 28 09               A  9387    	JR	Z,L_437
042B3B DD7EFC              A  9388    	LD	A,(IX+%FFFFFFFC)
042B3E FEE8                A  9389    	CP	A,%E8
042B40 C2 7F 2C 04         A  9390    	JR	NZ,L_442
042B44                     A  9391    L_437:
                           A  9392    ; 3255			if (sign == 0xAA55 && !memcmp(f
                           A  9393    .LINE 3255
                           A  9394    
042B44 490155AA            A  9395    	LD.LIS	BC,43605
042B48 DD27F5              A  9396    	LD	HL,(IX+%FFFFFFF5)
042B4B B7                  A  9397    	OR	A,A
042B4C 40ED42              A  9398    	SBC.SIS	HL,BC
042B4F 20 2B               A  9399    	JR	NZ,L_425
042B51 DD07F9              A  9400    	LD	BC,(IX+%FFFFFFF9)
042B54 DD0FEF              A  9401    	LD	(IX+%FFFFFFEF),BC
042B57 01080000            A  9402    	LD	BC,8
042B5B C5                  A  9403    	PUSH	BC
042B5C 01 8F 4D 04         A  9404    	LD	BC,L__220
042B60 C5                  A  9405    	PUSH	BC
042B61 DD31F9              A  9406    	LD	IY,(IX+%FFFFFFF9)
042B64 ED0352              A  9407    	LEA	BC,IY+%52
042B67 C5                  A  9408    	PUSH	BC
042B68 CD A9 46 04         A  9409    	CALL	_memcmp
042B6C C1                  A  9410    	POP	BC
042B6D C1                  A  9411    	POP	BC
042B6E C1                  A  9412    	POP	BC
042B6F CD E5 46 04         A  9413    	CALL	__icmpzero
042B73 20 07               A  9414    	JR	NZ,L_425
                           A  9415    ; 3256				return 0;	/* It is an FAT
                           A  9416    .LINE 3256
                           A  9417    
042B75 B7                  A  9418    	OR	A,A
042B76 ED62                A  9419    	SBC	HL,HL
042B78 C3 9F 2C 04         A  9420    	JR	L_443
                           A  9421    ; 3257			}
042B7C                     A  9422    L_425:
                           A  9423    .LINE 3257
                           A  9424    
                           A  9425    ; 3258			/* FAT volumes formatted with e
                           A  9426    ; 3259			w = ld_word(fs->win + BPB_BytsP
                           A  9427    .LINE 3259
                           A  9428    
042B7C DD07EF              A  9429    	LD	BC,(IX+%FFFFFFEF)
042B7F DD0FFD              A  9430    	LD	(IX+%FFFFFFFD),BC
042B82 DD31FD              A  9431    	LD	IY,(IX+%FFFFFFFD)
042B85 ED030B              A  9432    	LEA	BC,IY+%B
042B88 C5                  A  9433    	PUSH	BC
042B89 CD 25 0F 04         A  9434    	CALL	_ld_word
042B8D C1                  A  9435    	POP	BC
042B8E DD75F7              A  9436    	LD	(IX+%FFFFFFF7),L
042B91 DD74F8              A  9437    	LD	(IX+%FFFFFFF8),H
                           A  9438    ; 3260			b = fs->win[BPB_SecPerClus];
                           A  9439    .LINE 3260
                           A  9440    
042B94 DD31FD              A  9441    	LD	IY,(IX+%FFFFFFFD)
042B97 ED230D              A  9442    	LEA	HL,IY+%D
042B9A 7E                  A  9443    	LD	A,(HL)
042B9B DD77FC              A  9444    	LD	(IX+%FFFFFFFC),A
                           A  9445    ; 3261			if ((w & (w - 1)) == 0 && w >= 
                           A  9446    .LINE 3261
                           A  9447    
042B9E DD07F7              A  9448    	LD	BC,(IX+%FFFFFFF7)
042BA1 CD 73 45 04         A  9449    	CALL	__stoiu
042BA5 2B                  A  9450    	DEC	HL
042BA6 DD07F7              A  9451    	LD	BC,(IX+%FFFFFFF7)
042BA9 CD DC 46 04         A  9452    	CALL	__sand
042BAD CD D8 47 04         A  9453    	CALL	__scmpzero
042BB1 C2 7F 2C 04         A  9454    	JR	NZ,L_442
042BB5 49010002            A  9455    	LD.LIS	BC,512
042BB9 DD27F7              A  9456    	LD	HL,(IX+%FFFFFFF7)
042BBC B7                  A  9457    	OR	A,A
042BBD 40ED42              A  9458    	SBC.SIS	HL,BC
042BC0 DA 7F 2C 04         A  9459    	JR	C,L_442
                           A  9460    ; 3262				&& b != 0 && (b & (b - 1)) 
                           A  9461    .LINE 3262
                           A  9462    
042BC4 DD07F7              A  9463    	LD	BC,(IX+%FFFFFFF7)
042BC7 49210002            A  9464    	LD.LIS	HL,512
042BCB B7                  A  9465    	OR	A,A
042BCC 40ED42              A  9466    	SBC.SIS	HL,BC
042BCF DA 7F 2C 04         A  9467    	JR	C,L_442
042BD3 DD7EFC              A  9468    	LD	A,(IX+%FFFFFFFC)
042BD6 B7                  A  9469    	OR	A,A
042BD7 CA 7F 2C 04         A  9470    	JR	Z,L_442
                           A  9471    ; 3263				&& ld_word(fs->win + BPB_Rs
                           A  9472    .LINE 3263
                           A  9473    
042BDB DD7EFC              A  9474    	LD	A,(IX+%FFFFFFFC)
042BDE B7ED62              A  9475    	UEXT	HL
042BE1 6F                  A  9476    	LD	L,A
042BE2 2B                  A  9477    	DEC	HL
042BE3 7D                  A  9478    	LD	A,L
042BE4 DDA6FC              A  9479    	AND	A,(IX+%FFFFFFFC)
042BE7 C2 7F 2C 04         A  9480    	JR	NZ,L_442
                           A  9481    ; 3264				&& (UINT)fs->win[BPB_NumFAT
                           A  9482    .LINE 3264
                           A  9483    
042BEB DD31FD              A  9484    	LD	IY,(IX+%FFFFFFFD)
042BEE ED030E              A  9485    	LEA	BC,IY+%E
042BF1 C5                  A  9486    	PUSH	BC
042BF2 CD 25 0F 04         A  9487    	CALL	_ld_word
042BF6 C1                  A  9488    	POP	BC
042BF7 CD D8 47 04         A  9489    	CALL	__scmpzero
042BFB CA 7F 2C 04         A  9490    	JR	Z,L_442
                           A  9491    ; 3265				&& ld_word(fs->win + BPB_Ro
                           A  9492    .LINE 3265
                           A  9493    
042BFF DD31FD              A  9494    	LD	IY,(IX+%FFFFFFFD)
042C02 ED2310              A  9495    	LEA	HL,IY+%10
042C05 7E                  A  9496    	LD	A,(HL)
042C06 B7ED62              A  9497    	UEXT	HL
042C09 6F                  A  9498    	LD	L,A
042C0A E5C1                A  9499    	LD	BC,HL
042C0C 0B                  A  9500    	DEC	BC
042C0D 21010000            A  9501    	LD	HL,1
042C11 B7                  A  9502    	OR	A,A
042C12 ED42                A  9503    	SBC	HL,BC
042C14 38 69               A  9504    	JR	C,L_442
                           A  9505    ; 3266				&& (ld_word(fs->win + BPB_T
                           A  9506    .LINE 3266
                           A  9507    
042C16 DD31FD              A  9508    	LD	IY,(IX+%FFFFFFFD)
042C19 ED0311              A  9509    	LEA	BC,IY+%11
042C1C C5                  A  9510    	PUSH	BC
042C1D CD 25 0F 04         A  9511    	CALL	_ld_word
042C21 C1                  A  9512    	POP	BC
042C22 CD D8 47 04         A  9513    	CALL	__scmpzero
042C26 28 57               A  9514    	JR	Z,L_442
042C28 DD07FD              A  9515    	LD	BC,(IX+%FFFFFFFD)
042C2B DD0FEC              A  9516    	LD	(IX+%FFFFFFEC),BC
042C2E DD31FD              A  9517    	LD	IY,(IX+%FFFFFFFD)
042C31 ED0313              A  9518    	LEA	BC,IY+%13
042C34 C5                  A  9519    	PUSH	BC
042C35 CD 25 0F 04         A  9520    	CALL	_ld_word
042C39 C1                  A  9521    	POP	BC
042C3A E5C1                A  9522    	LD	BC,HL
042C3C CD 73 45 04         A  9523    	CALL	__stoiu
042C40 01800000            A  9524    	LD	BC,128
042C44 B7                  A  9525    	OR	A,A
042C45 ED42                A  9526    	SBC	HL,BC
042C47 F2 68 2C 04         A  9527    	JP	P,L_435
042C4B DD07FD              A  9528    	LD	BC,(IX+%FFFFFFFD)
042C4E DD0FEC              A  9529    	LD	(IX+%FFFFFFEC),BC
042C51 DD31FD              A  9530    	LD	IY,(IX+%FFFFFFFD)
042C54 ED0320              A  9531    	LEA	BC,IY+%20
042C57 C5                  A  9532    	PUSH	BC
042C58 CD 61 0F 04         A  9533    	CALL	_ld_dword
042C5C C1                  A  9534    	POP	BC
042C5D 01000001            A  9535    	LD	BC,65536
042C61 AF                  A  9536    	XOR	A,A
042C62 CD 88 47 04         A  9537    	CALL	__lcmpu
042C66 38 17               A  9538    	JR	C,L_442
                           A  9539    ; 3267				&& ld_word(fs->win + BPB_FA
042C68                     A  9540    L_435:
                           A  9541    .LINE 3267
                           A  9542    
042C68 DD31EC              A  9543    	LD	IY,(IX+%FFFFFFEC)
042C6B ED0316              A  9544    	LEA	BC,IY+%16
042C6E C5                  A  9545    	PUSH	BC
042C6F CD 25 0F 04         A  9546    	CALL	_ld_word
042C73 C1                  A  9547    	POP	BC
042C74 CD D8 47 04         A  9548    	CALL	__scmpzero
042C78 28 05               A  9549    	JR	Z,L_442
                           A  9550    ; 3268					return 0;	/* It can b
                           A  9551    .LINE 3268
                           A  9552    
042C7A B7                  A  9553    	OR	A,A
042C7B ED62                A  9554    	SBC	HL,HL
042C7D 18 20               A  9555    	JR	L_443
                           A  9556    ; 3269			}
                           A  9557    ; 3270		}
042C7F                     A  9558    L_442:
                           A  9559    .LINE 3270
                           A  9560    
                           A  9561    ; 3271		return sign == 0xAA55 ? 2 : 3;	/* 
                           A  9562    .LINE 3271
                           A  9563    
042C7F 490155AA            A  9564    	LD.LIS	BC,43605
042C83 DD27F5              A  9565    	LD	HL,(IX+%FFFFFFF5)
042C86 B7                  A  9566    	OR	A,A
042C87 40ED42              A  9567    	SBC.SIS	HL,BC
042C8A 20 09               A  9568    	JR	NZ,L_440
042C8C 01020000            A  9569    	LD	BC,2
042C90 DD0FF2              A  9570    	LD	(IX+%FFFFFFF2),BC
042C93 18 07               A  9571    	JR	L_441
042C95                     A  9572    L_440:
042C95 01030000            A  9573    	LD	BC,3
042C99 DD0FF2              A  9574    	LD	(IX+%FFFFFFF2),BC
042C9C                     A  9575    L_441:
042C9C DD27F2              A  9576    	LD	HL,(IX+%FFFFFFF2)
                           A  9577    ; 3272	}
042C9F                     A  9578    L_443:
                           A  9579    .LINE 3272
                           A  9580    
042C9F DDF9                A  9581    	LD	SP,IX
042CA1 DDE1                A  9582    	POP	IX
042CA3 C9                  A  9583    	RET	
                           A  9584    
                           A  9585    
                           A  9586    ;**************************** _check_fs *******
                           A  9587    ;Name                         Addr/Register   S
                           A  9588    ;_memcmp                             IMPORT  --
                           A  9589    ;G_31                                 IX-20    
                           A  9590    ;G_25                                 IX-17    
                           A  9591    ;temp438                              IX-14    
                           A  9592    ;sign                                 IX-11    
                           A  9593    ;w                                     IX-9    
                           A  9594    ;G_24                                  IX-7    
                           A  9595    ;b                                     IX-4    
                           A  9596    ;G_26                                  IX-3    
                           A  9597    ;sect                                  IX+9    
                           A  9598    ;fs                                    IX+6    
                           A  9599    
                           A  9600    
                           A  9601    ; Stack Frame Size: 35 (bytes)
                           A  9602    ;       Spill Code: 0 (instruction)
                           A  9603    
                           A  9604    
                           A  9605    .ENDFUNC "check_fs",3272,"_check_fs"
                           A  9606    	SEGMENT STRSECT
044D8F                     A  9607    L__220:
044D8F 46415433 32202020   A  9608    	DB	"FAT32   "
044D97 00                  A  9609    	DB	0
                           A  9610    	SEGMENT CODE
                           A  9611    ; 3273	
                           A  9612    ; 3274	
                           A  9613    ; 3275	/* Find an FAT volume */
                           A  9614    ; 3276	/* (It supports only generic partitioni
                           A  9615    ; 3277	
                           A  9616    ; 3278	static UINT find_volume (	/* Returns 
                           A  9617    ; 3279		FATFS* fs,		/* Filesystem objec
                           A  9618    ; 3280		UINT part		/* Partition to fin
                           A  9619    ; 3281	)
                           A  9620    ; 3282	{
042CA4                     A  9621    _find_volume:
                           A  9622    .DEFINE "_find_volume"
                           A  9623    
                           A  9624    .VALUE _find_volume
                           A  9625    
                           A  9626    .CLASS 3
                           A  9627    
                           A  9628    .TYPE 78
                           A  9629    
                           A  9630    .ENDEF
                           A  9631    
                           A  9632    .BEGFUNC "find_volume",3282,"_find_volume"
                           A  9633    
                           A  9634    .LINE 3282
                           A  9635    
                           A  9636    .DEFINE "fs"
                           A  9637    
                           A  9638    .CLASS 65
                           A  9639    
                           A  9640    .VALUE 6
                           A  9641    
                           A  9642    .TAG "NONAME0"
                           A  9643    
                           A  9644    .TYPE 40
                           A  9645    
                           A  9646    .ENDEF
                           A  9647    
                           A  9648    .DEFINE "part"
                           A  9649    
                           A  9650    .CLASS 65
                           A  9651    
                           A  9652    .VALUE 9
                           A  9653    
                           A  9654    .TYPE 14
                           A  9655    
                           A  9656    .ENDEF
                           A  9657    
                           A  9658    .DEFINE "i"
                           A  9659    
                           A  9660    .CLASS 65
                           A  9661    
                           A  9662    .VALUE -3
                           A  9663    
                           A  9664    .TYPE 14
                           A  9665    
                           A  9666    .ENDEF
                           A  9667    
                           A  9668    .DEFINE "fmt"
                           A  9669    
                           A  9670    .CLASS 65
                           A  9671    
                           A  9672    .VALUE -6
                           A  9673    
                           A  9674    .TYPE 14
                           A  9675    
                           A  9676    .ENDEF
                           A  9677    
                           A  9678    .DEFINE "mbr_pt"
                           A  9679    
                           A  9680    .CLASS 65
                           A  9681    
                           A  9682    .VALUE -31
                           A  9683    
                           A  9684    .DIM 4
                           A  9685    
                           A  9686    .TYPE 111
                           A  9687    
                           A  9688    .ENDEF
                           A  9689    
042CA4 DDE5                A  9690    	PUSH	IX
042CA6 DD210000 00         A  9691    	LD	IX,0
042CAB DD39                A  9692    	ADD	IX,SP
042CAD ED22DB              A  9693    	LEA	HL,IX+%FFFFFFDB
042CB0 F9                  A  9694    	LD	SP,HL
                           A  9695    ; 3283		UINT fmt, i;
                           A  9696    ; 3284		DWORD mbr_pt[4];
                           A  9697    ; 3285	
                           A  9698    ; 3286	
                           A  9699    ; 3287		fmt = check_fs(fs, 0);				
                           A  9700    .LINE 3287
                           A  9701    
042CB1 01000000            A  9702    	LD	BC,0
042CB5 C5                  A  9703    	PUSH	BC
042CB6 C5                  A  9704    	PUSH	BC
042CB7 DD0706              A  9705    	LD	BC,(IX+%6)
042CBA C5                  A  9706    	PUSH	BC
042CBB CD C7 2A 04         A  9707    	CALL	_check_fs
042CBF C1                  A  9708    	POP	BC
042CC0 C1                  A  9709    	POP	BC
042CC1 C1                  A  9710    	POP	BC
042CC2 DD2FFA              A  9711    	LD	(IX+%FFFFFFFA),HL
                           A  9712    ; 3288		if (fmt != 2 && (fmt >= 3 || part =
                           A  9713    .LINE 3288
                           A  9714    
042CC5 01020000            A  9715    	LD	BC,2
042CC9 DD27FA              A  9716    	LD	HL,(IX+%FFFFFFFA)
042CCC B7                  A  9717    	OR	A,A
042CCD ED42                A  9718    	SBC	HL,BC
042CCF 28 1C               A  9719    	JR	Z,L_453
042CD1 01030000            A  9720    	LD	BC,3
042CD5 DD27FA              A  9721    	LD	HL,(IX+%FFFFFFFA)
042CD8 B7                  A  9722    	OR	A,A
042CD9 ED42                A  9723    	SBC	HL,BC
042CDB 30 09               A  9724    	JR	NC,L_446
042CDD DD2709              A  9725    	LD	HL,(IX+%9)
042CE0 CD E5 46 04         A  9726    	CALL	__icmpzero
042CE4 20 07               A  9727    	JR	NZ,L_453
042CE6                     A  9728    L_446:
042CE6 DD27FA              A  9729    	LD	HL,(IX+%FFFFFFFA)
042CE9 C3 E4 2D 04         A  9730    	JR	L_468
                           A  9731    ; 3289	
                           A  9732    ; 3290		/* Sector 0 is not an FAT VBR or fo
                           A  9733    ; 3291	
                           A  9734    ; 3292	#if FF_LBA64
                           A  9735    ; 3293		if (fs->win[MBR_Table + PTE_System]
                           A  9736    ; 3294			DWORD n_ent, v_ent, ofs;
                           A  9737    ; 3295			QWORD pt_lba;
                           A  9738    ; 3296	
                           A  9739    ; 3297			if (move_window(fs, 1) != FR_OK
                           A  9740    ; 3298			if (!test_gpt_header(fs->win)) 
                           A  9741    ; 3299			n_ent = ld_dword(fs->win + GPTH
                           A  9742    ; 3300			pt_lba = ld_qword(fs->win + GPT
                           A  9743    ; 3301			for (v_ent = i = 0; i < n_ent; 
                           A  9744    ; 3302				if (move_window(fs, pt_lba 
                           A  9745    ; 3303				ofs = i * SZ_GPTE % SS(fs);
                           A  9746    ; 3304				if (!memcmp(fs->win + ofs +
                           A  9747    ; 3305					v_ent++;
                           A  9748    ; 3306					fmt = check_fs(fs, ld_q
                           A  9749    ; 3307					if (part == 0 && fmt <=
                           A  9750    ; 3308					if (part != 0 && v_ent 
                           A  9751    ; 3309				}
                           A  9752    ; 3310			}
                           A  9753    ; 3311			return 3;	/* Not found */
                           A  9754    ; 3312		}
                           A  9755    ; 3313	#endif
                           A  9756    ; 3314		if (FF_MULTI_PARTITION && part > 4)
042CED                     A  9757    L_453:
                           A  9758    .LINE 3314
                           A  9759    
                           A  9760    ; 3315		for (i = 0; i < 4; i++) {		/* 
                           A  9761    .LINE 3315
                           A  9762    
042CED 01000000            A  9763    	LD	BC,0
042CF1 DD0FFD              A  9764    	LD	(IX+%FFFFFFFD),BC
042CF4 18 4E               A  9765    	JR	L_452
042CF6                     A  9766    L_450:
                           A  9767    ; 3316			mbr_pt[i] = ld_dword(fs->win + 
                           A  9768    .LINE 3316
                           A  9769    
042CF6 01BE0100            A  9770    	LD	BC,446
042CFA DD3106              A  9771    	LD	IY,(IX+%6)
042CFD ED232E              A  9772    	LEA	HL,IY+%2E
042D00 09                  A  9773    	ADD	HL,BC
042D01 E5C1                A  9774    	LD	BC,HL
042D03 DD27FD              A  9775    	LD	HL,(IX+%FFFFFFFD)
042D06 29                  A  9776    	ADD	HL,HL
042D07 29                  A  9777    	ADD	HL,HL
042D08 29                  A  9778    	ADD	HL,HL
042D09 29                  A  9779    	ADD	HL,HL
042D0A 09                  A  9780    	ADD	HL,BC
042D0B E5FDE1              A  9781    	LD	IY,HL
042D0E ED0308              A  9782    	LEA	BC,IY+%8
042D11 C5                  A  9783    	PUSH	BC
042D12 CD 61 0F 04         A  9784    	CALL	_ld_dword
042D16 C1                  A  9785    	POP	BC
042D17 E5C1                A  9786    	LD	BC,HL
042D19 DD27FD              A  9787    	LD	HL,(IX+%FFFFFFFD)
042D1C 29                  A  9788    	ADD	HL,HL
042D1D 29                  A  9789    	ADD	HL,HL
042D1E DD0FDE              A  9790    	LD	(IX+%FFFFFFDE),BC	; spill
042D21 ED02E1              A  9791    	LEA	BC,IX+%FFFFFFE1
042D24 DD0FDB              A  9792    	LD	(IX+%FFFFFFDB),BC	; spill
042D27 DD07DE              A  9793    	LD	BC,(IX+%FFFFFFDE)	; unspill
042D2A DD0FDE              A  9794    	LD	(IX+%FFFFFFDE),BC	; spill
042D2D DD07DB              A  9795    	LD	BC,(IX+%FFFFFFDB)	; unspill
042D30 09                  A  9796    	ADD	HL,BC
042D31 DD07DE              A  9797    	LD	BC,(IX+%FFFFFFDE)	; unspill
042D34 E5FDE1              A  9798    	LD	IY,HL
042D37 FD0F00              A  9799    	LD	(IY),BC
042D3A FD7303              A  9800    	LD	(IY+%3),E
042D3D DD07FD              A  9801    	LD	BC,(IX+%FFFFFFFD)
042D40 03                  A  9802    	INC	BC
042D41 DD0FFD              A  9803    	LD	(IX+%FFFFFFFD),BC
                           A  9804    ; 3317		}
042D44                     A  9805    L_452:
                           A  9806    .LINE 3317
                           A  9807    
042D44 01040000            A  9808    	LD	BC,4
042D48 DD27FD              A  9809    	LD	HL,(IX+%FFFFFFFD)
042D4B B7                  A  9810    	OR	A,A
042D4C ED42                A  9811    	SBC	HL,BC
042D4E 38 A6               A  9812    	JR	C,L_450
                           A  9813    ; 3318		i = part ? part - 1 : 0;		/* 
                           A  9814    .LINE 3318
                           A  9815    
042D50 DD2709              A  9816    	LD	HL,(IX+%9)
042D53 CD E5 46 04         A  9817    	CALL	__icmpzero
042D57 28 0B               A  9818    	JR	Z,L_456
042D59 DD3109              A  9819    	LD	IY,(IX+%9)
042D5C ED33FF              A  9820    	LEA	IY,IY+%FFFFFFFF
042D5F DD3EF7              A  9821    	LD	(IX+%FFFFFFF7),IY
042D62 18 07               A  9822    	JR	L_457
042D64                     A  9823    L_456:
042D64 01000000            A  9824    	LD	BC,0
042D68 DD0FF7              A  9825    	LD	(IX+%FFFFFFF7),BC
042D6B                     A  9826    L_457:
042D6B DD07F7              A  9827    	LD	BC,(IX+%FFFFFFF7)
042D6E DD0FFD              A  9828    	LD	(IX+%FFFFFFFD),BC
                           A  9829    ; 3319		do {							/* 
042D71                     A  9830    L_465:
                           A  9831    .LINE 3319
                           A  9832    
                           A  9833    ; 3320			fmt = mbr_pt[i] ? check_fs(fs, 
                           A  9834    .LINE 3320
                           A  9835    
042D71 DD27FD              A  9836    	LD	HL,(IX+%FFFFFFFD)
042D74 29                  A  9837    	ADD	HL,HL
042D75 29                  A  9838    	ADD	HL,HL
042D76 E5C1                A  9839    	LD	BC,HL
042D78 ED22E1              A  9840    	LEA	HL,IX+%FFFFFFE1
042D7B 09                  A  9841    	ADD	HL,BC
042D7C DD2FF1              A  9842    	LD	(IX+%FFFFFFF1),HL
042D7F DD31F1              A  9843    	LD	IY,(IX+%FFFFFFF1)
042D82 FD2700              A  9844    	LD	HL,(IY)
042D85 FD5E03              A  9845    	LD	E,(IY+%3)
042D88 CD B8 45 04         A  9846    	CALL	__lcmpzero
042D8C 28 1E               A  9847    	JR	Z,L_461
042D8E DD31F1              A  9848    	LD	IY,(IX+%FFFFFFF1)
042D91 FD0700              A  9849    	LD	BC,(IY)
042D94 FD7E03              A  9850    	LD	A,(IY+%3)
042D97 2600                A  9851    	LD	H,%0
042D99 6F                  A  9852    	LD	L,A
042D9A E5                  A  9853    	PUSH	HL
042D9B C5                  A  9854    	PUSH	BC
042D9C DD0706              A  9855    	LD	BC,(IX+%6)
042D9F C5                  A  9856    	PUSH	BC
042DA0 CD C7 2A 04         A  9857    	CALL	_check_fs
042DA4 C1                  A  9858    	POP	BC
042DA5 C1                  A  9859    	POP	BC
042DA6 C1                  A  9860    	POP	BC
042DA7 DD2FF4              A  9861    	LD	(IX+%FFFFFFF4),HL
042DAA 18 07               A  9862    	JR	L_462
042DAC                     A  9863    L_461:
042DAC 01030000            A  9864    	LD	BC,3
042DB0 DD0FF4              A  9865    	LD	(IX+%FFFFFFF4),BC
042DB3                     A  9866    L_462:
042DB3 DD07F4              A  9867    	LD	BC,(IX+%FFFFFFF4)
042DB6 DD0FFA              A  9868    	LD	(IX+%FFFFFFFA),BC
                           A  9869    ; 3321		} while (part == 0 && fmt >= 2 && +
                           A  9870    .LINE 3321
                           A  9871    
042DB9 DD2709              A  9872    	LD	HL,(IX+%9)
042DBC CD E5 46 04         A  9873    	CALL	__icmpzero
042DC0 20 1F               A  9874    	JR	NZ,L_467
042DC2 01020000            A  9875    	LD	BC,2
042DC6 DD27FA              A  9876    	LD	HL,(IX+%FFFFFFFA)
042DC9 B7                  A  9877    	OR	A,A
042DCA ED42                A  9878    	SBC	HL,BC
042DCC 38 13               A  9879    	JR	C,L_467
042DCE DD07FD              A  9880    	LD	BC,(IX+%FFFFFFFD)
042DD1 03                  A  9881    	INC	BC
042DD2 DD0FFD              A  9882    	LD	(IX+%FFFFFFFD),BC
042DD5 01040000            A  9883    	LD	BC,4
042DD9 DD27FD              A  9884    	LD	HL,(IX+%FFFFFFFD)
042DDC B7                  A  9885    	OR	A,A
042DDD ED42                A  9886    	SBC	HL,BC
042DDF 38 90               A  9887    	JR	C,L_465
042DE1                     A  9888    L_467:
                           A  9889    ; 3322		return fmt;
                           A  9890    .LINE 3322
                           A  9891    
042DE1 DD27FA              A  9892    	LD	HL,(IX+%FFFFFFFA)
                           A  9893    ; 3323	}
042DE4                     A  9894    L_468:
                           A  9895    .LINE 3323
                           A  9896    
042DE4 DDF9                A  9897    	LD	SP,IX
042DE6 DDE1                A  9898    	POP	IX
042DE8 C9                  A  9899    	RET	
                           A  9900    
                           A  9901    
                           A  9902    ;**************************** _find_volume ****
                           A  9903    ;Name                         Addr/Register   S
                           A  9904    ;mbr_pt                               IX-31    
                           A  9905    ;G_32                                 IX-15    
                           A  9906    ;temp459                              IX-12    
                           A  9907    ;temp454                               IX-9    
                           A  9908    ;fmt                                   IX-6    
                           A  9909    ;i                                     IX-3    
                           A  9910    ;part                                  IX+9    
                           A  9911    ;fs                                    IX+6    
                           A  9912    
                           A  9913    
                           A  9914    ; Stack Frame Size: 49 (bytes)
                           A  9915    ;       Spill Code: 0 (instruction)
                           A  9916    
                           A  9917    
                           A  9918    .ENDFUNC "find_volume",3323,"_find_volume"
                           A  9919    ; 3324	
                           A  9920    ; 3325	
                           A  9921    ; 3326	
                           A  9922    ; 3327	
                           A  9923    ; 3328	/*-------------------------------------
                           A  9924    ; 3329	/* Determine logical drive number and m
                           A  9925    ; 3330	/*-------------------------------------
                           A  9926    ; 3331	
                           A  9927    ; 3332	static FRESULT mount_volume (	/* FR_O
                           A  9928    ; 3333		const TCHAR** path,			/* Poin
                           A  9929    ; 3334		FATFS** rfs,				/* Poin
                           A  9930    ; 3335		BYTE mode					/* !=0:
                           A  9931    ; 3336	)
                           A  9932    ; 3337	{
042DE9                     A  9933    _mount_volume:
                           A  9934    .DEFINE "_mount_volume"
                           A  9935    
                           A  9936    .VALUE _mount_volume
                           A  9937    
                           A  9938    .CLASS 3
                           A  9939    
                           A  9940    .TYPE 68
                           A  9941    
                           A  9942    .ENDEF
                           A  9943    
                           A  9944    .BEGFUNC "mount_volume",3337,"_mount_volume"
                           A  9945    
                           A  9946    .LINE 3337
                           A  9947    
                           A  9948    .DEFINE "path"
                           A  9949    
                           A  9950    .CLASS 65
                           A  9951    
                           A  9952    .VALUE 6
                           A  9953    
                           A  9954    .TYPE 1570
                           A  9955    
                           A  9956    .ENDEF
                           A  9957    
                           A  9958    .DEFINE "rfs"
                           A  9959    
                           A  9960    .CLASS 65
                           A  9961    
                           A  9962    .VALUE 9
                           A  9963    
                           A  9964    .TAG "NONAME0"
                           A  9965    
                           A  9966    .TYPE 296
                           A  9967    
                           A  9968    .ENDEF
                           A  9969    
                           A  9970    .DEFINE "mode"
                           A  9971    
                           A  9972    .CLASS 65
                           A  9973    
                           A  9974    .VALUE 12
                           A  9975    
                           A  9976    .TYPE 12
                           A  9977    
                           A  9978    .ENDEF
                           A  9979    
                           A  9980    .DEFINE "fs"
                           A  9981    
                           A  9982    .CLASS 65
                           A  9983    
                           A  9984    .VALUE -3
                           A  9985    
                           A  9986    .TAG "NONAME0"
                           A  9987    
                           A  9988    .TYPE 40
                           A  9989    
                           A  9990    .ENDEF
                           A  9991    
                           A  9992    .DEFINE "fmt"
                           A  9993    
                           A  9994    .CLASS 65
                           A  9995    
                           A  9996    .VALUE -6
                           A  9997    
                           A  9998    .TYPE 14
                           A  9999    
                           A 10000    .ENDEF
                           A 10001    
                           A 10002    .DEFINE "fasize"
                           A 10003    
                           A 10004    .CLASS 65
                           A 10005    
                           A 10006    .VALUE -10
                           A 10007    
                           A 10008    .TYPE 15
                           A 10009    
                           A 10010    .ENDEF
                           A 10011    
                           A 10012    .DEFINE "stat"
                           A 10013    
                           A 10014    .CLASS 65
                           A 10015    
                           A 10016    .VALUE -12
                           A 10017    
                           A 10018    .TYPE 12
                           A 10019    
                           A 10020    .ENDEF
                           A 10021    
                           A 10022    .DEFINE "nclst"
                           A 10023    
                           A 10024    .CLASS 65
                           A 10025    
                           A 10026    .VALUE -22
                           A 10027    
                           A 10028    .TYPE 15
                           A 10029    
                           A 10030    .ENDEF
                           A 10031    
                           A 10032    .DEFINE "nrsv"
                           A 10033    
                           A 10034    .CLASS 65
                           A 10035    
                           A 10036    .VALUE -24
                           A 10037    
                           A 10038    .TYPE 13
                           A 10039    
                           A 10040    .ENDEF
                           A 10041    
                           A 10042    .DEFINE "vol"
                           A 10043    
                           A 10044    .CLASS 65
                           A 10045    
                           A 10046    .VALUE -30
                           A 10047    
                           A 10048    .TYPE 4
                           A 10049    
                           A 10050    .ENDEF
                           A 10051    
                           A 10052    .DEFINE "tsect"
                           A 10053    
                           A 10054    .CLASS 65
                           A 10055    
                           A 10056    .VALUE -34
                           A 10057    
                           A 10058    .TYPE 15
                           A 10059    
                           A 10060    .ENDEF
                           A 10061    
                           A 10062    .DEFINE "sysect"
                           A 10063    
                           A 10064    .CLASS 65
                           A 10065    
                           A 10066    .VALUE -38
                           A 10067    
                           A 10068    .TYPE 15
                           A 10069    
                           A 10070    .ENDEF
                           A 10071    
                           A 10072    .DEFINE "bsect"
                           A 10073    
                           A 10074    .CLASS 65
                           A 10075    
                           A 10076    .VALUE -45
                           A 10077    
                           A 10078    .TYPE 15
                           A 10079    
                           A 10080    .ENDEF
                           A 10081    
                           A 10082    .DEFINE "szbfat"
                           A 10083    
                           A 10084    .CLASS 65
                           A 10085    
                           A 10086    .VALUE -56
                           A 10087    
                           A 10088    .TYPE 15
                           A 10089    
                           A 10090    .ENDEF
                           A 10091    
042DE9 DDE5                A 10092    	PUSH	IX
042DEB DD210000 00         A 10093    	LD	IX,0
042DF0 DD39                A 10094    	ADD	IX,SP
042DF2 ED22B8              A 10095    	LEA	HL,IX+%FFFFFFB8
042DF5 F9                  A 10096    	LD	SP,HL
                           A 10097    ; 3338		int vol;
                           A 10098    ; 3339		DSTATUS stat;
                           A 10099    ; 3340		LBA_t bsect;
                           A 10100    ; 3341		DWORD tsect, sysect, fasize, nclst,
                           A 10101    ; 3342		WORD nrsv;
                           A 10102    ; 3343		FATFS *fs;
                           A 10103    ; 3344		UINT fmt;
                           A 10104    ; 3345	
                           A 10105    ; 3346	
                           A 10106    ; 3347		/* Get logical drive number */
                           A 10107    ; 3348		*rfs = 0;
                           A 10108    .LINE 3348
                           A 10109    
042DF6 DD2709              A 10110    	LD	HL,(IX+%9)
042DF9 01000000            A 10111    	LD	BC,0
042DFD ED0F                A 10112    	LD	(HL),BC
                           A 10113    ; 3349		vol = get_ldnumber(path);
                           A 10114    .LINE 3349
                           A 10115    
042DFF DD0706              A 10116    	LD	BC,(IX+%6)
042E02 C5                  A 10117    	PUSH	BC
042E03 CD DE 29 04         A 10118    	CALL	_get_ldnumber
042E07 C1                  A 10119    	POP	BC
042E08 DD2FE2              A 10120    	LD	(IX+%FFFFFFE2),HL
                           A 10121    ; 3350		if (vol < 0) return FR_INVALID_DRIV
                           A 10122    .LINE 3350
                           A 10123    
042E0B CD E5 46 04         A 10124    	CALL	__icmpzero
042E0F CD 87 44 04         A 10125    	CALL	__setflag
042E13 F2 1F 2E 04         A 10126    	JP	P,L_470
042E17 210B0000            A 10127    	LD	HL,11
042E1B C3 2C 33 04         A 10128    	JR	L_529
042E1F                     A 10129    L_470:
                           A 10130    ; 3351	
                           A 10131    ; 3352		/* Check if the filesystem object i
                           A 10132    ; 3353		fs = FatFs[vol];					
                           A 10133    .LINE 3353
                           A 10134    
042E1F DD27E2              A 10135    	LD	HL,(IX+%FFFFFFE2)
042E22 E5C1                A 10136    	LD	BC,HL
042E24 29                  A 10137    	ADD	HL,HL
042E25 09                  A 10138    	ADD	HL,BC
042E26 01 C6 4F 04         A 10139    	LD	BC,_FatFs
042E2A 09                  A 10140    	ADD	HL,BC
042E2B ED07                A 10141    	LD	BC,(HL)
042E2D DD0FFD              A 10142    	LD	(IX+%FFFFFFFD),BC
                           A 10143    ; 3354		if (!fs) return FR_NOT_ENABLED;		
                           A 10144    .LINE 3354
                           A 10145    
042E30 C5E1                A 10146    	LD	HL,BC
042E32 CD E5 46 04         A 10147    	CALL	__icmpzero
042E36 20 08               A 10148    	JR	NZ,L_472
042E38 210C0000            A 10149    	LD	HL,12
042E3C C3 2C 33 04         A 10150    	JR	L_529
042E40                     A 10151    L_472:
                           A 10152    ; 3355	#if FF_FS_REENTRANT
                           A 10153    ; 3356		if (!lock_fs(fs)) return FR_TIMEOUT
                           A 10154    ; 3357	#endif
                           A 10155    ; 3358		*rfs = fs;							
                           A 10156    .LINE 3358
                           A 10157    
042E40 DD2709              A 10158    	LD	HL,(IX+%9)
042E43 DD07FD              A 10159    	LD	BC,(IX+%FFFFFFFD)
042E46 ED0F                A 10160    	LD	(HL),BC
                           A 10161    ; 3359	
                           A 10162    ; 3360		mode &= (BYTE)~FA_READ;				
                           A 10163    ; 3361		if (fs->fs_type != 0) {				
                           A 10164    .LINE 3361
                           A 10165    
042E48 DD31FD              A 10166    	LD	IY,(IX+%FFFFFFFD)
042E4B FD7E00              A 10167    	LD	A,(IY+%0)
042E4E B7                  A 10168    	OR	A,A
042E4F 28 1C               A 10169    	JR	Z,L_477
                           A 10170    ; 3362			stat = disk_status(fs->pdrv);
                           A 10171    .LINE 3362
                           A 10172    
042E51 DD31FD              A 10173    	LD	IY,(IX+%FFFFFFFD)
042E54 FD4E01              A 10174    	LD	C,(IY+%1)
042E57 0600                A 10175    	LD	B,%0
042E59 C5                  A 10176    	PUSH	BC
042E5A CD D1 3E 04         A 10177    	CALL	_disk_status
042E5E C1                  A 10178    	POP	BC
042E5F DD77F4              A 10179    	LD	(IX+%FFFFFFF4),A
                           A 10180    ; 3363			if (!(stat & STA_NOINIT)) {		
                           A 10181    .LINE 3363
                           A 10182    
042E62 E601                A 10183    	AND	A,%1
042E64 20 07               A 10184    	JR	NZ,L_477
                           A 10185    ; 3364				if (!FF_FS_READONLY && mode
                           A 10186    ; 3365					return FR_WRITE_PROTECT
                           A 10187    ; 3366				}
                           A 10188    ; 3367				return FR_OK;				
                           A 10189    .LINE 3367
                           A 10190    
042E66 B7                  A 10191    	OR	A,A
042E67 ED62                A 10192    	SBC	HL,HL
042E69 C3 2C 33 04         A 10193    	JR	L_529
                           A 10194    ; 3368			}
                           A 10195    ; 3369		}
042E6D                     A 10196    L_477:
                           A 10197    .LINE 3369
                           A 10198    
                           A 10199    ; 3370	
                           A 10200    ; 3371		/* The filesystem object is not val
                           A 10201    ; 3372		/* Following code attempts to mount
                           A 10202    ; 3373	
                           A 10203    ; 3374		fs->fs_type = 0;					
                           A 10204    .LINE 3374
                           A 10205    
042E6D DD31FD              A 10206    	LD	IY,(IX+%FFFFFFFD)
042E70 FD360000            A 10207    	LD	(IY+%0),%0
                           A 10208    ; 3375		fs->pdrv = LD2PD(vol);				
                           A 10209    .LINE 3375
                           A 10210    
042E74 DD7EE2              A 10211    	LD	A,(IX+%FFFFFFE2)
042E77 FD7701              A 10212    	LD	(IY+%1),A
                           A 10213    ; 3376		stat = disk_initialize(fs->pdrv);	
                           A 10214    .LINE 3376
                           A 10215    
042E7A FD4E01              A 10216    	LD	C,(IY+%1)
042E7D 0600                A 10217    	LD	B,%0
042E7F C5                  A 10218    	PUSH	BC
042E80 CD E0 3E 04         A 10219    	CALL	_disk_initialize
042E84 C1                  A 10220    	POP	BC
042E85 DD77F4              A 10221    	LD	(IX+%FFFFFFF4),A
                           A 10222    ; 3377		if (stat & STA_NOINIT) { 			
                           A 10223    .LINE 3377
                           A 10224    
042E88 E601                A 10225    	AND	A,%1
042E8A 28 08               A 10226    	JR	Z,L_481
                           A 10227    ; 3378			return FR_NOT_READY;			
                           A 10228    .LINE 3378
                           A 10229    
042E8C 21030000            A 10230    	LD	HL,3
042E90 C3 2C 33 04         A 10231    	JR	L_529
                           A 10232    ; 3379		}
                           A 10233    .LINE 3379
                           A 10234    
                           A 10235    ; 3380		if (!FF_FS_READONLY && mode && (sta
                           A 10236    ; 3381			return FR_WRITE_PROTECTED;
                           A 10237    ; 3382		}
042E94                     A 10238    L_481:
                           A 10239    .LINE 3382
                           A 10240    
                           A 10241    ; 3383	#if FF_MAX_SS != FF_MIN_SS				
                           A 10242    ; 3384		if (disk_ioctl(fs->pdrv, GET_SECTOR
                           A 10243    ; 3385		if (SS(fs) > FF_MAX_SS || SS(fs) < 
                           A 10244    ; 3386	#endif
                           A 10245    ; 3387	
                           A 10246    ; 3388		/* Find an FAT volume on the drive 
                           A 10247    ; 3389		fmt = find_volume(fs, LD2PT(vol));
                           A 10248    .LINE 3389
                           A 10249    
042E94 01000000            A 10250    	LD	BC,0
042E98 C5                  A 10251    	PUSH	BC
042E99 DD07FD              A 10252    	LD	BC,(IX+%FFFFFFFD)
042E9C C5                  A 10253    	PUSH	BC
042E9D CD A4 2C 04         A 10254    	CALL	_find_volume
042EA1 C1                  A 10255    	POP	BC
042EA2 C1                  A 10256    	POP	BC
042EA3 DD2FFA              A 10257    	LD	(IX+%FFFFFFFA),HL
                           A 10258    ; 3390		if (fmt == 4) return FR_DISK_ERR;	
                           A 10259    .LINE 3390
                           A 10260    
042EA6 01040000            A 10261    	LD	BC,4
042EAA DD27FA              A 10262    	LD	HL,(IX+%FFFFFFFA)
042EAD B7                  A 10263    	OR	A,A
042EAE ED42                A 10264    	SBC	HL,BC
042EB0 20 08               A 10265    	JR	NZ,L_484
042EB2 21010000            A 10266    	LD	HL,1
042EB6 C3 2C 33 04         A 10267    	JR	L_529
042EBA                     A 10268    L_484:
                           A 10269    ; 3391		if (fmt >= 2) return FR_NO_FILESYST
                           A 10270    .LINE 3391
                           A 10271    
042EBA 01020000            A 10272    	LD	BC,2
042EBE DD27FA              A 10273    	LD	HL,(IX+%FFFFFFFA)
042EC1 B7                  A 10274    	OR	A,A
042EC2 ED42                A 10275    	SBC	HL,BC
042EC4 38 08               A 10276    	JR	C,L_485
042EC6 210D0000            A 10277    	LD	HL,13
042ECA C3 2C 33 04         A 10278    	JR	L_529
042ECE                     A 10279    L_485:
                           A 10280    ; 3392		bsect = fs->winsect;				
                           A 10281    .LINE 3392
                           A 10282    
042ECE DD31FD              A 10283    	LD	IY,(IX+%FFFFFFFD)
042ED1 FD072A              A 10284    	LD	BC,(IY+%2A)
042ED4 FD7E2D              A 10285    	LD	A,(IY+%2D)
042ED7 DD0FD3              A 10286    	LD	(IX+%FFFFFFD3),BC
042EDA DD77D6              A 10287    	LD	(IX+%FFFFFFD6),A
                           A 10288    ; 3393	
                           A 10289    ; 3394		/* An FAT volume is found (bsect). 
                           A 10290    ; 3395	
                           A 10291    ; 3396	#if FF_FS_EXFAT
                           A 10292    ; 3397		if (fmt == 1) {
                           A 10293    ; 3398			QWORD maxlba;
                           A 10294    ; 3399			DWORD so, cv, bcl, i;
                           A 10295    ; 3400	
                           A 10296    ; 3401			for (i = BPB_ZeroedEx; i < BPB_
                           A 10297    ; 3402			if (i < BPB_ZeroedEx + 53) retu
                           A 10298    ; 3403	
                           A 10299    ; 3404			if (ld_word(fs->win + BPB_FSVer
                           A 10300    ; 3405	
                           A 10301    ; 3406			if (1 << fs->win[BPB_BytsPerSec
                           A 10302    ; 3407				return FR_NO_FILESYSTEM;
                           A 10303    ; 3408			}
                           A 10304    ; 3409	
                           A 10305    ; 3410			maxlba = ld_qword(fs->win + BPB
                           A 10306    ; 3411			if (!FF_LBA64 && maxlba >= 0x10
                           A 10307    ; 3412	
                           A 10308    ; 3413			fs->fsize = ld_dword(fs->win + 
                           A 10309    ; 3414	
                           A 10310    ; 3415			fs->n_fats = fs->win[BPB_NumFAT
                           A 10311    ; 3416			if (fs->n_fats != 1) return FR_
                           A 10312    ; 3417	
                           A 10313    ; 3418			fs->csize = 1 << fs->win[BPB_Se
                           A 10314    ; 3419			if (fs->csize == 0)	return FR_N
                           A 10315    ; 3420	
                           A 10316    ; 3421			nclst = ld_dword(fs->win + BPB_
                           A 10317    ; 3422			if (nclst > MAX_EXFAT) return F
                           A 10318    ; 3423			fs->n_fatent = nclst + 2;
                           A 10319    ; 3424	
                           A 10320    ; 3425			/* Boundaries and Limits */
                           A 10321    ; 3426			fs->volbase = bsect;
                           A 10322    ; 3427			fs->database = bsect + ld_dword
                           A 10323    ; 3428			fs->fatbase = bsect + ld_dword(
                           A 10324    ; 3429			if (maxlba < (QWORD)fs->databas
                           A 10325    ; 3430			fs->dirbase = ld_dword(fs->win 
                           A 10326    ; 3431	
                           A 10327    ; 3432			/* Get bitmap location and chec
                           A 10328    ; 3433			so = i = 0;
                           A 10329    ; 3434			for (;;) {	/* Find the bitmap 
                           A 10330    ; 3435				if (i == 0) {
                           A 10331    ; 3436					if (so >= fs->csize) re
                           A 10332    ; 3437					if (move_window(fs, cls
                           A 10333    ; 3438					so++;
                           A 10334    ; 3439				}
                           A 10335    ; 3440				if (fs->win[i] == ET_BITMAP
                           A 10336    ; 3441				i = (i + SZDIRE) % SS(fs);	
                           A 10337    ; 3442			}
                           A 10338    ; 3443			bcl = ld_dword(fs->win + i + 20
                           A 10339    ; 3444			if (bcl < 2 || bcl >= fs->n_fat
                           A 10340    ; 3445			fs->bitbase = fs->database + fs
                           A 10341    ; 3446			for (;;) {	/* Check if bitmap 
                           A 10342    ; 3447				if (move_window(fs, fs->fat
                           A 10343    ; 3448				cv = ld_dword(fs->win + bcl
                           A 10344    ; 3449				if (cv == 0xFFFFFFFF) break
                           A 10345    ; 3450				if (cv != ++bcl) return FR_
                           A 10346    ; 3451			}
                           A 10347    ; 3452	
                           A 10348    ; 3453	#if !FF_FS_READONLY
                           A 10349    ; 3454			fs->last_clst = fs->free_clst =
                           A 10350    ; 3455	#endif
                           A 10351    ; 3456			fmt = FS_EXFAT;			/* FAT 
                           A 10352    ; 3457		} else
                           A 10353    ; 3458	#endif	/* FF_FS_EXFAT */
                           A 10354    ; 3459		{
                           A 10355    ; 3460			if (ld_word(fs->win + BPB_BytsP
                           A 10356    .LINE 3460
                           A 10357    
042EDD ED032E              A 10358    	LEA	BC,IY+%2E
042EE0 DD0FEF              A 10359    	LD	(IX+%FFFFFFEF),BC
042EE3 DD31EF              A 10360    	LD	IY,(IX+%FFFFFFEF)
042EE6 ED030B              A 10361    	LEA	BC,IY+%B
042EE9 C5                  A 10362    	PUSH	BC
042EEA CD 25 0F 04         A 10363    	CALL	_ld_word
042EEE C1                  A 10364    	POP	BC
042EEF E5C1                A 10365    	LD	BC,HL
042EF1 CD 73 45 04         A 10366    	CALL	__stoiu
042EF5 01000200            A 10367    	LD	BC,512
042EF9 B7                  A 10368    	OR	A,A
042EFA ED42                A 10369    	SBC	HL,BC
042EFC 28 08               A 10370    	JR	Z,L_487
042EFE 210D0000            A 10371    	LD	HL,13
042F02 C3 2C 33 04         A 10372    	JR	L_529
042F06                     A 10373    L_487:
                           A 10374    ; 3461	
                           A 10375    ; 3462			fasize = ld_word(fs->win + BPB_
                           A 10376    .LINE 3462
                           A 10377    
042F06 DD31EF              A 10378    	LD	IY,(IX+%FFFFFFEF)
042F09 ED0316              A 10379    	LEA	BC,IY+%16
042F0C C5                  A 10380    	PUSH	BC
042F0D CD 25 0F 04         A 10381    	CALL	_ld_word
042F11 C1                  A 10382    	POP	BC
042F12 E5C1                A 10383    	LD	BC,HL
042F14 CD 73 45 04         A 10384    	CALL	__stoiu
042F18 AF                  A 10385    	XOR	A,A
042F19 DD2FF6              A 10386    	LD	(IX+%FFFFFFF6),HL
042F1C DD77F9              A 10387    	LD	(IX+%FFFFFFF9),A
                           A 10388    ; 3463			if (fasize == 0) fasize = ld_dw
                           A 10389    .LINE 3463
                           A 10390    
042F1F DD27F6              A 10391    	LD	HL,(IX+%FFFFFFF6)
042F22 DD5EF9              A 10392    	LD	E,(IX+%FFFFFFF9)
042F25 CD B8 45 04         A 10393    	CALL	__lcmpzero
042F29 20 12               A 10394    	JR	NZ,L_489
042F2B DD31EF              A 10395    	LD	IY,(IX+%FFFFFFEF)
042F2E ED0324              A 10396    	LEA	BC,IY+%24
042F31 C5                  A 10397    	PUSH	BC
042F32 CD 61 0F 04         A 10398    	CALL	_ld_dword
042F36 C1                  A 10399    	POP	BC
042F37 DD2FF6              A 10400    	LD	(IX+%FFFFFFF6),HL
042F3A DD73F9              A 10401    	LD	(IX+%FFFFFFF9),E
042F3D                     A 10402    L_489:
                           A 10403    ; 3464			fs->fsize = fasize;
                           A 10404    .LINE 3464
                           A 10405    
042F3D DD07F6              A 10406    	LD	BC,(IX+%FFFFFFF6)
042F40 DD7EF9              A 10407    	LD	A,(IX+%FFFFFFF9)
042F43 DD31FD              A 10408    	LD	IY,(IX+%FFFFFFFD)
042F46 FD0F16              A 10409    	LD	(IY+%16),BC
042F49 FD7719              A 10410    	LD	(IY+%19),A
                           A 10411    ; 3465	
                           A 10412    ; 3466			fs->n_fats = fs->win[BPB_NumFAT
                           A 10413    .LINE 3466
                           A 10414    
042F4C FD7E3E              A 10415    	LD	A,(IY+%3E)
042F4F FD7702              A 10416    	LD	(IY+%2),A
                           A 10417    ; 3467			if (fs->n_fats != 1 && fs->n_fa
                           A 10418    .LINE 3467
                           A 10419    
042F52 FD7E02              A 10420    	LD	A,(IY+%2)
042F55 DD77F5              A 10421    	LD	(IX+%FFFFFFF5),A
042F58 DD77EE              A 10422    	LD	(IX+%FFFFFFEE),A
042F5B DD7EF5              A 10423    	LD	A,(IX+%FFFFFFF5)
042F5E FE01                A 10424    	CP	A,%1
042F60 28 15               A 10425    	JR	Z,L_492
042F62 DD7EF5              A 10426    	LD	A,(IX+%FFFFFFF5)
042F65 DD77EE              A 10427    	LD	(IX+%FFFFFFEE),A
042F68 DD7EF5              A 10428    	LD	A,(IX+%FFFFFFF5)
042F6B FE02                A 10429    	CP	A,%2
042F6D 28 08               A 10430    	JR	Z,L_492
042F6F 210D0000            A 10431    	LD	HL,13
042F73 C3 2C 33 04         A 10432    	JR	L_529
042F77                     A 10433    L_492:
                           A 10434    ; 3468			fasize *= fs->n_fats;			
                           A 10435    .LINE 3468
                           A 10436    
042F77 B7ED62              A 10437    	UEXT	HL
042F7A DD6EEE              A 10438    	LD	L,(IX+%FFFFFFEE)
042F7D E5C1                A 10439    	LD	BC,HL
042F7F 7C                  A 10440    	LD	A,H
042F80 DD27F6              A 10441    	LD	HL,(IX+%FFFFFFF6)
042F83 DD5EF9              A 10442    	LD	E,(IX+%FFFFFFF9)
042F86 CD BD 48 04         A 10443    	CALL	__lmulu
042F8A DD2FF6              A 10444    	LD	(IX+%FFFFFFF6),HL
042F8D DD73F9              A 10445    	LD	(IX+%FFFFFFF9),E
                           A 10446    ; 3469	
                           A 10447    ; 3470			fs->csize = fs->win[BPB_SecPerC
                           A 10448    .LINE 3470
                           A 10449    
042F90 DD31FD              A 10450    	LD	IY,(IX+%FFFFFFFD)
042F93 ED233B              A 10451    	LEA	HL,IY+%3B
042F96 4E                  A 10452    	LD	C,(HL)
042F97 FD7109              A 10453    	LD	(IY+%9),C
042F9A FD360A00            A 10454    	LD	(IY+%A),%0
                           A 10455    ; 3471			if (fs->csize == 0 || (fs->csiz
                           A 10456    .LINE 3471
                           A 10457    
042F9E FD0709              A 10458    	LD	BC,(IY+%9)
042FA1 DD71F2              A 10459    	LD	(IX+%FFFFFFF2),C
042FA4 DD70F3              A 10460    	LD	(IX+%FFFFFFF3),B
042FA7 DD27F2              A 10461    	LD	HL,(IX+%FFFFFFF2)
042FAA CD D8 47 04         A 10462    	CALL	__scmpzero
042FAE 28 15               A 10463    	JR	Z,L_494
042FB0 DD07F2              A 10464    	LD	BC,(IX+%FFFFFFF2)
042FB3 CD 73 45 04         A 10465    	CALL	__stoiu
042FB7 2B                  A 10466    	DEC	HL
042FB8 DD07F2              A 10467    	LD	BC,(IX+%FFFFFFF2)
042FBB CD DC 46 04         A 10468    	CALL	__sand
042FBF CD D8 47 04         A 10469    	CALL	__scmpzero
042FC3 28 08               A 10470    	JR	Z,L_495
042FC5                     A 10471    L_494:
042FC5 210D0000            A 10472    	LD	HL,13
042FC9 C3 2C 33 04         A 10473    	JR	L_529
042FCD                     A 10474    L_495:
                           A 10475    ; 3472	
                           A 10476    ; 3473			fs->n_rootdir = ld_word(fs->win
                           A 10477    .LINE 3473
                           A 10478    
042FCD DD31FD              A 10479    	LD	IY,(IX+%FFFFFFFD)
042FD0 ED033F              A 10480    	LEA	BC,IY+%3F
042FD3 C5                  A 10481    	PUSH	BC
042FD4 CD 25 0F 04         A 10482    	CALL	_ld_word
042FD8 C1                  A 10483    	POP	BC
042FD9 DD31FD              A 10484    	LD	IY,(IX+%FFFFFFFD)
042FDC E5C1                A 10485    	LD	BC,HL
042FDE FD7107              A 10486    	LD	(IY+%7),C
042FE1 FD7008              A 10487    	LD	(IY+%8),B
                           A 10488    ; 3474			if (fs->n_rootdir % (SS(fs) / S
                           A 10489    .LINE 3474
                           A 10490    
042FE4 FD0707              A 10491    	LD	BC,(IY+%7)
042FE7 CD 73 45 04         A 10492    	CALL	__stoiu
042FEB 7D                  A 10493    	LD	A,L
042FEC E60F                A 10494    	AND	A,%F
042FEE B7ED62              A 10495    	UEXT	HL
042FF1 6F                  A 10496    	LD	L,A
042FF2 CD E5 46 04         A 10497    	CALL	__icmpzero
042FF6 28 08               A 10498    	JR	Z,L_497
042FF8 210D0000            A 10499    	LD	HL,13
042FFC C3 2C 33 04         A 10500    	JR	L_529
043000                     A 10501    L_497:
                           A 10502    ; 3475	
                           A 10503    ; 3476			tsect = ld_word(fs->win + BPB_T
                           A 10504    .LINE 3476
                           A 10505    
043000 DD31FD              A 10506    	LD	IY,(IX+%FFFFFFFD)
043003 ED032E              A 10507    	LEA	BC,IY+%2E
043006 DD0FE5              A 10508    	LD	(IX+%FFFFFFE5),BC
043009 DD0FD7              A 10509    	LD	(IX+%FFFFFFD7),BC
04300C DD31E5              A 10510    	LD	IY,(IX+%FFFFFFE5)
04300F ED0313              A 10511    	LEA	BC,IY+%13
043012 C5                  A 10512    	PUSH	BC
043013 CD 25 0F 04         A 10513    	CALL	_ld_word
043017 C1                  A 10514    	POP	BC
043018 E5C1                A 10515    	LD	BC,HL
04301A CD 73 45 04         A 10516    	CALL	__stoiu
04301E AF                  A 10517    	XOR	A,A
04301F DD2FDE              A 10518    	LD	(IX+%FFFFFFDE),HL
043022 DD77E1              A 10519    	LD	(IX+%FFFFFFE1),A
                           A 10520    ; 3477			if (tsect == 0) tsect = ld_dwor
                           A 10521    .LINE 3477
                           A 10522    
043025 DD27DE              A 10523    	LD	HL,(IX+%FFFFFFDE)
043028 DD5EE1              A 10524    	LD	E,(IX+%FFFFFFE1)
04302B CD B8 45 04         A 10525    	CALL	__lcmpzero
04302F 20 18               A 10526    	JR	NZ,L_499
043031 DD07E5              A 10527    	LD	BC,(IX+%FFFFFFE5)
043034 DD0FD7              A 10528    	LD	(IX+%FFFFFFD7),BC
043037 DD31E5              A 10529    	LD	IY,(IX+%FFFFFFE5)
04303A ED0320              A 10530    	LEA	BC,IY+%20
04303D C5                  A 10531    	PUSH	BC
04303E CD 61 0F 04         A 10532    	CALL	_ld_dword
043042 C1                  A 10533    	POP	BC
043043 DD2FDE              A 10534    	LD	(IX+%FFFFFFDE),HL
043046 DD73E1              A 10535    	LD	(IX+%FFFFFFE1),E
043049                     A 10536    L_499:
                           A 10537    ; 3478	
                           A 10538    ; 3479			nrsv = ld_word(fs->win + BPB_Rs
                           A 10539    .LINE 3479
                           A 10540    
043049 DD31D7              A 10541    	LD	IY,(IX+%FFFFFFD7)
04304C ED030E              A 10542    	LEA	BC,IY+%E
04304F C5                  A 10543    	PUSH	BC
043050 CD 25 0F 04         A 10544    	CALL	_ld_word
043054 C1                  A 10545    	POP	BC
043055 DD75E8              A 10546    	LD	(IX+%FFFFFFE8),L
043058 DD74E9              A 10547    	LD	(IX+%FFFFFFE9),H
                           A 10548    ; 3480			if (nrsv == 0) return FR_NO_FIL
                           A 10549    .LINE 3480
                           A 10550    
04305B DD27E8              A 10551    	LD	HL,(IX+%FFFFFFE8)
04305E CD D8 47 04         A 10552    	CALL	__scmpzero
043062 20 08               A 10553    	JR	NZ,L_501
043064 210D0000            A 10554    	LD	HL,13
043068 C3 2C 33 04         A 10555    	JR	L_529
04306C                     A 10556    L_501:
                           A 10557    ; 3481	
                           A 10558    ; 3482			/* Determine the FAT sub type *
                           A 10559    ; 3483			sysect = nrsv + fasize + fs->n_
                           A 10560    .LINE 3483
                           A 10561    
04306C DD31FD              A 10562    	LD	IY,(IX+%FFFFFFFD)
04306F FD0707              A 10563    	LD	BC,(IY+%7)
043072 CD 73 45 04         A 10564    	CALL	__stoiu
043076 3E04                A 10565    	LD	A,%4
043078 CD 5C 47 04         A 10566    	CALL	__ishru_b
04307C AF                  A 10567    	XOR	A,A
04307D DD77BB              A 10568    	LD	(IX+%FFFFFFBB),A
043080 DD2FB8              A 10569    	LD	(IX+%FFFFFFB8),HL
043083 DD07E8              A 10570    	LD	BC,(IX+%FFFFFFE8)
043086 CD 73 45 04         A 10571    	CALL	__stoiu
04308A E5C1                A 10572    	LD	BC,HL
04308C AF                  A 10573    	XOR	A,A
04308D DD27F6              A 10574    	LD	HL,(IX+%FFFFFFF6)
043090 DD5EF9              A 10575    	LD	E,(IX+%FFFFFFF9)
043093 CD A5 44 04         A 10576    	CALL	__ladd
043097 7B                  A 10577    	LD	A,E
043098 E5C1                A 10578    	LD	BC,HL
04309A DD5EBB              A 10579    	LD	E,(IX+%FFFFFFBB)
04309D DD27B8              A 10580    	LD	HL,(IX+%FFFFFFB8)
0430A0 CD A5 44 04         A 10581    	CALL	__ladd
0430A4 DD2FDA              A 10582    	LD	(IX+%FFFFFFDA),HL
0430A7 DD73DD              A 10583    	LD	(IX+%FFFFFFDD),E
                           A 10584    ; 3484			if (tsect < sysect) return FR_N
                           A 10585    .LINE 3484
                           A 10586    
0430AA DD27DE              A 10587    	LD	HL,(IX+%FFFFFFDE)
0430AD DD5EE1              A 10588    	LD	E,(IX+%FFFFFFE1)
0430B0 DD07DA              A 10589    	LD	BC,(IX+%FFFFFFDA)
0430B3 DD7EDD              A 10590    	LD	A,(IX+%FFFFFFDD)
0430B6 CD 88 47 04         A 10591    	CALL	__lcmpu
0430BA 30 08               A 10592    	JR	NC,L_503
0430BC 210D0000            A 10593    	LD	HL,13
0430C0 C3 2C 33 04         A 10594    	JR	L_529
0430C4                     A 10595    L_503:
                           A 10596    ; 3485			nclst = (tsect - sysect) / fs->
                           A 10597    .LINE 3485
                           A 10598    
0430C4 DD27DE              A 10599    	LD	HL,(IX+%FFFFFFDE)
0430C7 DD5EE1              A 10600    	LD	E,(IX+%FFFFFFE1)
0430CA DD07DA              A 10601    	LD	BC,(IX+%FFFFFFDA)
0430CD DD7EDD              A 10602    	LD	A,(IX+%FFFFFFDD)
0430D0 CD 7B 46 04         A 10603    	CALL	__lsub
0430D4 DD2FBC              A 10604    	LD	(IX+%FFFFFFBC),HL
0430D7 DD31FD              A 10605    	LD	IY,(IX+%FFFFFFFD)
0430DA FD0709              A 10606    	LD	BC,(IY+%9)
0430DD CD 73 45 04         A 10607    	CALL	__stoiu
0430E1 E5C1                A 10608    	LD	BC,HL
0430E3 AF                  A 10609    	XOR	A,A
0430E4 DD27BC              A 10610    	LD	HL,(IX+%FFFFFFBC)
0430E7 CD 29 46 04         A 10611    	CALL	__ldivu
0430EB DD2FEA              A 10612    	LD	(IX+%FFFFFFEA),HL
0430EE DD73ED              A 10613    	LD	(IX+%FFFFFFED),E
                           A 10614    ; 3486			if (nclst == 0) return FR_NO_FI
                           A 10615    .LINE 3486
                           A 10616    
0430F1 DD27EA              A 10617    	LD	HL,(IX+%FFFFFFEA)
0430F4 DD5EED              A 10618    	LD	E,(IX+%FFFFFFED)
0430F7 CD B8 45 04         A 10619    	CALL	__lcmpzero
0430FB 20 08               A 10620    	JR	NZ,L_505
0430FD 210D0000            A 10621    	LD	HL,13
043101 C3 2C 33 04         A 10622    	JR	L_529
043105                     A 10623    L_505:
                           A 10624    ; 3487			fmt = 0;
                           A 10625    .LINE 3487
                           A 10626    
043105 01000000            A 10627    	LD	BC,0
043109 DD0FFA              A 10628    	LD	(IX+%FFFFFFFA),BC
                           A 10629    ; 3488			if (nclst <= MAX_FAT32) fmt = F
                           A 10630    .LINE 3488
                           A 10631    
04310C 21F5FFFF            A 10632    	LD	HL,16777205
043110 1E0F                A 10633    	LD	E,%F
043112 DD07EA              A 10634    	LD	BC,(IX+%FFFFFFEA)
043115 DD7EED              A 10635    	LD	A,(IX+%FFFFFFED)
043118 CD 88 47 04         A 10636    	CALL	__lcmpu
04311C 38 07               A 10637    	JR	C,L_508
04311E 01030000            A 10638    	LD	BC,3
043122 DD0FFA              A 10639    	LD	(IX+%FFFFFFFA),BC
043125                     A 10640    L_508:
                           A 10641    ; 3489			if (nclst <= MAX_FAT16) fmt = F
                           A 10642    .LINE 3489
                           A 10643    
043125 21F5FF00            A 10644    	LD	HL,65525
043129 1E00                A 10645    	LD	E,%0
04312B DD07EA              A 10646    	LD	BC,(IX+%FFFFFFEA)
04312E DD7EED              A 10647    	LD	A,(IX+%FFFFFFED)
043131 CD 88 47 04         A 10648    	CALL	__lcmpu
043135 38 07               A 10649    	JR	C,L_510
043137 01020000            A 10650    	LD	BC,2
04313B DD0FFA              A 10651    	LD	(IX+%FFFFFFFA),BC
04313E                     A 10652    L_510:
                           A 10653    ; 3490			if (nclst <= MAX_FAT12) fmt = F
                           A 10654    .LINE 3490
                           A 10655    
04313E 21F50F00            A 10656    	LD	HL,4085
043142 DD07EA              A 10657    	LD	BC,(IX+%FFFFFFEA)
043145 DD7EED              A 10658    	LD	A,(IX+%FFFFFFED)
043148 CD 88 47 04         A 10659    	CALL	__lcmpu
04314C 38 07               A 10660    	JR	C,L_512
04314E 01010000            A 10661    	LD	BC,1
043152 DD0FFA              A 10662    	LD	(IX+%FFFFFFFA),BC
043155                     A 10663    L_512:
                           A 10664    ; 3491			if (fmt == 0) return FR_NO_FILE
                           A 10665    .LINE 3491
                           A 10666    
043155 DD27FA              A 10667    	LD	HL,(IX+%FFFFFFFA)
043158 CD E5 46 04         A 10668    	CALL	__icmpzero
04315C 20 08               A 10669    	JR	NZ,L_513
04315E 210D0000            A 10670    	LD	HL,13
043162 C3 2C 33 04         A 10671    	JR	L_529
043166                     A 10672    L_513:
                           A 10673    ; 3492	
                           A 10674    ; 3493			/* Boundaries and Limits */
                           A 10675    ; 3494			fs->n_fatent = nclst + 2;		
                           A 10676    .LINE 3494
                           A 10677    
043166 DD27EA              A 10678    	LD	HL,(IX+%FFFFFFEA)
043169 DD5EED              A 10679    	LD	E,(IX+%FFFFFFED)
04316C 3E02                A 10680    	LD	A,%2
04316E CD 96 44 04         A 10681    	CALL	__ladd_b
043172 DD31FD              A 10682    	LD	IY,(IX+%FFFFFFFD)
043175 FD2F12              A 10683    	LD	(IY+%12),HL
043178 FD7315              A 10684    	LD	(IY+%15),E
                           A 10685    ; 3495			fs->volbase = bsect;			
                           A 10686    .LINE 3495
                           A 10687    
04317B DD07D3              A 10688    	LD	BC,(IX+%FFFFFFD3)
04317E DD7ED6              A 10689    	LD	A,(IX+%FFFFFFD6)
043181 FD0F1A              A 10690    	LD	(IY+%1A),BC
043184 FD771D              A 10691    	LD	(IY+%1D),A
                           A 10692    ; 3496			fs->fatbase = bsect + nrsv; 	
                           A 10693    .LINE 3496
                           A 10694    
043187 DD07E8              A 10695    	LD	BC,(IX+%FFFFFFE8)
04318A CD 73 45 04         A 10696    	CALL	__stoiu
04318E E5C1                A 10697    	LD	BC,HL
043190 AF                  A 10698    	XOR	A,A
043191 DD27D3              A 10699    	LD	HL,(IX+%FFFFFFD3)
043194 DD5ED6              A 10700    	LD	E,(IX+%FFFFFFD6)
043197 CD A5 44 04         A 10701    	CALL	__ladd
04319B FD2F1E              A 10702    	LD	(IY+%1E),HL
04319E FD7321              A 10703    	LD	(IY+%21),E
                           A 10704    ; 3497			fs->database = bsect + sysect;	
                           A 10705    .LINE 3497
                           A 10706    
0431A1 DD27DA              A 10707    	LD	HL,(IX+%FFFFFFDA)
0431A4 DD5EDD              A 10708    	LD	E,(IX+%FFFFFFDD)
0431A7 DD07D3              A 10709    	LD	BC,(IX+%FFFFFFD3)
0431AA DD7ED6              A 10710    	LD	A,(IX+%FFFFFFD6)
0431AD CD A5 44 04         A 10711    	CALL	__ladd
0431B1 FD2F26              A 10712    	LD	(IY+%26),HL
0431B4 FD7329              A 10713    	LD	(IY+%29),E
                           A 10714    ; 3498			if (fmt == FS_FAT32) {
                           A 10715    .LINE 3498
                           A 10716    
0431B7 01030000            A 10717    	LD	BC,3
0431BB DD27FA              A 10718    	LD	HL,(IX+%FFFFFFFA)
0431BE B7                  A 10719    	OR	A,A
0431BF ED42                A 10720    	SBC	HL,BC
0431C1 20 65               A 10721    	JR	NZ,L_525
                           A 10722    ; 3499				if (ld_word(fs->win + BPB_F
                           A 10723    .LINE 3499
                           A 10724    
0431C3 DD31FD              A 10725    	LD	IY,(IX+%FFFFFFFD)
0431C6 ED032E              A 10726    	LEA	BC,IY+%2E
0431C9 DD0FD0              A 10727    	LD	(IX+%FFFFFFD0),BC
0431CC DD31D0              A 10728    	LD	IY,(IX+%FFFFFFD0)
0431CF ED032A              A 10729    	LEA	BC,IY+%2A
0431D2 C5                  A 10730    	PUSH	BC
0431D3 CD 25 0F 04         A 10731    	CALL	_ld_word
0431D7 C1                  A 10732    	POP	BC
0431D8 CD D8 47 04         A 10733    	CALL	__scmpzero
0431DC 28 08               A 10734    	JR	Z,L_516
0431DE 210D0000            A 10735    	LD	HL,13
0431E2 C3 2C 33 04         A 10736    	JR	L_529
0431E6                     A 10737    L_516:
                           A 10738    ; 3500				if (fs->n_rootdir != 0) ret
                           A 10739    .LINE 3500
                           A 10740    
0431E6 DD31FD              A 10741    	LD	IY,(IX+%FFFFFFFD)
0431E9 FD2707              A 10742    	LD	HL,(IY+%7)
0431EC CD D8 47 04         A 10743    	CALL	__scmpzero
0431F0 28 08               A 10744    	JR	Z,L_517
0431F2 210D0000            A 10745    	LD	HL,13
0431F6 C3 2C 33 04         A 10746    	JR	L_529
0431FA                     A 10747    L_517:
                           A 10748    ; 3501				fs->dirbase = ld_dword(fs->
                           A 10749    .LINE 3501
                           A 10750    
0431FA DD31D0              A 10751    	LD	IY,(IX+%FFFFFFD0)
0431FD ED032C              A 10752    	LEA	BC,IY+%2C
043200 C5                  A 10753    	PUSH	BC
043201 CD 61 0F 04         A 10754    	CALL	_ld_dword
043205 C1                  A 10755    	POP	BC
043206 DD31FD              A 10756    	LD	IY,(IX+%FFFFFFFD)
043209 FD2F22              A 10757    	LD	(IY+%22),HL
04320C FD7325              A 10758    	LD	(IY+%25),E
                           A 10759    ; 3502				szbfat = fs->n_fatent * 4;	
                           A 10760    .LINE 3502
                           A 10761    
04320F FD2712              A 10762    	LD	HL,(IY+%12)
043212 FD5E15              A 10763    	LD	E,(IY+%15)
043215 01040000            A 10764    	LD	BC,4
043219 AF                  A 10765    	XOR	A,A
04321A CD BD 48 04         A 10766    	CALL	__lmulu
04321E DD2FC8              A 10767    	LD	(IX+%FFFFFFC8),HL
043221 DD73CB              A 10768    	LD	(IX+%FFFFFFCB),E
                           A 10769    ; 3503			} else {
                           A 10770    .LINE 3503
                           A 10771    
043224 C3 D0 32 04         A 10772    	JR	L_527
043228                     A 10773    L_525:
                           A 10774    ; 3504				if (fs->n_rootdir == 0)	ret
                           A 10775    .LINE 3504
                           A 10776    
043228 DD31FD              A 10777    	LD	IY,(IX+%FFFFFFFD)
04322B FD2707              A 10778    	LD	HL,(IY+%7)
04322E CD D8 47 04         A 10779    	CALL	__scmpzero
043232 20 08               A 10780    	JR	NZ,L_519
043234 210D0000            A 10781    	LD	HL,13
043238 C3 2C 33 04         A 10782    	JR	L_529
04323C                     A 10783    L_519:
                           A 10784    ; 3505				fs->dirbase = fs->fatbase +
                           A 10785    .LINE 3505
                           A 10786    
04323C DD31FD              A 10787    	LD	IY,(IX+%FFFFFFFD)
04323F FD271E              A 10788    	LD	HL,(IY+%1E)
043242 FD5E21              A 10789    	LD	E,(IY+%21)
043245 DD07F6              A 10790    	LD	BC,(IX+%FFFFFFF6)
043248 DD7EF9              A 10791    	LD	A,(IX+%FFFFFFF9)
04324B CD A5 44 04         A 10792    	CALL	__ladd
04324F FD2F22              A 10793    	LD	(IY+%22),HL
043252 FD7325              A 10794    	LD	(IY+%25),E
                           A 10795    ; 3506				szbfat = (fmt == FS_FAT16) 
                           A 10796    .LINE 3506
                           A 10797    
043255 01020000            A 10798    	LD	BC,2
043259 DD27FA              A 10799    	LD	HL,(IX+%FFFFFFFA)
04325C B7                  A 10800    	OR	A,A
04325D ED42                A 10801    	SBC	HL,BC
04325F 20 16               A 10802    	JR	NZ,L_522
                           A 10803    ; 3507					fs->n_fatent * 2 : fs->
                           A 10804    .LINE 3507
                           A 10805    
043261 DD31FD              A 10806    	LD	IY,(IX+%FFFFFFFD)
043264 FD2712              A 10807    	LD	HL,(IY+%12)
043267 FD5E15              A 10808    	LD	E,(IY+%15)
04326A AF                  A 10809    	XOR	A,A
04326B CD BD 48 04         A 10810    	CALL	__lmulu
04326F DD2FCC              A 10811    	LD	(IX+%FFFFFFCC),HL
043272 DD73CF              A 10812    	LD	(IX+%FFFFFFCF),E
043275 18 4D               A 10813    	JR	L_523
043277                     A 10814    L_522:
043277 DD31FD              A 10815    	LD	IY,(IX+%FFFFFFFD)
04327A FD1712              A 10816    	LD	DE,(IY+%12)
04327D DD1FC2              A 10817    	LD	(IX+%FFFFFFC2),DE	; spill
043280 FD5E15              A 10818    	LD	E,(IY+%15)
043283 DD1FC5              A 10819    	LD	(IX+%FFFFFFC5),DE	; spill
043286 DD27C2              A 10820    	LD	HL,(IX+%FFFFFFC2)
043289 DD17C5              A 10821    	LD	DE,(IX+%FFFFFFC5)	; unspill
04328C 01030000            A 10822    	LD	BC,3
043290 AF                  A 10823    	XOR	A,A
043291 CD BD 48 04         A 10824    	CALL	__lmulu
043295 7B                  A 10825    	LD	A,E
043296 E5C1                A 10826    	LD	BC,HL
043298 2E01                A 10827    	LD	L,%1
04329A CD 87 46 04         A 10828    	CALL	__lshru
04329E DD0FBF              A 10829    	LD	(IX+%FFFFFFBF),BC
0432A1 5F                  A 10830    	LD	E,A
0432A2 DD1FC5              A 10831    	LD	(IX+%FFFFFFC5),DE	; spill
0432A5 DD17C2              A 10832    	LD	DE,(IX+%FFFFFFC2)	; unspill
0432A8 D5C1                A 10833    	LD	BC,DE
0432AA DD17C5              A 10834    	LD	DE,(IX+%FFFFFFC5)	; unspill
0432AD 79                  A 10835    	LD	A,C
0432AE E601                A 10836    	AND	A,%1
0432B0 B7ED62              A 10837    	UEXT	HL
0432B3 6F                  A 10838    	LD	L,A
0432B4 E5C1                A 10839    	LD	BC,HL
0432B6 7C                  A 10840    	LD	A,H
0432B7 DD27BF              A 10841    	LD	HL,(IX+%FFFFFFBF)
0432BA CD A5 44 04         A 10842    	CALL	__ladd
0432BE DD2FCC              A 10843    	LD	(IX+%FFFFFFCC),HL
0432C1 DD73CF              A 10844    	LD	(IX+%FFFFFFCF),E
0432C4                     A 10845    L_523:
0432C4 DD07CC              A 10846    	LD	BC,(IX+%FFFFFFCC)
0432C7 DD7ECF              A 10847    	LD	A,(IX+%FFFFFFCF)
0432CA DD0FC8              A 10848    	LD	(IX+%FFFFFFC8),BC
0432CD DD77CB              A 10849    	LD	(IX+%FFFFFFCB),A
                           A 10850    ; 3508			}
0432D0                     A 10851    L_527:
                           A 10852    .LINE 3508
                           A 10853    
                           A 10854    ; 3509			if (fs->fsize < (szbfat + (SS(f
                           A 10855    .LINE 3509
                           A 10856    
0432D0 DD27C8              A 10857    	LD	HL,(IX+%FFFFFFC8)
0432D3 DD5ECB              A 10858    	LD	E,(IX+%FFFFFFCB)
0432D6 01FF0100            A 10859    	LD	BC,511
0432DA AF                  A 10860    	XOR	A,A
0432DB CD A5 44 04         A 10861    	CALL	__ladd
0432DF 7B                  A 10862    	LD	A,E
0432E0 E5C1                A 10863    	LD	BC,HL
0432E2 2E09                A 10864    	LD	L,%9
0432E4 CD 87 46 04         A 10865    	CALL	__lshru
0432E8 DD31FD              A 10866    	LD	IY,(IX+%FFFFFFFD)
0432EB FD2716              A 10867    	LD	HL,(IY+%16)
0432EE FD5E19              A 10868    	LD	E,(IY+%19)
0432F1 CD 88 47 04         A 10869    	CALL	__lcmpu
0432F5 30 06               A 10870    	JR	NC,L_528
0432F7 210D0000            A 10871    	LD	HL,13
0432FB 18 2F               A 10872    	JR	L_529
                           A 10873    ; 3510	
                           A 10874    ; 3511	#if !FF_FS_READONLY
                           A 10875    ; 3512			/* Get FSInfo if available */
                           A 10876    ; 3513			fs->last_clst = fs->free_clst =
                           A 10877    ; 3514			fs->fsi_flag = 0x80;
                           A 10878    ; 3515	#if (FF_FS_NOFSINFO & 3) != 3
                           A 10879    ; 3516			if (fmt == FS_FAT32				
                           A 10880    ; 3517				&& ld_word(fs->win + BPB_FS
                           A 10881    ; 3518				&& move_window(fs, bsect + 
                           A 10882    ; 3519			{
                           A 10883    ; 3520				fs->fsi_flag = 0;
                           A 10884    ; 3521				if (ld_word(fs->win + BS_55
                           A 10885    ; 3522					&& ld_dword(fs->win + F
                           A 10886    ; 3523					&& ld_dword(fs->win + F
                           A 10887    ; 3524				{
                           A 10888    ; 3525	#if (FF_FS_NOFSINFO & 1) == 0
                           A 10889    ; 3526					fs->free_clst = ld_dwor
                           A 10890    ; 3527	#endif
                           A 10891    ; 3528	#if (FF_FS_NOFSINFO & 2) == 0
                           A 10892    ; 3529					fs->last_clst = ld_dwor
                           A 10893    ; 3530	#endif
                           A 10894    ; 3531				}
                           A 10895    ; 3532			}
                           A 10896    ; 3533	#endif	/* (FF_FS_NOFSINFO & 3) != 3 */
                           A 10897    ; 3534	#endif	/* !FF_FS_READONLY */
                           A 10898    ; 3535		}
0432FD                     A 10899    L_528:
                           A 10900    .LINE 3535
                           A 10901    
                           A 10902    ; 3536	
                           A 10903    ; 3537		fs->fs_type = (BYTE)fmt;/* FAT sub-
                           A 10904    .LINE 3537
                           A 10905    
0432FD DD7EFA              A 10906    	LD	A,(IX+%FFFFFFFA)
043300 DD31FD              A 10907    	LD	IY,(IX+%FFFFFFFD)
043303 FD7700              A 10908    	LD	(IY+%0),A
                           A 10909    ; 3538		fs->id = ++Fsid;		/* Volume m
                           A 10910    .LINE 3538
                           A 10911    
043306 ED4B C9 4F 04       A 10912    	LD	BC,(_Fsid)
04330B 03                  A 10913    	INC	BC
04330C 21 C9 4F 04         A 10914    	LD	HL,_Fsid
043310 71                  A 10915    	LD	(HL),C
043311 23                  A 10916    	INC	HL
043312 70                  A 10917    	LD	(HL),B
043313 ED4B C9 4F 04       A 10918    	LD	BC,(_Fsid)
043318 FD7105              A 10919    	LD	(IY+%5),C
04331B FD7006              A 10920    	LD	(IY+%6),B
                           A 10921    ; 3539	#if FF_USE_LFN == 1
                           A 10922    ; 3540		fs->lfnbuf = LfnBuf;	/* Static L
                           A 10923    ; 3541	#if FF_FS_EXFAT
                           A 10924    ; 3542		fs->dirbuf = DirBuf;	/* Static d
                           A 10925    ; 3543	#endif
                           A 10926    ; 3544	#endif
                           A 10927    ; 3545	#if FF_FS_RPATH != 0
                           A 10928    ; 3546		fs->cdir = 0;			/* Initiali
                           A 10929    .LINE 3546
                           A 10930    
04331E 01000000            A 10931    	LD	BC,0
043322 FD0F0E              A 10932    	LD	(IY+%E),BC
043325 FD361100            A 10933    	LD	(IY+%11),%0
                           A 10934    ; 3547	#endif
                           A 10935    ; 3548	#if FF_FS_LOCK != 0			/* Clear fi
                           A 10936    ; 3549		clear_lock(fs);
                           A 10937    ; 3550	#endif
                           A 10938    ; 3551		return FR_OK;
                           A 10939    .LINE 3551
                           A 10940    
043329 B7                  A 10941    	OR	A,A
04332A ED62                A 10942    	SBC	HL,HL
                           A 10943    ; 3552	}
04332C                     A 10944    L_529:
                           A 10945    .LINE 3552
                           A 10946    
04332C DDF9                A 10947    	LD	SP,IX
04332E DDE1                A 10948    	POP	IX
043330 C9                  A 10949    	RET	
                           A 10950    
                           A 10951    
                           A 10952    ;**************************** _mount_volume ***
                           A 10953    ;Name                         Addr/Register   S
                           A 10954    ;_Fsid                               STATIC    
                           A 10955    ;_disk_initialize                    IMPORT  --
                           A 10956    ;_disk_status                        IMPORT  --
                           A 10957    ;_FatFs                              STATIC    
                           A 10958    ;szbfat                               IX-56    
                           A 10959    ;temp520                              IX-52    
                           A 10960    ;G_40                                 IX-48    
                           A 10961    ;bsect                                IX-45    
                           A 10962    ;G_39                                 IX-41    
                           A 10963    ;sysect                               IX-38    
                           A 10964    ;tsect                                IX-34    
                           A 10965    ;vol                                  IX-30    
                           A 10966    ;G_38                                 IX-27    
                           A 10967    ;nrsv                                 IX-24    
                           A 10968    ;nclst                                IX-22    
                           A 10969    ;G_36                                 IX-18    
                           A 10970    ;G_33                                 IX-17    
                           A 10971    ;G_37                                 IX-14    
                           A 10972    ;stat                                 IX-12    
                           A 10973    ;G_35                                 IX-11    
                           A 10974    ;fasize                               IX-10    
                           A 10975    ;fmt                                   IX-6    
                           A 10976    ;fs                                    IX-3    
                           A 10977    ;mode                                 IX+12    
                           A 10978    ;rfs                                   IX+9    
                           A 10979    ;path                                  IX+6    
                           A 10980    
                           A 10981    
                           A 10982    ; Stack Frame Size: 87 (bytes)
                           A 10983    ;       Spill Code: -1 (instruction)
                           A 10984    
                           A 10985    
                           A 10986    .ENDFUNC "mount_volume",3552,"_mount_volume"
                           A 10987    ; 3553	
                           A 10988    ; 3554	
                           A 10989    ; 3555	
                           A 10990    ; 3556	
                           A 10991    ; 3557	/*-------------------------------------
                           A 10992    ; 3558	/* Check if the file/directory object i
                           A 10993    ; 3559	/*-------------------------------------
                           A 10994    ; 3560	
                           A 10995    ; 3561	static FRESULT validate (	/* Returns 
                           A 10996    ; 3562		FFOBJID* obj,			/* Pointer 
                           A 10997    ; 3563		FATFS** rfs				/* Pointer 
                           A 10998    ; 3564	)
                           A 10999    ; 3565	{
043331                     A 11000    _validate:
                           A 11001    .DEFINE "_validate"
                           A 11002    
                           A 11003    .VALUE _validate
                           A 11004    
                           A 11005    .CLASS 3
                           A 11006    
                           A 11007    .TYPE 68
                           A 11008    
                           A 11009    .ENDEF
                           A 11010    
                           A 11011    .BEGFUNC "validate",3565,"_validate"
                           A 11012    
                           A 11013    .LINE 3565
                           A 11014    
                           A 11015    .DEFINE "obj"
                           A 11016    
                           A 11017    .CLASS 65
                           A 11018    
                           A 11019    .VALUE 6
                           A 11020    
                           A 11021    .TAG "NONAME1"
                           A 11022    
                           A 11023    .TYPE 40
                           A 11024    
                           A 11025    .ENDEF
                           A 11026    
                           A 11027    .DEFINE "rfs"
                           A 11028    
                           A 11029    .CLASS 65
                           A 11030    
                           A 11031    .VALUE 9
                           A 11032    
                           A 11033    .TAG "NONAME0"
                           A 11034    
                           A 11035    .TYPE 296
                           A 11036    
                           A 11037    .ENDEF
                           A 11038    
                           A 11039    .DEFINE "res"
                           A 11040    
                           A 11041    .CLASS 65
                           A 11042    
                           A 11043    .VALUE -6
                           A 11044    
                           A 11045    .TYPE 4
                           A 11046    
                           A 11047    .ENDEF
                           A 11048    
043331 DDE5                A 11049    	PUSH	IX
043333 DD210000 00         A 11050    	LD	IX,0
043338 DD39                A 11051    	ADD	IX,SP
04333A C5                  A 11052    	PUSH	BC
04333B C5                  A 11053    	PUSH	BC
04333C C5                  A 11054    	PUSH	BC
                           A 11055    ; 3566		FRESULT res = FR_INVALID_OBJECT;
                           A 11056    .LINE 3566
                           A 11057    
04333D 01090000            A 11058    	LD	BC,9
043341 DD0FFA              A 11059    	LD	(IX+%FFFFFFFA),BC
                           A 11060    ; 3567	
                           A 11061    ; 3568	
                           A 11062    ; 3569		if (obj && obj->fs && obj->fs->fs_t
                           A 11063    .LINE 3569
                           A 11064    
043344 DD2706              A 11065    	LD	HL,(IX+%6)
043347 CD E5 46 04         A 11066    	CALL	__icmpzero
04334B 28 45               A 11067    	JR	Z,L_539
04334D DD3106              A 11068    	LD	IY,(IX+%6)
043350 FD0700              A 11069    	LD	BC,(IY+%0)
043353 DD0FFD              A 11070    	LD	(IX+%FFFFFFFD),BC
043356 C5E1                A 11071    	LD	HL,BC
043358 CD E5 46 04         A 11072    	CALL	__icmpzero
04335C 28 34               A 11073    	JR	Z,L_539
04335E DD31FD              A 11074    	LD	IY,(IX+%FFFFFFFD)
043361 FD7E00              A 11075    	LD	A,(IY+%0)
043364 B7                  A 11076    	OR	A,A
043365 28 2B               A 11077    	JR	Z,L_539
043367 DD31FD              A 11078    	LD	IY,(IX+%FFFFFFFD)
04336A FD0705              A 11079    	LD	BC,(IY+%5)
04336D DD3106              A 11080    	LD	IY,(IX+%6)
043370 FD2703              A 11081    	LD	HL,(IY+%3)
043373 B7                  A 11082    	OR	A,A
043374 40ED42              A 11083    	SBC.SIS	HL,BC
043377 20 19               A 11084    	JR	NZ,L_539
                           A 11085    ; 3570	#if FF_FS_REENTRANT
                           A 11086    ; 3571			if (lock_fs(obj->fs)) {	/* Obta
                           A 11087    ; 3572				if (!(disk_status(obj->fs->
                           A 11088    ; 3573					res = FR_OK;
                           A 11089    ; 3574				} else {
                           A 11090    ; 3575					unlock_fs(obj->fs, FR_O
                           A 11091    ; 3576				}
                           A 11092    ; 3577			} else {
                           A 11093    ; 3578				res = FR_TIMEOUT;
                           A 11094    ; 3579			}
                           A 11095    ; 3580	#else
                           A 11096    ; 3581			if (!(disk_status(obj->fs->pdrv
                           A 11097    .LINE 3581
                           A 11098    
043379 DD31FD              A 11099    	LD	IY,(IX+%FFFFFFFD)
04337C FD4E01              A 11100    	LD	C,(IY+%1)
04337F 0600                A 11101    	LD	B,%0
043381 C5                  A 11102    	PUSH	BC
043382 CD D1 3E 04         A 11103    	CALL	_disk_status
043386 C1                  A 11104    	POP	BC
043387 E601                A 11105    	AND	A,%1
043389 20 07               A 11106    	JR	NZ,L_539
                           A 11107    ; 3582				res = FR_OK;
                           A 11108    .LINE 3582
                           A 11109    
04338B 01000000            A 11110    	LD	BC,0
04338F DD0FFA              A 11111    	LD	(IX+%FFFFFFFA),BC
                           A 11112    ; 3583			}
                           A 11113    ; 3584	#endif
                           A 11114    ; 3585		}
043392                     A 11115    L_539:
                           A 11116    .LINE 3585
                           A 11117    
                           A 11118    ; 3586		*rfs = (res == FR_OK) ? obj->fs : 0
                           A 11119    .LINE 3586
                           A 11120    
043392 DD27FA              A 11121    	LD	HL,(IX+%FFFFFFFA)
043395 CD E5 46 04         A 11122    	CALL	__icmpzero
043399 20 0B               A 11123    	JR	NZ,L_537
04339B DD3106              A 11124    	LD	IY,(IX+%6)
04339E FD0700              A 11125    	LD	BC,(IY+%0)
0433A1 DD0FF7              A 11126    	LD	(IX+%FFFFFFF7),BC
0433A4 18 07               A 11127    	JR	L_538
0433A6                     A 11128    L_537:
0433A6 01000000            A 11129    	LD	BC,0
0433AA DD0FF7              A 11130    	LD	(IX+%FFFFFFF7),BC
0433AD                     A 11131    L_538:
0433AD DD2709              A 11132    	LD	HL,(IX+%9)
0433B0 DD07F7              A 11133    	LD	BC,(IX+%FFFFFFF7)
0433B3 ED0F                A 11134    	LD	(HL),BC
                           A 11135    ; 3587		return res;
                           A 11136    .LINE 3587
                           A 11137    
0433B5 DD27FA              A 11138    	LD	HL,(IX+%FFFFFFFA)
                           A 11139    ; 3588	}
                           A 11140    .LINE 3588
                           A 11141    
0433B8 DDF9                A 11142    	LD	SP,IX
0433BA DDE1                A 11143    	POP	IX
0433BC C9                  A 11144    	RET	
                           A 11145    
                           A 11146    
                           A 11147    ;**************************** _validate *******
                           A 11148    ;Name                         Addr/Register   S
                           A 11149    ;_disk_status                        IMPORT  --
                           A 11150    ;temp535                               IX-9    
                           A 11151    ;res                                   IX-6    
                           A 11152    ;G_41                                  IX-3    
                           A 11153    ;rfs                                   IX+9    
                           A 11154    ;obj                                   IX+6    
                           A 11155    
                           A 11156    
                           A 11157    ; Stack Frame Size: 21 (bytes)
                           A 11158    ;       Spill Code: -1 (instruction)
                           A 11159    
                           A 11160    
                           A 11161    .ENDFUNC "validate",3588,"_validate"
                           A 11162    ; 3589	
                           A 11163    ; 3590	
                           A 11164    ; 3591	
                           A 11165    ; 3592	
                           A 11166    ; 3593	/*-------------------------------------
                           A 11167    ; 3594	
                           A 11168    ; 3595	   Public Functions (FatFs API)
                           A 11169    ; 3596	
                           A 11170    ; 3597	---------------------------------------
                           A 11171    ; 3598	
                           A 11172    ; 3599	
                           A 11173    ; 3600	
                           A 11174    ; 3601	/*-------------------------------------
                           A 11175    ; 3602	/* Mount/Unmount a Logical Drive       
                           A 11176    ; 3603	/*-------------------------------------
                           A 11177    ; 3604	
                           A 11178    ; 3605	FRESULT f_mount (
                           A 11179    ; 3606		FATFS* fs,			/* Pointer to t
                           A 11180    ; 3607		const TCHAR* path,	/* Logical driv
                           A 11181    ; 3608		BYTE opt			/* Mount option
                           A 11182    ; 3609	)
                           A 11183    ; 3610	{
0433BD                     A 11184    _f_mount:
                           A 11185    .DEFINE "_f_mount"
                           A 11186    
                           A 11187    .VALUE _f_mount
                           A 11188    
                           A 11189    .CLASS 2
                           A 11190    
                           A 11191    .TYPE 68
                           A 11192    
                           A 11193    .ENDEF
                           A 11194    
                           A 11195    .BEGFUNC "f_mount",3610,"_f_mount"
                           A 11196    
                           A 11197    .LINE 3610
                           A 11198    
                           A 11199    .DEFINE "fs"
                           A 11200    
                           A 11201    .CLASS 65
                           A 11202    
                           A 11203    .VALUE 6
                           A 11204    
                           A 11205    .TAG "NONAME0"
                           A 11206    
                           A 11207    .TYPE 40
                           A 11208    
                           A 11209    .ENDEF
                           A 11210    
                           A 11211    .DEFINE "path"
                           A 11212    
                           A 11213    .CLASS 65
                           A 11214    
                           A 11215    .VALUE 9
                           A 11216    
                           A 11217    .TYPE 194
                           A 11218    
                           A 11219    .ENDEF
                           A 11220    
                           A 11221    .DEFINE "opt"
                           A 11222    
                           A 11223    .CLASS 65
                           A 11224    
                           A 11225    .VALUE 12
                           A 11226    
                           A 11227    .TYPE 12
                           A 11228    
                           A 11229    .ENDEF
                           A 11230    
                           A 11231    .DEFINE "cfs"
                           A 11232    
                           A 11233    .CLASS 65
                           A 11234    
                           A 11235    .VALUE -3
                           A 11236    
                           A 11237    .TAG "NONAME0"
                           A 11238    
                           A 11239    .TYPE 40
                           A 11240    
                           A 11241    .ENDEF
                           A 11242    
                           A 11243    .DEFINE "vol"
                           A 11244    
                           A 11245    .CLASS 65
                           A 11246    
                           A 11247    .VALUE -6
                           A 11248    
                           A 11249    .TYPE 4
                           A 11250    
                           A 11251    .ENDEF
                           A 11252    
                           A 11253    .DEFINE "res"
                           A 11254    
                           A 11255    .CLASS 65
                           A 11256    
                           A 11257    .VALUE -12
                           A 11258    
                           A 11259    .TYPE 4
                           A 11260    
                           A 11261    .ENDEF
                           A 11262    
                           A 11263    .DEFINE "rp"
                           A 11264    
                           A 11265    .CLASS 65
                           A 11266    
                           A 11267    .VALUE -15
                           A 11268    
                           A 11269    .TYPE 194
                           A 11270    
                           A 11271    .ENDEF
                           A 11272    
0433BD DDE5                A 11273    	PUSH	IX
0433BF DD210000 00         A 11274    	LD	IX,0
0433C4 DD39                A 11275    	ADD	IX,SP
0433C6 ED22F1              A 11276    	LEA	HL,IX+%FFFFFFF1
0433C9 F9                  A 11277    	LD	SP,HL
                           A 11278    ; 3611		FATFS *cfs;
                           A 11279    ; 3612		int vol;
                           A 11280    ; 3613		FRESULT res;
                           A 11281    ; 3614		const TCHAR *rp = path;
                           A 11282    .LINE 3614
                           A 11283    
0433CA DD0709              A 11284    	LD	BC,(IX+%9)
0433CD DD0FF1              A 11285    	LD	(IX+%FFFFFFF1),BC
                           A 11286    ; 3615	
                           A 11287    ; 3616	
                           A 11288    ; 3617		/* Get logical drive number */
                           A 11289    ; 3618		vol = get_ldnumber(&rp);
                           A 11290    .LINE 3618
                           A 11291    
0433D0 ED65F1              A 11292    	PEA	IX+%FFFFFFF1
0433D3 CD DE 29 04         A 11293    	CALL	_get_ldnumber
0433D7 C1                  A 11294    	POP	BC
0433D8 DD2FFA              A 11295    	LD	(IX+%FFFFFFFA),HL
                           A 11296    ; 3619		if (vol < 0) return FR_INVALID_DRIV
                           A 11297    .LINE 3619
                           A 11298    
0433DB CD E5 46 04         A 11299    	CALL	__icmpzero
0433DF F2 E9 33 04         A 11300    	JP	P,L_542
0433E3 210B0000            A 11301    	LD	HL,11
0433E7 18 5B               A 11302    	JR	L_549
0433E9                     A 11303    L_542:
                           A 11304    ; 3620		cfs = FatFs[vol];					
                           A 11305    .LINE 3620
                           A 11306    
0433E9 DD27FA              A 11307    	LD	HL,(IX+%FFFFFFFA)
0433EC E5C1                A 11308    	LD	BC,HL
0433EE 29                  A 11309    	ADD	HL,HL
0433EF 09                  A 11310    	ADD	HL,BC
0433F0 01 C6 4F 04         A 11311    	LD	BC,_FatFs
0433F4 09                  A 11312    	ADD	HL,BC
0433F5 DD2FF7              A 11313    	LD	(IX+%FFFFFFF7),HL
0433F8 ED07                A 11314    	LD	BC,(HL)
0433FA DD0FFD              A 11315    	LD	(IX+%FFFFFFFD),BC
                           A 11316    ; 3621	
                           A 11317    ; 3622		if (cfs) {
                           A 11318    .LINE 3622
                           A 11319    
0433FD C5E1                A 11320    	LD	HL,BC
0433FF CD E5 46 04         A 11321    	CALL	__icmpzero
043403 28 07               A 11322    	JR	Z,L_545
                           A 11323    ; 3623	#if FF_FS_LOCK != 0
                           A 11324    ; 3624			clear_lock(cfs);
                           A 11325    ; 3625	#endif
                           A 11326    ; 3626	#if FF_FS_REENTRANT						
                           A 11327    ; 3627			if (!ff_del_syncobj(cfs->sobj))
                           A 11328    ; 3628	#endif
                           A 11329    ; 3629			cfs->fs_type = 0;				
                           A 11330    .LINE 3629
                           A 11331    
043405 DD31FD              A 11332    	LD	IY,(IX+%FFFFFFFD)
043408 FD360000            A 11333    	LD	(IY+%0),%0
                           A 11334    ; 3630		}
04340C                     A 11335    L_545:
                           A 11336    .LINE 3630
                           A 11337    
                           A 11338    ; 3631	
                           A 11339    ; 3632		if (fs) {
                           A 11340    .LINE 3632
                           A 11341    
04340C DD2706              A 11342    	LD	HL,(IX+%6)
04340F CD E5 46 04         A 11343    	CALL	__icmpzero
043413 28 07               A 11344    	JR	Z,L_546
                           A 11345    ; 3633			fs->fs_type = 0;				
                           A 11346    .LINE 3633
                           A 11347    
043415 DD3106              A 11348    	LD	IY,(IX+%6)
043418 FD360000            A 11349    	LD	(IY+%0),%0
                           A 11350    ; 3634	#if FF_FS_REENTRANT						
                           A 11351    ; 3635			if (!ff_cre_syncobj((BYTE)vol, 
                           A 11352    ; 3636	#endif
                           A 11353    ; 3637		}
04341C                     A 11354    L_546:
                           A 11355    .LINE 3637
                           A 11356    
                           A 11357    ; 3638		FatFs[vol] = fs;					
                           A 11358    .LINE 3638
                           A 11359    
04341C DD27F7              A 11360    	LD	HL,(IX+%FFFFFFF7)
04341F DD0706              A 11361    	LD	BC,(IX+%6)
043422 ED0F                A 11362    	LD	(HL),BC
                           A 11363    ; 3639	
                           A 11364    ; 3640		if (opt == 0) return FR_OK;			
                           A 11365    .LINE 3640
                           A 11366    
043424 DD7E0C              A 11367    	LD	A,(IX+%C)
043427 B7                  A 11368    	OR	A,A
043428 20 05               A 11369    	JR	NZ,L_548
04342A B7                  A 11370    	OR	A,A
04342B ED62                A 11371    	SBC	HL,HL
04342D 18 15               A 11372    	JR	L_549
04342F                     A 11373    L_548:
                           A 11374    ; 3641	
                           A 11375    ; 3642		res = mount_volume(&path, &fs, 0);	
                           A 11376    .LINE 3642
                           A 11377    
04342F 01000000            A 11378    	LD	BC,0
043433 C5                  A 11379    	PUSH	BC
043434 ED6506              A 11380    	PEA	IX+%6
043437 ED6509              A 11381    	PEA	IX+%9
04343A CD E9 2D 04         A 11382    	CALL	_mount_volume
04343E C1                  A 11383    	POP	BC
04343F C1                  A 11384    	POP	BC
043440 C1                  A 11385    	POP	BC
043441 DD2FF4              A 11386    	LD	(IX+%FFFFFFF4),HL
                           A 11387    ; 3643		LEAVE_FF(fs, res);
                           A 11388    .LINE 3643
                           A 11389    
                           A 11390    ; 3644	}
043444                     A 11391    L_549:
                           A 11392    .LINE 3644
                           A 11393    
043444 DDF9                A 11394    	LD	SP,IX
043446 DDE1                A 11395    	POP	IX
043448 C9                  A 11396    	RET	
                           A 11397    
                           A 11398    
                           A 11399    ;**************************** _f_mount ********
                           A 11400    ;Name                         Addr/Register   S
                           A 11401    ;_FatFs                              STATIC    
                           A 11402    ;rp                                   IX-15    
                           A 11403    ;res                                  IX-12    
                           A 11404    ;G_44                                  IX-9    
                           A 11405    ;vol                                   IX-6    
                           A 11406    ;cfs                                   IX-3    
                           A 11407    ;opt                                  IX+12    
                           A 11408    ;path                                  IX+9    
                           A 11409    ;fs                                    IX+6    
                           A 11410    
                           A 11411    
                           A 11412    ; Stack Frame Size: 30 (bytes)
                           A 11413    ;       Spill Code: -1 (instruction)
                           A 11414    
                           A 11415    
                           A 11416    .ENDFUNC "f_mount",3644,"_f_mount"
                           A 11417    ; 3645	
                           A 11418    ; 3646	
                           A 11419    ; 3647	
                           A 11420    ; 3648	
                           A 11421    ; 3649	/*-------------------------------------
                           A 11422    ; 3650	/* Open or Create a File               
                           A 11423    ; 3651	/*-------------------------------------
                           A 11424    ; 3652	
                           A 11425    ; 3653	FRESULT f_open (
                           A 11426    ; 3654		FIL* fp,			/* Pointer to t
                           A 11427    ; 3655		const TCHAR* path,	/* Pointer to t
                           A 11428    ; 3656		BYTE mode			/* Access mode 
                           A 11429    ; 3657	)
                           A 11430    ; 3658	{
043449                     A 11431    _f_open:
                           A 11432    .DEFINE "_f_open"
                           A 11433    
                           A 11434    .VALUE _f_open
                           A 11435    
                           A 11436    .CLASS 2
                           A 11437    
                           A 11438    .TYPE 68
                           A 11439    
                           A 11440    .ENDEF
                           A 11441    
                           A 11442    .BEGFUNC "f_open",3658,"_f_open"
                           A 11443    
                           A 11444    .LINE 3658
                           A 11445    
                           A 11446    .DEFINE "fp"
                           A 11447    
                           A 11448    .CLASS 65
                           A 11449    
                           A 11450    .VALUE 6
                           A 11451    
                           A 11452    .TAG "NONAME2"
                           A 11453    
                           A 11454    .TYPE 40
                           A 11455    
                           A 11456    .ENDEF
                           A 11457    
                           A 11458    .DEFINE "path"
                           A 11459    
                           A 11460    .CLASS 65
                           A 11461    
                           A 11462    .VALUE 9
                           A 11463    
                           A 11464    .TYPE 194
                           A 11465    
                           A 11466    .ENDEF
                           A 11467    
                           A 11468    .DEFINE "mode"
                           A 11469    
                           A 11470    .CLASS 65
                           A 11471    
                           A 11472    .VALUE 12
                           A 11473    
                           A 11474    .TYPE 12
                           A 11475    
                           A 11476    .ENDEF
                           A 11477    
                           A 11478    .DEFINE "res"
                           A 11479    
                           A 11480    .CLASS 65
                           A 11481    
                           A 11482    .VALUE -3
                           A 11483    
                           A 11484    .TYPE 4
                           A 11485    
                           A 11486    .ENDEF
                           A 11487    
                           A 11488    .DEFINE "fs"
                           A 11489    
                           A 11490    .CLASS 65
                           A 11491    
                           A 11492    .VALUE -6
                           A 11493    
                           A 11494    .TAG "NONAME0"
                           A 11495    
                           A 11496    .TYPE 40
                           A 11497    
                           A 11498    .ENDEF
                           A 11499    
                           A 11500    .DEFINE "dj"
                           A 11501    
                           A 11502    .CLASS 65
                           A 11503    
                           A 11504    .VALUE -52
                           A 11505    
                           A 11506    .TAG "NONAME3"
                           A 11507    
                           A 11508    .TYPE 8
                           A 11509    
                           A 11510    .ENDEF
                           A 11511    
                           A 11512    .DEFINE "lbuf"
                           A 11513    
                           A 11514    .CLASS 65
                           A 11515    
                           A 11516    .VALUE -564
                           A 11517    
                           A 11518    .DIM 256
                           A 11519    
                           A 11520    .TYPE 109
                           A 11521    
                           A 11522    .ENDEF
                           A 11523    
043449 DDE5                A 11524    	PUSH	IX
04344B DD210000 00         A 11525    	LD	IX,0
043450 DD39                A 11526    	ADD	IX,SP
043452 21C3FDFF            A 11527    	LD	HL,-573
043456 39                  A 11528    	ADD	HL,SP
043457 F9                  A 11529    	LD	SP,HL
                           A 11530    ; 3659		FRESULT res;
                           A 11531    ; 3660		DIR dj;
                           A 11532    ; 3661		FATFS *fs;
                           A 11533    ; 3662	#if !FF_FS_READONLY
                           A 11534    ; 3663		DWORD cl, bcs, clst, tm;
                           A 11535    ; 3664		LBA_t sc;
                           A 11536    ; 3665		FSIZE_t ofs;
                           A 11537    ; 3666	#endif
                           A 11538    ; 3667		DEF_NAMBUF
                           A 11539    ; 3668	
                           A 11540    ; 3669	
                           A 11541    ; 3670		if (!fp) return FR_INVALID_OBJECT;
                           A 11542    .LINE 3670
                           A 11543    
043458 DD2706              A 11544    	LD	HL,(IX+%6)
04345B CD E5 46 04         A 11545    	CALL	__icmpzero
04345F 20 08               A 11546    	JR	NZ,L_551
043461 21090000            A 11547    	LD	HL,9
043465 C3 94 35 04         A 11548    	JR	L_563
043469                     A 11549    L_551:
                           A 11550    ; 3671	
                           A 11551    ; 3672		/* Get logical drive number */
                           A 11552    ; 3673		mode &= FF_FS_READONLY ? FA_READ : 
                           A 11553    .LINE 3673
                           A 11554    
043469 DD7E0C              A 11555    	LD	A,(IX+%C)
04346C E601                A 11556    	AND	A,%1
04346E DD770C              A 11557    	LD	(IX+%C),A
                           A 11558    ; 3674		res = mount_volume(&path, &fs, mode
                           A 11559    .LINE 3674
                           A 11560    
043471 DD4E0C              A 11561    	LD	C,(IX+%C)
043474 0600                A 11562    	LD	B,%0
043476 C5                  A 11563    	PUSH	BC
043477 ED65FA              A 11564    	PEA	IX+%FFFFFFFA
04347A ED6509              A 11565    	PEA	IX+%9
04347D CD E9 2D 04         A 11566    	CALL	_mount_volume
043481 C1                  A 11567    	POP	BC
043482 C1                  A 11568    	POP	BC
043483 C1                  A 11569    	POP	BC
043484 DD2FFD              A 11570    	LD	(IX+%FFFFFFFD),HL
                           A 11571    ; 3675		if (res == FR_OK) {
                           A 11572    .LINE 3675
                           A 11573    
043487 CD E5 46 04         A 11574    	CALL	__icmpzero
04348B C2 7E 35 04         A 11575    	JR	NZ,L_561
                           A 11576    ; 3676			dj.obj.fs = fs;
                           A 11577    .LINE 3676
                           A 11578    
04348F DD07FA              A 11579    	LD	BC,(IX+%FFFFFFFA)
043492 DD0FCC              A 11580    	LD	(IX+%FFFFFFCC),BC
                           A 11581    ; 3677			INIT_NAMBUF(fs);
                           A 11582    .LINE 3677
                           A 11583    
043495 DDE5E1              A 11584    	LD	HL,IX
043498 01CCFDFF            A 11585    	LD	BC,-564
04349C 09                  A 11586    	ADD	HL,BC
04349D DD31FA              A 11587    	LD	IY,(IX+%FFFFFFFA)
0434A0 FD2F0B              A 11588    	LD	(IY+%B),HL
                           A 11589    ; 3678			res = follow_path(&dj, path);	
                           A 11590    .LINE 3678
                           A 11591    
0434A3 DD0709              A 11592    	LD	BC,(IX+%9)
0434A6 C5                  A 11593    	PUSH	BC
0434A7 ED65CC              A 11594    	PEA	IX+%FFFFFFCC
0434AA CD 55 28 04         A 11595    	CALL	_follow_path
0434AE C1                  A 11596    	POP	BC
0434AF C1                  A 11597    	POP	BC
0434B0 DD2FFD              A 11598    	LD	(IX+%FFFFFFFD),HL
                           A 11599    ; 3679	#if !FF_FS_READONLY	/* Read/Write confi
                           A 11600    ; 3680			if (res == FR_OK) {
                           A 11601    ; 3681				if (dj.fn[NSFLAG] & NS_NONA
                           A 11602    ; 3682					res = FR_INVALID_NAME;
                           A 11603    ; 3683				}
                           A 11604    ; 3684	#if FF_FS_LOCK != 0
                           A 11605    ; 3685				else {
                           A 11606    ; 3686					res = chk_lock(&dj, (mo
                           A 11607    ; 3687				}
                           A 11608    ; 3688	#endif
                           A 11609    ; 3689			}
                           A 11610    ; 3690			/* Create or Open a file */
                           A 11611    ; 3691			if (mode & (FA_CREATE_ALWAYS | 
                           A 11612    ; 3692				if (res != FR_OK) {			
                           A 11613    ; 3693					if (res == FR_NO_FILE) 
                           A 11614    ; 3694	#if FF_FS_LOCK != 0
                           A 11615    ; 3695						res = enq_lock() ? 
                           A 11616    ; 3696	#else
                           A 11617    ; 3697						res = dir_register(
                           A 11618    ; 3698	#endif
                           A 11619    ; 3699					}
                           A 11620    ; 3700					mode |= FA_CREATE_ALWAY
                           A 11621    ; 3701				}
                           A 11622    ; 3702				else {						
                           A 11623    ; 3703					if (dj.obj.attr & (AM_R
                           A 11624    ; 3704						res = FR_DENIED;
                           A 11625    ; 3705					} else {
                           A 11626    ; 3706						if (mode & FA_CREAT
                           A 11627    ; 3707					}
                           A 11628    ; 3708				}
                           A 11629    ; 3709				if (res == FR_OK && (mode &
                           A 11630    ; 3710	#if FF_FS_EXFAT
                           A 11631    ; 3711					if (fs->fs_type == FS_E
                           A 11632    ; 3712						/* Get current allo
                           A 11633    ; 3713						fp->obj.fs = fs;
                           A 11634    ; 3714						init_alloc_info(fs,
                           A 11635    ; 3715						/* Set directory en
                           A 11636    ; 3716						memset(fs->dirbuf +
                           A 11637    ; 3717						memset(fs->dirbuf +
                           A 11638    ; 3718						fs->dirbuf[XDIR_Att
                           A 11639    ; 3719						st_dword(fs->dirbuf
                           A 11640    ; 3720						fs->dirbuf[XDIR_Gen
                           A 11641    ; 3721						res = store_xdir(&d
                           A 11642    ; 3722						if (res == FR_OK &&
                           A 11643    ; 3723							res = remove_ch
                           A 11644    ; 3724							fs->last_clst =
                           A 11645    ; 3725						}
                           A 11646    ; 3726					} else
                           A 11647    ; 3727	#endif
                           A 11648    ; 3728					{
                           A 11649    ; 3729						/* Set directory en
                           A 11650    ; 3730						tm = GET_FATTIME();
                           A 11651    ; 3731						st_dword(dj.dir + D
                           A 11652    ; 3732						st_dword(dj.dir + D
                           A 11653    ; 3733						cl = ld_clust(fs, d
                           A 11654    ; 3734						dj.dir[DIR_Attr] = 
                           A 11655    ; 3735						st_clust(fs, dj.dir
                           A 11656    ; 3736						st_dword(dj.dir + D
                           A 11657    ; 3737						fs->wflag = 1;
                           A 11658    ; 3738						if (cl != 0) {		
                           A 11659    ; 3739							sc = fs->winsec
                           A 11660    ; 3740							res = remove_ch
                           A 11661    ; 3741							if (res == FR_O
                           A 11662    ; 3742								res = move_
                           A 11663    ; 3743								fs->last_cl
                           A 11664    ; 3744							}
                           A 11665    ; 3745						}
                           A 11666    ; 3746					}
                           A 11667    ; 3747				}
                           A 11668    ; 3748			}
                           A 11669    ; 3749			else {	/* Open an existing fil
                           A 11670    ; 3750				if (res == FR_OK) {			
                           A 11671    ; 3751					if (dj.obj.attr & AM_DI
                           A 11672    ; 3752						res = FR_NO_FILE;
                           A 11673    ; 3753					} else {
                           A 11674    ; 3754						if ((mode & FA_WRIT
                           A 11675    ; 3755							res = FR_DENIED
                           A 11676    ; 3756						}
                           A 11677    ; 3757					}
                           A 11678    ; 3758				}
                           A 11679    ; 3759			}
                           A 11680    ; 3760			if (res == FR_OK) {
                           A 11681    ; 3761				if (mode & FA_CREATE_ALWAYS
                           A 11682    ; 3762				fp->dir_sect = fs->winsect;
                           A 11683    ; 3763				fp->dir_ptr = dj.dir;
                           A 11684    ; 3764	#if FF_FS_LOCK != 0
                           A 11685    ; 3765				fp->obj.lockid = inc_lock(&
                           A 11686    ; 3766				if (fp->obj.lockid == 0) re
                           A 11687    ; 3767	#endif
                           A 11688    ; 3768			}
                           A 11689    ; 3769	#else		/* R/O configuration */
                           A 11690    ; 3770			if (res == FR_OK) {
                           A 11691    .LINE 3770
                           A 11692    
0434B3 CD E5 46 04         A 11693    	CALL	__icmpzero
0434B7 20 21               A 11694    	JR	NZ,L_557
                           A 11695    ; 3771				if (dj.fn[NSFLAG] & NS_NONA
                           A 11696    .LINE 3771
                           A 11697    
0434B9 ED55EA              A 11698    	LEA	IY,IX+%FFFFFFEA
0434BC FD7E0B              A 11699    	LD	A,(IY+%B)
0434BF E680                A 11700    	AND	A,%80
0434C1 28 09               A 11701    	JR	Z,L_554
                           A 11702    ; 3772					res = FR_INVALID_NAME;
                           A 11703    .LINE 3772
                           A 11704    
0434C3 01060000            A 11705    	LD	BC,6
0434C7 DD0FFD              A 11706    	LD	(IX+%FFFFFFFD),BC
                           A 11707    ; 3773				} else {
                           A 11708    .LINE 3773
                           A 11709    
0434CA 18 0E               A 11710    	JR	L_557
0434CC                     A 11711    L_554:
                           A 11712    ; 3774					if (dj.obj.attr & AM_DI
                           A 11713    .LINE 3774
                           A 11714    
0434CC DD7ED1              A 11715    	LD	A,(IX+%FFFFFFD1)
0434CF E610                A 11716    	AND	A,%10
0434D1 28 07               A 11717    	JR	Z,L_557
                           A 11718    ; 3775						res = FR_NO_FILE;
                           A 11719    .LINE 3775
                           A 11720    
0434D3 01040000            A 11721    	LD	BC,4
0434D7 DD0FFD              A 11722    	LD	(IX+%FFFFFFFD),BC
                           A 11723    ; 3776					}
                           A 11724    ; 3777				}
                           A 11725    ; 3778			}
0434DA                     A 11726    L_557:
                           A 11727    .LINE 3778
                           A 11728    
                           A 11729    ; 3779	#endif
                           A 11730    ; 3780	
                           A 11731    ; 3781			if (res == FR_OK) {
                           A 11732    .LINE 3781
                           A 11733    
0434DA DD27FD              A 11734    	LD	HL,(IX+%FFFFFFFD)
0434DD CD E5 46 04         A 11735    	CALL	__icmpzero
0434E1 C2 7E 35 04         A 11736    	JR	NZ,L_558
                           A 11737    ; 3782	#if FF_FS_EXFAT
                           A 11738    ; 3783				if (fs->fs_type == FS_EXFAT
                           A 11739    ; 3784					fp->obj.c_scl = dj.obj.
                           A 11740    ; 3785					fp->obj.c_size = ((DWOR
                           A 11741    ; 3786					fp->obj.c_ofs = dj.blk_
                           A 11742    ; 3787					init_alloc_info(fs, &fp
                           A 11743    ; 3788				} else
                           A 11744    ; 3789	#endif
                           A 11745    ; 3790				{
                           A 11746    ; 3791					fp->obj.sclust = ld_clu
                           A 11747    .LINE 3791
                           A 11748    
0434E5 DD3106              A 11749    	LD	IY,(IX+%6)
0434E8 ED2300              A 11750    	LEA	HL,IY+%0
0434EB 01C9FDFF            A 11751    	LD	BC,-567
0434EF CD 43 45 04         A 11752    	CALL	__istix
0434F3 DD07E7              A 11753    	LD	BC,(IX+%FFFFFFE7)
0434F6 C5                  A 11754    	PUSH	BC
0434F7 DD07FA              A 11755    	LD	BC,(IX+%FFFFFFFA)
0434FA C5                  A 11756    	PUSH	BC
0434FB CD CC 18 04         A 11757    	CALL	_ld_clust
0434FF C1                  A 11758    	POP	BC
043500 C1                  A 11759    	POP	BC
043501 DD3106              A 11760    	LD	IY,(IX+%6)
043504 FD2F07              A 11761    	LD	(IY+%7),HL
043507 FD730A              A 11762    	LD	(IY+%A),E
                           A 11763    ; 3792					fp->obj.objsize = ld_dw
                           A 11764    .LINE 3792
                           A 11765    
04350A DD31E7              A 11766    	LD	IY,(IX+%FFFFFFE7)
04350D ED031C              A 11767    	LEA	BC,IY+%1C
043510 C5                  A 11768    	PUSH	BC
043511 CD 61 0F 04         A 11769    	CALL	_ld_dword
043515 C1                  A 11770    	POP	BC
043516 01C3FDFF            A 11771    	LD	BC,-573	; spill
04351A CD 43 45 04         A 11772    	CALL	__istix
04351E 01C9FDFF            A 11773    	LD	BC,-567
043522 CD 93 48 04         A 11774    	CALL	__ildix
043526 E5FDE1              A 11775    	LD	IY,HL
043529 01C3FDFF            A 11776    	LD	BC,-573	; unspill
04352D CD 93 48 04         A 11777    	CALL	__ildix
043531 FD2F0B              A 11778    	LD	(IY+%B),HL
043534 FD730E              A 11779    	LD	(IY+%E),E
                           A 11780    ; 3793				}
                           A 11781    ; 3794	#if FF_USE_FASTSEEK
                           A 11782    ; 3795				fp->cltbl = 0;		/* Disa
                           A 11783    ; 3796	#endif
                           A 11784    ; 3797				fp->obj.fs = fs;	/* Vali
                           A 11785    .LINE 3797
                           A 11786    
043537 01C9FDFF            A 11787    	LD	BC,-567
04353B CD 93 48 04         A 11788    	CALL	__ildix
04353F DD07FA              A 11789    	LD	BC,(IX+%FFFFFFFA)
043542 E5FDE1              A 11790    	LD	IY,HL
043545 FD0F00              A 11791    	LD	(IY+%0),BC
                           A 11792    ; 3798				fp->obj.id = fs->id;
                           A 11793    .LINE 3798
                           A 11794    
043548 01C9FDFF            A 11795    	LD	BC,-567
04354C CD 93 48 04         A 11796    	CALL	__ildix
043550 DD31FA              A 11797    	LD	IY,(IX+%FFFFFFFA)
043553 FD0705              A 11798    	LD	BC,(IY+%5)
043556 E5FDE1              A 11799    	LD	IY,HL
043559 FD7103              A 11800    	LD	(IY+%3),C
04355C FD7004              A 11801    	LD	(IY+%4),B
                           A 11802    ; 3799				fp->flag = mode;	/* Set 
                           A 11803    .LINE 3799
                           A 11804    
04355F DD7E0C              A 11805    	LD	A,(IX+%C)
043562 DD3106              A 11806    	LD	IY,(IX+%6)
043565 FD770F              A 11807    	LD	(IY+%F),A
                           A 11808    ; 3800				fp->err = 0;		/* Clea
                           A 11809    .LINE 3800
                           A 11810    
043568 FD361000            A 11811    	LD	(IY+%10),%0
                           A 11812    ; 3801				fp->sect = 0;		/* Inva
                           A 11813    .LINE 3801
                           A 11814    
04356C 01000000            A 11815    	LD	BC,0
043570 FD0F19              A 11816    	LD	(IY+%19),BC
043573 FD361C00            A 11817    	LD	(IY+%1C),%0
                           A 11818    ; 3802				fp->fptr = 0;		/* Set 
                           A 11819    .LINE 3802
                           A 11820    
043577 FD0F11              A 11821    	LD	(IY+%11),BC
04357A FD361400            A 11822    	LD	(IY+%14),%0
                           A 11823    ; 3803	#if !FF_FS_READONLY
                           A 11824    ; 3804	#if !FF_FS_TINY
                           A 11825    ; 3805				memset(fp->buf, 0, sizeof f
                           A 11826    ; 3806	#endif
                           A 11827    ; 3807				if ((mode & FA_SEEKEND) && 
                           A 11828    ; 3808					fp->fptr = fp->obj.objs
                           A 11829    ; 3809					bcs = (DWORD)fs->csize 
                           A 11830    ; 3810					clst = fp->obj.sclust;	
                           A 11831    ; 3811					for (ofs = fp->obj.objs
                           A 11832    ; 3812						clst = get_fat(&fp-
                           A 11833    ; 3813						if (clst <= 1) res 
                           A 11834    ; 3814						if (clst == 0xFFFFF
                           A 11835    ; 3815					}
                           A 11836    ; 3816					fp->clust = clst;
                           A 11837    ; 3817					if (res == FR_OK && ofs
                           A 11838    ; 3818						sc = clst2sect(fs, 
                           A 11839    ; 3819						if (sc == 0) {
                           A 11840    ; 3820							res = FR_INT_ER
                           A 11841    ; 3821						} else {
                           A 11842    ; 3822							fp->sect = sc +
                           A 11843    ; 3823	#if !FF_FS_TINY
                           A 11844    ; 3824							if (disk_read(f
                           A 11845    ; 3825	#endif
                           A 11846    ; 3826						}
                           A 11847    ; 3827					}
                           A 11848    ; 3828	#if FF_FS_LOCK != 0
                           A 11849    ; 3829					if (res != FR_OK) dec_l
                           A 11850    ; 3830	#endif
                           A 11851    ; 3831				}
                           A 11852    ; 3832	#endif
                           A 11853    ; 3833			}
04357E                     A 11854    L_558:
                           A 11855    .LINE 3833
                           A 11856    
                           A 11857    ; 3834	
                           A 11858    ; 3835			FREE_NAMBUF();
                           A 11859    ; 3836		}
04357E                     A 11860    L_561:
                           A 11861    .LINE 3836
                           A 11862    
                           A 11863    ; 3837	
                           A 11864    ; 3838		if (res != FR_OK) fp->obj.fs = 0;	
                           A 11865    .LINE 3838
                           A 11866    
04357E DD27FD              A 11867    	LD	HL,(IX+%FFFFFFFD)
043581 CD E5 46 04         A 11868    	CALL	__icmpzero
043585 28 0A               A 11869    	JR	Z,L_562
043587 01000000            A 11870    	LD	BC,0
04358B DD3106              A 11871    	LD	IY,(IX+%6)
04358E FD0F00              A 11872    	LD	(IY+%0),BC
043591                     A 11873    L_562:
                           A 11874    ; 3839	
                           A 11875    ; 3840		LEAVE_FF(fs, res);
                           A 11876    .LINE 3840
                           A 11877    
043591 DD27FD              A 11878    	LD	HL,(IX+%FFFFFFFD)
                           A 11879    ; 3841	}
043594                     A 11880    L_563:
                           A 11881    .LINE 3841
                           A 11882    
043594 DDF9                A 11883    	LD	SP,IX
043596 DDE1                A 11884    	POP	IX
043598 C9                  A 11885    	RET	
                           A 11886    
                           A 11887    
                           A 11888    ;**************************** _f_open *********
                           A 11889    ;Name                         Addr/Register   S
                           A 11890    ;lbuf                                IX-564    
                           A 11891    ;dj                                   IX-52    
                           A 11892    ;fs                                    IX-6    
                           A 11893    ;res                                   IX-3    
                           A 11894    ;mode                                 IX+12    
                           A 11895    ;path                                  IX+9    
                           A 11896    ;fp                                    IX+6    
                           A 11897    
                           A 11898    
                           A 11899    ; Stack Frame Size: 588 (bytes)
                           A 11900    ;       Spill Code: -1 (instruction)
                           A 11901    
                           A 11902    
                           A 11903    .ENDFUNC "f_open",3841,"_f_open"
                           A 11904    ; 3842	
                           A 11905    ; 3843	
                           A 11906    ; 3844	
                           A 11907    ; 3845	
                           A 11908    ; 3846	/*-------------------------------------
                           A 11909    ; 3847	/* Read File                           
                           A 11910    ; 3848	/*-------------------------------------
                           A 11911    ; 3849	
                           A 11912    ; 3850	FRESULT f_read (
                           A 11913    ; 3851		FIL* fp, 	/* Open file to be read
                           A 11914    ; 3852		void* buff,	/* Data buffer to store
                           A 11915    ; 3853		UINT btr,	/* Number of bytes to r
                           A 11916    ; 3854		UINT* br	/* Number of bytes read
                           A 11917    ; 3855	)
                           A 11918    ; 3856	{
043599                     A 11919    _f_read:
                           A 11920    .DEFINE "_f_read"
                           A 11921    
                           A 11922    .VALUE _f_read
                           A 11923    
                           A 11924    .CLASS 2
                           A 11925    
                           A 11926    .TYPE 68
                           A 11927    
                           A 11928    .ENDEF
                           A 11929    
                           A 11930    .BEGFUNC "f_read",3856,"_f_read"
                           A 11931    
                           A 11932    .LINE 3856
                           A 11933    
                           A 11934    .DEFINE "fp"
                           A 11935    
                           A 11936    .CLASS 65
                           A 11937    
                           A 11938    .VALUE 6
                           A 11939    
                           A 11940    .TAG "NONAME2"
                           A 11941    
                           A 11942    .TYPE 40
                           A 11943    
                           A 11944    .ENDEF
                           A 11945    
                           A 11946    .DEFINE "buff"
                           A 11947    
                           A 11948    .CLASS 65
                           A 11949    
                           A 11950    .VALUE 9
                           A 11951    
                           A 11952    .TYPE 33
                           A 11953    
                           A 11954    .ENDEF
                           A 11955    
                           A 11956    .DEFINE "btr"
                           A 11957    
                           A 11958    .CLASS 65
                           A 11959    
                           A 11960    .VALUE 12
                           A 11961    
                           A 11962    .TYPE 14
                           A 11963    
                           A 11964    .ENDEF
                           A 11965    
                           A 11966    .DEFINE "br"
                           A 11967    
                           A 11968    .CLASS 65
                           A 11969    
                           A 11970    .VALUE 15
                           A 11971    
                           A 11972    .TYPE 46
                           A 11973    
                           A 11974    .ENDEF
                           A 11975    
                           A 11976    .DEFINE "rcnt"
                           A 11977    
                           A 11978    .CLASS 65
                           A 11979    
                           A 11980    .VALUE -3
                           A 11981    
                           A 11982    .TYPE 14
                           A 11983    
                           A 11984    .ENDEF
                           A 11985    
                           A 11986    .DEFINE "sect"
                           A 11987    
                           A 11988    .CLASS 65
                           A 11989    
                           A 11990    .VALUE -7
                           A 11991    
                           A 11992    .TYPE 15
                           A 11993    
                           A 11994    .ENDEF
                           A 11995    
                           A 11996    .DEFINE "fs"
                           A 11997    
                           A 11998    .CLASS 65
                           A 11999    
                           A 12000    .VALUE -10
                           A 12001    
                           A 12002    .TAG "NONAME0"
                           A 12003    
                           A 12004    .TYPE 40
                           A 12005    
                           A 12006    .ENDEF
                           A 12007    
                           A 12008    .DEFINE "cc"
                           A 12009    
                           A 12010    .CLASS 65
                           A 12011    
                           A 12012    .VALUE -13
                           A 12013    
                           A 12014    .TYPE 14
                           A 12015    
                           A 12016    .ENDEF
                           A 12017    
                           A 12018    .DEFINE "res"
                           A 12019    
                           A 12020    .CLASS 65
                           A 12021    
                           A 12022    .VALUE -16
                           A 12023    
                           A 12024    .TYPE 4
                           A 12025    
                           A 12026    .ENDEF
                           A 12027    
                           A 12028    .DEFINE "csect"
                           A 12029    
                           A 12030    .CLASS 65
                           A 12031    
                           A 12032    .VALUE -19
                           A 12033    
                           A 12034    .TYPE 14
                           A 12035    
                           A 12036    .ENDEF
                           A 12037    
                           A 12038    .DEFINE "rbuff"
                           A 12039    
                           A 12040    .CLASS 65
                           A 12041    
                           A 12042    .VALUE -22
                           A 12043    
                           A 12044    .TYPE 44
                           A 12045    
                           A 12046    .ENDEF
                           A 12047    
                           A 12048    .DEFINE "clst"
                           A 12049    
                           A 12050    .CLASS 65
                           A 12051    
                           A 12052    .VALUE -26
                           A 12053    
                           A 12054    .TYPE 15
                           A 12055    
                           A 12056    .ENDEF
                           A 12057    
                           A 12058    .DEFINE "remain"
                           A 12059    
                           A 12060    .CLASS 65
                           A 12061    
                           A 12062    .VALUE -34
                           A 12063    
                           A 12064    .TYPE 15
                           A 12065    
                           A 12066    .ENDEF
                           A 12067    
043599 DDE5                A 12068    	PUSH	IX
04359B DD210000 00         A 12069    	LD	IX,0
0435A0 DD39                A 12070    	ADD	IX,SP
0435A2 ED22D6              A 12071    	LEA	HL,IX+%FFFFFFD6
0435A5 F9                  A 12072    	LD	SP,HL
                           A 12073    ; 3857		FRESULT res;
                           A 12074    ; 3858		FATFS *fs;
                           A 12075    ; 3859		DWORD clst;
                           A 12076    ; 3860		LBA_t sect;
                           A 12077    ; 3861		FSIZE_t remain;
                           A 12078    ; 3862		UINT rcnt, cc, csect;
                           A 12079    ; 3863		BYTE *rbuff = (BYTE*)buff;
                           A 12080    .LINE 3863
                           A 12081    
0435A6 DD0709              A 12082    	LD	BC,(IX+%9)
0435A9 DD0FEA              A 12083    	LD	(IX+%FFFFFFEA),BC
                           A 12084    ; 3864	
                           A 12085    ; 3865	
                           A 12086    ; 3866		*br = 0;	/* Clear read byte coun
                           A 12087    .LINE 3866
                           A 12088    
0435AC DD270F              A 12089    	LD	HL,(IX+%F)
0435AF 01000000            A 12090    	LD	BC,0
0435B3 ED0F                A 12091    	LD	(HL),BC
                           A 12092    ; 3867		res = validate(&fp->obj, &fs);		
                           A 12093    .LINE 3867
                           A 12094    
0435B5 ED65F6              A 12095    	PEA	IX+%FFFFFFF6
0435B8 DD3106              A 12096    	LD	IY,(IX+%6)
0435BB ED6600              A 12097    	PEA	IY+%0
0435BE CD 31 33 04         A 12098    	CALL	_validate
0435C2 C1                  A 12099    	POP	BC
0435C3 C1                  A 12100    	POP	BC
0435C4 DD2FF0              A 12101    	LD	(IX+%FFFFFFF0),HL
                           A 12102    ; 3868		if (res != FR_OK || (res = (FRESULT
                           A 12103    .LINE 3868
                           A 12104    
0435C7 CD E5 46 04         A 12105    	CALL	__icmpzero
0435CB 20 13               A 12106    	JR	NZ,L_565
0435CD DD3106              A 12107    	LD	IY,(IX+%6)
0435D0 FD7E10              A 12108    	LD	A,(IY+%10)
0435D3 B7ED62              A 12109    	UEXT	HL
0435D6 6F                  A 12110    	LD	L,A
0435D7 DD2FF0              A 12111    	LD	(IX+%FFFFFFF0),HL
0435DA CD E5 46 04         A 12112    	CALL	__icmpzero
0435DE 28 07               A 12113    	JR	Z,L_567
0435E0                     A 12114    L_565:
0435E0 DD27F0              A 12115    	LD	HL,(IX+%FFFFFFF0)
0435E3 C3 02 39 04         A 12116    	JR	L_600
0435E7                     A 12117    L_567:
                           A 12118    ; 3869		if (!(fp->flag & FA_READ)) LEAVE_FF
                           A 12119    .LINE 3869
                           A 12120    
0435E7 DD3106              A 12121    	LD	IY,(IX+%6)
0435EA FD7E0F              A 12122    	LD	A,(IY+%F)
0435ED E601                A 12123    	AND	A,%1
0435EF 20 08               A 12124    	JR	NZ,L_568
0435F1 21070000            A 12125    	LD	HL,7
0435F5 C3 02 39 04         A 12126    	JR	L_600
0435F9                     A 12127    L_568:
                           A 12128    ; 3870		remain = fp->obj.objsize - fp->fptr
                           A 12129    .LINE 3870
                           A 12130    
0435F9 DD3106              A 12131    	LD	IY,(IX+%6)
0435FC FD270B              A 12132    	LD	HL,(IY+%B)
0435FF FD5E0E              A 12133    	LD	E,(IY+%E)
043602 FD0711              A 12134    	LD	BC,(IY+%11)
043605 FD7E14              A 12135    	LD	A,(IY+%14)
043608 CD 7B 46 04         A 12136    	CALL	__lsub
04360C DD2FDE              A 12137    	LD	(IX+%FFFFFFDE),HL
04360F DD73E1              A 12138    	LD	(IX+%FFFFFFE1),E
                           A 12139    ; 3871		if (btr > remain) btr = (UINT)remai
                           A 12140    .LINE 3871
                           A 12141    
043612 DD070C              A 12142    	LD	BC,(IX+%C)
043615 AF                  A 12143    	XOR	A,A
043616 DD27DE              A 12144    	LD	HL,(IX+%FFFFFFDE)
043619 DD5EE1              A 12145    	LD	E,(IX+%FFFFFFE1)
04361C CD 88 47 04         A 12146    	CALL	__lcmpu
043620 D2 F2 38 04         A 12147    	JR	NC,L_597
043624 DD07DE              A 12148    	LD	BC,(IX+%FFFFFFDE)
043627 DD0F0C              A 12149    	LD	(IX+%C),BC
                           A 12150    ; 3872	
                           A 12151    ; 3873		for ( ; btr > 0; btr -= rcnt, *br +
                           A 12152    .LINE 3873
                           A 12153    
04362A C3 F2 38 04         A 12154    	JR	L_597
04362E                     A 12155    L_595:
                           A 12156    ; 3874			if (fp->fptr % SS(fs) == 0) {	
                           A 12157    .LINE 3874
                           A 12158    
04362E DD3106              A 12159    	LD	IY,(IX+%6)
043631 FD0711              A 12160    	LD	BC,(IY+%11)
043634 FD7E14              A 12161    	LD	A,(IY+%14)
043637 DD0FE2              A 12162    	LD	(IX+%FFFFFFE2),BC
04363A DD77E5              A 12163    	LD	(IX+%FFFFFFE5),A
04363D C5E1                A 12164    	LD	HL,BC
04363F DD5EE5              A 12165    	LD	E,(IX+%FFFFFFE5)
043642 01FF0100            A 12166    	LD	BC,511
043646 AF                  A 12167    	XOR	A,A
043647 CD B4 48 04         A 12168    	CALL	__land
04364B CD B8 45 04         A 12169    	CALL	__lcmpzero
04364F C2 53 38 04         A 12170    	JR	NZ,L_592
                           A 12171    ; 3875				csect = (UINT)(fp->fptr / S
                           A 12172    .LINE 3875
                           A 12173    
043653 DD31F6              A 12174    	LD	IY,(IX+%FFFFFFF6)
043656 FD0709              A 12175    	LD	BC,(IY+%9)
043659 CD 73 45 04         A 12176    	CALL	__stoiu
04365D 2B                  A 12177    	DEC	HL
04365E E5C1                A 12178    	LD	BC,HL
043660 CD 81 47 04         A 12179    	CALL	__itol
043664 DD0FD7              A 12180    	LD	(IX+%FFFFFFD7),BC
043667 5F                  A 12181    	LD	E,A
043668 DD07E2              A 12182    	LD	BC,(IX+%FFFFFFE2)
04366B DD7EE5              A 12183    	LD	A,(IX+%FFFFFFE5)
04366E 2E09                A 12184    	LD	L,%9
043670 CD 87 46 04         A 12185    	CALL	__lshru
043674 DD27D7              A 12186    	LD	HL,(IX+%FFFFFFD7)
043677 CD B4 48 04         A 12187    	CALL	__land
04367B DD2FED              A 12188    	LD	(IX+%FFFFFFED),HL
                           A 12189    ; 3876				if (csect == 0) {			
                           A 12190    .LINE 3876
                           A 12191    
04367E CD E5 46 04         A 12192    	CALL	__icmpzero
043682 C2 11 37 04         A 12193    	JR	NZ,L_578
                           A 12194    ; 3877					if (fp->fptr == 0) {	
                           A 12195    .LINE 3877
                           A 12196    
043686 DD27E2              A 12197    	LD	HL,(IX+%FFFFFFE2)
043689 DD5EE5              A 12198    	LD	E,(IX+%FFFFFFE5)
04368C CD B8 45 04         A 12199    	CALL	__lcmpzero
043690 20 11               A 12200    	JR	NZ,L_571
                           A 12201    ; 3878						clst = fp->obj.sclu
                           A 12202    .LINE 3878
                           A 12203    
043692 DD3106              A 12204    	LD	IY,(IX+%6)
043695 FD0707              A 12205    	LD	BC,(IY+%7)
043698 FD7E0A              A 12206    	LD	A,(IY+%A)
04369B DD0FE6              A 12207    	LD	(IX+%FFFFFFE6),BC
04369E DD77E9              A 12208    	LD	(IX+%FFFFFFE9),A
                           A 12209    ; 3879					} else {				
                           A 12210    .LINE 3879
                           A 12211    
0436A1 18 1E               A 12212    	JR	L_573
0436A3                     A 12213    L_571:
                           A 12214    ; 3880	#if FF_USE_FASTSEEK
                           A 12215    ; 3881						if (fp->cltbl) {
                           A 12216    ; 3882							clst = clmt_clu
                           A 12217    ; 3883						} else
                           A 12218    ; 3884	#endif
                           A 12219    ; 3885						{
                           A 12220    ; 3886							clst = get_fat(
                           A 12221    .LINE 3886
                           A 12222    
0436A3 DD3106              A 12223    	LD	IY,(IX+%6)
0436A6 FD0715              A 12224    	LD	BC,(IY+%15)
0436A9 FD7E18              A 12225    	LD	A,(IY+%18)
0436AC 2600                A 12226    	LD	H,%0
0436AE 6F                  A 12227    	LD	L,A
0436AF E5                  A 12228    	PUSH	HL
0436B0 C5                  A 12229    	PUSH	BC
0436B1 ED6600              A 12230    	PEA	IY+%0
0436B4 CD 67 12 04         A 12231    	CALL	_get_fat
0436B8 C1                  A 12232    	POP	BC
0436B9 C1                  A 12233    	POP	BC
0436BA C1                  A 12234    	POP	BC
0436BB DD2FE6              A 12235    	LD	(IX+%FFFFFFE6),HL
0436BE DD73E9              A 12236    	LD	(IX+%FFFFFFE9),E
                           A 12237    ; 3887						}
                           A 12238    ; 3888					}
0436C1                     A 12239    L_573:
                           A 12240    .LINE 3888
                           A 12241    
                           A 12242    ; 3889					if (clst < 2) ABORT(fs,
                           A 12243    .LINE 3889
                           A 12244    
0436C1 DD27E6              A 12245    	LD	HL,(IX+%FFFFFFE6)
0436C4 DD5EE9              A 12246    	LD	E,(IX+%FFFFFFE9)
0436C7 01020000            A 12247    	LD	BC,2
0436CB AF                  A 12248    	XOR	A,A
0436CC CD 88 47 04         A 12249    	CALL	__lcmpu
0436D0 30 0F               A 12250    	JR	NC,L_574
0436D2 DD3106              A 12251    	LD	IY,(IX+%6)
0436D5 FD361002            A 12252    	LD	(IY+%10),%2
0436D9 21020000            A 12253    	LD	HL,2
0436DD C3 02 39 04         A 12254    	JR	L_600
0436E1                     A 12255    L_574:
                           A 12256    ; 3890					if (clst == 0xFFFFFFFF)
                           A 12257    .LINE 3890
                           A 12258    
0436E1 DD27E6              A 12259    	LD	HL,(IX+%FFFFFFE6)
0436E4 DD5EE9              A 12260    	LD	E,(IX+%FFFFFFE9)
0436E7 01FFFFFF            A 12261    	LD	BC,16777215
0436EB 3EFF                A 12262    	LD	A,%FF
0436ED CD 88 47 04         A 12263    	CALL	__lcmpu
0436F1 20 0F               A 12264    	JR	NZ,L_576
0436F3 DD3106              A 12265    	LD	IY,(IX+%6)
0436F6 FD361001            A 12266    	LD	(IY+%10),%1
0436FA 21010000            A 12267    	LD	HL,1
0436FE C3 02 39 04         A 12268    	JR	L_600
043702                     A 12269    L_576:
                           A 12270    ; 3891					fp->clust = clst;		
                           A 12271    .LINE 3891
                           A 12272    
043702 DD07E6              A 12273    	LD	BC,(IX+%FFFFFFE6)
043705 DD7EE9              A 12274    	LD	A,(IX+%FFFFFFE9)
043708 DD3106              A 12275    	LD	IY,(IX+%6)
04370B FD0F15              A 12276    	LD	(IY+%15),BC
04370E FD7718              A 12277    	LD	(IY+%18),A
                           A 12278    ; 3892				}
043711                     A 12279    L_578:
                           A 12280    .LINE 3892
                           A 12281    
                           A 12282    ; 3893				sect = clst2sect(fs, fp->cl
                           A 12283    .LINE 3893
                           A 12284    
043711 DD3106              A 12285    	LD	IY,(IX+%6)
043714 FD0715              A 12286    	LD	BC,(IY+%15)
043717 FD7E18              A 12287    	LD	A,(IY+%18)
04371A 2600                A 12288    	LD	H,%0
04371C 6F                  A 12289    	LD	L,A
04371D E5                  A 12290    	PUSH	HL
04371E C5                  A 12291    	PUSH	BC
04371F DD07F6              A 12292    	LD	BC,(IX+%FFFFFFF6)
043722 C5                  A 12293    	PUSH	BC
043723 CD FC 11 04         A 12294    	CALL	_clst2sect
043727 C1                  A 12295    	POP	BC
043728 C1                  A 12296    	POP	BC
043729 C1                  A 12297    	POP	BC
04372A DD2FF9              A 12298    	LD	(IX+%FFFFFFF9),HL
04372D DD73FC              A 12299    	LD	(IX+%FFFFFFFC),E
                           A 12300    ; 3894				if (sect == 0) ABORT(fs, FR
                           A 12301    .LINE 3894
                           A 12302    
043730 DD27F9              A 12303    	LD	HL,(IX+%FFFFFFF9)
043733 DD5EFC              A 12304    	LD	E,(IX+%FFFFFFFC)
043736 CD B8 45 04         A 12305    	CALL	__lcmpzero
04373A 20 0F               A 12306    	JR	NZ,L_580
04373C DD3106              A 12307    	LD	IY,(IX+%6)
04373F FD361002            A 12308    	LD	(IY+%10),%2
043743 21020000            A 12309    	LD	HL,2
043747 C3 02 39 04         A 12310    	JR	L_600
04374B                     A 12311    L_580:
                           A 12312    ; 3895				sect += csect;
                           A 12313    .LINE 3895
                           A 12314    
04374B DD07ED              A 12315    	LD	BC,(IX+%FFFFFFED)
04374E AF                  A 12316    	XOR	A,A
04374F DD27F9              A 12317    	LD	HL,(IX+%FFFFFFF9)
043752 DD5EFC              A 12318    	LD	E,(IX+%FFFFFFFC)
043755 CD A5 44 04         A 12319    	CALL	__ladd
043759 DD2FF9              A 12320    	LD	(IX+%FFFFFFF9),HL
04375C DD73FC              A 12321    	LD	(IX+%FFFFFFFC),E
                           A 12322    ; 3896				cc = btr / SS(fs);			
                           A 12323    .LINE 3896
                           A 12324    
04375F DD270C              A 12325    	LD	HL,(IX+%C)
043762 3E09                A 12326    	LD	A,%9
043764 CD 5C 47 04         A 12327    	CALL	__ishru_b
043768 DD2FF3              A 12328    	LD	(IX+%FFFFFFF3),HL
                           A 12329    ; 3897				if (cc > 0) {				
                           A 12330    .LINE 3897
                           A 12331    
04376B E5C1                A 12332    	LD	BC,HL
04376D B7                  A 12333    	OR	A,A
04376E ED62                A 12334    	SBC	HL,HL
043770 B7                  A 12335    	OR	A,A
043771 ED42                A 12336    	SBC	HL,BC
043773 30 78               A 12337    	JR	NC,L_589
                           A 12338    ; 3898					if (csect + cc > fs->cs
                           A 12339    .LINE 3898
                           A 12340    
043775 DD31F6              A 12341    	LD	IY,(IX+%FFFFFFF6)
043778 FD0709              A 12342    	LD	BC,(IY+%9)
04377B CD 73 45 04         A 12343    	CALL	__stoiu
04377F E5C1                A 12344    	LD	BC,HL
043781 DD17F3              A 12345    	LD	DE,(IX+%FFFFFFF3)
043784 DD27ED              A 12346    	LD	HL,(IX+%FFFFFFED)
043787 19                  A 12347    	ADD	HL,DE
043788 E5D1                A 12348    	LD	DE,HL
04378A C5E1                A 12349    	LD	HL,BC
04378C B7                  A 12350    	OR	A,A
04378D ED52                A 12351    	SBC	HL,DE
04378F 30 13               A 12352    	JR	NC,L_583
                           A 12353    ; 3899						cc = fs->csize - cs
                           A 12354    .LINE 3899
                           A 12355    
043791 DD31F6              A 12356    	LD	IY,(IX+%FFFFFFF6)
043794 FD0709              A 12357    	LD	BC,(IY+%9)
043797 CD 73 45 04         A 12358    	CALL	__stoiu
04379B DD07ED              A 12359    	LD	BC,(IX+%FFFFFFED)
04379E B7                  A 12360    	OR	A,A
04379F ED42                A 12361    	SBC	HL,BC
0437A1 DD2FF3              A 12362    	LD	(IX+%FFFFFFF3),HL
                           A 12363    ; 3900					}
0437A4                     A 12364    L_583:
                           A 12365    .LINE 3900
                           A 12366    
                           A 12367    ; 3901					if (disk_read(fs->pdrv,
                           A 12368    .LINE 3901
                           A 12369    
0437A4 DD07F3              A 12370    	LD	BC,(IX+%FFFFFFF3)
0437A7 C5                  A 12371    	PUSH	BC
0437A8 DD4EFC              A 12372    	LD	C,(IX+%FFFFFFFC)
0437AB 0600                A 12373    	LD	B,%0
0437AD C5                  A 12374    	PUSH	BC
0437AE DD07F9              A 12375    	LD	BC,(IX+%FFFFFFF9)
0437B1 C5                  A 12376    	PUSH	BC
0437B2 DD07EA              A 12377    	LD	BC,(IX+%FFFFFFEA)
0437B5 C5                  A 12378    	PUSH	BC
0437B6 DD31F6              A 12379    	LD	IY,(IX+%FFFFFFF6)
0437B9 FD4E01              A 12380    	LD	C,(IY+%1)
0437BC 0600                A 12381    	LD	B,%0
0437BE C5                  A 12382    	PUSH	BC
0437BF CD FE 3E 04         A 12383    	CALL	_disk_read
0437C3 C1                  A 12384    	POP	BC
0437C4 C1                  A 12385    	POP	BC
0437C5 C1                  A 12386    	POP	BC
0437C6 C1                  A 12387    	POP	BC
0437C7 C1                  A 12388    	POP	BC
0437C8 CD E5 46 04         A 12389    	CALL	__icmpzero
0437CC 28 0F               A 12390    	JR	Z,L_584
0437CE DD3106              A 12391    	LD	IY,(IX+%6)
0437D1 FD361001            A 12392    	LD	(IY+%10),%1
0437D5 21010000            A 12393    	LD	HL,1
0437D9 C3 02 39 04         A 12394    	JR	L_600
0437DD                     A 12395    L_584:
                           A 12396    ; 3902	#if !FF_FS_READONLY && FF_FS_MINIMIZE <
                           A 12397    ; 3903	#if FF_FS_TINY
                           A 12398    ; 3904					if (fs->wflag && fs->wi
                           A 12399    ; 3905						memcpy(rbuff + ((fs
                           A 12400    ; 3906					}
                           A 12401    ; 3907	#else
                           A 12402    ; 3908					if ((fp->flag & FA_DIRT
                           A 12403    ; 3909						memcpy(rbuff + ((fp
                           A 12404    ; 3910					}
                           A 12405    ; 3911	#endif
                           A 12406    ; 3912	#endif
                           A 12407    ; 3913					rcnt = SS(fs) * cc;		
                           A 12408    .LINE 3913
                           A 12409    
0437DD DD27F3              A 12410    	LD	HL,(IX+%FFFFFFF3)
0437E0 3E09                A 12411    	LD	A,%9
0437E2 CD 30 48 04         A 12412    	CALL	__ishl_b
0437E6 DD2FFD              A 12413    	LD	(IX+%FFFFFFFD),HL
                           A 12414    ; 3914					continue;
                           A 12415    .LINE 3914
                           A 12416    
0437E9 C3 B6 38 04         A 12417    	JR	L_596
                           A 12418    ; 3915				}
0437ED                     A 12419    L_589:
                           A 12420    .LINE 3915
                           A 12421    
                           A 12422    ; 3916	#if !FF_FS_TINY
                           A 12423    ; 3917				if (fp->sect != sect) {		
                           A 12424    .LINE 3917
                           A 12425    
0437ED DD3106              A 12426    	LD	IY,(IX+%6)
0437F0 FD2719              A 12427    	LD	HL,(IY+%19)
0437F3 FD5E1C              A 12428    	LD	E,(IY+%1C)
0437F6 DD07F9              A 12429    	LD	BC,(IX+%FFFFFFF9)
0437F9 DD7EFC              A 12430    	LD	A,(IX+%FFFFFFFC)
0437FC CD 88 47 04         A 12431    	CALL	__lcmpu
043800 28 42               A 12432    	JR	Z,L_590
                           A 12433    ; 3918	#if !FF_FS_READONLY
                           A 12434    ; 3919					if (fp->flag & FA_DIRTY
                           A 12435    ; 3920						if (disk_write(fs->
                           A 12436    ; 3921						fp->flag &= (BYTE)~
                           A 12437    ; 3922					}
                           A 12438    ; 3923	#endif
                           A 12439    ; 3924					if (disk_read(fs->pdrv,
                           A 12440    .LINE 3924
                           A 12441    
043802 01010000            A 12442    	LD	BC,1
043806 C5                  A 12443    	PUSH	BC
043807 DD4EFC              A 12444    	LD	C,(IX+%FFFFFFFC)
04380A 0600                A 12445    	LD	B,%0
04380C C5                  A 12446    	PUSH	BC
04380D DD07F9              A 12447    	LD	BC,(IX+%FFFFFFF9)
043810 C5                  A 12448    	PUSH	BC
043811 DD3106              A 12449    	LD	IY,(IX+%6)
043814 ED661D              A 12450    	PEA	IY+%1D
043817 DD31F6              A 12451    	LD	IY,(IX+%FFFFFFF6)
04381A FD4E01              A 12452    	LD	C,(IY+%1)
04381D 0600                A 12453    	LD	B,%0
04381F C5                  A 12454    	PUSH	BC
043820 DD77D6              A 12455    	LD	(IX+%FFFFFFD6),A
043823 CD FE 3E 04         A 12456    	CALL	_disk_read
043827 DD7ED6              A 12457    	LD	A,(IX+%FFFFFFD6)
04382A C1                  A 12458    	POP	BC
04382B C1                  A 12459    	POP	BC
04382C C1                  A 12460    	POP	BC
04382D C1                  A 12461    	POP	BC
04382E C1                  A 12462    	POP	BC
04382F CD E5 46 04         A 12463    	CALL	__icmpzero
043833 28 0F               A 12464    	JR	Z,L_590
043835 DD3106              A 12465    	LD	IY,(IX+%6)
043838 FD361001            A 12466    	LD	(IY+%10),%1
04383C 21010000            A 12467    	LD	HL,1
043840 C3 02 39 04         A 12468    	JR	L_600
                           A 12469    ; 3925				}
043844                     A 12470    L_590:
                           A 12471    .LINE 3925
                           A 12472    
                           A 12473    ; 3926	#endif
                           A 12474    ; 3927				fp->sect = sect;
                           A 12475    .LINE 3927
                           A 12476    
043844 DD07F9              A 12477    	LD	BC,(IX+%FFFFFFF9)
043847 DD56FC              A 12478    	LD	D,(IX+%FFFFFFFC)
04384A DD3106              A 12479    	LD	IY,(IX+%6)
04384D FD0F19              A 12480    	LD	(IY+%19),BC
043850 FD721C              A 12481    	LD	(IY+%1C),D
                           A 12482    ; 3928			}
043853                     A 12483    L_592:
                           A 12484    .LINE 3928
                           A 12485    
                           A 12486    ; 3929			rcnt = SS(fs) - (UINT)fp->fptr 
                           A 12487    .LINE 3929
                           A 12488    
043853 DD3106              A 12489    	LD	IY,(IX+%6)
043856 FD0711              A 12490    	LD	BC,(IY+%11)
043859 FD5614              A 12491    	LD	D,(IY+%14)
04385C DD0FDA              A 12492    	LD	(IX+%FFFFFFDA),BC
04385F DD72DD              A 12493    	LD	(IX+%FFFFFFDD),D
043862 C5E1                A 12494    	LD	HL,BC
043864 01FF0100            A 12495    	LD	BC,511
043868 CD F4 47 04         A 12496    	CALL	__iand
04386C E5C1                A 12497    	LD	BC,HL
04386E 21000200            A 12498    	LD	HL,512
043872 B7                  A 12499    	OR	A,A
043873 ED42                A 12500    	SBC	HL,BC
043875 DD2FFD              A 12501    	LD	(IX+%FFFFFFFD),HL
                           A 12502    ; 3930			if (rcnt > btr) rcnt = btr;		
                           A 12503    .LINE 3930
                           A 12504    
043878 E5C1                A 12505    	LD	BC,HL
04387A DD270C              A 12506    	LD	HL,(IX+%C)
04387D B7                  A 12507    	OR	A,A
04387E ED42                A 12508    	SBC	HL,BC
043880 30 06               A 12509    	JR	NC,L_594
043882 DD070C              A 12510    	LD	BC,(IX+%C)
043885 DD0FFD              A 12511    	LD	(IX+%FFFFFFFD),BC
043888                     A 12512    L_594:
                           A 12513    ; 3931	#if FF_FS_TINY
                           A 12514    ; 3932			if (move_window(fs, fp->sect) !
                           A 12515    ; 3933			memcpy(rbuff, fs->win + fp->fpt
                           A 12516    ; 3934	#else
                           A 12517    ; 3935			memcpy(rbuff, fp->buf + fp->fpt
                           A 12518    .LINE 3935
                           A 12519    
043888 DD07FD              A 12520    	LD	BC,(IX+%FFFFFFFD)
04388B C5                  A 12521    	PUSH	BC
04388C DD27DA              A 12522    	LD	HL,(IX+%FFFFFFDA)
04388F DD5EDD              A 12523    	LD	E,(IX+%FFFFFFDD)
043892 01FF0100            A 12524    	LD	BC,511
043896 AF                  A 12525    	XOR	A,A
043897 CD B4 48 04         A 12526    	CALL	__land
04389B E5C1                A 12527    	LD	BC,HL
04389D DD3106              A 12528    	LD	IY,(IX+%6)
0438A0 ED231D              A 12529    	LEA	HL,IY+%1D
0438A3 09                  A 12530    	ADD	HL,BC
0438A4 E5                  A 12531    	PUSH	HL
0438A5 DD07EA              A 12532    	LD	BC,(IX+%FFFFFFEA)
0438A8 C5                  A 12533    	PUSH	BC
0438A9 DD77D6              A 12534    	LD	(IX+%FFFFFFD6),A
0438AC CD 5F 46 04         A 12535    	CALL	_memcpy
0438B0 DD7ED6              A 12536    	LD	A,(IX+%FFFFFFD6)
0438B3 C1                  A 12537    	POP	BC
0438B4 C1                  A 12538    	POP	BC
0438B5 C1                  A 12539    	POP	BC
                           A 12540    ; 3936	#endif
                           A 12541    ; 3937		}
0438B6                     A 12542    L_596:
                           A 12543    .LINE 3937
                           A 12544    
0438B6 DD07FD              A 12545    	LD	BC,(IX+%FFFFFFFD)
0438B9 DD270C              A 12546    	LD	HL,(IX+%C)
0438BC B7                  A 12547    	OR	A,A
0438BD ED42                A 12548    	SBC	HL,BC
0438BF DD2F0C              A 12549    	LD	(IX+%C),HL
0438C2 DD270F              A 12550    	LD	HL,(IX+%F)
0438C5 DD310F              A 12551    	LD	IY,(IX+%F)
0438C8 DD07FD              A 12552    	LD	BC,(IX+%FFFFFFFD)
0438CB ED27                A 12553    	LD	HL,(HL)
0438CD 09                  A 12554    	ADD	HL,BC
0438CE FD2F00              A 12555    	LD	(IY),HL
0438D1 DD07FD              A 12556    	LD	BC,(IX+%FFFFFFFD)
0438D4 DD27EA              A 12557    	LD	HL,(IX+%FFFFFFEA)
0438D7 09                  A 12558    	ADD	HL,BC
0438D8 DD2FEA              A 12559    	LD	(IX+%FFFFFFEA),HL
0438DB DD07FD              A 12560    	LD	BC,(IX+%FFFFFFFD)
0438DE AF                  A 12561    	XOR	A,A
0438DF DD3106              A 12562    	LD	IY,(IX+%6)
0438E2 FD2711              A 12563    	LD	HL,(IY+%11)
0438E5 FD5E14              A 12564    	LD	E,(IY+%14)
0438E8 CD A5 44 04         A 12565    	CALL	__ladd
0438EC FD2F11              A 12566    	LD	(IY+%11),HL
0438EF FD7314              A 12567    	LD	(IY+%14),E
0438F2                     A 12568    L_597:
0438F2 DD070C              A 12569    	LD	BC,(IX+%C)
0438F5 B7                  A 12570    	OR	A,A
0438F6 ED62                A 12571    	SBC	HL,HL
0438F8 B7                  A 12572    	OR	A,A
0438F9 ED42                A 12573    	SBC	HL,BC
0438FB DA 2E 36 04         A 12574    	JR	C,L_595
                           A 12575    ; 3938	
                           A 12576    ; 3939		LEAVE_FF(fs, FR_OK);
                           A 12577    .LINE 3939
                           A 12578    
0438FF B7                  A 12579    	OR	A,A
043900 ED62                A 12580    	SBC	HL,HL
                           A 12581    ; 3940	}
043902                     A 12582    L_600:
                           A 12583    .LINE 3940
                           A 12584    
043902 DDF9                A 12585    	LD	SP,IX
043904 DDE1                A 12586    	POP	IX
043906 C9                  A 12587    	RET	
                           A 12588    
                           A 12589    
                           A 12590    ;**************************** _f_read *********
                           A 12591    ;Name                         Addr/Register   S
                           A 12592    ;_memcpy                             IMPORT  --
                           A 12593    ;_disk_read                          IMPORT  --
                           A 12594    ;G_47                                 IX-38    
                           A 12595    ;remain                               IX-34    
                           A 12596    ;G_45                                 IX-30    
                           A 12597    ;clst                                 IX-26    
                           A 12598    ;rbuff                                IX-22    
                           A 12599    ;csect                                IX-19    
                           A 12600    ;res                                  IX-16    
                           A 12601    ;cc                                   IX-13    
                           A 12602    ;fs                                   IX-10    
                           A 12603    ;sect                                  IX-7    
                           A 12604    ;rcnt                                  IX-3    
                           A 12605    ;br                                   IX+15    
                           A 12606    ;btr                                  IX+12    
                           A 12607    ;buff                                  IX+9    
                           A 12608    ;fp                                    IX+6    
                           A 12609    
                           A 12610    
                           A 12611    ; Stack Frame Size: 60 (bytes)
                           A 12612    ;       Spill Code: -1 (instruction)
                           A 12613    
                           A 12614    
                           A 12615    .ENDFUNC "f_read",3940,"_f_read"
                           A 12616    ; 3941	
                           A 12617    ; 3942	
                           A 12618    ; 3943	
                           A 12619    ; 3944	
                           A 12620    ; 3945	#if !FF_FS_READONLY
                           A 12621    ; 3946	/*-------------------------------------
                           A 12622    ; 3947	/* Write File                          
                           A 12623    ; 3948	/*-------------------------------------
                           A 12624    ; 3949	
                           A 12625    ; 3950	FRESULT f_write (
                           A 12626    ; 3951		FIL* fp,			/* Open file to
                           A 12627    ; 3952		const void* buff,	/* Data to be w
                           A 12628    ; 3953		UINT btw,			/* Number of by
                           A 12629    ; 3954		UINT* bw			/* Number of by
                           A 12630    ; 3955	)
                           A 12631    ; 3956	{
                           A 12632    ; 3957		FRESULT res;
                           A 12633    ; 3958		FATFS *fs;
                           A 12634    ; 3959		DWORD clst;
                           A 12635    ; 3960		LBA_t sect;
                           A 12636    ; 3961		UINT wcnt, cc, csect;
                           A 12637    ; 3962		const BYTE *wbuff = (const BYTE*)bu
                           A 12638    ; 3963	
                           A 12639    ; 3964	
                           A 12640    ; 3965		*bw = 0;	/* Clear write byte cou
                           A 12641    ; 3966		res = validate(&fp->obj, &fs);		
                           A 12642    ; 3967		if (res != FR_OK || (res = (FRESULT
                           A 12643    ; 3968		if (!(fp->flag & FA_WRITE)) LEAVE_F
                           A 12644    ; 3969	
                           A 12645    ; 3970		/* Check fptr wrap-around (file siz
                           A 12646    ; 3971		if ((!FF_FS_EXFAT || fs->fs_type !=
                           A 12647    ; 3972			btw = (UINT)(0xFFFFFFFF - (DWOR
                           A 12648    ; 3973		}
                           A 12649    ; 3974	
                           A 12650    ; 3975		for ( ; btw > 0; btw -= wcnt, *bw +
                           A 12651    ; 3976			if (fp->fptr % SS(fs) == 0) {	
                           A 12652    ; 3977				csect = (UINT)(fp->fptr / S
                           A 12653    ; 3978				if (csect == 0) {			
                           A 12654    ; 3979					if (fp->fptr == 0) {	
                           A 12655    ; 3980						clst = fp->obj.sclu
                           A 12656    ; 3981						if (clst == 0) {	
                           A 12657    ; 3982							clst = create_c
                           A 12658    ; 3983						}
                           A 12659    ; 3984					} else {				
                           A 12660    ; 3985	#if FF_USE_FASTSEEK
                           A 12661    ; 3986						if (fp->cltbl) {
                           A 12662    ; 3987							clst = clmt_clu
                           A 12663    ; 3988						} else
                           A 12664    ; 3989	#endif
                           A 12665    ; 3990						{
                           A 12666    ; 3991							clst = create_c
                           A 12667    ; 3992						}
                           A 12668    ; 3993					}
                           A 12669    ; 3994					if (clst == 0) break;	
                           A 12670    ; 3995					if (clst == 1) ABORT(fs
                           A 12671    ; 3996					if (clst == 0xFFFFFFFF)
                           A 12672    ; 3997					fp->clust = clst;		
                           A 12673    ; 3998					if (fp->obj.sclust == 0
                           A 12674    ; 3999				}
                           A 12675    ; 4000	#if FF_FS_TINY
                           A 12676    ; 4001				if (fs->winsect == fp->sect
                           A 12677    ; 4002	#else
                           A 12678    ; 4003				if (fp->flag & FA_DIRTY) {	
                           A 12679    ; 4004					if (disk_write(fs->pdrv
                           A 12680    ; 4005					fp->flag &= (BYTE)~FA_D
                           A 12681    ; 4006				}
                           A 12682    ; 4007	#endif
                           A 12683    ; 4008				sect = clst2sect(fs, fp->cl
                           A 12684    ; 4009				if (sect == 0) ABORT(fs, FR
                           A 12685    ; 4010				sect += csect;
                           A 12686    ; 4011				cc = btw / SS(fs);			
                           A 12687    ; 4012				if (cc > 0) {				
                           A 12688    ; 4013					if (csect + cc > fs->cs
                           A 12689    ; 4014						cc = fs->csize - cs
                           A 12690    ; 4015					}
                           A 12691    ; 4016					if (disk_write(fs->pdrv
                           A 12692    ; 4017	#if FF_FS_MINIMIZE <= 2
                           A 12693    ; 4018	#if FF_FS_TINY
                           A 12694    ; 4019					if (fs->winsect - sect 
                           A 12695    ; 4020						memcpy(fs->win, wbu
                           A 12696    ; 4021						fs->wflag = 0;
                           A 12697    ; 4022					}
                           A 12698    ; 4023	#else
                           A 12699    ; 4024					if (fp->sect - sect < c
                           A 12700    ; 4025						memcpy(fp->buf, wbu
                           A 12701    ; 4026						fp->flag &= (BYTE)~
                           A 12702    ; 4027					}
                           A 12703    ; 4028	#endif
                           A 12704    ; 4029	#endif
                           A 12705    ; 4030					wcnt = SS(fs) * cc;		
                           A 12706    ; 4031					continue;
                           A 12707    ; 4032				}
                           A 12708    ; 4033	#if FF_FS_TINY
                           A 12709    ; 4034				if (fp->fptr >= fp->obj.obj
                           A 12710    ; 4035					if (sync_window(fs) != 
                           A 12711    ; 4036					fs->winsect = sect;
                           A 12712    ; 4037				}
                           A 12713    ; 4038	#else
                           A 12714    ; 4039				if (fp->sect != sect && 	
                           A 12715    ; 4040					fp->fptr < fp->obj.objs
                           A 12716    ; 4041					disk_read(fs->pdrv, fp-
                           A 12717    ; 4042						ABORT(fs, FR_DISK_E
                           A 12718    ; 4043				}
                           A 12719    ; 4044	#endif
                           A 12720    ; 4045				fp->sect = sect;
                           A 12721    ; 4046			}
                           A 12722    ; 4047			wcnt = SS(fs) - (UINT)fp->fptr 
                           A 12723    ; 4048			if (wcnt > btw) wcnt = btw;		
                           A 12724    ; 4049	#if FF_FS_TINY
                           A 12725    ; 4050			if (move_window(fs, fp->sect) !
                           A 12726    ; 4051			memcpy(fs->win + fp->fptr % SS(
                           A 12727    ; 4052			fs->wflag = 1;
                           A 12728    ; 4053	#else
                           A 12729    ; 4054			memcpy(fp->buf + fp->fptr % SS(
                           A 12730    ; 4055			fp->flag |= FA_DIRTY;
                           A 12731    ; 4056	#endif
                           A 12732    ; 4057		}
                           A 12733    ; 4058	
                           A 12734    ; 4059		fp->flag |= FA_MODIFIED;			
                           A 12735    ; 4060	
                           A 12736    ; 4061		LEAVE_FF(fs, FR_OK);
                           A 12737    ; 4062	}
                           A 12738    ; 4063	
                           A 12739    ; 4064	
                           A 12740    ; 4065	
                           A 12741    ; 4066	
                           A 12742    ; 4067	/*-------------------------------------
                           A 12743    ; 4068	/* Synchronize the File                
                           A 12744    ; 4069	/*-------------------------------------
                           A 12745    ; 4070	
                           A 12746    ; 4071	FRESULT f_sync (
                           A 12747    ; 4072		FIL* fp		/* Open file to be sync
                           A 12748    ; 4073	)
                           A 12749    ; 4074	{
                           A 12750    ; 4075		FRESULT res;
                           A 12751    ; 4076		FATFS *fs;
                           A 12752    ; 4077		DWORD tm;
                           A 12753    ; 4078		BYTE *dir;
                           A 12754    ; 4079	
                           A 12755    ; 4080	
                           A 12756    ; 4081		res = validate(&fp->obj, &fs);	/* 
                           A 12757    ; 4082		if (res == FR_OK) {
                           A 12758    ; 4083			if (fp->flag & FA_MODIFIED) {	
                           A 12759    ; 4084	#if !FF_FS_TINY
                           A 12760    ; 4085				if (fp->flag & FA_DIRTY) {	
                           A 12761    ; 4086					if (disk_write(fs->pdrv
                           A 12762    ; 4087					fp->flag &= (BYTE)~FA_D
                           A 12763    ; 4088				}
                           A 12764    ; 4089	#endif
                           A 12765    ; 4090				/* Update the directory ent
                           A 12766    ; 4091				tm = GET_FATTIME();			
                           A 12767    ; 4092	#if FF_FS_EXFAT
                           A 12768    ; 4093				if (fs->fs_type == FS_EXFAT
                           A 12769    ; 4094					res = fill_first_frag(&
                           A 12770    ; 4095					if (res == FR_OK) {
                           A 12771    ; 4096						res = fill_last_fra
                           A 12772    ; 4097					}
                           A 12773    ; 4098					if (res == FR_OK) {
                           A 12774    ; 4099						DIR dj;
                           A 12775    ; 4100						DEF_NAMBUF
                           A 12776    ; 4101	
                           A 12777    ; 4102						INIT_NAMBUF(fs);
                           A 12778    ; 4103						res = load_obj_xdir
                           A 12779    ; 4104						if (res == FR_OK) {
                           A 12780    ; 4105							fs->dirbuf[XDIR
                           A 12781    ; 4106							fs->dirbuf[XDIR
                           A 12782    ; 4107							st_dword(fs->di
                           A 12783    ; 4108							st_qword(fs->di
                           A 12784    ; 4109							st_qword(fs->di
                           A 12785    ; 4110							st_dword(fs->di
                           A 12786    ; 4111							fs->dirbuf[XDIR
                           A 12787    ; 4112							st_dword(fs->di
                           A 12788    ; 4113							res = store_xdi
                           A 12789    ; 4114							if (res == FR_O
                           A 12790    ; 4115								res = sync_
                           A 12791    ; 4116								fp->flag &=
                           A 12792    ; 4117							}
                           A 12793    ; 4118						}
                           A 12794    ; 4119						FREE_NAMBUF();
                           A 12795    ; 4120					}
                           A 12796    ; 4121				} else
                           A 12797    ; 4122	#endif
                           A 12798    ; 4123				{
                           A 12799    ; 4124					res = move_window(fs, f
                           A 12800    ; 4125					if (res == FR_OK) {
                           A 12801    ; 4126						dir = fp->dir_ptr;
                           A 12802    ; 4127						dir[DIR_Attr] |= AM
                           A 12803    ; 4128						st_clust(fp->obj.fs
                           A 12804    ; 4129						st_dword(dir + DIR_
                           A 12805    ; 4130						st_dword(dir + DIR_
                           A 12806    ; 4131						st_word(dir + DIR_L
                           A 12807    ; 4132						fs->wflag = 1;
                           A 12808    ; 4133						res = sync_fs(fs);	
                           A 12809    ; 4134						fp->flag &= (BYTE)~
                           A 12810    ; 4135					}
                           A 12811    ; 4136				}
                           A 12812    ; 4137			}
                           A 12813    ; 4138		}
                           A 12814    ; 4139	
                           A 12815    ; 4140		LEAVE_FF(fs, res);
                           A 12816    ; 4141	}
                           A 12817    ; 4142	
                           A 12818    ; 4143	#endif /* !FF_FS_READONLY */
                           A 12819    ; 4144	
                           A 12820    ; 4145	
                           A 12821    ; 4146	
                           A 12822    ; 4147	
                           A 12823    ; 4148	/*-------------------------------------
                           A 12824    ; 4149	/* Close File                          
                           A 12825    ; 4150	/*-------------------------------------
                           A 12826    ; 4151	
                           A 12827    ; 4152	FRESULT f_close (
                           A 12828    ; 4153		FIL* fp		/* Open file to be clos
                           A 12829    ; 4154	)
                           A 12830    ; 4155	{
043907                     A 12831    _f_close:
                           A 12832    .DEFINE "_f_close"
                           A 12833    
                           A 12834    .VALUE _f_close
                           A 12835    
                           A 12836    .CLASS 2
                           A 12837    
                           A 12838    .TYPE 68
                           A 12839    
                           A 12840    .ENDEF
                           A 12841    
                           A 12842    .BEGFUNC "f_close",4155,"_f_close"
                           A 12843    
                           A 12844    .LINE 4155
                           A 12845    
                           A 12846    .DEFINE "fp"
                           A 12847    
                           A 12848    .CLASS 65
                           A 12849    
                           A 12850    .VALUE 6
                           A 12851    
                           A 12852    .TAG "NONAME2"
                           A 12853    
                           A 12854    .TYPE 40
                           A 12855    
                           A 12856    .ENDEF
                           A 12857    
                           A 12858    .DEFINE "res"
                           A 12859    
                           A 12860    .CLASS 65
                           A 12861    
                           A 12862    .VALUE -3
                           A 12863    
                           A 12864    .TYPE 4
                           A 12865    
                           A 12866    .ENDEF
                           A 12867    
                           A 12868    .DEFINE "fs"
                           A 12869    
                           A 12870    .CLASS 65
                           A 12871    
                           A 12872    .VALUE -6
                           A 12873    
                           A 12874    .TAG "NONAME0"
                           A 12875    
                           A 12876    .TYPE 40
                           A 12877    
                           A 12878    .ENDEF
                           A 12879    
043907 DDE5                A 12880    	PUSH	IX
043909 DD210000 00         A 12881    	LD	IX,0
04390E DD39                A 12882    	ADD	IX,SP
043910 C5                  A 12883    	PUSH	BC
043911 C5                  A 12884    	PUSH	BC
                           A 12885    ; 4156		FRESULT res;
                           A 12886    ; 4157		FATFS *fs;
                           A 12887    ; 4158	
                           A 12888    ; 4159	#if !FF_FS_READONLY
                           A 12889    ; 4160		res = f_sync(fp);					
                           A 12890    ; 4161		if (res == FR_OK)
                           A 12891    ; 4162	#endif
                           A 12892    ; 4163		{
                           A 12893    ; 4164			res = validate(&fp->obj, &fs);	
                           A 12894    .LINE 4164
                           A 12895    
043912 ED65FA              A 12896    	PEA	IX+%FFFFFFFA
043915 DD3106              A 12897    	LD	IY,(IX+%6)
043918 ED6600              A 12898    	PEA	IY+%0
04391B CD 31 33 04         A 12899    	CALL	_validate
04391F C1                  A 12900    	POP	BC
043920 C1                  A 12901    	POP	BC
043921 DD2FFD              A 12902    	LD	(IX+%FFFFFFFD),HL
                           A 12903    ; 4165			if (res == FR_OK) {
                           A 12904    .LINE 4165
                           A 12905    
043924 CD E5 46 04         A 12906    	CALL	__icmpzero
043928 20 0A               A 12907    	JR	NZ,L_602
                           A 12908    ; 4166	#if FF_FS_LOCK != 0
                           A 12909    ; 4167				res = dec_lock(fp->obj.lock
                           A 12910    ; 4168				if (res == FR_OK) fp->obj.f
                           A 12911    ; 4169	#else
                           A 12912    ; 4170				fp->obj.fs = 0;	/* Invalida
                           A 12913    .LINE 4170
                           A 12914    
04392A 01000000            A 12915    	LD	BC,0
04392E DD3106              A 12916    	LD	IY,(IX+%6)
043931 FD0F00              A 12917    	LD	(IY+%0),BC
                           A 12918    ; 4171	#endif
                           A 12919    ; 4172	#if FF_FS_REENTRANT
                           A 12920    ; 4173				unlock_fs(fs, FR_OK);		
                           A 12921    ; 4174	#endif
                           A 12922    ; 4175			}
                           A 12923    ; 4176		}
043934                     A 12924    L_602:
                           A 12925    .LINE 4176
                           A 12926    
                           A 12927    ; 4177		return res;
                           A 12928    .LINE 4177
                           A 12929    
043934 DD27FD              A 12930    	LD	HL,(IX+%FFFFFFFD)
                           A 12931    ; 4178	}
                           A 12932    .LINE 4178
                           A 12933    
043937 DDF9                A 12934    	LD	SP,IX
043939 DDE1                A 12935    	POP	IX
04393B C9                  A 12936    	RET	
                           A 12937    
                           A 12938    
                           A 12939    ;**************************** _f_close ********
                           A 12940    ;Name                         Addr/Register   S
                           A 12941    ;fs                                    IX-6    
                           A 12942    ;res                                   IX-3    
                           A 12943    ;fp                                    IX+6    
                           A 12944    
                           A 12945    
                           A 12946    ; Stack Frame Size: 15 (bytes)
                           A 12947    ;       Spill Code: -1 (instruction)
                           A 12948    
                           A 12949    
                           A 12950    .ENDFUNC "f_close",4178,"_f_close"
                           A 12951    ; 4179	
                           A 12952    ; 4180	
                           A 12953    ; 4181	
                           A 12954    ; 4182	
                           A 12955    ; 4183	#if FF_FS_RPATH >= 1
                           A 12956    ; 4184	/*-------------------------------------
                           A 12957    ; 4185	/* Change Current Directory or Current 
                           A 12958    ; 4186	/*-------------------------------------
                           A 12959    ; 4187	
                           A 12960    ; 4188	FRESULT f_chdrive (
                           A 12961    ; 4189		const TCHAR* path		/* Drive nu
                           A 12962    ; 4190	)
                           A 12963    ; 4191	{
04393C                     A 12964    _f_chdrive:
                           A 12965    .DEFINE "_f_chdrive"
                           A 12966    
                           A 12967    .VALUE _f_chdrive
                           A 12968    
                           A 12969    .CLASS 2
                           A 12970    
                           A 12971    .TYPE 68
                           A 12972    
                           A 12973    .ENDEF
                           A 12974    
                           A 12975    .BEGFUNC "f_chdrive",4191,"_f_chdrive"
                           A 12976    
                           A 12977    .LINE 4191
                           A 12978    
                           A 12979    .DEFINE "path"
                           A 12980    
                           A 12981    .CLASS 65
                           A 12982    
                           A 12983    .VALUE 6
                           A 12984    
                           A 12985    .TYPE 194
                           A 12986    
                           A 12987    .ENDEF
                           A 12988    
                           A 12989    .DEFINE "vol"
                           A 12990    
                           A 12991    .CLASS 65
                           A 12992    
                           A 12993    .VALUE -3
                           A 12994    
                           A 12995    .TYPE 4
                           A 12996    
                           A 12997    .ENDEF
                           A 12998    
04393C DDE5                A 12999    	PUSH	IX
04393E DD210000 00         A 13000    	LD	IX,0
043943 DD39                A 13001    	ADD	IX,SP
043945 C5                  A 13002    	PUSH	BC
                           A 13003    ; 4192		int vol;
                           A 13004    ; 4193	
                           A 13005    ; 4194	
                           A 13006    ; 4195		/* Get logical drive number */
                           A 13007    ; 4196		vol = get_ldnumber(&path);
                           A 13008    .LINE 4196
                           A 13009    
043946 ED6506              A 13010    	PEA	IX+%6
043949 CD DE 29 04         A 13011    	CALL	_get_ldnumber
04394D C1                  A 13012    	POP	BC
04394E DD2FFD              A 13013    	LD	(IX+%FFFFFFFD),HL
                           A 13014    ; 4197		if (vol < 0) return FR_INVALID_DRIV
                           A 13015    .LINE 4197
                           A 13016    
043951 CD E5 46 04         A 13017    	CALL	__icmpzero
043955 F2 5F 39 04         A 13018    	JP	P,L_605
043959 210B0000            A 13019    	LD	HL,11
04395D 18 0A               A 13020    	JR	L_606
04395F                     A 13021    L_605:
                           A 13022    ; 4198		CurrVol = (BYTE)vol;	/* Set it a
                           A 13023    .LINE 4198
                           A 13024    
04395F DD7EFD              A 13025    	LD	A,(IX+%FFFFFFFD)
043962 32 CB 4F 04         A 13026    	LD	(_CurrVol),A
                           A 13027    ; 4199	
                           A 13028    ; 4200		return FR_OK;
                           A 13029    .LINE 4200
                           A 13030    
043966 B7                  A 13031    	OR	A,A
043967 ED62                A 13032    	SBC	HL,HL
                           A 13033    ; 4201	}
043969                     A 13034    L_606:
                           A 13035    .LINE 4201
                           A 13036    
043969 DDF9                A 13037    	LD	SP,IX
04396B DDE1                A 13038    	POP	IX
04396D C9                  A 13039    	RET	
                           A 13040    
                           A 13041    
                           A 13042    ;**************************** _f_chdrive ******
                           A 13043    ;Name                         Addr/Register   S
                           A 13044    ;_CurrVol                            STATIC    
                           A 13045    ;vol                                   IX-3    
                           A 13046    ;path                                  IX+6    
                           A 13047    
                           A 13048    
                           A 13049    ; Stack Frame Size: 12 (bytes)
                           A 13050    ;       Spill Code: -1 (instruction)
                           A 13051    
                           A 13052    
                           A 13053    .ENDFUNC "f_chdrive",4201,"_f_chdrive"
                           A 13054    ; 4202	
                           A 13055    ; 4203	
                           A 13056    ; 4204	
                           A 13057    ; 4205	FRESULT f_chdir (
                           A 13058    ; 4206		const TCHAR* path	/* Pointer to t
                           A 13059    ; 4207	)
                           A 13060    ; 4208	{
04396E                     A 13061    _f_chdir:
                           A 13062    .DEFINE "_f_chdir"
                           A 13063    
                           A 13064    .VALUE _f_chdir
                           A 13065    
                           A 13066    .CLASS 2
                           A 13067    
                           A 13068    .TYPE 68
                           A 13069    
                           A 13070    .ENDEF
                           A 13071    
                           A 13072    .BEGFUNC "f_chdir",4208,"_f_chdir"
                           A 13073    
                           A 13074    .LINE 4208
                           A 13075    
                           A 13076    .DEFINE "path"
                           A 13077    
                           A 13078    .CLASS 65
                           A 13079    
                           A 13080    .VALUE 6
                           A 13081    
                           A 13082    .TYPE 194
                           A 13083    
                           A 13084    .ENDEF
                           A 13085    
                           A 13086    .DEFINE "res"
                           A 13087    
                           A 13088    .CLASS 65
                           A 13089    
                           A 13090    .VALUE -3
                           A 13091    
                           A 13092    .TYPE 4
                           A 13093    
                           A 13094    .ENDEF
                           A 13095    
                           A 13096    .DEFINE "fs"
                           A 13097    
                           A 13098    .CLASS 65
                           A 13099    
                           A 13100    .VALUE -6
                           A 13101    
                           A 13102    .TAG "NONAME0"
                           A 13103    
                           A 13104    .TYPE 40
                           A 13105    
                           A 13106    .ENDEF
                           A 13107    
                           A 13108    .DEFINE "dj"
                           A 13109    
                           A 13110    .CLASS 65
                           A 13111    
                           A 13112    .VALUE -52
                           A 13113    
                           A 13114    .TAG "NONAME3"
                           A 13115    
                           A 13116    .TYPE 8
                           A 13117    
                           A 13118    .ENDEF
                           A 13119    
                           A 13120    .DEFINE "lbuf"
                           A 13121    
                           A 13122    .CLASS 65
                           A 13123    
                           A 13124    .VALUE -564
                           A 13125    
                           A 13126    .DIM 256
                           A 13127    
                           A 13128    .TYPE 109
                           A 13129    
                           A 13130    .ENDEF
                           A 13131    
04396E DDE5                A 13132    	PUSH	IX
043970 DD210000 00         A 13133    	LD	IX,0
043975 DD39                A 13134    	ADD	IX,SP
043977 21CCFDFF            A 13135    	LD	HL,-564
04397B 39                  A 13136    	ADD	HL,SP
04397C F9                  A 13137    	LD	SP,HL
                           A 13138    ; 4209	#if FF_STR_VOLUME_ID == 2
                           A 13139    ; 4210		UINT i;
                           A 13140    ; 4211	#endif
                           A 13141    ; 4212		FRESULT res;
                           A 13142    ; 4213		DIR dj;
                           A 13143    ; 4214		FATFS *fs;
                           A 13144    ; 4215		DEF_NAMBUF
                           A 13145    ; 4216	
                           A 13146    ; 4217	
                           A 13147    ; 4218		/* Get logical drive */
                           A 13148    ; 4219		res = mount_volume(&path, &fs, 0);
                           A 13149    .LINE 4219
                           A 13150    
04397D 01000000            A 13151    	LD	BC,0
043981 C5                  A 13152    	PUSH	BC
043982 ED65FA              A 13153    	PEA	IX+%FFFFFFFA
043985 ED6506              A 13154    	PEA	IX+%6
043988 CD E9 2D 04         A 13155    	CALL	_mount_volume
04398C C1                  A 13156    	POP	BC
04398D C1                  A 13157    	POP	BC
04398E C1                  A 13158    	POP	BC
04398F DD2FFD              A 13159    	LD	(IX+%FFFFFFFD),HL
                           A 13160    ; 4220		if (res == FR_OK) {
                           A 13161    .LINE 4220
                           A 13162    
043992 CD E5 46 04         A 13163    	CALL	__icmpzero
043996 20 7F               A 13164    	JR	NZ,L_615
                           A 13165    ; 4221			dj.obj.fs = fs;
                           A 13166    .LINE 4221
                           A 13167    
043998 DD07FA              A 13168    	LD	BC,(IX+%FFFFFFFA)
04399B DD0FCC              A 13169    	LD	(IX+%FFFFFFCC),BC
                           A 13170    ; 4222			INIT_NAMBUF(fs);
                           A 13171    .LINE 4222
                           A 13172    
04399E DDE5E1              A 13173    	LD	HL,IX
0439A1 01CCFDFF            A 13174    	LD	BC,-564
0439A5 09                  A 13175    	ADD	HL,BC
0439A6 DD31FA              A 13176    	LD	IY,(IX+%FFFFFFFA)
0439A9 FD2F0B              A 13177    	LD	(IY+%B),HL
                           A 13178    ; 4223			res = follow_path(&dj, path);	
                           A 13179    .LINE 4223
                           A 13180    
0439AC DD0706              A 13181    	LD	BC,(IX+%6)
0439AF C5                  A 13182    	PUSH	BC
0439B0 ED65CC              A 13183    	PEA	IX+%FFFFFFCC
0439B3 CD 55 28 04         A 13184    	CALL	_follow_path
0439B7 C1                  A 13185    	POP	BC
0439B8 C1                  A 13186    	POP	BC
0439B9 DD2FFD              A 13187    	LD	(IX+%FFFFFFFD),HL
                           A 13188    ; 4224			if (res == FR_OK) {				
                           A 13189    .LINE 4224
                           A 13190    
0439BC CD E5 46 04         A 13191    	CALL	__icmpzero
0439C0 20 42               A 13192    	JR	NZ,L_612
                           A 13193    ; 4225				if (dj.fn[NSFLAG] & NS_NONA
                           A 13194    .LINE 4225
                           A 13195    
0439C2 ED55EA              A 13196    	LEA	IY,IX+%FFFFFFEA
0439C5 FD7E0B              A 13197    	LD	A,(IY+%B)
0439C8 E680                A 13198    	AND	A,%80
0439CA 28 11               A 13199    	JR	Z,L_610
                           A 13200    ; 4226					fs->cdir = dj.obj.sclus
                           A 13201    .LINE 4226
                           A 13202    
0439CC DD07D3              A 13203    	LD	BC,(IX+%FFFFFFD3)
0439CF DD7ED6              A 13204    	LD	A,(IX+%FFFFFFD6)
0439D2 DD31FA              A 13205    	LD	IY,(IX+%FFFFFFFA)
0439D5 FD0F0E              A 13206    	LD	(IY+%E),BC
0439D8 FD7711              A 13207    	LD	(IY+%11),A
                           A 13208    ; 4227	#if FF_FS_EXFAT
                           A 13209    ; 4228					if (fs->fs_type == FS_E
                           A 13210    ; 4229						fs->cdc_scl = dj.ob
                           A 13211    ; 4230						fs->cdc_size = dj.o
                           A 13212    ; 4231						fs->cdc_ofs = dj.ob
                           A 13213    ; 4232					}
                           A 13214    ; 4233	#endif
                           A 13215    ; 4234				} else {
                           A 13216    .LINE 4234
                           A 13217    
0439DB 18 27               A 13218    	JR	L_612
0439DD                     A 13219    L_610:
                           A 13220    ; 4235					if (dj.obj.attr & AM_DI
                           A 13221    .LINE 4235
                           A 13222    
0439DD DD7ED1              A 13223    	LD	A,(IX+%FFFFFFD1)
0439E0 E610                A 13224    	AND	A,%10
0439E2 28 19               A 13225    	JR	Z,L_608
                           A 13226    ; 4236	#if FF_FS_EXFAT
                           A 13227    ; 4237						if (fs->fs_type == 
                           A 13228    ; 4238							fs->cdir = ld_d
                           A 13229    ; 4239							fs->cdc_scl = d
                           A 13230    ; 4240							fs->cdc_size = 
                           A 13231    ; 4241							fs->cdc_ofs = d
                           A 13232    ; 4242						} else
                           A 13233    ; 4243	#endif
                           A 13234    ; 4244						{
                           A 13235    ; 4245							fs->cdir = ld_c
                           A 13236    .LINE 4245
                           A 13237    
0439E4 DD07E7              A 13238    	LD	BC,(IX+%FFFFFFE7)
0439E7 C5                  A 13239    	PUSH	BC
0439E8 DD07FA              A 13240    	LD	BC,(IX+%FFFFFFFA)
0439EB C5                  A 13241    	PUSH	BC
0439EC CD CC 18 04         A 13242    	CALL	_ld_clust
0439F0 C1                  A 13243    	POP	BC
0439F1 C1                  A 13244    	POP	BC
0439F2 DD31FA              A 13245    	LD	IY,(IX+%FFFFFFFA)
0439F5 FD2F0E              A 13246    	LD	(IY+%E),HL
0439F8 FD7311              A 13247    	LD	(IY+%11),E
                           A 13248    ; 4246						}
                           A 13249    ; 4247					} else {
                           A 13250    .LINE 4247
                           A 13251    
0439FB 18 07               A 13252    	JR	L_612
0439FD                     A 13253    L_608:
                           A 13254    ; 4248						res = FR_NO_PATH;	
                           A 13255    .LINE 4248
                           A 13256    
0439FD 01050000            A 13257    	LD	BC,5
043A01 DD0FFD              A 13258    	LD	(IX+%FFFFFFFD),BC
                           A 13259    ; 4249					}
                           A 13260    ; 4250				}
                           A 13261    ; 4251			}
043A04                     A 13262    L_612:
                           A 13263    .LINE 4251
                           A 13264    
                           A 13265    ; 4252			FREE_NAMBUF();
                           A 13266    ; 4253			if (res == FR_NO_FILE) res = FR
                           A 13267    .LINE 4253
                           A 13268    
043A04 01040000            A 13269    	LD	BC,4
043A08 DD27FD              A 13270    	LD	HL,(IX+%FFFFFFFD)
043A0B B7                  A 13271    	OR	A,A
043A0C ED42                A 13272    	SBC	HL,BC
043A0E 20 07               A 13273    	JR	NZ,L_615
043A10 01050000            A 13274    	LD	BC,5
043A14 DD0FFD              A 13275    	LD	(IX+%FFFFFFFD),BC
                           A 13276    ; 4254	#if FF_STR_VOLUME_ID == 2	/* Also cur
                           A 13277    ; 4255			if (res == FR_OK) {
                           A 13278    ; 4256				for (i = FF_VOLUMES - 1; i 
                           A 13279    ; 4257				CurrVol = (BYTE)i;
                           A 13280    ; 4258			}
                           A 13281    ; 4259	#endif
                           A 13282    ; 4260		}
043A17                     A 13283    L_615:
                           A 13284    .LINE 4260
                           A 13285    
                           A 13286    ; 4261	
                           A 13287    ; 4262		LEAVE_FF(fs, res);
                           A 13288    .LINE 4262
                           A 13289    
043A17 DD27FD              A 13290    	LD	HL,(IX+%FFFFFFFD)
                           A 13291    ; 4263	}
                           A 13292    .LINE 4263
                           A 13293    
043A1A DDF9                A 13294    	LD	SP,IX
043A1C DDE1                A 13295    	POP	IX
043A1E C9                  A 13296    	RET	
                           A 13297    
                           A 13298    
                           A 13299    ;**************************** _f_chdir ********
                           A 13300    ;Name                         Addr/Register   S
                           A 13301    ;lbuf                                IX-564    
                           A 13302    ;dj                                   IX-52    
                           A 13303    ;fs                                    IX-6    
                           A 13304    ;res                                   IX-3    
                           A 13305    ;path                                  IX+6    
                           A 13306    
                           A 13307    
                           A 13308    ; Stack Frame Size: 573 (bytes)
                           A 13309    ;       Spill Code: -1 (instruction)
                           A 13310    
                           A 13311    
                           A 13312    .ENDFUNC "f_chdir",4263,"_f_chdir"
                           A 13313    ; 4264	
                           A 13314    ; 4265	
                           A 13315    ; 4266	#if FF_FS_RPATH >= 2
                           A 13316    ; 4267	FRESULT f_getcwd (
                           A 13317    ; 4268		TCHAR* buff,	/* Pointer to the d
                           A 13318    ; 4269		UINT len		/* Size of buff in 
                           A 13319    ; 4270	)
                           A 13320    ; 4271	{
043A1F                     A 13321    _f_getcwd:
                           A 13322    .DEFINE "_f_getcwd"
                           A 13323    
                           A 13324    .VALUE _f_getcwd
                           A 13325    
                           A 13326    .CLASS 2
                           A 13327    
                           A 13328    .TYPE 68
                           A 13329    
                           A 13330    .ENDEF
                           A 13331    
                           A 13332    .BEGFUNC "f_getcwd",4271,"_f_getcwd"
                           A 13333    
                           A 13334    .LINE 4271
                           A 13335    
                           A 13336    .DEFINE "buff"
                           A 13337    
                           A 13338    .CLASS 65
                           A 13339    
                           A 13340    .VALUE 6
                           A 13341    
                           A 13342    .TYPE 34
                           A 13343    
                           A 13344    .ENDEF
                           A 13345    
                           A 13346    .DEFINE "len"
                           A 13347    
                           A 13348    .CLASS 65
                           A 13349    
                           A 13350    .VALUE 9
                           A 13351    
                           A 13352    .TYPE 14
                           A 13353    
                           A 13354    .ENDEF
                           A 13355    
                           A 13356    .DEFINE "res"
                           A 13357    
                           A 13358    .CLASS 65
                           A 13359    
                           A 13360    .VALUE -3
                           A 13361    
                           A 13362    .TYPE 4
                           A 13363    
                           A 13364    .ENDEF
                           A 13365    
                           A 13366    .DEFINE "i"
                           A 13367    
                           A 13368    .CLASS 65
                           A 13369    
                           A 13370    .VALUE -6
                           A 13371    
                           A 13372    .TYPE 14
                           A 13373    
                           A 13374    .ENDEF
                           A 13375    
                           A 13376    .DEFINE "n"
                           A 13377    
                           A 13378    .CLASS 65
                           A 13379    
                           A 13380    .VALUE -9
                           A 13381    
                           A 13382    .TYPE 14
                           A 13383    
                           A 13384    .ENDEF
                           A 13385    
                           A 13386    .DEFINE "fs"
                           A 13387    
                           A 13388    .CLASS 65
                           A 13389    
                           A 13390    .VALUE -12
                           A 13391    
                           A 13392    .TAG "NONAME0"
                           A 13393    
                           A 13394    .TYPE 40
                           A 13395    
                           A 13396    .ENDEF
                           A 13397    
                           A 13398    .DEFINE "tp"
                           A 13399    
                           A 13400    .CLASS 65
                           A 13401    
                           A 13402    .VALUE -15
                           A 13403    
                           A 13404    .TYPE 34
                           A 13405    
                           A 13406    .ENDEF
                           A 13407    
                           A 13408    .DEFINE "ccl"
                           A 13409    
                           A 13410    .CLASS 65
                           A 13411    
                           A 13412    .VALUE -19
                           A 13413    
                           A 13414    .TYPE 15
                           A 13415    
                           A 13416    .ENDEF
                           A 13417    
                           A 13418    .DEFINE "dj"
                           A 13419    
                           A 13420    .CLASS 65
                           A 13421    
                           A 13422    .VALUE -65
                           A 13423    
                           A 13424    .TAG "NONAME3"
                           A 13425    
                           A 13426    .TYPE 8
                           A 13427    
                           A 13428    .ENDEF
                           A 13429    
                           A 13430    .DEFINE "fno"
                           A 13431    
                           A 13432    .CLASS 65
                           A 13433    
                           A 13434    .VALUE -343
                           A 13435    
                           A 13436    .TAG "NONAME4"
                           A 13437    
                           A 13438    .TYPE 8
                           A 13439    
                           A 13440    .ENDEF
                           A 13441    
                           A 13442    .DEFINE "lbuf"
                           A 13443    
                           A 13444    .CLASS 65
                           A 13445    
                           A 13446    .VALUE -855
                           A 13447    
                           A 13448    .DIM 256
                           A 13449    
                           A 13450    .TYPE 109
                           A 13451    
                           A 13452    .ENDEF
                           A 13453    
043A1F DDE5                A 13454    	PUSH	IX
043A21 DD210000 00         A 13455    	LD	IX,0
043A26 DD39                A 13456    	ADD	IX,SP
043A28 21A3FCFF            A 13457    	LD	HL,-861
043A2C 39                  A 13458    	ADD	HL,SP
043A2D F9                  A 13459    	LD	SP,HL
                           A 13460    ; 4272		FRESULT res;
                           A 13461    ; 4273		DIR dj;
                           A 13462    ; 4274		FATFS *fs;
                           A 13463    ; 4275		UINT i, n;
                           A 13464    ; 4276		DWORD ccl;
                           A 13465    ; 4277		TCHAR *tp = buff;
                           A 13466    .LINE 4277
                           A 13467    
043A2E DD0706              A 13468    	LD	BC,(IX+%6)
043A31 DD0FF1              A 13469    	LD	(IX+%FFFFFFF1),BC
                           A 13470    ; 4278	#if FF_VOLUMES >= 2
                           A 13471    ; 4279		UINT vl;
                           A 13472    ; 4280	#if FF_STR_VOLUME_ID
                           A 13473    ; 4281		const char *vp;
                           A 13474    ; 4282	#endif
                           A 13475    ; 4283	#endif
                           A 13476    ; 4284		FILINFO fno;
                           A 13477    ; 4285		DEF_NAMBUF
                           A 13478    ; 4286	
                           A 13479    ; 4287	
                           A 13480    ; 4288		/* Get logical drive */
                           A 13481    ; 4289		buff[0] = 0;	/* Set null string 
                           A 13482    .LINE 4289
                           A 13483    
043A34 DD2706              A 13484    	LD	HL,(IX+%6)
043A37 3600                A 13485    	LD	(HL),%0
                           A 13486    ; 4290		res = mount_volume((const TCHAR**)&
                           A 13487    .LINE 4290
                           A 13488    
043A39 01000000            A 13489    	LD	BC,0
043A3D C5                  A 13490    	PUSH	BC
043A3E ED65F4              A 13491    	PEA	IX+%FFFFFFF4
043A41 ED6506              A 13492    	PEA	IX+%6
043A44 CD E9 2D 04         A 13493    	CALL	_mount_volume
043A48 C1                  A 13494    	POP	BC
043A49 C1                  A 13495    	POP	BC
043A4A C1                  A 13496    	POP	BC
043A4B DD2FFD              A 13497    	LD	(IX+%FFFFFFFD),HL
                           A 13498    ; 4291		if (res == FR_OK) {
                           A 13499    .LINE 4291
                           A 13500    
043A4E CD E5 46 04         A 13501    	CALL	__icmpzero
043A52 C2 7C 3C 04         A 13502    	JR	NZ,L_658
                           A 13503    ; 4292			dj.obj.fs = fs;
                           A 13504    .LINE 4292
                           A 13505    
043A56 ED22BF              A 13506    	LEA	HL,IX+%FFFFFFBF
043A59 01A6FCFF            A 13507    	LD	BC,-858
043A5D CD 43 45 04         A 13508    	CALL	__istix
043A61 DD07F4              A 13509    	LD	BC,(IX+%FFFFFFF4)
043A64 DD0FBF              A 13510    	LD	(IX+%FFFFFFBF),BC
                           A 13511    ; 4293			INIT_NAMBUF(fs);
                           A 13512    .LINE 4293
                           A 13513    
043A67 DDE5E1              A 13514    	LD	HL,IX
043A6A 01A9FCFF            A 13515    	LD	BC,-855
043A6E 09                  A 13516    	ADD	HL,BC
043A6F DD31F4              A 13517    	LD	IY,(IX+%FFFFFFF4)
043A72 FD2F0B              A 13518    	LD	(IY+%B),HL
                           A 13519    ; 4294	
                           A 13520    ; 4295			/* Follow parent directories an
                           A 13521    ; 4296			i = len;			/* Bottom o
                           A 13522    .LINE 4296
                           A 13523    
043A75 DD0709              A 13524    	LD	BC,(IX+%9)
043A78 DD0FFA              A 13525    	LD	(IX+%FFFFFFFA),BC
                           A 13526    ; 4297			if (!FF_FS_EXFAT || fs->fs_type
                           A 13527    ; 4298				dj.obj.sclust = fs->cdir;	
                           A 13528    .LINE 4298
                           A 13529    
043A7B 01A6FCFF            A 13530    	LD	BC,-858
043A7F CD 93 48 04         A 13531    	CALL	__ildix
043A83 FD070E              A 13532    	LD	BC,(IY+%E)
043A86 FD7E11              A 13533    	LD	A,(IY+%11)
043A89 E5FDE1              A 13534    	LD	IY,HL
043A8C FD0F07              A 13535    	LD	(IY+%7),BC
043A8F FD770A              A 13536    	LD	(IY+%A),A
                           A 13537    ; 4299				while ((ccl = dj.obj.sclust
                           A 13538    .LINE 4299
                           A 13539    
043A92 C3 FA 3B 04         A 13540    	JR	L_644
043A96                     A 13541    L_645:
                           A 13542    ; 4300					res = dir_sdi(&dj, 1 * 
                           A 13543    .LINE 4300
                           A 13544    
043A96 01000000            A 13545    	LD	BC,0
043A9A C5                  A 13546    	PUSH	BC
043A9B 01200000            A 13547    	LD	BC,32
043A9F C5                  A 13548    	PUSH	BC
043AA0 ED65BF              A 13549    	PEA	IX+%FFFFFFBF
043AA3 CD B4 14 04         A 13550    	CALL	_dir_sdi
043AA7 C1                  A 13551    	POP	BC
043AA8 C1                  A 13552    	POP	BC
043AA9 C1                  A 13553    	POP	BC
043AAA DD2FFD              A 13554    	LD	(IX+%FFFFFFFD),HL
                           A 13555    ; 4301					if (res != FR_OK) break
                           A 13556    .LINE 4301
                           A 13557    
043AAD CD E5 46 04         A 13558    	CALL	__icmpzero
043AB1 C2 13 3C 04         A 13559    	JR	NZ,L_655
                           A 13560    ; 4302					res = move_window(fs, d
                           A 13561    .LINE 4302
                           A 13562    
043AB5 DD4ED9              A 13563    	LD	C,(IX+%FFFFFFD9)
043AB8 0600                A 13564    	LD	B,%0
043ABA C5                  A 13565    	PUSH	BC
043ABB DD07D6              A 13566    	LD	BC,(IX+%FFFFFFD6)
043ABE C5                  A 13567    	PUSH	BC
043ABF DD07F4              A 13568    	LD	BC,(IX+%FFFFFFF4)
043AC2 C5                  A 13569    	PUSH	BC
043AC3 CD 82 11 04         A 13570    	CALL	_move_window
043AC7 C1                  A 13571    	POP	BC
043AC8 C1                  A 13572    	POP	BC
043AC9 C1                  A 13573    	POP	BC
043ACA DD2FFD              A 13574    	LD	(IX+%FFFFFFFD),HL
                           A 13575    ; 4303					if (res != FR_OK) break
                           A 13576    .LINE 4303
                           A 13577    
043ACD CD E5 46 04         A 13578    	CALL	__icmpzero
043AD1 C2 13 3C 04         A 13579    	JR	NZ,L_655
                           A 13580    ; 4304					dj.obj.sclust = ld_clus
                           A 13581    .LINE 4304
                           A 13582    
043AD5 DD07DA              A 13583    	LD	BC,(IX+%FFFFFFDA)
043AD8 C5                  A 13584    	PUSH	BC
043AD9 DD07F4              A 13585    	LD	BC,(IX+%FFFFFFF4)
043ADC C5                  A 13586    	PUSH	BC
043ADD CD CC 18 04         A 13587    	CALL	_ld_clust
043AE1 C1                  A 13588    	POP	BC
043AE2 C1                  A 13589    	POP	BC
043AE3 DD2FC6              A 13590    	LD	(IX+%FFFFFFC6),HL
043AE6 DD73C9              A 13591    	LD	(IX+%FFFFFFC9),E
                           A 13592    ; 4305					res = dir_sdi(&dj, 0);
                           A 13593    .LINE 4305
                           A 13594    
043AE9 01000000            A 13595    	LD	BC,0
043AED C5                  A 13596    	PUSH	BC
043AEE C5                  A 13597    	PUSH	BC
043AEF ED65BF              A 13598    	PEA	IX+%FFFFFFBF
043AF2 CD B4 14 04         A 13599    	CALL	_dir_sdi
043AF6 C1                  A 13600    	POP	BC
043AF7 C1                  A 13601    	POP	BC
043AF8 C1                  A 13602    	POP	BC
043AF9 DD2FFD              A 13603    	LD	(IX+%FFFFFFFD),HL
                           A 13604    ; 4306					if (res != FR_OK) break
                           A 13605    .LINE 4306
                           A 13606    
043AFC CD E5 46 04         A 13607    	CALL	__icmpzero
043B00 C2 13 3C 04         A 13608    	JR	NZ,L_655
                           A 13609    ; 4307					do {					
043B04                     A 13610    L_626:
                           A 13611    .LINE 4307
                           A 13612    
                           A 13613    ; 4308						res = DIR_READ_FILE
                           A 13614    .LINE 4308
                           A 13615    
043B04 01000000            A 13616    	LD	BC,0
043B08 C5                  A 13617    	PUSH	BC
043B09 ED65BF              A 13618    	PEA	IX+%FFFFFFBF
043B0C CD BA 1B 04         A 13619    	CALL	_dir_read
043B10 C1                  A 13620    	POP	BC
043B11 C1                  A 13621    	POP	BC
043B12 DD2FFD              A 13622    	LD	(IX+%FFFFFFFD),HL
                           A 13623    ; 4309						if (res != FR_OK) b
                           A 13624    .LINE 4309
                           A 13625    
043B15 CD E5 46 04         A 13626    	CALL	__icmpzero
043B19 20 31               A 13627    	JR	NZ,L_630
                           A 13628    ; 4310						if (ccl == ld_clust
                           A 13629    .LINE 4310
                           A 13630    
043B1B DD07DA              A 13631    	LD	BC,(IX+%FFFFFFDA)
043B1E C5                  A 13632    	PUSH	BC
043B1F DD07F4              A 13633    	LD	BC,(IX+%FFFFFFF4)
043B22 C5                  A 13634    	PUSH	BC
043B23 CD CC 18 04         A 13635    	CALL	_ld_clust
043B27 C1                  A 13636    	POP	BC
043B28 C1                  A 13637    	POP	BC
043B29 DD07ED              A 13638    	LD	BC,(IX+%FFFFFFED)
043B2C DD7EF0              A 13639    	LD	A,(IX+%FFFFFFF0)
043B2F CD 88 47 04         A 13640    	CALL	__lcmpu
043B33 28 17               A 13641    	JR	Z,L_630
                           A 13642    ; 4311						res = dir_next(&dj,
                           A 13643    .LINE 4311
                           A 13644    
043B35 01000000            A 13645    	LD	BC,0
043B39 C5                  A 13646    	PUSH	BC
043B3A ED65BF              A 13647    	PEA	IX+%FFFFFFBF
043B3D CD BA 16 04         A 13648    	CALL	_dir_next
043B41 C1                  A 13649    	POP	BC
043B42 C1                  A 13650    	POP	BC
043B43 DD2FFD              A 13651    	LD	(IX+%FFFFFFFD),HL
                           A 13652    ; 4312					} while (res == FR_OK);
                           A 13653    .LINE 4312
                           A 13654    
043B46 CD E5 46 04         A 13655    	CALL	__icmpzero
043B4A 28 B8               A 13656    	JR	Z,L_626
043B4C                     A 13657    L_630:
                           A 13658    ; 4313					if (res == FR_NO_FILE) 
                           A 13659    .LINE 4313
                           A 13660    
043B4C 01040000            A 13661    	LD	BC,4
043B50 DD27FD              A 13662    	LD	HL,(IX+%FFFFFFFD)
043B53 B7                  A 13663    	OR	A,A
043B54 ED42                A 13664    	SBC	HL,BC
043B56 20 07               A 13665    	JR	NZ,L_632
043B58 01020000            A 13666    	LD	BC,2
043B5C DD0FFD              A 13667    	LD	(IX+%FFFFFFFD),BC
043B5F                     A 13668    L_632:
                           A 13669    ; 4314					if (res != FR_OK) break
                           A 13670    .LINE 4314
                           A 13671    
043B5F DD27FD              A 13672    	LD	HL,(IX+%FFFFFFFD)
043B62 CD E5 46 04         A 13673    	CALL	__icmpzero
043B66 C2 13 3C 04         A 13674    	JR	NZ,L_655
                           A 13675    ; 4315					get_fileinfo(&dj, &fno)
                           A 13676    .LINE 4315
                           A 13677    
043B6A DDE5E1              A 13678    	LD	HL,IX
043B6D 01A9FEFF            A 13679    	LD	BC,-343
043B71 09                  A 13680    	ADD	HL,BC
043B72 E5C1                A 13681    	LD	BC,HL
043B74 C5                  A 13682    	PUSH	BC
043B75 ED65BF              A 13683    	PEA	IX+%FFFFFFBF
043B78 CD 36 1F 04         A 13684    	CALL	_get_fileinfo
043B7C C1                  A 13685    	POP	BC
043B7D C1                  A 13686    	POP	BC
                           A 13687    ; 4316					for (n = 0; fno.fname[n
                           A 13688    .LINE 4316
                           A 13689    
043B7E 01000000            A 13690    	LD	BC,0
043B82 DD0FF7              A 13691    	LD	(IX+%FFFFFFF7),BC
043B85 18 07               A 13692    	JR	L_637
043B87                     A 13693    L_635:
043B87 DD07F7              A 13694    	LD	BC,(IX+%FFFFFFF7)
043B8A 03                  A 13695    	INC	BC
043B8B DD0FF7              A 13696    	LD	(IX+%FFFFFFF7),BC
043B8E                     A 13697    L_637:
043B8E DD07F7              A 13698    	LD	BC,(IX+%FFFFFFF7)
043B91 DDE5E1              A 13699    	LD	HL,IX
043B94 11BFFEFF            A 13700    	LD	DE,-321
043B98 19                  A 13701    	ADD	HL,DE
043B99 09                  A 13702    	ADD	HL,BC
043B9A 7E                  A 13703    	LD	A,(HL)
043B9B B7                  A 13704    	OR	A,A
043B9C 20 E9               A 13705    	JR	NZ,L_635
                           A 13706    ; 4317					if (i < n + 1) {	/* 
                           A 13707    .LINE 4317
                           A 13708    
043B9E DD07F7              A 13709    	LD	BC,(IX+%FFFFFFF7)
043BA1 03                  A 13710    	INC	BC
043BA2 DD27FA              A 13711    	LD	HL,(IX+%FFFFFFFA)
043BA5 B7                  A 13712    	OR	A,A
043BA6 ED42                A 13713    	SBC	HL,BC
043BA8 30 35               A 13714    	JR	NC,L_640
                           A 13715    ; 4318						res = FR_NOT_ENOUGH
                           A 13716    .LINE 4318
                           A 13717    
043BAA 01110000            A 13718    	LD	BC,17
043BAE DD0FFD              A 13719    	LD	(IX+%FFFFFFFD),BC
043BB1 18 60               A 13720    	JR	L_655
                           A 13721    ; 4319					}
                           A 13722    .LINE 4319
                           A 13723    
                           A 13724    ; 4320					while (n) buff[--i] = f
                           A 13725    .LINE 4320
                           A 13726    
043BB3                     A 13727    L_641:
043BB3 DD31F7              A 13728    	LD	IY,(IX+%FFFFFFF7)
043BB6 ED03FF              A 13729    	LEA	BC,IY+%FFFFFFFF
043BB9 DD0FF7              A 13730    	LD	(IX+%FFFFFFF7),BC
043BBC DD31FA              A 13731    	LD	IY,(IX+%FFFFFFFA)
043BBF ED33FF              A 13732    	LEA	IY,IY+%FFFFFFFF
043BC2 DD3EFA              A 13733    	LD	(IX+%FFFFFFFA),IY
043BC5 DD07F7              A 13734    	LD	BC,(IX+%FFFFFFF7)
043BC8 DDE5E1              A 13735    	LD	HL,IX
043BCB 11BFFEFF            A 13736    	LD	DE,-321
043BCF 19                  A 13737    	ADD	HL,DE
043BD0 09                  A 13738    	ADD	HL,BC
043BD1 E5FDE1              A 13739    	LD	IY,HL
043BD4 DD07FA              A 13740    	LD	BC,(IX+%FFFFFFFA)
043BD7 DD2706              A 13741    	LD	HL,(IX+%6)
043BDA 09                  A 13742    	ADD	HL,BC
043BDB FD7E00              A 13743    	LD	A,(IY)
043BDE 77                  A 13744    	LD	(HL),A
043BDF                     A 13745    L_640:
043BDF DD27F7              A 13746    	LD	HL,(IX+%FFFFFFF7)
043BE2 CD E5 46 04         A 13747    	CALL	__icmpzero
043BE6 20 CB               A 13748    	JR	NZ,L_641
                           A 13749    ; 4321					buff[--i] = '/';
                           A 13750    .LINE 4321
                           A 13751    
043BE8 DD31FA              A 13752    	LD	IY,(IX+%FFFFFFFA)
043BEB ED33FF              A 13753    	LEA	IY,IY+%FFFFFFFF
043BEE DD3EFA              A 13754    	LD	(IX+%FFFFFFFA),IY
043BF1 FDE5C1              A 13755    	LD	BC,IY
043BF4 DD2706              A 13756    	LD	HL,(IX+%6)
043BF7 09                  A 13757    	ADD	HL,BC
043BF8 362F                A 13758    	LD	(HL),%2F
                           A 13759    ; 4322				}
043BFA                     A 13760    L_644:
                           A 13761    .LINE 4322
                           A 13762    
043BFA DD07C6              A 13763    	LD	BC,(IX+%FFFFFFC6)
043BFD DD7EC9              A 13764    	LD	A,(IX+%FFFFFFC9)
043C00 DD0FED              A 13765    	LD	(IX+%FFFFFFED),BC
043C03 DD77F0              A 13766    	LD	(IX+%FFFFFFF0),A
043C06 C5E1                A 13767    	LD	HL,BC
043C08 DD5EF0              A 13768    	LD	E,(IX+%FFFFFFF0)
043C0B CD B8 45 04         A 13769    	CALL	__lcmpzero
043C0F C2 96 3A 04         A 13770    	JR	NZ,L_645
                           A 13771    ; 4323			}
043C13                     A 13772    L_655:
                           A 13773    .LINE 4323
                           A 13774    
                           A 13775    ; 4324			if (res == FR_OK) {
                           A 13776    .LINE 4324
                           A 13777    
043C13 DD27FD              A 13778    	LD	HL,(IX+%FFFFFFFD)
043C16 CD E5 46 04         A 13779    	CALL	__icmpzero
043C1A 20 60               A 13780    	JR	NZ,L_656
                           A 13781    ; 4325				if (i == len) buff[--i] = '
                           A 13782    .LINE 4325
                           A 13783    
043C1C DD0709              A 13784    	LD	BC,(IX+%9)
043C1F DD27FA              A 13785    	LD	HL,(IX+%FFFFFFFA)
043C22 B7                  A 13786    	OR	A,A
043C23 ED42                A 13787    	SBC	HL,BC
043C25 20 12               A 13788    	JR	NZ,L_653
043C27 DD31FA              A 13789    	LD	IY,(IX+%FFFFFFFA)
043C2A ED33FF              A 13790    	LEA	IY,IY+%FFFFFFFF
043C2D DD3EFA              A 13791    	LD	(IX+%FFFFFFFA),IY
043C30 FDE5C1              A 13792    	LD	BC,IY
043C33 DD2706              A 13793    	LD	HL,(IX+%6)
043C36 09                  A 13794    	ADD	HL,BC
043C37 362F                A 13795    	LD	(HL),%2F
043C39                     A 13796    L_653:
                           A 13797    ; 4326	#if FF_VOLUMES >= 2			/* Put driv
                           A 13798    ; 4327				vl = 0;
                           A 13799    ; 4328	#if FF_STR_VOLUME_ID >= 1	/* String v
                           A 13800    ; 4329				for (n = 0, vp = (const cha
                           A 13801    ; 4330				if (i >= n + 2) {
                           A 13802    ; 4331					if (FF_STR_VOLUME_ID ==
                           A 13803    ; 4332					for (vl = 0; vl < n; *t
                           A 13804    ; 4333					if (FF_STR_VOLUME_ID ==
                           A 13805    ; 4334					vl++;
                           A 13806    ; 4335				}
                           A 13807    ; 4336	#else						/* Numeric 
                           A 13808    ; 4337				if (i >= 3) {
                           A 13809    ; 4338					*tp++ = (TCHAR)'0' + Cu
                           A 13810    ; 4339					*tp++ = (TCHAR)':';
                           A 13811    ; 4340					vl = 2;
                           A 13812    ; 4341				}
                           A 13813    ; 4342	#endif
                           A 13814    ; 4343				if (vl == 0) res = FR_NOT_E
                           A 13815    ; 4344	#endif
                           A 13816    ; 4345				/* Add current directory pa
                           A 13817    ; 4346				if (res == FR_OK) {
                           A 13818    .LINE 4346
                           A 13819    
043C39 DD27FD              A 13820    	LD	HL,(IX+%FFFFFFFD)
043C3C CD E5 46 04         A 13821    	CALL	__icmpzero
043C40 20 3A               A 13822    	JR	NZ,L_656
                           A 13823    ; 4347					do *tp++ = buff[i++]; w
043C42                     A 13824    L_650:
                           A 13825    .LINE 4347
                           A 13826    
043C42 DD27F1              A 13827    	LD	HL,(IX+%FFFFFFF1)
043C45 01A3FCFF            A 13828    	LD	BC,-861
043C49 CD 43 45 04         A 13829    	CALL	__istix
043C4D DD07FA              A 13830    	LD	BC,(IX+%FFFFFFFA)
043C50 DD2706              A 13831    	LD	HL,(IX+%6)
043C53 09                  A 13832    	ADD	HL,BC
043C54 E5FDE1              A 13833    	LD	IY,HL
043C57 01A3FCFF            A 13834    	LD	BC,-861
043C5B CD 93 48 04         A 13835    	CALL	__ildix
043C5F FD7E00              A 13836    	LD	A,(IY)
043C62 77                  A 13837    	LD	(HL),A
043C63 DD07FA              A 13838    	LD	BC,(IX+%FFFFFFFA)
043C66 03                  A 13839    	INC	BC
043C67 DD0FFA              A 13840    	LD	(IX+%FFFFFFFA),BC
043C6A DD07F1              A 13841    	LD	BC,(IX+%FFFFFFF1)
043C6D 03                  A 13842    	INC	BC
043C6E DD0FF1              A 13843    	LD	(IX+%FFFFFFF1),BC
043C71 DD0709              A 13844    	LD	BC,(IX+%9)
043C74 DD27FA              A 13845    	LD	HL,(IX+%FFFFFFFA)
043C77 B7                  A 13846    	OR	A,A
043C78 ED42                A 13847    	SBC	HL,BC
043C7A 38 C6               A 13848    	JR	C,L_650
                           A 13849    ; 4348				}
                           A 13850    ; 4349			}
043C7C                     A 13851    L_656:
                           A 13852    .LINE 4349
                           A 13853    
                           A 13854    ; 4350			FREE_NAMBUF();
                           A 13855    ; 4351		}
043C7C                     A 13856    L_658:
                           A 13857    .LINE 4351
                           A 13858    
                           A 13859    ; 4352	
                           A 13860    ; 4353		*tp = 0;
                           A 13861    .LINE 4353
                           A 13862    
043C7C DD27F1              A 13863    	LD	HL,(IX+%FFFFFFF1)
043C7F 3600                A 13864    	LD	(HL),%0
                           A 13865    ; 4354		LEAVE_FF(fs, res);
                           A 13866    .LINE 4354
                           A 13867    
043C81 DD27FD              A 13868    	LD	HL,(IX+%FFFFFFFD)
                           A 13869    ; 4355	}
                           A 13870    .LINE 4355
                           A 13871    
043C84 DDF9                A 13872    	LD	SP,IX
043C86 DDE1                A 13873    	POP	IX
043C88 C9                  A 13874    	RET	
                           A 13875    
                           A 13876    
                           A 13877    ;**************************** _f_getcwd *******
                           A 13878    ;Name                         Addr/Register   S
                           A 13879    ;lbuf                                IX-855    
                           A 13880    ;fno                                 IX-343    
                           A 13881    ;dj                                   IX-65    
                           A 13882    ;ccl                                  IX-19    
                           A 13883    ;tp                                   IX-15    
                           A 13884    ;fs                                   IX-12    
                           A 13885    ;n                                     IX-9    
                           A 13886    ;i                                     IX-6    
                           A 13887    ;res                                   IX-3    
                           A 13888    ;len                                   IX+9    
                           A 13889    ;buff                                  IX+6    
                           A 13890    
                           A 13891    
                           A 13892    ; Stack Frame Size: 873 (bytes)
                           A 13893    ;       Spill Code: -1 (instruction)
                           A 13894    
                           A 13895    
                           A 13896    .ENDFUNC "f_getcwd",4355,"_f_getcwd"
                           A 13897    ; 4356	
                           A 13898    ; 4357	#endif /* FF_FS_RPATH >= 2 */
                           A 13899    ; 4358	#endif /* FF_FS_RPATH >= 1 */
                           A 13900    ; 4359	
                           A 13901    ; 4360	
                           A 13902    ; 4361	
                           A 13903    ; 4362	#if FF_FS_MINIMIZE <= 2
                           A 13904    ; 4363	/*-------------------------------------
                           A 13905    ; 4364	/* Seek File Read/Write Pointer        
                           A 13906    ; 4365	/*-------------------------------------
                           A 13907    ; 4366	
                           A 13908    ; 4367	FRESULT f_lseek (
                           A 13909    ; 4368		FIL* fp,		/* Pointer to the f
                           A 13910    ; 4369		FSIZE_t ofs		/* File pointer fro
                           A 13911    ; 4370	)
                           A 13912    ; 4371	{
                           A 13913    ; 4372		FRESULT res;
                           A 13914    ; 4373		FATFS *fs;
                           A 13915    ; 4374		DWORD clst, bcs;
                           A 13916    ; 4375		LBA_t nsect;
                           A 13917    ; 4376		FSIZE_t ifptr;
                           A 13918    ; 4377	#if FF_USE_FASTSEEK
                           A 13919    ; 4378		DWORD cl, pcl, ncl, tcl, tlen, ulen
                           A 13920    ; 4379		DWORD *tbl;
                           A 13921    ; 4380		LBA_t dsc;
                           A 13922    ; 4381	#endif
                           A 13923    ; 4382	
                           A 13924    ; 4383		res = validate(&fp->obj, &fs);		
                           A 13925    ; 4384		if (res == FR_OK) res = (FRESULT)fp
                           A 13926    ; 4385	#if FF_FS_EXFAT && !FF_FS_READONLY
                           A 13927    ; 4386		if (res == FR_OK && fs->fs_type == 
                           A 13928    ; 4387			res = fill_last_frag(&fp->obj, 
                           A 13929    ; 4388		}
                           A 13930    ; 4389	#endif
                           A 13931    ; 4390		if (res != FR_OK) LEAVE_FF(fs, res)
                           A 13932    ; 4391	
                           A 13933    ; 4392	#if FF_USE_FASTSEEK
                           A 13934    ; 4393		if (fp->cltbl) {	/* Fast seek */
                           A 13935    ; 4394			if (ofs == CREATE_LINKMAP) {	
                           A 13936    ; 4395				tbl = fp->cltbl;
                           A 13937    ; 4396				tlen = *tbl++; ulen = 2;	
                           A 13938    ; 4397				cl = fp->obj.sclust;		
                           A 13939    ; 4398				if (cl != 0) {
                           A 13940    ; 4399					do {
                           A 13941    ; 4400						/* Get a fragment *
                           A 13942    ; 4401						tcl = cl; ncl = 0; 
                           A 13943    ; 4402						do {
                           A 13944    ; 4403							pcl = cl; ncl++
                           A 13945    ; 4404							cl = get_fat(&f
                           A 13946    ; 4405							if (cl <= 1) AB
                           A 13947    ; 4406							if (cl == 0xFFF
                           A 13948    ; 4407						} while (cl == pcl 
                           A 13949    ; 4408						if (ulen <= tlen) {
                           A 13950    ; 4409							*tbl++ = ncl; *
                           A 13951    ; 4410						}
                           A 13952    ; 4411					} while (cl < fs->n_fat
                           A 13953    ; 4412				}
                           A 13954    ; 4413				*fp->cltbl = ulen;	/* Numb
                           A 13955    ; 4414				if (ulen <= tlen) {
                           A 13956    ; 4415					*tbl = 0;		/* Term
                           A 13957    ; 4416				} else {
                           A 13958    ; 4417					res = FR_NOT_ENOUGH_COR
                           A 13959    ; 4418				}
                           A 13960    ; 4419			} else {						
                           A 13961    ; 4420				if (ofs > fp->obj.objsize) 
                           A 13962    ; 4421				fp->fptr = ofs;				
                           A 13963    ; 4422				if (ofs > 0) {
                           A 13964    ; 4423					fp->clust = clmt_clust(
                           A 13965    ; 4424					dsc = clst2sect(fs, fp-
                           A 13966    ; 4425					if (dsc == 0) ABORT(fs,
                           A 13967    ; 4426					dsc += (DWORD)((ofs - 1
                           A 13968    ; 4427					if (fp->fptr % SS(fs) &
                           A 13969    ; 4428	#if !FF_FS_TINY
                           A 13970    ; 4429	#if !FF_FS_READONLY
                           A 13971    ; 4430						if (fp->flag & FA_D
                           A 13972    ; 4431							if (disk_write(
                           A 13973    ; 4432							fp->flag &= (BY
                           A 13974    ; 4433						}
                           A 13975    ; 4434	#endif
                           A 13976    ; 4435						if (disk_read(fs->p
                           A 13977    ; 4436	#endif
                           A 13978    ; 4437						fp->sect = dsc;
                           A 13979    ; 4438					}
                           A 13980    ; 4439				}
                           A 13981    ; 4440			}
                           A 13982    ; 4441		} else
                           A 13983    ; 4442	#endif
                           A 13984    ; 4443	
                           A 13985    ; 4444		/* Normal Seek */
                           A 13986    ; 4445		{
                           A 13987    ; 4446	#if FF_FS_EXFAT
                           A 13988    ; 4447			if (fs->fs_type != FS_EXFAT && 
                           A 13989    ; 4448	#endif
                           A 13990    ; 4449			if (ofs > fp->obj.objsize && (F
                           A 13991    ; 4450				ofs = fp->obj.objsize;
                           A 13992    ; 4451			}
                           A 13993    ; 4452			ifptr = fp->fptr;
                           A 13994    ; 4453			fp->fptr = nsect = 0;
                           A 13995    ; 4454			if (ofs > 0) {
                           A 13996    ; 4455				bcs = (DWORD)fs->csize * SS
                           A 13997    ; 4456				if (ifptr > 0 &&
                           A 13998    ; 4457					(ofs - 1) / bcs >= (ifp
                           A 13999    ; 4458					fp->fptr = (ifptr - 1) 
                           A 14000    ; 4459					ofs -= fp->fptr;
                           A 14001    ; 4460					clst = fp->clust;
                           A 14002    ; 4461				} else {					
                           A 14003    ; 4462					clst = fp->obj.sclust;	
                           A 14004    ; 4463	#if !FF_FS_READONLY
                           A 14005    ; 4464					if (clst == 0) {		
                           A 14006    ; 4465						clst = create_chain
                           A 14007    ; 4466						if (clst == 1) ABOR
                           A 14008    ; 4467						if (clst == 0xFFFFF
                           A 14009    ; 4468						fp->obj.sclust = cl
                           A 14010    ; 4469					}
                           A 14011    ; 4470	#endif
                           A 14012    ; 4471					fp->clust = clst;
                           A 14013    ; 4472				}
                           A 14014    ; 4473				if (clst != 0) {
                           A 14015    ; 4474					while (ofs > bcs) {		
                           A 14016    ; 4475						ofs -= bcs; fp->fpt
                           A 14017    ; 4476	#if !FF_FS_READONLY
                           A 14018    ; 4477						if (fp->flag & FA_W
                           A 14019    ; 4478							if (FF_FS_EXFAT
                           A 14020    ; 4479								fp->obj.obj
                           A 14021    ; 4480								fp->flag |=
                           A 14022    ; 4481							}
                           A 14023    ; 4482							clst = create_c
                           A 14024    ; 4483							if (clst == 0) 
                           A 14025    ; 4484								ofs = 0; br
                           A 14026    ; 4485							}
                           A 14027    ; 4486						} else
                           A 14028    ; 4487	#endif
                           A 14029    ; 4488						{
                           A 14030    ; 4489							clst = get_fat(
                           A 14031    ; 4490						}
                           A 14032    ; 4491						if (clst == 0xFFFFF
                           A 14033    ; 4492						if (clst <= 1 || cl
                           A 14034    ; 4493						fp->clust = clst;
                           A 14035    ; 4494					}
                           A 14036    ; 4495					fp->fptr += ofs;
                           A 14037    ; 4496					if (ofs % SS(fs)) {
                           A 14038    ; 4497						nsect = clst2sect(f
                           A 14039    ; 4498						if (nsect == 0) ABO
                           A 14040    ; 4499						nsect += (DWORD)(of
                           A 14041    ; 4500					}
                           A 14042    ; 4501				}
                           A 14043    ; 4502			}
                           A 14044    ; 4503			if (!FF_FS_READONLY && fp->fptr
                           A 14045    ; 4504				fp->obj.objsize = fp->fptr;
                           A 14046    ; 4505				fp->flag |= FA_MODIFIED;
                           A 14047    ; 4506			}
                           A 14048    ; 4507			if (fp->fptr % SS(fs) && nsect 
                           A 14049    ; 4508	#if !FF_FS_TINY
                           A 14050    ; 4509	#if !FF_FS_READONLY
                           A 14051    ; 4510				if (fp->flag & FA_DIRTY) {	
                           A 14052    ; 4511					if (disk_write(fs->pdrv
                           A 14053    ; 4512					fp->flag &= (BYTE)~FA_D
                           A 14054    ; 4513				}
                           A 14055    ; 4514	#endif
                           A 14056    ; 4515				if (disk_read(fs->pdrv, fp-
                           A 14057    ; 4516	#endif
                           A 14058    ; 4517				fp->sect = nsect;
                           A 14059    ; 4518			}
                           A 14060    ; 4519		}
                           A 14061    ; 4520	
                           A 14062    ; 4521		LEAVE_FF(fs, res);
                           A 14063    ; 4522	}
                           A 14064    ; 4523	
                           A 14065    ; 4524	
                           A 14066    ; 4525	
                           A 14067    ; 4526	#if FF_FS_MINIMIZE <= 1
                           A 14068    ; 4527	/*-------------------------------------
                           A 14069    ; 4528	/* Create a Directory Object           
                           A 14070    ; 4529	/*-------------------------------------
                           A 14071    ; 4530	
                           A 14072    ; 4531	FRESULT f_opendir (
                           A 14073    ; 4532		DIR* dp,			/* Pointer to d
                           A 14074    ; 4533		const TCHAR* path	/* Pointer to t
                           A 14075    ; 4534	)
                           A 14076    ; 4535	{
                           A 14077    ; 4536		FRESULT res;
                           A 14078    ; 4537		FATFS *fs;
                           A 14079    ; 4538		DEF_NAMBUF
                           A 14080    ; 4539	
                           A 14081    ; 4540	
                           A 14082    ; 4541		if (!dp) return FR_INVALID_OBJECT;
                           A 14083    ; 4542	
                           A 14084    ; 4543		/* Get logical drive */
                           A 14085    ; 4544		res = mount_volume(&path, &fs, 0);
                           A 14086    ; 4545		if (res == FR_OK) {
                           A 14087    ; 4546			dp->obj.fs = fs;
                           A 14088    ; 4547			INIT_NAMBUF(fs);
                           A 14089    ; 4548			res = follow_path(dp, path);	
                           A 14090    ; 4549			if (res == FR_OK) {				
                           A 14091    ; 4550				if (!(dp->fn[NSFLAG] & NS_N
                           A 14092    ; 4551					if (dp->obj.attr & AM_D
                           A 14093    ; 4552	#if FF_FS_EXFAT
                           A 14094    ; 4553						if (fs->fs_type == 
                           A 14095    ; 4554							dp->obj.c_scl =
                           A 14096    ; 4555							dp->obj.c_size 
                           A 14097    ; 4556							dp->obj.c_ofs =
                           A 14098    ; 4557							init_alloc_info
                           A 14099    ; 4558						} else
                           A 14100    ; 4559	#endif
                           A 14101    ; 4560						{
                           A 14102    ; 4561							dp->obj.sclust 
                           A 14103    ; 4562						}
                           A 14104    ; 4563					} else {				
                           A 14105    ; 4564						res = FR_NO_PATH;
                           A 14106    ; 4565					}
                           A 14107    ; 4566				}
                           A 14108    ; 4567				if (res == FR_OK) {
                           A 14109    ; 4568					dp->obj.id = fs->id;
                           A 14110    ; 4569					res = dir_sdi(dp, 0);	
                           A 14111    ; 4570	#if FF_FS_LOCK != 0
                           A 14112    ; 4571					if (res == FR_OK) {
                           A 14113    ; 4572						if (dp->obj.sclust 
                           A 14114    ; 4573							dp->obj.lockid 
                           A 14115    ; 4574							if (!dp->obj.lo
                           A 14116    ; 4575						} else {
                           A 14117    ; 4576							dp->obj.lockid 
                           A 14118    ; 4577						}
                           A 14119    ; 4578					}
                           A 14120    ; 4579	#endif
                           A 14121    ; 4580				}
                           A 14122    ; 4581			}
                           A 14123    ; 4582			FREE_NAMBUF();
                           A 14124    ; 4583			if (res == FR_NO_FILE) res = FR
                           A 14125    ; 4584		}
                           A 14126    ; 4585		if (res != FR_OK) dp->obj.fs = 0;	
                           A 14127    ; 4586	
                           A 14128    ; 4587		LEAVE_FF(fs, res);
                           A 14129    ; 4588	}
                           A 14130    ; 4589	
                           A 14131    ; 4590	
                           A 14132    ; 4591	
                           A 14133    ; 4592	
                           A 14134    ; 4593	/*-------------------------------------
                           A 14135    ; 4594	/* Close Directory                     
                           A 14136    ; 4595	/*-------------------------------------
                           A 14137    ; 4596	
                           A 14138    ; 4597	FRESULT f_closedir (
                           A 14139    ; 4598		DIR *dp		/* Pointer to the direc
                           A 14140    ; 4599	)
                           A 14141    ; 4600	{
                           A 14142    ; 4601		FRESULT res;
                           A 14143    ; 4602		FATFS *fs;
                           A 14144    ; 4603	
                           A 14145    ; 4604	
                           A 14146    ; 4605		res = validate(&dp->obj, &fs);	/* 
                           A 14147    ; 4606		if (res == FR_OK) {
                           A 14148    ; 4607	#if FF_FS_LOCK != 0
                           A 14149    ; 4608			if (dp->obj.lockid) res = dec_l
                           A 14150    ; 4609			if (res == FR_OK) dp->obj.fs = 
                           A 14151    ; 4610	#else
                           A 14152    ; 4611			dp->obj.fs = 0;	/* Invalidate d
                           A 14153    ; 4612	#endif
                           A 14154    ; 4613	#if FF_FS_REENTRANT
                           A 14155    ; 4614			unlock_fs(fs, FR_OK);		/* 
                           A 14156    ; 4615	#endif
                           A 14157    ; 4616		}
                           A 14158    ; 4617		return res;
                           A 14159    ; 4618	}
                           A 14160    ; 4619	
                           A 14161    ; 4620	
                           A 14162    ; 4621	
                           A 14163    ; 4622	
                           A 14164    ; 4623	/*-------------------------------------
                           A 14165    ; 4624	/* Read Directory Entries in Sequence  
                           A 14166    ; 4625	/*-------------------------------------
                           A 14167    ; 4626	
                           A 14168    ; 4627	FRESULT f_readdir (
                           A 14169    ; 4628		DIR* dp,			/* Pointer to t
                           A 14170    ; 4629		FILINFO* fno		/* Pointer to f
                           A 14171    ; 4630	)
                           A 14172    ; 4631	{
                           A 14173    ; 4632		FRESULT res;
                           A 14174    ; 4633		FATFS *fs;
                           A 14175    ; 4634		DEF_NAMBUF
                           A 14176    ; 4635	
                           A 14177    ; 4636	
                           A 14178    ; 4637		res = validate(&dp->obj, &fs);	/* 
                           A 14179    ; 4638		if (res == FR_OK) {
                           A 14180    ; 4639			if (!fno) {
                           A 14181    ; 4640				res = dir_sdi(dp, 0);		
                           A 14182    ; 4641			} else {
                           A 14183    ; 4642				INIT_NAMBUF(fs);
                           A 14184    ; 4643				res = DIR_READ_FILE(dp);	
                           A 14185    ; 4644				if (res == FR_NO_FILE) res 
                           A 14186    ; 4645				if (res == FR_OK) {			
                           A 14187    ; 4646					get_fileinfo(dp, fno);	
                           A 14188    ; 4647					res = dir_next(dp, 0);	
                           A 14189    ; 4648					if (res == FR_NO_FILE) 
                           A 14190    ; 4649				}
                           A 14191    ; 4650				FREE_NAMBUF();
                           A 14192    ; 4651			}
                           A 14193    ; 4652		}
                           A 14194    ; 4653		LEAVE_FF(fs, res);
                           A 14195    ; 4654	}
                           A 14196    ; 4655	
                           A 14197    ; 4656	
                           A 14198    ; 4657	
                           A 14199    ; 4658	#if FF_USE_FIND
                           A 14200    ; 4659	/*-------------------------------------
                           A 14201    ; 4660	/* Find Next File                      
                           A 14202    ; 4661	/*-------------------------------------
                           A 14203    ; 4662	
                           A 14204    ; 4663	FRESULT f_findnext (
                           A 14205    ; 4664		DIR* dp,		/* Pointer to the o
                           A 14206    ; 4665		FILINFO* fno	/* Pointer to the f
                           A 14207    ; 4666	)
                           A 14208    ; 4667	{
                           A 14209    ; 4668		FRESULT res;
                           A 14210    ; 4669	
                           A 14211    ; 4670	
                           A 14212    ; 4671		for (;;) {
                           A 14213    ; 4672			res = f_readdir(dp, fno);		
                           A 14214    ; 4673			if (res != FR_OK || !fno || !fn
                           A 14215    ; 4674			if (pattern_match(dp->pat, fno-
                           A 14216    ; 4675	#if FF_USE_LFN && FF_USE_FIND == 2
                           A 14217    ; 4676			if (pattern_match(dp->pat, fno-
                           A 14218    ; 4677	#endif
                           A 14219    ; 4678		}
                           A 14220    ; 4679		return res;
                           A 14221    ; 4680	}
                           A 14222    ; 4681	
                           A 14223    ; 4682	
                           A 14224    ; 4683	
                           A 14225    ; 4684	/*-------------------------------------
                           A 14226    ; 4685	/* Find First File                     
                           A 14227    ; 4686	/*-------------------------------------
                           A 14228    ; 4687	
                           A 14229    ; 4688	FRESULT f_findfirst (
                           A 14230    ; 4689		DIR* dp,				/* Pointer 
                           A 14231    ; 4690		FILINFO* fno,			/* Pointer 
                           A 14232    ; 4691		const TCHAR* path,		/* Pointer 
                           A 14233    ; 4692		const TCHAR* pattern	/* Pointer 
                           A 14234    ; 4693	)
                           A 14235    ; 4694	{
                           A 14236    ; 4695		FRESULT res;
                           A 14237    ; 4696	
                           A 14238    ; 4697	
                           A 14239    ; 4698		dp->pat = pattern;		/* Save poi
                           A 14240    ; 4699		res = f_opendir(dp, path);		/* 
                           A 14241    ; 4700		if (res == FR_OK) {
                           A 14242    ; 4701			res = f_findnext(dp, fno);	/* 
                           A 14243    ; 4702		}
                           A 14244    ; 4703		return res;
                           A 14245    ; 4704	}
                           A 14246    ; 4705	
                           A 14247    ; 4706	#endif	/* FF_USE_FIND */
                           A 14248    ; 4707	
                           A 14249    ; 4708	
                           A 14250    ; 4709	
                           A 14251    ; 4710	#if FF_FS_MINIMIZE == 0
                           A 14252    ; 4711	/*-------------------------------------
                           A 14253    ; 4712	/* Get File Status                     
                           A 14254    ; 4713	/*-------------------------------------
                           A 14255    ; 4714	
                           A 14256    ; 4715	FRESULT f_stat (
                           A 14257    ; 4716		const TCHAR* path,	/* Pointer to t
                           A 14258    ; 4717		FILINFO* fno		/* Pointer to f
                           A 14259    ; 4718	)
                           A 14260    ; 4719	{
                           A 14261    ; 4720		FRESULT res;
                           A 14262    ; 4721		DIR dj;
                           A 14263    ; 4722		DEF_NAMBUF
                           A 14264    ; 4723	
                           A 14265    ; 4724	
                           A 14266    ; 4725		/* Get logical drive */
                           A 14267    ; 4726		res = mount_volume(&path, &dj.obj.f
                           A 14268    ; 4727		if (res == FR_OK) {
                           A 14269    ; 4728			INIT_NAMBUF(dj.obj.fs);
                           A 14270    ; 4729			res = follow_path(&dj, path);	
                           A 14271    ; 4730			if (res == FR_OK) {				
                           A 14272    ; 4731				if (dj.fn[NSFLAG] & NS_NONA
                           A 14273    ; 4732					res = FR_INVALID_NAME;
                           A 14274    ; 4733				} else {					
                           A 14275    ; 4734					if (fno) get_fileinfo(&
                           A 14276    ; 4735				}
                           A 14277    ; 4736			}
                           A 14278    ; 4737			FREE_NAMBUF();
                           A 14279    ; 4738		}
                           A 14280    ; 4739	
                           A 14281    ; 4740		LEAVE_FF(dj.obj.fs, res);
                           A 14282    ; 4741	}
                           A 14283    ; 4742	
                           A 14284    ; 4743	
                           A 14285    ; 4744	
                           A 14286    ; 4745	#if !FF_FS_READONLY
                           A 14287    ; 4746	/*-------------------------------------
                           A 14288    ; 4747	/* Get Number of Free Clusters         
                           A 14289    ; 4748	/*-------------------------------------
                           A 14290    ; 4749	
                           A 14291    ; 4750	FRESULT f_getfree (
                           A 14292    ; 4751		const TCHAR* path,	/* Logical driv
                           A 14293    ; 4752		DWORD* nclst,		/* Pointer to a
                           A 14294    ; 4753		FATFS** fatfs		/* Pointer to r
                           A 14295    ; 4754	)
                           A 14296    ; 4755	{
                           A 14297    ; 4756		FRESULT res;
                           A 14298    ; 4757		FATFS *fs;
                           A 14299    ; 4758		DWORD nfree, clst, stat;
                           A 14300    ; 4759		LBA_t sect;
                           A 14301    ; 4760		UINT i;
                           A 14302    ; 4761		FFOBJID obj;
                           A 14303    ; 4762	
                           A 14304    ; 4763	
                           A 14305    ; 4764		/* Get logical drive */
                           A 14306    ; 4765		res = mount_volume(&path, &fs, 0);
                           A 14307    ; 4766		if (res == FR_OK) {
                           A 14308    ; 4767			*fatfs = fs;				/* 
                           A 14309    ; 4768			/* If free_clst is valid, retur
                           A 14310    ; 4769			if (fs->free_clst <= fs->n_fate
                           A 14311    ; 4770				*nclst = fs->free_clst;
                           A 14312    ; 4771			} else {
                           A 14313    ; 4772				/* Scan FAT to obtain numbe
                           A 14314    ; 4773				nfree = 0;
                           A 14315    ; 4774				if (fs->fs_type == FS_FAT12
                           A 14316    ; 4775					clst = 2; obj.fs = fs;
                           A 14317    ; 4776					do {
                           A 14318    ; 4777						stat = get_fat(&obj
                           A 14319    ; 4778						if (stat == 0xFFFFF
                           A 14320    ; 4779						if (stat == 1) { re
                           A 14321    ; 4780						if (stat == 0) nfre
                           A 14322    ; 4781					} while (++clst < fs->n
                           A 14323    ; 4782				} else {
                           A 14324    ; 4783	#if FF_FS_EXFAT
                           A 14325    ; 4784					if (fs->fs_type == FS_E
                           A 14326    ; 4785						BYTE bm;
                           A 14327    ; 4786						UINT b;
                           A 14328    ; 4787	
                           A 14329    ; 4788						clst = fs->n_fatent
                           A 14330    ; 4789						sect = fs->bitbase;
                           A 14331    ; 4790						i = 0;				
                           A 14332    ; 4791						do {	/* Counts n
                           A 14333    ; 4792							if (i == 0) {
                           A 14334    ; 4793								res = move_
                           A 14335    ; 4794								if (res != 
                           A 14336    ; 4795							}
                           A 14337    ; 4796							for (b = 8, bm 
                           A 14338    ; 4797								if (!(bm & 
                           A 14339    ; 4798								bm >>= 1;
                           A 14340    ; 4799							}
                           A 14341    ; 4800							i = (i + 1) % S
                           A 14342    ; 4801						} while (clst);
                           A 14343    ; 4802					} else
                           A 14344    ; 4803	#endif
                           A 14345    ; 4804					{	/* FAT16/32: Scan W
                           A 14346    ; 4805						clst = fs->n_fatent
                           A 14347    ; 4806						sect = fs->fatbase;
                           A 14348    ; 4807						i = 0;				
                           A 14349    ; 4808						do {	/* Counts n
                           A 14350    ; 4809							if (i == 0) {
                           A 14351    ; 4810								res = move_
                           A 14352    ; 4811								if (res != 
                           A 14353    ; 4812							}
                           A 14354    ; 4813							if (fs->fs_type
                           A 14355    ; 4814								if (ld_word
                           A 14356    ; 4815								i += 2;
                           A 14357    ; 4816							} else {
                           A 14358    ; 4817								if ((ld_dwo
                           A 14359    ; 4818								i += 4;
                           A 14360    ; 4819							}
                           A 14361    ; 4820							i %= SS(fs);
                           A 14362    ; 4821						} while (--clst);
                           A 14363    ; 4822					}
                           A 14364    ; 4823				}
                           A 14365    ; 4824				if (res == FR_OK) {		/* 
                           A 14366    ; 4825					*nclst = nfree;			
                           A 14367    ; 4826					fs->free_clst = nfree;	
                           A 14368    ; 4827					fs->fsi_flag |= 1;		
                           A 14369    ; 4828				}
                           A 14370    ; 4829			}
                           A 14371    ; 4830		}
                           A 14372    ; 4831	
                           A 14373    ; 4832		LEAVE_FF(fs, res);
                           A 14374    ; 4833	}
                           A 14375    ; 4834	
                           A 14376    ; 4835	
                           A 14377    ; 4836	
                           A 14378    ; 4837	
                           A 14379    ; 4838	/*-------------------------------------
                           A 14380    ; 4839	/* Truncate File                       
                           A 14381    ; 4840	/*-------------------------------------
                           A 14382    ; 4841	
                           A 14383    ; 4842	FRESULT f_truncate (
                           A 14384    ; 4843		FIL* fp		/* Pointer to the file 
                           A 14385    ; 4844	)
                           A 14386    ; 4845	{
                           A 14387    ; 4846		FRESULT res;
                           A 14388    ; 4847		FATFS *fs;
                           A 14389    ; 4848		DWORD ncl;
                           A 14390    ; 4849	
                           A 14391    ; 4850	
                           A 14392    ; 4851		res = validate(&fp->obj, &fs);	/* 
                           A 14393    ; 4852		if (res != FR_OK || (res = (FRESULT
                           A 14394    ; 4853		if (!(fp->flag & FA_WRITE)) LEAVE_F
                           A 14395    ; 4854	
                           A 14396    ; 4855		if (fp->fptr < fp->obj.objsize) {	
                           A 14397    ; 4856			if (fp->fptr == 0) {	/* When
                           A 14398    ; 4857				res = remove_chain(&fp->obj
                           A 14399    ; 4858				fp->obj.sclust = 0;
                           A 14400    ; 4859			} else {				/* When
                           A 14401    ; 4860				ncl = get_fat(&fp->obj, fp-
                           A 14402    ; 4861				res = FR_OK;
                           A 14403    ; 4862				if (ncl == 0xFFFFFFFF) res 
                           A 14404    ; 4863				if (ncl == 1) res = FR_INT_
                           A 14405    ; 4864				if (res == FR_OK && ncl < f
                           A 14406    ; 4865					res = remove_chain(&fp-
                           A 14407    ; 4866				}
                           A 14408    ; 4867			}
                           A 14409    ; 4868			fp->obj.objsize = fp->fptr;	/* 
                           A 14410    ; 4869			fp->flag |= FA_MODIFIED;
                           A 14411    ; 4870	#if !FF_FS_TINY
                           A 14412    ; 4871			if (res == FR_OK && (fp->flag &
                           A 14413    ; 4872				if (disk_write(fs->pdrv, fp
                           A 14414    ; 4873					res = FR_DISK_ERR;
                           A 14415    ; 4874				} else {
                           A 14416    ; 4875					fp->flag &= (BYTE)~FA_D
                           A 14417    ; 4876				}
                           A 14418    ; 4877			}
                           A 14419    ; 4878	#endif
                           A 14420    ; 4879			if (res != FR_OK) ABORT(fs, res
                           A 14421    ; 4880		}
                           A 14422    ; 4881	
                           A 14423    ; 4882		LEAVE_FF(fs, res);
                           A 14424    ; 4883	}
                           A 14425    ; 4884	
                           A 14426    ; 4885	
                           A 14427    ; 4886	
                           A 14428    ; 4887	
                           A 14429    ; 4888	/*-------------------------------------
                           A 14430    ; 4889	/* Delete a File/Directory             
                           A 14431    ; 4890	/*-------------------------------------
                           A 14432    ; 4891	
                           A 14433    ; 4892	FRESULT f_unlink (
                           A 14434    ; 4893		const TCHAR* path		/* Pointer 
                           A 14435    ; 4894	)
                           A 14436    ; 4895	{
                           A 14437    ; 4896		FRESULT res;
                           A 14438    ; 4897		DIR dj, sdj;
                           A 14439    ; 4898		DWORD dclst = 0;
                           A 14440    ; 4899		FATFS *fs;
                           A 14441    ; 4900	#if FF_FS_EXFAT
                           A 14442    ; 4901		FFOBJID obj;
                           A 14443    ; 4902	#endif
                           A 14444    ; 4903		DEF_NAMBUF
                           A 14445    ; 4904	
                           A 14446    ; 4905	
                           A 14447    ; 4906		/* Get logical drive */
                           A 14448    ; 4907		res = mount_volume(&path, &fs, FA_W
                           A 14449    ; 4908		if (res == FR_OK) {
                           A 14450    ; 4909			dj.obj.fs = fs;
                           A 14451    ; 4910			INIT_NAMBUF(fs);
                           A 14452    ; 4911			res = follow_path(&dj, path);	
                           A 14453    ; 4912			if (FF_FS_RPATH && res == FR_OK
                           A 14454    ; 4913				res = FR_INVALID_NAME;		
                           A 14455    ; 4914			}
                           A 14456    ; 4915	#if FF_FS_LOCK != 0
                           A 14457    ; 4916			if (res == FR_OK) res = chk_loc
                           A 14458    ; 4917	#endif
                           A 14459    ; 4918			if (res == FR_OK) {				
                           A 14460    ; 4919				if (dj.fn[NSFLAG] & NS_NONA
                           A 14461    ; 4920					res = FR_INVALID_NAME;	
                           A 14462    ; 4921				} else {
                           A 14463    ; 4922					if (dj.obj.attr & AM_RD
                           A 14464    ; 4923						res = FR_DENIED;	
                           A 14465    ; 4924					}
                           A 14466    ; 4925				}
                           A 14467    ; 4926				if (res == FR_OK) {
                           A 14468    ; 4927	#if FF_FS_EXFAT
                           A 14469    ; 4928					obj.fs = fs;
                           A 14470    ; 4929					if (fs->fs_type == FS_E
                           A 14471    ; 4930						init_alloc_info(fs,
                           A 14472    ; 4931						dclst = obj.sclust;
                           A 14473    ; 4932					} else
                           A 14474    ; 4933	#endif
                           A 14475    ; 4934					{
                           A 14476    ; 4935						dclst = ld_clust(fs
                           A 14477    ; 4936					}
                           A 14478    ; 4937					if (dj.obj.attr & AM_DI
                           A 14479    ; 4938	#if FF_FS_RPATH != 0
                           A 14480    ; 4939						if (dclst == fs->cd
                           A 14481    ; 4940							res = FR_DENIED
                           A 14482    ; 4941						} else
                           A 14483    ; 4942	#endif
                           A 14484    ; 4943						{
                           A 14485    ; 4944							sdj.obj.fs = fs
                           A 14486    ; 4945							sdj.obj.sclust 
                           A 14487    ; 4946	#if FF_FS_EXFAT
                           A 14488    ; 4947							if (fs->fs_type
                           A 14489    ; 4948								sdj.obj.obj
                           A 14490    ; 4949								sdj.obj.sta
                           A 14491    ; 4950							}
                           A 14492    ; 4951	#endif
                           A 14493    ; 4952							res = dir_sdi(&
                           A 14494    ; 4953							if (res == FR_O
                           A 14495    ; 4954								res = DIR_R
                           A 14496    ; 4955								if (res == 
                           A 14497    ; 4956								if (res == 
                           A 14498    ; 4957							}
                           A 14499    ; 4958						}
                           A 14500    ; 4959					}
                           A 14501    ; 4960				}
                           A 14502    ; 4961				if (res == FR_OK) {
                           A 14503    ; 4962					res = dir_remove(&dj);	
                           A 14504    ; 4963					if (res == FR_OK && dcl
                           A 14505    ; 4964	#if FF_FS_EXFAT
                           A 14506    ; 4965						res = remove_chain(
                           A 14507    ; 4966	#else
                           A 14508    ; 4967						res = remove_chain(
                           A 14509    ; 4968	#endif
                           A 14510    ; 4969					}
                           A 14511    ; 4970					if (res == FR_OK) res =
                           A 14512    ; 4971				}
                           A 14513    ; 4972			}
                           A 14514    ; 4973			FREE_NAMBUF();
                           A 14515    ; 4974		}
                           A 14516    ; 4975	
                           A 14517    ; 4976		LEAVE_FF(fs, res);
                           A 14518    ; 4977	}
                           A 14519    ; 4978	
                           A 14520    ; 4979	
                           A 14521    ; 4980	
                           A 14522    ; 4981	
                           A 14523    ; 4982	/*-------------------------------------
                           A 14524    ; 4983	/* Create a Directory                  
                           A 14525    ; 4984	/*-------------------------------------
                           A 14526    ; 4985	
                           A 14527    ; 4986	FRESULT f_mkdir (
                           A 14528    ; 4987		const TCHAR* path		/* Pointer 
                           A 14529    ; 4988	)
                           A 14530    ; 4989	{
                           A 14531    ; 4990		FRESULT res;
                           A 14532    ; 4991		DIR dj;
                           A 14533    ; 4992		FFOBJID sobj;
                           A 14534    ; 4993		FATFS *fs;
                           A 14535    ; 4994		DWORD dcl, pcl, tm;
                           A 14536    ; 4995		DEF_NAMBUF
                           A 14537    ; 4996	
                           A 14538    ; 4997	
                           A 14539    ; 4998		res = mount_volume(&path, &fs, FA_W
                           A 14540    ; 4999		if (res == FR_OK) {
                           A 14541    ; 5000			dj.obj.fs = fs;
                           A 14542    ; 5001			INIT_NAMBUF(fs);
                           A 14543    ; 5002			res = follow_path(&dj, path);	
                           A 14544    ; 5003			if (res == FR_OK) res = FR_EXIS
                           A 14545    ; 5004			if (FF_FS_RPATH && res == FR_NO
                           A 14546    ; 5005				res = FR_INVALID_NAME;
                           A 14547    ; 5006			}
                           A 14548    ; 5007			if (res == FR_NO_FILE) {		
                           A 14549    ; 5008				sobj.fs = fs;				
                           A 14550    ; 5009				dcl = create_chain(&sobj, 0
                           A 14551    ; 5010				res = FR_OK;
                           A 14552    ; 5011				if (dcl == 0) res = FR_DENI
                           A 14553    ; 5012				if (dcl == 1) res = FR_INT_
                           A 14554    ; 5013				if (dcl == 0xFFFFFFFF) res 
                           A 14555    ; 5014				tm = GET_FATTIME();
                           A 14556    ; 5015				if (res == FR_OK) {
                           A 14557    ; 5016					res = dir_clear(fs, dcl
                           A 14558    ; 5017					if (res == FR_OK) {
                           A 14559    ; 5018						if (!FF_FS_EXFAT ||
                           A 14560    ; 5019							memset(fs->win 
                           A 14561    ; 5020							fs->win[DIR_Nam
                           A 14562    ; 5021							fs->win[DIR_Att
                           A 14563    ; 5022							st_dword(fs->wi
                           A 14564    ; 5023							st_clust(fs, fs
                           A 14565    ; 5024							memcpy(fs->win 
                           A 14566    ; 5025							fs->win[SZDIRE 
                           A 14567    ; 5026							st_clust(fs, fs
                           A 14568    ; 5027							fs->wflag = 1;
                           A 14569    ; 5028						}
                           A 14570    ; 5029						res = dir_register(
                           A 14571    ; 5030					}
                           A 14572    ; 5031				}
                           A 14573    ; 5032				if (res == FR_OK) {
                           A 14574    ; 5033	#if FF_FS_EXFAT
                           A 14575    ; 5034					if (fs->fs_type == FS_E
                           A 14576    ; 5035						st_dword(fs->dirbuf
                           A 14577    ; 5036						st_dword(fs->dirbuf
                           A 14578    ; 5037						st_dword(fs->dirbuf
                           A 14579    ; 5038						st_dword(fs->dirbuf
                           A 14580    ; 5039						fs->dirbuf[XDIR_Gen
                           A 14581    ; 5040						fs->dirbuf[XDIR_Att
                           A 14582    ; 5041						res = store_xdir(&d
                           A 14583    ; 5042					} else
                           A 14584    ; 5043	#endif
                           A 14585    ; 5044					{
                           A 14586    ; 5045						st_dword(dj.dir + D
                           A 14587    ; 5046						st_clust(fs, dj.dir
                           A 14588    ; 5047						dj.dir[DIR_Attr] = 
                           A 14589    ; 5048						fs->wflag = 1;
                           A 14590    ; 5049					}
                           A 14591    ; 5050					if (res == FR_OK) {
                           A 14592    ; 5051						res = sync_fs(fs);
                           A 14593    ; 5052					}
                           A 14594    ; 5053				} else {
                           A 14595    ; 5054					remove_chain(&sobj, dcl
                           A 14596    ; 5055				}
                           A 14597    ; 5056			}
                           A 14598    ; 5057			FREE_NAMBUF();
                           A 14599    ; 5058		}
                           A 14600    ; 5059	
                           A 14601    ; 5060		LEAVE_FF(fs, res);
                           A 14602    ; 5061	}
                           A 14603    ; 5062	
                           A 14604    ; 5063	
                           A 14605    ; 5064	
                           A 14606    ; 5065	
                           A 14607    ; 5066	/*-------------------------------------
                           A 14608    ; 5067	/* Rename a File/Directory             
                           A 14609    ; 5068	/*-------------------------------------
                           A 14610    ; 5069	
                           A 14611    ; 5070	FRESULT f_rename (
                           A 14612    ; 5071		const TCHAR* path_old,	/* Pointer 
                           A 14613    ; 5072		const TCHAR* path_new	/* Pointer 
                           A 14614    ; 5073	)
                           A 14615    ; 5074	{
                           A 14616    ; 5075		FRESULT res;
                           A 14617    ; 5076		DIR djo, djn;
                           A 14618    ; 5077		FATFS *fs;
                           A 14619    ; 5078		BYTE buf[FF_FS_EXFAT ? SZDIRE * 2 :
                           A 14620    ; 5079		LBA_t sect;
                           A 14621    ; 5080		DEF_NAMBUF
                           A 14622    ; 5081	
                           A 14623    ; 5082	
                           A 14624    ; 5083		get_ldnumber(&path_new);			
                           A 14625    ; 5084		res = mount_volume(&path_old, &fs, 
                           A 14626    ; 5085		if (res == FR_OK) {
                           A 14627    ; 5086			djo.obj.fs = fs;
                           A 14628    ; 5087			INIT_NAMBUF(fs);
                           A 14629    ; 5088			res = follow_path(&djo, path_ol
                           A 14630    ; 5089			if (res == FR_OK && (djo.fn[NSF
                           A 14631    ; 5090	#if FF_FS_LOCK != 0
                           A 14632    ; 5091			if (res == FR_OK) {
                           A 14633    ; 5092				res = chk_lock(&djo, 2);
                           A 14634    ; 5093			}
                           A 14635    ; 5094	#endif
                           A 14636    ; 5095			if (res == FR_OK) {				
                           A 14637    ; 5096	#if FF_FS_EXFAT
                           A 14638    ; 5097				if (fs->fs_type == FS_EXFAT
                           A 14639    ; 5098					BYTE nf, nn;
                           A 14640    ; 5099					WORD nh;
                           A 14641    ; 5100	
                           A 14642    ; 5101					memcpy(buf, fs->dirbuf,
                           A 14643    ; 5102					memcpy(&djn, &djo, size
                           A 14644    ; 5103					res = follow_path(&djn,
                           A 14645    ; 5104					if (res == FR_OK) {		
                           A 14646    ; 5105						res = (djn.obj.sclu
                           A 14647    ; 5106					}
                           A 14648    ; 5107					if (res == FR_NO_FILE) 
                           A 14649    ; 5108						res = dir_register(
                           A 14650    ; 5109						if (res == FR_OK) {
                           A 14651    ; 5110							nf = fs->dirbuf
                           A 14652    ; 5111							nh = ld_word(fs
                           A 14653    ; 5112							memcpy(fs->dirb
                           A 14654    ; 5113							fs->dirbuf[XDIR
                           A 14655    ; 5114							st_word(fs->dir
                           A 14656    ; 5115							if (!(fs->dirbu
                           A 14657    ; 5116	/* Start of critical section where an i
                           A 14658    ; 5117							res = store_xdi
                           A 14659    ; 5118						}
                           A 14660    ; 5119					}
                           A 14661    ; 5120				} else
                           A 14662    ; 5121	#endif
                           A 14663    ; 5122				{	/* At FAT/FAT32 volume 
                           A 14664    ; 5123					memcpy(buf, djo.dir, SZ
                           A 14665    ; 5124					memcpy(&djn, &djo, size
                           A 14666    ; 5125					res = follow_path(&djn,
                           A 14667    ; 5126					if (res == FR_OK) {		
                           A 14668    ; 5127						res = (djn.obj.sclu
                           A 14669    ; 5128					}
                           A 14670    ; 5129					if (res == FR_NO_FILE) 
                           A 14671    ; 5130						res = dir_register(
                           A 14672    ; 5131						if (res == FR_OK) {
                           A 14673    ; 5132							dir = djn.dir;	
                           A 14674    ; 5133							memcpy(dir + 13
                           A 14675    ; 5134							dir[DIR_Attr] =
                           A 14676    ; 5135							if (!(dir[DIR_A
                           A 14677    ; 5136							fs->wflag = 1;
                           A 14678    ; 5137							if ((dir[DIR_At
                           A 14679    ; 5138								sect = clst
                           A 14680    ; 5139								if (sect ==
                           A 14681    ; 5140									res = F
                           A 14682    ; 5141								} else {
                           A 14683    ; 5142	/* Start of critical section where an i
                           A 14684    ; 5143									res = m
                           A 14685    ; 5144									dir = f
                           A 14686    ; 5145									if (res
                           A 14687    ; 5146										st_
                           A 14688    ; 5147										fs-
                           A 14689    ; 5148									}
                           A 14690    ; 5149								}
                           A 14691    ; 5150							}
                           A 14692    ; 5151						}
                           A 14693    ; 5152					}
                           A 14694    ; 5153				}
                           A 14695    ; 5154				if (res == FR_OK) {
                           A 14696    ; 5155					res = dir_remove(&djo);
                           A 14697    ; 5156					if (res == FR_OK) {
                           A 14698    ; 5157						res = sync_fs(fs);
                           A 14699    ; 5158					}
                           A 14700    ; 5159				}
                           A 14701    ; 5160	/* End of the critical section */
                           A 14702    ; 5161			}
                           A 14703    ; 5162			FREE_NAMBUF();
                           A 14704    ; 5163		}
                           A 14705    ; 5164	
                           A 14706    ; 5165		LEAVE_FF(fs, res);
                           A 14707    ; 5166	}
                           A 14708    ; 5167	
                           A 14709    ; 5168	#endif /* !FF_FS_READONLY */
                           A 14710    ; 5169	#endif /* FF_FS_MINIMIZE == 0 */
                           A 14711    ; 5170	#endif /* FF_FS_MINIMIZE <= 1 */
                           A 14712    ; 5171	#endif /* FF_FS_MINIMIZE <= 2 */
                           A 14713    ; 5172	
                           A 14714    ; 5173	
                           A 14715    ; 5174	
                           A 14716    ; 5175	#if FF_USE_CHMOD && !FF_FS_READONLY
                           A 14717    ; 5176	/*-------------------------------------
                           A 14718    ; 5177	/* Change Attribute                    
                           A 14719    ; 5178	/*-------------------------------------
                           A 14720    ; 5179	
                           A 14721    ; 5180	FRESULT f_chmod (
                           A 14722    ; 5181		const TCHAR* path,	/* Pointer to t
                           A 14723    ; 5182		BYTE attr,			/* Attribute bi
                           A 14724    ; 5183		BYTE mask			/* Attribute ma
                           A 14725    ; 5184	)
                           A 14726    ; 5185	{
                           A 14727    ; 5186		FRESULT res;
                           A 14728    ; 5187		DIR dj;
                           A 14729    ; 5188		FATFS *fs;
                           A 14730    ; 5189		DEF_NAMBUF
                           A 14731    ; 5190	
                           A 14732    ; 5191	
                           A 14733    ; 5192		res = mount_volume(&path, &fs, FA_W
                           A 14734    ; 5193		if (res == FR_OK) {
                           A 14735    ; 5194			dj.obj.fs = fs;
                           A 14736    ; 5195			INIT_NAMBUF(fs);
                           A 14737    ; 5196			res = follow_path(&dj, path);	
                           A 14738    ; 5197			if (res == FR_OK && (dj.fn[NSFL
                           A 14739    ; 5198			if (res == FR_OK) {
                           A 14740    ; 5199				mask &= AM_RDO|AM_HID|AM_SY
                           A 14741    ; 5200	#if FF_FS_EXFAT
                           A 14742    ; 5201				if (fs->fs_type == FS_EXFAT
                           A 14743    ; 5202					fs->dirbuf[XDIR_Attr] =
                           A 14744    ; 5203					res = store_xdir(&dj);
                           A 14745    ; 5204				} else
                           A 14746    ; 5205	#endif
                           A 14747    ; 5206				{
                           A 14748    ; 5207					dj.dir[DIR_Attr] = (att
                           A 14749    ; 5208					fs->wflag = 1;
                           A 14750    ; 5209				}
                           A 14751    ; 5210				if (res == FR_OK) {
                           A 14752    ; 5211					res = sync_fs(fs);
                           A 14753    ; 5212				}
                           A 14754    ; 5213			}
                           A 14755    ; 5214			FREE_NAMBUF();
                           A 14756    ; 5215		}
                           A 14757    ; 5216	
                           A 14758    ; 5217		LEAVE_FF(fs, res);
                           A 14759    ; 5218	}
                           A 14760    ; 5219	
                           A 14761    ; 5220	
                           A 14762    ; 5221	
                           A 14763    ; 5222	
                           A 14764    ; 5223	/*-------------------------------------
                           A 14765    ; 5224	/* Change Timestamp                    
                           A 14766    ; 5225	/*-------------------------------------
                           A 14767    ; 5226	
                           A 14768    ; 5227	FRESULT f_utime (
                           A 14769    ; 5228		const TCHAR* path,	/* Pointer to t
                           A 14770    ; 5229		const FILINFO* fno	/* Pointer to t
                           A 14771    ; 5230	)
                           A 14772    ; 5231	{
                           A 14773    ; 5232		FRESULT res;
                           A 14774    ; 5233		DIR dj;
                           A 14775    ; 5234		FATFS *fs;
                           A 14776    ; 5235		DEF_NAMBUF
                           A 14777    ; 5236	
                           A 14778    ; 5237	
                           A 14779    ; 5238		res = mount_volume(&path, &fs, FA_W
                           A 14780    ; 5239		if (res == FR_OK) {
                           A 14781    ; 5240			dj.obj.fs = fs;
                           A 14782    ; 5241			INIT_NAMBUF(fs);
                           A 14783    ; 5242			res = follow_path(&dj, path);	
                           A 14784    ; 5243			if (res == FR_OK && (dj.fn[NSFL
                           A 14785    ; 5244			if (res == FR_OK) {
                           A 14786    ; 5245	#if FF_FS_EXFAT
                           A 14787    ; 5246				if (fs->fs_type == FS_EXFAT
                           A 14788    ; 5247					st_dword(fs->dirbuf + X
                           A 14789    ; 5248					res = store_xdir(&dj);
                           A 14790    ; 5249				} else
                           A 14791    ; 5250	#endif
                           A 14792    ; 5251				{
                           A 14793    ; 5252					st_dword(dj.dir + DIR_M
                           A 14794    ; 5253					fs->wflag = 1;
                           A 14795    ; 5254				}
                           A 14796    ; 5255				if (res == FR_OK) {
                           A 14797    ; 5256					res = sync_fs(fs);
                           A 14798    ; 5257				}
                           A 14799    ; 5258			}
                           A 14800    ; 5259			FREE_NAMBUF();
                           A 14801    ; 5260		}
                           A 14802    ; 5261	
                           A 14803    ; 5262		LEAVE_FF(fs, res);
                           A 14804    ; 5263	}
                           A 14805    ; 5264	
                           A 14806    ; 5265	#endif	/* FF_USE_CHMOD && !FF_FS_READO
                           A 14807    ; 5266	
                           A 14808    ; 5267	
                           A 14809    ; 5268	
                           A 14810    ; 5269	#if FF_USE_LABEL
                           A 14811    ; 5270	/*-------------------------------------
                           A 14812    ; 5271	/* Get Volume Label                    
                           A 14813    ; 5272	/*-------------------------------------
                           A 14814    ; 5273	
                           A 14815    ; 5274	FRESULT f_getlabel (
                           A 14816    ; 5275		const TCHAR* path,	/* Logical driv
                           A 14817    ; 5276		TCHAR* label,		/* Buffer to st
                           A 14818    ; 5277		DWORD* vsn			/* Variable to 
                           A 14819    ; 5278	)
                           A 14820    ; 5279	{
043C89                     A 14821    _f_getlabel:
                           A 14822    .DEFINE "_f_getlabel"
                           A 14823    
                           A 14824    .VALUE _f_getlabel
                           A 14825    
                           A 14826    .CLASS 2
                           A 14827    
                           A 14828    .TYPE 68
                           A 14829    
                           A 14830    .ENDEF
                           A 14831    
                           A 14832    .BEGFUNC "f_getlabel",5279,"_f_getlabel"
                           A 14833    
                           A 14834    .LINE 5279
                           A 14835    
                           A 14836    .DEFINE "path"
                           A 14837    
                           A 14838    .CLASS 65
                           A 14839    
                           A 14840    .VALUE 6
                           A 14841    
                           A 14842    .TYPE 194
                           A 14843    
                           A 14844    .ENDEF
                           A 14845    
                           A 14846    .DEFINE "label"
                           A 14847    
                           A 14848    .CLASS 65
                           A 14849    
                           A 14850    .VALUE 9
                           A 14851    
                           A 14852    .TYPE 34
                           A 14853    
                           A 14854    .ENDEF
                           A 14855    
                           A 14856    .DEFINE "vsn"
                           A 14857    
                           A 14858    .CLASS 65
                           A 14859    
                           A 14860    .VALUE 12
                           A 14861    
                           A 14862    .TYPE 47
                           A 14863    
                           A 14864    .ENDEF
                           A 14865    
                           A 14866    .DEFINE "di"
                           A 14867    
                           A 14868    .CLASS 65
                           A 14869    
                           A 14870    .VALUE -3
                           A 14871    
                           A 14872    .TYPE 14
                           A 14873    
                           A 14874    .ENDEF
                           A 14875    
                           A 14876    .DEFINE "res"
                           A 14877    
                           A 14878    .CLASS 65
                           A 14879    
                           A 14880    .VALUE -6
                           A 14881    
                           A 14882    .TYPE 4
                           A 14883    
                           A 14884    .ENDEF
                           A 14885    
                           A 14886    .DEFINE "fs"
                           A 14887    
                           A 14888    .CLASS 65
                           A 14889    
                           A 14890    .VALUE -9
                           A 14891    
                           A 14892    .TAG "NONAME0"
                           A 14893    
                           A 14894    .TYPE 40
                           A 14895    
                           A 14896    .ENDEF
                           A 14897    
                           A 14898    .DEFINE "si"
                           A 14899    
                           A 14900    .CLASS 65
                           A 14901    
                           A 14902    .VALUE -12
                           A 14903    
                           A 14904    .TYPE 14
                           A 14905    
                           A 14906    .ENDEF
                           A 14907    
                           A 14908    .DEFINE "wc"
                           A 14909    
                           A 14910    .CLASS 65
                           A 14911    
                           A 14912    .VALUE -14
                           A 14913    
                           A 14914    .TYPE 13
                           A 14915    
                           A 14916    .ENDEF
                           A 14917    
                           A 14918    .DEFINE "dj"
                           A 14919    
                           A 14920    .CLASS 65
                           A 14921    
                           A 14922    .VALUE -60
                           A 14923    
                           A 14924    .TAG "NONAME3"
                           A 14925    
                           A 14926    .TYPE 8
                           A 14927    
                           A 14928    .ENDEF
                           A 14929    
043C89 DDE5                A 14930    	PUSH	IX
043C8B DD210000 00         A 14931    	LD	IX,0
043C90 DD39                A 14932    	ADD	IX,SP
043C92 ED22C1              A 14933    	LEA	HL,IX+%FFFFFFC1
043C95 F9                  A 14934    	LD	SP,HL
                           A 14935    ; 5280		FRESULT res;
                           A 14936    ; 5281		DIR dj;
                           A 14937    ; 5282		FATFS *fs;
                           A 14938    ; 5283		UINT si, di;
                           A 14939    ; 5284		WCHAR wc;
                           A 14940    ; 5285	
                           A 14941    ; 5286		/* Get logical drive */
                           A 14942    ; 5287		res = mount_volume(&path, &fs, 0);
                           A 14943    .LINE 5287
                           A 14944    
043C96 01000000            A 14945    	LD	BC,0
043C9A C5                  A 14946    	PUSH	BC
043C9B ED65F7              A 14947    	PEA	IX+%FFFFFFF7
043C9E ED6506              A 14948    	PEA	IX+%6
043CA1 CD E9 2D 04         A 14949    	CALL	_mount_volume
043CA5 C1                  A 14950    	POP	BC
043CA6 C1                  A 14951    	POP	BC
043CA7 C1                  A 14952    	POP	BC
043CA8 DD2FFA              A 14953    	LD	(IX+%FFFFFFFA),HL
                           A 14954    ; 5288	
                           A 14955    ; 5289		/* Get volume label */
                           A 14956    ; 5290		if (res == FR_OK && label) {
                           A 14957    .LINE 5290
                           A 14958    
043CAB CD E5 46 04         A 14959    	CALL	__icmpzero
043CAF C2 92 3D 04         A 14960    	JR	NZ,L_681
043CB3 DD2709              A 14961    	LD	HL,(IX+%9)
043CB6 CD E5 46 04         A 14962    	CALL	__icmpzero
043CBA CA 92 3D 04         A 14963    	JR	Z,L_681
                           A 14964    ; 5291			dj.obj.fs = fs; dj.obj.sclust =
                           A 14965    .LINE 5291
                           A 14966    
043CBE ED02C4              A 14967    	LEA	BC,IX+%FFFFFFC4
043CC1 DD0FC1              A 14968    	LD	(IX+%FFFFFFC1),BC
043CC4 DD07F7              A 14969    	LD	BC,(IX+%FFFFFFF7)
043CC7 DD0FC4              A 14970    	LD	(IX+%FFFFFFC4),BC
043CCA 01000000            A 14971    	LD	BC,0
043CCE DD31C1              A 14972    	LD	IY,(IX+%FFFFFFC1)
043CD1 FD0F07              A 14973    	LD	(IY+%7),BC
043CD4 FD360A00            A 14974    	LD	(IY+%A),%0
                           A 14975    ; 5292			res = dir_sdi(&dj, 0);
                           A 14976    .LINE 5292
                           A 14977    
043CD8 C5                  A 14978    	PUSH	BC
043CD9 C5                  A 14979    	PUSH	BC
043CDA ED65C4              A 14980    	PEA	IX+%FFFFFFC4
043CDD CD B4 14 04         A 14981    	CALL	_dir_sdi
043CE1 C1                  A 14982    	POP	BC
043CE2 C1                  A 14983    	POP	BC
043CE3 C1                  A 14984    	POP	BC
043CE4 DD2FFA              A 14985    	LD	(IX+%FFFFFFFA),HL
                           A 14986    ; 5293			if (res == FR_OK) {
                           A 14987    .LINE 5293
                           A 14988    
043CE7 CD E5 46 04         A 14989    	CALL	__icmpzero
043CEB C2 7A 3D 04         A 14990    	JR	NZ,L_672
                           A 14991    ; 5294			 	res = DIR_READ_LABEL(&dj);	
                           A 14992    .LINE 5294
                           A 14993    
043CEF 01010000            A 14994    	LD	BC,1
043CF3 C5                  A 14995    	PUSH	BC
043CF4 ED65C4              A 14996    	PEA	IX+%FFFFFFC4
043CF7 CD BA 1B 04         A 14997    	CALL	_dir_read
043CFB C1                  A 14998    	POP	BC
043CFC C1                  A 14999    	POP	BC
043CFD DD2FFA              A 15000    	LD	(IX+%FFFFFFFA),HL
                           A 15001    ; 5295			 	if (res == FR_OK) {
                           A 15002    .LINE 5295
                           A 15003    
043D00 CD E5 46 04         A 15004    	CALL	__icmpzero
043D04 20 74               A 15005    	JR	NZ,L_672
                           A 15006    ; 5296	#if FF_FS_EXFAT
                           A 15007    ; 5297					if (fs->fs_type == FS_E
                           A 15008    ; 5298						WCHAR hs;
                           A 15009    ; 5299						UINT nw;
                           A 15010    ; 5300	
                           A 15011    ; 5301						for (si = di = hs =
                           A 15012    ; 5302							wc = ld_word(dj
                           A 15013    ; 5303							if (hs == 0 && 
                           A 15014    ; 5304								hs = wc; co
                           A 15015    ; 5305							}
                           A 15016    ; 5306							nw = put_utf((D
                           A 15017    ; 5307							if (nw == 0) { 
                           A 15018    ; 5308							di += nw;
                           A 15019    ; 5309							hs = 0;
                           A 15020    ; 5310						}
                           A 15021    ; 5311						if (hs != 0) di = 0
                           A 15022    ; 5312						label[di] = 0;
                           A 15023    ; 5313					} else
                           A 15024    ; 5314	#endif
                           A 15025    ; 5315					{
                           A 15026    ; 5316						si = di = 0;		
                           A 15027    .LINE 5316
                           A 15028    
043D06 01000000            A 15029    	LD	BC,0
043D0A DD0FFD              A 15030    	LD	(IX+%FFFFFFFD),BC
043D0D DD0FF4              A 15031    	LD	(IX+%FFFFFFF4),BC
                           A 15032    ; 5317						while (si < 11) {
                           A 15033    .LINE 5317
                           A 15034    
043D10 18 2B               A 15035    	JR	L_663
043D12                     A 15036    L_664:
                           A 15037    ; 5318							wc = dj.dir[si+
                           A 15038    .LINE 5318
                           A 15039    
043D12 DD07F4              A 15040    	LD	BC,(IX+%FFFFFFF4)
043D15 DD27DF              A 15041    	LD	HL,(IX+%FFFFFFDF)
043D18 09                  A 15042    	ADD	HL,BC
043D19 4E                  A 15043    	LD	C,(HL)
043D1A 0600                A 15044    	LD	B,%0
043D1C C5E1                A 15045    	LD	HL,BC
043D1E DD75F2              A 15046    	LD	(IX+%FFFFFFF2),L
043D21 DD74F3              A 15047    	LD	(IX+%FFFFFFF3),H
043D24 DD07F4              A 15048    	LD	BC,(IX+%FFFFFFF4)
043D27 03                  A 15049    	INC	BC
043D28 DD0FF4              A 15050    	LD	(IX+%FFFFFFF4),BC
                           A 15051    ; 5319	#if FF_USE_LFN && FF_LFN_UNICODE >= 1 	
                           A 15052    ; 5320							if (dbc_1st((BY
                           A 15053    ; 5321							wc = ff_oem2uni
                           A 15054    ; 5322							if (wc == 0) { 
                           A 15055    ; 5323							di += put_utf(w
                           A 15056    ; 5324	#else									
                           A 15057    ; 5325							label[di++] = (
                           A 15058    .LINE 5325
                           A 15059    
043D2B DD7EF2              A 15060    	LD	A,(IX+%FFFFFFF2)
043D2E DD07FD              A 15061    	LD	BC,(IX+%FFFFFFFD)
043D31 DD2709              A 15062    	LD	HL,(IX+%9)
043D34 09                  A 15063    	ADD	HL,BC
043D35 77                  A 15064    	LD	(HL),A
043D36 DD07FD              A 15065    	LD	BC,(IX+%FFFFFFFD)
043D39 03                  A 15066    	INC	BC
043D3A DD0FFD              A 15067    	LD	(IX+%FFFFFFFD),BC
                           A 15068    ; 5326	#endif
                           A 15069    ; 5327						}
043D3D                     A 15070    L_663:
                           A 15071    .LINE 5327
                           A 15072    
043D3D 010B0000            A 15073    	LD	BC,11
043D41 DD27F4              A 15074    	LD	HL,(IX+%FFFFFFF4)
043D44 B7                  A 15075    	OR	A,A
043D45 ED42                A 15076    	SBC	HL,BC
043D47 38 C9               A 15077    	JR	C,L_664
                           A 15078    ; 5328						do {				
043D49                     A 15079    L_666:
                           A 15080    .LINE 5328
                           A 15081    
                           A 15082    ; 5329							label[di] = 0;
                           A 15083    .LINE 5329
                           A 15084    
043D49 DD07FD              A 15085    	LD	BC,(IX+%FFFFFFFD)
043D4C DD2709              A 15086    	LD	HL,(IX+%9)
043D4F 09                  A 15087    	ADD	HL,BC
043D50 3600                A 15088    	LD	(HL),%0
                           A 15089    ; 5330							if (di == 0) br
                           A 15090    .LINE 5330
                           A 15091    
043D52 DD27FD              A 15092    	LD	HL,(IX+%FFFFFFFD)
043D55 CD E5 46 04         A 15093    	CALL	__icmpzero
043D59 28 1F               A 15094    	JR	Z,L_672
                           A 15095    ; 5331						} while (label[--di
                           A 15096    .LINE 5331
                           A 15097    
043D5B DD31FD              A 15098    	LD	IY,(IX+%FFFFFFFD)
043D5E ED33FF              A 15099    	LEA	IY,IY+%FFFFFFFF
043D61 DD3EFD              A 15100    	LD	(IX+%FFFFFFFD),IY
043D64 FDE5C1              A 15101    	LD	BC,IY
043D67 DD2709              A 15102    	LD	HL,(IX+%9)
043D6A 09                  A 15103    	ADD	HL,BC
043D6B 7E                  A 15104    	LD	A,(HL)
043D6C 47                  A 15105    	LD	B,A
043D6D 17ED62              A 15106    	SEXT	HL
043D70 68                  A 15107    	LD	L,B
043D71 01200000            A 15108    	LD	BC,32
043D75 B7                  A 15109    	OR	A,A
043D76 ED42                A 15110    	SBC	HL,BC
043D78 28 CF               A 15111    	JR	Z,L_666
                           A 15112    ; 5332					}
                           A 15113    ; 5333				}
                           A 15114    ; 5334			}
043D7A                     A 15115    L_672:
                           A 15116    .LINE 5334
                           A 15117    
                           A 15118    ; 5335			if (res == FR_NO_FILE) {	/* 
                           A 15119    .LINE 5335
                           A 15120    
043D7A 01040000            A 15121    	LD	BC,4
043D7E DD27FA              A 15122    	LD	HL,(IX+%FFFFFFFA)
043D81 B7                  A 15123    	OR	A,A
043D82 ED42                A 15124    	SBC	HL,BC
043D84 20 0C               A 15125    	JR	NZ,L_681
                           A 15126    ; 5336				label[0] = 0;
                           A 15127    .LINE 5336
                           A 15128    
043D86 DD2709              A 15129    	LD	HL,(IX+%9)
043D89 3600                A 15130    	LD	(HL),%0
                           A 15131    ; 5337				res = FR_OK;
                           A 15132    .LINE 5337
                           A 15133    
043D8B 01000000            A 15134    	LD	BC,0
043D8F DD0FFA              A 15135    	LD	(IX+%FFFFFFFA),BC
                           A 15136    ; 5338			}
                           A 15137    ; 5339		}
043D92                     A 15138    L_681:
                           A 15139    .LINE 5339
                           A 15140    
                           A 15141    ; 5340	
                           A 15142    ; 5341		/* Get volume serial number */
                           A 15143    ; 5342		if (res == FR_OK && vsn) {
                           A 15144    .LINE 5342
                           A 15145    
043D92 DD27FA              A 15146    	LD	HL,(IX+%FFFFFFFA)
043D95 CD E5 46 04         A 15147    	CALL	__icmpzero
043D99 20 79               A 15148    	JR	NZ,L_682
043D9B DD270C              A 15149    	LD	HL,(IX+%C)
043D9E CD E5 46 04         A 15150    	CALL	__icmpzero
043DA2 28 70               A 15151    	JR	Z,L_682
                           A 15152    ; 5343			res = move_window(fs, fs->volba
                           A 15153    .LINE 5343
                           A 15154    
043DA4 DD31F7              A 15155    	LD	IY,(IX+%FFFFFFF7)
043DA7 FD071A              A 15156    	LD	BC,(IY+%1A)
043DAA FD7E1D              A 15157    	LD	A,(IY+%1D)
043DAD 2600                A 15158    	LD	H,%0
043DAF 6F                  A 15159    	LD	L,A
043DB0 E5                  A 15160    	PUSH	HL
043DB1 C5                  A 15161    	PUSH	BC
043DB2 DD07F7              A 15162    	LD	BC,(IX+%FFFFFFF7)
043DB5 C5                  A 15163    	PUSH	BC
043DB6 CD 82 11 04         A 15164    	CALL	_move_window
043DBA C1                  A 15165    	POP	BC
043DBB C1                  A 15166    	POP	BC
043DBC C1                  A 15167    	POP	BC
043DBD DD2FFA              A 15168    	LD	(IX+%FFFFFFFA),HL
                           A 15169    ; 5344			if (res == FR_OK) {
                           A 15170    .LINE 5344
                           A 15171    
043DC0 CD E5 46 04         A 15172    	CALL	__icmpzero
043DC4 20 4E               A 15173    	JR	NZ,L_682
                           A 15174    ; 5345				switch (fs->fs_type) {
                           A 15175    .LINE 5345
                           A 15176    
043DC6 DD31F7              A 15177    	LD	IY,(IX+%FFFFFFF7)
043DC9 FD7E00              A 15178    	LD	A,(IY+%0)
043DCC B7ED62              A 15179    	UEXT	HL
043DCF 6F                  A 15180    	LD	L,A
043DD0 CD 9E 47 04         A 15181    	CALL	__case8D
043DD4 E9                  A 15182    	JP	(HL)
043DD5                     A 15183    L__351:
043DD5 0200                A 15184    	DW	2
043DD7 03                  A 15185    	DB	3
043DD8 EB3D04              A 15186    	DW24	L_676	
                           A 15187    
043DDB 04                  A 15188    	DB	4
043DDC E23D04              A 15189    	DW24	L_675	
                           A 15190    
043DDF F43D04              A 15191    	DW24	L_677	
                           A 15192    
                           A 15193    ; 5346				case FS_EXFAT:
043DE2                     A 15194    L_675:
                           A 15195    .LINE 5346
                           A 15196    
                           A 15197    ; 5347					di = BPB_VolIDEx;
                           A 15198    .LINE 5347
                           A 15199    
043DE2 01640000            A 15200    	LD	BC,100
043DE6 DD0FFD              A 15201    	LD	(IX+%FFFFFFFD),BC
                           A 15202    ; 5348					break;
                           A 15203    .LINE 5348
                           A 15204    
043DE9 18 10               A 15205    	JR	L_678
                           A 15206    ; 5349	
                           A 15207    ; 5350				case FS_FAT32:
043DEB                     A 15208    L_676:
                           A 15209    .LINE 5350
                           A 15210    
                           A 15211    ; 5351					di = BS_VolID32;
                           A 15212    .LINE 5351
                           A 15213    
043DEB 01430000            A 15214    	LD	BC,67
043DEF DD0FFD              A 15215    	LD	(IX+%FFFFFFFD),BC
                           A 15216    ; 5352					break;
                           A 15217    .LINE 5352
                           A 15218    
043DF2 18 07               A 15219    	JR	L_678
                           A 15220    ; 5353	
                           A 15221    ; 5354				default:
043DF4                     A 15222    L_677:
                           A 15223    .LINE 5354
                           A 15224    
                           A 15225    ; 5355					di = BS_VolID;
                           A 15226    .LINE 5355
                           A 15227    
043DF4 01270000            A 15228    	LD	BC,39
043DF8 DD0FFD              A 15229    	LD	(IX+%FFFFFFFD),BC
                           A 15230    ; 5356				}
043DFB                     A 15231    L_678:
                           A 15232    .LINE 5356
                           A 15233    
                           A 15234    ; 5357				*vsn = ld_dword(fs->win + d
                           A 15235    .LINE 5357
                           A 15236    
043DFB DD07FD              A 15237    	LD	BC,(IX+%FFFFFFFD)
043DFE DD31F7              A 15238    	LD	IY,(IX+%FFFFFFF7)
043E01 ED232E              A 15239    	LEA	HL,IY+%2E
043E04 09                  A 15240    	ADD	HL,BC
043E05 E5                  A 15241    	PUSH	HL
043E06 CD 61 0F 04         A 15242    	CALL	_ld_dword
043E0A C1                  A 15243    	POP	BC
043E0B DD310C              A 15244    	LD	IY,(IX+%C)
043E0E FD2F00              A 15245    	LD	(IY),HL
043E11 FD7303              A 15246    	LD	(IY+%3),E
                           A 15247    ; 5358			}
                           A 15248    ; 5359		}
043E14                     A 15249    L_682:
                           A 15250    .LINE 5359
                           A 15251    
                           A 15252    ; 5360	
                           A 15253    ; 5361		LEAVE_FF(fs, res);
                           A 15254    .LINE 5361
                           A 15255    
043E14 DD27FA              A 15256    	LD	HL,(IX+%FFFFFFFA)
                           A 15257    ; 5362	}
                           A 15258    .LINE 5362
                           A 15259    
043E17 DDF9                A 15260    	LD	SP,IX
043E19 DDE1                A 15261    	POP	IX
043E1B C9                  A 15262    	RET	
                           A 15263    
                           A 15264    
                           A 15265    ;**************************** _f_getlabel *****
                           A 15266    ;Name                         Addr/Register   S
                           A 15267    ;dj                                   IX-60    
                           A 15268    ;wc                                   IX-14    
                           A 15269    ;si                                   IX-12    
                           A 15270    ;fs                                    IX-9    
                           A 15271    ;res                                   IX-6    
                           A 15272    ;di                                    IX-3    
                           A 15273    ;vsn                                  IX+12    
                           A 15274    ;label                                 IX+9    
                           A 15275    ;path                                  IX+6    
                           A 15276    
                           A 15277    
                           A 15278    ; Stack Frame Size: 78 (bytes)
                           A 15279    ;       Spill Code: -1 (instruction)
                           A 15280    
                           A 15281    
                           A 15282    .ENDFUNC "f_getlabel",5362,"_f_getlabel"
                           A 15283    ; 5363	
                           A 15284    ; 5364	
                           A 15285    ; 5365	
                           A 15286    ; 5366	#if !FF_FS_READONLY
                           A 15287    ; 5367	/*-------------------------------------
                           A 15288    ; 5368	/* Set Volume Label                    
                           A 15289    ; 5369	/*-------------------------------------
                           A 15290    ; 5370	
                           A 15291    ; 5371	FRESULT f_setlabel (
                           A 15292    ; 5372		const TCHAR* label	/* Volume label
                           A 15293    ; 5373	)
                           A 15294    ; 5374	{
                           A 15295    ; 5375		FRESULT res;
                           A 15296    ; 5376		DIR dj;
                           A 15297    ; 5377		FATFS *fs;
                           A 15298    ; 5378		BYTE dirvn[22];
                           A 15299    ; 5379		UINT di;
                           A 15300    ; 5380		WCHAR wc;
                           A 15301    ; 5381		static const char badchr[18] = "+.,
                           A 15302    ; 5382	#if FF_USE_LFN
                           A 15303    ; 5383		DWORD dc;
                           A 15304    ; 5384	#endif
                           A 15305    ; 5385	
                           A 15306    ; 5386		/* Get logical drive */
                           A 15307    ; 5387		res = mount_volume(&label, &fs, FA_
                           A 15308    ; 5388		if (res != FR_OK) LEAVE_FF(fs, res)
                           A 15309    ; 5389	
                           A 15310    ; 5390	#if FF_FS_EXFAT
                           A 15311    ; 5391		if (fs->fs_type == FS_EXFAT) {	/* 
                           A 15312    ; 5392			memset(dirvn, 0, 22);
                           A 15313    ; 5393			di = 0;
                           A 15314    ; 5394			while ((UINT)*label >= ' ') {	
                           A 15315    ; 5395				dc = tchar2uni(&label);	/* 
                           A 15316    ; 5396				if (dc >= 0x10000) {
                           A 15317    ; 5397					if (dc == 0xFFFFFFFF ||
                           A 15318    ; 5398						dc = 0;
                           A 15319    ; 5399					} else {
                           A 15320    ; 5400						st_word(dirvn + di 
                           A 15321    ; 5401					}
                           A 15322    ; 5402				}
                           A 15323    ; 5403				if (dc == 0 || strchr(&badc
                           A 15324    ; 5404					LEAVE_FF(fs, FR_INVALID
                           A 15325    ; 5405				}
                           A 15326    ; 5406				st_word(dirvn + di * 2, (WC
                           A 15327    ; 5407			}
                           A 15328    ; 5408		} else
                           A 15329    ; 5409	#endif
                           A 15330    ; 5410		{	/* On the FAT/FAT32 volume */
                           A 15331    ; 5411			memset(dirvn, ' ', 11);
                           A 15332    ; 5412			di = 0;
                           A 15333    ; 5413			while ((UINT)*label >= ' ') {	
                           A 15334    ; 5414	#if FF_USE_LFN
                           A 15335    ; 5415				dc = tchar2uni(&label);
                           A 15336    ; 5416				wc = (dc < 0x10000) ? ff_un
                           A 15337    ; 5417	#else									
                           A 15338    ; 5418				wc = (BYTE)*label++;
                           A 15339    ; 5419				if (dbc_1st((BYTE)wc)) wc =
                           A 15340    ; 5420				if (IsLower(wc)) wc -= 0x20
                           A 15341    ; 5421	#if FF_CODE_PAGE == 0
                           A 15342    ; 5422				if (ExCvt && wc >= 0x80) wc
                           A 15343    ; 5423	#elif FF_CODE_PAGE < 900
                           A 15344    ; 5424				if (wc >= 0x80) wc = ExCvt[
                           A 15345    ; 5425	#endif
                           A 15346    ; 5426	#endif
                           A 15347    ; 5427				if (wc == 0 || strchr(&badc
                           A 15348    ; 5428					LEAVE_FF(fs, FR_INVALID
                           A 15349    ; 5429				}
                           A 15350    ; 5430				if (wc >= 0x100) dirvn[di++
                           A 15351    ; 5431				dirvn[di++] = (BYTE)wc;
                           A 15352    ; 5432			}
                           A 15353    ; 5433			if (dirvn[0] == DDEM) LEAVE_FF(
                           A 15354    ; 5434			while (di && dirvn[di - 1] == '
                           A 15355    ; 5435		}
                           A 15356    ; 5436	
                           A 15357    ; 5437		/* Set volume label */
                           A 15358    ; 5438		dj.obj.fs = fs; dj.obj.sclust = 0;	
                           A 15359    ; 5439		res = dir_sdi(&dj, 0);
                           A 15360    ; 5440		if (res == FR_OK) {
                           A 15361    ; 5441			res = DIR_READ_LABEL(&dj);	/* 
                           A 15362    ; 5442			if (res == FR_OK) {
                           A 15363    ; 5443				if (FF_FS_EXFAT && fs->fs_t
                           A 15364    ; 5444					dj.dir[XDIR_NumLabel] =
                           A 15365    ; 5445					memcpy(dj.dir + XDIR_La
                           A 15366    ; 5446				} else {
                           A 15367    ; 5447					if (di != 0) {
                           A 15368    ; 5448						memcpy(dj.dir, dirv
                           A 15369    ; 5449					} else {
                           A 15370    ; 5450						dj.dir[DIR_Name] = 
                           A 15371    ; 5451					}
                           A 15372    ; 5452				}
                           A 15373    ; 5453				fs->wflag = 1;
                           A 15374    ; 5454				res = sync_fs(fs);
                           A 15375    ; 5455			} else {			/* No volum
                           A 15376    ; 5456				if (res == FR_NO_FILE) {
                           A 15377    ; 5457					res = FR_OK;
                           A 15378    ; 5458					if (di != 0) {	/* Crea
                           A 15379    ; 5459						res = dir_alloc(&dj
                           A 15380    ; 5460						if (res == FR_OK) {
                           A 15381    ; 5461							memset(dj.dir, 
                           A 15382    ; 5462							if (FF_FS_EXFAT
                           A 15383    ; 5463								dj.dir[XDIR
                           A 15384    ; 5464								dj.dir[XDIR
                           A 15385    ; 5465								memcpy(dj.d
                           A 15386    ; 5466							} else {
                           A 15387    ; 5467								dj.dir[DIR_
                           A 15388    ; 5468								memcpy(dj.d
                           A 15389    ; 5469							}
                           A 15390    ; 5470							fs->wflag = 1;
                           A 15391    ; 5471							res = sync_fs(f
                           A 15392    ; 5472						}
                           A 15393    ; 5473					}
                           A 15394    ; 5474				}
                           A 15395    ; 5475			}
                           A 15396    ; 5476		}
                           A 15397    ; 5477	
                           A 15398    ; 5478		LEAVE_FF(fs, res);
                           A 15399    ; 5479	}
                           A 15400    ; 5480	
                           A 15401    ; 5481	#endif /* !FF_FS_READONLY */
                           A 15402    ; 5482	#endif /* FF_USE_LABEL */
                           A 15403    ; 5483	
                           A 15404    ; 5484	
                           A 15405    ; 5485	
                           A 15406    ; 5486	#if FF_USE_EXPAND && !FF_FS_READONLY
                           A 15407    ; 5487	/*-------------------------------------
                           A 15408    ; 5488	/* Allocate a Contiguous Blocks to the 
                           A 15409    ; 5489	/*-------------------------------------
                           A 15410    ; 5490	
                           A 15411    ; 5491	FRESULT f_expand (
                           A 15412    ; 5492		FIL* fp,		/* Pointer to the f
                           A 15413    ; 5493		FSIZE_t fsz,	/* File size to be 
                           A 15414    ; 5494		BYTE opt		/* Operation mode 0
                           A 15415    ; 5495	)
                           A 15416    ; 5496	{
                           A 15417    ; 5497		FRESULT res;
                           A 15418    ; 5498		FATFS *fs;
                           A 15419    ; 5499		DWORD n, clst, stcl, scl, ncl, tcl,
                           A 15420    ; 5500	
                           A 15421    ; 5501	
                           A 15422    ; 5502		res = validate(&fp->obj, &fs);		
                           A 15423    ; 5503		if (res != FR_OK || (res = (FRESULT
                           A 15424    ; 5504		if (fsz == 0 || fp->obj.objsize != 
                           A 15425    ; 5505	#if FF_FS_EXFAT
                           A 15426    ; 5506		if (fs->fs_type != FS_EXFAT && fsz 
                           A 15427    ; 5507	#endif
                           A 15428    ; 5508		n = (DWORD)fs->csize * SS(fs);	/* 
                           A 15429    ; 5509		tcl = (DWORD)(fsz / n) + ((fsz & (n
                           A 15430    ; 5510		stcl = fs->last_clst; lclst = 0;
                           A 15431    ; 5511		if (stcl < 2 || stcl >= fs->n_faten
                           A 15432    ; 5512	
                           A 15433    ; 5513	#if FF_FS_EXFAT
                           A 15434    ; 5514		if (fs->fs_type == FS_EXFAT) {
                           A 15435    ; 5515			scl = find_bitmap(fs, stcl, tcl
                           A 15436    ; 5516			if (scl == 0) res = FR_DENIED;	
                           A 15437    ; 5517			if (scl == 0xFFFFFFFF) res = FR
                           A 15438    ; 5518			if (res == FR_OK) {	/* A contig
                           A 15439    ; 5519				if (opt) {		/* Allocate
                           A 15440    ; 5520					res = change_bitmap(fs,
                           A 15441    ; 5521					lclst = scl + tcl - 1;
                           A 15442    ; 5522				} else {		/* Set it a
                           A 15443    ; 5523					lclst = scl - 1;
                           A 15444    ; 5524				}
                           A 15445    ; 5525			}
                           A 15446    ; 5526		} else
                           A 15447    ; 5527	#endif
                           A 15448    ; 5528		{
                           A 15449    ; 5529			scl = clst = stcl; ncl = 0;
                           A 15450    ; 5530			for (;;) {	/* Find a contiguou
                           A 15451    ; 5531				n = get_fat(&fp->obj, clst)
                           A 15452    ; 5532				if (++clst >= fs->n_fatent)
                           A 15453    ; 5533				if (n == 1) { res = FR_INT_
                           A 15454    ; 5534				if (n == 0xFFFFFFFF) { res 
                           A 15455    ; 5535				if (n == 0) {	/* Is it a 
                           A 15456    ; 5536					if (++ncl == tcl) break
                           A 15457    ; 5537				} else {
                           A 15458    ; 5538					scl = clst; ncl = 0;	
                           A 15459    ; 5539				}
                           A 15460    ; 5540				if (clst == stcl) { res = F
                           A 15461    ; 5541			}
                           A 15462    ; 5542			if (res == FR_OK) {	/* A contig
                           A 15463    ; 5543				if (opt) {		/* Allocate
                           A 15464    ; 5544					for (clst = scl, n = tc
                           A 15465    ; 5545						res = put_fat(fs, c
                           A 15466    ; 5546						if (res != FR_OK) b
                           A 15467    ; 5547						lclst = clst;
                           A 15468    ; 5548					}
                           A 15469    ; 5549				} else {		/* Set it a
                           A 15470    ; 5550					lclst = scl - 1;
                           A 15471    ; 5551				}
                           A 15472    ; 5552			}
                           A 15473    ; 5553		}
                           A 15474    ; 5554	
                           A 15475    ; 5555		if (res == FR_OK) {
                           A 15476    ; 5556			fs->last_clst = lclst;		/* 
                           A 15477    ; 5557			if (opt) {	/* Is it allocated 
                           A 15478    ; 5558				fp->obj.sclust = scl;		
                           A 15479    ; 5559				fp->obj.objsize = fsz;
                           A 15480    ; 5560				if (FF_FS_EXFAT) fp->obj.st
                           A 15481    ; 5561				fp->flag |= FA_MODIFIED;
                           A 15482    ; 5562				if (fs->free_clst <= fs->n_
                           A 15483    ; 5563					fs->free_clst -= tcl;
                           A 15484    ; 5564					fs->fsi_flag |= 1;
                           A 15485    ; 5565				}
                           A 15486    ; 5566			}
                           A 15487    ; 5567		}
                           A 15488    ; 5568	
                           A 15489    ; 5569		LEAVE_FF(fs, res);
                           A 15490    ; 5570	}
                           A 15491    ; 5571	
                           A 15492    ; 5572	#endif /* FF_USE_EXPAND && !FF_FS_READO
                           A 15493    ; 5573	
                           A 15494    ; 5574	
                           A 15495    ; 5575	
                           A 15496    ; 5576	#if FF_USE_FORWARD
                           A 15497    ; 5577	/*-------------------------------------
                           A 15498    ; 5578	/* Forward Data to the Stream Directly 
                           A 15499    ; 5579	/*-------------------------------------
                           A 15500    ; 5580	
                           A 15501    ; 5581	FRESULT f_forward (
                           A 15502    ; 5582		FIL* fp, 						/* 
                           A 15503    ; 5583		UINT (*func)(const BYTE*,UINT),	/* 
                           A 15504    ; 5584		UINT btf,						/* 
                           A 15505    ; 5585		UINT* bf						/* 
                           A 15506    ; 5586	)
                           A 15507    ; 5587	{
                           A 15508    ; 5588		FRESULT res;
                           A 15509    ; 5589		FATFS *fs;
                           A 15510    ; 5590		DWORD clst;
                           A 15511    ; 5591		LBA_t sect;
                           A 15512    ; 5592		FSIZE_t remain;
                           A 15513    ; 5593		UINT rcnt, csect;
                           A 15514    ; 5594		BYTE *dbuf;
                           A 15515    ; 5595	
                           A 15516    ; 5596	
                           A 15517    ; 5597		*bf = 0;	/* Clear transfer byte 
                           A 15518    ; 5598		res = validate(&fp->obj, &fs);		
                           A 15519    ; 5599		if (res != FR_OK || (res = (FRESULT
                           A 15520    ; 5600		if (!(fp->flag & FA_READ)) LEAVE_FF
                           A 15521    ; 5601	
                           A 15522    ; 5602		remain = fp->obj.objsize - fp->fptr
                           A 15523    ; 5603		if (btf > remain) btf = (UINT)remai
                           A 15524    ; 5604	
                           A 15525    ; 5605		for ( ; btf > 0 && (*func)(0, 0); f
                           A 15526    ; 5606			csect = (UINT)(fp->fptr / SS(fs
                           A 15527    ; 5607			if (fp->fptr % SS(fs) == 0) {	
                           A 15528    ; 5608				if (csect == 0) {			
                           A 15529    ; 5609					clst = (fp->fptr == 0) 
                           A 15530    ; 5610						fp->obj.sclust : ge
                           A 15531    ; 5611					if (clst <= 1) ABORT(fs
                           A 15532    ; 5612					if (clst == 0xFFFFFFFF)
                           A 15533    ; 5613					fp->clust = clst;		
                           A 15534    ; 5614				}
                           A 15535    ; 5615			}
                           A 15536    ; 5616			sect = clst2sect(fs, fp->clust)
                           A 15537    ; 5617			if (sect == 0) ABORT(fs, FR_INT
                           A 15538    ; 5618			sect += csect;
                           A 15539    ; 5619	#if FF_FS_TINY
                           A 15540    ; 5620			if (move_window(fs, sect) != FR
                           A 15541    ; 5621			dbuf = fs->win;
                           A 15542    ; 5622	#else
                           A 15543    ; 5623			if (fp->sect != sect) {		/* 
                           A 15544    ; 5624	#if !FF_FS_READONLY
                           A 15545    ; 5625				if (fp->flag & FA_DIRTY) {	
                           A 15546    ; 5626					if (disk_write(fs->pdrv
                           A 15547    ; 5627					fp->flag &= (BYTE)~FA_D
                           A 15548    ; 5628				}
                           A 15549    ; 5629	#endif
                           A 15550    ; 5630				if (disk_read(fs->pdrv, fp-
                           A 15551    ; 5631			}
                           A 15552    ; 5632			dbuf = fp->buf;
                           A 15553    ; 5633	#endif
                           A 15554    ; 5634			fp->sect = sect;
                           A 15555    ; 5635			rcnt = SS(fs) - (UINT)fp->fptr 
                           A 15556    ; 5636			if (rcnt > btf) rcnt = btf;		
                           A 15557    ; 5637			rcnt = (*func)(dbuf + ((UINT)fp
                           A 15558    ; 5638			if (rcnt == 0) ABORT(fs, FR_INT
                           A 15559    ; 5639		}
                           A 15560    ; 5640	
                           A 15561    ; 5641		LEAVE_FF(fs, FR_OK);
                           A 15562    ; 5642	}
                           A 15563    ; 5643	#endif /* FF_USE_FORWARD */
                           A 15564    ; 5644	
                           A 15565    ; 5645	
                           A 15566    ; 5646	
                           A 15567    ; 5647	#if !FF_FS_READONLY && FF_USE_MKFS
                           A 15568    ; 5648	/*-------------------------------------
                           A 15569    ; 5649	/* Create FAT/exFAT volume (with sub-fu
                           A 15570    ; 5650	/*-------------------------------------
                           A 15571    ; 5651	
                           A 15572    ; 5652	#define N_SEC_TRACK 63			/* Sect
                           A 15573    ; 5653	#define	GPT_ALIGN	0x100000	/* Alig
                           A 15574    ; 5654	#define GPT_ITEMS	128			/* Numb
                           A 15575    ; 5655	
                           A 15576    ; 5656	
                           A 15577    ; 5657	/* Create partitions on the physical dr
                           A 15578    ; 5658	
                           A 15579    ; 5659	static FRESULT create_partition (
                           A 15580    ; 5660		BYTE drv,			/* Physical dri
                           A 15581    ; 5661		const LBA_t plst[],	/* Partition li
                           A 15582    ; 5662		BYTE sys,			/* System ID (f
                           A 15583    ; 5663		BYTE* buf			/* Working buff
                           A 15584    ; 5664	)
                           A 15585    ; 5665	{
                           A 15586    ; 5666		UINT i, cy;
                           A 15587    ; 5667		LBA_t sz_drv;
                           A 15588    ; 5668		DWORD sz_drv32, nxt_alloc32, sz_par
                           A 15589    ; 5669		BYTE *pte;
                           A 15590    ; 5670		BYTE hd, n_hd, sc, n_sc;
                           A 15591    ; 5671	
                           A 15592    ; 5672		/* Get physical drive size */
                           A 15593    ; 5673		if (disk_ioctl(drv, GET_SECTOR_COUN
                           A 15594    ; 5674	
                           A 15595    ; 5675	#if FF_LBA64
                           A 15596    ; 5676		if (sz_drv >= FF_MIN_GPT) {	/* Crea
                           A 15597    ; 5677			WORD ss;
                           A 15598    ; 5678			UINT sz_ptbl, pi, si, ofs;
                           A 15599    ; 5679			DWORD bcc, rnd, align;
                           A 15600    ; 5680			QWORD nxt_alloc, sz_part, sz_po
                           A 15601    ; 5681			static const BYTE gpt_mbr[16] =
                           A 15602    ; 5682	
                           A 15603    ; 5683	#if FF_MAX_SS != FF_MIN_SS
                           A 15604    ; 5684			if (disk_ioctl(drv, GET_SECTOR_
                           A 15605    ; 5685			if (ss > FF_MAX_SS || ss < FF_M
                           A 15606    ; 5686	#else
                           A 15607    ; 5687			ss = FF_MAX_SS;
                           A 15608    ; 5688	#endif
                           A 15609    ; 5689			rnd = (DWORD)sz_drv + GET_FATTI
                           A 15610    ; 5690			align = GPT_ALIGN / ss;			
                           A 15611    ; 5691			sz_ptbl = GPT_ITEMS * SZ_GPTE /
                           A 15612    ; 5692			top_bpt = sz_drv - sz_ptbl - 1;
                           A 15613    ; 5693			nxt_alloc = 2 + sz_ptbl;		
                           A 15614    ; 5694			sz_pool = top_bpt - nxt_alloc;	
                           A 15615    ; 5695			bcc = 0xFFFFFFFF; sz_part = 1;
                           A 15616    ; 5696			pi = si = 0;	/* partition ta
                           A 15617    ; 5697			do {
                           A 15618    ; 5698				if (pi * SZ_GPTE % ss == 0)
                           A 15619    ; 5699				if (sz_part != 0) {			
                           A 15620    ; 5700					nxt_alloc = (nxt_alloc 
                           A 15621    ; 5701					sz_part = plst[si++];	
                           A 15622    ; 5702					if (sz_part <= 100) {	
                           A 15623    ; 5703						sz_part = sz_pool *
                           A 15624    ; 5704						sz_part = (sz_part 
                           A 15625    ; 5705					}
                           A 15626    ; 5706					if (nxt_alloc + sz_part
                           A 15627    ; 5707						sz_part = (nxt_allo
                           A 15628    ; 5708					}
                           A 15629    ; 5709				}
                           A 15630    ; 5710				if (sz_part != 0) {			
                           A 15631    ; 5711					ofs = pi * SZ_GPTE % ss
                           A 15632    ; 5712					memcpy(buf + ofs + GPTE
                           A 15633    ; 5713					rnd = make_rand(rnd, bu
                           A 15634    ; 5714					st_qword(buf + ofs + GP
                           A 15635    ; 5715					st_qword(buf + ofs + GP
                           A 15636    ; 5716					nxt_alloc += sz_part;	
                           A 15637    ; 5717				}
                           A 15638    ; 5718				if ((pi + 1) * SZ_GPTE % ss
                           A 15639    ; 5719					for (i = 0; i < ss; bcc
                           A 15640    ; 5720					if (disk_write(drv, buf
                           A 15641    ; 5721					if (disk_write(drv, buf
                           A 15642    ; 5722				}
                           A 15643    ; 5723			} while (++pi < GPT_ITEMS);
                           A 15644    ; 5724	
                           A 15645    ; 5725			/* Create primary GPT header */
                           A 15646    ; 5726			memset(buf, 0, ss);
                           A 15647    ; 5727			memcpy(buf + GPTH_Sign, "EFI PA
                           A 15648    ; 5728			st_dword(buf + GPTH_PtBcc, ~bcc
                           A 15649    ; 5729			st_qword(buf + GPTH_CurLba, 1);
                           A 15650    ; 5730			st_qword(buf + GPTH_BakLba, sz_
                           A 15651    ; 5731			st_qword(buf + GPTH_FstLba, 2 +
                           A 15652    ; 5732			st_qword(buf + GPTH_LstLba, top
                           A 15653    ; 5733			st_dword(buf + GPTH_PteSize, SZ
                           A 15654    ; 5734			st_dword(buf + GPTH_PtNum, GPT_
                           A 15655    ; 5735			st_dword(buf + GPTH_PtOfs, 2);	
                           A 15656    ; 5736			rnd = make_rand(rnd, buf + GPTH
                           A 15657    ; 5737			for (i = 0, bcc= 0xFFFFFFFF; i 
                           A 15658    ; 5738			st_dword(buf + GPTH_Bcc, ~bcc);
                           A 15659    ; 5739			if (disk_write(drv, buf, 1, 1) 
                           A 15660    ; 5740	
                           A 15661    ; 5741			/* Create secondary GPT header 
                           A 15662    ; 5742			st_qword(buf + GPTH_CurLba, sz_
                           A 15663    ; 5743			st_qword(buf + GPTH_BakLba, 1);
                           A 15664    ; 5744			st_qword(buf + GPTH_PtOfs, top_
                           A 15665    ; 5745			st_dword(buf + GPTH_Bcc, 0);
                           A 15666    ; 5746			for (i = 0, bcc= 0xFFFFFFFF; i 
                           A 15667    ; 5747			st_dword(buf + GPTH_Bcc, ~bcc);
                           A 15668    ; 5748			if (disk_write(drv, buf, sz_drv
                           A 15669    ; 5749	
                           A 15670    ; 5750			/* Create protective MBR */
                           A 15671    ; 5751			memset(buf, 0, ss);
                           A 15672    ; 5752			memcpy(buf + MBR_Table, gpt_mbr
                           A 15673    ; 5753			st_word(buf + BS_55AA, 0xAA55);
                           A 15674    ; 5754			if (disk_write(drv, buf, 0, 1) 
                           A 15675    ; 5755	
                           A 15676    ; 5756		} else
                           A 15677    ; 5757	#endif
                           A 15678    ; 5758		{	/* Create partitions in MBR for
                           A 15679    ; 5759			sz_drv32 = (DWORD)sz_drv;
                           A 15680    ; 5760			n_sc = N_SEC_TRACK;				
                           A 15681    ; 5761			for (n_hd = 8; n_hd != 0 && sz_
                           A 15682    ; 5762			if (n_hd == 0) n_hd = 255;		
                           A 15683    ; 5763	
                           A 15684    ; 5764			memset(buf, 0, FF_MAX_SS);		
                           A 15685    ; 5765			pte = buf + MBR_Table;	/* Part
                           A 15686    ; 5766			for (i = 0, nxt_alloc32 = n_sc;
                           A 15687    ; 5767				sz_part32 = (DWORD)plst[i];
                           A 15688    ; 5768				if (sz_part32 <= 100) sz_pa
                           A 15689    ; 5769				if (nxt_alloc32 + sz_part32
                           A 15690    ; 5770				if (sz_part32 == 0) break;	
                           A 15691    ; 5771	
                           A 15692    ; 5772				st_dword(pte + PTE_StLba, n
                           A 15693    ; 5773				st_dword(pte + PTE_SizLba, 
                           A 15694    ; 5774				pte[PTE_System] = sys;		
                           A 15695    ; 5775	
                           A 15696    ; 5776				cy = (UINT)(nxt_alloc32 / n
                           A 15697    ; 5777				hd = (BYTE)(nxt_alloc32 / n
                           A 15698    ; 5778				sc = (BYTE)(nxt_alloc32 % n
                           A 15699    ; 5779				pte[PTE_StHead] = hd;
                           A 15700    ; 5780				pte[PTE_StSec] = (BYTE)((cy
                           A 15701    ; 5781				pte[PTE_StCyl] = (BYTE)cy;
                           A 15702    ; 5782	
                           A 15703    ; 5783				cy = (UINT)((nxt_alloc32 + 
                           A 15704    ; 5784				hd = (BYTE)((nxt_alloc32 + 
                           A 15705    ; 5785				sc = (BYTE)((nxt_alloc32 + 
                           A 15706    ; 5786				pte[PTE_EdHead] = hd;
                           A 15707    ; 5787				pte[PTE_EdSec] = (BYTE)((cy
                           A 15708    ; 5788				pte[PTE_EdCyl] = (BYTE)cy;
                           A 15709    ; 5789	
                           A 15710    ; 5790				pte += SZ_PTE;		/* Next
                           A 15711    ; 5791			}
                           A 15712    ; 5792	
                           A 15713    ; 5793			st_word(buf + BS_55AA, 0xAA55);
                           A 15714    ; 5794			if (disk_write(drv, buf, 0, 1) 
                           A 15715    ; 5795		}
                           A 15716    ; 5796	
                           A 15717    ; 5797		return FR_OK;
                           A 15718    ; 5798	}
                           A 15719    ; 5799	
                           A 15720    ; 5800	
                           A 15721    ; 5801	
                           A 15722    ; 5802	FRESULT f_mkfs (
                           A 15723    ; 5803		const TCHAR* path,		/* Logical 
                           A 15724    ; 5804		const MKFS_PARM* opt,	/* Format o
                           A 15725    ; 5805		void* work,				/* Pointer 
                           A 15726    ; 5806		UINT len				/* Size of 
                           A 15727    ; 5807	)
                           A 15728    ; 5808	{
                           A 15729    ; 5809		static const WORD cst[] = {1, 4, 16
                           A 15730    ; 5810		static const WORD cst32[] = {1, 2, 
                           A 15731    ; 5811		static const MKFS_PARM defopt = {FM
                           A 15732    ; 5812		BYTE fsopt, fsty, sys, *buf, *pte, 
                           A 15733    ; 5813		WORD ss;	/* Sector size */
                           A 15734    ; 5814		DWORD sz_buf, sz_blk, n_clst, pau, 
                           A 15735    ; 5815		LBA_t sz_vol, b_vol, b_fat, b_data;
                           A 15736    ; 5816		LBA_t sect, lba[2];
                           A 15737    ; 5817		DWORD sz_rsv, sz_fat, sz_dir, sz_au
                           A 15738    ; 5818		UINT n_fat, n_root, i;				
                           A 15739    ; 5819		int vol;
                           A 15740    ; 5820		DSTATUS ds;
                           A 15741    ; 5821		FRESULT fr;
                           A 15742    ; 5822	
                           A 15743    ; 5823	
                           A 15744    ; 5824		/* Check mounted drive and clear wo
                           A 15745    ; 5825		vol = get_ldnumber(&path);			
                           A 15746    ; 5826		if (vol < 0) return FR_INVALID_DRIV
                           A 15747    ; 5827		if (FatFs[vol]) FatFs[vol]->fs_type
                           A 15748    ; 5828		pdrv = LD2PD(vol);			/* Phys
                           A 15749    ; 5829		ipart = LD2PT(vol);			/* Part
                           A 15750    ; 5830		if (!opt) opt = &defopt;	/* Use 
                           A 15751    ; 5831	
                           A 15752    ; 5832		/* Get physical drive status (sz_dr
                           A 15753    ; 5833		ds = disk_initialize(pdrv);
                           A 15754    ; 5834		if (ds & STA_NOINIT) return FR_NOT_
                           A 15755    ; 5835		if (ds & STA_PROTECT) return FR_WRI
                           A 15756    ; 5836		sz_blk = opt->align;
                           A 15757    ; 5837		if (sz_blk == 0 && disk_ioctl(pdrv,
                           A 15758    ; 5838	 	if (sz_blk == 0 || sz_blk > 0x8000 
                           A 15759    ; 5839	#if FF_MAX_SS != FF_MIN_SS
                           A 15760    ; 5840		if (disk_ioctl(pdrv, GET_SECTOR_SIZ
                           A 15761    ; 5841		if (ss > FF_MAX_SS || ss < FF_MIN_S
                           A 15762    ; 5842	#else
                           A 15763    ; 5843		ss = FF_MAX_SS;
                           A 15764    ; 5844	#endif
                           A 15765    ; 5845		/* Options for FAT sub-type and FAT
                           A 15766    ; 5846		fsopt = opt->fmt & (FM_ANY | FM_SFD
                           A 15767    ; 5847		n_fat = (opt->n_fat >= 1 && opt->n_
                           A 15768    ; 5848		n_root = (opt->n_root >= 1 && opt->
                           A 15769    ; 5849		sz_au = (opt->au_size <= 0x1000000 
                           A 15770    ; 5850		sz_au /= ss;	/* Byte --> Sector 
                           A 15771    ; 5851	
                           A 15772    ; 5852		/* Get working buffer */
                           A 15773    ; 5853		sz_buf = len / ss;		/* Size of 
                           A 15774    ; 5854		if (sz_buf == 0) return FR_NOT_ENOU
                           A 15775    ; 5855		buf = (BYTE*)work;		/* Working 
                           A 15776    ; 5856	#if FF_USE_LFN == 3
                           A 15777    ; 5857		if (!buf) buf = ff_memalloc(sz_buf 
                           A 15778    ; 5858	#endif
                           A 15779    ; 5859		if (!buf) return FR_NOT_ENOUGH_CORE
                           A 15780    ; 5860	
                           A 15781    ; 5861		/* Determine where the volume to be
                           A 15782    ; 5862		b_vol = sz_vol = 0;
                           A 15783    ; 5863		if (FF_MULTI_PARTITION && ipart != 
                           A 15784    ; 5864			/* Get partition location from 
                           A 15785    ; 5865			if (disk_read(pdrv, buf, 0, 1) 
                           A 15786    ; 5866			if (ld_word(buf + BS_55AA) != 0
                           A 15787    ; 5867	#if FF_LBA64
                           A 15788    ; 5868			if (buf[MBR_Table + PTE_System]
                           A 15789    ; 5869				DWORD n_ent, ofs;
                           A 15790    ; 5870				QWORD pt_lba;
                           A 15791    ; 5871	
                           A 15792    ; 5872				/* Get the partition locati
                           A 15793    ; 5873				if (disk_read(pdrv, buf, 1,
                           A 15794    ; 5874				if (!test_gpt_header(buf)) 
                           A 15795    ; 5875				n_ent = ld_dword(buf + GPTH
                           A 15796    ; 5876				pt_lba = ld_qword(buf + GPT
                           A 15797    ; 5877				ofs = i = 0;
                           A 15798    ; 5878				while (n_ent) {		/* Find
                           A 15799    ; 5879					if (ofs == 0 && disk_re
                           A 15800    ; 5880					if (!memcmp(buf + ofs +
                           A 15801    ; 5881						b_vol = ld_qword(bu
                           A 15802    ; 5882						sz_vol = ld_qword(b
                           A 15803    ; 5883						break;
                           A 15804    ; 5884					}
                           A 15805    ; 5885					n_ent--; ofs = (ofs + S
                           A 15806    ; 5886				}
                           A 15807    ; 5887				if (n_ent == 0) LEAVE_MKFS(
                           A 15808    ; 5888				fsopt |= 0x80;	/* Partitio
                           A 15809    ; 5889			} else
                           A 15810    ; 5890	#endif
                           A 15811    ; 5891			{	/* Get the partition locati
                           A 15812    ; 5892				pte = buf + (MBR_Table + (i
                           A 15813    ; 5893				if (ipart > 4 || pte[PTE_Sy
                           A 15814    ; 5894				b_vol = ld_dword(pte + PTE_
                           A 15815    ; 5895				sz_vol = ld_dword(pte + PTE
                           A 15816    ; 5896			}
                           A 15817    ; 5897		} else {	/* The volume is associ
                           A 15818    ; 5898			if (disk_ioctl(pdrv, GET_SECTOR
                           A 15819    ; 5899			if (!(fsopt & FM_SFD)) {	/* 
                           A 15820    ; 5900				/* Create a single-partitio
                           A 15821    ; 5901	#if FF_LBA64
                           A 15822    ; 5902				if (sz_vol >= FF_MIN_GPT) {
                           A 15823    ; 5903					fsopt |= 0x80;		/* 
                           A 15824    ; 5904					b_vol = GPT_ALIGN / ss;
                           A 15825    ; 5905				} else
                           A 15826    ; 5906	#endif
                           A 15827    ; 5907				{	/* Partitioning is in M
                           A 15828    ; 5908					if (sz_vol > N_SEC_TRAC
                           A 15829    ; 5909						b_vol = N_SEC_TRACK
                           A 15830    ; 5910					}
                           A 15831    ; 5911				}
                           A 15832    ; 5912			}
                           A 15833    ; 5913		}
                           A 15834    ; 5914		if (sz_vol < 128) LEAVE_MKFS(FR_MKF
                           A 15835    ; 5915	
                           A 15836    ; 5916		/* Now start to create an FAT volum
                           A 15837    ; 5917	
                           A 15838    ; 5918		do {	/* Pre-determine the FAT ty
                           A 15839    ; 5919			if (FF_FS_EXFAT && (fsopt & FM_
                           A 15840    ; 5920				if ((fsopt & FM_ANY) == FM_
                           A 15841    ; 5921					fsty = FS_EXFAT; break;
                           A 15842    ; 5922				}
                           A 15843    ; 5923			}
                           A 15844    ; 5924	#if FF_LBA64
                           A 15845    ; 5925			if (sz_vol >= 0x100000000) LEAV
                           A 15846    ; 5926	#endif
                           A 15847    ; 5927			if (sz_au > 128) sz_au = 128;	
                           A 15848    ; 5928			if (fsopt & FM_FAT32) {	/* FAT3
                           A 15849    ; 5929				if (!(fsopt & FM_FAT)) {	
                           A 15850    ; 5930					fsty = FS_FAT32; break;
                           A 15851    ; 5931				}
                           A 15852    ; 5932			}
                           A 15853    ; 5933			if (!(fsopt & FM_FAT)) LEAVE_MK
                           A 15854    ; 5934			fsty = FS_FAT16;
                           A 15855    ; 5935		} while (0);
                           A 15856    ; 5936	
                           A 15857    ; 5937		vsn = (DWORD)sz_vol + GET_FATTIME()
                           A 15858    ; 5938	
                           A 15859    ; 5939	#if FF_FS_EXFAT
                           A 15860    ; 5940		if (fsty == FS_EXFAT) {	/* Create a
                           A 15861    ; 5941			DWORD szb_bit, szb_case, sum, n
                           A 15862    ; 5942			WCHAR ch, si;
                           A 15863    ; 5943			UINT j, st;
                           A 15864    ; 5944	
                           A 15865    ; 5945			if (sz_vol < 0x1000) LEAVE_MKFS
                           A 15866    ; 5946	#if FF_USE_TRIM
                           A 15867    ; 5947			lba[0] = b_vol; lba[1] = b_vol 
                           A 15868    ; 5948			disk_ioctl(pdrv, CTRL_TRIM, lba
                           A 15869    ; 5949	#endif
                           A 15870    ; 5950			/* Determine FAT location, data
                           A 15871    ; 5951			if (sz_au == 0) {	/* AU auto-
                           A 15872    ; 5952				sz_au = 8;
                           A 15873    ; 5953				if (sz_vol >= 0x80000) sz_a
                           A 15874    ; 5954				if (sz_vol >= 0x4000000) sz
                           A 15875    ; 5955			}
                           A 15876    ; 5956			b_fat = b_vol + 32;				
                           A 15877    ; 5957			sz_fat = (DWORD)((sz_vol / sz_a
                           A 15878    ; 5958			b_data = (b_fat + sz_fat + sz_b
                           A 15879    ; 5959			if (b_data - b_vol >= sz_vol / 
                           A 15880    ; 5960			n_clst = (DWORD)(sz_vol - (b_da
                           A 15881    ; 5961			if (n_clst <16) LEAVE_MKFS(FR_M
                           A 15882    ; 5962			if (n_clst > MAX_EXFAT) LEAVE_M
                           A 15883    ; 5963	
                           A 15884    ; 5964			szb_bit = (n_clst + 7) / 8;		
                           A 15885    ; 5965			clen[0] = (szb_bit + sz_au * ss
                           A 15886    ; 5966	
                           A 15887    ; 5967			/* Create a compressed up-case 
                           A 15888    ; 5968			sect = b_data + sz_au * clen[0]
                           A 15889    ; 5969			sum = 0;						
                           A 15890    ; 5970			st = 0; si = 0; i = 0; j = 0; s
                           A 15891    ; 5971			do {
                           A 15892    ; 5972				switch (st) {
                           A 15893    ; 5973				case 0:
                           A 15894    ; 5974					ch = (WCHAR)ff_wtoupper
                           A 15895    ; 5975					if (ch != si) {
                           A 15896    ; 5976						si++; break;		
                           A 15897    ; 5977					}
                           A 15898    ; 5978					for (j = 1; (WCHAR)(si 
                           A 15899    ; 5979					if (j >= 128) {
                           A 15900    ; 5980						ch = 0xFFFF; st = 2
                           A 15901    ; 5981					}
                           A 15902    ; 5982					st = 1;			/* Do n
                           A 15903    ; 5983					/* FALLTHROUGH */
                           A 15904    ; 5984				case 1:
                           A 15905    ; 5985					ch = si++;		/* Fill
                           A 15906    ; 5986					if (--j == 0) st = 0;
                           A 15907    ; 5987					break;
                           A 15908    ; 5988	
                           A 15909    ; 5989				default:
                           A 15910    ; 5990					ch = (WCHAR)j; si += (W
                           A 15911    ; 5991					st = 0;
                           A 15912    ; 5992				}
                           A 15913    ; 5993				sum = xsum32(buf[i + 0] = (
                           A 15914    ; 5994				sum = xsum32(buf[i + 1] = (
                           A 15915    ; 5995				i += 2; szb_case += 2;
                           A 15916    ; 5996				if (si == 0 || i == sz_buf 
                           A 15917    ; 5997					n = (i + ss - 1) / ss;
                           A 15918    ; 5998					if (disk_write(pdrv, bu
                           A 15919    ; 5999					sect += n; i = 0;
                           A 15920    ; 6000				}
                           A 15921    ; 6001			} while (si);
                           A 15922    ; 6002			clen[1] = (szb_case + sz_au * s
                           A 15923    ; 6003			clen[2] = 1;	/* Number of ro
                           A 15924    ; 6004	
                           A 15925    ; 6005			/* Initialize the allocation bi
                           A 15926    ; 6006			sect = b_data; nsect = (szb_bit
                           A 15927    ; 6007			nbit = clen[0] + clen[1] + clen
                           A 15928    ; 6008			do {
                           A 15929    ; 6009				memset(buf, 0, sz_buf * ss)
                           A 15930    ; 6010				for (i = 0; nbit != 0 && i 
                           A 15931    ; 6011				n = (nsect > sz_buf) ? sz_b
                           A 15932    ; 6012				if (disk_write(pdrv, buf, s
                           A 15933    ; 6013				sect += n; nsect -= n;
                           A 15934    ; 6014			} while (nsect);
                           A 15935    ; 6015	
                           A 15936    ; 6016			/* Initialize the FAT */
                           A 15937    ; 6017			sect = b_fat; nsect = sz_fat;	
                           A 15938    ; 6018			j = nbit = clu = 0;
                           A 15939    ; 6019			do {
                           A 15940    ; 6020				memset(buf, 0, sz_buf * ss)
                           A 15941    ; 6021				if (clu == 0) {	/* Initiali
                           A 15942    ; 6022					st_dword(buf + i, 0xFFF
                           A 15943    ; 6023					st_dword(buf + i, 0xFFF
                           A 15944    ; 6024				}
                           A 15945    ; 6025				do {			/* Create c
                           A 15946    ; 6026					while (nbit != 0 && i <
                           A 15947    ; 6027						st_dword(buf + i, (
                           A 15948    ; 6028						i += 4; clu++; nbit
                           A 15949    ; 6029					}
                           A 15950    ; 6030					if (nbit == 0 && j < 3)
                           A 15951    ; 6031				} while (nbit != 0 && i < s
                           A 15952    ; 6032				n = (nsect > sz_buf) ? sz_b
                           A 15953    ; 6033				if (disk_write(pdrv, buf, s
                           A 15954    ; 6034				sect += n; nsect -= n;
                           A 15955    ; 6035			} while (nsect);
                           A 15956    ; 6036	
                           A 15957    ; 6037			/* Initialize the root director
                           A 15958    ; 6038			memset(buf, 0, sz_buf * ss);
                           A 15959    ; 6039			buf[SZDIRE * 0 + 0] = ET_VLABEL
                           A 15960    ; 6040			buf[SZDIRE * 1 + 0] = ET_BITMAP
                           A 15961    ; 6041			st_dword(buf + SZDIRE * 1 + 20,
                           A 15962    ; 6042			st_dword(buf + SZDIRE * 1 + 24,
                           A 15963    ; 6043			buf[SZDIRE * 2 + 0] = ET_UPCASE
                           A 15964    ; 6044			st_dword(buf + SZDIRE * 2 + 4, 
                           A 15965    ; 6045			st_dword(buf + SZDIRE * 2 + 20,
                           A 15966    ; 6046			st_dword(buf + SZDIRE * 2 + 24,
                           A 15967    ; 6047			sect = b_data + sz_au * (clen[0
                           A 15968    ; 6048			do {	/* Fill root directory 
                           A 15969    ; 6049				n = (nsect > sz_buf) ? sz_b
                           A 15970    ; 6050				if (disk_write(pdrv, buf, s
                           A 15971    ; 6051				memset(buf, 0, ss);	/* Rest
                           A 15972    ; 6052				sect += n; nsect -= n;
                           A 15973    ; 6053			} while (nsect);
                           A 15974    ; 6054	
                           A 15975    ; 6055			/* Create two set of the exFAT 
                           A 15976    ; 6056			sect = b_vol;
                           A 15977    ; 6057			for (n = 0; n < 2; n++) {
                           A 15978    ; 6058				/* Main record (+0) */
                           A 15979    ; 6059				memset(buf, 0, ss);
                           A 15980    ; 6060				memcpy(buf + BS_JmpBoot, "\
                           A 15981    ; 6061				st_qword(buf + BPB_VolOfsEx
                           A 15982    ; 6062				st_qword(buf + BPB_TotSecEx
                           A 15983    ; 6063				st_dword(buf + BPB_FatOfsEx
                           A 15984    ; 6064				st_dword(buf + BPB_FatSzEx,
                           A 15985    ; 6065				st_dword(buf + BPB_DataOfsE
                           A 15986    ; 6066				st_dword(buf + BPB_NumClusE
                           A 15987    ; 6067				st_dword(buf + BPB_RootClus
                           A 15988    ; 6068				st_dword(buf + BPB_VolIDEx,
                           A 15989    ; 6069				st_word(buf + BPB_FSVerEx, 
                           A 15990    ; 6070				for (buf[BPB_BytsPerSecEx] 
                           A 15991    ; 6071				for (buf[BPB_SecPerClusEx] 
                           A 15992    ; 6072				buf[BPB_NumFATsEx] = 1;		
                           A 15993    ; 6073				buf[BPB_DrvNumEx] = 0x80;	
                           A 15994    ; 6074				st_word(buf + BS_BootCodeEx
                           A 15995    ; 6075				st_word(buf + BS_55AA, 0xAA
                           A 15996    ; 6076				for (i = sum = 0; i < ss; i
                           A 15997    ; 6077					if (i != BPB_VolFlagEx 
                           A 15998    ; 6078				}
                           A 15999    ; 6079				if (disk_write(pdrv, buf, s
                           A 16000    ; 6080				/* Extended bootstrap recor
                           A 16001    ; 6081				memset(buf, 0, ss);
                           A 16002    ; 6082				st_word(buf + ss - 2, 0xAA5
                           A 16003    ; 6083				for (j = 1; j < 9; j++) {
                           A 16004    ; 6084					for (i = 0; i < ss; sum
                           A 16005    ; 6085					if (disk_write(pdrv, bu
                           A 16006    ; 6086				}
                           A 16007    ; 6087				/* OEM/Reserved record (+9.
                           A 16008    ; 6088				memset(buf, 0, ss);
                           A 16009    ; 6089				for ( ; j < 11; j++) {
                           A 16010    ; 6090					for (i = 0; i < ss; sum
                           A 16011    ; 6091					if (disk_write(pdrv, bu
                           A 16012    ; 6092				}
                           A 16013    ; 6093				/* Sum record (+11) */
                           A 16014    ; 6094				for (i = 0; i < ss; i += 4)
                           A 16015    ; 6095				if (disk_write(pdrv, buf, s
                           A 16016    ; 6096			}
                           A 16017    ; 6097	
                           A 16018    ; 6098		} else
                           A 16019    ; 6099	#endif	/* FF_FS_EXFAT */
                           A 16020    ; 6100		{	/* Create an FAT/FAT32 volume *
                           A 16021    ; 6101			do {
                           A 16022    ; 6102				pau = sz_au;
                           A 16023    ; 6103				/* Pre-determine number of 
                           A 16024    ; 6104				if (fsty == FS_FAT32) {	/* 
                           A 16025    ; 6105					if (pau == 0) {	/* AU a
                           A 16026    ; 6106						n = (DWORD)sz_vol /
                           A 16027    ; 6107						for (i = 0, pau = 1
                           A 16028    ; 6108					}
                           A 16029    ; 6109					n_clst = (DWORD)sz_vol 
                           A 16030    ; 6110					sz_fat = (n_clst * 4 + 
                           A 16031    ; 6111					sz_rsv = 32;	/* Numb
                           A 16032    ; 6112					sz_dir = 0;		/* No s
                           A 16033    ; 6113					if (n_clst <= MAX_FAT16
                           A 16034    ; 6114				} else {				/* 
                           A 16035    ; 6115					if (pau == 0) {	/* au a
                           A 16036    ; 6116						n = (DWORD)sz_vol /
                           A 16037    ; 6117						for (i = 0, pau = 1
                           A 16038    ; 6118					}
                           A 16039    ; 6119					n_clst = (DWORD)sz_vol 
                           A 16040    ; 6120					if (n_clst > MAX_FAT12)
                           A 16041    ; 6121						n = n_clst * 2 + 4;
                           A 16042    ; 6122					} else {
                           A 16043    ; 6123						fsty = FS_FAT12;
                           A 16044    ; 6124						n = (n_clst * 3 + 1
                           A 16045    ; 6125					}
                           A 16046    ; 6126					sz_fat = (n + ss - 1) /
                           A 16047    ; 6127					sz_rsv = 1;				
                           A 16048    ; 6128					sz_dir = (DWORD)n_root 
                           A 16049    ; 6129				}
                           A 16050    ; 6130				b_fat = b_vol + sz_rsv;		
                           A 16051    ; 6131				b_data = b_fat + sz_fat * n
                           A 16052    ; 6132	
                           A 16053    ; 6133				/* Align data area to erase
                           A 16054    ; 6134				n = (DWORD)(((b_data + sz_b
                           A 16055    ; 6135				if (fsty == FS_FAT32) {		
                           A 16056    ; 6136					sz_rsv += n; b_fat += n
                           A 16057    ; 6137				} else {					
                           A 16058    ; 6138					if (n % n_fat) {	/* 
                           A 16059    ; 6139						n--; sz_rsv++; b_fa
                           A 16060    ; 6140					}
                           A 16061    ; 6141					sz_fat += n / n_fat;
                           A 16062    ; 6142				}
                           A 16063    ; 6143	
                           A 16064    ; 6144				/* Determine number of clus
                           A 16065    ; 6145				if (sz_vol < b_data + pau *
                           A 16066    ; 6146				n_clst = ((DWORD)sz_vol - s
                           A 16067    ; 6147				if (fsty == FS_FAT32) {
                           A 16068    ; 6148					if (n_clst <= MAX_FAT16
                           A 16069    ; 6149						if (sz_au == 0 && (
                           A 16070    ; 6150						LEAVE_MKFS(FR_MKFS_
                           A 16071    ; 6151					}
                           A 16072    ; 6152				}
                           A 16073    ; 6153				if (fsty == FS_FAT16) {
                           A 16074    ; 6154					if (n_clst > MAX_FAT16)
                           A 16075    ; 6155						if (sz_au == 0 && (
                           A 16076    ; 6156							sz_au = pau * 2
                           A 16077    ; 6157						}
                           A 16078    ; 6158						if ((fsopt & FM_FAT
                           A 16079    ; 6159							fsty = FS_FAT32
                           A 16080    ; 6160						}
                           A 16081    ; 6161						if (sz_au == 0 && (
                           A 16082    ; 6162						LEAVE_MKFS(FR_MKFS_
                           A 16083    ; 6163					}
                           A 16084    ; 6164					if  (n_clst <= MAX_FAT1
                           A 16085    ; 6165						if (sz_au == 0 && (
                           A 16086    ; 6166						LEAVE_MKFS(FR_MKFS_
                           A 16087    ; 6167					}
                           A 16088    ; 6168				}
                           A 16089    ; 6169				if (fsty == FS_FAT12 && n_c
                           A 16090    ; 6170	
                           A 16091    ; 6171				/* Ok, it is the valid clus
                           A 16092    ; 6172				break;
                           A 16093    ; 6173			} while (1);
                           A 16094    ; 6174	
                           A 16095    ; 6175	#if FF_USE_TRIM
                           A 16096    ; 6176			lba[0] = b_vol; lba[1] = b_vol 
                           A 16097    ; 6177			disk_ioctl(pdrv, CTRL_TRIM, lba
                           A 16098    ; 6178	#endif
                           A 16099    ; 6179			/* Create FAT VBR */
                           A 16100    ; 6180			memset(buf, 0, ss);
                           A 16101    ; 6181			memcpy(buf + BS_JmpBoot, "\xEB\
                           A 16102    ; 6182			st_word(buf + BPB_BytsPerSec, s
                           A 16103    ; 6183			buf[BPB_SecPerClus] = (BYTE)pau
                           A 16104    ; 6184			st_word(buf + BPB_RsvdSecCnt, (
                           A 16105    ; 6185			buf[BPB_NumFATs] = (BYTE)n_fat;
                           A 16106    ; 6186			st_word(buf + BPB_RootEntCnt, (
                           A 16107    ; 6187			if (sz_vol < 0x10000) {
                           A 16108    ; 6188				st_word(buf + BPB_TotSec16,
                           A 16109    ; 6189			} else {
                           A 16110    ; 6190				st_dword(buf + BPB_TotSec32
                           A 16111    ; 6191			}
                           A 16112    ; 6192			buf[BPB_Media] = 0xF8;			
                           A 16113    ; 6193			st_word(buf + BPB_SecPerTrk, 63
                           A 16114    ; 6194			st_word(buf + BPB_NumHeads, 255
                           A 16115    ; 6195			st_dword(buf + BPB_HiddSec, (DW
                           A 16116    ; 6196			if (fsty == FS_FAT32) {
                           A 16117    ; 6197				st_dword(buf + BS_VolID32, 
                           A 16118    ; 6198				st_dword(buf + BPB_FATSz32,
                           A 16119    ; 6199				st_dword(buf + BPB_RootClus
                           A 16120    ; 6200				st_word(buf + BPB_FSInfo32,
                           A 16121    ; 6201				st_word(buf + BPB_BkBootSec
                           A 16122    ; 6202				buf[BS_DrvNum32] = 0x80;	
                           A 16123    ; 6203				buf[BS_BootSig32] = 0x29;	
                           A 16124    ; 6204				memcpy(buf + BS_VolLab32, "
                           A 16125    ; 6205			} else {
                           A 16126    ; 6206				st_dword(buf + BS_VolID, vs
                           A 16127    ; 6207				st_word(buf + BPB_FATSz16, 
                           A 16128    ; 6208				buf[BS_DrvNum] = 0x80;		
                           A 16129    ; 6209				buf[BS_BootSig] = 0x29;		
                           A 16130    ; 6210				memcpy(buf + BS_VolLab, "NO
                           A 16131    ; 6211			}
                           A 16132    ; 6212			st_word(buf + BS_55AA, 0xAA55);
                           A 16133    ; 6213			if (disk_write(pdrv, buf, b_vol
                           A 16134    ; 6214	
                           A 16135    ; 6215			/* Create FSINFO record if need
                           A 16136    ; 6216			if (fsty == FS_FAT32) {
                           A 16137    ; 6217				disk_write(pdrv, buf, b_vol
                           A 16138    ; 6218				memset(buf, 0, ss);
                           A 16139    ; 6219				st_dword(buf + FSI_LeadSig,
                           A 16140    ; 6220				st_dword(buf + FSI_StrucSig
                           A 16141    ; 6221				st_dword(buf + FSI_Free_Cou
                           A 16142    ; 6222				st_dword(buf + FSI_Nxt_Free
                           A 16143    ; 6223				st_word(buf + BS_55AA, 0xAA
                           A 16144    ; 6224				disk_write(pdrv, buf, b_vol
                           A 16145    ; 6225				disk_write(pdrv, buf, b_vol
                           A 16146    ; 6226			}
                           A 16147    ; 6227	
                           A 16148    ; 6228			/* Initialize FAT area */
                           A 16149    ; 6229			memset(buf, 0, sz_buf * ss);
                           A 16150    ; 6230			sect = b_fat;		/* FAT star
                           A 16151    ; 6231			for (i = 0; i < n_fat; i++) {	
                           A 16152    ; 6232				if (fsty == FS_FAT32) {
                           A 16153    ; 6233					st_dword(buf + 0, 0xFFF
                           A 16154    ; 6234					st_dword(buf + 4, 0xFFF
                           A 16155    ; 6235					st_dword(buf + 8, 0x0FF
                           A 16156    ; 6236				} else {
                           A 16157    ; 6237					st_dword(buf + 0, (fsty
                           A 16158    ; 6238				}
                           A 16159    ; 6239				nsect = sz_fat;		/* Numb
                           A 16160    ; 6240				do {	/* Fill FAT sectors
                           A 16161    ; 6241					n = (nsect > sz_buf) ? 
                           A 16162    ; 6242					if (disk_write(pdrv, bu
                           A 16163    ; 6243					memset(buf, 0, ss);	/* 
                           A 16164    ; 6244					sect += n; nsect -= n;
                           A 16165    ; 6245				} while (nsect);
                           A 16166    ; 6246			}
                           A 16167    ; 6247	
                           A 16168    ; 6248			/* Initialize root directory (f
                           A 16169    ; 6249			nsect = (fsty == FS_FAT32) ? pa
                           A 16170    ; 6250			do {
                           A 16171    ; 6251				n = (nsect > sz_buf) ? sz_b
                           A 16172    ; 6252				if (disk_write(pdrv, buf, s
                           A 16173    ; 6253				sect += n; nsect -= n;
                           A 16174    ; 6254			} while (nsect);
                           A 16175    ; 6255		}
                           A 16176    ; 6256	
                           A 16177    ; 6257		/* A FAT volume has been created he
                           A 16178    ; 6258	
                           A 16179    ; 6259		/* Determine system ID in the MBR p
                           A 16180    ; 6260		if (FF_FS_EXFAT && fsty == FS_EXFAT
                           A 16181    ; 6261			sys = 0x07;			/* exFAT */
                           A 16182    ; 6262		} else {
                           A 16183    ; 6263			if (fsty == FS_FAT32) {
                           A 16184    ; 6264				sys = 0x0C;		/* FAT32X *
                           A 16185    ; 6265			} else {
                           A 16186    ; 6266				if (sz_vol >= 0x10000) {
                           A 16187    ; 6267					sys = 0x06;	/* FAT12/16
                           A 16188    ; 6268				} else {
                           A 16189    ; 6269					sys = (fsty == FS_FAT16
                           A 16190    ; 6270				}
                           A 16191    ; 6271			}
                           A 16192    ; 6272		}
                           A 16193    ; 6273	
                           A 16194    ; 6274		/* Update partition information */
                           A 16195    ; 6275		if (FF_MULTI_PARTITION && ipart != 
                           A 16196    ; 6276			if (!FF_LBA64 || !(fsopt & 0x80
                           A 16197    ; 6277				/* Update system ID in the 
                           A 16198    ; 6278				if (disk_read(pdrv, buf, 0,
                           A 16199    ; 6279				buf[MBR_Table + (ipart - 1)
                           A 16200    ; 6280				if (disk_write(pdrv, buf, 0
                           A 16201    ; 6281			}
                           A 16202    ; 6282		} else {							
                           A 16203    ; 6283			if (!(fsopt & FM_SFD)) {		
                           A 16204    ; 6284				lba[0] = sz_vol; lba[1] = 0
                           A 16205    ; 6285				fr = create_partition(pdrv,
                           A 16206    ; 6286				if (fr != FR_OK) LEAVE_MKFS
                           A 16207    ; 6287			}
                           A 16208    ; 6288		}
                           A 16209    ; 6289	
                           A 16210    ; 6290		if (disk_ioctl(pdrv, CTRL_SYNC, 0) 
                           A 16211    ; 6291	
                           A 16212    ; 6292		LEAVE_MKFS(FR_OK);
                           A 16213    ; 6293	}
                           A 16214    ; 6294	
                           A 16215    ; 6295	
                           A 16216    ; 6296	
                           A 16217    ; 6297	
                           A 16218    ; 6298	#if FF_MULTI_PARTITION
                           A 16219    ; 6299	/*-------------------------------------
                           A 16220    ; 6300	/* Create Partition Table on the Physic
                           A 16221    ; 6301	/*-------------------------------------
                           A 16222    ; 6302	
                           A 16223    ; 6303	FRESULT f_fdisk (
                           A 16224    ; 6304		BYTE pdrv,			/* Physical dri
                           A 16225    ; 6305		const LBA_t ptbl[],	/* Pointer to t
                           A 16226    ; 6306		void* work			/* Pointer to t
                           A 16227    ; 6307	)
                           A 16228    ; 6308	{
                           A 16229    ; 6309		BYTE *buf = (BYTE*)work;
                           A 16230    ; 6310		DSTATUS stat;
                           A 16231    ; 6311	
                           A 16232    ; 6312	
                           A 16233    ; 6313		stat = disk_initialize(pdrv);
                           A 16234    ; 6314		if (stat & STA_NOINIT) return FR_NO
                           A 16235    ; 6315		if (stat & STA_PROTECT) return FR_W
                           A 16236    ; 6316	#if FF_USE_LFN == 3
                           A 16237    ; 6317		if (!buf) buf = ff_memalloc(FF_MAX_
                           A 16238    ; 6318	#endif
                           A 16239    ; 6319		if (!buf) return FR_NOT_ENOUGH_CORE
                           A 16240    ; 6320	
                           A 16241    ; 6321		LEAVE_MKFS(create_partition(pdrv, p
                           A 16242    ; 6322	}
                           A 16243    ; 6323	
                           A 16244    ; 6324	#endif /* FF_MULTI_PARTITION */
                           A 16245    ; 6325	#endif /* !FF_FS_READONLY && FF_USE_MKF
                           A 16246    ; 6326	
                           A 16247    ; 6327	
                           A 16248    ; 6328	
                           A 16249    ; 6329	
                           A 16250    ; 6330	#if FF_USE_STRFUNC
                           A 16251    ; 6331	#if FF_USE_LFN && FF_LFN_UNICODE && (FF
                           A 16252    ; 6332	#error Wrong FF_STRF_ENCODE setting
                           A 16253    ; 6333	#endif
                           A 16254    ; 6334	/*-------------------------------------
                           A 16255    ; 6335	/* Get a String from the File          
                           A 16256    ; 6336	/*-------------------------------------
                           A 16257    ; 6337	
                           A 16258    ; 6338	TCHAR* f_gets (
                           A 16259    ; 6339		TCHAR* buff,	/* Pointer to the b
                           A 16260    ; 6340		int len,		/* Size of string b
                           A 16261    ; 6341		FIL* fp			/* Pointer to the f
                           A 16262    ; 6342	)
                           A 16263    ; 6343	{
043E1C                     A 16264    _f_gets:
                           A 16265    .DEFINE "_f_gets"
                           A 16266    
                           A 16267    .VALUE _f_gets
                           A 16268    
                           A 16269    .CLASS 2
                           A 16270    
                           A 16271    .TYPE 322
                           A 16272    
                           A 16273    .ENDEF
                           A 16274    
                           A 16275    .BEGFUNC "f_gets",6343,"_f_gets"
                           A 16276    
                           A 16277    .LINE 6343
                           A 16278    
                           A 16279    .DEFINE "buff"
                           A 16280    
                           A 16281    .CLASS 65
                           A 16282    
                           A 16283    .VALUE 6
                           A 16284    
                           A 16285    .TYPE 34
                           A 16286    
                           A 16287    .ENDEF
                           A 16288    
                           A 16289    .DEFINE "len"
                           A 16290    
                           A 16291    .CLASS 65
                           A 16292    
                           A 16293    .VALUE 9
                           A 16294    
                           A 16295    .TYPE 4
                           A 16296    
                           A 16297    .ENDEF
                           A 16298    
                           A 16299    .DEFINE "fp"
                           A 16300    
                           A 16301    .CLASS 65
                           A 16302    
                           A 16303    .VALUE 12
                           A 16304    
                           A 16305    .TAG "NONAME2"
                           A 16306    
                           A 16307    .TYPE 40
                           A 16308    
                           A 16309    .ENDEF
                           A 16310    
                           A 16311    .DEFINE "nc"
                           A 16312    
                           A 16313    .CLASS 65
                           A 16314    
                           A 16315    .VALUE -3
                           A 16316    
                           A 16317    .TYPE 4
                           A 16318    
                           A 16319    .ENDEF
                           A 16320    
                           A 16321    .DEFINE "p"
                           A 16322    
                           A 16323    .CLASS 65
                           A 16324    
                           A 16325    .VALUE -6
                           A 16326    
                           A 16327    .TYPE 34
                           A 16328    
                           A 16329    .ENDEF
                           A 16330    
                           A 16331    .DEFINE "rc"
                           A 16332    
                           A 16333    .CLASS 65
                           A 16334    
                           A 16335    .VALUE -12
                           A 16336    
                           A 16337    .TYPE 14
                           A 16338    
                           A 16339    .ENDEF
                           A 16340    
                           A 16341    .DEFINE "dc"
                           A 16342    
                           A 16343    .CLASS 65
                           A 16344    
                           A 16345    .VALUE -16
                           A 16346    
                           A 16347    .TYPE 15
                           A 16348    
                           A 16349    .ENDEF
                           A 16350    
                           A 16351    .DEFINE "s"
                           A 16352    
                           A 16353    .CLASS 65
                           A 16354    
                           A 16355    .VALUE -20
                           A 16356    
                           A 16357    .DIM 4
                           A 16358    
                           A 16359    .TYPE 108
                           A 16360    
                           A 16361    .ENDEF
                           A 16362    
043E1C DDE5                A 16363    	PUSH	IX
043E1E DD210000 00         A 16364    	LD	IX,0
043E23 DD39                A 16365    	ADD	IX,SP
043E25 ED22E8              A 16366    	LEA	HL,IX+%FFFFFFE8
043E28 F9                  A 16367    	LD	SP,HL
                           A 16368    ; 6344		int nc = 0;
                           A 16369    .LINE 6344
                           A 16370    
043E29 01000000            A 16371    	LD	BC,0
043E2D DD0FFD              A 16372    	LD	(IX+%FFFFFFFD),BC
                           A 16373    ; 6345		TCHAR *p = buff;
                           A 16374    .LINE 6345
                           A 16375    
043E30 DD0706              A 16376    	LD	BC,(IX+%6)
043E33 DD0FFA              A 16377    	LD	(IX+%FFFFFFFA),BC
                           A 16378    ; 6346		BYTE s[4];
                           A 16379    ; 6347		UINT rc;
                           A 16380    ; 6348		DWORD dc;
                           A 16381    ; 6349	#if FF_USE_LFN && FF_LFN_UNICODE && FF_
                           A 16382    ; 6350		WCHAR wc;
                           A 16383    ; 6351	#endif
                           A 16384    ; 6352	#if FF_USE_LFN && FF_LFN_UNICODE && FF_
                           A 16385    ; 6353		UINT ct;
                           A 16386    ; 6354	#endif
                           A 16387    ; 6355	
                           A 16388    ; 6356	#if FF_USE_LFN && FF_LFN_UNICODE		
                           A 16389    ; 6357		/* Make a room for the character an
                           A 16390    ; 6358		if (FF_LFN_UNICODE == 1) len -= (FF
                           A 16391    ; 6359		if (FF_LFN_UNICODE == 2) len -= (FF
                           A 16392    ; 6360		if (FF_LFN_UNICODE == 3) len -= 1;
                           A 16393    ; 6361		while (nc < len) {
                           A 16394    ; 6362	#if FF_STRF_ENCODE == 0				/* 
                           A 16395    ; 6363			f_read(fp, s, 1, &rc);		/* 
                           A 16396    ; 6364			if (rc != 1) break;			/* 
                           A 16397    ; 6365			wc = s[0];
                           A 16398    ; 6366			if (dbc_1st((BYTE)wc)) {	/* 
                           A 16399    ; 6367				f_read(fp, s, 1, &rc);	/* 
                           A 16400    ; 6368				if (rc != 1 || !dbc_2nd(s[0
                           A 16401    ; 6369				wc = wc << 8 | s[0];
                           A 16402    ; 6370			}
                           A 16403    ; 6371			dc = ff_oem2uni(wc, CODEPAGE);	
                           A 16404    ; 6372			if (dc == 0) continue;		/* 
                           A 16405    ; 6373	#elif FF_STRF_ENCODE == 1 || FF_STRF_EN
                           A 16406    ; 6374			f_read(fp, s, 2, &rc);		/* 
                           A 16407    ; 6375			if (rc != 2) break;			/* 
                           A 16408    ; 6376			dc = (FF_STRF_ENCODE == 1) ? ld
                           A 16409    ; 6377			if (IsSurrogateL(dc)) continue;
                           A 16410    ; 6378			if (IsSurrogateH(dc)) {		/* 
                           A 16411    ; 6379				f_read(fp, s, 2, &rc);	/* 
                           A 16412    ; 6380				if (rc != 2) break;		/* 
                           A 16413    ; 6381				wc = (FF_STRF_ENCODE == 1) 
                           A 16414    ; 6382				if (!IsSurrogateL(wc)) cont
                           A 16415    ; 6383				dc = ((dc & 0x3FF) + 0x40) 
                           A 16416    ; 6384			}
                           A 16417    ; 6385	#else	/* Read a character in UTF-8 */
                           A 16418    ; 6386			f_read(fp, s, 1, &rc);		/* 
                           A 16419    ; 6387			if (rc != 1) break;			/* 
                           A 16420    ; 6388			dc = s[0];
                           A 16421    ; 6389			if (dc >= 0x80) {			/* 
                           A 16422    ; 6390				ct = 0;
                           A 16423    ; 6391				if ((dc & 0xE0) == 0xC0) { 
                           A 16424    ; 6392				if ((dc & 0xF0) == 0xE0) { 
                           A 16425    ; 6393				if ((dc & 0xF8) == 0xF0) { 
                           A 16426    ; 6394				if (ct == 0) continue;
                           A 16427    ; 6395				f_read(fp, s, ct, &rc);	/* 
                           A 16428    ; 6396				if (rc != ct) break;
                           A 16429    ; 6397				rc = 0;
                           A 16430    ; 6398				do {	/* Merge the byte s
                           A 16431    ; 6399					if ((s[rc] & 0xC0) != 0
                           A 16432    ; 6400					dc = dc << 6 | (s[rc] &
                           A 16433    ; 6401				} while (++rc < ct);
                           A 16434    ; 6402				if (rc != ct || dc < 0x80 |
                           A 16435    ; 6403			}
                           A 16436    ; 6404	#endif
                           A 16437    ; 6405			/* A code point is avaialble in
                           A 16438    ; 6406	
                           A 16439    ; 6407			if (FF_USE_STRFUNC == 2 && dc =
                           A 16440    ; 6408	#if FF_LFN_UNICODE == 1	|| FF_LFN_UNICO
                           A 16441    ; 6409			if (FF_LFN_UNICODE == 1 && dc >
                           A 16442    ; 6410				*p++ = (TCHAR)(0xD800 | ((d
                           A 16443    ; 6411				dc = 0xDC00 | (dc & 0x3FF);
                           A 16444    ; 6412			}
                           A 16445    ; 6413			*p++ = (TCHAR)dc; nc++;
                           A 16446    ; 6414			if (dc == '\n') break;	/* End 
                           A 16447    ; 6415	#elif FF_LFN_UNICODE == 2		/* Outp
                           A 16448    ; 6416			if (dc < 0x80) {	/* Single b
                           A 16449    ; 6417				*p++ = (TCHAR)dc;
                           A 16450    ; 6418				nc++;
                           A 16451    ; 6419				if (dc == '\n') break;	/* 
                           A 16452    ; 6420			} else {
                           A 16453    ; 6421				if (dc < 0x800) {		/* 
                           A 16454    ; 6422					*p++ = (TCHAR)(0xC0 | (
                           A 16455    ; 6423					*p++ = (TCHAR)(0x80 | (
                           A 16456    ; 6424					nc += 2;
                           A 16457    ; 6425				} else {
                           A 16458    ; 6426					if (dc < 0x10000) {	/* 
                           A 16459    ; 6427						*p++ = (TCHAR)(0xE0
                           A 16460    ; 6428						*p++ = (TCHAR)(0x80
                           A 16461    ; 6429						*p++ = (TCHAR)(0x80
                           A 16462    ; 6430						nc += 3;
                           A 16463    ; 6431					} else {			/* 
                           A 16464    ; 6432						*p++ = (TCHAR)(0xF0
                           A 16465    ; 6433						*p++ = (TCHAR)(0x80
                           A 16466    ; 6434						*p++ = (TCHAR)(0x80
                           A 16467    ; 6435						*p++ = (TCHAR)(0x80
                           A 16468    ; 6436						nc += 4;
                           A 16469    ; 6437					}
                           A 16470    ; 6438				}
                           A 16471    ; 6439			}
                           A 16472    ; 6440	#endif
                           A 16473    ; 6441		}
                           A 16474    ; 6442	
                           A 16475    ; 6443	#else			/* Byte-by-byte read wi
                           A 16476    ; 6444		len -= 1;	/* Make a room for the 
                           A 16477    .LINE 6444
                           A 16478    
043E36 DD0709              A 16479    	LD	BC,(IX+%9)
043E39 0B                  A 16480    	DEC	BC
043E3A DD0F09              A 16481    	LD	(IX+%9),BC
                           A 16482    ; 6445		while (nc < len) {
                           A 16483    .LINE 6445
                           A 16484    
043E3D 18 60               A 16485    	JR	L_691
043E3F                     A 16486    L_692:
                           A 16487    ; 6446			f_read(fp, s, 1, &rc);	/* Get 
                           A 16488    .LINE 6446
                           A 16489    
043E3F ED65F4              A 16490    	PEA	IX+%FFFFFFF4
043E42 01010000            A 16491    	LD	BC,1
043E46 C5                  A 16492    	PUSH	BC
043E47 ED65EC              A 16493    	PEA	IX+%FFFFFFEC
043E4A DD070C              A 16494    	LD	BC,(IX+%C)
043E4D C5                  A 16495    	PUSH	BC
043E4E DD77E8              A 16496    	LD	(IX+%FFFFFFE8),A
043E51 CD 99 35 04         A 16497    	CALL	_f_read
043E55 DD7EE8              A 16498    	LD	A,(IX+%FFFFFFE8)
043E58 C1                  A 16499    	POP	BC
043E59 C1                  A 16500    	POP	BC
043E5A C1                  A 16501    	POP	BC
043E5B C1                  A 16502    	POP	BC
                           A 16503    ; 6447			if (rc != 1) break;		/* EOF?
                           A 16504    .LINE 6447
                           A 16505    
043E5C 01010000            A 16506    	LD	BC,1
043E60 DD27F4              A 16507    	LD	HL,(IX+%FFFFFFF4)
043E63 B7                  A 16508    	OR	A,A
043E64 ED42                A 16509    	SBC	HL,BC
043E66 20 44               A 16510    	JR	NZ,L_693
                           A 16511    ; 6448			dc = s[0];
                           A 16512    .LINE 6448
                           A 16513    
043E68 B7ED62              A 16514    	UEXT	HL
043E6B DD6EEC              A 16515    	LD	L,(IX+%FFFFFFEC)
043E6E DD2FF0              A 16516    	LD	(IX+%FFFFFFF0),HL
043E71 DD74F3              A 16517    	LD	(IX+%FFFFFFF3),H
                           A 16518    ; 6449			if (FF_USE_STRFUNC == 2 && dc =
                           A 16519    ; 6450			*p++ = (TCHAR)dc; nc++;
                           A 16520    .LINE 6450
                           A 16521    
043E74 DD07FA              A 16522    	LD	BC,(IX+%FFFFFFFA)
043E77 DD0FE9              A 16523    	LD	(IX+%FFFFFFE9),BC
043E7A DD7EF0              A 16524    	LD	A,(IX+%FFFFFFF0)
043E7D C5E1                A 16525    	LD	HL,BC
043E7F 77                  A 16526    	LD	(HL),A
043E80 DD07FA              A 16527    	LD	BC,(IX+%FFFFFFFA)
043E83 03                  A 16528    	INC	BC
043E84 DD0FFA              A 16529    	LD	(IX+%FFFFFFFA),BC
043E87 DD07FD              A 16530    	LD	BC,(IX+%FFFFFFFD)
043E8A 03                  A 16531    	INC	BC
043E8B DD0FFD              A 16532    	LD	(IX+%FFFFFFFD),BC
                           A 16533    ; 6451			if (dc == '\n') break;
                           A 16534    .LINE 6451
                           A 16535    
043E8E DD27F0              A 16536    	LD	HL,(IX+%FFFFFFF0)
043E91 DD5EF3              A 16537    	LD	E,(IX+%FFFFFFF3)
043E94 010A0000            A 16538    	LD	BC,10
043E98 AF                  A 16539    	XOR	A,A
043E99 CD 88 47 04         A 16540    	CALL	__lcmpu
043E9D 28 0D               A 16541    	JR	Z,L_693
                           A 16542    ; 6452		}
043E9F                     A 16543    L_691:
                           A 16544    .LINE 6452
                           A 16545    
043E9F DD0709              A 16546    	LD	BC,(IX+%9)
043EA2 DD27FD              A 16547    	LD	HL,(IX+%FFFFFFFD)
043EA5 B7                  A 16548    	OR	A,A
043EA6 ED42                A 16549    	SBC	HL,BC
043EA8 FA 3F 3E 04         A 16550    	JP	M,L_692
043EAC                     A 16551    L_693:
                           A 16552    ; 6453	#endif
                           A 16553    ; 6454	
                           A 16554    ; 6455		*p = 0;		/* Terminate the string
                           A 16555    .LINE 6455
                           A 16556    
043EAC DD27FA              A 16557    	LD	HL,(IX+%FFFFFFFA)
043EAF 3600                A 16558    	LD	(HL),%0
                           A 16559    ; 6456		return nc ? buff : 0;	/* When no 
                           A 16560    .LINE 6456
                           A 16561    
043EB1 DD27FD              A 16562    	LD	HL,(IX+%FFFFFFFD)
043EB4 CD E5 46 04         A 16563    	CALL	__icmpzero
043EB8 28 08               A 16564    	JR	Z,L_696
043EBA DD0706              A 16565    	LD	BC,(IX+%6)
043EBD DD0FF7              A 16566    	LD	(IX+%FFFFFFF7),BC
043EC0 18 07               A 16567    	JR	L_697
043EC2                     A 16568    L_696:
043EC2 01000000            A 16569    	LD	BC,0
043EC6 DD0FF7              A 16570    	LD	(IX+%FFFFFFF7),BC
043EC9                     A 16571    L_697:
043EC9 DD27F7              A 16572    	LD	HL,(IX+%FFFFFFF7)
                           A 16573    ; 6457	}
                           A 16574    .LINE 6457
                           A 16575    
043ECC DDF9                A 16576    	LD	SP,IX
043ECE DDE1                A 16577    	POP	IX
043ED0 C9                  A 16578    	RET	
                           A 16579    
                           A 16580    
                           A 16581    ;**************************** _f_gets *********
                           A 16582    ;Name                         Addr/Register   S
                           A 16583    ;_f_read                             IMPORT  --
                           A 16584    ;s                                    IX-20    
                           A 16585    ;dc                                   IX-16    
                           A 16586    ;rc                                   IX-12    
                           A 16587    ;temp694                               IX-9    
                           A 16588    ;p                                     IX-6    
                           A 16589    ;nc                                    IX-3    
                           A 16590    ;fp                                   IX+12    
                           A 16591    ;len                                   IX+9    
                           A 16592    ;buff                                  IX+6    
                           A 16593    
                           A 16594    
                           A 16595    ; Stack Frame Size: 39 (bytes)
                           A 16596    ;       Spill Code: -1 (instruction)
                           A 16597    
                           A 16598    
                           A 16599    .ENDFUNC "f_gets",6457,"_f_gets"
                           A 16600    	XREF _disk_read:ROM
                           A 16601    	XREF _disk_status:ROM
                           A 16602    	XREF _disk_initialize:ROM
                           A 16603    	XREF _ff_wtoupper:ROM
                           A 16604    	XREF _ff_uni2oem:ROM
                           A 16605    	XREF _ff_oem2uni:ROM
                           A 16606    	XREF _strchr:ROM
                           A 16607    	XREF _memset:ROM
                           A 16608    	XREF _memcmp:ROM
                           A 16609    	XREF _memcpy:ROM
                           A 16610    	XREF __lcmpu:ROM
                           A 16611    	XREF __ladd:ROM
                           A 16612    	XREF __lsub:ROM
                           A 16613    	XREF __ldivu:ROM
                           A 16614    	XREF __lmulu:ROM
                           A 16615    	XREF __sor:ROM
                           A 16616    	XREF __ior:ROM
                           A 16617    	XREF __lor:ROM
                           A 16618    	XREF __sand:ROM
                           A 16619    	XREF __iand:ROM
                           A 16620    	XREF __land:ROM
                           A 16621    	XREF __bshl:ROM
                           A 16622    	XREF __lshl:ROM
                           A 16623    	XREF __lshru:ROM
                           A 16624    	XREF __stoiu:ROM
                           A 16625    	XREF __itol:ROM
                           A 16626    	XREF __ildix:ROM
                           A 16627    	XREF __istix:ROM
                           A 16628    	XREF __setflag:ROM
                           A 16629    	XREF __scmpzero:ROM
                           A 16630    	XREF __icmpzero:ROM
                           A 16631    	XREF __lcmpzero:ROM
                           A 16632    	XREF __case8D:ROM
                           A 16633    	XREF __seqcaseD:ROM
                           A 16634    	XREF __imul_b:ROM
                           A 16635    	XREF __ladd_b:ROM
                           A 16636    	XREF __ishl_b:ROM
                           A 16637    	XREF __ishru_b:ROM
                           A 16638    	XREF __ishrs_b:ROM
                           A 16639    	XDEF _f_gets
                           A 16640    	XDEF _f_getlabel
                           A 16641    	XDEF _f_getcwd
                           A 16642    	XDEF _f_chdir
                           A 16643    	XDEF _f_chdrive
                           A 16644    	XDEF _f_close
                           A 16645    	XDEF _f_read
                           A 16646    	XDEF _f_open
                           A 16647    	XDEF _f_mount
                           A 16648    	END


Errors: 0
Warnings: 0
Lines Assembled: 16649
